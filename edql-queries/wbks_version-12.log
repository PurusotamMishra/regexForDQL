stream=EP-PROCESS where action='PROCESS_ADDED' and processname='powershell.exe' and commandline like '%powershell.exe%Set-ExecutionPolicy%Bypass%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='powershell.exe' and commandline like '%powershell.exe%Set-ExecutionPolicy%Bypass%' | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?(StartMenuLogOff|onlogoff)") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?(StartMenuLogOff|onlogoff)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and  (rlike(lower(commandline),"mkdir .*?windows .*?(system32|syswow64)") or rlike(lower(commandline),"(copy |mlink ).*? .*?windows .*?(system32|syswow64)")) | duration 1h | groupby user, system, commandline

stream=WIN-AUDIT where action="PROCESS_CREATED" and  (rlike(lower(commandline),"mkdir .*?windows .*?(system32|syswow64)") or rlike(lower(commandline),"(copy |mlink ).*? .*?windows .*?(system32|syswow64)")) and user='{SuspectUser}' and system='{TargetHost}' and commandline='{TargetObject}' | duration 6m

stream=ep-process where eid='1' and ((image like '%bginfo.exe%' and commandline like '%nolicprompt%' and commandline like '%popup%') or image like '%odbcconf.exe%' or image like '%dnx.exe%') | duration 1d | select image,system, user | limit 10

stream=ep-process where eid='1' and ((image like '%bginfo.exe%' and commandline like '%nolicprompt%' and commandline like '%popup%') or image like '%odbcconf.exe%' or image like '%dnx.exe%') and duration 1d and system='{TargetHost}' and user='{SuspectUser}'

stream=WIN-AUDIT where eid='4663' and @event_category="Removable Storage" and (@access="WriteData%" or @access="%AppendData%") | select distinct_count(object) as DataCopied | groupby user | having DataCopied>100

stream=iam where sourcename='WINDOWS' and action='USER_CREATED' and status='PASSED' and user='administrator' | groupby srcip, targetuser

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%powershell.exe%convertto-securestring%get-childitem -path%export-pfxcertificate%-filepath%') | groupby user , system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%convertto-securestring%fet-childitem -path%export-pfxcertificate%-filepath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%<script>%' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%.js%' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%javascript:%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%<script>%' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%.js%' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%javascript:%') and user='{SystemUser}' and system='{TargetHost}' | duration 6m

stream=configuration where eventid='6006' | duration 24h | groupby devsrcip, message, system | limit 100

stream=* where sourcename="WINDOWS" | groupby sourcename, eid | duration = 7d

stream=email-gateway where action="EMAIL_QUARANTINED" and severity in ('risk','medium') | groupby sender, recipient | having sender > 5

stream=SYSMON-PROCESS where sourcename="WINDOWS" and ParentCommandLine='sethc.exe 211' and image like '%EaseOfAccessDialog.exe' | groupby devsrcip, user

stream=FIREWALL where action='BTNT_BLKD' and status='FAILED' and sourcename='FORTIGATE' and LogID='1501054601' | duration 24h | groupby domain

stream=FIREWALL where sourcename='FORTIGATE' and ActionTaken='accept' | groupby category | duration 7d | limit 10

stream=CONFIGURATION where sourcename='TREND-MICRO' | duration 1d | groupby targetentity | limit 100

stream=CONFIGURATION where sourcename='FORTIGATE' and action='CONFIG_ERASD' and ActionTaken='delete_phase1_sa' | duration 24h | groupby user, srcip, message

stream=CONFIGURATION where sourcename='TREND-MICRO' and not user='-' | duration 1d | groupby user | limit 10

stream=* |  groupby devsrcip, system | duration 1d | last 100

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?(DisableChangePassword).*?\/d\s1") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?(DisableChangePassword)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-file where eid='11' and action='FILE_CREATED' and status='PASSED' and path like '%Drivers%' | groupby system, user, sourcename, path | duration 15m | limit 10

stream=configuration where eventid in ('6005', '6006') | duration 24h | groupby devsrcip, system, message | limit 100

stream=* | duration from 2023-02-26T00:00:00 to 2023-02-26T23:59:59 | timeslice 1h

stream=symon-process where action="PROCESS_ADDED" and ParentCommandLine="sethc.exe 211" and Image like "%EaseOfAccessDialog.exe" | groupby devsrcip

stream=authentication where srccn = 'CN' |  groupby srcip

stream=* where sourcetype="DAM" and devsrcip in ('10.204.0.164', '10.201.0.228', '10.201.1.52', '10.201.2.100', '10.202.0.228', '10.203.0.228', '10.203.8.52', '10.203.0.229', '10.203.2.100') | duration 1d | groupby devsrcip, sourcename, sourcetype, action

stream=SYSMON-REGISTRY where sourcename="WINDOWS" and TargetObject in ('HKLM\\SOFTWARE\\WINDOWS NT\\CurrentVersion\\Windows\\AppInit_DLLs', 'HKLM\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows NT\\CurrentVersion\\Windows\\LoadAppInit_DLLs') | groupby targetobject, devsrcip, image

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'esentutl.*?/y\s+/vss.*?/d.*?(ntds|sam)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'esentutl.*?/y\s+/vss.*?/d.*?(ntds|sam)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image='net.exe' and commandline like '%group%' and commandline like '%Domain%Admins%' and commandline like '%/delete%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and image='net.exe' and commandline like '%group%' and commandline like '%Domain%Admins%' and commandline like '%/delete%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=AUTHENTICATION where Channel='Directory Service' and sourcename='WINDOWS' | duration 24h | groupby user, system | limit 100

stream=webserver where sourcename='ARRAY-OS' sourcetype='LOADBALANCER' | duration 7d | groupby virtualip | limit 100

stream=webserver where sourcename='ARRAY-OS' and sourcetype='LOADBALANCER' | duration 7d | select sum(evtlen)

stream=AUTHENTICATION where action='LOGIN' and user NOT LIKE '%$%' and user NOT LIKE '%ANONYMOUS%' and user NOT LIKE '%AUTHORITY%' and user NOT LIKE '%X509N%' and not user in ('NOCNMSUSER', 'NOCNMUSER', '-',  'Nocnmuser', 'SPIUSER3', 'nocnmsuser.', 'nocnmsuser', 'NOCNMS', 'SYSTEM', 'socfauser', ' ', 'cloudadmin', 'None') | groupby srcip, user  | duration 1d

stream=* | select system, sourcename, substring(xhour, 0, 8) as date | groupby system, sourcename, substring(xhour, 0, 8) | duration 8d

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%powershell.exe%convertto-securestring%get-childitem -path%export-pfxcertificate%-filepath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%powershell.exe%convertto-securestring%get-childitem -path%export-pfxcertificate%-filepath%') | groupby user , system 

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%convertto-securestring%-force%new-selfsignedcertificate%-dnsname%-certstorelocation%get-childitem -path%export-pfxcertificate%-filepath%') | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%convertto-securestring%-force%new-selfsignedcertificate%-dnsname%-certstorelocation%get-childitem -path%export-pfxcertificate%-filepath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=authentication | limit 1

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%powershell.exe%convertto-securestring%-Force%New-SelfSignedCertificate%-DnsName%-CertStoreLocation%get-childitem -path%export-pfxcertificate%-filepath%') | duration 10m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%powershell.exe%convertto-securestring%get-childitem -path%export-pfxcertificate%-filepath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), 'bitsadmin.*?addfile')  | groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), 'bitsadmin.*?addfile') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%adfind%-s base lockoutduration lockoutthreshold lockoutobservationwindow maxpwdage minpwdage minpwdlength pwdhistorylength pwdproperties%' or lower(commandline) like '%adfind%-sc admincountdmp%' or lower(commandline) like '%adfind%-f%objectcategory=person%' or lower(commandline) like '%adfind%-sc exchaddresses%' or lower(commandline) like '%adfind%-f%objectcategory=person%objectclass=user%memberof=cn=administrators%' or lower(commandline) like '%adfind%-f%objectcategory=group%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%adfind%-s base lockoutduration lockoutthreshold lockoutobservationwindow maxpwdage minpwdage minpwdlength pwdhistorylength pwdproperties%' or lower(commandline) like '%adfind%-sc admincountdmp%' or lower(commandline) like '%adfind%-f%objectcategory=person%' or lower(commandline) like '%adfind%-sc exchaddresses%' or lower(commandline) like '%adfind%-f%objectcategory=person%objectclass=user%memberof=cn=administrators%' or lower(commandline) like '%adfind%-f%objectcategory=group%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (lower(commandline) like '%start-bitstransfer%priority%foreground%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (lower(commandline) like '%start-bitstransfer%priority%foreground%') | groupby system, user

stream=signals | duration 1h | limit 10

stream=authentication where  action='LOGIN' and status='FAILED' |  groupby user 

stream=authentication where  action='LOGIN' and status='FAILED' | duration 1d | groupby user 

stream=win-audit where eid in ('4663', '4656') and (object like "%keyboard%" or object like "%keylog%") and action="OBJECT_ACCESSED" | groupby srcip, user

stream=win-audit where eid in ('4663', '4656') and (object like "%keyboard%" or object like "%keylog%") and action="OBJECT_ACCESSED" | groupby srcip, user

stream=SYSMON-REGISTRY where sourcename="WINDOWS" and TargetObject='HKLM\\System\\CurrentControlSet\\Control\\SESSION MANAGER\\BootExecute' | groupby targetobject, devsrcip, image

stream=webserver where (UriQuery like "%%%3Cscript%3E%" or UriQuery like "%%<script%%" or UriQuery like "%%&#x3C;script&#x3E;%" or UriQuery like "%%&lt;script%&gt;%")

stream=webserver where (URL like "%%%3Cscript%3E%" or URL like "%%<script%%" or URL like "%%&#x3C;script&#x3E;%" or URL like "%%&lt;script%&gt;%")

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(commandline, '(.*Add-DomainGroupMember.*|.*Add-DomainObjectAcl.*|.*Add-RemoteConnection.*|.*Add-ServiceDacl.*|.*Add-Win32Type.*|.*Convert-ADName.*|.*Convert-LDAPProperty.*|.*ConvertFrom-LDAPLogonHours.*|.*ConvertFrom-UACValue.*|.*Copy-ArrayOfMemAddresses.*|.*Create-NamedPipe.*|.*Create-ProcessWithToken.*|.*Create-RemoteThread.*|.*Create-SuspendedWinLogon.*|.*Create-WinLogonProcess.*|.*Emit-CallThreadStub.*|.*Enable-SeAssignPrimaryTokenPrivilege.*|.*Enable-SeDebugPrivilege.*|.*Enum-AllTokens.*|.*Export-PowerViewCSV.*|.*Find-AVSignature.*|.*Find-AppLockerLog.*|.*Find-DomainLocalGroupMember.*|.*Find-DomainObjectPropertyOutlier.*|.*Find-DomainProcess.*|.*Find-DomainShare.*|.*Find-DomainUserEvent.*|.*Find-DomainUserLocation.*|.*Find-InterestingDomainAcl.*|.*Find-InterestingDomainShareFile.*|.*Find-InterestingFile.*|.*Find-LocalAdminAccess.*|.*Find-PSScriptsInPSAppLog.*|.*Find-PathDLLHijack.*|.*Find-ProcessDLLHijack.*|.*Find-RDPClientConnection.*|.*Get-AllAttributesForClass.*|.*Get-CachedGPPPassword.*|.*Get-DecryptedCpassword.*|.*Get-DecryptedSitelistPassword.*|.*Get-DelegateType.*|.*Get-DomainDFSShare.*|.*Get-DomainDFSShareV1.*|.*Get-DomainDFSShareV2.*|.*Get-DomainDNSRecord.*|.*Get-DomainDNSZone.*|.*Get-DomainFileServer.*|.*Get-DomainForeignGroupMember.*|.*Get-DomainForeignUser.*|.*Get-DomainGPO.*|.*Get-DomainGPOComputerLocalGroupMapping.*|.*Get-DomainGPOLocalGroup.*|.*Get-DomainGPOUserLocalGroupMapping.*|.*Get-DomainGUIDMap.*|.*Get-DomainGroup.*|.*Get-DomainGroupMember.*|.*Get-DomainGroupMemberDeleted.*|.*Get-DomainManagedSecurityGroup.*|.*Get-DomainOU.*|.*Get-DomainObject.*|.*Get-DomainObjectAcl.*|.*Get-DomainObjectAttributeHistory.*|.*Get-DomainObjectLinkedAttributeHistory.*|.*Get-DomainPolicyData.*|.*Get-DomainSID.*|.*Get-DomainSPNTicket.*|.*Get-DomainSearcher.*|.*Get-DomainSite.*|.*Get-DomainSubnet.*|.*Get-DomainTrust.*|.*Get-DomainTrustMapping.*|.*Get-DomainUser.*|.*Get-DomainUserEvent.*|.*Get-Forest.*|.*Get-ForestDomain.*|.*Get-ForestGlobalCatalog.*|.*Get-ForestSchemaClass.*|.*Get-ForestTrust.*|.*Get-GPODelegation.*|.*Get-GPPAutologon.*|.*Get-GPPInnerField.*|.*Get-GPPInnerFields.*|.*Get-GPPPassword.*|.*Get-GptTmpl.*|.*Get-GroupsXML.*|.*Get-HttpStatus.*|.*Get-ImageNtHeaders.*|.*Get-Keystrokes.*|.*Get-MemoryProcAddress.*|.*Get-MicrophoneAudio.*|.*Get-ModifiablePath.*|.*Get-ModifiableRegistryAutoRun.*|.*Get-ModifiableScheduledTaskFile.*|.*Get-ModifiableService.*|.*Get-ModifiableServiceFile.*|.*Get-Name.*|.*Get-NetComputerSiteName.*|.*Get-NetLocalGroup.*|.*Get-NetLocalGroupMember.*|.*Get-NetLoggedon.*|.*Get-NetRDPSession.*|.*Get-NetSession.*|.*Get-NetShare.*|.*Get-PEArchitecture.*|.*Get-PEBasicInfo.*|.*Get-PEDetailedInfo.*|.*Get-PathAcl.*|.*Get-PrimaryToken.*|.*Get-ProcAddress.*|.*Get-ProcessTokenGroup.*|.*Get-ProcessTokenPrivilege.*|.*Get-ProcessTokenType.*|.*Get-RegLoggedOn.*|.*Get-RegistryAlwaysInstallElevated.*|.*Get-RegistryAutoLogon.*|.*Get-RemoteProcAddress.*|.*Get-Screenshot.*|.*Get-ServiceDetail.*|.*Get-SiteListPassword.*|.*Get-SitelistField.*|.*Get-System.*|.*Get-SystemNamedPipe.*|.*Get-SystemToken.*|.*Get-ThreadToken.*|.*Get-TimedScreenshot.*|.*Get-TokenInformation.*|.*Get-TopPort.*|.*Get-UnattendedInstallFile.*|.*Get-UniqueTokens.*|.*Get-UnquotedService.*|.*Get-VaultCredential.*|.*Get-VaultElementValue.*|.*Get-VirtualProtectValue.*|.*Get-VolumeShadowCopy.*|.*Get-WMIProcess.*|.*Get-WMIRegCachedRDPConnection.*|.*Get-WMIRegLastLoggedOn.*|.*Get-WMIRegMountedDrive.*|.*Get-WMIRegProxy.*|.*Get-WebConfig.*|.*Get-Win32Constants.*|.*Get-Win32Functions.*|.*Get-Win32Types.*|.*Import-DllImports.*|.*Import-DllInRemoteProcess.*|.*Inject-LocalShellcode.*|.*Inject-RemoteShellcode.*|.*Install-ServiceBinary.*|.*Invoke-CompareAttributesForClass.*|.*Invoke-CreateRemoteThread.*|.*Invoke-CredentialInjection.*|.*Invoke-DllInjection.*|.*Invoke-EventVwrBypass.*|.*Invoke-ImpersonateUser.*|.*Invoke-Kerberoast.*|.*Invoke-MemoryFreeLibrary.*|.*Invoke-MemoryLoadLibrary.*|.*Invoke-Method.*|.*Invoke-Mimikatz.*|.*Invoke-NinjaCopy.*|.*Invoke-PatchDll.*|.*Invoke-Portscan.*|.*Invoke-PrivescAudit.*|.*Invoke-ReflectivePEInjection.*|.*Invoke-ReverseDnsLookup.*|.*Invoke-RevertToSelf.*|.*Invoke-ServiceAbuse.*|.*Invoke-Shellcode.*|.*Invoke-TokenManipulation.*|.*Invoke-UserImpersonation.*|.*Invoke-WmiCommand.*|.*Mount-VolumeShadowCopy.*|.*New-ADObjectAccessControlEntry.*|.*New-DomainGroup.*|.*New-DomainUser.*|.*New-DynamicParameter.*|.*New-InMemoryModule.*|.*New-ThreadedFunction.*|.*New-VolumeShadowCopy.*|.*Out-CompressedDll.*|.*Out-EncodedCommand.*|.*Out-EncryptedScript.*|.*Out-Minidump.*|.*PortScan-Alive.*|.*Portscan-Port.*|.*Remove-DomainGroupMember.*|.*Remove-DomainObjectAcl.*|.*Remove-RemoteConnection.*|.*Remove-VolumeShadowCopy.*|.*Restore-ServiceBinary.*|.*Set-DesktopACLToAllowEveryone.*|.*Set-DesktopACLs.*|.*Set-DomainObject.*|.*Set-DomainObjectOwner.*|.*Set-DomainUserPassword.*|.*Set-ServiceBinaryPath.*|.*Sub-SignedIntAsUnsigned.*|.*Test-AdminAccess.*|.*Test-MemoryRangeValid.*|.*Test-ServiceDaclPermission.*|.*Update-ExeFunctions.*|.*Update-MemoryAddresses.*|.*Update-MemoryProtectionFlags.*|.*Write-BytesToMemory.*|.*Write-HijackDll.*|.*Write-PortscanOut.*|.*Write-ServiceBinary.*|.*Write-UserAddMSI.*|.*Invoke-Privesc.*|.*func_get_proc_address.*|.*Invoke-BloodHound.*|.*Invoke-HostEnum.*|.*Get-BrowserInformation.*|.*Get-DomainAccountPolicy.*|.*Get-DomainAdmins.*|.*Get-AVProcesses.*|.*Get-AVInfo.*|.*Get-RecycleBin.*|.*Invoke-BruteForce.*|.*Get-PassHints.*|.*Invoke-SessionGopher.*|.*Get-LSASecret.*|.*Get-PassHashes.*|.*Invoke-WdigestDowngrade.*|.*Get-ChromeDump.*|.*Invoke-DomainPasswordSpray.*|.*Get-FoxDump.*|.*New-HoneyHash.*|.*Invoke-DCSync.*|.*Invoke-PowerDump.*|.*Invoke-SSIDExfil.*|.*Invoke-PowerShellTCP.*|.*Add-Exfiltration.*|.*Do-Exfiltration.*|.*Invoke-DropboxUpload.*|.*Invoke-ExfilDataToGitHub.*|.*Invoke-EgressCheck.*|.*Invoke-PostExfil.*|.*Create-MultipleSessions.*|.*Invoke-NetworkRelay.*|.*New-GPOImmediateTask.*|.*Invoke-WMIDebugger.*|.*Invoke-SQLOSCMD.*|.*Invoke-SMBExec.*|.*Invoke-PSRemoting.*|.*Invoke-ExecuteMSBuild.*|.*Invoke-DCOM.*|.*Invoke-InveighRelay.*|.*Invoke-PsExec.*|.*Invoke-SSHCommand.*|.*Find-ActiveUsersWMI.*|.*Get-SystemDrivesWMI.*|.*Get-ActiveNICSWMI.*|.*Remove-Persistence.*|.*DNS_TXT_Pwnage.*|.*Execute-OnTime.*|.*HTTP-Backdoor.*|.*Add-ConstrainedDelegationBackdoor.*|.*Add-RegBackdoor.*|.*Add-ScrnSaveBackdoor.*|.*Gupt-Backdoor.*|.*Invoke-ADSBackdoor.*|.*Add-Persistence.*|.*Invoke-ResolverBackdoor.*|.*Invoke-EventLogBackdoor.*|.*Invoke-DeadUserBackdoor.*|.*Invoke-DisableMachineAcctChange.*|.*Invoke-AccessBinary.*|.*Add-NetUser.*|.*Invoke-Schtasks.*|.*Invoke-JSRatRegsvr.*|.*Invoke-JSRatRundll.*|.*Invoke-PoshRatHttps.*|.*Invoke-PsGcatAgent.*|.*Remove-PoshRat.*|.*Install-SSP.*|.*Invoke-BackdoorLNK.*|.*PowerBreach.*|.*InstallEXE-Persistence.*|.*RemoveEXE-Persistence.*|.*Install-ServiceLevel-Persistence.*|.*Remove-ServiceLevel-Persistence.*|.*Invoke-Prompt.*|.*Invoke-PacketCapture.*|.*Start-WebcamRecorder.*|.*Get-USBKeyStrokes.*|.*Invoke-KeeThief.*|.*Get-Keystrokes.*|.*Invoke-NetRipper.*|.*Get-EmailItems.*|.*Invoke-MailSearch.*|.*Invoke-SearchGAL.*|.*Get-WebCredentials.*|.*Start-CaptureServer.*|.*Invoke-PowerShellIcmp.*|.*Invoke-PowerShellTcpOneLine.*|.*Invoke-PowerShellTcpOneLineBind.*|.*Invoke-PowerShellUdp.*|.*Invoke-PowerShellUdpOneLine.*|.*Run-EXEonRemote.*|.*Download-Execute-PS.*|.*Out-RundllCommand.*|.*Set-RemoteWMI.*|.*Set-DCShadowPermissions.*|.*Invoke-PowerShellWMI.*|.*Invoke-Vnc.*|.*Invoke-LockWorkStation.*|.*Invoke-EternalBlue.*|.*Invoke-ShellcodeMSIL.*|.*Invoke-MetasploitPayload.*|.*Invoke-DowngradeAccount.*|.*Invoke-RunAs.*|.*ExetoText.*|.*Disable-SecuritySettings.*|.*Set-MacAttribute.*|.*Invoke-MS16032.*|.*Invoke-BypassUACTokenManipulation.*|.*Invoke-SDCLTBypass.*|.*Invoke-FodHelperBypass.*|.*Invoke-EventVwrBypass.*|.*Invoke-EnvBypass.*|.*Get-ServiceUnquoted.*|.*Get-ServiceFilePermission.*|.*Get-ServicePermission.*|.*Get-ServicePermission.*|.*Enable-DuplicateToken.*|.*Invoke-PsUaCme.*|.*Invoke-Tater.*|.*Invoke-WScriptBypassUAC.*|.*Invoke-AllChecks.*|.*Find-TrustedDocuments.*|.*Invoke-Interceptor.*|.*Invoke-PoshRatHttp.*|.*Invoke-ExecCommandWMI.*|.*Invoke-KillProcessWMI.*|.*Invoke-CreateShareandExecute.*|.*Invoke-RemoteScriptWithOutput.*|.*Invoke-SchedJobManipulation.*|.*Invoke-ServiceManipulation.*|.*Invoke-PowerOptionsWMI.*|.*Invoke-DirectoryListing.*|.*Invoke-FileTransferOverWMI.*|.*Invoke-WMImplant.*|.*Invoke-WMIObfuscatedPSCommand.*|.*Invoke-WMIDuplicateClass.*|.*Invoke-WMIUpload.*|.*Invoke-WMIRemoteExtract.*|.*Invoke-winPEAS.*|.*Set-PSBreakpoint.*)') and not subjectusersid in ('S-1-5-18', 'S-1-5-19') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(commandline, '(.*Add-DomainGroupMember.*|.*Add-DomainObjectAcl.*|.*Add-RemoteConnection.*|.*Add-ServiceDacl.*|.*Add-Win32Type.*|.*Convert-ADName.*|.*Convert-LDAPProperty.*|.*ConvertFrom-LDAPLogonHours.*|.*ConvertFrom-UACValue.*|.*Copy-ArrayOfMemAddresses.*|.*Create-NamedPipe.*|.*Create-ProcessWithToken.*|.*Create-RemoteThread.*|.*Create-SuspendedWinLogon.*|.*Create-WinLogonProcess.*|.*Emit-CallThreadStub.*|.*Enable-SeAssignPrimaryTokenPrivilege.*|.*Enable-SeDebugPrivilege.*|.*Enum-AllTokens.*|.*Export-PowerViewCSV.*|.*Find-AVSignature.*|.*Find-AppLockerLog.*|.*Find-DomainLocalGroupMember.*|.*Find-DomainObjectPropertyOutlier.*|.*Find-DomainProcess.*|.*Find-DomainShare.*|.*Find-DomainUserEvent.*|.*Find-DomainUserLocation.*|.*Find-InterestingDomainAcl.*|.*Find-InterestingDomainShareFile.*|.*Find-InterestingFile.*|.*Find-LocalAdminAccess.*|.*Find-PSScriptsInPSAppLog.*|.*Find-PathDLLHijack.*|.*Find-ProcessDLLHijack.*|.*Find-RDPClientConnection.*|.*Get-AllAttributesForClass.*|.*Get-CachedGPPPassword.*|.*Get-DecryptedCpassword.*|.*Get-DecryptedSitelistPassword.*|.*Get-DelegateType.*|.*Get-DomainDFSShare.*|.*Get-DomainDFSShareV1.*|.*Get-DomainDFSShareV2.*|.*Get-DomainDNSRecord.*|.*Get-DomainDNSZone.*|.*Get-DomainFileServer.*|.*Get-DomainForeignGroupMember.*|.*Get-DomainForeignUser.*|.*Get-DomainGPO.*|.*Get-DomainGPOComputerLocalGroupMapping.*|.*Get-DomainGPOLocalGroup.*|.*Get-DomainGPOUserLocalGroupMapping.*|.*Get-DomainGUIDMap.*|.*Get-DomainGroup.*|.*Get-DomainGroupMember.*|.*Get-DomainGroupMemberDeleted.*|.*Get-DomainManagedSecurityGroup.*|.*Get-DomainOU.*|.*Get-DomainObject.*|.*Get-DomainObjectAcl.*|.*Get-DomainObjectAttributeHistory.*|.*Get-DomainObjectLinkedAttributeHistory.*|.*Get-DomainPolicyData.*|.*Get-DomainSID.*|.*Get-DomainSPNTicket.*|.*Get-DomainSearcher.*|.*Get-DomainSite.*|.*Get-DomainSubnet.*|.*Get-DomainTrust.*|.*Get-DomainTrustMapping.*|.*Get-DomainUser.*|.*Get-DomainUserEvent.*|.*Get-Forest.*|.*Get-ForestDomain.*|.*Get-ForestGlobalCatalog.*|.*Get-ForestSchemaClass.*|.*Get-ForestTrust.*|.*Get-GPODelegation.*|.*Get-GPPAutologon.*|.*Get-GPPInnerField.*|.*Get-GPPInnerFields.*|.*Get-GPPPassword.*|.*Get-GptTmpl.*|.*Get-GroupsXML.*|.*Get-HttpStatus.*|.*Get-ImageNtHeaders.*|.*Get-Keystrokes.*|.*Get-MemoryProcAddress.*|.*Get-MicrophoneAudio.*|.*Get-ModifiablePath.*|.*Get-ModifiableRegistryAutoRun.*|.*Get-ModifiableScheduledTaskFile.*|.*Get-ModifiableService.*|.*Get-ModifiableServiceFile.*|.*Get-Name.*|.*Get-NetComputerSiteName.*|.*Get-NetLocalGroup.*|.*Get-NetLocalGroupMember.*|.*Get-NetLoggedon.*|.*Get-NetRDPSession.*|.*Get-NetSession.*|.*Get-NetShare.*|.*Get-PEArchitecture.*|.*Get-PEBasicInfo.*|.*Get-PEDetailedInfo.*|.*Get-PathAcl.*|.*Get-PrimaryToken.*|.*Get-ProcAddress.*|.*Get-ProcessTokenGroup.*|.*Get-ProcessTokenPrivilege.*|.*Get-ProcessTokenType.*|.*Get-RegLoggedOn.*|.*Get-RegistryAlwaysInstallElevated.*|.*Get-RegistryAutoLogon.*|.*Get-RemoteProcAddress.*|.*Get-Screenshot.*|.*Get-ServiceDetail.*|.*Get-SiteListPassword.*|.*Get-SitelistField.*|.*Get-System.*|.*Get-SystemNamedPipe.*|.*Get-SystemToken.*|.*Get-ThreadToken.*|.*Get-TimedScreenshot.*|.*Get-TokenInformation.*|.*Get-TopPort.*|.*Get-UnattendedInstallFile.*|.*Get-UniqueTokens.*|.*Get-UnquotedService.*|.*Get-VaultCredential.*|.*Get-VaultElementValue.*|.*Get-VirtualProtectValue.*|.*Get-VolumeShadowCopy.*|.*Get-WMIProcess.*|.*Get-WMIRegCachedRDPConnection.*|.*Get-WMIRegLastLoggedOn.*|.*Get-WMIRegMountedDrive.*|.*Get-WMIRegProxy.*|.*Get-WebConfig.*|.*Get-Win32Constants.*|.*Get-Win32Functions.*|.*Get-Win32Types.*|.*Import-DllImports.*|.*Import-DllInRemoteProcess.*|.*Inject-LocalShellcode.*|.*Inject-RemoteShellcode.*|.*Install-ServiceBinary.*|.*Invoke-CompareAttributesForClass.*|.*Invoke-CreateRemoteThread.*|.*Invoke-CredentialInjection.*|.*Invoke-DllInjection.*|.*Invoke-EventVwrBypass.*|.*Invoke-ImpersonateUser.*|.*Invoke-Kerberoast.*|.*Invoke-MemoryFreeLibrary.*|.*Invoke-MemoryLoadLibrary.*|.*Invoke-Method.*|.*Invoke-Mimikatz.*|.*Invoke-NinjaCopy.*|.*Invoke-PatchDll.*|.*Invoke-Portscan.*|.*Invoke-PrivescAudit.*|.*Invoke-ReflectivePEInjection.*|.*Invoke-ReverseDnsLookup.*|.*Invoke-RevertToSelf.*|.*Invoke-ServiceAbuse.*|.*Invoke-Shellcode.*|.*Invoke-TokenManipulation.*|.*Invoke-UserImpersonation.*|.*Invoke-WmiCommand.*|.*Mount-VolumeShadowCopy.*|.*New-ADObjectAccessControlEntry.*|.*New-DomainGroup.*|.*New-DomainUser.*|.*New-DynamicParameter.*|.*New-InMemoryModule.*|.*New-ThreadedFunction.*|.*New-VolumeShadowCopy.*|.*Out-CompressedDll.*|.*Out-EncodedCommand.*|.*Out-EncryptedScript.*|.*Out-Minidump.*|.*PortScan-Alive.*|.*Portscan-Port.*|.*Remove-DomainGroupMember.*|.*Remove-DomainObjectAcl.*|.*Remove-RemoteConnection.*|.*Remove-VolumeShadowCopy.*|.*Restore-ServiceBinary.*|.*Set-DesktopACLToAllowEveryone.*|.*Set-DesktopACLs.*|.*Set-DomainObject.*|.*Set-DomainObjectOwner.*|.*Set-DomainUserPassword.*|.*Set-ServiceBinaryPath.*|.*Sub-SignedIntAsUnsigned.*|.*Test-AdminAccess.*|.*Test-MemoryRangeValid.*|.*Test-ServiceDaclPermission.*|.*Update-ExeFunctions.*|.*Update-MemoryAddresses.*|.*Update-MemoryProtectionFlags.*|.*Write-BytesToMemory.*|.*Write-HijackDll.*|.*Write-PortscanOut.*|.*Write-ServiceBinary.*|.*Write-UserAddMSI.*|.*Invoke-Privesc.*|.*func_get_proc_address.*|.*Invoke-BloodHound.*|.*Invoke-HostEnum.*|.*Get-BrowserInformation.*|.*Get-DomainAccountPolicy.*|.*Get-DomainAdmins.*|.*Get-AVProcesses.*|.*Get-AVInfo.*|.*Get-RecycleBin.*|.*Invoke-BruteForce.*|.*Get-PassHints.*|.*Invoke-SessionGopher.*|.*Get-LSASecret.*|.*Get-PassHashes.*|.*Invoke-WdigestDowngrade.*|.*Get-ChromeDump.*|.*Invoke-DomainPasswordSpray.*|.*Get-FoxDump.*|.*New-HoneyHash.*|.*Invoke-DCSync.*|.*Invoke-PowerDump.*|.*Invoke-SSIDExfil.*|.*Invoke-PowerShellTCP.*|.*Add-Exfiltration.*|.*Do-Exfiltration.*|.*Invoke-DropboxUpload.*|.*Invoke-ExfilDataToGitHub.*|.*Invoke-EgressCheck.*|.*Invoke-PostExfil.*|.*Create-MultipleSessions.*|.*Invoke-NetworkRelay.*|.*New-GPOImmediateTask.*|.*Invoke-WMIDebugger.*|.*Invoke-SQLOSCMD.*|.*Invoke-SMBExec.*|.*Invoke-PSRemoting.*|.*Invoke-ExecuteMSBuild.*|.*Invoke-DCOM.*|.*Invoke-InveighRelay.*|.*Invoke-PsExec.*|.*Invoke-SSHCommand.*|.*Find-ActiveUsersWMI.*|.*Get-SystemDrivesWMI.*|.*Get-ActiveNICSWMI.*|.*Remove-Persistence.*|.*DNS_TXT_Pwnage.*|.*Execute-OnTime.*|.*HTTP-Backdoor.*|.*Add-ConstrainedDelegationBackdoor.*|.*Add-RegBackdoor.*|.*Add-ScrnSaveBackdoor.*|.*Gupt-Backdoor.*|.*Invoke-ADSBackdoor.*|.*Add-Persistence.*|.*Invoke-ResolverBackdoor.*|.*Invoke-EventLogBackdoor.*|.*Invoke-DeadUserBackdoor.*|.*Invoke-DisableMachineAcctChange.*|.*Invoke-AccessBinary.*|.*Add-NetUser.*|.*Invoke-Schtasks.*|.*Invoke-JSRatRegsvr.*|.*Invoke-JSRatRundll.*|.*Invoke-PoshRatHttps.*|.*Invoke-PsGcatAgent.*|.*Remove-PoshRat.*|.*Install-SSP.*|.*Invoke-BackdoorLNK.*|.*PowerBreach.*|.*InstallEXE-Persistence.*|.*RemoveEXE-Persistence.*|.*Install-ServiceLevel-Persistence.*|.*Remove-ServiceLevel-Persistence.*|.*Invoke-Prompt.*|.*Invoke-PacketCapture.*|.*Start-WebcamRecorder.*|.*Get-USBKeyStrokes.*|.*Invoke-KeeThief.*|.*Get-Keystrokes.*|.*Invoke-NetRipper.*|.*Get-EmailItems.*|.*Invoke-MailSearch.*|.*Invoke-SearchGAL.*|.*Get-WebCredentials.*|.*Start-CaptureServer.*|.*Invoke-PowerShellIcmp.*|.*Invoke-PowerShellTcpOneLine.*|.*Invoke-PowerShellTcpOneLineBind.*|.*Invoke-PowerShellUdp.*|.*Invoke-PowerShellUdpOneLine.*|.*Run-EXEonRemote.*|.*Download-Execute-PS.*|.*Out-RundllCommand.*|.*Set-RemoteWMI.*|.*Set-DCShadowPermissions.*|.*Invoke-PowerShellWMI.*|.*Invoke-Vnc.*|.*Invoke-LockWorkStation.*|.*Invoke-EternalBlue.*|.*Invoke-ShellcodeMSIL.*|.*Invoke-MetasploitPayload.*|.*Invoke-DowngradeAccount.*|.*Invoke-RunAs.*|.*ExetoText.*|.*Disable-SecuritySettings.*|.*Set-MacAttribute.*|.*Invoke-MS16032.*|.*Invoke-BypassUACTokenManipulation.*|.*Invoke-SDCLTBypass.*|.*Invoke-FodHelperBypass.*|.*Invoke-EventVwrBypass.*|.*Invoke-EnvBypass.*|.*Get-ServiceUnquoted.*|.*Get-ServiceFilePermission.*|.*Get-ServicePermission.*|.*Get-ServicePermission.*|.*Enable-DuplicateToken.*|.*Invoke-PsUaCme.*|.*Invoke-Tater.*|.*Invoke-WScriptBypassUAC.*|.*Invoke-AllChecks.*|.*Find-TrustedDocuments.*|.*Invoke-Interceptor.*|.*Invoke-PoshRatHttp.*|.*Invoke-ExecCommandWMI.*|.*Invoke-KillProcessWMI.*|.*Invoke-CreateShareandExecute.*|.*Invoke-RemoteScriptWithOutput.*|.*Invoke-SchedJobManipulation.*|.*Invoke-ServiceManipulation.*|.*Invoke-PowerOptionsWMI.*|.*Invoke-DirectoryListing.*|.*Invoke-FileTransferOverWMI.*|.*Invoke-WMImplant.*|.*Invoke-WMIObfuscatedPSCommand.*|.*Invoke-WMIDuplicateClass.*|.*Invoke-WMIUpload.*|.*Invoke-WMIRemoteExtract.*|.*Invoke-winPEAS.*|.*Set-PSBreakpoint.*)') and not subjectusersid in ('S-1-5-18', 'S-1-5-19') | groupby user, system

stream=authentication where action='LOGIN_NOTIF' and status='FAILED' | duration 5m | groupby srcip, authproto | limit 100

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Remove%AzureADUser%' or commandline like '%az%ad%user%delete%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Remove%AzureADUser%' or commandline like '%az%ad%user%delete%') | groupby user, system

stream=ep-process where eid in ('1','3') and image like '%powershell.exe' and (commandline like '%-NoP -sta -NonI -W Hidden -Enc%' or commandline like '%-noP -sta -w 1 -enc%' or commandline like '%-NoP -NonI -W Hidden -enc%' or commandline like '%-noP -sta -w 1 -enc%' or commandline like '%-enc  SQB%' or commandline like '%-nop -exec bypass -EncodedCommand%') |  groupby user, commandline, system

stream=VPN where sourcename='FORTIGATE' and eventid='0101039943' and action='SSL_NEW_CON' | groupby devsrcip, srcip | duration 24h | limit 10

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0') | groupby user, system

stream=configuration where sourcename='F5BIGIP' and action='CONFIGURATION_CHANGED' and logcode in ('01310053','01070417') | duration 1h | select user, system, count(*) as CountUnique | groupby user, system | having CountUnique>=5

stream=configuration where sourcename='F5BIGIP' and logcode in ('01310053','01070417') and not user in ('fwadmin','root','admin') and user='{SuspectUser}' and system='{TargetHost}'

stream=WEBFILTER where (URL like "%%%3Cscript%3E%" or URL like "%%<script%%" or URL like "%%&#x3C;script&#x3E;%" or URL like "%%&lt;script%&gt;%") | groupby srcip, dstip

stream=auditd where sourcename='F5BIGIP' and logcode='01420007' | duration 7d | select file, distinct_count(system) as CountUnique | groupby file | having CountUnique>=1

stream=webserver where (rlike(url,"/../") or rlike(url,"/..%2f") or rlike(url,"%2e%2e%2f") or rlike(url,"%2e%2e/") or rlike(url,"..\\..\\")) | groupby srcip, devsrcip

stream=SYSMON-PROCESS where sourcename="WINDOWS" and commandline like "%cmstp%" and commandline like "%.inf%" | groupby image, devsrcip, ParentCommandLine, user 

stream=configuration where sourcename='F5BIGIP' and logcode in ('01310053','01070417') and not user in ('fwadmin','root','admin') | duration 1h | select user, system, count(*) as CountUnique | groupby user, system | having CountUnique>=5

stream=webserver where (rlike(url,"/../") or rlike(url,"/..%2f") or rlike(url,"%2e%2e%2f") or rlike(url,"%2e%2e/") or rlike(url,"..\\..\\")) | groupby srcip, devsrcip

stream=auditd where sourcename='F5BIGIP' and logcode='01420007' | duration 7d | select file, distinct_count(system) as CountUnique | groupby file | having CountUnique>=1

stream=webserver where ((url like "%/tmui/%" or url like "%/hsqldb%") and (url like "%..;/%" or url like "%.jsp/..%")) and status='PASSED' and action='REQUEST_ALLOWED' | groupby system

stream=ep-process where ( parentimage like "%powershell.exe%" OR parentimage like "%PowerShell.exe%" OR parentimage like "%powershell%" OR  parentimage like "%cmd%") and (commandline like "%fileNameToDelete = %.crmlog%"
 or commandline like "%Remove-Item -Path%") | groupby user, system

stream=WIN-AUDIT,EP-PROCESS where action IN ("PROCESS_CREATED", "PROCESS_ADDED") and rlike(lower(commandline), "(wmic.*?process.*?where.*?(msmpeng|mssense|smartscreen|windefend|mpssvc|nortonantivirus|ccsvchst|mcshield|mfevtps|avp).*?name.*?delte|(taskkill.*?f.*?im|pskill|processhacker.*?type.*?process.*?kill|backstab.*?-k.*?-n).*?(msmpeng|smartscreen|windefend|mpssvc|nortonantivirus|ccsvchst|mssense|mcshield|mfevtps|avp))") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT,EP-PROCESS where action IN ("PROCESS_CREATED", "PROCESS_ADDED") and rlike(lower(commandline), "(wmic.*?process.*?where.*?(msmpeng|mssense|smartscreen|windefend|mpssvc|nortonantivirus|ccsvchst|mcshield|mfevtps|avp).*?name.*?delte|(taskkill.*?f.*?im|pskill|processhacker.*?type.*?process.*?kill|backstab.*?-k.*?-n).*?(msmpeng|smartscreen|windefend|mpssvc|nortonantivirus|ccsvchst|mssense|mcshield|mfevtps|avp))") |  groupby user, system

stream=firewall | groupby srcip, action


stream=configuration where sourcename='F5BIGIP' and logcode in ('01310053','01070417') and not user in ('fwadmin','root','admin') | duration 1h | select user, system, count(*) as CountUnique | groupby user, system | having CountUnique>=5

stream=iam where sourcename='FORTIGATE' and SubSystem='ADMINISTRATION' and action='REPORT_DELETED' and status='PASSED'|  groupby devsrcip | duration 30d | limit 10

stream=configuration where sourcename='F5BIGIP' and logcode in ('01310053','01070417') and not user in ('fwadmin','root','admin') | duration 1h | select user, system, count(*) as CountUnique | groupby user, system | having CountUnique>=5

stream=win-audit where  action="PROCESS_CREATED" and lower(commandline) like '%reg.exe%hklm%software%microsoft%windows%currentversion%policies%system%consentpromptbehavioradmin%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where  action="PROCESS_CREATED" and lower(commandline) like '%reg.exe%hklm%software%microsoft%windows%currentversion%policies%system%consentpromptbehavioradmin%0%' | groupby user, system

stream=webserver where (rlike(url,"\\%24\\%7B") or rlike(url,"\\%24\\%28") or rlike(url."\\%24\\%7C")) | groupby srcip, devsrcip

stream=configuration where sourcename='F5BIGIP' and logcode in ('01310053','01070417') and not user in ('fwadmin','root','admin') and user='{SuspectUser}' and system='{TargetHost}'

stream=configuration where sourcename='F5BIGIP' and logcode in ('01310053','01070417') and not user in ('fwadmin','root','admin') | duration 1h | select user, system, count(*) as CountUnique | groupby user, system | having CountUnique>=5

stream=* | groupby devsrcip | duration 7d

stream=WEBFILTER where ( rlike(url,"\\%\\%3Cscript\\%3E") or rlike(url,"\\%\\<script\\%") or rlike(url,"\\%\\&\\#x3C\\;script\\&\\#x3E\\;") or rlike(url,"\\%\\&lt\\;script\\%\\&gt\\;")) | groupby srcip, dstip

stream=win-audit where eid in ('4663', '4656') and (object like "%keyboard%" or object like "%keylog%") and action="OBJECT_ACCESSED" and user='{SuspectHost}' and devsrcip='{TargetHost}'

stream=win-audit where eid in ('4663', '4656') and (object like "%keyboard%" or object like "%keylog%") and action="OBJECT_ACCESSED" | groupby srcip, user

stream=IAM where action='PRIVILEGE_CHANGED' and status='PASSED' and role='Special Logon' | duration 1h | groupby user, targetuser

stream=IAM where action='PRIVILEGE_CHANGED' and status='PASSED' and role='Special Logon' and targetuser='{TargetUser}' and user='{SuspectUser}'

stream=ep-process where eid='1' and (commandline like '%Get-History%' or  commandline like '%AppData%Roaming%Microsoft%Windows%PowerShell%PSReadline%ConsoleHost_history.txt%' or commandline like '%Get-PSReadlineOption.HistorySavePath%') and not system='PC.local'| groupby user, hash, commandline, system 

stream=webserver where (rlike(url,"/../") or rlike(url,"/..%2f") or rlike(url,"%2e%2e%2f") or rlike(url,"%2e%2e/") or rlike(url,"..\\..\\")) | groupby srcip

stream=webserver where (rlike(url,"/../") or rlike(url,"/..%2f") or rlike(url,"%2e%2e%2f") or rlike(url,"%2e%2e/") or rlike(url,"..\\..\\")) and srcip='{SuspectHost}'

stream=threat where sourcename='F5BIGIP' and action='THREAT_DETECTED' and status='PASSED' and vector='WEB' and srcip='{SuspectHost}' and dstip='{TargetHost}'

stream=threat where sourcename='F5BIGIP' and action='THREAT_DETECTED' and status='PASSED' and vector='WEB' | groupby srcip, dstip

stream=auditd where sourcename='F5BIGIP' and logcode='01420007' and us

stream=auditd where sourcename='F5BIGIP' and action='CERTIFICATE_EXPIRED' and logcode='01420007' | groupby user, system 

stream=webserver where ( rlike(url,"\\%\\%3Cscript\\%3E") or rlike(url,"\\%\\<script\\%") or rlike(url,"\\%\\&\\#x3C\\;script\\&\\#x3E\\;") or rlike(url,"\\%\\&lt\\;script\\%\\&gt\\;")) | groupby srcip

stream=webserver where ( rlike(url,"\\%\\%3Cscript\\%3E") or rlike(url,"\\%\\<script\\%") or rlike(url,"\\%\\&\\#x3C\\;script\\&\\#x3E\\;") or rlike(url,"\\%\\&lt\\;script\\%\\&gt\\;")) and srcip='{SyspectHost}'

stream=DNS where query like "%antimalware%" and srcip='{SuspectHost}'

stream=& | groupby srcip

stream=configuration where sourcetype="FIREWALL" and not config like "%delete%phase" and not config like "%IPsec%phase%" | groupby action, config 

stream=WIN-AUDIT where eid='4663' and @event_category="Removable Storage" and (@access="WriteData%" or @access="%AppendData%") | select distinct_count(object) as DataCopied | groupby user | having DataCopied>100

stream=webserver where (rlike(url,"\\%24\\%7B") or rlike(url,"\\%24\\%28") or rlike(url."\\%24\\%7C")) | groupby srcip

stream=webserver where (rlike(url,"\\%24\\%7B") or rlike(url,"\\%24\\%28") or rlike(url."\\%24\\%7C")) and srcip='{SuspectHost}'

stream=authentication |  groupby user |  limit 3

stream=iam where sourcename='FORTIGATE' and SubSystem='ADMINISTRATION' and action='REPORT_CREATED' and status='PASSED'| groupby devsrcip | duration 24h | limit 10

stream=webserver where (rlike(url,"/../") or rlike(url,"/..%2f") or rlike(url,"%2e%2e%2f") or rlike(url,"%2e%2e/") or rlike(url,"..\\..\\")) and srcip='{SuspectHost}'

stream=webserver where (rlike(url,"/../") or rlike(url,"/..%2f") or rlike(url,"%2e%2e%2f") or rlike(url,"%2e%2e/") or rlike(url,"..\\..\\")) | groupby srcip, devsrcip

stream=webserver where (rlike(url,"\\%24\\%7B") or rlike(url,"\\%24\\%28") or rlike(url."\\%24\\%7C")) and srcip='{SuspectHost}'

stream=webserver where (rlike(url,"\\%24\\%7B") or rlike(url,"\\%24\\%28") or rlike(url."\\%24\\%7C")) | groupby srcip

stream=SYSMON-REGISTRY where sourcename="WINDOWS" and action="OBJECT_MODIFIED" and TargetObject="HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Image File Execution Options\\New Key #1" and image="C:\\Windows\\regedit.exe" | groupby devsrcip

stream=webserver where (rlike(url,"\\%24\\%7B") or rlike(url,"\\%24\\%28") or rlike(url."\\%24\\%7C")) and srcip='{SuspectHost}'

stream=webserver where (rlike(url,"\\%24\\%7B") or rlike(url,"\\%24\\%28") or rlike(url."\\%24\\%7C")) | groupby srcip

stream=EP-PROCESS where eid in ('1', '4104') and image like "%powershell.exe" and lower(CommandLine) like "%powershell%-encodedcommand%" |  groupby user, srcip, hostname

stream=webserver where (rlike(url,"/../") or rlike(url,"/..%2f") or rlike(url,"%2e%2e%2f") or rlike(url,"%2e%2e/") or rlike(url,"..\\..\\")) and srcip='{SuspectHost}'

stream=webserver where (rlike(url,"/../") or rlike(url,"/..%2f") or rlike(url,"%2e%2e%2f") or rlike(url,"%2e%2e/") or rlike(url,"..\\..\\")) | groupby srcip

stream=webserver where ( rlike(url,"\\%\\%3Cscript\\%3E") or rlike(url,"\\%\\<script\\%") or rlike(url,"\\%\\&\\#x3C\\;script\\&\\#x3E\\;") or rlike(url,"\\%\\&lt\\;script\\%\\&gt\\;")) | groupby srcip

stream=webserver where ( rlike(url,"\\%\\%3Cscript\\%3E") or rlike(url,"\\%\\<script\\%") or rlike(url,"\\%\\&\\#x3C\\;script\\&\\#x3E\\;") or rlike(url,"\\%\\&lt\\;script\\%\\&gt\\;")) and srcip='{SyspectHost}'

stream=configuration where action='CONFIGURATION_CHANGED' and lower(commandline) like '%vssadmin%resize%shadowstorage%' and user='{SuspectUser}' and system='{TargetHost}' | duration 1h


stream=configuration where action='CONFIGURATION_CHANGED' and lower(commandline) like '%vssadmin%resize%shadowstorage%' | groupby user, system | duration 1h

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='powershell.exe' and commandline like '%powershell.exe%Set-ExecutionPolicy%Bypass%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='powershell.exe' and commandline like '%powershell.exe%Set-ExecutionPolicy%Bypass%' | groupby user, system

stream=authentication where sourcename='FORTIGATE' and authproto='VPN' | groupby action, srcip, user | duration 1d | limit 100

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz%exe%crypto%certificate%export%') | groupby user,system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz%exe%crypto%certificate%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.56' and eventid='706' | groupby config | duration 30d | limit 100 

stream=authentication

stream=webserver where ((url like "%/tmui/%" or url like "%/hsqldb%") and (url like "%..;/%" or url like "%.jsp/..%")) and status='PASSED' and action='REQUEST_ALLOWED' | groupby system

stream=webserver where ((url like "%/tmui/%" or url like "%/hsqldb%") and (url like "%..;/%" or url like "%.jsp/..%")) and status='PASSED' and action='REQUEST_ALLOWED' and system='{TargetHost}'

stream=auditd where sourcename='F5BIGIP' and logcode='01420007' | groupby system 

stream=ep-process where ((image like '%\CamMute.exe' not image like '%\Lenovo\Communication Utility\%') or (image like '%\chrome_frame_helper.exe' not image like '%\Google\Chrome\application\%') or (image like '%\dvcemumanager.exe' not image like '%\Microsoft Device Emulator\%') or (image like '%\Gadget.exe' not image like '%\Windows Media Player\%') or (image like '%\hcc.exe' not image like '%\HTML Help Workshop\%') or (image like '%\hkcmd.exe' not image  ["*\System32\*", "*\SysNative\*", "*\SysWowo64\*"]) OR (image="*\Mc.exe" -image IN ["*\Microsoft Visual Studio*", "*\Microsoft SDK*", "*\Windows Kit*"]) OR (image="*\MsMpEng.exe" -image IN ["*\Microsoft Security Client\*", "*\Windows Defender\*", "*\AntiMalware\*"]) OR (image="*\msseces.exe" -image IN ["*\Microsoft Security Center\*", "*\Microsoft Security Client\*", "*\Microsoft Security Essentials\*"]) OR (image="*\OInfoP11.exe" -image="*\Common Files\Microsoft Shared\*") OR (image="*\OleView.exe" -image IN ["*\Microsoft Visual Studio*", "*\Microsoft SDK*", "*\Windows Kit*", "*\Windows Resource Kit\*"]) OR (image="*\rc.exe" -image IN ["*\Microsoft Visual Studio*", "*\Microsoft SDK*", "*\Windows Kit*", "*\Windows Resource Kit\*", "*\Microsoft.NET\*"]))

stream=ep-process where ( parentimage like "%powershell.exe%" OR parentimage like "%PowerShell.exe%" OR parentimage like "%powershell%" OR  parentimage like "%cmd%") and (commandline like "%fileNameToDelete = %.crmlog%"
 or commandline like "%Remove-Item -Path%") | groupby user, system

stream=firewall | duration 2M | groupby srcip | limit 2

stream=auditd where sourcename='F5BIGIP' and logcode='01420007' | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='powershell.exe' and commandline like '%powershell.exe%Set-ExecutionPolicy%Bypass%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='powershell.exe' and commandline like '%powershell.exe%Set-ExecutionPolicy%Bypass%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=auditd where sourcename='F5BIGIP' and logcode='01420007' | groupby user, system 

stream=auditd where sourcename='F5BIGIP' and logcode='01420007' and us

stream=auditd where sourcename='F5BIGIP' and logcode='01420007' | groupby user, system 

stream=firewall where action='PACKET_BLOCKED' | duration 1h |  groupby srcip, dstip | limit 1 

stream=signals | duration 1M | limit 1

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0') | groupby user, system

stream=authentication where action= 'LOGIN' and status= 'FAILED' | groupby user | limit 5

stream=other | limit 1

stream=configuration where sourcename='F5BIGIP' and logcode in ('01310053','01070417') and not user in ('fwadmin','root','admin') and user='{SuspectUser}' and system='{TargetHost}'

stream=configuration where sourcename='F5BIGIP' and logcode in ('01310053','01070417') | duration 1h | select user, system, count(*) as CountUnique | groupby user, system | having CountUnique>=5

stream=threat where sourcename='F5BIGIP' and action='THREAT_DETECTED' and status='PASSED' and vector='WEB' and srcip='{SuspectHost}' and dstip='{TargetHost}'

stream=threat where sourcename='F5BIGIP' and action='THREAT_DETECTED' and status='PASSED' and vector='WEB' | groupby srcip, dstip

stream=EP-PROCESS where eid in ('1', '4104') and parentimage like "%powershell.exe" and lower(parentCommandLine) like "%powershell%-encodedcommand%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where eid in ('1', '4104') and parentimage like "%powershell.exe" and lower(parentCommandLine) like "%powershell%-encodedcommand%" |  groupby user, system

stream=* | duration=15m |  groupby srcip

stream=AUTHENTICATION where sourcename='F5BIGIP' and action='LOGIN' and status='FALIED' and reason='INVALID_CREDENTIALS' and user='{SuspectUser}' and system='{TargetHost}'

stream=AUTHENTICATION where sourcename='F5BIGIP' and action='LOGIN' and status='FALIED' and reason='INVALID_CREDENTIALS' | duration 5m | groupby User, system | having count_col0 > 3

stream=EP-PROCESS where eid in ('1', '4104') and parentimage like "%powershell.exe" and lower(parentCommandLine) like "%powershell%-encodedcommand%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where eid in ('1', '4104') and parentimage like "%powershell.exe" and lower(parentCommandLine) like "%powershell%-encodedcommand%" |  groupby user, system

stream=EP-PROCESS where eid in ('1', '4104') and parentimage like "%powershell.exe" and lower(parentCommandLine) like "%powershell%-encodedcommand%" |  groupby user, system

stream=EP-PROCESS where eid in ('1', '4104') and parentimage like "%powershell.exe" and lower(parentCommandLine) like "%powershell%-encodedcommand%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where eid in ('1', '4104') and parentimage like "%powershell.exe" and lower(parentCommandLine) like "%powershell%-encodedcommand%" |  groupby user, system

stream=EP-PROCESS where eid in ('1', '4104') and parentimage like "%powershell.exe" and lower(parentCommandLine) like "%powershell%-encodedcommand%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process, win-audit,configuration where action in ('PROCESS_CREATED', 'PROCESS_ADDED', 'CONFIGURATION_CHANGED') and lower(commandline) like '%vssadmin%resize%shadowstorage%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit,configuration where action in ('PROCESS_CREATED', 'PROCESS_ADDED', 'CONFIGURATION_CHANGED') and lower(commandline) like '%vssadmin%resize%shadowstorage%' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "%powershell.exe" and lower(parentCommandLine) like "%powershell%-encodedcommand%" |  groupby user, system

stream=EP-PROCESS where eid in ('1', '4104') and parentimage like "%powershell.exe" and lower(parentCommandLine) like "%powershell%-encodedcommand%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where image like "%powershell%" and commandline like "%WindowsAudioDevice-Powershell-Cmdlet%" and action='PROCESS_ADDED' | groupby system, user

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershel\\.exe)')

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline),  "(windowsaudiodevice-powershell-cmdlet|get-audiodevice|set-audiodevice|toggle-audiodevice|write-audiodevice|start-audiodevicecapture)") | duration 2h

stream=firewall where sourcename='CHECKPOINT' and srcip is not null | groupby srcip, system

stream=ep-process,win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(windowsaudiodevice-powershell-cmdlet|get-audiodevice|set-audiodevice|toggle-audiodevice|write-audiodevice|start-audiodevicecapture)") | groupby user, system

stream=ep-process,win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(windowsaudiodevice-powershell-cmdlet|get-audiodevice|set-audiodevice|toggle-audiodevice|write-audiodevice|start-audiodevicecapture)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=authentication where action="LOGIN" |  groupby status

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, '(C.*\\.zip.*exe|C.*\\.rar.*exe|C.*\\.7z.*exe|C.*\\.tar.*exe|C.*\\.zip|C.*\\.rar|C.*\\.7z|C.*\\.tar)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, '(C.*\\.zip.*exe|C.*\\.rar.*exe|C.*\\.7z.*exe|C.*\\.tar.*exe|C.*\\.zip|C.*\\.rar|C.*\\.7z|C.*\\.tar)') |  groupby user, system 

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, '(C.*\\.zip.*exe|C.*\\.rar.*exe|C.*\\.7z.*exe|C.*\\.tar.*exe|C.*\\.zip|C.*\\.rar|C.*\\.7z|C.*\\.tar)') |  groupby user, system | duration 1h

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, '(C.*\\.zip.*exe|C.*\\.rar.*exe|C.*\\.7z.*exe|C.*\\.tar.*exe|C.*\\.zip|C.*\\.rar|C.*\\.7z|C.*\\.tar)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, '(C.*\\.zip.*exe|C.*\\.rar.*exe|C.*\\.7z.*exe|C.*\\.tar.*exe|C.*\\.zip|C.*\\.rar|C.*\\.7z|C.*\\.tar)') |  groupby user, system 

stream=configuration where sourcename='WINDOWS' and eid='106' and action='CONFIGURATION_CHANGED' and system='{TargetHost}' and user='{SuspectUser}'

stream=configuration where sourcename='WINDOWS' and eid='106' and action='CONFIGURATION_CHANGED' | groupby system, user | limit 10 | duration 20h

stream=ep-process where ( parentimage like "%powershell.exe%" OR parentimage like "%PowerShell.exe%" OR parentimage like "%powershell%" OR  parentimage like "%cmd%") and (commandline like "%fileNameToDelete = %.crmlog%"
 or commandline like "%Remove-Item -Path%") | groupby user, system

stream=ep-process where ( parentimage like "%powershell.exe%" OR parentimage like "%PowerShell.exe%" OR parentimage like "%powershell%" OR  parentimage like "%cmd%") and (commandline like "%fileNameToDelete = %.crmlog%"
 or commandline like "%Remove-Item -Path%") and user='{SuspectUser}' and system='{TargetHost}'

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=authentication |  groupby user |  limit 3

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, '(C.*\\.zip.*exe|C.*\\.rar.*exe|C.*\\.7z.*exe|C.*\\.tar.*exe|C.*\\.zip|C.*\\.rar|C.*\\.7z|C.*\\.tar)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, '(C.*\\.zip.*exe|C.*\\.rar.*exe|C.*\\.7z.*exe|C.*\\.tar.*exe|C.*\\.zip|C.*\\.rar|C.*\\.7z|C.*\\.tar)') |  groupby user, system 

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=win-audit where eid='5632' | select @ssid, distinct_count(@PeerMac) | groupby @ssid, @PeerMac | having distinct_count_col1>1

stream=authentication | limit 1

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableCMD") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableCMD") and user='{SuspectUser}' and '{TargetHost}' | duration 6m

stream=firewall where dstport=53 and (dstip='8.8.8.8' or dstip='1.1.1.1')| duration 1d | limit 10

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%" | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 10m

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%" | groupby user, system

stream=ep-process,win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline),  "(windowsaudiodevice-powershell-cmdlet|get-audiodevice|set-audiodevice|toggle-audiodevice|write-audiodevice|start-audiodevicecapture)") | duration 2h

stream=ep-process, win-audit where action in ('PROCESS_CRETAED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?microphone') | groupby user, system

stream=* where sourcename="" | duration 7d | groupby devsrcip, sourcename | limit 100

stream=win-audit where action='PROCESS_CREATED' and (NewProcessName like "%.jse" or NewProcessName like "%.js") and rlike(CommandLine, '(\\-\\-decompress|\\-c)') and user='{SuspectUser}' and system='{TargetSystem}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (NewProcessName like "%.jse" or NewProcessName like "%.js") and rlike(CommandLine, '(\\-\\-decompress|\\-c)') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%msbuild.exe%' or commandline like '%.csproj%' or commandline like '%vb.xml%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%msbuild.exe%' or commandline like '%.csproj%' or commandline like '%vb.xml%') | groupby system, user, commandline

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, '(C.*\\.zip.*exe|C.*\\.rar.*exe|C.*\\.7z.*exe|C.*\\.tar.*exe|C.*\\.zip|C.*\\.rar|C.*\\.7z|C.*\\.tar)') |  groupby user, system | duration 1h

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, '(C.*\\.zip.*exe|C.*\\.rar.*exe|C.*\\.7z.*exe|C.*\\.tar.*exe|C.*\\.zip|C.*\\.rar|C.*\\.7z|C.*\\.tar)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, '(C.*\\.zip.*exe|C.*\\.rar.*exe|C.*\\.7z.*exe|C.*\\.tar.*exe|C.*\\.zip|C.*\\.rar|C.*\\.7z|C.*\\.tar)') |  groupby user, system | duration 1h

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, '(C.*\\.zip.*exe|C.*\\.rar.*exe|C.*\\.7z.*exe|C.*\\.tar.*exe|C.*\\.zip|C.*\\.rar|C.*\\.7z|C.*\\.tar)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (NewProcessName like "%.jse" or NewProcessName like "%.js") and rlike(CommandLine, '(\\-\\-decompress|\\-c)') and user='{SuspectUser}' and system='{TargetSystem}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (NewProcessName like "%.jse" or NewProcessName like "%.js") and rlike(CommandLine, '(\\-\\-decompress|\\-c)') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like "%\\Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable\\%"	or commandlinelike "%\\CurrentControlSet\\Services\\Amsi%" or commandline like "%\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellServiceObjects\\{B3C418EE-30F7-4E66-B436-725E99247AC5}%" or commandline like "%\\Microsoft\\Windows Defender\\%" or commandline like "%\\SOFTWARE\\Microsoft\\AMSI\\Providers\\{2781761E-28E0-4109-99FE-B9D127C57AFE}%") | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like "%\\Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable\\%"	or commandlinelike "%\\CurrentControlSet\\Services\\Amsi%" or commandline like "%\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellServiceObjects\\{B3C418EE-30F7-4E66-B436-725E99247AC5}%" or commandline like "%\\Microsoft\\Windows Defender\\%" or commandline like "%\\SOFTWARE\\Microsoft\\AMSI\\Providers\\{2781761E-28E0-4109-99FE-B9D127C57AFE}%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%" and system='{TargetHost}' and user='{SuspectUser}'

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%" and system='{TargetHost}' and user='{SuspectUser}'

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%" | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (NewProcessName like "%.jse" or NewProcessName like "%.js") and rlike(CommandLine, '(\\-\\-decompress|\\-c)') and user='{SuspectUser}' and system='{TargetSystem}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (NewProcessName like "%.jse" or NewProcessName like "%.js") and rlike(CommandLine, '(\\-\\-decompress|\\-c)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like 'Msxml2.ServerXMLHTTP' or commandline like 'Msxml2.DOMDocument' or commandline like 'Msxml2.FreeThreadedDOMDocument' or commandline like 'Msxml2.MXXMLWriter') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like 'Msxml2.ServerXMLHTTP' or commandline like 'Msxml2.DOMDocument' or commandline like 'Msxml2.FreeThreadedDOMDocument' or commandline like 'Msxml2.MXXMLWriter') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(icmpsh\_m|nc|powercat)' | groupby user, system

stream=firewall|  groupby srcip |  limit 3

stream=signals

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=firewall where sourcetype='FIREWALL' and dstport in ('107','384','512','530','544','625','641','666','981') and not dstcn='-' and not actiontaken in ('close','deny') | groupby srcip

stream=firewall where sourcetype='FIREWALL' and dstport in ('107','384','512','530','544','625','641','666','981') and not dstcn='-' and not actiontaken in ('close','deny') and srcip='{SuspectHost}'

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like 'Msxml2.ServerXMLHTTP' or commandline like 'Msxml2.DOMDocument' or commandline like 'Msxml2.FreeThreadedDOMDocument' or commandline like 'Msxml2.MXXMLWriter') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like 'Msxml2.ServerXMLHTTP' or commandline like 'Msxml2.DOMDocument' or commandline like 'Msxml2.FreeThreadedDOMDocument' or commandline like 'Msxml2.MXXMLWriter') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=signals

stream=signals

stream=signals

stream=ep-process where action="PROCESS_ADDED" and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (NewProcessName like "%.jse" or NewProcessName like "%.js") and rlike(CommandLine, '(\\-\\-decompress|\\-c)') and user='{SuspectUser}' and system='{TargetSystem}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (NewProcessName like "%.jse" or NewProcessName like "%.js") and rlike(CommandLine, '(\\-\\-decompress|\\-c)') | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like 'Msxml2.ServerXMLHTTP' or commandline like 'Msxml2.DOMDocument' or commandline like 'Msxml2.FreeThreadedDOMDocument' or commandline like 'Msxml2.MXXMLWriter') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like 'Msxml2.ServerXMLHTTP' or commandline like 'Msxml2.DOMDocument' or commandline like 'Msxml2.FreeThreadedDOMDocument' or commandline like 'Msxml2.MXXMLWriter') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(icmpsh\_m|nc|ncat|powercat)' | groupby user, system

stream=firewall|  groupby srcip |  limit 3

stream=win-audit where action="PROCESS_CREATED" and (commandline like "reg add" or commandline like "reg delete" or commandline like "New-ItemProperty") and (commandline like "\\Software\\Policies\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon" or commandline like "Software\\\\Policies\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon") | groupby system, userstream=win-audit where action="PROCESS_CREATED" and (commandline like "reg add" or commandline like "reg delete" or commandline like "New-ItemProperty") and (commandline like "\\Software\\Policies\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon" or commandline like "Software\\\\Policies\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon") | groupby user, system 

stream=win-audit where action="PROCESS_CREATED" and (commandline like "reg add" or commandline like "reg delete" or commandline like "New-ItemProperty") and (commandline like "\\Software\\Policies\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon" or commandline like "Software\\\\Policies\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon") and system='{TargetHost}' and user='{SuspectUser}' | duration 

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='powershell.exe' and commandline like '%powershell.exe%Set-ExecutionPolicy%Bypass%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='powershell.exe' and commandline like '%powershell.exe%Set-ExecutionPolicy%Bypass%' | groupby user, system

stream=firewall where sourcename='FORTIGATE' and action='PACKET_ALLOWED' and status='PASSED' and dstport='69' and @service='"TFTP"' | groupby srcip, dstip |  having count_col0 > 10

stream=EP-PROCESS where action='PROCESS_ADDED' and ParentImage like 'vssadmin.exe' and CommandLine='/noconfig * /fullpaths' | groupby user, system

stream=email-gateway where action='EMAIL_DELIVERED' and status='PASSED' and file is not null and srcip is not null and substr(SUBSTR(file,Instr(File,"."),LENGTH(file)), 0,4) IN ('.app','.bin','.exe','.osx','.out','.prg','.run','.ham','.js','.ore','.pex','.plx','.rox','.upx') | select srcip, count(*) as CountUnique | groupby by srcip | having CountUnique>=2

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%powershell%mimikatz%dumpcr%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%powershell%mimikatz%dumpcr%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%<script>%' or scriptblocktext like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%.js%' or scriptblocktext like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%javascript:%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%<script>%' or scriptblocktext like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%.js%' or scriptblocktext like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%javascript:%') | groupby user, system

stream=threat where sourcename='TIPPINGPOINT' and action='THREAT_DETECTED' and status='PASSED' and vector='NETWORK' and not dstip in ('172.23.0.51','172.23.0.52') and not threat like '%vulnerability%' | groupby threat, srcip, dstip 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%<script>%' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%.js%' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%javascript:%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%<script>%' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%.js%' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%javascript:%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=* | duration 10d | select substring(xhour,0, 8) as date, sum(evtlen) | groupby xhour

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?(screensaver|screensaveactive|screensavetimeout|screensaverissecure|scrnsave)') and system='{TargetHost}' and user='{TargetUser}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?(screensaver|screensaveactive|screensavetimeout|screensaverissecure|scrnsave)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(tor.exe|tor\s+browser|\.onion)'  | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%<script>%' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%.js%' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%javascript:%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%<script>%' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%.js%' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%javascript:%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=firewall where sourcename='FORTIGATE' | duration 7d | groupby action | limit 20

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like '%get-wmiobject%win32_pnpentity%' | groupby user, system | duration 1h

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like '%get-wmiobject%win32_pnpentity%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and lower(parentcommandline) like '%powershell%mimikatz%dumpcr%' | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and lower(parentcommandline) like '%powershell%mimikatz%dumpcr%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline),'((hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language|chcp)')) | groupby user, system 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline),'((hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language|chcp)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like '%get-wmiobject%win32_pnpentity%' | groupby user, system 

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like '%get-wmiobject%win32_pnpentity%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname in ('powershell.exe','cmd.exe') and commandline like '%netsh%portproxy%v4tov4%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname in ('powershell.exe','cmd.exe') and commandline like '%netsh%portproxy%v4tov4%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like '%winpwn%printercheck%' | groupby system, user 

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like '%winpwn%printercheck%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=firewall where sourcename='FORTIGATE' and action='PACKET_BLOCKED' and srcip='{SuspectHost}'

stream=firewall where sourcename='FORTIGATE' and action='PACKET_BLOCKED' | duration 1h | groupby srcip | having count_col1 > 100

stream=webfilter where sourcename='FORTIGATE' | duration 7d | groupby action | limit 20

stream=EP-PROCESS where action='PROCESS_ADDED' and lower(commandline) like '%new-object%system.xml%xmlDoc%xml.load%' or lower(commandline) like 'system%xml%xmldoc%load%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and lower(commandline) like '%new-object%system.xml%xmlDoc%xml.load%' or lower(commandline) like 'system%xml%xmldoc%load%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('powershell.exe','pwsh.exe') and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Internet%Settings%ZoneMap%Domains%new-item%2%DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('powershell.exe','pwsh.exe') and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Internet%Settings%ZoneMap%Domains%new-item%2%DWORD%' | groupby user, system

stream=auditd where sourcename='FORTIGATE' and action='DOWN' | duration 24h | groupby message, system | limit 10

stream=threat where sourcename='TIPPINGPOINT' and action='THREAT_BLOCKED' and status='PASSED' and threat like '%Backdoor%' |  duration 1h | groupby threat, srcip, dstip | limi 100

stream=* | duration 1M | timeslice 1h

stream=CONFIGURATION where sourcename='TREND-MICRO' | duration 1d | groupby message | limit 100

stream=CONFIGURATION where sourcename='TREND-MICRO' | duration 1d | groupby config | limit 100

stream=* |  duration 1d |  groupby srcip | limit 10

stream=webfilter where useragent like ('%Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.67 Safari/537.36%') | duration 2h

stream=authentication where sourcename='CYBEROAM' | duration 7h | select regexp_extract(logevent, 'device\_id=(\\w+)') | limit 10

stream=authentication where sourcename='CYBEROAM' |select @auth_client, logevent| duration 3d | limit 2 

stream=other where not logevent="" | duration 2h | limit 1

stream=AUDITD where category='NTP' and sourcetype='NETWORK-OS' and sourcename='JUNOS' | duration 24h | groupby devsrcip, system, message | limit 100

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.53' and eventid='706' | groupby config | duration 30d | limit 100 

stream=authentication where sourcename='FORTIGATE' and action='LOGIN' and status='FAILED' | duration 24h | groupby srcip | limit 100

stream=auditd where sourcename='NIX' and action='SERVICE_STARTED' and status='PASSED' |  groupby devsrcip, system | duration 24h | limit 20

stream=iam where sourcename='WINDOWS' and action='USER_ENABLED' and status='PASSED' and role='User Account Management' | groupby user, targetuser, domain | duration 1d | limit 10

stream=sysmon-process where action='PROCESS_ADDED' and eid='1' and (commandline like '%Invoke-DllInjection%' or commandline like '%C:%windows%sysnative%') | duration 1h | select system, commandline | groupby system, commandline | limit 100

stream=authentication where sourcename='WINDOWS' and action='LOGIN' and status='PASSED' and eid='4778' | groupby user, srcip, devsrcip | duration 1d | limit 10

stream=THREAT where sourcename='TREND-MICRO' | duration 1d | groupby threat | limit 100

stream=cloudtrail where eventsource="route53.amazonaws.com" and eventname="TransferDomainToAnotherAwsAccount" |  groupby user, userarn

stream=cloudtrail where eventsource="route53.amazonaws.com" and eventname="TransferDomainToAnotherAwsAccount" and username='{SuspectUser}'

stream=authentication where sourcename='WINDOWS' and action='LOGIN' and eid='4776' | groupby user, devsrcip, status | duration 1d | limit 10

stream=authentication where action ='LOGIN' and status='FAILED' |  groupby reason | duration 1w | limit100

stream=github | duration 1d | select user, distinct_count(srccn) as srccn_cnt, user |  groupby user | having srccn_cnt > 2

stream=authentication where action='LOGIN' | groupby user, srcip, system | duration 1d | limit 100

stream=authentication where sourcename='FORTIGATE' and action='LOGIN' and status='PASSED' and intel='True' | groupby user, srcip, devsrcip | duration 1d | limit 100

stream=iam where sourcename='WINDOWS' and action='PRIVILEGE_CHANGED' and status='PASSED' and role='Special Logon' | groupby user, targetuser, domain | duration 1d | limit 100

stream=authentication where devsrcip='172.16.57.145' and action='LOGIN' and user is not null | duration 24h |  groupby user | limit 10

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.101' and eventid='706' | groupby config | duration 30d | limit 100 

stream=cloudtrail where eventsource="guardduty.amazonaws.com" and eventname="CreateIPSet" | groupby user, userarn

stream=cloudtrail where eventsource="guardduty.amazonaws.com" and eventname="CreateIPSet" and username='{SuspectUser}'

stream=github where sourcename='GITHUB' and action='' and srctype='PUBLIC' | groupby user

stream=* where devsrcip in ('10.201.7.102', '10.201.7.103', '10.203.7.103') |  duration 1d | groupby devsrcip, pstatus

stream=win-audit where sourcename='WINDOWS' and action='OBJECT_ACCESSED' and eid='5157' |  duration 1d |  groupby srcip | limit 10

stream=configuration where sourcename='MSSQL' and action='CONFIGURATION_CHANGED' and config='Database Checked' | groupby user, config | duration 7d | limit 10

stream=configuration where eventid='6005' | duration 24h | groupby devsrcip, message, system | limit 100

stream=authentication where sourcename='NIX' and action='LOGIN' and status='FAILED' and user is not null |  duration 24h |  groupby user, srcip, devsrcip | limit 100

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.60.103' and eventid='706' | groupby config | duration 30d | limit 100 

stream=* where devsrcip in ('10.201.7.36', '10.201.7.37', '10.203.7.36', '10.202.2.36', '10.204.1.36') | duration 1d | groupby devsrcip, sourcename, sourcetype

stream=authentication where sourcename='NIX' and action='LOGIN_SESSION_DISCON' and status='PASSED' | duration 24h | groupby srcip, devsrcip, authproto, system | limit 100

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('powershell.exe','pwsh.exe') and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Internet%Settings%ZoneMap%Domains%new-item%2%DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('powershell.exe','pwsh.exe') and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Internet%Settings%ZoneMap%Domains%new-item%2%DWORD%' | groupby user, system

stream=firewall where sourcename='FORTIGATE' and action='PACKET_BLOCKED' and dstcn is not null | groupby cnamtime, srcip, srccn, dstip, dstport, devsrcip |  duration 24h | limit 20

stream=configuration where sourcename='WINDOWS' and action='CONFIGURATION_CHANGED' and status='PASSED' and config='System Time Changed' | groupby user, system, devsrcip | duration 1d | limit 10

stream=authentication where sourcename='MSSQL' and action='LOGIN' and status='PASSED' | groupby srcip | duration 1d | limit 10

stream=win-audit where sourcename='WINDOWS' and action='OBJECT_ACCESSED' and eid='5157' |  duration 1d |  groupby srcip | limit 100

stream=configuration where sourcename='MSSQL' and action='CONFIGURATION_CHANGED' and status='PASSED' and config='Log was restored.' | groupby user,config |  duration 1d | limit 10

stream=github where sourcename='GITHUB' and action='' | groupby user 

stream=configuration where sourcename='FORTIGATE' and action='CONFIGURATION_CHANGED' and not user='rancid' |  duration 24h |  groupby action, srcip, user |  limit 100

stream=authentication where sourcename='FORTIGATE' and action='LOGIN' and status='PASSED' and authproto='VPN' | select user, max(cnamtime) as MaxLoginTime | groupby user | duration 1d | limit 100

stream=configuration where sourcename='WINDOWS' and action='CONFIGURATION_CHANGED' and status='PASSED' and config='System Time Changed' | groupby user, system, devsrcip | duration 1d | limit 100

stream=authentication where sourcename='FORTIGATE' and action='LOGOUT' and status='PASSED' | duration 24h | groupby user | limit 100

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg.*?\\.exe|gpedit\\.msc|cmd\\.exe).*?(DisableChangePassword).*?\\/d\\s1") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg.*?\\.exe|gpedit\\.msc|cmd\\.exe).*?(DisableChangePassword).*?\\/d\\s1") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=iam where sourcename='WINDOWS' and action='USER_ENABLED' and status='PASSED' and role='User Account Management' | groupby user, targetuser, domain | duration 1d | limit 100

stream=configuration where sourcename='WINDOWS' and action='CONFIGURATION_CHANGED' and status='PASSED' and config='System Start' | groupby system, devsrcip | duration 1d | limit 100

stream=iam where sourcename='WINDOWS' and action='PASSWORD_CHANGED' and status='PASSED' and role='User Account Management' |  groupby user, targetuser, system | duration 1d | limit 10

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like 'Msxml2.ServerXMLHTTP' or commandline like 'Msxml2.DOMDocument' or commandline like 'Msxml2.FreeThreadedDOMDocument' or commandline like 'Msxml2.MXXMLWriter') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like 'Msxml2.ServerXMLHTTP' or commandline like 'Msxml2.DOMDocument' or commandline like 'Msxml2.FreeThreadedDOMDocument' or commandline like 'Msxml2.MXXMLWriter') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=authentication | groupby domain

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%new-object%system.xml%xmlDoc%xml.load%' or lower(commandline) like 'system%xml%xmldoc%load%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and lower(commandline) like '%new-object%system.xml%xmlDoc%xml.load%' or lower(commandline) like 'system%xml%xmldoc%load%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like 'Msxml2.ServerXMLHTTP' or commandline like 'Msxml2.DOMDocument' or commandline like 'Msxml2.FreeThreadedDOMDocument' or commandline like 'Msxml2.MXXMLWriter') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like 'Msxml2.ServerXMLHTTP' or commandline like 'Msxml2.DOMDocument' or commandline like 'Msxml2.FreeThreadedDOMDocument' or commandline like 'Msxml2.MXXMLWriter') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=* | duration 10m | groupby devsrcip

stream=firewall where sourcename='FORTIGATE' and action='PACKET_BLOCKED' and srccn is not null | groupby cnamtime, srcip, srccn, dstip, dstport, devsrcip | duration 1d | limit 20

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%system.xml%xmlDoc%xml.load%' or lower(commandline) like 'system%xml%xmldoc%load%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%new-object%system.xml%xmlDoc%xml.load%' or lower(commandline) like 'system%xml%xmldoc%load%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=firewall where sourcename='FORTIGATE' and action='PACKET_ALLOWED' and dstcn is not null | groupby cnamtime, srcip, srccn, dstip, dstport, devsrcip | duration 24h | limit 20

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.60.49' and eventid='706' | groupby config | duration 30d | limit 100 

stream=* | select devsrcip, count(*) as count_unique | groupby devsrcip | duration 30m 

stream=* | groupby devsrcip | duration 4h 

stream=* where sourcename='TIPPINGPOINT' | groupby eventname | duration | limit 100

stream=firewall where aourcename='FORTIGATE' and action='PACKET_BLOCKED' and intel='True' |  duration 1h |  groupby srcip | limit 10

stream=github where sourcename='GITHUB' and action='disabled' | groupby user 

stream=authentication where sourcename='GITHUB' | duration 7h | select user, count(user) as user_cnt | groupby user | having user_cnt > 10

stream=authentication where sourcename='MSSQL' and sourcetype='DATABASE' and action='LOGIN' | groupby action, srcip, user | duration 1d | limit 100

stream=authentication where sourcename='FORTIGATE' and action='LOGOUT' and authproto='VPN' | duration 1d | groupby srcip, user | limit 100

stream=authentication where sourcename='NIX' and action='LOGIN' and status='PASSED'  | groupby user, devsrcip | duration 1d | limit 100

stream=authentication | groupby domain | duration 1h

stream=authentication where sourcename='G-SUITE' and user not like '%net-mon.net%' and action='LOGIN' and status='PASSED' and user is not null and not user='-' | select srcip,user 

stream=* where devsrcip in ('10.201.2.148', '10.203.2.148', '10.201.7.132', '10.203.7.132') | duration 1d | groupby devsrcip, sourcename, sourcetype

stream=* | duration 7d | select distinct(devsrcip) as UniqueDevSrcIP

stream=authentication where sourcename='WINDOWS' and action='LOGIN' and eid='4776' | groupby user, devsrcip, status | duration 1d | limit 100

stream=firewall where sourcename='FORTIGATE' and dstport='1433' |  duration 1h | groupby action, srcip, system | limit 100

stream=authentication where sourcename='FORTIGATE' and action='LOGIN' and status in ('PASSED','FAILED') and srcip is not null and user is not null |  duration 1d |  groupby user, status, srcip | limit 100

stream=authentication where sourcename='WINDOWS' and action='LOGIN' and status='PASSED' and eid='4778' | groupby user, srcip, devsrcip | duration 1d | limit 100

stream=EP-PROCESS where action in ('PROCESS_ADDED','OBJECT_ACCESSED') and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action in ('PROCESS_ADDED','OBJECT_ACCESSED') and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') | groupby user, system

stream=EP-REGISTRY where targetobject like '%HKLM%SYSTEM%CurrentControlSet%Control%SecurityProviders%WDigest%UseLogonCredential%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-REGISTRY where targetobject like '%HKLM%SYSTEM%CurrentControlSet%Control%SecurityProviders%WDigest%UseLogonCredential%' | groupby user, system

stream=iam where sourcename='WINDOWS' and action='USER_DELETED' and role='User Account Management' |  duration 24h |  groupby user, targetuser | limit 100

stream=VPN where authproto='VPN' and sourcename='FORTIGATE' | duration 24h | groupby actiontaken | limit 100

stream=authentication where sourcename='MSSQL' and action='LOGIN' and status='FAILED' and user is not null | groupby srcip, user, reason | duration 1d | limit 10

stream=configuration where sourcename='MSSQL' and action='CONFIGURATION_CHANGED' and status='PASSED' and config='Log was backed up.' |  groupby user, config | duration 1d | limit 100

stream=auditd where sourcename='FORTIGATE' and action='UP' | duration 24h | groupby message, system | limit 10

stream=firewall where sourcename='FORTIGATE' and srccn is not null and dstcn is not null and dstport='445' | duration 4h | groupby action, srcip, dstip | limit 10

stream=configuration where sourcename='WINDOWS' and action='CONFIGURATION_CHANGED' and status='PASSED' | groupby user, system, config | duration 30m | limit 100

stream=* where sourcename='JUNOS' and sourcetype='SWITCH' |  groupby srcip, system | duration 1d | limit 100

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%SecurityProviders%WDigest%UseLogonCredential%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%SecurityProviders%WDigest%UseLogonCredential%REG_DWORD%1%' | groupby user, system

stream=threat where sourcename='WINDOWS' and action='THREAT_DETECTED' and status='PASSED' and threat='A replay attack was detected.' | groupby user, srcip

stream=win-audit where sourcename='WINDOWS' and action='POLICY_CHANGED' and status='PASSED' and event='System audit policy was changed.' | groupby user

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%SecurityProviders%WDigest%UseLogonCredential%REG_DWORD%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%SecurityProviders%WDigest%UseLogonCredential%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe','cmd') and commandline like '%HKEY_LOCAL_MACHINE%Software%Microsoft%Windows%CurrentVersion%Run%REG_EXPAND_SZ%SecurityHealth%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe','cmd') and commandline like '%HKEY_LOCAL_MACHINE%Software%Microsoft%Windows%CurrentVersion%Run%REG_EXPAND_SZ%SecurityHealth%' | groupby user, system

stream=cloudtrail where eventSource="rds.amazonaws.com" and @responseElements.publiclyAccessible="true" and eventname="RestoreDBInstanceFromDBSnapshot" |  groupby user, userarn

stream=cloudtrail where eventSource="rds.amazonaws.com" and @responseElements.publiclyAccessible="true" and eventname="RestoreDBInstanceFromDBSnapshot" and username='{SuspectUser}'

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%System%LocalAccountTokenFilterPolicy%EnableLinkedConnections%SYSTEM%CurrentControlSet%Control%FileSystem%LongPathsEnabled%DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%cmd.exe%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%System%LocalAccountTokenFilterPolicy%EnableLinkedConnections%SYSTEM%CurrentControlSet%Control%FileSystem%LongPathsEnabled%DWORD%1%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%System%LocalAccountTokenFilterPolicy%EnableLinkedConnections%SYSTEM%CurrentControlSet%Control%FileSystem%LongPathsEnabled%DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%cmd.exe%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%System%LocalAccountTokenFilterPolicy%EnableLinkedConnections%SYSTEM%CurrentControlSet%Control%FileSystem%LongPathsEnabled%DWORD%1%' | groupby user, system

stream=* where devsrcip='152.58.44.148' | duration 2m | groupby stream | limit 100

stream=signals | duration 12m | limit 1

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%powershell.exe%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%System%LocalAccountTokenFilterPolicy%EnableLinkedConnections%SYSTEM%CurrentControlSet%Control%FileSystem%LongPathsEnabled%DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%powershell.exe%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%System%LocalAccountTokenFilterPolicy%EnableLinkedConnections%SYSTEM%CurrentControlSet%Control%FileSystem%LongPathsEnabled%DWORD%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoTrayContextMenu%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoTrayContextMenu%REG_DWORD%1%' | groupby user, system

stream=cloudtrail where not eventname like 'Describ%' and not eventname like 'List%' and not eventname like 'Get%' | duration 1d | groupby eventname |  limit 100

stream=authentication where sourcename='FORTIGATE' and action='LOGOUT' and authproto='VPN' |  select user, max(cnamtime) as MaxLogoutTime | groupby user | duration 1d | limit 100

stream=authentication | duration 1M | select "vsys1" as vsys, "host3" as HostID, "serial1" as SerialNo, "test1" as Source, cnamtime as time | limit 1

stream=authentication where action='LOGIN' and srccn is not null and not srccn='IN' and not srccn='-' and srctype='PUBLIC' and system='{TargetHost}' and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=authentication where action='LOGIN' and srccn is not null and not srccn='IN' and not srccn='-' and srctype='PUBLIC' |  groupby status, srcip, system

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.51' and eventid='706' | groupby config | duration 30d | limit 100 

stream=* where evtlen='214895' |  duration 1h | last 10

stream=* | duration 1d | groupby evtlen | limit 1000

stream=other where devsrcip='172.24.10.119' | limit 5000

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.150' and eventid='706' | groupby config | duration 30d | limit 100 

stream=configuration where sourcename='WINDOWS' and category='Application Crashing Events' | duration 24h | groupby devsrcip, app, process | limit 100

stream=signals | duration 3M | groupby uuid | limit 100000

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%powershell.exe%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%System%LocalAccountTokenFilterPolicy%EnableLinkedConnections%SYSTEM%CurrentControlSet%Control%FileSystem%LongPathsEnabled%DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%powershell.exe%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%System%LocalAccountTokenFilterPolicy%EnableLinkedConnections%SYSTEM%CurrentControlSet%Control%FileSystem%LongPathsEnabled%DWORD%1%' | groupby user, system

stream=EP-Process where action="PROCESS_ADDED" and commandline like "%csc.exe%" and (commandline like "%/target:exe%/code%/out%" ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-Process where action="PROCESS_ADDED" and commandline like "%csc.exe%" and (commandline like "%/target:exe%/code%/out%" ) | groupby system, user 

stream=awsflowlog where srctype='PRIVATE' and dsttype='PUBLIC' and proto='TCP' and dstport in ('9001','9030') |  select packetsrcip, count(packetdstip) as countpacketdstip | groupby packetdstip, packetsrcip

stream=other where devsrcip in ('172.24.10.103','172.24.10.119','172.24.10.92') and pstatus='PAD' |  duration 1d | limit 5000

stream=win-audit where sourcename='WINDOWS' and action='PROCESS_CREATED' and status='PASSED' and eid=4688 and not user in ('yadaje-contadm','pateab-conttadm','cmadmin')| groupby user, @ParentProcessName

stream=awsflowlog where action='PACKET_BLOCKED' and status='PASSED' and srctype='PRIVATE' | select packetsrcip, count(action) as totalcount | groupby packetsrcip | duration 15m | having totalcount>30000

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.60.75' and eventid='706' | groupby config | duration 30d | limit 100 

stream=* | duration=15m |  groupby srcip

stream=iam where targetuser in ('') |  groupby user, action

stream=iam where targetuser='{TargetUser}' and user='{SuspectUser}'

stream=webfilter where url like '%.tor' or url like '%.onion' or url like '%.i2p' or url like '%.bit' |  duration 1d

stream=awsflowlog where dstport='3389'  |  select packetsrcip, packetdstip, count(*) as cnt |  groupby packetsrcip, packetdstip | having cnt>2 |  limit 100

stream=awsflowlog where proto='TCP' and srctype='PRIVATE' and dstport='8000' | groupby packetsrcip, packetdstip | limit 10

stream=win-audit where sourcename='WINDOWS' and action='POLICY_CHANGED' and status='PASSED' and event='Auditing settings on object were changed.' | groupby user

stream=awsflowlog where srctype='PUBLIC' and not instanceid='-' |  select packetdstip, count(action) as totalcount, distinct_count(packetsrcip) as distinctsrcips, distinct_count(proto) as protocount | groupby packetdstip | duration 15m 

stream=awsflowlog where  proto='UDP' and dstport='4500' | groupby packetsrcip, packetdstip | limit 10

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.90' and eventid='706' | groupby config | duration 30d | limit 100 

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.79' and eventid='706' | groupby config | duration 30d | limit 100 

stream=win-audit where sourcename='WINDOWS' and action='POLICY_CHANGED' and status='PASSED' and eid in ('4954', '4947', '4954') | groupby user

stream=sysmon-registry where action='OBJECT_MODIFIED' and image='C:\\Windows\\system32\\reg.exe' and logevent like '%sethc.exe%' | groupby devsrcip

stream=iam where sourcename='WINDOWS' and action='PASSWORD_CHANGED' and status='PASSED' and role='User Account Management' | groupby user, targetuser

stream=configuration where sourcename='WINDOWS' and action='CONFIGURATION_CHANGED' and status='PASSED' | groupby user, system, config | duration 30m | limit 10

stream=authentication where sourcename='BLUECOAT' and sourcetype='WEBFILTER' and action='LOGIN' and status='FAILED' and user='{SuspectUser}'

stream=authentication where sourcename='BLUECOAT' and sourcetype='WEBFILTER' and action='LOGIN' and status='FAILED' | groupby user 

stream=SYSMON-REGISTRY where sourcename='WINDOWS' and image="C:\\Windows\\system32\\reg.exe" and ParentCommandLine like "%sethc.exe" | groupby devsrcip

stream=threat | duration 1d | groupby threat, devsrcip, sourcename

stream=cloudtrail where eventsource="rds.amazonaws.com" and @responseElements.pendingModifiedValues.masterUserPassword is not null and eventname="ModifyDBInstance" and username='{SuspectUser}'

stream=cloudtrail where eventsource="rds.amazonaws.com" and @responseElements.pendingModifiedValues.masterUserPassword is not null and eventname="ModifyDBInstance" | groupby user, userarn

stream=win-audit where sourcename='WINDOWS' and action='POLICY_CHANGED' and eid in ('4706','4707','4714') | groupby user

stream=win-audit where sourcename='WINDOWS' and action='POLICY_CHANGED' and eid in ('4703','4704','4705') | groupby user

stream=win-audit where sourcename='WINDOWS' and action='OBJECT_ACCESSED' and status='PASSED' and eid=4656 and object like "%dump%" | groupby user, object

stream=authentication where sourcename='WINDOWS' and action='LOGIN' and status='FAILED' and reason='ACCOUNT_EXPIRED' | groupby user, system

stream=win-audit where sourcename='WINDOWS' and action='OBJECT_ACCESSED' and status='PASSED' and event='A network share object was accessed.' | groupby user

stream=AUTHENTICATION where sourcename='MSSQL' and loglevel='ERROR' | duration 24h |  groupby category, message, srcip, user | limit 100

stream=sysmon-registry where TargetObject='HKLM\\SOFTWARE\\ Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Run\\(Default)' | groupby devsrcip

stream=* where devsrcip in ('10.201.7.36', '10.201.7.37', '10.203.7.36', '10.202.2.36', '10.204.1.36') | duration 1d | groupby devsrcip, pstatus

stream=win-audit where sourcename='WINDOWS' and action='OBJECT_ACCESSED' and status='PASSED' and eid=4656 | groupby user

stream=win-audit where sourcename='WINDOWS' and action='PROCESS_CREATED' and status='PASSED' and eid=4688 | groupby user, @NewProcessName | duration 1d

stream=firewall where action='PACKET_BLOCKED'| duration 1h | limit 100

stream=webfilter where action='URL_ALLOWED' and url_categories in ('Instant Messaging', 'Web Phone', 'Shareware/Freeware', 'Social Networking', 'Travel', 'Job Search','Entertainment, Streaming Media', 'Blogs/Wiki, Social Networking', 'Streaming Media', 'Chat', 'Online Shopping, Fashion/Beauty') | groupby user |  duration 1h | having count_col1>100


stream=win-audit where sourcename='WINDOWS' and action='PROCESS_TERMINATED' and status='PASSED' and event='A process has exited.' | groupby user

stream=win-audit where sourcename='WINDOWS' and action='PROCESS_CREATED' and status='PASSED' and eid=4688 | groupby user, @ParentProcessName | duration 1d

stream=win-audit  where sourcename='WINDOWS' and action='POLICY_CHANGED' and status='PASSED' and eid in ('4865', '4866', '4867') | groupby user

stream=iam where sourcename='WINDOWS' and action='USER_ADDED' and status='PASSED' and role='Security Group Management' | groupby user, group

stream=iam where sourcename='WINDOWS' and action='USER_DELETED' and status='PASSED' and role='User Account Management' | groupby user, targetuser

stream=configuration where sourcename='WINDOWS' and action='CONFIGURATION_CHANGED' and status='PASSED' | groupby user

stream=authentication where sourcename='WINDOWS' and action='LOGIN' and status='FAILED' and reason='USER_LOCKOUT' | groupby user, system

stream=win-audit where sourcename='WINDOWS' and action='PROCESS_CREATED' and status='PASSED' and eid=4688 | groupby user, @NewProcessName

stream=authentication where sourcename='WINDOWS' and action='LOGIN' and status='FAILED' and reason='USER_DISABLED' | groupby user, system

stream=win-audit where sourcename='WINDOWS' and action='POLICY_CHANGED' and status='PASSED' and event='Kerberos policy was changed.' |  groupby user

stream=authentication where sourcename='WINDOWS' and action='LOGIN' and status='FAILED' and reason='PASSWORD_EXPIRED' and @Category='Credential Validation' | groupby user, system

stream=win-audit where sourcename='WINDOWS' and action='POLICY_CHANGED' and status='PASSED' and event='The audit policy (SACL) on an object was changed.' | groupby user

stream=configuration where sourcename='WINDOWS' and action='CONFIGURATION_CHANGED' and status='PASSED' and config='System Shut Down' | groupby user, system

stream=iam where sourcename='WINDOWS' and action in ('GROUP_DELETED', 'GROUP_CREATED') and status='PASSED' | groupby user, group

stream=iam where sourcename='WINDOWS' and action='USER_CREATED' and status='PASSED' and role='User Account Management' | groupby user, targetuser

stream=win-audit where sourcename='WINDOWS' and action='OBJECT_ACCESSED' and status='PASSED' and event='A registry value was modified.' and rlike(object,".*currentversion.*run.*") | groupby user, system

stream=configuration where sourcename='WINDOWS' and action='CONFIGURATION_CHANGED' and status='PASSED' and config='System Time Changed' | groupby user

stream=win-audit where sourcename='WINDOWS' and action='POLICY_CHANGED' and status='PASSED' and event='Domain Policy was changed.' | groupby user

stream=iam where sourcename='WINDOWS' and action='USER_LOCKOUT' and status='PASSED' and role='User Account Management' |  groupby user, targetuser

stream=email-gateway where sourcename='MS-O365' and action='MAILBOX_LOGIN' and srccn='CZ' and srccn is not null | groupby remoteip, srccn, sender, recipient

stream=iam where sourcename='MS-O365' and action='PASSWORD_CHANGED' and status='PASSED' | select cnamtime, user, targetuser | groupby cnamtime, user, targetuser

stream=email-gateway where sourcename='MS-O365' and action='MAILBOX_LOGIN' and srccn='KR' and srccn is not null |  groupby remoteip, srccn, sender, recipient

stream=email-gateway where sourcename='MS-O365' and action='MAILBOX_LOGIN' and srccn='RU' and srccn is not null | groupby remoteip, srccn, sender, recipient

stream=email-gateway where sourcename='MS-O365' and action='MAILBOX_LOGIN' and srccn='TR' and srccn is not null |  groupby remoteip, srccn, sender, recipient

stream=threat where sourcename='MS-O365' and action='THREAT_DETECTED' and status='PASSED' and vector='HOST' and @Operation='FileMalwareDetected' and @SourceFileExtension='exe' | groupby user, dstip, file

stream=sysmon-process where action='PROCESS_ADDED' and image like '%reg.exe' and (commandline like '%software%Microsoft%Windows%CurrentVersion%Run%' or commandline like '%software%Microsoft%Windows%CurrentVersion%RunOnce%' or commandline like '%software%Microsoft%Windows%CurrentVersion%RunOnceEx%' or commandline like '%software%Microsoft%Windows%CurrentVersion%RunServices%' or commandline like '%software%Microsoft%Windows%CurrentVersion%RunServicesOnce%' or commandline like '%software%Microsoft%Windows NT%CurrentVersion%Winlogon%Userinit%' or commandline like '%software%Microsoft%Windows NT%CurrentVersion%Winlogon%Shell%' or commandline like '%software%Microsoft%Windows NT%CurrentVersion%Windows%' or commandline like '%software%Microsoft%Windows%CurrentVersion%Explorer%User Shell Folders%' and commandline like '%add%') and eid='1' | groupby system, image, commandline 

stream=sysmon-process where action='PROCESS_ADDED' and system='{TargetHost}' and image like '%reg.exe' and (commandline like '%software%Microsoft%Windows%CurrentVersion%Run%' or commandline like '%software%Microsoft%Windows%CurrentVersion%RunOnce%' or commandline like '%software%Microsoft%Windows%CurrentVersion%RunOnceEx%' or commandline like '%software%Microsoft%Windows%CurrentVersion%RunServices%' or commandline like '%software%Microsoft%Windows%CurrentVersion%RunServicesOnce%' or commandline like '%software%Microsoft%Windows NT%CurrentVersion%Winlogon%Userinit%' or commandline like '%software%Microsoft%Windows NT%CurrentVersion%Winlogon%Shell%' or commandline like '%software%Microsoft%Windows NT%CurrentVersion%Windows%' or commandline like '%software%Microsoft%Windows%CurrentVersion%Explorer%User Shell Folders%' or commandline like '%add%') and eid='1' 

stream=sysmon-image-load where action='PROCESS_ACCESSED' and status='PASSED' and system='{TargetHost}' and image like '%notepad.exe' and (imageloaded like '%samlib.dll' or imageloaded like '%WinSCard.dll') | duration 1h | limit 100

stream=sysmon-image-load where action='PROCESS_ACCESSED' and status='PASSED' and image like '%notepad.exe' and (imageloaded like '%samlib.dll' or imageloaded like '%WinSCard.dll') | select system, image, imageloaded | groupby system, image, imageloaded 

stream=authentication where sourcename='BLUECOAT' and sourcetype='WEBFILTER' and action='LOGIN' and status='PASSED' and user='{SuspectUser}'

stream=authentication where sourcename='BLUECOAT' and sourcetype='WEBFILTER' and action='LOGIN' and status='PASSED' | groupby user 

stream=signals where detectionname='User Accessing Non Productive URLs' and suspectuser is not null |  duration 7d |  groupby suspectuser | having count_col1>10

stream=sysmon-process where action='PROCESS_ADDED' and eid='1' and parentimage like '%EdgeTransport.exe' | duration 1h | select system, parentimage | groupby system, parentimage | limit 100

stream=sysmon-process where action='PROCESS_ADDED' and system='{TargetHost}' and eid='1' and parentimage like '%EdgeTransport.exe' | duration 1h | limit 100

stream=authentication where action='LOGIN' and status='FAILED'| duration 1h | groupby srcip, system | having count_col1 > 15

stream=firewall where sourcename='FORTIGATE' and action='PACKET_ALLOWED' and srccn is not null | groupby cnamtime,srcip, dstip, dstport, srccn, devsrcip | duration 24h | limit 20

stream=SYSMON-FILE where sourcename="WINDOWS" and targetfilename like "%.ps1" | groupby @Hash, devsrcip | limit 10

stream=IAM and action="REPORT_CREATED" | duration 1d | limit 10

stream=IAM and action="REPORT_CREATED" and SubScope='{SuspectUser}' | limit 10
_checkif int_compare EvtLen > 466 include

stream=webfilter where action='URL_BLOCKED' and srctype='PUBLIC' and not user='-' |  duration 6h | groupby user, url | having count_col1 > 100

stream=configuration where sourcename='CISCO-IRONPORT' and devsrcip='10.113.100.21' | duration 1h | groupby devsrcip | limit 100

stream=iam where sourcename='CISCO-IRONPORT' and devsrcip='10.113.100.21' | duration 1h | groupby devsrcip | limit 100

stream=authentication where sourcename='CISCO-IRONPORT' and devsrcip='10.113.100.21' | duration 1h | groupby devsrcip | limit 100

stream=threat where sourcename='CISCO-IRONPORT' and devsrcip='10.113.100.21' | duration 1h | groupby devsrcip | limit 100

stream=azure where sourcename='FORCEPOINT-DLP' and threat='Confidential Warning' AND @sourceServiceName='Endpoint HTTPS' AND devsrcip='10.101.76.23' | duration 1h | groupby @suser, devsrcip | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and action='THREAT_DETECTED' AND threat='Klassify Secret' and devsrcip='10.101.76.23' | duration 15m | groupby @suser, @severityType, @duser | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and threat='File De-Compression' AND action='THREAT_DETECTED' AND devsrcip='10.101.76.23' | duration 15m | groupby file, @suser, @severityType | limit 100

stream=IAM where action IN ('USER_CREATED','USER_REMOVED','USER_ADDED','USER_LOCKOUT','USER_UNLOCKED') and targetuser is not null |  groupby targetuser |  duration 1h |  having count_col1>3

stream=authentucation where sourcename='TREND-MICRO-NETWORK' | duration 1h | groupby devsrcip | limit 100

stream=threat where sourcename='TREND-MICRO-NETWORK' | duration 1h | groupby devsrcip | limit 100

stream=configuration where sourcename='TREND-MICRO-NETWORK' | duration 1h | groupby devsrcip | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and @act='Permitted' AND threat='PPBL Klassify Internal 2' AND devsrcip='10.101.76.23' | duration 15m | groupby file, @suser, @severityType | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and threat='Bids and Tenders' AND action='THREAT_DETECTED' AND devsrcip='10.101.76.23' | duration 15m | groupby file, @suser, @severityType, @duser | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and not (@act='Quarantined' or @act='Blocked') AND threat='Leavers/Movers- Mail block policy' AND devsrcip='10.101.76.23' | duration 10m | groupby @act, threat, @suser, file | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and threat='Software Design Documents_1' AND action='THREAT_DETECTED' AND devsrcip='10.101.76.23' | duration 15m | groupby suser, file, threat, @severityType | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and threat='Customer Name detection Policy' AND action='THREAT_DETECTED' AND devsrcip='10.101.76.23' | duration 15m | groupby file, user | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and threat='PKCS #12 Files' AND action='THREAT_DETECTED' AND devsrcip='10.101.76.23' | duration 15m | groupby file, @suser, @severityType | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and not (@act='Quarantined' or @act='Blocked') AND threat='Aadhaar with supporting Keyword' | duration 10m | groupby @act, threat, @suser, file | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and threat='.REG Files' AND action='THREAT_DETECTED' AND devsrcip='10.101.76.23' | duration 15m | groupby file, @suser, @severityType, @duser | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and threat='Project Document' AND action='THREAT_DETECTED' AND devsrcip='10.101.76.23' | duration 15m | groupby file, threat, @severityType, @suser | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and not (@act='Quarantined' or @act='Blocked') AND threat='dlp_block_user_whitelisting (BCM-4648_Har Pratap)' AND devsrcip='10.101.76.23' |  duration 10m | groupby @act, threat, @suser, file | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and threat='Network share Outside the office' AND @sourceServiceName='Endpoint LAN' AND devsrcip='10.101.76.23' | duration 15m | groupby @suser | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and action='THREAT_DETECTED' and threat='Financial Information (Monitoring)' and devsrcip='10.101.76.23' and not (@duser='vaibhav@elevationcapital.com' or @duser='manju.agarwal50@gmail.com' or @duser='sairee@sheroes.in' or @duser='rameshabhishek@gmail.com' or @duser='vaibhav@elevationcapital.com' or @duser='manju.agarwal50@gmail.com' or @duser='sairee@sheroes.in' or @duser='rameshabhishek@gmail.com') | duration 15m | groupby @suser, @severityType, file, @duser | limit 100 

stream=threat where sourcename='FORCEPOINT-DLP' and not (@act='Quarantined' or @act='Blocked') AND threat='dlp_block_user_whitelisting (BCM-4622_ujjval.kumar)' AND devsrcip='10.101.76.23' | duration 10m | groupby @act, threat, @suser, file | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and not (@act='Quarantined' or @act='Blocked') AND threat='dlp_block_user_whitelisting (BCM-4418_Suraj.parkash)' AND devsrcip='10.101.76.23' |  duration 15m | groupby @act, threat, @suser, @file | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' AND threat='India PII' AND action='THREAT_DETECTED' AND devsrcip='10.101.76.23' | duration 15m | groupby file, @suser, @severityType | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' not (@act='Quarantined' or @act='Blocked') AND threat='dlp_block_user_whitelisting (BCM-4396_Shiv.kumar)' AND devsrcip='10.101.76.23' | duration 15m | groupby @act, threat, @suser, file | limit 100 

stream=threat where sourcename='FORCEPOINT-DLP' and not (@act='Quarantined' or @act='Blocked') AND threat='Bluetooth Data Transfer' AND devsrcip='10.101.76.23' | duration 10m | groupby @act, threat, @suser, file | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and not (@act='Quarantined'or @act='Blocked') AND threat='Financial Information' AND devsrcip='10.101.76.23' | duration 15m | groupby file, @suser, @severityType | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and not (@act='Quarantined' or @act='Blocked') AND threat='dlp_block_user_whitelisting (BCM-4430_rushabh.shah)' AND devsrcip='10.101.76.23' | duration 15m | groupby @act, threat, @suser, file | limit 100 

stream=firewall where action='PACKET_ALLOWED' | select sourcename, dstip, count(srcip) as COUNTU | groupby sourcename, dstip | having COUNTU>100

stream=threat where sourcename='FORCEPOINT-DLP' and threat='PCI' AND action='THREAT_DETECTED' AND devsrcip='10.101.76.23' | duration 15m | groupby file, @suser, @severityType | limit 100

stream=authentication where sourcename='FORTIGATE' and action='LOGIN' and status='PASSED' and intel='True' and user is not null | groupby user, srcip, devsrcip | duration 1d | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and threat='Financial Information_1' AND action='THREAT_DETECTED' AND devsrcip='10.101.76.23' | duration 15m | groupby file, @suser, @severityType | limit 100 

stream=threat where sourcename='FORCEPOINT-DLP' and threat='BCM-4668_User_Whitelisting_Aadhaar_Support(Rajat&Manu)' AND @act='Permitted' | duration 10m | groupby @act, threat, @suser, file | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and devsrcip='10.101.76.23' and action='THREAT_DETECTED' and @sourceServiceName='Endpoint Removable Media' | duration 1h | groupby @suser, @duser, file | limit 10

stream=threat where sourcename='FORCEPOINT-DLP' and @act='Permitted' AND threat='Klassify confidential(External)' | duration 15m | groupby file, @duser, @severityType | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and threat='PPBL Klassify Internal (Monitoring) BCM-3575' AND action='THREAT_DETECTED' | duration 15m | groupby @suser, @duser, threat, @severityType | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and not (@act='Quarantined' or @act='Blocked') AND threat='Credit Cards' AND devsrcip='10.101.76.23' | duration 10m | groupby @act, threat, @suser, file | limit 100

stream=ep-process where action="PROCESS-ADDED" and (commandline like "%Disable-WindowsOptionalFeature%-Online%-FeatureName%Windows-Defender%" or commandline like "%Disable-WindowsOptionalFeature%-FeatureName%Windows-Defender%" | groupby user, system

stream=ep-process where action="PROCESS-ADDED" and (commandline like "%Disable-WindowsOptionalFeature%-Online%-FeatureName%Windows-Defender%" or commandline like "%Disable-WindowsOptionalFeature%-FeatureName%Windows-Defender%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=threat where action='CONFIGURATION_CHANGED' AND logevent like '%Microsoft Storage Spaces SMP%' AND devsrcip='10.101.76.23' | duration 15m | groupby system | limit 100 

stream=threat where action='CONFIGURATION_CHANGED' AND logevent like '%WinHTTP Web Proxy Auto-Discovery Service%' AND devsrcip='10.101.76.23' | duration 15m | groupby system, action | limit 100

stream=threat where NOT (file='ServletController' or file='ARN' or file='ALM' or file='EPSF' or file='PDF' or file='-n' or file='Microsoft') AND devsrcip='10.101.76.23' AND @sourceServiceName='Endpoint Printing' | duration 1h | groupby @suser, @duser, file | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and not (@act='Quarantined' or @act='Blocked') AND threat='PAN With Support Keyword' AND devsrcip='10.101.76.23' | duration 10m | groupby @act, threat, @suser, file | limit 100

stream=threat where sourcename='FORCEPOINT-DLP' and @act='Permitted' and @sourceServiceName='Endpoint Email' AND threat='Klassify confidential(External)' AND devsrcip='10.101.76.23' | duration 15m | groupby @suser | limit 100 

stream=firewall where sourcename='CHECKPOINT' and srcip is not null | groupby srcip, system

stream=auditd and action='PROCESS_ADDED' |duration 1h |groupby system, systemtstamp |  limit 100

Stream=FIREWALL |groupby dstip |select dstip, percentage_of(dstport==23), ratio_of(dstport==23) |having percentage_of_col1>0


stream=authentication where user is not null and user='{SuspectUser}' and system='{TargetHost}' | duration 30m | limit 1

stream=authentication where user is not null | duration 30m | groupby user, system | limit 2

stream=iam where sourcename='WINDOWS' and action='PASSWORD_CHANGED' and status='PASSED' and role='User Account Management' |  groupby user, targetuser, system | duration 1d | limit 100

stream=firewall where action='PACKET_ALLOWED' and not left(dstip,3) between 190 and 191 | groupby srcip, dstip

stream=firewall where action='PACKET_BLOCKED' | duration 5m | groupby srcip, dstip | limit 1

stream=* where devsrcip='10.21.171.61' | duration 1d | groupby devsrcip, pstatus

stream=firewall where srctype='PUBLIC' | duration 10m | groupby srcip | limit 2

stream=cloudtrail where eventsource="rds.amazonaws.com" and @responseElements.pendingModifiedValues.masterUserPassword is not null and eventname="ModifyDBInstance" | groupby user

stream=authentication where action='LOGIN' and status IN ('PASSED', 'FAILED')  and @EventType='AUDIT_SUCCESS' | select distinct_count(user) as dstU, user | duration 1h | groupby user | having dstU > 0 | limit 1

stream=authentication where action='LOGIN' and status IN ('PASSED', 'FAILED') and @EventType='AUDIT_SUCCESS' and user='{SuspectUser}' | duration 1h

stream=win-audit where sourcename='WINDOWS' and action='PROCESS_CREATED' and status='PASSED' and eid=4688 and not user in ('yadaje-contadm','pateab-conttadm','cmadmin') | groupby user, @ParentProcessName

stream=firewall | limit 10

stream=webserver where (srctype='PUBLIC' and dsttype='PRIVATE') and action='REQUEST_DENIED' and httpreferer not in ('-', 'None', '"-"') and srcip not in ('::1', '-') and user not in ('None','-','0#.w|ultimatix\\sakmsp_srchdca') |  duration 15m | select srcip, count(*) as countunique, distinct_count(user) as distinctuser, count(distinct(httpreferer)) as distinctref | groupby srcip | having distinctuser>1 and distinctref>0 and countunique>0

stream=firewall | groupby srcisp | limit 100

stream=cloudtrail where eventname in ("ArchiveFindings", "CreateFindingsFilter", "DeleteMember", "DisassociateFromMasterAccount", "DisassociateMember", "DisableMacie", "DisableOrganizationAdminAccount", "UpdateFindingsFilter", "UpdateMacieSession", "UpdateMemberSession", "UpdateClassificationJob") | select user, count(*) as count_col | groupby user | having count_col > 5 | duration 10m

stream=firewall | groupby srcip, dstip | duration 5m | limit 1

stream=authentication AND action='LOGIN' AND status='FAILED' |  limit 10


stream=firewall where action='PACKET_BLOCKED' and not left(dstip,3) between 224 and 239 and not dstport in ('514','8081','161','162','8080','5355') and not srcport in ('514','80','8080','8800') and dstip is not null and srcip is not null |group by srcip, dstip |select srcip, dstip, count(*) as countunique |having countunique>30000

stream=cloudtrail where eventsource="elasticache.amazonaws.com" and eventname IN ("DeleteCacheSecurityGroup", "AuthorizeCacheSecurityGroupIngress", "RevokeCacheSecurityGroupIngress", "AuthorizeCacheSecurityGroupEgress", "RevokeCacheSecurityGroupEgress") | groupby eventname, user

stream=authentication | duration 1d |  groupby action, user, srcip

stream=firewall where action in ('PACKET_ALLOWED', 'PACKET_ALLOWED') and not left(dstip,3) between 50 and 150 and not dstport in ('53','443') and not srcport in ('16018','137') and dstip is not null and srcip is not null | groupby dstip, srcip | select dstip, srcip, count(*) as countunique | duration 1h | having countunique>12

stream=* where devsrcip in ('10.201.2.53', '10.201.2.54', '10.201.2.69', '10.201.2.70', '10.203.2.68', '10.203.2.52') | duration 1d | groupby devsrcip, sourcename, sourcetype, @Severity

stream=win-audit where sourcename='WINDOWS' and action='PROCESS_CREATED' and status='PASSED' and eid=4688 and not user in ('yadaje-contadm','pateab-conttadm','cmadmin') and logevent like "%powershell%" | groupby user, @ParentProcessName

stream=other | limit 1

stream=email-gateway where not remotecn='-' |  groupby remoteip, remotecn | duration 10m | limit 10

stream=authentication where sourcename='MS-O365' | groupby @ExtendedProperties[0].Value as useragent, @UserId as userid, status | duration 30m

stream=authentication where  action='LOGIN' and status='PASSED' | limit 5

stream=authentication where  action='LOGIN' and status='PASSED' | limit 5

stream=configuration where action="CONFIGURATION_CHANGED" AND sourcetype="FIREWALL" | duration 1d | groupby devsrcip, sourcename, config, user

stream=IAM where action='USER_DELETED' and sourcename="NIX" | duration 1d | groupby hostname, action, user

stream=firewall where sourcetype!='NETWORK-OS' and indicatortype in not null and status='PASSED' and categoryoutcome='/Success' and indicator!='None' and action in ('PACKET_ALLOWED','CONNECTION_ESTABLISHED','SESSION_CONNECTED') | groupby indicator, system, deviceaddress | select indicatior, system, deviceaddress, count(*) as countunique | having countunique>=1

stream=* where devsrcip in ('10.201.7.100', '10.201.7.101', '10.203.7.101', '10.201.7.108') | duration 1d | groupby devsrcip, pstatus

stream=firewall where action='PACKET_ALLOWED' |duration 1M |groupby system, systemtstamp, cnamtime |first 1

stream=firewall where sourcetytype!='NETWORK-OS' and action in ('PACKET_ALLOWED', 'CONNECTION_ESTABLISHED', 'SESSION_CONNECTED') and status='PASSED' and categoryoutcome='/Success' and threattype is not null and indicatortype is not null | groupby srcip, threattyty

stream=firewall where devsrcip='114.143.64.202' | groupby srcip, dstip

stream=authentication where sourcename='CBS' | groupby action

stream=win-audit where sourcename='WINDOWS' and action='OBJECT_ACCESSED' and status='PASSED' and eid=4656 and logevent like "%user%" | groupby user, @ProcessName

stream=* where devsrcip="10.201.2.196" | duration 1d | groupby devsrcip, pstatus

stream=firewall where srctype='PUBLIC' |  duration 10h |  select srcip, distinct_count(dstport) as dst_cnt | groupby srcip, dstport |  having dst_cnt >100

stream=other |  duration 1h | limit 1

stream=* | select sum(evtlen) as eventlength | duration 24h

stream=* where devsrcip="10.202.0.196" | duration 1d | groupby devsrcip, pstatus

stream=firewall where srcip='{SuspectUser}' and dstip='{TargetUser}' and resource='{TargetUser}' | duration=5m | limit 10

stream=firewall where action='CONNECTION_ESTABLISHED' and logevent like '%Teardown%' | limit 100

stream=authentication where sourcename='MS-O365' and logevent like "%shell/%" | groupby @ExtendedProperties[0].Value as useragent, @UserId as userid, status

stream=authentication where sourcename='WINDOWS' and logontype='network' and status='failed' and not rlike(user,"(a-zA-Z)*") and not user='101' and deviceprocessname='advapi' and statussubstat in ('0xC0000064_0xc000006a','0xc000015B', '0xc0000072') | duration 1h | select round(($SystemTstamp/86400000)+25569,3) as NewTimestamp, User,COUNT(*) | groupby newtimestamp, user | having count>=10

stream=cloudtrail where eventname='CreateBucket' and eventsource='s3.amazonaws.com' and srctype='PUBLIC' and user='{TargetUser}' and srcip='{SuspectHost}' |  duration 1h | limit 100

stream=cloudtrail where eventname='CreateBucket' and eventsource='s3.amazonaws.com' and srctype='PUBLIC' and acl like '%public%' | duration 5m | select srcip, eventname, eventsource, user, bucketname, acl  |  groupby srcip, eventname, eventsource, user, bucketname, acl | limit 100

stream=firewall where (srcip='99.99.99.99' or dstip='71.39.18.121') | groupby srcip, dstip

stream=firewall where dstport=53 and not (dstip='8.8.8.8' or dstip='66.198.145.99') | groupby dstip | duration 1

stream=authentication where action='LOGIN' and status='PASSED' | duration 1h | groupby user, system | limit 1

stream=authentication where action='LOGIN' and status='PASSED' and user='{SuspectUser}' and system='{TargetHost}' 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg.*?\.exe|gpedit\.msc|cmd\.exe).*?(DisableChangePassword).*?\/d\s1") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg.*?\.exe|gpedit\.msc|cmd\.exe).*?(DisableChangePassword).*?\/d\s1") | groupby user, system

stream=EMAIL-GATEWAY | duration 1h | groupby sender, recipient |  limit 5000

stream=win-audit where sourcename='WINDOWS' and action='POLICY_CHANGED' and status='PASSED' and event='Domain Policy was changed.' | duration 30m | groupby user

stream=* where sourcetype="DAM" and devsrcip in ('10.204.0.164', '10.201.0.228', '10.201.1.52', '10.201.2.100', '10.202.0.228', '10.203.0.228', '10.203.8.52', '10.203.0.229', '10.203.2.100') | duration 1d | groupby devsrcip,pstatus

stream=authentication where action='LOGIN' | duration 6h |  groupby user | limit 2

stream=cloudtrail where eventname in ('UpdateTrail', 'DeleteTrail', 'StopLogging', 'DeleteFlowLogs', 'DeleteEventBus') and user is not null and eventsource is not null | groupby user, userarn, eventname | duration 5m

stream=cloudtrail where eventname in ('UpdateTrail', 'DeleteTrail', 'StopLogging', 'DeleteFlowLogs', 'DeleteEventBus') and user is not null and eventsource is not null and user='{SuspectUser}'

stream=authentication where action='LOGIN' | duration 6h |  timeslice 1h |  groupby user

stream=configuration where sourcename='MSSQL' and action='CONFIGURATION_CHANGED' and status='PASSED' and config='SQL Server is starting at normal priority base.' | groupby user, config | duration 7d | limit 10

stream=authentication where sourcename='NIX' and action='LOGIN' and status='PASSED' and user is not null and authproto in ('VPN','SSH') | groupby user, authproto, system, srcip, devsrcip | duration 1d | limit 100

stream=authentication where sourcename='NIX' and action='LOGIN' and status='FAILED' and user is not null |  duration 24h |  groupby user, srcip, devsrcip | limit 10

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%cmd.exe%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%System%LocalAccountTokenFilterPolicy%EnableLinkedConnections%SYSTEM%CurrentControlSet%Control%FileSystem%LongPathsEnabled%DWORD%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%cmd.exe%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%System%LocalAccountTokenFilterPolicy%EnableLinkedConnections%SYSTEM%CurrentControlSet%Control%FileSystem%LongPathsEnabled%DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=firewall where not srccn='-' | groupby srcip, srccn |  duration 7d | first 12


stream=* | duration 1h | select devsrcip as UniqueDevSrcIP, count(*) as count_unique | groupby devsrcip

stream=authentication where sourcename='FORTIGATE' and action='LOGIN' and status='PASSED' and authproto='VPN' | groupby user, srcip | duration 1d | limit 10

stream=* | duration 1h | select devsrcip as UniqueDevSrcIP, count(*) as count_unique | groupby devsrcip

stream=authentication where sourcename='NIX' and action='LOGIN' and status='PASSED' | groupby user,devsrcip | duration 1d | limit 10


stream=configuration where sourcename='MSSQL' and action='CONFIGURATION_CHANGED' and status='PASSED' and config='SQL Server Blocked' | groupby user, config | duration 1d | limit 10

stream=authentication where sourcename='NIX' and action='LOGIN' and status='PASSED' and user is not null and authproto in ('VPN','SSH') | groupby user, authproto, system, srcip, devsrcip | duration 1d | limit 100

stream=iam where sourcename='WINDOWS' and action='USER_DELETED' and role='User Account Management' |  duration 24h |  groupby user, targetuser | limit 10

stream=configuration where sourcename='MSSQL' and action='CONFIGURATION_CHANGED' and status='PASSED' and config='Server Reconfiguration' | groupby user, config | duration 1d | limit 10

stream=iam where action='PRIVILEGE_CHANGED' and status='PASSED' and role='Special Logon' | groupby user, targetuser, domain | duration 1d | limit 10

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('netsh.exe','cmd.exe','powershell.exe') and (commandline like '%advfirewall firewall set rule group=%remote desktop%new enable=Yes%' or commandline like '%advfirewall firewall set rule group=%file and printer sharing%new enable=Yes%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('netsh.exe','cmd.exe','powershell.exe') and (commandline like '%advfirewall firewall set rule group=%remote desktop%new enable=Yes%' or commandline like '%advfirewall firewall set rule group=%file and printer sharing%new enable=Yes%') | groupby user, system

stream=authentication where devsrcip='172.16.57.145' and action='LOGOUT' and user is not null |  groupby user | duration 24h | limit 10

stream=authentication where sourcename='MSSQL' and action='LOGIN' and status='PASSED' | groupby user | duration 1d | limit 10

stream=firewall |  groupby srcip

stream=configuration where sourcename='WINDOWS' and action='CONFIGURATION_CHANGED' and status='PASSED' and config='System Start' | groupby system,devsrcip | duration 1d | limit 10

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%cmd.exe%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%System%LocalAccountTokenFilterPolicy%EnableLinkedConnections%SYSTEM%CurrentControlSet%Control%FileSystem%LongPathsEnabled%DWORD%1%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%cmd.exe%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%System%LocalAccountTokenFilterPolicy%EnableLinkedConnections%SYSTEM%CurrentControlSet%Control%FileSystem%LongPathsEnabled%DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=configuration where sourcename='WINDOWS' and not system='MUMDCAD01.paytmbank.net' and not user='LOCAL SERVICE' AND eid='4616' | duration 1h | groupby user, system | limit 10

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.60.106' and eventid='706' | groupby config | duration 30d | limit 100 

stream=signals | duration 1d | groupby workbook 

stream=authentication where action='LOGIN' |  groupby user, srcip |  select user,distinct_count(srcip) as srcip_cnt |  having srcip_cnt>2

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableCMD") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableCMD") and user='{SuspectUser}' and '{TargetHost}' | duration 6m

stream=* where devsrcip="10.202.0.196" | duration 1d | groupby devsrcip, sourcename, soucetype

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.54' and eventid='706' | groupby config | duration 30d | limit 100 

stream=firewall where action='PACKET_BLOCKED' | groupby srcip, system | duration 1h | limit 8

stream=firewall where action='PACKET_BLOCKED' and srcip='{$SuspectHost}' and system='{$TargetHost}' 

stream=webserver where (useragent like '%Iceweasel%' or useragent like '%Nikto%' or useragent like '%dirb%' or useragent like '%Wscript%') | select srcip, useragent,count(*) as countunique | groupby srcip, useragent | having countunique>=1

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663', '4656') and rlike(lower(commandline), '(new blob|remote.html)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663', '4656') and rlike(lower(commandline), '(new blob|remote.html)') | groupby system, user

stream=nta-dns |  duration 12h | groupby dstip

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike (lower(commandline),'tshark.*?(\-i.*?\-c|\-f|\-r\|-w)') | duration 1h

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike (lower(commandline),'tshark.*?(\-i.*?\-c|\-f|\-r\|-w)')and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process,win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), 'currentcontrolset.*?control.*?lsa.*?runasppl.*?(dword|value).*?0') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%CurrentControlSet%Control%LSA%v%RunAsPPL%t%REG_DWORD%/d%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process,win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), 'currentcontrolset.*?control.*?lsa.*?runasppl.*?(dword|value).*?0') | groupby user, system

stream=ep-process,win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), 'currentcontrolset.*?control.*?lsa.*?runasppl.*?(dword|value).*?0') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike (lower(commandline),'tshark.*?(\-i.*?\-c|\-f|\-r\|-w)') | groupby  user, system

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike (lower(commandline),'tshark.*?(\-i.*?\-c|\-f|\-r\|-w)')and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%fltmc%unload%sysmon%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%fltmc%unload%sysmon%' | groupby user, system

stream=ep-process,win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), 'currentcontrolset.*?control.*?lsa.*?runasppl.*?(dword|value).*?0') | groupby user, system

stream=ep-process,win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), 'currentcontrolset.*?control.*?lsa.*?runasppl.*?(dword|value).*?0') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=nta-dns |  duration 12h | groupby dstip

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'c.*?windows.*?microsoft.net.*?framework64.*?(csc\.exe|csc)' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'c.*?windows.*?microsoft.net.*?framework64.*?(csc\.exe|csc)' | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'destination.*?(customshellhost.exe|explorer.exe).*?force' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'destination.*?(customshellhost.exe|explorer.exe).*?force' | groupby  user, system

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%fltmc%unload%sysmon%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%fltmc%unload%sysmon%' | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'sdelete.*?(-c|-f|-p|-q|-r|-s|-z)')| groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'sdelete.*?(-c|-f|-p|-q|-r|-s|-z)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like  '%cipher%/w:c:%' 

stream=OTHER where devsrcip='10.64.26.12' and logevent like '%WINVAT_Online_sdl...' | duration 2h | limit 100

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%tshark.exe%-i%-c 5%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike (lower(commandline),'tshark.*?(\-i.*?\-c|\-f|\-r\|-w)') | duration 1h

stream=ep-process,win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), 'currentcontrolset.*?control.*?lsa.*?runasppl.*?(dword|value).*?0') | groupby user, system

stream=ep-process,win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), 'currentcontrolset.*?control.*?lsa.*?runasppl.*?(dword|value).*?0') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and ((commandline like '%ie4uinit.exe%ieuinit.inf%') or lower(commandline) like '%ie4unit.exe%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and ((commandline like '%ie4uinit.exe%ieuinit.inf%') or lower(commandline) like '%ie4unit.exe%') | groupby user, system

stream=nta-kerberos where action = 'KERBEROS_AUTHENTICATION_SERVICE_USED' and status = 'FAILED' and not client like '%$%' |  duration 1h |  groupby client, action, srcip, status

stream=nta-kerberos where action = 'KERBEROS_AUTHENTICATION_SERVICE_USED' and client = '{TargetUser}' and srcip = '{SuspectHost}' and not client like '%$%' |  duration 1h 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like  '%cipher%/w:%c:%'  | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%CurrentControlSet%Control%LSA%v%RunAsPPL%t%REG_DWORD%/d%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process,win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), 'currentcontrolset.*?control.*?lsa.*?runasppl.*?(dword|value).*?0') | groupby user, system

stream=nta-kerberos where action = 'KERBEROS_AUTHENTICATION_SERVICE_USED' and status = 'FAILED' and not client like '%$%' |  duration 1h |  groupby client, action, srcip, status

stream=authentication

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '((net|sc).*?(stop|delete).*?sysmon|sysmon.*?-u)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '((net|sc).*?(stop|delete).*?sysmon|sysmon.*?-u)') | groupby system, user

stream=OTHER where devsrcip='10.64.26.12' and logevent like '%WINVAT_BAT_Online_sdl...' | duration 1h | limit 100

stream=other where devsrcip='10.64.26.12' and logevent like '%WINRDPADT%' | duration 1h | limit 1

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '((net|sc).*?(stop|delete).*?sysmon|sysmon.*?-u)') | groupby system, user

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '((net|sc).*?(stop|delete).*?sysmon|sysmon.*?-u)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=nta-rdp where cookie = '{TargetUser}' | duration 1h

stream=nta-rdp where cookie = 'Administrator' or cookie = 'raiAdmin' | duration 1h

stream=nta-kerberos where action = 'KERBEROS_AUTHENTICATION_SERVICE_USED' and status = 'FAILED' and not client like '%$%' |  duration 1h |  groupby client, action, srcip, status

stream=nta-kerberos where action = 'KERBEROS_AUTHENTICATION_SERVICE_USED' and client = '{TargetUser}' and srcip = '{SuspectHost}' and not client like '%$%' |  duration 1h 

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (lower(commandline)  like '%winpwn.ps1%mimiload%') | groupby user, system

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (lower(commandline) like '%winpwn.ps1%mimiload%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=nta-rdp where cookie = '{TargetUser}' | duration 1h

stream=nta-rdp where cookie = 'Administrator' or cookie = 'raiAdmin' | duration 1h

stream=nta-rdp where action = "{TargetUser}" | duration 1h

stream=nta-rdp where cookie = 'Administrator' or cookie = 'raiAdmin' | duration 1h

stream=nta-rdp where cookie = "{TargetUser}" | duration 1h

stream=nta-rdp where cookie = 'Administrator' or cookie = 'raiAdmin' | duration 1h

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%windows%control.exe%' | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%windows%control.exe%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT,EP-PROCESS where action in ("PROCESS_CREATED", "PROCESS_ADDED") and ( rlike(lower(commandline), "(net.*?stop|sc.*?stop).*?(windefend|mpssvc|wuauserv|wscsvc|sense|policyagent|wdnissvc|vaultsvc|eventlog|nlasvc|bfe|rpcss|rasman|smartscreen|nissrv|winmgmt|alg|winrm|swprv|securityhealthservice|gpsvc|kdc|lanmanserver|lanmanworkstation|msdtc|efs|bdesvc|napagent|wbiosrvc|wbengine|w32time|dgssvc|scardsvr|wscsvc|winrm|mcafeedlpagentservice)") or rlike(lower(commandline), "sc.*?config.*?(windefend|mpssvc|wuauserv|wscsvc|sense|policyagent|wdnissvc|vaultsvc|eventlog|nlasvc|bfe|rpcss|rasman|smartscreen|nissrv|winmgmt|alg|winrm|swprv|securityhealthservice|gpsvc|kdc|lanmanserver|lanmanworkstation|msdtc|efs|bdesvc|napagent|wbiosrvc|wbengine|w32time|dgssvc|scardsvr|wscsvc|winrm|mcafeedlpagentservice).*?start.*?disable")) | groupby user, system

stream=WIN-AUDIT,EP-PROCESS where action in ("PROCESS_CREATED", "PROCESS_ADDED") and ( rlike(lower(commandline), "(net.*?stop|sc.*?stop).*?(windefend|mpssvc|wuauserv|wscsvc|sense|policyagent|wdnissvc|vaultsvc|eventlog|nlasvc|bfe|rpcss|rasman|smartscreen|nissrv|winmgmt|alg|winrm|swprv|securityhealthservice|gpsvc|kdc|lanmanserver|lanmanworkstation|msdtc|efs|bdesvc|napagent|wbiosrvc|wbengine|w32time|dgssvc|scardsvr|wscsvc|winrm|mcafeedlpagentservice)") or rlike(lower(commandline), "sc.*?config.*?(windefend|mpssvc|wuauserv|wscsvc|sense|policyagent|wdnissvc|vaultsvc|eventlog|nlasvc|bfe|rpcss|rasman|smartscreen|nissrv|winmgmt|alg|winrm|swprv|securityhealthservice|gpsvc|kdc|lanmanserver|lanmanworkstation|msdtc|efs|bdesvc|napagent|wbiosrvc|wbengine|w32time|dgssvc|scardsvr|wscsvc|winrm|mcafeedlpagentservice).*?start.*?disable")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=nta-intel where srcip="{TargetHost}" and indicator="{SuspectObject}" |  duration 30m

stream=nta-intel  | groupby indicatortype, indicator,  msg, srcip | duration 30m

stream=nta-kerberos where action = 'KERBEROS_AUTHENTICATION_SERVICE_USED' and status = 'FAILED' and not client like '%$%' |  duration 1h |  groupby client, action, srcip, status

stream=nta-kerberos where action = 'KERBEROS_AUTHENTICATION_SERVICE_USED' and client = '{TargetUser}' and srcip = '{SuspectHost}' and not client like '%$%' |  duration 1h 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'sdelete.*?(-c|-f|-p|-q|-r|-s|-z)') | duration 1d| groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'sdelete.*?(-c|-f|-p|-q|-r|-s|-z)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'sdelete.*?(-c|-f|-p|-q|-r|-s|-z)') | duration 1d| groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'sdelete.*?(-c|-f|-p|-q|-r|-s|-z)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (lower(commandline)  like '%winpwn.ps1%mimiload%') | groupby user, system

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (lower(commandline) like '%winpwn.ps1%mimiload%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=other where devsrcip='10.64.26.12' and logevent like '%MIMIKATZ%' | duration 1h | limit 100

stream=ep-registry where action='OBJECT_MODIFIED' and targetobject='%Software%Microsoft%Office%Resiliency%' | groupby system, targetobject, user | limit 100

stream=ep-registry where action='OBJECT_MODIFIED' and targetobject='%Software%Microsoft%Office%Resiliency%' and system='{TargetHost}'

stream=authentication where action='LOGIN' and user is not null and not user like 'sa%' and srcip is not null | duration 1m | groupby srcip, system | select srcip, system, count_if(status=='FAILED') as failcount, count_if(status=='PASSED') as passcount | having failcount >= 10000 and failcount >= passcount * 5 | limit 100 

stream=* where devsrcip in ('10.201.2.53', '10.201.2.54', '10.201.2.69', '10.201.2.70', '10.203.2.68', '10.203.2.52') | duration 1d | groupby devsrcip, pstatus

stream=webserver where not action='REQUEST_DENIED' and method is not null and user='-' | select srcip, method, count(*), distinct_count(srcip) as distinctsrcip | groupby srcip, method | having distinctsrcip>=1

stream=webserver where srcip='{SuspectHost}' and not action='REQUEST_DENIED' and method is not null and user='-' 

stream=authentication where action='LOGIN' and user is not null and srcip is not null and status='FAILED' | duration 1h | groupby srcip, system | select srcip, system, distinct_count(sourcetype) as failcount | having failcount >= 2

stream=authentication where sourcename='F5BIGIP' and status='FAILED' and srcip is not null | select srcip, round((systemtstamp/86400000)+25569,1) as temp, eventname, count(*) as CountUnique | groupby srcip, temp, eventname | having CountUnique>=5 

stream=authentication where sourcename='F5BIGIP' and status='FAILED' and srcip is not null | duration 1h | select srcip, distinct_count(eventname) as CountUnique | groupby srcip | having CountUnique>=3

stream=ep-process where action='PROCESS_ADDED' and newprocessname like '%powershell.exe' and (commandline like 'reg%add%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like 'reg%delete%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or Commandline like '%New-ItemProperty%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and newprocessname like '%powershell.exe' and (commandline like 'reg%add%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like 'reg%delete%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or Commandline like '%New-ItemProperty%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') | groupby user, system 

stream=auditd where sourcename='F5BIGIP' and logcode='01420007' | duration 7d | select file, distinct_count(system) as CountUnique | groupby file | having CountUnique>=1

stream=configuration where sourcename='F5BIGIP' and logcode in ('01310053','01070417') and not user in ('fwadmin','root','admin') | duration 1h | select user, system, count(*) as CountUnique | groupby user, system | having CountUnique>=5

stream=configuration where sourcename='CISCO-ISE' and eventid='52001' and duser not in ('internal-sys-user','System','idm') | duration 1h | select duser, system, count(*) as CountUnique | groupby duser, system | having countUnique>=5

stream=auditd where sourcename='CISCO-ISE' and eventid='60167' | duration 7d | select system, count(*) as CountUnique | groupby system | having CountUnique>=1

stream=threat where sourcename='CROWDSTRIKE-FALCON' and threat is not null and not user REGEXP('[a-zA-Z]') | duration 1d | select user, count(*) as CountUnique | groupby user | having CountUnique>100

stream=threat where sourcename='CROWDSTRIKE-FALCON' and threat is not null and not (user='N/A' or user is null or user like '%@tcs.com') and user like '%HW%' and srctype='PRIVATE' and category is not null | select user, srchost, round((systemtstamp/86400000)+25569,1) as temp, count(*) as CountUnique | groupby user, srchost, temp | having CountUnique>=20

stream=threat where sourcename='CROWDSTRIKE-FALCON' and threat is not null and (user='N/A' or user is null) and srctype='PRIVATE' | duration 1h | select srchost, category, threat, count(*) as CountUnique | groupby srchost, category, threat | having CountUnique>=1

stream=threat where sourcename='Attivo' and whitelist='DecoyIP' and srcip not in ('10.87.17.218','10.17.239.167','10.17.239.27','10.51.104.230') and category!='Information' | select srcip, category, eventname, count(*) as uniqueevent | groupby srcip, category, eventname | having uniqueevent>5

stream=threat where sourcename='Attivo' and whitelist='DecoyIP' and srcip not in ('10.87.17.218','10.17.239.167','10.17.239.27','10.51.104.230') and category!='Information' | select srcip, category, distinct_count(eventname) as uniqueevent | groupby srcip, category | having uniqueevent>1

stream=threat where sourcename='Attivo' and whitelist='DecoyIP' and srcip not in ('10.87.17.218','10.17.239.167','10.17.239.27','10.51.104.230') and category!='Information' | select srcip, count(category) as uniquecategory | groupby srcip | having uniquecategory>1

stream=dns where sourcename='CISCO-ISE' and eventid in ('25016', '25044') | duration 1h | select dstdomain, count(*) as CountUnique | groupby dstdomain | having CountUnique>500

stream=dns where responsecode='NXDOMAIN' and system like '%dns%.tcs.com' and dstdomain not like '%in-addr.arpa%' and not (dstdomain like '%senderbase.org' or dstdomain like '%spamhaus.org' or dstdomain like '%barracudacentral.org') | duration 1h | select distinct(srcip) as DistinctSrcIP, system, count(*) as count | groupby srcip, system | having count>500

stream=dns where dstdomain like '%aaa.stage.%' or dstdomain like '%apost.1%' | select distinct(srcip) as DistinctSrcIP, system, count(*) as count | groupby srcip, system | having count>=1

stream=dns where proto='UDP' and (dstdomain not like '%in-addr.arpa%' or dstdomain not like '%opendns%') and system like '%dns%.tcs.com' and action='DNS_QUERIED' | duration 1h | select distinct(srcip) as DistinctSrcIP, system, count(*) as count | groupby srcip, system | having count>=30000

stream=dns where action='DNS_QUERIED' and query like 'Query:TXT%' and system not like 'cdctns3new%' and dstdomain not like '%in-addr.arpa%' and dstdomain not like '%opendns%' and srcport > 1023 and dstport='53' | duration 15m | select distinct(srcip) as DistinctSrcIP, dstdomain, count(*) as count | groupby srcip, dstdomain | having count>1000

stream=dns where srctype='PUBLIC' and action='DNS_QUERIED' and system not like 'cdctns3new%' and dstdomain not like '%in-addr.arpa%' and dstdomain is not null and dstdomain not like '%opendns%' and srcport > 1023 | duration 1h | select srcip, round((SUBSTR(systemtstamp,1,(length(systemtstamp)))/86400000)+25569,1) as NewTimestamp, count(*) as countUnique | groupby srcip, NewTimestamp | having countUnique > 5000 

stream=dns where srctype='PRIVATE' and action='DNS_QUERIED' and system not like 'cdctns3new%' and dstdomain not like '%in-addr.arpa%' and dstdomain is not null and dstdomain not like '%opendns%' and srcport > 1023 | duration 1h | select srcip, round((SUBSTR(systemtstamp,1,(length(systemtstamp)))/86400000)+25569,1) as NewTimestamp, count(*) as countUnique | groupby srcip, NewTimestamp | having countUnique>15000

stream=email-gateway where sourcename='CISCO-IRONPORT' and srcip is not null and sendergroup in ('SUSPECTLIST','BLACKLIST') and action='EMAIL_DELIVERED' and status='PASSED' and sbrs REGEXP '(?i)(?:^\-+[0-9]|^[0-2]|china)' | select deviceaddress, distinct_count(srcip) as CountUnique | groupby by deviceaddress | having CountUnique>=5

stream=email-gateway where sourcename='CISCO-IRONPORT' and action='EMAIL_DELIVERED' and status='PASSED' and file is not null and srcip is not null and SUBSTR(file,Instr(File,"."),LENGTH(file)) IN ('.app','.bin','.exe','.osx','.out','.prg','.run','.eham','.ham','.js','.nexe','.ore','.pex','.plx','.rox','.upx') | select srcip, count(*) as CountUnique | groupby by srcip | having CountUnique>=2

stream=email-gateway where sourcename='CISCO-IRONPORT' and srcip is not null and sendergroup in ('SUSPECTLIST','BLACKLIST') and action='EMAIL_DELIVERED' and status='PASSED' and sbrs REGEXP '(?i)(?:^\-+[0-9]|^[0-2]|china)' | duration 1h | select srcip, srcdomain,deviceaddress, count(*) as CountUnique | groupby by srcip,srcdomain,deviceaddress | having CountUnique>=10

stream=firewall where sourcename='ASA' and dsttype='PUBLIC' and srctype='PRIVATE' and action='PACKET_ALLOWED' and categoryoutcome ='/Success' and status='PASSED' and dstport in (1389, 389, 636, 1099) |  duration 30m | groupby srcip, dstip, deviceaddress, system | select srcip, dstip, dstport, count(*) as countunique, distinct_count(srcip) as uniquesources | having uniquesources < 25

stream=firewall where sourcename='F5BIGIP' and action='CONNECTION_TERMINATED' and srcip is not null | duration 1h | groupby srcip, system, logcode, eventname | select srcip, system, logcode, eventname, count(*) as CountUnique | having CountUnique>1000

stream=firewall where (srctype='PRIVATE' or whitelist='InternalIP') and not left(dstip,3) between 224 and 239 and dstport not in ('514','8081','161','162','8080','5355') and srcport not in ('514','80','8080','8800') and dstip is not null and srcip is not null and action='PACKET_BLOCKED' | duration 30m | select srcip, dstip, distinct_count(srcip) as distinctsrcip, count(*) as countunique | groupby srcip, dstip | having distinctsrcip>1 and countunique>50000

stream=firewall where sourcename='ASA' and eventid='106021' and action in ('PACKET_ALLOWED','CONNECTION_ESTABLISHED','SESSION_CONNECTED','PACKET_BLOCKED') |  duration 1h | groupby srcip, dstip | select srcip, dstip, count(*) as countunique | having countunique>8000

stream=firewall where srctype='PUBLIC' and whitelist is null and dsttype='PRIVATE' and dstport not in ('80','8080','443','514') and action='PACKET_ALLOWED' and not left(dstip,3) between 224 and 239 and dstip is not null and srcip is not null | duration 1h | groupby srcip, dstip | select srcip, dstip, distinct_count(dstport) as countunique | having countunique > 2000

stream=firewall where sourcename='FORTIGATE' and action='PACKET_BLOCKED' and srcip is not null | select srcip, distinct_count(concat(system,"--",eventname)) as CountUnique | groupby srcip | having CountUnique>=5 

stream=firewall where srctype='PUBLIC' and dsttype='PRIVATE' and action='PACKET_ALLOWED' and whitelist is null and proto='ICMP' and not left(dstip,3) between 224 and 239 and dstip is not null and srcip is not null | duration 15m | groupby srcip, dstip | select srcip, dstip, count(*) as countunique | having countunique > 6000

stream=firewall where srctype='PUBLIC' and whitelist is null and status='PASSED' and categorysignificance in ('/Suspicious','/Compromise') and dstport='445' and not left(dstip,3) between 224 and 239 | duration 1h | select srcip, dstip, count(*) as cnt | groupby srcip, dstip | having cnt>2000

stream=firewall where (srctype='PRIVATE' or whitelist='InternalIP') and status='PASSED' and categorysignificance in ('/Suspicious','/Compromise') and dstport='445' and not left(dstip,3) between 224 and 239 | duration 1h | select srcip, dstip, count(*) as countunique | groupby srcip, dstip | having countunique > 3000 

stream=firewall where sourcename='ASA' and eventid='106021' and action in ('PACKET_ALLOWED','CONNECTION_ESTABLISHED','SESSION_CONNECTED') and status='PASSED' | select srcip, dstip, count(*) as cnt | groupby srcip, dstip | having cnt>=1


stream=firewall where (srctype='PRIVATE' or whitelist='InternalIP') and dsttype='PRIVATE' and dstport not in ('80','8080','443','514') and not left(dstip,3) between 224 and 239 and dstip is not null and srcip is not null | duration 1h | groupby srcip, dstip | select srcip, dstip, distinct_count(dstport) as countunique | having countunique > 3200

stream=iam where sourcename='SITEMINDER' and indicatortype is not null and eventname in ('AuthAccept','ValidateAccept') and indicator!='None' | select system, indicator, distinct_count(realm) as CountUnique | groupby system, indicator | having CountUnique>=1

stream=firewall where action='PACKET_BLOCKED' and srctype='PUBLIC' and whitelist is null and not left(dstip,3) between 224 and 239 and not dstport in ('514','8081','161','162','8080','5355') and not srcport in ('514','80','8080','8800') and dstip is not null and srcip is not null| duration 1h | groupby srcip, dstip | select srcip, dstip, count(*) as countunique | having countunique>30000

stream=firewall where srctype='PUBLIC' and whitelist is null and not left(dstip,3) between 224 and 239 and dstport not in ('514','8081','161','162','8080','5355') and srcport not in ('514','80','8080','8800') and dstip is not null and srcip is not null and action='PACKET_BLOCKED' | duration 30m | select srcip, dstip | groupby srcip, dstip, distinct_count(srcip) as distinctsrcip, COUNT(*) as countunique | having distinctsrcip>1 and countunique>20000

stream=firewall where sourcename='ASA' and eventid='106017' and status='FAILED' |  duration 30m |  select srcip, dstip, deviceaddress, system, count(*) as cnt |  groupby srcip, dstip, deviceaddress, system having cnt > 100

stream=firewall where (srctype='PUBLIC' or whitelist='InternalIP') and dsttype='PRIVATE' and proto='ICMP' and action='PACKET_ALLOWED' and not left(dstip,3) between 224 and 239 and dstip is not null and srcip is not null | duration 15m | groupby srcip, dstip | select srcip, dstip, count(*) as countunique | having countunique > 30000

stream=firewall where sourcename='ASA' and eventid='106017' and status='PASSED' |  duration 30m | groupby srcip, dstip, deviceaddress, system | select srcip, dstip, system, deviceaddress, count(*) as countunique | having countunique>=1

stream=webfilter where url like '%jndi:%' | select url, count(*) as cnt | groupby url | having cnt >=1

stream=firewall where action in('PACKET_ALLOWED','SESSION_ESTABLISHED','CONNECTION_ESTABLISHED','SESSION_CONNECTED') and (srctype='PRIVATE' or whitelist='InternalIP') and not left(dstip,3) between 224 and 239 and dstport in(0,443,53) and dstip is not null and srcip is not null and dsttype='PRIVATE' | duration 30m |  select dstip, distinct_count(srcip) as srccnt |  groupby dstip | having srccnt>=13500

stream=firewall where srctype='PUBLIC' and action in ('PACKET_ALLOWED','SESSION_ESTABLISHED','CONNECTION_ESTABLISHED','SESSION_CONNECTED') and whitelist is not null and not left(dstip, 3) between 224 and 239 and dstport not in (0,443,53) and dstip is not null and srcip is not null and dsttype='PRIVATE' | duration 30m | select srcip, dstip, count(*) as cnt, count(srcip) as srccnt |  groupby srcip, dstip | having srccnt > 1 and cnt > 3500

stream=iam where sourcename='SITEMINDER' and eventname in ('AuthAccept','ValidateAccept') and threattype is not null and indicatortype is null | select srcip, threattype, count(*), distinct_count(srcip) as CountUnique | groupby srcip, theattype | having CountUnique>=1

stream=authentication where threattype is not null and indicatortype is null and eventname not in ('Connection closed','Received disconnect','Did not receive identification string','Failed password','Identification not received') | select srcip, threattype, count(*), distinct_count(srcip) as CountUnique | groupby srcip, theattype | having CountUnique>=1

stream=webserver where srcip not in ('-', '"-"', 'None') and (useragent like '%jndi%' or url like 'jndi') and returncode like '2%' | duration 1h | select srcip, count(*) as countunique | groupby srcip | having countunique>=1

stream=iam where sourcename='SITEMINDER' and reason='UserDisabled' and not eventname='AuthReject' and smstatus not like '%authcode%' and smstatus like '%User%' and not user REGEXP ('[a-zA-Z]') and user not in ('None','-','weblogic') | select round((substr(cnamtime,1,(length(cnamtime)))/86400000)+25569,3) as NewTimestamp, eventname, smstatus, user, realm, count(*) as cnt | groupby NewTimestamp, eventname, smstatus, user, realm | having cnt>=1

stream=iam where sourcename='SITEMINDER' and not reason='-' and eventname='AzReject' and not user REGEXP ('[a-zA-Z]') and user not in ('None','-') | duration 1h | select round((SUBSTR(cnamtime,1,(length(cnamtime)))/86400000)+25569,3) as NewTimestamp, user, realm, devsrcip, count(*) as cnt | groupby  NewTimestamp, user, devsrcip, realm | having cnt>100

stream=authentication where indicatortype is not null and status='PASSED' and indicator!='None' | select system, indicator, count(*) as CountUnique | groupby system, indicator | having CountUnique>=1

stream=iam where sourcename='SITEMINDER' and eventname='AuthReject' and smstatus like '%error%' and reason='ExcessiveFailedLoginAttempts' and not user REGEXP ('[a-zA-Z]') and user!='None' and not reason='-' | duration 15m | select round((SUBSTR(cnamtime,1,(length(cnamtime)))/86400000)+25569,3) as NewTimestamp, user, smdomain, realm, count(*) as cnt | groupby NewTimestamp, user, smdomain, realm | having cnt>=10

stream=other where  devsrcip='10.64.26.12' and logevent like '%WINSIDHIS%' | duration 1h | limit 100

stream=other where devsrcip='10.64.26.12' and logevent like '%MALIPVALIDATION_INFRA%' | duration 1d | limit 100

stream=other where devsrcip='10.64.26.12' and logevent like '%WINNEWAUTH%' | duration 4m | limit 100

stream=threat where sourcename='ASM' and returncode in ('0','200') and threat!='N/A' and action='THREAT_DETECTED' and threat not in ('Cross Site Scripting (XSS)','Path Traversal','SQL-Injection') and url not in ('/*','/') and not (lower(url) REGEXP ('(.png|.json|.jsp|.jsf|.png|.jpg|.bmp|.js|.gif|.css|.svg|.html)(?![a-zA-z\-\/\.\_\?\&\|])')) | duration 1h | select srcip, count(threat) as CntThreat, url, count(*) as CountUnique | groupby srcip, url | having CntThreat>=1 

stream=threat where sourcename='ASM' and (lower(url) like '%.sh' or lower(url) like '%shell%cmd%') and action='THREAT_DETECTED' and returncode in ('0','200') | duration 1h | select srcip, COUNT(*) as CountUnique | groupby srcip, url | having CountUnique>=1

stream=threat where sourcename='ASM' and returncode in ('0','200') and indicatortype is not null and action='THREAT_DETECTED' and indicator!='None' | select system, indicator, count(*) as CountUnique | groupby system, indicator | having CountUnique>=1

stream=threat where action='THREAT_DETECTED' and returncode in ('0','200') and threattype is not null and indicatortype is null | select srcip, threattype, count(*), distinct_count(srcip) as CountUnique | groupby srcip, threattype | having CountUnique>=1

stream=threat where sourcename='ASM' and (url like '%<%>%' or url like '%</%>%') and action='THREAT_DETECTED' and returncode in ('0','200') | duration 1h | select srcip, count(*) as CountUnique | groupby srcip, url | having CountUnique>=1

stream=threat where sourcename='ASM' and lower(url) like '%extract%' and action='THREAT_DETECTED' and returncode in ('0','200') | duration 1h | select srcip, count(*) as CountUnique | groupby srcip, url | having CountUnique>=1

stream=threat where sourcename='ASM' and action='THREAT_DETECTED' and returncode in ('0','200') and (lower(url) like lower('%SELECT%') or lower(url) like lower('%INSERT%') or lower(url) like lower('LIKE%UNION%') or lower(url) like lower('%CONVERT%') or lower(url) like lower('%CONCAT%') or lower(url) like lower('%TRUNCATE%') or lower(url) like lower('%DELETE%') or lower(url) like lower('%EVAL%') or lower(url) like lower('%UPDATE%') or lower(url) like lower('%SLEEP%')) and not user in ('-','None','101') and not (lower(url) REGEXP ('(?i)(?:update|select|delete|eval|insert|convert|concat|sleep|union)(?=[0-9a-zA-z\-\/\.\_\?])')) and not (lower(url) REGEXP ('(.pnLIKEg|.json|.jsp|.jsf|.png|.jpg|.bmp|.js|.gif|.css|.svg|.html)(?![a-zA-z\-\/\.\_\?\&\|])')) and not (lower(url) like '%update' or lower(url) like '%select' or lower(url) like '%insert' or lower(url) like '%delete') | duration 1h | select  srcip, count(*) as CountUnique | groupby srcip, url | having CountUnique>=1

stream=threat where sourcename='ASM' and (url like '%../%' or url like '%..%2f%' or url like '%%2e%2e%2f%' or url like '%%25%2e%25%2e%25%5c%') and action='THREAT_DETECTED' and returncode in ('0','200') | duration 1h | select srcip, count(*) as CountUnique | groupby srcip, url | having CountUnique>=1

stream=webfilter where user is not null and (returncode like '3%' or returncode like '4%' or returncode like '5%') and (srctype='PRIVATE' or whitelist is not null) and not dstip='0.0.0.0' | duration 1h | select srcip, dsthost, count(*) as countunique | groupby srcip, dsthost | having countunique >= 8000

stream=webfilter where action='URL_ALLOWED' and (category like 'Pornography' or category like 'Nudity' or category like 'Online') and not (destinationservicename like 'Google Chat' or destinationservicename like 'Google Hangouts' or destinationservicename like 'General Browsing') or not (contentcategory like 'Google Chat' or contentcategory like 'Google Hangouts' or contentcategory like 'General Browsing') and user is not null and (srctype='PRIVATE' or whitelist is not null) | select srcip, substr(user,1,(length(user)-instr(user, "@")-1)) as user, count(*) as cnt  | groupby srcip, user | having cnt >= 1

stream=webfilter where (dsthost like '%aaa.stage.%' or dsthost like '%post.1%') | select substr(user,1,(length(user)-instr(user, "@")-1)) as user, dsthost, count(*) as cnt | groupby user, dsthost | having cnt >= 1

stream=webfilter where action='URL_ALLOWED' and dsthost is not null and user is not null and (returncode='NA' or returncode like '2%') and (dsthost like '%.surf' or dsthost like '%.gq' or dsthost like '%.ga' or dsthost like '%.cf' or dsthost like '%.ml' or dsthost like '%.tk' or dsthost like '%.work' or dsthost like '%.tokyo' or dsthost like '%.top' or dsthost like '%.fit' or dsthost like '%.webcam' or dsthost like '%.loan' or dsthost like '%.viajes' or dsthost like '%.email' or dsthost like '%.rest' or dsthost like '%.london') and (srctype='PRIVATE' or whitelist is not null) | duration 1h | select srcip, dsthost, count(*) as cnt | groupby srcip, dsthost | having cnt >= 40

stream=webfilter where url is not null and not user like '%OnPremise%' and user is not null and dsthost is not null and not user like '%noauth%' and not (category like '%SCCM-URL%' or category like 'TCS%' or category like '%Intune_Urls%') and not method like '%NA%' and not (url like '%tcscom%' or url like '%r.manage.microsoft.com:443' or url like '%accesoremoto.bancolombia.com:443' or url like '%tcs%' or url like '%ultimatix%') and (srctype='PRIVATE' or whitelist is not null) | duration 1h | select substr(user,1,(instr(user, "@")-1)) as user, method, dsthost, count(*) as countunique | groupby user, method, dsthost | having countunique >= 8000

stream=webfilter where action='URL_ALLOWED' and not method='NA' and dsthost is not null and user is not null and not (category like '%gINCHNSIR-Talk-Test-Allow%' or category like 'CR_7645343%' or category like 'CR9539464%' or category like 'CR_7737302%' or category like 'CR7939602%' or category like '%Operating%System%and%Software%Updates%' or category like 'VPN_URLs' or category like '%INPUNSAP_Telstra_Urls%' or category like '%gINBLRGLAH-BMO_Allow%' or category like '%CR9894769_URLs%' or category like '%Fresco_Videos_Whitelisting%' or category like 'None_Not_Notify%' or category like 'Crowdstrike_URLs%' or category like '%Exemption%URLs%' or category like 'Citrix_Allow%' or category like 'CR7504540_4374303_allow%' or category like '%Windows_Microsoft_URLs%' or category like '%SCCM-URL%' or category like 'TCS%' or category like '%Intune_Urls%') or contentcategory='CR%') and not user regexp('[a-zA-Z]') and not (user like '%tcscom%' or user like '%r.manage.microsoft.com:443%' or user like '%accesoremoto.bancolombia.com:443%') and not (dsthost like '%tcs%' or dsthost like '%ultimatix%') and not (user like 'noauth-bypassurl$@4897005.zscalerthree.net' or user like 'noauth-protocol$@4897005.zscalerthree.net' or user like 'noauth-useragent$@4897005.zscalerthree.net' or user like 'noauth-misc$@4897005.zscalerthree.net' or user like 'noauth-unknownkrbuser$@4897005.zscalerthree.net') and (srctype='PRIVATE' or whitelist is not null) and not dstip='2.20.92.6' | duration 1h | select substr(user,1,(length(user)-instr(user, "@")-1)) as user,dsthost,count(*) as countunique | groupby user, dsthost | having countunique >= 500

stream=webfilter where action='URL_ALLOWED' and (method like 'PUT' or method like 'POST') and dsthost is not null and user is not null and returncode='200' and (category like 'FileHost%' or category like 'File host%') or contentcategory not like 'CR%' and (srctype='PRIVATE' or whitelist is not null) | duration 1h | select substr(user,1,(instr(user, "@")-1)) as user, dsthost, sum(txlen) as out | groupby user, dsthost | having out > 100000000

stream=webserver where returncode like '2%' and (srctype='PRIVATE' and dsttype='PRIVATE') and ((useragent like '%\%3Cscript\%3E%' or useragent like '%\%3C\%2Fscript\%3E%' or useragent like '%<%>%' or useragent like '%</%>%') or (url like '%\%3D\%3B%' or url like '%\%3D\%27%' or url like '%\%3D\%00%' or url like '%\%3D^\n%' or url like '%\%3Cscript\%3E%' or url like '%\%3C\%2Fscript\%3E%' or url like '%<%>%' or url like '%</%>%') or (httpreferer like '%\%3D\%3B%' or httpreferer like '%\%3D\%27%' or httpreferer like '%\%3D\%00%' or httpreferer like '%\%3D^\n%' or httpreferer like '%\%3Cscript\%3E%' or httpreferer like '%\%3C\%2Fscript\%3E%' or httpreferer like '%<%>%' or httpreferer like '%</%>%')) and not (lower(url) regexp ('(.png|.json|.jsf|.png|.jpg|.bmp|.js|.gif|.css|.svg|.html)(?![a-zA-z\-\/\.\_\?\&\|])')) and not (lower(httpreferer) regexp ('(.png|.json|.jsf|.png|.jpg|.bmp|.js|.gif|.css|.svg|.html)(?![a-zA-z\-\/\.\_\?\&\|])')) | duration 1h | select srcip, count(*) as countunique | groupby srcip | having countunique>=10

stream=webserver where threattype='Malicious' and returncode like '2%' and indicatortype is not null and url is not null AND action!='REQUEST_DENIED' and indicator!='None' | select system, indicator, distinct_count(url) as countunique | groupby indicator, system | having countunique>1

stream=webserver where returncode like '2%' and (srctype='PUBLIC' and dsttype='PRIVATE') and (( httpreferer like '%../%' or httpreferer like '%..\%2f%' or httpreferer like '%\%2e\%2e\%2f%' or httpreferer like '%\%25\%2e\%25\%2e\%25\%5c%') or ( url like '%../%' or url like '%..\%2f%' or url like '%\%2e\%2e\%2f%' or url like '%\%25\%2e\%25\%2e\%25\%5c%')) and not (lower(url) regexp('(.png|.json|.jsf|.png|.jpg|.bmp|.js|.gif|.css|.svg|.html)(?![a-zA-z\-\/\.\_\?\&\|])')) and not (lower(httpreferer) regexp('(.png|.json|.jsf|.png|.jpg|.bmp|.js|.gif|.css|.svg|.html)(?![a-zA-z\-\/\.\_\?\&\|])')) | duration 1h | select srcip, count(*) as countunique | groupby srcip | having countunique>=20

stream=webserver where (srctype='PUBLIC' and dsttype='PRIVATE') and action='REQUEST_DENIED' and whitelist is not null and httpreferer not in ('-', 'None', '"-"') and srcip not in ('::1', '-') and user not in ('None','-','0#.w|ultimatix\\sakmsp_srchdca') |  duration 15m | select srcip, count(*) as countunique, distinct_count(user) as distinctuser, count(distinct(httpreferer)) as distinctref | groupby srcip | having distinctuser>3 and distinctref>1 and countunique>3000

stream=threat where sourcename='CISCO-WLC' and threat!='VENDOR_PLD_VALIDATE_ERR' | duration 1h | select duser, system, threat, count(*) as CountUnique | groupby duser, system, threat | having CountUnique>=5 

stream=webserver where returncode='2%' and srctype='PRIVATE' and dsttype='PRIVATE' and url like '%shell%' and not (url like '%/shell/%' or url like '%/shellError.js%' or url like '%shell_%') | duratrion 1h | select srcip, count(*) as countunique | groupby srcip | having countunique>=5

stream=webserver where (srctype='PUBLIC' and dsttype='PRIVATE') and action='REQUEST_ALLOWED' and httpreferer not in ('-', '"-"', 'None') and srcip not in ('::1','-') and user not in ('None','-','0#.w|ultimatix\\sakmsp_srchdca') and httpreferer like '%https://ievolve%' | duration 15m | select substr(httpreferer,1,(length(httpreferer)-length(substring_index(httpreferer, "/", -1)))) as HTTPRef, count(*) as countunique, distinct_count(srcip) as distinctsrcip, distinct_count(user) as distinctuser | groupby httpreferer | having (distinctsrcip==1 and distinctuser==1 and countunique>5000) or (distinctsrcip>1 and distinctuser>=1 and countunique>80000)

stream=webserver where (srctype='PRIVATE' and dsttype='PRIVATE') and action='REQUEST_ALLOWED' and httpreferer not in ('-', '"-"', 'None') and srcip not in ('::1','-') and user not in ('None','-','0#.w|ultimatix\\sakmsp_srchdca') and httpreferer like '%https://ievolve%' | duration 15m | select substr(httpreferer,1,(length(httpreferer)-length(substring_index(httpreferer, "/", -1)))) as HTTPReferer, count(*) as countunique, distinct_count(srcip) as distinctsrcip, distinct_count(user) as distinctuser | groupby httpreferer | having (distinctsrcip==1 and distinctuser==1 and countunique>5000) or (distinctsrcip>1 and distinctuser>=1 and countunique>80000)

stream=webserver where (srctype='PUBLIC' and dsttype='PRIVATE') and action='REQUEST_ALLOWED' and httpreferer not in ('-', '""-""', 'None') and srcip not in ('::1', '-') and user not in ( 'None', '-', '0#.w|ultimatix\\sakmsp_srchdca') and not httpreferer like '%www.ultimatix.net/uxportal/uxportalhome.html%' | duration 15m | select SUBSTR(httpreferer,1,(length(httpreferer)-length(SUBSTRING_INDEX(httpreferer, "/", -1)))) as HTTPReferer, count(*) as countunique, distinct_count(srcip) as distinctsrcip, distinct_count(user) as distinctuser | groupby HTTPReferer | having (distinctsrcip==1 and distinctuser==1 and countunique>2000) or (distinctsrcip>1 and distinctuser>=1 and countunique>40000)

stream=webserver where (srctype='PUBLIC' and dsttype='PRIVATE') and whitelist is null and action='REQUEST_ALLOWED' and httpreferer not in ('-', '""-""', 'None') and srcip not in ('::1','-') and user not in ('None','-','0#.w|ultimatix\\sakmsp_srchdca') | duration 15m | select srcip, count(*) as countunique, distinct_count(user) as distinctuser, count(distinct(httpreferer)) as distinctref | groupby srcip | having distinctuser>3 and distinctref>1 and countunique>10000

stream=webserver where (srctype='PUBLIC' and dsttype='PRIVATE') and method='POST' and returncode like '2%' and httpreferer not in ('-', '"-"', 'None') and srcip not in ('::1','-') and user not in ('None','-','0#.w|ultimatix\\sakmsp_srchdca') and httpreferer like '%https://ievolve%' | duration 15m | select substr(httpreferer,1,(length(httpreferer)-length(substring_index(httpreferer, "/", -1)))) as HTTPReferer, count(*) as countunique, distinct_count(srcip) as distinctsrcip, distinct_count(user) as distinctuser | groupby httpreferer | having (distinctsrcip==1 and distinctuser==1 and countunique>5000) or (distinctsrcip>1 and distinctuser>=1 and countunique>80000)

stream=webserver where (lower(url) like lower('%SELECT%') or lower(url) like lower('%INSERT%') or lower(url) like lower('%UNION%') or lower(url) like lower('%CONVERT%') OR lower(url) like lower('%CONCAT%') or lower(url) like lower('%TRUNCATE%') OR lower(url) like lower('%DELETE%') or lower(url) like lower('%EVAL%') or lower(url) like lower('%UPDATE%') or lower(url) like lower('%SLEEP%')) and not $User IN ('-','None','101') and not (lower(url) REGEXP ('(?i)(?:update|select|delete|eval|insert|convert|concat|sleep|union)(?=[0-9a-zA-z\-\/\.\_\?])')) and not (lower(url) REGEXP ('(.png|.json|.jsp|.jsf|.png|.jpg|.bmp|.js|.gif|.css|.svg|.html|.ico)(?![a-zA-z\-\/\.\_\?\&\|])')) and not (lower(url) like '%update' or lower(url) like '%select' or lower(url) like '%insert' or lower(url) like '%delete') and url not like '%searchapi%rest%fetch%' and url not like '%api%search%' and srctype='PUBLIC' and whitelist is null | select srcip, count(*) as CountUnique | groupby srcip | having CountUnique>=1

stream=iam where sourcename='WINDOWS' and eventid='4725' and not rlike(user, "[a-z,A-Z]*") | duration 1h | select dsthost, count(*) as countunique | groupby dsthost | having countunique>10

stream=webserver where (srctype='PRIVATE' and dsttype='PRIVATE') and whitelist is not null and action='REQUEST_ALLOWED' and httpreferer not in ('-', '""-""', 'None') and srcip not in ('::1', '-') and user not in ('None', '-', '0#.w|ultimatix\\sakmsp_srchdca') | duration 15m | select srcip, count(*) as CountUnique, distinct_count(httpreferer) as DistinctHTTPReferer, distinct_count(user) as DistinctUser | groupby srcip | having DistinctHTTPReferer>1 and DistinctUser>3 and CountUnique>20000

stream=webserver | where returncode like '2%' and (srctype='PUBLIC' and dsttype='PRIVATE') and ((useragent like '%\%3Cscript\%3E%' or useragent like '%\%3C\%2Fscript\%3E%' or useragent like '%<%>%' or useragent like '%</%>%') or (url like '%\%3D\%3B%' or url like '%\%3D\%27%' or url like '%\%3D\%00%' or url like '%\%3D^\n%' or url like '%\%3Cscript\%3E%' or url like '%\%3C\%2Fscript\%3E%' or url like '%<%>%' or url like '%</%>%') or (httpreferer like '%\%3D\%3B%' or httpreferer like '%\%3D\%27%' or httpreferer like '%\%3D\%00%' or httpreferer like '%\%3D^\n%' or httpreferer like '%\%3Cscript\%3E%' or httpreferer like '%\%3C\%2Fscript\%3E%' or httpreferer like '%<%>%' or httpreferer like '%</%>%')) | duration 1h | select srcip, count(*) as countunique | groupby srcip | having countunique>=1

stream=threat where sourcename='windows' and eventid in ('4618', '4649', '4618') and categoryoutcome ='/Failure' | duration 1h | select system, srcip, threat, count(*) as CountUnique | groupby system, srcip, threat | having threat countunique>=1

stream=webserver where (lower(useragent) like lower('%SELECT%') or lower(useragent) like lower('%INSERT%') or lower(useragent) like lower('%UNION%') or lower(useragent) like lower('%CONVERT%') or lower(useragent) like lower('%CONCAT%') or lower(useragent) like lower('%TRUNCATE%') or lower(useragent) like lower('%DELETE%') or lower(useragent) like lower('%EVAL%') or lower(useragent) like lower('%UPDATE%') or lower(useragent) like lower('%SLEEP%')) and not user in ('-','None','101') and not (lower(useragent) REGEXP ('(?i)(?:update|select|delete|eval|insert|convert|concat|sleep|union)(?=[0-9a-zA-z\-\/\.\_\?])')) and not (lower(useragent) REGEXP ('(.png|.json|.jsp|.jsf|.png|.jpg|.bmp|.js|.gif|.css|.svg|.html)(?![a-zA-z\-\/\.\_\?\&\|])')) and not (lower(useragent) like '%update' or lower($UserAgent) like '%select' or lower(useragent) like '%insert' or lower(useragent) like '%delete') and srctype='PUBLIC' and whitelist is null | select srcip, useragent, count(*) as CountUnique | groupby srcip, useragent | having CountUnique>=1

stream=webserver where (srctype='PRIVATE' and dsttype='PRIVATE') and method='POST' and returncode like '2%' and httpreferer not in ('-', '""-""', 'None') and srcip not in ('::1', '-') and user not in ('None', '-', '0#.w|ultimatix\\sakmsp_srchdca') | duration 15m | select srcip, count(*) as countunique, distinct_count(user) as distinctuser, count(distinct(httpreferer)) as distinctref | groupby srcip | having distinctuser>3 and distinctref>1 and countunique>20000

stream=webserver where returncode='2%' and srctype='PUBLIC' and dsttype='PRIVATE' and url like '%shell%' and not (url like '%/shell/%' or url like '%/shellError.js%' or url like '%shell_%') | select srcip, count(*) as countunique | groupby srcip | having countunique>1

stream=webserver where (useragent like '%Iceweasel%' or useragent like '%Nikto%' or useragent like '%dirb%' or useragent like '%Wscript%') | select srcip, useragent, count(*) as countunique | groupby srcip, useragent | having countunique>=1

stream=webserver where (srctype='PUBLIC' and dsttype='PRIVATE') and action='REQUEST_DENIED' and httpreferer not in ('-', '""-""', 'None') and srcip not in ('::1','-') and user not in ('None','-','0#.w|ultimatix\\sakmsp_srchdca') | duration 15m | select substr(httpreferer,1,(length(httpreferer)-length(substring_index(httpreferer, "/", -1)))) as HTTPReferer, count(*) as countunique, distinct_count(srcip) as distinctsrcip, distinct_count(user) as distinctuser | groupby httpreferer | having (distinctsrcip==1 and distinctuser==1 and countunique>1000) or (distinctsrcip>1 and distinctuser>=1 and countunique>10000)

stream=threat where sourcename='MOJO' and not threat='Unauthorized Client connection to Authorized AP' and not threat='Mis-configured Authorized AP active' | duration 1h | select deviceaddress, distinct_count(threat) as CountUnique | groupby deviceaddress | having CountUnique>=3

stream=webserver where (srctype='PUBLIC' and dsttype='PRIVATE') and method='POST' and returncode like '2%' and httpreferer not in ('-', '"-"', 'None') and srcip not in ('::1','-') and user not in ('None','-','0#.w|ultimatix\\sakmsp_srchdca') and httpreferer like '%www.ultimatix.net/uxportal/uxportalhome.html%' and httpreferer like '%https://ievolve%' | duration 15m | select substr(httpreferer,1,(length(httpreferer)-length(substring_index(httpreferer, "/", -1)))) as HTTPReferer, count(*) as countunique, distinct_count(srcip) as distinctsrcip, distinct_count(user) as distinctuser | groupby httpreferer | having (distinctsrcip==1 and distinctuser==1 and countunique>2500) or (distinctsrcip>1 and distinctuser>=1 and countunique>20000)

stream=webserver where returncode like '2%' and (srctype='PUBLIC' and dsttype='PRIVATE') and (( httpreferer like '%../%' or httpreferer like '%..\%2f%' or httpreferer like '%\%2e\%2e\%2f%' or httpreferer like '%\%25\%2e\%25\%2e\%25\%5c%') or ( url like '%../%' or url like '%..\%2f%' or url like '%\%2e\%2e\%2f%' or url like '%\%25\%2e\%25\%2e\%25\%5c%')) | duration 1h | select srcip, count(*) as countunique | groupby srcip | having countunique>=1

stream=* where devsrcip in ('10.201.7.73', '10.201.7.81', '10.201.7.82', '10.201.7.83', '10.201.7.74', '10.201.7.84', '10.201.7.85', '10.201.7.86', '10.203.7.73', '10.203.7.81', '10.203.7.83', '10.203.7.74', '10.203.7.84', '10.203.7.85', '10.102.2.81') | duration 1d | groupby devsrcip, sourcename, sourcetype

stream=webserver where action='REQUEST_DENIED' and (srctype='PRIVATE' and dsttype='PRIVATE') and httpreferer not in ('-', '""-""', 'None') and srcip not in ('::1','-') and user not in ('None','-','0#.w|ultimatix\\sakmsp_srchdca') | duration 15m | select substr(httpreferer,1,(length(httpreferer)-length(substring_index(httpreferer, "/", -1)))) as HTTPRef, count(*) as countunique, distinct_count(srcip) as distinctsrcip, distinct_count(user) as distinctuser | groupby httpreferer | having (distinctsrcip==1 and distinctuser==1 and countunique>2000) or (distinctsrcip>1 and distinctuser>=1 and countunique>15000)

stream=webserver where (srctype='PRIVATE' and dsttype='PRIVATE') and method='POST' and action='REQUEST_ALLOWED' and returncode like '2%' and httpreferer not in ('-', '"-"', 'None') and srcip not in ('::1','-') and user not in ('None','-','0#.w|ultimatix\\sakmsp_srchdca') and httpreferer like '%www.ultimatix.net/uxportal/uxportalhome.html%' and httpreferer like '%https://ievolve%' | duration 15m | select substr(httpreferer,1,(length(httpreferer)-length(substring_index(httpreferer, "/", -1)))) as HTTPReferer, count(*) as countunique, distinct_count(srcip) as distinctsrcip, distinct_count(user) as distinctuser | groupby httpreferer | having (distinctsrcip==1 and distinctuser==1 and countunique>1000) or (distinctsrcip>1 and distinctuser>=1 and countunique>35000)

stream=firewall where not action='REQUEST_DENIED' and threattype is not null and indicatortype is null | select srcip, threattype, count(*), distinct_count(srcip) as CountUnique | groupby srcip, threattype | having CountUnique>=1

stream=webserver | where (srctype='PRIVATE' and dsttype='PRIVATE') and action='REQUEST_ALLOWED' and httpreferer not in ('-', '""-""', 'None') and srcip not in ('::1', '-') and user not in ( 'None', '-', '0#.w|ultimatix\\sakmsp_srchdca') and not httpreferer like '%www.ultimatix.net/uxportal/uxportalhome.html%' | duration=15m | select SUBSTR(httpreferer,1,(length(httpreferer)-length(SUBSTRING_INDEX(httpreferer, "/", -1)))) AS HTTPReferer, count(*) as countunique, distinct_count(srcip) as distinctsrcip, distinct_count(user) as distinctuser | groupby HTTPReferer | having (distinctsrcip==1 and distinctuser==1 and countunique>4000) or (distinctsrcip>1 and distinctuser>=1 and countunique>45000)

stream=webserver where (srctype='PRIVATE' and dsttype='PRIVATE') and whitelist is not null and action='REQUEST_DENIED' and httpreferer not in ('-', '""-""', 'None') and srcip not in ('::1','-') and user not in ('None','-','0#.w|ultimatix\\sakmsp_srchdca') | duration 15m | select srcip, count(*) as countunique, distinct_count(user) as distinctuser, count(distinct(httpreferer)) as distinctref | groupby srcip | having distinctuser>3 and distinctref>1 and countunique>3000

stream=webserver where (srctype='PUBLIC' and dsttype='PRIVATE') and action='REQUEST_ALLOWED' and method='POST' and returncode like '2%' and httpreferer not in ('-', '"-"', 'None') and srcip not in ('::1', '-') and user not in ('None', '-', '0#.w|ultimatix\\sakmsp_srchdca') and httpreferer like '%https://ievolve%' | duration 15m | select substr(httpreferer,1,(length(httpreferer)-length(substring_index(httpreferer, "/", -1)))) as HTTPReferer, count(*) as countunique, distinct_count(srcip) as distinctsrcip, distinct_count(user) as distinctuser | groupby httpreferer | having (distinctsrcip==1 and distinctuser==1 and countunique>5000) or (distinctsrcip>1 and distinctuser>=1 and countunique>80000)

stream=webserver where (srctype='PUBLIC' and dsttype='PRIVATE') and whitelist is null and method='POST' and returncode like '2%' and httpreferer not in ('-', '""-""', 'None') and srcip not in ('::1', '-') and user not in ('None', '-', '0#.w|ultimatix\\sakmsp_srchdca') | duration 15m | select srcip, count(*) as countunique, distinct_count(user) as distinctuser, count(distinct(httpreferer)) as distinctref | groupby srcip | having distinctuser>3 and distinctref>1 and countunique>10000

stream=iam where sourcename='WINDOWS' and eventid in ('4723','4724') and not rlike(user,"(a-zA-Z)*") | duration 1h | select round(systemtstamp/86400000+25569,3) as newtimestamp, user, count(*) as CountUnique  | groupby user, newtimestamp | having countunique>=5

stream=authentication where sourcename='WINDOWS' and eventid='4625' and logontype='Network' and status='FAILED' and not rlike(user,"[a-zA-Z]*") and not user='101' and deviceprocessname='advapi' and statussubstart in ('0xC0000064_0xc000006a','0xc000015B','0xc0000072') | select round((systemtstamp/86400000)+25569,3) as newtimestamp, user, count(*) as cnt | groupby newtimestamp, user | having cnt>=10

stream=iam where sourcename='WINDOWS' and eventid='4726' and not rlike(user, "[a-zA-Z]*") | select dsthost, count(*) as countunique | groupby dsthost | having countunique>=10

stream=authentication where sourcename='WINDOWS' and eventid='4625' and logontype='Batch' and status='FAILED' and not rlike(user,"[a-zA-Z]*") | duration 1h | select user, count(*) as countunique |  groupby user | having countunique>10

stream=* where devsrcip in ('10.201.2.4', '10.201.2.20', '10.203.2.4', '10.203.2.20') |  duration 1d | groupby devsrcip, sourcename, sourcetype, @Severity

stream=iam where sourcename='WINDOWS' and eventid='4730' and categoryoutcome='/Success' | duration 1h | select dsthost, distinct_count(domaingroup) as domaingrp, count(*) as CountUnique | groupby dsthost | having domaingrp>=2

stream=iam where sourcename='WINDOWS' and eventid='4740' and rlike(user,"[a-zA-Z]*") | duration 1h | select round((systemtstamp/6400000)+25569,1) as newtimestamp, user, count(*) as countunique | groupby newtimestamp, user | having countunique>3

stream=iam where sourcename='WINDOWS' and eventid='4740' and not rlike(user,"[a-zA-Z]*") | select round((systemtstamp/86400000)+25569,1) as newtimestamp, user, count(*) as countunique | groupby newtimestamp, user | having countunique>10

stream=authentication where sourcename='CISCO-WLC' and action='LOGIN' and status='FAILED' and eventname!='SNMP Authentication failure' | duration 1h | select duser, system, eventname, count(*) as CountUnique | groupby duser, system, eventname | having CountUnique>25

stream=authentication where sourcename='MOJO' and action='LOGIN' and status='FAILED' | duration 1h | select duser, deviceaddress, eventname, count(*) as CountUnique | groupby duser, deviceaddress, eventname | having CountUnique>=5

stream=threat where sourcename='MOJO' | duration 1h | select dstmac, deviceaddress, threat, count(*) as CountUnique | groupby dstmac, deviceaddress, threat | having CountUnique>30

stream=authentication where sourcename='MOJO' and status='FAILED' and action='LOGIN' | duration 1h | select srcip, deviceaddress, distinct_count(duser) as CountUnique | groupby srcip, deviceaddress | having CountUnique>=5

stream=sysmon-process where image like '%schtasks.exe' and commandline like '%/create%/s%' |select distinct_count(system) as dstsystem, commandline, user |  groupby user, commandline, | duration 1h | having dstsystem > 3

stream=iam where action='PASSWORD_CHANGED' and status='PASSED' | select user, distinct_count(targetuser) as dstuser, system | duration 1d | groupby user, system | having dstuser > 2

stream=authentication where action='LOGIN' AND status='PASSED' |  groupby system | duration 1h

stream=signals where detectiontechnique='Brute Force'| groupby suspecthost

stream=system where Severity="HIGH" and (AppService="SMTP" or AppService="Endpoint Email") and LogType="DLP" | duration 1h | groupby SrcUser, DstUser | limit 100

stream=system where ActionTaken="BLOCK" and IPSSeverity="Critical" and IPSSeverity="Major" and AtkClass="Virus" and LogType="IPS" | duration 1h | groupby AtkSign, SrcIP | limit 100

stream=system where LogName='SMOKESCREEN-CEF' and (SubType='conn' or SubType='conn_init') and ChainPhase='Lateral Movement' and AtkThreat like '%windows_admin_share%' | groupby AtkName | limit 100

stream=system where LogName='TREND-MICRO' and EventName='Virus/Malware' | duration 1h | groupby ActionTaken, DstIP, VirusName, FileName |  limit 100

stream=authentication where action='LOGIN' and status='FAILED' and not user like '%SAP%' and user is not null and not user='INVALID' | select user, distinct_count(system) as system_cnt | groupby system, user | having system_cnt>10

stream=authentication where sourcename='GITHUB' and action='LOGIN' and status='PASSED' and countrycode is not null and not countrycode='IN' | select user, distinct_count(countrycode) as cnt | groupby user | having cnt > 1

stream=github where sourcename='GITHUB' and countrycode is not null and not countrycode='IN'

stream=system where LogName='SMOKESCREEN-CEF' and ThreatIds like '%filetheft_open%' | duration 1h | groupby SrcIP | limit 100

stream=system where EventName='Predictive Machine Learning' and LogName='TREND-MICRO' | duration 1h | groupby DstIP, AtkMsg | limit 100

stream=system where ActionTaken="PERMIT" and (IPSSeverity="Critical" or IPSSeverity="Major") and AtkClass="Virus" and LogType="IPS" | groupby AtkSign, SrcIP | limit 100

stream=system where SubSystem='AUTHENTICATION' and Action='LOGIN' | duration 1h | groupby SrcIP, DstIP | limit 100

stream=system where logtype='APT'and devaction='Detection ExD Hit' | duration 1h | groupby dstip | limit 100

stream=system where SubType='conn' and ChainPhase='Lateral Movement' and AtkThreat like '%network_ssh_access%' |  duration 1h | groupby AtkName | limit 100

stream=system where EventName like '%Behavior%' and LogName='TREND-MICRO' | duration 1h | groupby SrcHost, PolicyID | limit 100

stream=system where LogName='SMOKESCREEN-CEF' and ThreatIds like '%windows_powershell_process_start%' | duration 1h | groupby SrcIP | limit 100

stream=* where sourcetype="IPS" and devsrcip in ('10.202.4.20', '10.203.4.20') | duration 1d | groupby devsrcip, pstatus

stream=system where LogName='TREND-MICRO' and EventName='Spyware/Grayware' | duration 1h | groupby VirusName, DstIP, ActionTaken, FileName | limit 100

stream=system where Severity='HIGH' and AppService='Endpoint Email' AND LogType='DLP' | duration 1h | groupby SrcUser, SrcHost, DstUser | limit 100

stream=system where ActionTaken="True" and ThreatCategory="Injections" and LogType="WAF" and ActionTaken="True" | duration 1h | groupby SrcIP | limit 100

stream=* where sourcetype="IPS" and devsrcip in ('10.202.4.20', '10.203.4.20') | duration 1d | groupby devsrcip, sourcename. sourcetype

stream=system where LogName='SMOKESCREEN-CEF' and ThreatIds like '%windows_ntlm_logon_failure%' | duration 1h | groupby SrcIP | limit 100

stream=system where atkclass='Exploits' and actiontaken='BLOCK' and (ipseverity='Critical' or ipseverity='Major') and logtype='IPS' | duration 1h | groupby srcip, atksign | limit 100

stream=system where EventName="CnC Callback" and LogName="TREND-MICRO" | duration 1h | groupby SrcHost, CallbackURL | limit 100

stream=system where NOT (SrcIP='0.0.0.0' or SrcIP like '203.199.247%') and LogType='DDOS' AND (ActionTaken='forward' or ActionTaken='proxy' or ActionTaken='bypass') and Category='Anomalies' | duration=1h | groupby SrcIP | limit 100 

stream=system where LogName='SMOKESCREEN-CEF' and ChainPhase='Lateral Movement' and SubType like '%smb_files%' and AtkThreat like '%smb_file_open%' | duration 1h | groupby AtkName | limit 100

stream=system where ChainPhase="Reconnaissance" and LogName="SMOKESCREEN-CEF" | duration 15m | groupby SrcIP, ScopeID | limit 100

stream=system where (ActionTaken="False" or ActionTaken="True") and ThreatCategory="Injections" and LogType="WAF" | duration 1h | groupby SrcIP | limit 100

stream=system where AtkMsg="DDOS-tcp-zero-seq" and LogType="DDOS" | duration 1h | groupby SrcIP | limit 100

stream=system where LogName='TREND-MICRO' and EventName='EVT_VIRUS_FOUND' | duration 1h | groupby URL, UserID, MalwareName | limit 100

stream=system where EventName="DDL commands - Alert" and LogType="DAM" | duration 1h | groupby DstUser | limit 100

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.58.21' and eventid='706' | groupby config | duration 30d | limit 100 

stream=system where TaxonomyID='16908288' and LogType='IPS' | duration 1h | groupby SrcIP | limit 100

stream=system where logtype='APT' and devaction='Detection IOC Hit' | duration 1h | groupby dstip | limit 100

stream=system where LogName='SMOKESCREEN-CEF' and ChainPhase='Lateral Movement' and SubType like '%rdp%' | duration 1h | groupby AtkName | limit 100

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.60.63' and eventid='706' | groupby config | duration 30d | limit 100 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "cmdkey.*?(list|delete|add)") and user='{SuspectUser}' and system='{TragetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "cmdkey.*?(list|delete|add|pass)") | groupby user, system 

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like "%csc.exe%target:exe%" or commandline like "%csc.exe%code%" or commandline like "%csc.exe%out%") | groupby system, user 

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like "%csc.exe%target:exe%" or commandline like "%csc.exe%code%" or commandline like "%csc.exe%out%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like "%SoftwareMicrosoft%Windows Script%Settings%AmsiEnable%" or commandline like "%CurrentControlSet%Services%Amsi%" or commandline like "%Microsoft%Windows%CurrentVersion%Explorer%ShellServiceObjects%{B3C418EE-30F7-4E66-B436-725E99247AC5}%" or commandline like "%Microsoft%Windows Defender%" or commandline like "%SOFTWARE%Microsoft%AMSI%Providers%{2781761E-28E0-4109-99FE-B9D127C57AFE}%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like "%SoftwareMicrosoft%Windows Script%Settings%AmsiEnable%" or commandline like "%CurrentControlSet%Services%Amsi%" or commandline like "%Microsoft%Windows%CurrentVersion%Explorer%ShellServiceObjects%{B3C418EE-30F7-4E66-B436-725E99247AC5}%" or commandline like "%Microsoft%Windows Defender%" or commandline like "%SOFTWARE%Microsoft%AMSI%Providers%{2781761E-28E0-4109-99FE-B9D127C57AFE}%") | groupby user, system

stream=configuration where sourcename='WINDOWS' and not system='MUMDCAD01.paytmbank.net' and not user='LOCAL SERVICE' AND eid='4616' | duration 1h | groupby user, system | limit 10

stream=system where loglevel='EMERG' and sourcename='ARUBA' | duration 1h | groupby system | limit 10

stream=authentication where user='root' and action='LOGIN' and status='PASSED' and (DevSrcIP='10.100.9.87' or DevSrcIP='10.100.9.89' or DevSrcIP='10.100.9.92' or DevSrcIP='10.100.9.93' or DevSrcIP='10.100.9.94' or DevSrcIP='10.100.175.11' or DevSrcIP='10.100.175.12' or DevSrcIP='10.100.175.13' or DevSrcIP='10.100.175.14' or DevSrcIP='10.100.175.15' or DevSrcIP='10.100.175.17' or DevSrcIP='10.100.175.18' or DevSrcIP='10.100.9.102' or DevSrcIP='10.100.178.16' or DevSrcIP='10.100.178.17') | groupby devsrcip, user | duration 15m | limit 10 

stream=system where loglevel='ALERT' and sourcename='ARUBA' | duration 1h | groupby system | limit 10

stream=auditd where action='FILE_DELETED' and logevent like '%kern.log%' | duration 30m | groupby devsrcip | limit 100

stream=system where action='INT_DOWN' | duration 1h | groupby action, devsrcip, iface | limit 10

stream=threat where sourcename='TREND-MICRO-ENDPOINT' and @cs1='multiple windows audit failure events' and (devsrcip='10.100.199.33' or devsrcip='10.101.199.33') | duration 15m | groupby devsrcip | limit 100

stream=email-gateway where subject like '%Compressed/Archive File%' and (devsrcip='192.168.204.21' or devsrcip='192.168.204.22') | duration 1d | groupby file, subject, devsrcip, system | limit 100

stream=system where sourcename='ARUBA' and daemon='stm' | duration 1h | groupby srcip, daemon, loglevel, macaddress | limit 10

stream=azure where sourcename='ARUBA' and deamon='stm' | duration 15m | groupby devsrcip, daemon, macaddress, system | limit 10

stream=system where status='PASSED' and subsystem='system' and action='RESOURCE_ALERT' and sourcename='FORTIGATE' | duration 1h | groupby system | limit 100

stream=system where action='CRONEXEC' and (devsrcip='10.100.2.28' or devsrcip='10.100.175.25' or devsrcip='10.100.2.23' or devsrcip='10.100.2.26' or devsrcip='10.100.175.27') | duration 1h | groupby action, user, system, devsrcip | limit 100

stream=auditd where action='FILE_DELETED' and logevent like '%secure%' | duration 30m | groupby devsrcip | limit 100

stream=authentication where action='LOGIN' and status='PASSED' | duration 15m | groupby user, devsrcip | limit 10

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz%exe%crypto%certificate%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6 m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz%exe%crypto%certificate%export%') | groupby user,system

stream=threat where sourcename='TREND-MICRO-ENDPOINT' and @cs1='Windows Audit Policy changed' and (devsrcip='10.100.199.33' or devsrcip='10.101.199.33') | duration 15m | groupby devsrcip | limit 100

stream=threat | duration 15m | groupby url, user | limit 100

stream=system where subcategory='system' and status='PASSED' and action='REPORT_DLETD' and subsytem='ADMINISTRATION' and sourcename='FORTIGATE' | duration 1h | groupby devsrcip | limit 100

stream=auditd where action='SERVICE_STARTED' | duration 1h | groupby process, daemon, system | limit 100

stream=* where sourcename='TREND-MICRO-NETWORK' and @cs1='Connection Established from unknown machine' and (devsrcip='10.100.199.33' or devsrcip='10.101.199.33') | duration 15m | groupby devsrcip | limit 100

stream=email-gateway where sourcename='MS-EXCHANGE' and action='EMAIL_TRANSFERRED' and (devsrcip='192.168.204.21' or devsrcip='192.168.204.22') | duration 1d | groupby file, system, devsrcip | limit 100 

stream=webfilter where action='URL_BLOCKED' | duration 15m | groupby srcip, domain | limit 100

stream=email-gateway where not subject like '%clean%' and subject like '%sophos%' and (devsrcip='192.168.204.21' or devsrcip='192.168.204.22') | duration 1d | groupby file, subject, devsrcip, system | limit 100

stream=webfilter | duration 15m | groupby url, user | limit 100

stream=threat where sourcename='TREND-MICRO-ENDPOINT' and @cs1='error' and (devsrcip='10.100.199.33' or devsrcip='10.101.199.33') | duration 15m | groupby devsrcip | limit 100

stream=EMAIL-GATEWAY where sourcename='CISCO-IRONPORT' | duration 1d | groupby @sha256 | limit 100

stream=threat where sourcename='TREND-MICRO-ENDPOINT' and @cs1='memory' and devsrcip='10.100.199.33' | duration 15m | groupby devsrcip, @cs1, @msg | limit 100

stream=EP-REGISTRY where (registrypath like "%SoftwareMicrosoft%Windows Script%Settings%AmsiEnable%" or registrypath like "%CurrentControlSet%Services%Amsi%" or registrypath like "%Microsoft%Windows%CurrentVersion%Explorer%ShellServiceObjects%{B3C418EE-30F7-4E66-B436-725E99247AC5}%" or registrypath like "%Microsoft%Windows Defender%" or registrypath like "%SOFTWARE%Microsoft%AMSI%Providers%{2781761E-28E0-4109-99FE-B9D127C57AFE}%") | groupby user, system

stream=EP-REGISTRY where (registrypath like "%SoftwareMicrosoft%Windows Script%Settings%AmsiEnable%" or registrypath like "%CurrentControlSet%Services%Amsi%" or registrypath like "%Microsoft%Windows%CurrentVersion%Explorer%ShellServiceObjects%{B3C418EE-30F7-4E66-B436-725E99247AC5}%" or registrypath like "%Microsoft%Windows Defender%" or registrypath like "%SOFTWARE%Microsoft%AMSI%Providers%{2781761E-28E0-4109-99FE-B9D127C57AFE}%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=system where action='CRONEXEC' | duration 1h | groupby system, devsrcip, user | limit 10

stream=CONFIGURATION where sourcename='NIX' and action='CONFIGURATION_CHANGED' and deamon='crontab' and config like '%EDIT%' | duration 30m | groupby devsrcip, user | limit 100

stream=threat where sourcename='TREND-MICRO-ENDPOINT' and @cs1='multiple SSHD authentication failure' and devsrcip='10.100.199.33' | duration 15m | groupby srcip | limit 100

stream=email-gateway where not subject like '%attachment%' and subject like '%query%' and (devsrcip='192.168.204.21' or devsrcip='192.168.204.22')  | duration 1d | groupby subject, devsrcip, system | limit 100

stream=auditd where action='FILE_DELETED' and logevent like '%faillog%' | duration 30m | groupby devsrcip | limit 100

stream=EMAIL-GATEWAY where not file='winmail.dat' and sourcename='CISCO-IRONPORT' and logevent like '%.dat%' | duration 1h | groupby file, devsrcip, subject | limit 100

stream=ep-process where lower(commandline) like "%dnsexfiltrator%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where lower(commandline) like "%dnsexfiltrator%" | groupby user, system | duration 1d

stream=IAM where sourcename='WINDOWS' and action='USER_DISABLED' and not user like '$%' | duration 1h | groupby user, devsrcip, system | limit 100

stream=configuration where (devsrcip='10.100.199.33' or devsrcip='10.101.199.33') and config='Anti-Malware Engine Offline' | groupby config, user | limit 100

stream=webfilter where action='URL_ALLWD' and sourcename='FORCEPOINT' and @Severity='HIGH' | duration 15m | groupby domain | limit 100

stream=auditd where action='FILE_DELETED' and logevent like '%auth.log%' | duration 30m | groupby devsrcip | limit 100

stream=auditd where action='FILE_DELETED' and logevent like '%boot.log%' | duration 30m | groupby devsrcip | limit 100

stream=signals where detectionname='Brute Force Access' |  groupby suspecthost

stream=system where errorid='132207' and sourcename='ARUBA' and daemon='authmgr' | duration 1h | groupby devsrcip, daemon, macaddress, system, user | limit 10

stream=auditd where action='FILE_DELETED' and logevent like '%user.log%' | duration 30m | groupby devsrcip | limit 100

stream=EMAIL-GATEWAY where sourcename='CISCO-IRONPORT' and (logevent like '%.exe%' or logevent like '%.zbw%') | duration 1h | groupby file, devsrcip, Subject | limit 100

stream=system where status='PASSED' and action='REPORT_CREATD' and subsystem='ADMINISTRATION' and sourcename='FORTIGATE' | duration 1d | groupby devsrcip | limit 100

stream=system where errorid='132053' and sourcename='ARUBA' and daemon='authmgr' | duration 1h | groupby devsrcip, daemon, macaddress, system | limit 10

stream=threat where devsrcip='10.100.51.73' AND @cs1Severity='high' | duration 15m | groupby srcip | limit 100 

stream=threat where action='THREAT_DETECTED' AND @sourceServiceName='Endpoint LAN' AND threat='Network share Outside the office' AND devsrcip='10.101.76.23' | duration 7d | groupby user, srcip, dstip | limit 100 

stream=authentication where action='LOGIN' and status='FAILED'  | groupby user, srcip | limit 10

stream=authentication where action='LOGIN' and status='FAILED' and srcip='{SuspectHost}'

stream=configuration where sourcetype="NETWORK-OS" |  groupby action 

stream=configuration where sourcetype="NETWORK-OS" and action='{SuspectAction}'

stream=threat where sourcename='FIREEYE' AND action='THREAT_DETECTED' AND logevent like '%|10|%' AND devsrcip in ('10.113.12.99','10.100.6.90','10.110.56.33','10.100.51.105','10.100.51.106') | duration 7d | groupby threat, srcip, dstip | limit 100 

stream=threat where sourcename='FORTIGATE' and action='THREAT_DETECTED' and @severity='"medium"' and @type='"utm"' and @subtype='"ips"' | duration 3h | groupby dstip, srcip, threat | limit 100

stream=iam where sourcename='SLACK' and action='PRIVILEGE_CHANGED' and status='PASSED' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=iam where sourcename='SLACK' and action='PRIVILEGE_CHANGED' and status='PASSED' | groupby user, targetuser

stream=threat where (devsrcip='10.100.199.33' or devsrcip='10.101.199.33') AND threat like 'Reconnaissance%' | duration 1h | groupby srcip | limit 100

stream=threat where sourcename='AKAMAI' AND @AkamaiSiemResponseStatus in ('503', '500', '502', '504', '540', '542', '543', '544', '545', '546', '548', '549', '552', '553', '554', '555', '556', '557', '559', '561', '562') AND devsrcip='10.100.51.22' | duration 15m | groupby srcip, @AkamaiSiemResponseStatus | limit 100

stream=threat where action='THREAT_DETECTED' AND @sourceServiceName='Endpoint Removable Media' | duration 7d | groupby user, srcip, dstip, threat | limit 10

stream=firewall where action='PACKET_ALLOWED' AND proto IN ('TCP','tcp') | groupby srcip, dstip | limit 100

stream=threat where SourceName='AKAMAI' AND logevent like '%TROJAN%' and NOT @cs1 IN (631220,699991,60081871,60014279) and NOT @cs1='631220,950109' and NOT @cs1='699991,950000' and NOT @cs1='699991,IPBLOCK-BURST4-60658' and NOT @cs1='631220,950001,959073,981173' and NOT @AkamaiSiemRuleTags='matching_on_a_path' AND devsrcip='10.100.51.22' AND @act='alert' AND action='THREAT_DETECTED' | duration 15m | groupby srcip, system |  limit 100

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Microsoft%Windows%Defender%Features%TamperProtection%REG_DWORD%d%" | groupby system, user

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Microsoft%Windows%Defender%Features%TamperProtection%REG_DWORD%d%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=threat where sourcename='FORCEPOINT-DLP' AND threat='Confidential Warning' AND @sourceservicename='Endpoint HTTPS' AND devsrcip='10.101.76.23' | duration 7d | groupby user, srcip, file | limit 10 

stream=threat where action='THREAT_DETECTED' AND sourcename='FIREEYE' AND logevent like '%|5|%' AND devsrcip IN ('10.113.12.99','10.100.6.90','10.110.56.33','10.100.51.105','10.100.51.106') AND NOT threat='SIPVicious Security Scanner' | duration 1d | groupby threat, srcip, dstip | limit 100

stream=* where sourcename="TREND-MICRO-DDEI" and not lcase(user) like "%spiuser%" and user='{SyspectUser}'

stream=* where sourcename="TREND-MICRO-DDEI" and not lcase(user) like "%spiuser%" | groupby user, sourcename, sourcetype

stream=threat where sourcename='SMOKESCREEN' and @protocol='icmp' and devsrcip='10.100.51.73' and not (srcip='10.110.56.33' or srcip='10.100.16.26') | duration 15m | groupby @severity, srcip | limit 100

stream=firewall where action='PACKET_ALLOWED' | groupby srcip, srcport, dstip, dstport | limit 100

stream=* where devsrcip in ('10.201.6.104', '10.201.6.105', '10.203.6.102', '10.204.1.101', '10.204.7.102', '10.204.5.102', '10.204.6.102', '10.201.3.70', '10.201.3.71', '10.201.3.72', '10.201.3.73', '10.201.6.101', '10.203.6.101') | duration 1d | groupby devsrcip, sourcename, sourcetype

stream=threat where action='THREAT_DETECTED' AND sourcename='AKAMAI' and NOT @cs1 IN (631220,699991,60081871,60014279) and NOT @cs1='631220,950109' and NOT @cs1='699991,950000' and NOT @cs1='699991,IPBLOCK-BURST4-60658' and NOT @cs1='631220,950001,959073,981173' and logevent like '%SQL_INJECTION%' AND @AkamaiSiemRuleTags='matching_on_a_path' AND devsrcip='10.100.51.22' AND @act='alert' | duration 15m | groupby srcip, system | limit 100

stream=threat where eventname='networkconnectip4' and srctype='PUBLIC' and proto='TCP' and @connectionDirection='1' | duration 1h | groupby srcip | having count_col1>=1

stream=threat where eventname='networkconnectip4' and srctype='PUBLIC' and proto='TCP' and @connectionDirection='1' and srcip='{SuspectHost}'

stream=webfilter where category IN ('Adult Material','Sex','Lingerie and Swimsuit','Adult Content') | duration 24h | groupby domain, user | limit 10 

stream=threat where sourcename='AKAMAI' AND threat='THREAT_DETECTED' AND logevent like '%FILE_INJECTION%' AND @act='alert' | duration 24h | groupby action, system, srcip | limit 100

stream=threat where action='THREAT_DETECTED' and srcip='{SuspectHost}'

stream=threat where action='THREAT_DETECTED'  | duration 1h | select srcip, distinct_count(threat) as threat_count | having threat_count > 100

stream=configuration where eventid='264' and devsrcip='172.16.60.49' | duration 30d | limit 1000

stream=threat where sourcename='FIREEYE' AND action='THREAT_DETECTED' AND logevent like '%|8|%' AND devsrcip in ('10.113.12.99','10.100.6.90','10.110.56.33','10.100.51.105','10.100.51.106') | duration 7d | groupby threat, srcip, dstip | limit 100 

stream=threat where sourcename='AKAMAI' | duration 15m | groupby srcip, system | limit 100

stream=AUTHENTICATION where Action="LOGIN" and sourcename="WINDOWS" and status="PASSED" | duration 1d | groupby user, devsrcip | limit 100

stream=AUTHENTICATION where Action="LOGIN" and sourcename="WINDOWS" and status="PASSED" and user='{SuspectUser}'

stream=signals where suspecthost!='' and not detectionname like '%TEST' | select suspecthost , count_if (detectionname like 'MALICIOUS IP%') as Mal_IP_Count, count_if (detectionname not like 'MALICIOUS IP%') as Other_Alert_Count  | groupby suspecthost | having Mal_IP_Count>0 and Other_Alert_Count>0 | duration 1d

stream=signals where suspecthost='{SuspectHost}' and suspecthost!='' and not detectionname like '%TEST'

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') | groupby user, system | duration 1d

stream=firewall where sourcename='FORTIGATE' and @level='critical' | duration 5m | groupby devsrcip, action | limit 100

stream=threat where devsrcip='10.101.76.23' AND @sourceServiceName='Endpoint Printing' and not file in ('ServletController','ARN','ALM','EPSF','PDF','-n','Microsoft') | duration 7d | groupby action, user, file | limit 100

stream=sysmon-image-load | duration 15m | groupby hash, system | limit 100

stream=webfilter | duration 15m | groupby url, user | limit 100

stream=threat where sourcename='FORTIGATE' and sourcetype='FIREWALL' | duration 1h | groupby devsrcip | limit 100

stream=iam where sourcename='FORTIGATE' and sourcetype='FIREWALL' | duration 1h | groupby devsrcip | limit 100

stream=webfilter where sourcename='FORTIGATE' and sourcetype='FIREWALL' | duration 1h | groupby devsrcip | limit 100

stream=configuration where sourcename='FORTIGATE' and sourcetype='FIREWALL' | duration 1h | groupby devsrcip | limit 100

stream=firewall where sourcename='FORTIGATE' and sourcetype='FIREWALL' | duration 1h | groupby devsrcip | limit 100

stream=authentication where sourcename='FORTIGATE' and sourcetype='FIREWALL' | duration 1h | groupby devsrcip | limit 100

stream=authentication where sourcename='FIREEYE' and (devsrcip='10.100.51.105' or devsrcip='10.100.41.106') | duration 1h | groupby devsrcip | limit 100

stream=threat where sourcename='FIREEYE' and (devsrcip='10.100.51.105' or devsrcip='10.100.41.106') | duration 1h | groupby devsrcip | limit 100

stream=configuration where sourcename='FIREEYE' and (devsrcip='10.100.51.105' or devsrcip='10.100.41.106') | duration 1h | groupby devsrcip | limit 100

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%DoNotConnectToWindowsUpdateInternetLocations%REG_DWORD%d%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%DoNotConnectToWindowsUpdateInternetLocations%REG_DWORD%d%" | groupby user, system

stream=threat where sourcename='SMOKESCREEN' and devsrcip='10.100.51.73' | duration 1h | groupby devsrcip | limit 100

stream=IAM where sourcename='ARUBA-CLEARPASS' and devsrcip='10.113.12.54' | duration 1h | groupby devsrcip | limit 100

stream=configuration where sourcename='ORACLE-AUDIT-VAULT' and devsrcip='10.100.27.24' | duration 1h | groupby devsrcip | limit 100

stream=authentication where sourcename='ORACLE-AUDIT-VAULT' and devsrcip='10.100.27.24' | duration 1h | groupby devsrcip | limit 100

stream=threat | duration 15m | groupby url, user | limit 100

stream=threat where sourcename='CISCO-IRONPORT' and (devsrcip='192.168.204.21' or devsrcip='192.168.204.22') | duration 1h | groupby devsrcip | limit 100

stream=email-gateway where sourcename='CISCO-IRONPORT' and (devsrcip='192.168.204.21' or devsrcip='192.168.204.22') | duration 1h | groupby devsrcip | limit 100

stream=threat where sourcename='AKAMAI' and devsrcip='10.100.51.22' | duration 1h | groupby devsrcip | limit 100

stream=configuration where sourcename='PALOALTO' and sourcetype='FIREWALL' | duration 1h | groupby devsrcip | limit 100

stream=threat where sourcename='PALOALTO' and sourcetype='FIREWALL' | duration 1h | groupby devsrcip | limit 100

stream=authentication where sourcename='PALOALTO' and sourcetype='FIREWALL' | duration 1h | groupby devsrcip | limit 100

stream=firewall where sourcename='PALOALTO' and sourcetype='FIREWALL' | duration 1h | groupby devsrcip | limit 100

stream=webserver where srcip='{SuspectHost}' and (useragent like '%Iceweasel%' or useragent like '%Nikto%' or useragent like '%dirb%' or useragent like '%Wscript%')

stream=webserver where (useragent like '%Iceweasel%' or useragent like '%Nikto%' or useragent like '%dirb%' or useragent like '%Wscript%') | select srcip, useragent,count(*) as countunique | groupby srcip, useragent | having countunique>=1

stream=win-audit where action="OBJECT_ACCESSED" and newprocessname like '%powershell.exe%' and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="OBJECT_ACCESSED" and newprocessname like '%powershell.exe%' and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") | groupby user, system

stream=webfilter where action='URL_ALLOWED' and httpmethod='GET' | select substring(xhour, 9, 10) as HourOfTheDay, user, url, txlen | having txlen > 1000 |  duration 8h

stream=threat where action='THREAT_DETECTED'  | duration 1h | select user, distinct_count(threat) as threat_count | having threat_count > 100

stream=threat where action='THREAT_DETECTED' and user='{SuspectUser}'

stream=cloudtrail where eventname in ('UpdateTrail', 'DeleteTrail', 'StopLogging', 'DeleteFlowLogs', 'DeleteEventBus') and user is not null and eventsource is not null | groupby user, userarn, eventname

stream=* | duration from 2023-02-26T00:00:00 to 2023-02-26T23:59:59 | timeslice 1h

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.60.50' and eventid='706' | groupby config | duration 30d | limit 100 

stream=threat | duration 1d | groupby threat, sourcename

stream=IAM where action='PASSWORD_CHANGED' |  select user,distinct_count(targetuser) as target_cnt |  groupby user, targetuser |  having target_cnt>10

stream=configuration where action='CONFIGURATION_CHANGED' and status='PASSED' and user='{SuspectUser}'

stream=configuration where action='CONFIGURATION_CHANGED' and status='PASSED' | groupby user, config | limit 10

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.86' and eventid='706' | groupby config | duration 30d | limit 100 

stream=authentication where sourcename='GITHUB' and action='user.login' | duration 5m | select user, distinct_count(user) as user_cnt | groupby user | having user_cnt > 10

stream=authentication where sourcename='GITHUB' and user='{SuspectUser}'

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.60.51' and eventid='706' | groupby config | duration 30d | limit 100 

stream=threat where sourcename="IMPERVA-WAF" and threat="SQL Correlation Policy" and user='{SuspectUser}'

stream=threat where sourcename="IMPERVA-WAF" and threat="SQL Correlation Policy" | groupby user 

stream=IAM where action='PASSWORD_CHANGED' and not targetuser like '%iraje%' and not targetuser like '%Health%' |  duration 3h |  groupby targetuser, user | having count_col1>1

stream=awsflowlog where srctype='PRIVATE' and dsttype='PUBLIC' and dstport in ('25','587') |  select packetsrcip, packetdstip, count(*) | groupby packetdstip, packetsrcip

stream=FIREWALL where  sourcetype='FIREWALL' and ViolationField='SOURCE' and Action='PACKET_ALLOWED' and Intel='True' | groupby SrcIP | limit 100 

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.60.52' and eventid='706' | groupby config | duration 30d | limit 100 

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.145' and eventid='706' | groupby config | duration 30d | limit 100 

stream=* where srcip='{SuspectHost}'

stream=* | groupby srcip | duration 1h

stream=threat where sourcename="TREND-MICRO-ENDPOINT" and threat='CnC Callback' and @shost='{SuspectHost}'

stream=threat where sourcename="TREND-MICRO-ENDPOINT" and eventname="CNC Callback" |  duration 1m | groupby srchost | limit 10

stream=authentication where sourcename="NIX" and user="root" and action="LOGIN" and status="FAILED"  and srcip='{SuspectHost}'

stream=authentication where sourcename="NIX" and user="root" and action="LOGIN" and status="FAILED" | groupby srcip, devsrcip |  limit 10

stream=* | duration 6h | timeslice 1h

stream=gsuite where sourcename='G-SUITE' and Role='mobile' and @name='FAILED_PASSWORD_ATTEMPTS_EVENT' and @parameters.FAILED_PASSWD_ATTEMPTS >='10' | duration 1h | groupby user | having count_col1 >=1

stream=gsuite where sourcename='G-SUITE' and Role='mobile' and @name='FAILED_PASSWORD_ATTEMPTS_EVENT' and @parameters.FAILED_PASSWD_ATTEMPTS >='10' and user='{SuspectUser}'

stream=THREAT where sourcename="FIREEYE" and threat="IOC Hit Found" and dstip='{TargetHost}'

stream=THREAT where sourcename="FIREEYE" and threat="IOC Hit Found" | groupby dstip, process | limit 10

stream=threat where sourcename="IMPERVA-WAF" and threat="Grant Command Execution - Alert" | groupby user 

stream=threat where sourcename="IMPERVA-WAF" and threat="Grant Command Execution - Alert" and user='{SuspectUser}'

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.61' and eventid='706' | groupby config | duration 30d | limit 100 

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.58.25' and eventid='706' | groupby config | duration 30d | limit 100 

stream=FIREWALL where  sourcetype='FIREWALL' and ViolationField='DESTINATION' and Action='PACKET_ALLOWED' and Intel='True' | groupby dstip | limit 100 

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.60.68' and eventid='706' | groupby config | duration 30d | limit 100 

stream=authentication where action="LOGOUT" and sourcename="WINDOWS" and @EventID="4634" | duration 1d | groupby user, devsrcip

stream=webfilter where sourcename='FORTIGATE' and sourcetype='FIREWALL' and action='URL_BLOCKED' |  groupby srcip, url | limit 4 

stream=authentication | limit 1

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.99' and eventid='706' | groupby config | duration 30d | limit 100 

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.108' and eventid='706' | groupby config | duration 30d | limit 100 

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.60.105' and eventid='706' | groupby config | duration 30d | limit 100 

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.60.66' and eventid='706' | groupby config | duration 30d | limit 100 

stream=iam where sourcename='SLACK' and action='USER_ADDED' and status='PASSED' and not user like '%net-mon%' | groupby user, targetuser

stream=iam where sourcename='SLACK' and action='USER_ADDED' and status='PASSED' and not user like '%net-mon%' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.58.22' and eventid='706' | groupby config | duration 30d | limit 100 

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.57' and eventid='706' | groupby config | duration 30d | limit 100 

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.102' and eventid='706' | groupby config | duration 30d | limit 100 

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.50' and eventid='706' | groupby config | duration 30d | limit 100 

stream=cloudtrail where eventsource="sts.amazonaws.com" and eventname="GetSessionToken" and usergroup="IAMUser" | groupby user, userarn

stream=cloudtrail where eventsource="sts.amazonaws.com" and eventname="GetSessionToken" and usergroup="IAMUser" and username='{SuspectUser}'

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.60.60' and eventid='706' | groupby config | duration 30d | limit 100 

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.58.24' and eventid='706' | groupby config | duration 30d | limit 100 

stream=cloudtrail  where eventsource="s3.amazonaws.com" and eventname in ("PutBucketLogging", "PutBucketWebsite", "PutEncryptionConfiguration", "PutLifecycleConfiguration", "PutReplicationConfiguration", "ReplicateObject", "RestoreObject") and username='{SuspectUser}'

stream=cloudtrail  where eventsource="s3.amazonaws.com" and eventname in ("PutBucketLogging", "PutBucketWebsite", "PutEncryptionConfiguration", "PutLifecycleConfiguration", "PutReplicationConfiguration", "ReplicateObject", "RestoreObject") | groupby eventname, user, userarn

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.91' and eventid='706' | groupby config | duration 30d | limit 100 

stream=cloudtrail where eventsource="ec2.amazonaws.com" and @requestParameters.attribute="userData" and eventname="DescribeInstanceAttribute" and username='{SuspectUser}'

stream=cloudtrail  where eventsource="ec2.amazonaws.com" and @requestParameters.attribute="userData" and eventname="DescribeInstanceAttribute" | select count(*) as count_col, user, userarn | groupby user, userarn | having count_col > 10 | duration 30m

stream=authentication where action='LOGIN' and status='PASSED' and system!='raigad.netmonastery.network'  |  select user, system, distinct_count(srcip) as CountSrcIP, employee_name | groupby user, system, employee_name  |  having CountSrcIP>3

stream=cloudtrail where eventSource='lambda.amazonaws.com' and eventname like 'UpdateFunctionConfiguration%' and username='{SuspectUser}'

stream=cloudtrail where eventSource='lambda.amazonaws.com' and eventname like 'UpdateFunctionConfiguration%' | groupby user, userarn

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.77' and eventid='706' | groupby config | duration 30d | limit 100 

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.109' and eventid='706' | groupby config | duration 30d | limit 100 

stream=cloudtrail where eventsource="securityhub.amazonaws.com" and eventname in ("BatchUpdateFindings", "DeleteInsight", "UpdateFindings", "UpdateInsight") | groupby eventname, user, userarn

stream=cloudtrail where eventsource="securityhub.amazonaws.com" and eventname in ("BatchUpdateFindings", "DeleteInsight", "UpdateFindings", "UpdateInsight") and username='{SuspectUser}'

stream=threat where action="THREAT_BLOCKED" and sourcetype="IPS" and severity in ( "Major", "Critical") and atkclass="Virus" and srcip='{SuspectHost}'

stream=threat where action="THREAT_BLOCKED" and sourcetype="IPS" and severity in ( "Major", "Critical") and atkclass="Virus" | groupby threat, srcip

stream=awsflowlog where srctype='PRIVATE' and dsttype='PUBLIC' and direction='egress' and txlen>200000 and instanceid!='-' and not packetdstawsservice in ('AMAZON', 'AMAZON_APPFLOW', 'AMAZON_CONNECT', 'API_GATEWAY', 'CHIME_MEETINGS', 'CHIME_VOICECONNECTOR', 'CLOUD9', 'CLOUDFRONT', 'CLOUDFRONT_ORIGIN_FACING', 'CODEBUILD', 'DYNAMODB', 'EBS', 'EC2', 'EC2_INSTANCE_CONNECT', 'GLOBALACCELERATOR', 'KINESIS_VIDEO_STREAMS', 'ROUTE53', 'ROUTE53_HEALTHCHECKS', 'ROUTE53_HEALTHCHECKS_PUBLISHING', 'ROUTE53_RESOLVER', 'S3', 'WORKSPACES_GATEWAYS') | select packetsrcip, dstport, packetdstip, count(*) as cnt|  groupby packetsrcip, dstport, packetdstip |  having cnt>10

stream=cloudtrail where eventname like "list%" | select count(*) as count_col, eventname, user, userarn | groupby eventname, user, userarn  | duration 10m

stream=cloudtrail where eventname like "list%" and username='{SuspectUser}' 

stream=slack where sourcename='SLACK' and actiontaken='idp_configuration_added' and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=slack where sourcename='SLACK' and actiontaken='idp_configuration_added' |  groupby user, srcip

stream=awsflowlog where proto='TCP' and srctype='PRIVATE' and dsttype='PUBLIC' and dstport in ('20','21') and not packetdstawsservice in ('AMAZON', 'AMAZON_APPFLOW', 'AMAZON_CONNECT', 'API_GATEWAY', 'CHIME_MEETINGS', 'CHIME_VOICECONNECTOR', 'CLOUD9', 'CLOUDFRONT', 'CLOUDFRONT_ORIGIN_FACING', 'CODEBUILD', 'DYNAMODB', 'EBS', 'EC2', 'EC2_INSTANCE_CONNECT', 'GLOBALACCELERATOR', 'KINESIS_VIDEO_STREAMS', 'ROUTE53', 'ROUTE53_HEALTHCHECKS', 'ROUTE53_HEALTHCHECKS_PUBLISHING', 'ROUTE53_RESOLVER', 'S3', 'WORKSPACES_GATEWAYS') | groupby packetsrcip, packetdstip | limit 100

stream=cloudtrail where eventsource="elasticache.amazonaws.com" and eventname IN ("DeleteCacheSecurityGroup", "AuthorizeCacheSecurityGroupIngress", "RevokeCacheSecurityGroupIngress", "AuthorizeCacheSecurityGroupEgress", "RevokeCacheSecurityGroupEgress") | groupby eventname, user, userarn

stream=cloudtrail where eventsource="elasticache.amazonaws.com" and eventname IN ("DeleteCacheSecurityGroup", "AuthorizeCacheSecurityGroupIngress", "RevokeCacheSecurityGroupIngress", "AuthorizeCacheSecurityGroupEgress", "RevokeCacheSecurityGroupEgress") and username='{SuspectUser}'

stream=cloudtrail where eventsource="config.amazonaws.com" and eventname IN ("DeleteDeliveryChannel", "StopConfigurationRecorder") | groupby user, userarn

stream=cloudtrail where eventsource="config.amazonaws.com" and eventname IN ("DeleteDeliveryChannel", "StopConfigurationRecorder") and username='{SuspectUser}'

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.49' and eventid='706' | groupby config | duration 30d | limit 100 

stream=configuration where action="CONFIGURATION_CHANGED" and sourcename="CHECKPOINT-FIREWALL" | duration 1d | groupby devsrcip, config, srcip

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like '%get-wmiobject%win32_pnpentity%' | groupby user, system 

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like '%get-wmiobject%win32_pnpentity%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=cloudtrail where eventname IN ("ArchiveFindings", "CreateFindingsFilter", "DeleteMember", "DisassociateFromMasterAccount", "DisassociateMember", "DisableMacie", "DisableOrganizationAdminAccount", "UpdateFindingsFilter", "UpdateMacieSession", "UpdateMemberSession", "UpdateClassificationJob") | select userarn, user, count(*) as count_col | groupby userarn, user | having count_col > 5 | duration 10m

stream=cloudtrail where eventname IN ("ArchiveFindings", "CreateFindingsFilter", "DeleteMember", "DisassociateFromMasterAccount", "DisassociateMember", "DisableMacie", "DisableOrganizationAdminAccount", "UpdateFindingsFilter", "UpdateMacieSession", "UpdateMemberSession", "UpdateClassificationJob") and username='{SuspectUser}'

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(parentcommandline), 'netsh\s+interface\s+portproxy\s+add\s+v4tov4' or rlike(lower(parentcommandline), 'new-netfirewallrule.*-protocol\s+tcp\s+-localport.*-action\s+allow' or rlike(lower(parentcommandline), 'add-netnatstaticmapping.*-protocol\s+tcp.*-externalport.*-internalport') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(parentcommandline), 'netsh\s+interface\s+portproxy\s+add\s+v4tov4' or rlike(lower(parentcommandline), 'new-netfirewallrule.*-protocol\s+tcp\s+-localport.*-action\s+allow' or rlike(lower(parentcommandline), 'add-netnatstaticmapping.*-protocol\s+tcp.*-externalport.*-internalport') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll')) and user='{SuspectUser}' and system='{TargetHost}' 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll')) | duration 15m |  groupby user, system, commandline 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll')) and user='{SuspectUser}' and system='{TargetHost}' 6m

stream=cloudtrail where eventsource="route53.amazonaws.com" and eventname="DisableDomainTransferLock" and username='{SuspectUser}'

stream=cloudtrail where eventsource="route53.amazonaws.com" and eventname="DisableDomainTransferLock" | groupby user, userarn


stream=cloudtrail  where eventsource='elasticache.amazonaws.com' and eventname='CreateCacheSecurityGroup' and username='{SuspectUser}'

stream=cloudtrail  where eventsource='elasticache.amazonaws.com' and eventname='CreateCacheSecurityGroup' | groupby user, userarn

stream=iam where sourcename='G-SUITE' and action='USER_ADDED' and status='PASSED' and role='groups_enterprise' and @type='moderator_action' and @name='ban_user_with_moderation' and user='{SuspectUser}'

stream=iam where sourcename='G-SUITE' and action='USER_ADDED' and status='PASSED' and role='groups_enterprise' and @type='moderator_action' and @name='ban_user_with_moderation' | duration 1h | groupby user | having count_col1 >=1

stream=cloudtrail where eventsource="elasticfilesystem.amazonaws.com" and eventname="DeleteFileSystem" | groupby user, userarn

stream=cloudtrail where eventsource="elasticfilesystem.amazonaws.com" and eventname="DeleteFileSystem" and username='{SuspectUser}'

stream=awsflowlog where srctype='PRIVATE' and dsttype='PUBLIC' and action='PACKET_ALLOWED' and dstport='3389' |  select packetsrcip, count(packetdstip) as countpacketdstip | groupby packetsrcip, packetdstip

stream=threat where sourcename="SMOKESCREEN" and @cs1SubType="conn" or @cs1SubType="conn_init" and threat="Lateral Movement" and atkthreat like "%network_vnc_access%" and @cs1AttackerName='{SuspectHost}'

stream=threat where sourcename="SMOKESCREEN" and @cs1SubType="conn" or @cs1SubType="conn_init" and threat="Lateral Movement" and atkthreat like "%network_vnc_access%" | groupby @cs1AttackerName

stream=IAM where action='USER_CREATED' and sourcename="NIX" | duration 1d | groupby devsrcip, hostname, action, user

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.80' and eventid='706' | groupby config | duration 30d | limit 100 

stream=IAM where action="PASSWORD_CHANGED" and sourcename="WINDOWS" | duration 1d | groupby devsrcip, user, targetuser, Category

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.55' and eventid='706' | groupby config | duration 30d | limit 100 

stream=cloudtrail where eventname='GetCallerIdentity' and usergroup='AssumedRole' | groupby user, userarn

stream=cloudtrail where eventname='GetCallerIdentity' and usergroup='AssumedRole' and username='{$SuspectUser}'

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.76' and eventid='706' | groupby config | duration 30d | limit 100 

stream=* where devsrcip in ('10.201.2.148', '10.203.2.148', '10.201.7.132', '10.203.7.132') | duration 1d | groupby devsrcip, pstatus

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline,"mimikatz.*?(sid::add|sid::patch|sid::lookup||sekurlsa::logonpasswords|token::whoami)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|sid\\:\\:patch|sid\\:\\:lookup|sekurlsa::logonpasswords|token::whoami)")  | groupby user, system

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.58.23' and eventid='706' | groupby config | duration 30d | limit 100 

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.107' and eventid='706' | groupby config | duration 30d | limit 100 

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.60.69' and eventid='706' | groupby config | duration 30d | limit 100 

stream=CONFIGURATION where sourcetype='CLOUD-SECURITY' and sourcename='TREND-MICRO' and devsrcip='172.16.57.104' and eventid='706' | groupby config | duration 3d | limit 100 

stream=cloudtrail where eventSource="elasticfilesystem.amazonaws.com" and eventname="DeleteMountTarget" | groupby user, userarn

stream=cloudtrail where eventSource="elasticfilesystem.amazonaws.com" and eventname="DeleteMountTarget" and username='{SuspectUser}'

stream=* where devsrcip in ('10.201.6.21', '10.201.6.22', '10.201.2.84', '10.203.6.20', '10.203.2.84', '10.204.1.20', '10.202.0.244', '10.202.0.245') | duration 1d | groupby devsrcip, pstatus

stream=* where devsrcip in ('10.201.7.102', '10.201.7.103', '10.203.7.103') |  duration 1d | groupby devsrcip, sourcename, sourcetype

stream=* where srcip in ('192.168.0.152', '192.168.71.152' )| duration 7d | groupby srcip | limit 10

stream=IAM where action="USER_ADDED" and sourcename="WINDOWS" and @EventID="4732" | duration 1d | groupby devsrcip, user, group 

stream=cloudtrail where eventsource="ec2.amazonaws.com" and @requestParameters.attribute="userData" and eventname="ModifyInstanceAttribute" | groupby eventname, user, userarn 


stream=cloudtrail where eventsource="ec2.amazonaws.com" and @requestParameters.attribute="userData" and eventname="ModifyInstanceAttribute" and username='{SuspectUser}'

stream=* where devsrcip in ('10.201.6.21', '10.201.6.22', '10.201.2.84', '10.203.6.20', '10.203.2.84', '10.204.1.20', '10.202.0.244', '10.202.0.245') | duration 1d | groupby devsrcip, sourcename, sourcetype, loglevel

stream=cloudtrail where eventsource='eks.amazonaws.com' and eventname IN ('CreateCluster', 'DeleteCluster') and username='{SuspectUser}'

stream=cloudtrail where eventsource='eks.amazonaws.com' and eventname IN ('CreateCluster', 'DeleteCluster') |  groupby user, userarn

stream=cloudtrail where eventsource="ec2.amazonaws.com" and eventname="DisableEbsEncryptionByDefault" and username='{SuspectUser}'

stream=cloudtrail where eventsource="ec2.amazonaws.com" and eventname="DisableEbsEncryptionByDefault" | groupby user, userarn

stream=sysmon-process where action='PROCESS_ADDED' and eid='1' and parentimage like '%powershell.exe' commandline like ('%schtasks%Create%SC %ONLOGON%TN %Updater%TR %powershell%' or commandline like '%schtasks%Create%SC %DAILY%TN %Updater%TR %powershell%' or commandline like  '%schtasks%Create%SC %ONIDLE%TN %Updater%TR %powershell%' or commandline like  '%schtasks%Create%SC %Updater%TN %Updater%TR %powershell%') | duration 1h |  select system, parentimage, commandline |  groupby system, parentimage, commandline |  limit 100

stream=IAM where  action="USER_LOCKOUT" | duration 1d | groupby devsrcip, sourcename, user, targetuser, category

stream=* where devsrcip in ('10.201.7.180', '10.201.7.164', '10.201.2.228', '10.203.7.180', '10.203.7.164', '10.203.2.228') | duration 1d | groupby devsrcip, sourcename

stream=IAM where action='USER_CREATED' and sourcename="WINDOWS" | duration 1d | groupby devsrcip, hostname, action, user

stream=IAM where action='USER_REMOVED' and sourcename="WINDOWS" | duration 1d | groupby hostname, action, user

stream=authentication where not user="SPIUSER3" | duration 1d | groupby devsrcip, user, action, status | limit 10000

stream=awsflowlog where proto='TCP' and dstport in ('1080','3128','8080') and srctype='PRIVATE' and not dsttype='PRIVATE' and not packetdstawsservice in ('AMAZON', 'AMAZON_APPFLOW', 'AMAZON_CONNECT', 'API_GATEWAY', 'CHIME_MEETINGS', 'CHIME_VOICECONNECTOR', 'CLOUD9', 'CLOUDFRONT', 'CLOUDFRONT_ORIGIN_FACING', 'CODEBUILD', 'DYNAMODB', 'EBS', 'EC2', 'EC2_INSTANCE_CONNECT', 'GLOBALACCELERATOR', 'KINESIS_VIDEO_STREAMS', 'ROUTE53', 'ROUTE53_HEALTHCHECKS', 'ROUTE53_HEALTHCHECKS_PUBLISHING', 'ROUTE53_RESOLVER', 'S3', 'WORKSPACES_GATEWAYS') | groupby packetsrcip, packetdstip | limit 10

stream=awsflowlog where proto='TCP' and action='PACKET_ALLOWED' and dstport='1723' and status='PASSED' and instanceid!='-' and not packetdstawsservice in ('AMAZON', 'AMAZON_APPFLOW', 'AMAZON_CONNECT', 'API_GATEWAY', 'CHIME_MEETINGS', 'CHIME_VOICECONNECTOR', 'CLOUD9', 'CLOUDFRONT', 'CLOUDFRONT_ORIGIN_FACING', 'CODEBUILD', 'DYNAMODB', 'EBS', 'EC2', 'EC2_INSTANCE_CONNECT', 'GLOBALACCELERATOR', 'KINESIS_VIDEO_STREAMS', 'ROUTE53', 'ROUTE53_HEALTHCHECKS', 'ROUTE53_HEALTHCHECKS_PUBLISHING', 'ROUTE53_RESOLVER', 'S3', 'WORKSPACES_GATEWAYS')
|  groupby packetsrcip, packetdstip| limit 100

stream=github where sourcename='GITHUB' | duration 20m | select user, distinct_count(action) as action_cnt | groupby user | having action_cnt > 2

stream=github where sourcename='GITHUB' and user='{SuspectUser}'

stream=cloudtrail where eventsource='lambda.amazonaws.com' and (eventname like "%CreateFunction%" or eventname like "%Invoke%") | groupby user, userarn | duration 10m

stream=cloudtrail  where eventsource="cloudtrail.amazonaws.com" and eventname IN ("StopLogging", "UpdateTrail", "DeleteTrail") | groupby user, userarn

stream=cloudtrail where eventsource="cloudtrail.amazonaws.com" and eventname IN ("StopLogging", "UpdateTrail", "DeleteTrail") and username='{SuspectUser}'

stream=other where sourcetype="FIREWALL" and logevent like '%-500003%' and devsrcip='{SuspectHost}'

stream=other where sourcetype="FIREWALL" and logevent like '%-500003%' | groupby devsrcip

stream=auditd where action='FILE_CREATED' and commandline='/etc/doas.conf' and system='{TargetHost}'

stream=auditd where action='FILE_CREATED' and commandline='/etc/doas.conf' | select system, commandline | groupby system, commandline

stream=sysmon-file where action='FILE_DELETED' and (image like '%dns.exe') and not (targetfilename like '%dns.log') | select image, system | groupby image, system

stream=sysmon-file where action='FILE_DELETED' and (image like '%dns.exe') and not (targetfilename like '%dns.log') and system='{TargetHost}'

stream=authentication | duration 5m | select "vsys1" as vsys, "host3" as HostID, "serial1" as SerialNo, "test1" as Source, cnamtime as time | limit 1

stream=cloudtrail where eventname in ('UpdateTrail', 'DeleteTrail', 'StopLogging', 'DeleteFlowLogs', 'DeleteEventBus') and user is not null and eventsource is not null | groupby user, userarn, eventname

stream=cloudtrail where eventname in ('UpdateTrail', 'DeleteTrail', 'StopLogging', 'DeleteFlowLogs', 'DeleteEventBus') and user is not null and eventsource is not null and username='{SuspectUser}'

stream=configuration where action="CONFIGURATION_CHANGED" and sourcetype="FIREWALL" and devsrcip='{SuspectHost}'

stream=configuration where action="CONFIGURATION_CHANGED" and sourcetype="FIREWALL" | groupby devsrcip, config 

stream=firewall where action="PACKET_BLOCKED" and sourcename="FORTIGATE" | groupby srcip, action 

stream=* where devsrcip="10.21.171.61" and sourcename="CHECKPOINT-FIREWALL" | duration 1d | groupby devsrcip, sourcename, sourcetype, srcip

stream=gcp where MethodName='io.k8s.core.v1.pods.exec.create' and not ResourceName='null' | select  principal, @protoPayload.resourceName as namespace, @protoPayload.resource.labels.project_id as projectid | groupby principal, @protoPayload.resourceName, @protoPayload.resource.labels.project_id | duration 1h

stream=gcp where MethodName='io.k8s.core.v1.pods.exec.create' and not ResourceName='null' and principal='{SuspectUser}'

stream=configuration where action="CONFIGURATION_CHANGED" and sourcetype="NETWORK-OS" |  duration 1d | groupby sourcename, devsrcip, srcip, action

stream=* where devsrcip="10.201.2.196" | duration 1d | groupby devsrcip, sourcename, sourcetype

stream=* where devsrcip in ('10.201.7.100', '10.201.7.101', '10.203.7.101', '10.201.7.108') | duration 1d | groupby devsrcip, sourcename, sourcetype

stream=* | duration 12h | select distinct(devsrcip) as UniqueDevSrcIP

stream=auditd where action='FILE_CREATED' and (commandline like '/etc/ld.so.conf.d/%' or commandline like '/etc/cron.d/%' or commandline like '/etc/sudoers.d/%' or commandline like '/etc/rc.d/init.d/%' or commandline like '/etc/systemd/system/%' ) and not (process like '%/dpkg' or process like '%/yum' or process like '%/apt' or process like '%/dnf' or process like '%/systemd' or process like '%/snapd' or process like '%/dnf-automatic' or process like '%/yum-cron' or process like '%/elastic-agent' or process like '%/dnfdaemon-system') and system='{TargetHost}'

stream=auditd where action='FILE_CREATED' and (commandline like '/etc/ld.so.conf.d/%' or commandline like '/etc/cron.d/%' or commandline like '/etc/sudoers.d/%' or commandline like '/etc/rc.d/init.d/%' or commandline like '/etc/systemd/system/%' ) and not (process like '%/dpkg' or process like '%/yum' or process like '%/apt' or process like '%/dnf' or process like '%/systemd' or process like '%/snapd' or process like '%/dnf-automatic' or process like '%/yum-cron' or process like '%/elastic-agent' or process like '%/dnfdaemon-system') | select commandline, system | groupby commandline, system

stream=authentication where action="LOGIN" and status="FAILED" and sourcename="FORTIGATE" and @action="ssl-login-fail" | duration 1d | groupby srcip, user, @action, reason

stream=authentication where  sourcename='G-SUITE' AND action='LOGIN' AND reason='INVALID_CREDENTIALS'  | duration 5m | groupby srcip, system | select srcip, system, count_if(status=='FAILED') as failcount, count_if(status=='PASSED') as passcount | having failcount >= 10 and failcount >= passcount * 1 | limit 100

stream=authentication where sourcename="ARCOS-DBEVT" and action="LOGIN" and status="FAILED" and reason="INVALID_CREDENTAILS" | groupby user

stream=THREAT where sourcename="SMOKESCREEN" and ThreatParseID="reconnassiance_honeypotbuster" | groupby srcip | limit 10

stream=auditd where action='FILE_DELETED' and (commandline like '/var/run/utmp' or commandline like '/var/log/wtmp' or commandline like '/var/log/btmp' or commandline like '/var/log/lastlog' or commandline like '/var/log/faillog' or commandline like '/var/log/syslog' or commandline like '/var/log/messages' or commandline like '/var/log/secure' or commandline like '/var/log/auth.log' or commandline like '/var/log/kern.log' or commandline like '/var/log/boot.log' or commandline like '/var/log/kern.log') and not (process like '%gzip%') and system='{TargetHost}'

stream=auditd where action='FILE_DELETED' and (commandline like '/var/run/utmp' or commandline like '/var/log/wtmp' or commandline like '/var/log/btmp' or commandline like '/var/log/lastlog' or commandline like '/var/log/faillog' or commandline like '/var/log/syslog' or commandline like '/var/log/messages' or commandline like '/var/log/secure' or commandline like '/var/log/auth.log' or commandline like '/var/log/kern.log' or commandline like '/var/log/boot.log' or commandline like '/var/log/kern.log') and not (process like '%gzip%') | select commandline, system | groupby commandline, system

Stream=IAM and action='FILE_DELETED' and status='PASSED' SubSystem='ADMINISTRATION' | groupby action, message, devsrcip |  duration 24h | limit 100

stream=* where devsrcip in ('10.201.2.4', '10.201.2.20', '10.203.2.4', '10.203.2.20') |  duration 1d | groupby devsrcip, pstatus

stream=threat where action="THREAT_DETECTED" and sourcetype="IPS" and AtkClass="Reconnaissance" | groupby srcip, threat

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and operation like 'REST.%.OBJECT' and @ciphersuite is null and @tlsVersion is null and @remoteip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and operation like 'REST.%.OBJECT' and @ciphersuite is null and @tlsVersion is null | duration 12h | groupby @remoteip | having count_col1 >=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and eventname in ('ChangePassword','CreateAccessKey','CreateLoginProfile','CreateUser') and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and  eventname in ('ChangePassword','CreateAccessKey','CreateLoginProfile','CreateUser')  | duration 1h | groupby srcip | having count_col1>=1

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') | groupby user, system | duration 1d

stream=threat where sourcename="TREND-MICRO-ENDPOINT" and action="THREAT_DETECTED" and eventname="Virus/Malware" | groupby dstip, action | limit 10

stream=Threat where sourcename="TREND-MICRO-ENDPOINT" and action="THREAT_DETECTED" and eventname='Virus/Malware' and dstip='{TargetHost}'

stream=threat where sourcename="RADWARE" and IsPassive="True" and threatcategory="Injections" | groupby srcip

stream=threat where sourcename="RADWARE" and IsPassive="True" and @Threatcategory="Injections" and srcip='{SuspectHost}'

stream=system where LogType='DDOS' and Category='Intrusions' | duration 1h | groupby SrcIP | limit 100

Stream=IAM and sourcetype='FIREWALL' and action='SCHEDULE_TASK_UPDATED' | groupby message, system | duration 24h | limit 10

stream=authentication where action="LOGIN" and status="PASSED" and sourcename="FORTIGATE" and devsrcip="10.52.4.1" and @reason="login successfully" | duration 1d | groupby srcip, user, authproto

stream=IAM where action="USER_REMOVED" and sourcename="WINDOWS" and @EventID="4733" | duration 1d | groupby devsrcip, user, group 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll')) and user='{SuspectUser}' and system='{TargetHost}' 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll')) | duration 15m |  groupby user, system, commandline 

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='DisassociateWebACL' | duration 1h | groupby user | having count_col1 >=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='DisassociateWebACL' and user='{SuspectUser}'

stream=configuration where action="CONFIGURATION_CHANGED" and sourcetype="WAF" |  duration 1d | groupby sourcename, devsrcip, srcip, action

stream=AUTHENTICATION where action="LOGIN" and status="FAILED" and devsrcip in ('10.21.11.13', '10.21.171.14', '10.41.177.14', '10.31.171.13') |  duration 1d | groupby devsrcip, srcip, user, reason

stream=* where devsrcip in ('10.201.7.73', '10.201.7.81', '10.201.7.82', '10.201.7.83', '10.201.7.74', '10.201.7.84', '10.201.7.85', '10.201.7.86', '10.203.7.73', '10.203.7.81', '10.203.7.83', '10.203.7.74', '10.203.7.84', '10.203.7.85', '10.102.2.81') | duration 1d | groupby devsrcip, pstatus

stream=authentication where not user in ('NOCNMSUSER', 'NOCNMS', 'nocnmsuser', 'nocnmuser', "null") and not srcip in ('10.201.2.38', '10.201.2.37') and sourcename='NIX' | duration 1d | groupby user, devsrcip, srcip, action , status

stream=configuration where action="CONFIGURATION_CHANGED" and sourcetype="DATABASE" |  duration 1d | groupby devsrcip, sourcename, config

stream=configuration where action="CONFIGURATION_CHANGED" and sourcename="FORTIGATE" | duration 1d | groupby sourcename, devsrcip, action, user

stream=iam where sourcename='GITHUB' and action in ('USER_ADDED','MEMBER_INVITED') |  duration 2h | select user, count(action) |  groupby  user 

stream=authentication where not srcip like '10.%' | duration 1d | groupby sourcetype, devsrcip, srcip, user

stream=* where devsrcip in ('10.201.7.180', '10.201.7.164', '10.201.2.228', '10.203.7.180', '10.203.7.164', '10.203.2.228') | duration 1d | groupby devsrcip, pstatus

stream=authentication where action="LOGIN" and sourcename="CHECKPOINT-FIREWALL" and @product="Connectra" and logevent like '%vpn%' | duration 1d | groupby srcip, user, action, status

stream=win-audit where action="POLICY_CHANGED" | duration 1d | groupby devsrcip, user

stream=* where devsrcip in ('10.201.6.104', '10.201.6.105', '10.203.6.102', '10.204.1.101', '10.204.7.102', '10.204.5.102', '10.204.6.102', '10.201.3.70', '10.201.3.71', '10.201.3.72', '10.201.3.73', '10.201.6.101', '10.203.6.101') | duration 1d | groupby devsrcip, pstatus

stream=* where sourcename='ARRAY-OS' and sourcetype='LOADBALANCER' | duration 7d | groupby subsystem 

stream=CONFIGURATION where sourcename='FORTIGATE' and action='CONFIG_ERASD' and ActionTaken='Rename' | duration 24h | groupby user, srcip, message

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and eventname in ('PutBucketAcl','PutBucketPolicy','PutBucketCors','DeleteBucketPolicy','DeleteBucketCors') and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and  eventname in ('PutBucketAcl','PutBucketPolicy','PutBucketCors','DeleteBucketPolicy','DeleteBucketCors') | duration 1h | groupby srcip | having count_col1>=1

stream=authentication where action in ('LOGIN','VPN_CONNECTED') |  groupby srcip, user 

stream=threat where action="THREAT_DETECTED" and sourcetype="IPS" and severity in ( "Major", "Critical") and atkclass="Virus" | groupby threat, srcip

stream=threat where action="THREAT_DETECTED" and sourcetype="IPS" and severity in ( "Major", "Critical") and atkclass="Virus" and srcip='{SuspectHost}'

stream=authentication where devsrcip in ('10.52.4.1','10.52.22.34','10.52.0.27','10.42.4.1','10.42.22.81','10.42.0.27','10.61.176.2','10.31.176.2','10.71.103.254','10.72.103.254','10.73.103.254','10.74.103.254','10.75.103.254','10.76.103.254','10.77.103.254','10.78.103.254','10.79.103.254','10.80.103.254','10.81.103.254','10.82.103.254','10.83.103.254','10.84.103.254','10.85.103.254','10.86.103.254','10.52.0.10','10.52.0.11','10.42.0.10','122.15.216.97','61.246.216.33','122.15.216.98','122.15.216.99','10.21.171.61','172.16.14.242','172.16.14.243','10.41.120.4','10.11.168.52','10.87.103.254','10.89.103.254','10.124.244.186','10.124.247.166','10.124.249.142','10.124.247.162','10.124.239.214','10.126.11.66','10.124.240.2','10.126.7.150','10.126.8.34','10.77.172.14','10.124.248.114','10.124.241.130','10.77.157.62','10.124.242.138','10.124.1.58','10.124.241.134','10.77.41.218','10.124.250.250','10.124.249.94','10.124.251.110','10.77.157.86','10.126.10.42','10.124.239.218','10.126.9.106','10.124.245.10','10.126.6.126','10.126.14.246','10.124.239.254','10.124.254.86','10.77.206.198','10.77.212.38','10.77.152.62','14.142.63.254','14.141.187.210','14.143.51.230','14.143.51.242','14.143.85.2','59.160.146.126','219.65.107.58','14.142.162.70','115.112.45.106','14.143.55.10','14.141.29.142','219.65.102.102','219.65.102.90','14.143.194.22','14.140.209.126','14.143.55.150','14.142.181.246','59.162.20.21','10.201.7.36','10.201.7.37','10.203.7.36','10.202.2.36','10.204.1.36','10.201.6.21','10.201.6.22','10.201.2.84','10.203.6.20','10.203.2.84','10.204.1.20','10.202.0.244','10.202.0.245','10.201.4.4','10.201.4.5','10.202.4.4','10.202.4.5','10.203.4.4','10.203.4.5','10.203.4.20','10.202.4.20','10.201.6.148','10.201.6.4','10.201.7.72','10.201.0.101','10.201.0.100','10.204.1.4','10.204.1.71','10.204.0.100','10.203.6.4','10.203.7.72','10.203.0.100') and srcip like '10.%' | duration 1d | groupby sourcetype, devsrcip, srcip, user

stream=IAM where action="USER_REMOVED" and sourcename="WINDOWS" and @EventID="4729" | duration 1d | groupby devsrcip, user, group 

stream=email-gateway where action="EMAIL_DELIVERED" and severity in ('high', 'Medium') |  select distinct_count(file) as file_cnt, sender | groupby file, sender | having file_cnt > 1

stream=github where sourcename='GITHUB' and action in ('LABEL_CREATED', 'REPOSITORY_CREATED', 'ORGANISATION_CREATED') |  duration 2h |  select user, count(action)  | groupby user 

stream=github where sourcename='GITHUB' and action in ('LABEL_CREATED', 'REPOSITORY_CREATED', 'ORGANISATION_CREATED') and user='{SuspectUser}'

stream=threat where sourcetype="IPS" and action="THREAT_BLOCKED" and logevent like "Reconnaissance" and srcip="{SuspectHost}"

stream=threat where sourcetype="IPS" and action="THREAT_BLOCKED" and logevent like "Reconnaissance" | select srcip, count(srcip) as srcipcnt | groupby srcip | having srcipcnt > 3

stream=configuration where sourcename='NIX' and action='SHUTDOWN' and subsystem='SYSTEM' AND status='PASSED' | duration 24h | groupby devsrcip, system |  limit 100

stream=IAM where action="USER_ADDED" and sourcename="WINDOWS" and @EventID="4728" | duration 1d | groupby devsrcip, user, group 

stream=github where sourcename='GITHUB' | duration 2h | select user, distinct_count(action) as action_cnt | groupby user | having action_cnt > 2

stream=github where sourcename='GITHUB' and action in ('LABEL_CREATED', 'REPOSITORY_CREATED', 'ORGANISATION_CREATED') |  duration 2h |  select user, count(action)  | groupby user 

stream=webserver where not srccn='-' and sourcename='ARRAY-OS' and sourcetype='LOADBALANCER' | Duration 7d | groupby srccn | limit 100

stream=webserver where sourcename='ARRAY-OS' and sourcetype='LOADBALANCER' | duration 7d | groupby srcip | limit 10

stream=iam where sourcename='GITHUB' and action in ('USER_ADDED','MEMBER_INVITED') |  duration 5m | select user, count(action) as cnt  | groupby user | having cnt > 100

stream=iam where sourcename='GITHUB' and action in ('USER_ADDED','MEMBER_INVITED') and user='{SuspectUser}'

stream=SYSMON-REGISTRY where action='OBJECT_MODIFIED' and status='PASSED' and user='{SuspectUser}' and targetobject='{TargetResource}' and system='{TargetHost}'

stream=webserver where sourcename='ARRAY-OS' and sourcetype='LOADBALANCER' | duration 7d | groupby httpmethod | limit 100

stream=webserver where sourcename='ARRAY-OS' and sourcetype='LOADBALANCER' | duration 7d | groupby action, user | limit 100

stream=AUTHENTICATION where action='VPN_CONNECTED' | duration 24h | groupby srcip | limit 100

stream=* where sourcename='ARRAY-OS' and sourcetype='LOADBALANCER' | duration 7d |  groupby action, user

stream=* where sourcename='ARRAY-OS' and sourcetype='LOADBALANCER' | duration 7d |  groupby action, user, commandline

stream=*  | duration 1h | groupby devsrcip

stream=configuration where sourcename='NIX' and action='REBOOT' and subsystem='SYSTEM' AND status='PASSED' | duration 24h | groupby devsrcip, system |  limit 100

stream=FIREWALL where action='BTNT_BLKD' and status='FAILED' and sourcename='FORTIGATE' and LogID='1501054601' | duration 24h | groupby srcip

stream=CONFIGURATION where sourcename='FORTIGATE' and action='CONFIG_ERASD' | duration 24h | groupby actiontaken 

stream=WEBFILTER where category="Malicious Websites" | groupby srcip

stream=WEBFILTER where category="Malicious Websites" and srcip='{SuspectHost}'

stream=gsuite where sourcename='G-SUITE' and @id.applicationName='access_transparency' and @type='GSUITE_RESOURCE' | duration 1h | groupby user | having count_col1 >=1

stream=gsuite where sourcename='G-SUITE' and @id.applicationName='access_transparency' and @type='GSUITE_RESOURCE' and user='{SuspectUser}'

stream=firewall where sourcename='FORTIGATE' and dstport in ('9001','9030','9031','9051','9150','9151') and actiontaken in ('allow','accept') and srccn='-' and not dstcn in ('-','IN') and srcip='{SuspectHost}'

stream=firewall where sourcename='FORTIGATE' and dstport in ('9001','9030','9031','9051','9150','9151') and actiontaken in ('allow','accept') and srccn='-' and not dstcn in ('-','IN') | groupby srcip

stream=webserver where sourcename="APACHE2" and returncode like "5%" |  groupby devsrcip, returncode, srcip

stream=authentication where sourcetype="ENDPOINT-SECURITY" and not lcase(user) like "%spiuser%" | groupby user, sourcetype, sourcetype

stream=firewall and action="PACKET_ALLOWED" and sourcetype="FIREWALL" and not srcip like "10.%" | groupby sourcename, srcip

stream=Threat where sourcename="TREND-MICRO-ENDPOINT" and threat='Spyware Detected' | groupby dstip, action | limit 10

stream=Threat where sourcename="TREND-MICRO-ENDPOINT" and threat='Spyware Detected' and dstip='{TargetHost}'

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('netsh.exe','cmd.exe','powershell.exe') and (commandline like '%advfirewall firewall set rule group=%remote desktop%new enable=Yes%' or commandline like '%advfirewall firewall set rule group=%file and printer sharing%new enable=Yes%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('netsh.exe','cmd.exe','powershell.exe') and (commandline like '%advfirewall firewall set rule group=%remote desktop%new enable=Yes%' or commandline like '%advfirewall firewall set rule group=%file and printer sharing%new enable=Yes%') | groupby user, system

stream=win-audit where action='POLICY_CHANGED' AND logevent like '%A token right was adjusted%' and not user like '%$%' | duration 7d | groupby user, system | limit 100 

stream=authentication where eid="4625" and action="LOGIN"and status="FAILED" and @LogonType="3" | groupby devsrcip, logontype

stream=authentication where action='2FA_TOKEN_MODIFIED' and status='PASSED' and eventtype in ('user.mfa.factor.deactivate', 'user.mfa.factor.suspend') and not @displayMessage='Reset factor for user' and not @outcome.result='SUCCESS' | duration 15m | groupby user | having count_col1>=1

stream=authentication where action='2FA_TOKEN_MODIFIED' and status='PASSED' and eventtype in ('user.mfa.factor.deactivate', 'user.mfa.factor.suspend') and not @displayMessage='Reset factor for user' and not @outcome.result='SUCCESS' and user='{SuspectUser}'

stream=threat where sourcename='FORTIGATE' AND action='THREAT_DETECTED' AND @severity='"critical"' AND @type='"utm"' AND @subtype='"ips"' | duration 1d | groupby dstip, srcip, threat |  limit 100

stream=firewall | duration 5m | groupby devsrcip, action | limit 100

stream=webfilter where action='URL_ALLOWED' AND category='Uncategorized' and not domain in ('https://paytm-bank.myfreshworks.com','https://paytm-bank.freshconnect.io','https://assets1.freshconnect.io') | duration 1h | groupby domain, srcip | limit 100

stream=threat where sourcename='AKAMAI' AND @AkamaiSiemResponseStatus in ('503', '500', '502', '504', '540', '542', '543', '544', '545', '546', '548', '549', '552', '553', '554', '555', '556', '557', '559', '561', '562') AND devsrcip='10.100.51.22' | duration 15m | groupby srcip, @AkamaiSiemResponseStatus | limit 100

Stream=threat | duration 7d | groupby user, srcip, dstip | limit 10

stream=threat where sourcename='AKAMAI' AND logevent like '%JAVA_INJECTION%' and not @cs1 IN (631220,699991,60081871,60014279) and not @cs1='631220,950109' and not @cs1='699991,950000' and not @cs1='699991,IPBLOCK-BURST4-60658' and not @cs1='631220,950001,959073,981173' and not @AkamaiSiemRuleTags='matching_on_a_path' AND devsrcip='10.100.51.22' AND @act='alert' AND action='THREAT_DETECTED' | duration 15m | groupby srcip, system | limit 100

stream=threat where action='THREAT_DETECTED' AND sourcename='FIREEYE' AND logevent like '%|9|%' AND devsrcip IN ('10.113.12.99','10.100.6.90','10.110.56.33','10.100.51.105','10.100.51.106') | duration 1d | groupby threat, srcip, dstip | limit 100

stream=iam where sourcename='WINDOWS' AND sourcetype='OS' AND action IN ('USER_ADDED', 'USER_REMOVED', 'GROUP_CHANGED') and not user='ldap_idam_prod' | groupby action, devsrcip, user | limit 100

stream=WEBSERVER where sourcetype='WEBSERVER' | duration 1h | groupby devsrcip | limit 10

stream=webfilter where category in ('Suspicious Embedded Link','Advanced Malware Command and Control','Advanced Malware Payloads','Compromised Websites','Custom-Encrypted Uploads','Files Containing Passwords','Keyloggers','Malicious Embedded Link','Malicious Embedded iFrame','Malicious Websites','Mobile Malware','Phishing and Other Frauds','Potentially Exploited Documents','Potentially Unwanted Software','Spyware','Unauthorized Mobile Marketplaces') | duration 10m | groupby srcip, domain, user |  limit 100

stream=threat where sourcename='FORTIGATE' and action='THREAT_DETECTED' and @severity='"low"' and @type='"utm"' and @subtype='"ips"' | duration 1d |  groupby dstip, srcip, threat | limit 100 


stream=threat where sourcename='FORTIGATE' and action='THREAT_DETECTED' AND @severity='"high"' AND @type='"utm"' AND @subtype='"ips"' and not devsrcip='10.110.56.33' | duration 1d | groupby dstip, srcip, threat | limit 100 

stream=iam | duration 15m | groupby targetuser, user | limit 10

stream=threat where sourcename='AKAMAI' AND logevent like '%META_CHARS%' and NOT @cs1 IN (631220,699991,60081871,60014279) and NOT @cs1='631220,950109' and NOT @cs1='699991,950000' and NOT @cs1='699991,IPBLOCK-BURST4-60658' and NOT  @cs1='631220,950001,959073,981173' and NOT @AkamaiSiemRuleTags='matching_on_a_path' AND devsrcip='10.100.51.22' AND @act='alert' AND action='THREAT_DETECTED' | duration 15m | groupby srcip, system | limit 100

stream=threat where sourcename='AKAMAI' and NOT system='upisecure.paytmbank.com' and NOT threat='Matching on /Paytm_UPI/upi/' and NOT (srcip like '%192.168.*%' or srcip like '%10.17*%' or srcip='172.17.23.23' ) and not devsrcip='10.100.51.22' AND @requestMethod='POST' | duration 15m | groupby srcip | limit 100

stream=win-audit where action='DIRECTORY_SERVICE_ACCESSED' AND status='PASSED' AND eid IN ('5137','5138','5139','5141') | duration 12h | groupby devsrcip, user, system | limit 100

stream=threat where action='THREAT_DETECTED' AND sourcename='FIREEYE' AND logevent like '%|7|%' AND devsrcip IN ('10.113.12.99','10.100.6.90','10.110.56.33','10.100.51.105','10.100.51.106') AND NOT threat='SIPVicious Security Scanner' | duration 1d | groupby threat, srcip, dstip | limit 100

stream=threat where action='THREAT_DETECTED' AND sourcename='FIREEYE' AND logevent like '%|6|%' AND devsrcip IN ('10.113.12.99','10.100.6.90','10.110.56.33','10.100.51.105','10.100.51.106') AND NOT threat='SIPVicious Security Scanner' | duration 15d | groupby threat, srcip, dstip | limit 100

stream=threat where sourcename='AKAMAI' and not system='upisecure.paytmbank.com' and not threat='Matching on /Paytm_UPI/upi/' and not (srcip like '%10.*%' or srcip like '%192.168.*%' or srcip like '%172.17.*%') and NOT devsrcip='10.100.51.22' AND @requestMethod='GET' | groupby srcip | limit 100

stream=okta where eventype='system.api_token.create' and @outcome.result='SUCCESS' | duration 1h | groupby user | having count_col1 >=1

stream=okta where eventype='system.api_token.create' and outcome.result='SUCCESS' and user='{SuspectUser}'

stream=webserver where Method="POST" and action="REQUEST_ALLOWED" and ReturnCode="200" and srcip='{SuspectHost}'

stream=webserver where Method="POST" and action="REQUEST_ALLOWED" and ReturnCode="200" | duration 10m | groupby srcip

stream=threat where sourcename='SMOKESCREEN' and not @protocol='icmp' and devsrcip='10.100.51.73' and not (srcip='10.110.56.33' or srcip='10.100.16.26') | duration 15m | groupby @severity, srcip | limit 100

stream=authentication where action='LOGIN' and user='root' and sourcename='NIX' | duration 15m | groupby user, action, srcip, system, devsrcip | limit 10

stream=AUTHENTICATION where sourcename='MS-O365' and action='2FA_TOKEN_MODIFIED' and status='PASSED' and @Operation='Update' and @ModifiedProperties.Name='StrongAuthenticationMethod' and user='{SuspectUser}'

stream=AUTHENTICATION where sourcename='MS-O365' and action='2FA_TOKEN_MODIFIED' and status='PASSED' and @Operation='Update' and @ModifiedProperties.Name='StrongAuthenticationMethod' | duration 1h | groupby user | having count_col1 >=1

stream=authentication where eid="4625" and action="LOGIN"and status="FAILED" and @LogonType="3" | duration 15m | groupby devsrcip, @LogonType

stream=authentication where eid="4625" and action="LOGIN"and status="FAILED" and @LogonType="3" and devsrcip='{SuspectHost}'

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%mshta.exe%http%' or lower(commandline) like '%mshta.exe%https%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%mshta.exe%http%' or lower(commandline) like '%mshta.exe%https%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and ((lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-signing%' or lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-decrypting%' or lower(commandline) like '%import%module%aadinternals%export%aadintadfscertificates%' or lower(commandline) like '%import%module%activedirectory%import-module%aadinternals%export-aadintadfsconfiguration%export-aadintadfsencryptionkey%export-aadintadfscertificates -configuration%-key%')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and ((lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-signing%' or lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-decrypting%' or lower(commandline) like '%import%module%aadinternals%export%aadintadfscertificates%' or lower(commandline) like '%import%module%activedirectory%import-module%aadinternals%export-aadintadfsconfiguration%export-aadintadfsencryptionkey%export-aadintadfscertificates -configuration%-key%')) | groupby user, system

stream=firewall where sourcename='FORTIGATE' and dstport in ('23','3389') and actiontaken in ('allow','accept') and not srccn in ('-','IN') and srctype='PUBLIC' and srcip='{SuspectHost}'

stream=firewall where sourcename='FORTIGATE' and dstport in ('23','3389') and actiontaken in ('allow','accept') and not srccn in ('-','IN') and srctype='PUBLIC' | groupby srcip

stream=authentication where  sourcename='G-SUITE' AND action='LOGIN' AND reason='INVALID_CREDENTIALS'  | duration 5m | groupby srcip, system | select srcip, system, count_if(status=='FAILED') as failcount, count_if(status=='PASSED') as passcount | having failcount >= 10 and failcount >= passcount * 1 | limit 100

stream=SIGNALS |  groupby targethost 

stream=cloudtrail | groupby userarn | limit 5

stream=authentication where action='LOGIN'

stream=authentication | duration 1d | select user, distinct_count(srccn) as srccn_cnt, user |  groupby user | having srccn_cnt > 2

stream=firewall where action='PACKET_ALLOWED' | groupby srcip | limit 10

stream=firewall where intelreference='GREENSNOW'

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%mpcmdrun%-removedefinitions%" or rlike(lower(commandline),"(del|remove).*?programdata.*?microsoft.*?windows.*?defender.*?defination.*?update")) | groupby user, system, commandline 

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%mpcmdrun%-removedefinitions%" or rlike(lower(commandline),"(del|remove).*?programdata.*?microsoft.*?windows.*?defender.*?defination.*?update")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=DOCUMENTS where sourcename='G-SUITE' AND action='EDITED' | duration 1d | limit 100

stream=win-audit where sourcename='WINDOWS' and action='PROCESS_CREATED' and status='PASSED' and eid='4688' | groupby user, @NewProcessName

stream=IAM where action='PRIVILEGE_CHANGED' and status='PASSED' and role='Special Logon' | duration 1h | groupby user, targetuser

stream=IAM where action='PRIVILEGE_CHANGED' and status='PASSED' and role='Special Logon' and targetuser='{TargetUser}' and user='{SuspectUser}'

stream=gsuite where sourcename='G-SUITE' and name='CHANGE_DEVICE_STATE' and app='admin' and type='CHROME_OS_SETTINGS' | duration 60m | groupby user | having count_col1>=1 

stream=gsuite where sourcename='G-SUITE' and name='CHANGE_DEVICE_STATE' and app='admin' and type='CHROME_OS_SETTINGS' and user='{SuspectUser}'

stream=gsuite where sourcename='G-SUITE' and app='login' and type='account_warning' and name='account_disabled_password_leak' | duration 1h | groupby user | having count_col1 >=1

stream=gsuite where sourcename='G-SUITE' and app='login' and type='account_warning' and name='account_disabled_password_leak' and user='{SuspectUser}'

stream=* |  groupby stream, sourcename |  duration 15m

stream=gsuite where sourcename='G-SUITE' and app='rules' and @parameters.severity='MEDIUM' and user='{SuspectUser}'

stream=gsuite where sourcename='G-SUITE' and app='rules' and @parameters.severity='MEDIUM' | duration 1h | groupby user | having count_col1 >=1

stream=* and srcip='{SuspectHost}'

stream=* | duration 1h | groupby srcip | having count_col1>=1

stream=github where sourcename='GITHUB' and actiontaken='protected_branch.destroy' and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken='protected_branch.destroy' | groupby user 

stream=github where sourcename='GITHUB' and actiontaken='hook.destroy' and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken='hook.destroy' |  groupby user

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%mshta.exe%http%' or lower(commandline) like '%mshta.exe%https%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%mshta.exe%http%' or lower(commandline) like '%mshta.exe%https%') | groupby user, system

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' nd eventsource='iam.amazonaws.com' and eventname='UpdateLoginProfile' | duration 1h | groupby userarn, @requestParameters.userName as username | having count_col1 >=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' nd eventsource='iam.amazonaws.com' and eventname='UpdateLoginProfile' and username='{SuspectUser}'

stream=slack where sourcename='SLACK' and actiontaken in ('idp_configuration_added','idp_configuration_deleted','idp_prod_configuration_updated') |  groupby user, targetworkspace, srcip

stream=slack where sourcename='SLACK' and actiontaken in ('idp_configuration_added','idp_configuration_deleted','idp_prod_configuration_updated') and targetworkspace='{TargetResource}' and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=win-audit where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('PutDeliveryChannel','PutConfigurationRecorder','StartConfigurationRecorder') | duration 1h | groupby srcip | having count_col1>=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('PutDeliveryChannel','PutConfigurationRecorder','StartConfigurationRecorder') and srcip='{SuspectHost}'

stream=authentication where system in ('DELL', 'ACER') | duration 5d | limit 3

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | groupby user, system

stream=win-audit where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=win-audit where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") and user='{SuspectUser}' and host='{SuspectHost}' | duration 6m

stream=iam where action='USER_DELETED' and user='{SuspectUser}' | duration 7d | limit 1000

stream=win-audit where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=win-audit where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") and user='{SuspectUser}' and host='{SuspectHost}' | duration 6m

stream=win-audit where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") and user='{SuspectUser}' and host='{SuspectHost}' | duration 6m

stream=ep-process where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=cloudtrail where eventsource="ecs.amazonaws.com" and eventname IN ("DescribeTaskDefinition", "RegisterTaskDefinition", "RunTask") and @requestParameters.containerDefinitions.command like "%169.254%" and @requestParameters.containerDefinitions.command like "%$AWS_CONTAINER_CREDENTIALS%"

stream=cloudtrail where userarn like '%{SuspectUser}' | duration 1h

stream=cloudtrail | groupby user, userarn | duration 1h

stream=authentication where sourcename='MS-O365' | groupby @ExtendedProperties[0].Value as useragent, @UserId as userid, status

stream=authentication where sourcename='NIX' and action='LOGIN' and status='FAILED' and user='root' |  groupby user, system

stream=cloudtrail where userarn like '%{SuspectUser}'

stream=cloudtrail | groupby user, userarn, eventname | limit 1

stream=win-audit where action='OBJECT_ACCESSED' and status='PASSED' and sourcename='WINDOWS' and not logevent like '%program%files%nxlog%nxlog.exe%' | groupby @Application

stream=authentication where  sourcename='G-SUITE' AND action='LOGIN' AND reason='INVALID_CREDENTIALS'  | duration 5m | groupby srcip, system | select srcip, system, count_if(status=='FAILED') as failcount, count_if(status=='PASSED') as passcount | having failcount >= 10 and failcount >= passcount * 1 | limit 100

stream=ep-process where eid='1' and action='PROCESS_ADDED' and status='PASSED' and (parentimage like '%WINWORD.EXE%' or parentimage like '%EXCEL.EXE%' or parentimage like '%POWERPNT.exe%' or parentimage '%MSPUB.exe%' or parentimage like '%VISIO.exe%' or parentimage like '%OUTLOOK.EXE%') and (image like '%cmd.exe%' or image like '%powershell.exe%' or image like '%wscript.exe%' or image like '%cscript.exe%' or image like '%sh.exe%' or image like '%bash.exe%' or image like '%reg.exe%' or image like '%regsvr32.exe%' or image like '%BITSADMIN%') | duration 5m | limit 10

stream=ep-process where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=win-audit where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") and user='{SuspectUser}' and host='{SuspectHost}' | duration 6m

stream=SYSMON-REGISTRY where action='OBJECT_MODIFIED' and rlike(image, 'C:\\\WINDOWS\\\system32.*') and system='{TargetHost}'

stream=SYSMON-REGISTRY where action='OBJECT_MODIFIED' and rlike(image, 'C:\\\WINDOWS\\\system32.*') | groupby image, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | groupby user, system

stream=cloudtrail | select @userIdentity.type


stream=win-audit where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=win-audit where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") and user='{SuspectUser}' and host='{SuspectHost}' | duration 6m

stream=configuration where action="CONFIGURATION_CHANGED" and config IN ("DeleteDeliveryChannel", "StopConfigurationRecorder") |  groupby srcip, user

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and lower(commandline) like "%mimikatz%lsadump::dcsync%" | groupby user, system | duration 1d

stream=win-audit where action="PROCESS_CREATED" and lower(commandline) like "%mimikatz%lsadump::dcsync%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=firewall where action='PACKET_ALLOWED' | select sourcename, dstip, count(srcip) as COUNTU | groupby sourcename, dstip | having COUNTU>100

stream=documents where sourcename='G-SUITE' and action='DOWNLOADED' and not user like '%net-mon.net%' and user='nishmithashetty090@gmail.com' |  duration 1d

stream=configuration where config like 'A forced configuration update for%has successfully completed.' and @Channel='Application' and action='CONFIGURATION_CHANGED' and status='PASSED' and system='{TargetHost}' | duration 5m | limit 100

stream=configuration where config like 'A forced configuration update for%has successfully completed.' and @Channel='Application' and action='CONFIGURATION_CHANGED' and status='PASSED' | groupby system | duration 5m | limit 100

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | groupby user, system

stream=SYSMON-REGISTRY where action='OBJECT_MODIFIED' and rlike (targetobject, 'currentversion\\\\(runservices|run|Windows\\\\Appinit_Dlls.*|Winlogon\\\\(Shell|Userinit|VmApplet)|policies\\\\explorer\\\\run)|.*currentcontrolset\\\\Control\\\\Lsa\\\\|Microsoft\\\\Windows\sNT\\\\CurrentVersion\\\\Image\sFile\sExecution\sOptions|HKLM\\\\SOFTWARE\\\\Microsoft\\\\Netsh.*') and system='{TargetHost}'

stream=auditd

stream=configuration where (system= 'MMKNDMBX01.corp.mahindra.com' or system= 'MS-O365' or system= 'NESSUS01.NCDEXLTD.com') |  groupby config, system | duration 5m | limit 100

 stream=win-audit where sourcename='WINDOWS' and event='A fatal error occurred when attempting to access the SSL server credential private key.' and action='OBJECT_ACCESSED' and status='PASSED' and system='{TargetHost}' and user='{SuspectUser}' | duration 5m | limit 100

stream=win-audit where sourcename='WINDOWS' and event='A fatal error occurred when attempting to access the SSL server credential private key.' and action='OBJECT_ACCESSED' and status='PASSED' | groupby system, user | duration 5m | limit 100

stream=firewall | groupby srcip, action


stream=iam where sourcename='NIX' and action='USER_ADDED' and status='PASSED' |  groupby user, targetuser

stream=SIGNALS |  groupby detectionname

stream=firewall where dstport=53| 
groupby srcip| 
select srcip,count(distinct(dstip)) as distinct_DNS_servers| 
having distinct_DNS_servers>5

stream=sysmon-registry where action='OBJECT_MODIFIED' and rlike (targetobject, '.*CurrentControlSet.*Control.*Lsa.*|Microsoft.*Windows.*NT.*CurrentVersion.*Image\sFile\sExecution\sOptions|HKLM.*SOFTWARE.*Microsoft.*Netsh.*|currentversion.*runservices.*Winlogon.*Shell.*policies.*explorer.*run|currentversion.*run.*Winlogon.*Userinit.*policies.*explorer.*run|currentversion.*Windows.*Appinit_Dlls.*Winlogon.*VmApplet.*policies.*explorer.*run') and system='{TargetHost}'

stream=sysmon-registry where action='OBJECT_MODIFIED' and rlike (targetobject, '.*CurrentControlSet.*Control.*Lsa.*|Microsoft.*Windows.*NT.*CurrentVersion.*Image\sFile\sExecution\sOptions|HKLM.*SOFTWARE.*Microsoft.*Netsh.*|currentversion.*runservices.*Winlogon.*Shell.*policies.*explorer.*run|currentversion.*run.*Winlogon.*Userinit.*policies.*explorer.*run|currentversion.*Windows.*Appinit_Dlls.*Winlogon.*VmApplet.*policies.*explorer.*run') |  duration 1h |  groupby targetobject, system

stream=threat where  action='THREAT_DETECTED' and vector='AUTHENTICATION'| groupby threat,srcip,user| select threat,srcip,user 

stream=THREAT where action='THREAT_DETECTED' and vector='AUTHENTICATION' and User='{TargetUser}' and SrcIP='{SuspectHost}'

Stream=authentication where action='LOGIN' | duration 15m|  groupby SrcIP,System | select SrcIP,System,count_if(Status='FAILED') as Failure,count_if(Status='PASSED') as sucessful| having Failure>50 and Failure>5*sucessful

stream=Documents where action in ('EDITED', 'DELETED') and  not user='ben@secureframe.com' |  groupby user, action | duration 1d | having count_col1 >10 and count_col1 < 50 | limit 30

stream=Authentication where action='LOGIN' | groupby user, action, status, devsrcip

stream=* | duration 6h | select distinct(devsrcip) as UniqueDevSrcIP

stream=cloudtrail where eventname="CreateInstanceExportTask" and eventsource="ec2.amazonaws.com" and (@responseelements like "%Failure%" or @errorMessage is not null or errorcode is not null) | groupby user

stream=documents where sourcename='G-SUITE' and action='DOWNLOADED' and employeestatus='Notice Period' and user!='*net-mon.net*' | duration 10h | groupby user, file

stream=firewall where sourcename='FORTIGATE' | select @sessionid, @subtype | groupby @sessionid, @subtype

stream=WIN-AUDIT where system= 'GOODTECH2-EXCHA.DNF.com' |  groupby event

stream=firewall | select dstip, (cast(sum(case when dstport=='23' then 1 else 0 end) as float)/cast(count(*) as float))*100 as percentagecount, (cast(sum(case when dstport=='23' then 1 else 0 end) as float)/cast(count(*) as float)) as ratiocount | duration 1h | groupby dstip | having percentagecount>0 and ratiocount>0 

stream=authentication where action='LOGIN' and status='PASSED' | duration 1h | groupby user, system | limit 1

stream=authentication where action='LOGIN' and status='PASSED' and user='{SuspectUser}' and system='{TargetUser}' | duration 1h

stream=authentication where action='LOGIN' and status='PASSED' | select user, system, distinct_count(srcip) as countsrcip | groupby user, system | having countsrcip>3

stream=cloudtrail where eventsource='cloudtrail.amazonaws.com'  and sourcename='AWS-CLOUDTRAIL' | select logevent, @userIdentity.principalId, @eventID

stream=authentication where sourcename='NIX' and action='LOGIN' and status='FAILED' and authproto='SSH' and reason='INVALID_CREDENTIALS' |  groupby user, system

stream=webfilter where sourcename='CLOUDFLARE' and not action='URL_BLOCKED' and status='PASSED' and @Source='l7ddos' and srcip='{SuspectHost}'

stream=webfilter where sourcename='CLOUDFLARE' and not action='URL_BLOCKED' and status='PASSED' and @Source='l7ddos' | duration 1h |  groupby srcip | having count_col1>=100

stream=firewall |  groupby srcip, dstip,srcport,dstport | limit 5


stream=webfilter where sourcename='CLOUDFLARE' and action='URL_BLOCKED' and status='PASSED' | duration 1h |  groupby srcip | having count_col1 >=1

stream=webfilter where sourcename='CLOUDFLARE' and action='URL_BLOCKED' and status='PASSED' and srcip='{SuspectHost}'

stream=firewall where srctype='PUBLIC' | duration 10m | groupby srcip | limit 2

stream=authentication where action='LOGIN' and status='PASSED' | select user, system,count(status) as cntstatus | groupby user, system | having cntstatus > 1

stream=sysmon-process where image like "%schtasks.exe" and commandline like "%/create%/s%" and user='{SuspectUser}' | duration 6h

stream=sysmon-process where image like "%schtasks.exe" and commandline like "%/create%/s%" | duration 6h | select user, distinct_count(system) as dstsystem, commandline | groupby user, commandline | having dstsystem > 3

stream=iam where action='USER_LOCKOUT' | select user, system, distinct_count(targetuser) as distincttuser |  groupby user, system | having distincttuser > 3

stream=iam where action='USER_LOCKOUT' and user='{SuspectUser}' and system='{TargetHost}'

stream=* | duration 1h | groupby srcip, sourcetype | having count_col1 >=1

stream=* and srcip='{SuspectHost}'

stream=iam where sourcename='G-SUITE' and action='USER_DISABLED' and status='PASSED' and @id.applicationName='user_accounts' and @name='titanium_unenroll' | duration 1h | groupby user | having count_col1 >=1

stream=iam where sourcename='G-SUITE' and action='USER_DISABLED' and status='PASSED' and @id.applicationName='user_accounts' and @name='titanium_unenroll' and user='{SuspectUser}'

stream=authentication where action='LOGIN' and status='PASSED' | select user, system, distinct_count(srcip) as distinctsrcip | groupby user, system | having distinctsrcip > 2

stream=authentication where action='LOGIN' and status='PASSED' and user='{TargetUser}' and system='{TargetHost}'

stream=firewall | where action!='PACKET_ALLOWED' and action!='PACKET_BLOCKED' | duration 1m |  groupby action, devsrcip | limit 10

stream=webfilter where sourcename='CLOUDFLARE' and @BotScore>=30 | duration 1h |  groupby srcip | having count_col1 >=100

stream=webfilter where sourcename='CLOUDFLARE' and action='URL_BLOCKED' and status='PASSED' and @BotScore>=30 and srcip='{SuspectHost}'

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg.*?\\.exe|gpedit\\.msc|cmd\\.exe).*?(DisableChangePassword).*?\\/d\\s1") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg.*?\\.exe|gpedit\\.msc|cmd\\.exe).*?(DisableChangePassword).*?\\/d\\s1") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?(DisableChangePassword).*?\/d\s1") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?(DisableChangePassword)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'reg\s+save.*?(hklm|hkey_local_machine).*?(sam|system|security).*?temp.*?(sam|system|security)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'reg\s+save.*?(hklm|hkey_local_machine).*?(sam|system|security).*?temp.*?(sam|system|security)') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | groupby user, system

stream=iam where sourcename='NIX' and action='PASSWORD_CHANGED' and status='PASSED' |  groupby user, targetuser 

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell%" and commandline like "%Get-ADReplAccount%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell%" and commandline like "%Get-ADReplAccount%" | groupby user, system 

stream=iam where sourcename='NIX' and action='PASSWORD_CHANGED' and status='PASSED' and user='root' |  groupby user, targetuser 

stream=iam where sourcename='NIX' and action='USER_DELETED' and status='PASSED' | groupby user, targetuser 

stream=authentication where (unknownpayload='Event_RemoteResponseSessionStartEvent' or externalapitype='Event_RemoteResponseSessionStartEvent') | duration 1h | groupby user | having count_col1>=1

stream=authentication where (unknownpayload='Event_RemoteResponseSessionStartEvent' or externalapitype='Event_RemoteResponseSessionStartEvent') and user='{SuspectUser}'

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(reg\s+add.*?services.*?lanmanserver.*?parameters.*?(autosharewks|autoshareserver).*?reg\_dword.*?0)') or rlike(lower(commandline), '(new-itemproperty.*?(autosharewks|autoshareserver).*?aervices.*?lanmanserver.*?parameters.*?\-type\s+dword\s+-value\s+0)')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(reg\s+add.*?services.*?lanmanserver.*?parameters.*?(autosharewks|autoshareserver).*?reg\_dword.*?0)') or rlike(lower(commandline), '(new-itemproperty.*?(autosharewks|autoshareserver).*?aervices.*?lanmanserver.*?parameters.*?\-type\s+dword\s+-value\s+0)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or scriptblocktext like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') | groupby user, system

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or scriptblocktext like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=* | duration 1h | select devsrcip as UniqueDevSrcIP, count(*) as count_unique | groupby devsrcip

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz%exe%crypto%certificate%export%') | groupby user,system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz%exe%crypto%certificate%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Get-ADComputer%-Properties%' or commandline like '%Get-ADComputer%-Properties ms-Mcs-AdmPwd%ms-Mcs-AdmPwdExpirationTime%' or commandline like '%Get-adcomputer -SearchScope subtree -filter%name -like%-Properties%' or commandline like '%AdFind.exe%subtree -f%objectclass=computer%' or commandline like '%AdFind.exe%subtree%objectclass=computer%ms-Mcs-AdmPwd%ms-Mcs-AdmPwdExpirationTime%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Get-ADComputer%-Properties%' or commandline like '%Get-ADComputer%-Properties ms-Mcs-AdmPwd%ms-Mcs-AdmPwdExpirationTime%' or commandline like '%Get-adcomputer -SearchScope subtree -filter%name -like%-Properties%' or commandline like '%AdFind.exe%subtree -f%objectclass=computer%' or commandline like '%AdFind.exe%subtree%objectclass=computer%ms-Mcs-AdmPwd%ms-Mcs-AdmPwdExpirationTime%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=* | duration 1h | select devsrcip as UniqueDevSrcIP, count(*) as count_unique | groupby devsrcip

stream=authentication |  groupby srcip

stream=threat where not srcip='0.0.0.0' and sourcetype="IPS" and actiontaken in ('forward', 'proxy', 'bypass') and category='Behavioral-DoS' | groupby srcip 

stream=authentication where sourcename='NIX' and action='LOGIN' and status='PASSED'  | groupby user, devsrcip | duration 1d | limit 10

stream=iam where sourcename='NIX' and action='PASSWORD_CHANGED' and status='PASSED'| groupby user, targetuser

stream=configuration where sourcename='WINDOWS' and action='CONFIGURATION_CHANGED' and status='PASSED' | groupby user, system, config | duration 30m | limit 10

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%msbuild.exe%' or commandline like '%.csproj%' or commandline like '%vb.xml%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%msbuild.exe%' or commandline like '%.csproj%' or commandline like '%vb.xml%') | groupby system, user, commandline

stream=threat where eventname='networkconnectip4' and srctype='PUBLIC' and srcport in ('5938', '8040', '8041', '5900', '5901', '5902', '5903', '5904', '5905', '5906', '5907', '5908', '5909', '5910', '3389', '3283', '137', '139', '445') | duration 1h | groupby srcip | having count_col1>=1

stream=threat where eventname='networkconnectip4' and srctype='PUBLIC' and srcport in ('5938', '8040', '8041', '5900', '5901', '5902', '5903', '5904', '5905', '5906', '5907', '5908', '5909', '5910', '3389', '3283', '137', '139', '445') and srcip='{SuspectHost}'

stream=configuration where sourcename='WINDOWS' and action='CONFIGURATION_CHANGED' and status='PASSED' and config='System Shut Down' | groupby system, devsrcip | duration 1d | limit 10

stream=auditd where action='SERVICE_STARTED' and status='PASSED' |  groupby devsrcip, system | duration 24h | limit 10

stream=authentication where sourcename='NIX' and action='LOGIN' and status='FAILED' and user is not null |  duration 24h |  groupby user, srcip, devsrcip | limit 10

stream=threat where @ExternalApiType='Event_DetectionSummaryEvent' | duration 1h | groupby user | having count_col1 >=1

stream=threat where @ExternalApiType='Event_DetectionSummaryEvent' and user='{SuspectUser}'

stream=authentication where sourcename='NIX' and action='LOGIN' and status='PASSED' and user is not null and authproto in ('VPN','SSH') | groupby user, authproto, system, srcip, devsrcip | duration 1d | limit 100

stream=threat where not srcip="0.0.0.0" and not srcip like '203.199.247%' and sourcetype="IPS" and actiontaken in ('forward', 'proxy', 'bypass') and category="Anomolies" | duration 1h | groupby srcip

stream=threat where not srcip='0.0.0.0' and sourcetype="IPS" and not dstip="2403:0000:0101:0200::000d" and category='DNS-Protection' | duration 1h | groupby srcip 

stream=threat where sourcetype="IPS" and category="Intrusions" | duration 1h | groupby srcip

stream=* | duration 1h | select devsrcip as UniqueDevSrcIP, count(*) as count_unique | groupby devsrcip

stream=firewall where sourcename='FORTIGATE' and dstport in ('21','23','389','3389','445','63','5985','5986') and actiontaken in ('allow','accept') and not dstip like '190.%' and srccn='-' and not dstcn in ('-','IN','US') and srctype='PRIVATE' | groupby srcip

stream=firewall where sourcename='FORTIGATE' and dstport in ('21','23','389','3389','445','63','5985','5986') and actiontaken in ('allow','accept') and not dstip like '190.%' and srccn='-' and not dstcn in ('-','IN','US') and srctype='PRIVATE' and srcip='{SuspectHost}'

stream=configuration where sourcename='WINDOWS' and action='CONFIGURATION_CHANGED' and status='PASSED' | groupby user, system, config | duration 30m | limit 10

stream=configuration where sourcename='WINDOWS' and action='CONFIGURATION_CHANGED' and status='PASSED' and config='System Start' | groupby system,devsrcip | duration 1d | limit 10

stream=slack where sourcename='SLACK' and actiontaken='idp_configuration_deleted' and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=slack where sourcename='SLACK' and actiontaken='idp_configuration_deleted' |  groupby user, srcip

stream=duo where @result='fraud' and user='{SuspectUser}'

stream=duo where @result='fraud' | duration 15m | groupby user | having count_col1>=1

stream=webfilter where sourcename='CLOUDFLARE' and @BotScore>=30 and srcip='{SuspectHost}'

stream=webfilter where sourcename='CLOUDFLARE' and @BotScore>=30 | duration 1h |  groupby srcip | having count_col1 >=100

stream=threat where sourcename='TIPPINGPOINT' and threat like '%vulnerability%' | groupby threat, srcip, dstip

stream=firewall where sourcename='FORTIGATE' and dstport in ('5656','6086','14800','18080','24465','9389','9898','9988') and actiontaken in ('allow','accept') and srccn='-' and not dstcn='-' and srctype='PRIVATE' and srcip='{SuspectHost}'

stream=firewall where sourcename='FORTIGATE' and dstport in ('5656','6086','14800','18080','24465','9389','9898','9988') and actiontaken in ('allow','accept') and srccn='-' and not dstcn='-' and srctype='PRIVATE' | groupby srcip, dstport, dstip, srccn

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ("GetAlternateContact","GetContactInformation","PutAlternateContact","PutContactInformation","DescribeAccount") and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ("GetAlternateContact","GetContactInformation","PutAlternateContact","PutContactInformation","DescribeAccount") | duration 1h |  groupby srcip | having count_col1 >= 1

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe -Version%' or parentcommandline like '%powershell.exe -Version%') and user='{SuspectUser}' and system='{TargetHost}' | duration 5m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe -Version%' or parentcommandline like '%powershell.exe -Version%') | groupby user, system

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='DisableEbsEncryptionByDefault' and eventsource='ec2.amazonaws.com' | duration 1h |  groupby srcip | having count_col1 >=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and @log-status='SKIPDATA' and system='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and @log-status='SKIPDATA' | groupby system | duration 60m | having count_col1>=1 

stream=firewall where sourcename='FORTIGATE' and dstport in ('5656','6086','14800','18080','24465','9389','9898','9988') and actiontaken in ('allow','accept') and not srccn='-' and srctype='PUBLIC' | groupby srcip

stream=firewall where sourcename='FORTIGATE' and dstport in ('5656','6086','14800','18080','24465','9389','9898','9988') and actiontaken in ('allow','accept') and not srccn='-' and srcip='{SuspectHost}'

stream=threat where sourcename='TIPPINGPOINT' and action='THREAT_DETECTED' and status='PASSED' and vector='NETWORK' and threat like '%vulnerability%' | groupby threat, srcip, dstip 

stream=authentication where action='LOGIN' and status='FAILED' and authproto='SSH' | groupby user, srcip | limit 10

stream=authentication where action='LOGIN' and status='FAILED' and authproto='SSH' and srcip='{SuspectUser}'

stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%windows_powershell_process_start%" |  groupby srcip

stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%windows_powershell_process_start%" and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='ConsoleLogin' and @userIdentity.type='Root' and @responseElements.ConsoleLogin='Success' | duration 1h | groupby srcip | having count_col1>=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='ConsoleLogin' and @userIdentity.type='Root' and @responseElements.ConsoleLogin='Success' and srcip='{SuspectHost}'

stream=threat where sourcetype='DECOY' and vector='WEB' and srcip='{SuspectHost}'

stream=threat where sourcetype='DECOY' and vector='WEB' |  groupby srcip

stream=* where sourcename="JUNOS" and not stream="OTHER" | duration 7d | groupby stream | limit 100

stream=firewall where sourcename='FORTIGATE' and dstport in ('8333','18333','9333','9999','22556','30303') and actiontaken in ('allow','accept') and srccn='-' and not dstcn='-' | groupby srcip

stream=firewall where sourcename='FORTIGATE' and dstport in ('8333','18333','9333','9999','22556','30303') and actiontaken in ('allow','accept') and srccn='-' and not dstcn='-' and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' | groupby @query_name, srcip | duration 1h | having count_col1>=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and srcip='{SuspectHost}'

stream=gsuite where sourcename='G-SUITE' and app='rules' | duration 1h | groupby user | having count_col1>=

stream=gsuite where sourcename='G-SUITE' and app='rules' and user='{SuspectUser}'

stream=* where devsrcip='10.201.0.82' and eventid in ('9100', '9101') and sourcename='ARCOS-DBEVT' | duration 30m |  groupby user, eventid

stream=* where devsrcip='10.201.0.82' and eventid in ('9100', '9101') and sourcename='ARCOS-DBEVT' and user='{SuspectUser}'

stream=authentication where action="LOGIN" and dstip in ( '10.52.22.34', '10.42.22.81', '10.52.22.34', '10.42.22.81') | groupby srcip, dstip 

stream=threat where sourcename="SMOKESCREEN" and @cs1SubType="conn" and threat="Lateral Movement" and atkthreat like "%network_ssh_access%" | groupby @cs1AttackerName

stream=threat where sourcename="SMOKESCREEN" and @cs1SubType="conn" and threat="Lateral Movement" and atkthreat like "%network_ssh_access%" and @cs1AttackerName='{SuspectHost}'

stream=threat where sourcename="RADWARE" and ResourceName="Filter" and IsPassive="False" | duration 1h | groupby srcip, AttackMsg | limit 10


stream=threat where sourcename="RADWARE" and @Resource="Filter" and @IsPassive="False" and srcip='{SuspectHost}'

stream=threat where sourcetype="IPS" and not srcip="0.0.0.0" and actiontaken in ( "forward", "proxy", "bypass") and catagory="Behavioral-DoS" | groupby srcip

stream=threat where sourcetype="IPS" and not srcip="0.0.0.0" and actiontaken in ('forward', "proxy", "bypass") and catagory="Behavioral-Dos" and srcip='{SuspectHost}'

stream=threat where sourcetype="IPS" and action="THREAT_BLOCKED" and atkclass="Exploits" and severity in ( "Critical", "Major") | groupby srcip, threat

stream=DNS where sourcname="INFOBLOX" and sourcetype="NETWORK-OS" and query like "%ransomware%" | groupby srcip

stream=DNS where sourcname="INFOBLOX" and sourcetype="NETWORK-OS" and query like "%ransomware%" and srcip='{SuspectHost}'

stream=firewall where sourcename="FORTIGATE" and not (srcip like "172.%" or srcip like "192.168%" or srcip like "10.%") and not dstport="443" |  duration 5m | groupby dstport, srcip, dstip 

stream=firewall where sourcename="FORTIGATE" and not (srcip like "172.%" or srcip like "192.168%" or srcip like "10.%") and not dstport="443" and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='UpdateProjectVisibility' and @requestParameters.projectVisibility='PUBLIC_READ' | duration 1h |  groupby srcip | having count_col1 >= 1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='UpdateProjectVisibility' and @requestParameters.projectVisibility='PUBLIC_READ' and srcip='{SuspectHost}'

stream=threat where sourcename="SMOKESCREEN" and @cs1SubType="conn" or @cs1SubType="conn_init" and threat="Lateral Movement" and atkthreat like "%windows_admin_share%" | groupby @cs1AttackerName

stream=threat where sourcename="SMOKESCREEN" and @cs1SubType="conn" or @cs1SubType="conn_init" and threat="Lateral Movement" and atkthreat like "%windows_admin_share%" and @cs1AttackerName='{SuspectUser}'

stream=threat where sourcename="SMOKESCREEN-CEF" and threat='Reconnaissance' and srcip='{SuspectHost}'

stream=threat where sourcename="SMOKESCREEN-CEF" and threat='Reconnaissance' | groupby SrcIP | limit 100

stream=Threat where sourcename="TREND-MICRO-ENDPOINT" and action="THREAT_DETECTED" and eventname="Virus/Malware" | groupby dstip, threat | limit 10

stream=Threat where sourcename="TREND-MICRO-ENDPOINT" and action="THREAT_DETECTED" and eventname='Virus/Malware' and threat='{SusspectObject}'

stream=github where sourcename='GITHUB' and actiontaken in ('team.add_member', 'team.add_repository', 'team.change_parent_team', 'team.create', 'team.destroy', 'team.remove_member', 'team.remove_repository') and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken in ('team.add_member', 'team.add_repository', 'team.change_parent_team', 'team.create', 'team.destroy', 'team.remove_member', 'team.remove_repository') | duration 1h | groupby user | having count_col1>=1

stream=cloudtrail where (eventsource='sts.amazonaws.com' and eventname='AssumeRoleWithSAML') or (eventsource='iam.amazonaws.com' and eventname='UpdateSAMLProvider') and user='{SuspectUser}'

stream=cloudtrail where (eventsource='sts.amazonaws.com' and eventname='AssumeRoleWithSAML') or (eventsource='iam.amazonaws.com' and eventname='UpdateSAMLProvider') | duration 1h | groupby user | having count_col1>=1

stream=DNS where sourcname="INFOBLOX" and sourcetype="NETWORK-OS" and query like "%tor-exit-node-ip%" | groupby srcip

stream=DNS where sourcname="INFOBLOX" and sourcetype="NETWORK-OS" and query like "%tor-exit-node-ip%" and srcip='{SuspectHost}'

stream=threat where sourcename="RADWARE" and ResourceName="Filter" and IsPassive="False" | groupby srcip, Object | limit 100


stream=threat where sourcename="RADWARE" and ResourceName="Filter" and IsPassive="False" and srcip='{SuspectHost}'

stream=webserver where sourcename="TOMCAT" and returncode like "5%" |  groupby devsrcip, returncode, srcip

stream=threat where sourcename="TREND-MICRO-ENDPOINT" and filtername="SpamFilter" and threat="Phishing Rule" | groupby sender

stream=threat where sourcename="TREND-MICRO-ENDPOINT" and filtername="SpamFilter" and threat="Phishing Rule" and sender='{SuspectUser}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='PasswordUpdated' and usergroup='Root' and @responseElements.PasswordUpdated='Success' and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='PasswordUpdated' and usergroup='Root' and @responseElements.PasswordUpdated='Success' | duration 1h |  groupby srcip | having count_col1 >= 1

stream=Threat where sourcename="TREND-MICRO-ENDPOINT" and action="THREAT_DETECTED" and eventname='Virus/Malware' and file='{SusspectObject}' and dstip='{TargetHost}'

stream=Threat where sourcename="TREND-MICRO-ENDPOINT" and action="THREAT_DETECTED" and eventname='Virus/Malware' | groupby dstip, file | limit 10

stream=webfilter where EnrichmentSource="WatchlistIPMalware" | groupby domain

stream=webfilter where EnrichmentSource="WatchlistIPMalware" and domain='{SuspectUrl}'

stream=Threat where sourcename="TREND-MICRO-ENDPOINT" and threat='CnC Callback' | groupby dstip, @shost | limit 10

stream=Threat where sourcename="TREND-MICRO-ENDPOINT" and threat='CnC Callback' and @shost='{SuspectHost}'

stream=authentication where action="LOGIN" and status="FAILED" | duration 15m | groupby user, devsrcip, reason

stream=authentication where action="LOGIN" and status="FAILED" and user='{SuspectUser}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='ConsoleLogin' and usergroup='Root' and @responseElements.ConsoleLogin='Failure' | duration 15m |  groupby srcip | having count_col1>=5

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='ConsoleLogin' and usergroup='Root' and @responseElements.ConsoleLogin='Failure' and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('CreateCustomerGateway', 'DeleteCustomerGateway', 'AttachInternetGateway', 'CreateInternetGateway', 'DeleteInternetGateway', 'DetachInternetGateway') | duration 1h |  groupby @recipientAccountId, srcip | having count_col1>=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('CreateCustomerGateway', 'DeleteCustomerGateway', 'AttachInternetGateway', 'CreateInternetGateway', 'DeleteInternetGateway', 'DetachInternetGateway') and srcip='{SuspectHost}'

stream=webserver where sourcename="IIS" and returncode like "5%" |  groupby devsrcip, returncode, srcip

stream=authentication where sourcetype="IPS" and not devsrcip in ("10.202.4.20", "10.203.4.20") and not user="sebiadminand" and not lcase(user) like "%spiuser%" and user='{SuspectUser}'

stream=authentication where sourcetype="IPS" and not devsrcip in ("10.202.4.20", "10.203.4.20") and not user="sebiadminand" and not lcase(user) like "%spiuser%" | groupby user, sourcetype, sourcetype

stream=THREAT where sourcename="SMOKESCREEN" and not user='sauatbpmidm' and sourcetype='DECOY' and ThreatParseID='credtheft_honeypotbuster' and threat='Privilege Escalation' and user='{SuspectUser}'

stream=THREAT where sourcename="SMOKESCREEN" and not user='sauatbpmidm' and sourcetype='DECOY' and ThreatParseID='credtheft_honeypotbuster' and threat='Privilege Escalation' | groupby user | limit 100

stream=ARCOS-EVT where devsrcip='10.201.0.82' and eventid='9400' and sourcename='ARCOS-DBEVT' |  duration 1h |  groupby user

stream=ARCOS-EVT where devsrcip='10.201.0.82' and eventid='9400' and sourcename='ARCOS-DBEVT' and user='{SuspectUser}'

stream=threat where threat like "%zgrab Scanner Detection%" and not srccn="-" and devsrcip="10.202.4.20" and srcip='{SuspectHost}'

stream=threat where threat like "%zgrab Scanner Detection%" and not srccn="-" and devsrcip="10.202.4.20" | groupby threat, srcip, srccn, action

stream=threat where sourcename="SMOKESCREEN" and atkthreat like "%recon_creds_submitted%" | groupby @cs1AttackerId

stream=threat where sourcename="SMOKESCREEN" and atkthreat like "%recon_creds_submitted%" and @cs1AttackerId='{SuspectHost}'

stream=THREAT where sourcename="FIREEYE" and @act="Detection IOC Hit" |  groupby dstip | limit 10

stream=THREAT where sourcename="FIREEYE" and @act="Detection IOC Hit" and dstip='{TargetHost}'

stream=threat where sourcetype="IPS" and action="THREAT_BLOCKED" and atkclass="Reconnaissance" | groupby srcip, threat

stream=threat where sourcetype="IPS" and action="THREAT_BLOCKED" and atkclass="Reconnaissance" and srcip='{SuspectHost}'

stream=threat where sourcename="FORCEPOINT-DLP" and @severityType="HIGH" and (@sourceServiceName="SMTP" or @sourceServiceName="Endpoint Email") | groupby user, threat | limit 10

stream=threat where sourcename="FORCEPOINT-DLP" and @severityType="HIGH" and (@sourceServiceName="SMTP" or @sourceServiceName="Endpoint Email") and user='{SuspectUser}'

stream=authentication where sourcename="ARCOS-DBEVT" and action="LOGIN" and status="FAILED" and reason="INVALID_CREDENTAILS" | groupby user

stream=Threat where sourcetype='ENDPOINT-SECURITY' and sourcename='INTERSCAN-VIRUSWALL' and logevent like '%Detected virus log%' and user='{SuspectUser}'

stream=Threat where sourcetype='ENDPOINT-SECURITY' and sourcename='INTERSCAN-VIRUSWALL' and logevent like '%Detected virus log%' |  duration 12h |  groupby url, user, threat

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and @severity between 4.0 and 6.9 and @accountId='{SuspectUser}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and @severity between 4.0 and 6.9 | duration 1h | groupby @accountId | having count_col1 >=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='ModifyImageAttribute' and @requestparameters.launchpermission.add.items.group='all' and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='ModifyImageAttribute' and @requestparameters.launchpermission.add.items.group='all' | duration 60m | groupby srcip | having count_col1>=1 

stream=threat where sourcename="RADWARE" and ResourceName="Filter" and IsPassive="False" and srcip='{SuspectHost}'

stream=threat where sourcename="RADWARE" and ResourceName="Filter" and IsPassive="False" | duration 1h | groupby srcip | limit 100


stream=WEBSERVER where ReturnCode="400" |  groupby srcip

stream=WEBSERVER where ReturnCode="400" and srcip='{SuspectHost}'

stream=system where sourcename="JUNOS" and sourcetype="NETWORK-OS" and category="NTP" | groupby devsrcip

stream=AUTHENTICATION where Action="LOGIN" and sourcename="WINDOWS" and status="PASSED" | duration 1d | groupby user | limit 10

stream=AUTHENTICATION where Action="LOGIN" and sourcename="WINDOWS" and status="PASSED" and user='{SuspectUser}'

stream=firewall where action="PACKET_ALLOWED" and sourcetype="FIREWALL" and not srcip like "10.%" and EnrichmentSource="WatchlistIPMalware" | groupby sourcename, srcip, EnrichmentSource

stream=firewall and action="PACKET_ALLOWED" and sourcetype="FIREWALL" and not srcip like "10.%" and EnrichmentSource="WatchlistIPMalware" and srcip='{SuspectHost}'

stream=authentication where sourcename='FORTIGATE' and action='LOGIN' and status='FAILED' | groupby user, system

stream=sysmon-registry where action='OBJECT_MODIFIED' and eid='13' and (targetobject like '%Microsoft%Windows%CurrentVersion%Run%' or targetobject like '%Microsoft%Windows%CurrentVersion%RunOnce%') and devsrcip='{SuspectHost}'

stream=sysmon-registry where action='OBJECT_MODIFIED' and eid='13' and (targetobject like '%Microsoft%Windows%CurrentVersion%Run%' or targetobject like '%Microsoft%Windows%CurrentVersion%RunOnce%') | groupby targetobject, system, devsrcip

stream=webfilter where category="Phishing and Other Frauds" | groupby srcip

stream=webfilter where category="Phishing and Other Frauds" and srcip='{SuspectHost}'

stream=authentication where sourcename='NIX' and sourcetype="OS" and action="LOGIN" and user="root" | groupby devsrcip, srcip | limit 100

stream=authentication where sourcename='NIX' and sourcetype="OS" AND Action="LOGIN" AND User="root" and srcip='{SuspectHost}' and devsrcip='{TargetHost}'

stream=threat where sourcetype="IPS" and catagory="Intrusions" | duration 1d | groupby srcip

stream=threat where sourcetype="IPS" and catagory="Intrusions" and srcip='{SuspectHost}'

stream=authentication where action='LOGIN' and status='PASSED' and @attributes.action='user_logged_in_as_user' | duration 1h | groupby user | having count_col1>=1

stream=authentication where action='LOGIN' and status='PASSED' and @attributes.action='user_logged_in_as_user' and user='{SuspectUser}'

stream=firewall where sourcename='FORTIGATE' and action='PACKET_ALLOWED' and status='PASSED' and dstport='69' and @service='TFTP' | groupby srcip, dstip

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and srctype='PUBLIC' and @stage='ResponseComplete' and @responseStatus.code='403' and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and srctype='PUBLIC' and @stage='ResponseComplete' and @responseStatus.code='403'  | duration 30m |  groupby srcip | having count_col1 >= 10

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('PutBucketPolicy','SetRepositoryPolicy','CreateElasticsearchDomain','UpdateElasticsearchDomainConfig','CreateKey','PutKeyPolicy','SetVaultAccessPolicy','SetQueueAttributes','CreateTopic','SetTopicAttributes','PutResourcePolicy') and @requestParameters.bucketPolicy.Statement.Sid='Public Access' | duration 1h |  groupby srcip | having count_col1 >= 1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('PutBucketPolicy','SetRepositoryPolicy','CreateElasticsearchDomain','UpdateElasticsearchDomainConfig','CreateKey','PutKeyPolicy','SetVaultAccessPolicy','SetQueueAttributes','CreateTopic','SetTopicAttributes','PutResourcePolicy') and @requestParameters.bucketPolicy.Statement.Sid='Public Access' and srcip='{SuspectHost}'

stream=IAM where devsrcip='10.201.0.82' and PasswordChangedByUserName!='ARCOSSPCService' and eventid='9500' and sourcename='ARCOS-DBEVT' |  duration 1h |  groupby passwordchangedbyusername

stream=IAM where devsrcip='10.201.0.82' and PasswordChangedByUserName!='ARCOSSPCService' and eventid='9500' and sourcename='ARCOS-DBEVT' and passwordchangedbyusername='{SuspectUser}'

stream=threat where sourcetype="IPS"  and severity in ( "Critical", "Major") and AtkClass="Network Equipment" and not srcip="0.0.0.0" | groupby srcip

stream=threat where sourcetype="IPS" and severity in ( "Critical", "Major") and AtkClass="Network Equipment" and not srcip="0.0.0.0" and srcip='{SuspectHost}'

stream=threat where sourcetype="IPS" and not srcip="0.0.0.0" and srcip not like "203.199.247%" and actiontaken in ('forward', "proxy", "bypass") and catagory="Anomalies" and srcip='{SuspectHost}'

stream=threat where sourcetype="IPS" and not srcip="0.0.0.0" and srcip not like "203.199.247%" and actiontaken in ( "forward", "proxy", "bypass") and catagory="Anomalies" | duration 1h | groupby srcip

stream=authentication where sourcename='FORTIGATE' and action='LOGIN' and status='PASSED' and intel='True' | groupby system, user 

stream=threat where sourcetype="DECOY" and not srcip="10.201.2.164" and @cs1DecoyType="network" | groupby system, srcip

stream=threat where sourcename="FORCEPOINT-DLP" and @sourceServiceName="Endpoint HTTPS" and @severityType="HIGH" | duration 7d | groupby srcip

stream=threat where sourcename="FORCEPOINT-DLP" and @sourceServiceName="Endpoint HTTPS" and @severityType="HIGH" and srcip='{SuspectHost}'

stream=Threat where sourcename="TREND-MICRO-ENDPOINT" and threat='Spyware Detected' | groupby dstip, action | limit 10

stream=Threat where sourcename="TREND-MICRO-ENDPOINT" and threat='Spyware Detected' and dstip='{TargetHost}'

stream=authentication where sourcetype="IPS" and not user="radware" and devsrcip not in ("10.204.1.40", "10.203.6.4", "10.201.6.4") and not lcase(user) like "%spiuser%" | groupby user, sourcetype, sourcetype

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='ConsoleLogin' and @additionalEventData.MFAUsed='NO' and @responseElements.ConsoleLogin='Success' and not usergroup='AssumedRole' and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='ConsoleLogin' and @additionalEventData.MFAUsed='NO' and @responseElements.ConsoleLogin='Success' and not usergroup='AssumedRole' | duration 1h |  groupby srcip | having count_col1 >= 1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname=('CreateRoute', 'CreateRouteTable', 'ReplaceRoute', 'ReplaceRouteTableAssociation', 'DeleteRouteTable', 'DeleteRoute', 'DisassociateRouteTable') | duration 1h |  groupby @recipientAccountId, srcip | having count_col1>=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname=('CreateRoute', 'CreateRouteTable', 'ReplaceRoute', 'ReplaceRouteTableAssociation', 'DeleteRouteTable', 'DeleteRoute', 'DisassociateRouteTable') and srcip='{SuspectHost}'

stream=cloudtrail where domainname in ('api.earnin.com', 'nativeapi.earnin.com', 'experian-ewa.dev.earnin.com', 'api.us-west-2.dev.earnin.com', 'api.dev.earnin.com') and not (elbStatusCode='502' or  elbStatusCode='503') and srcip='{SuspectHost}' and dstip='{TargetHost}'

stream=cloudtrail where domainname in ('api.earnin.com', 'nativeapi.earnin.com', 'experian-ewa.dev.earnin.com', 'api.us-west-2.dev.earnin.com', 'api.dev.earnin.com') and not (elbStatusCode='502' or  elbStatusCode='503') | duration 1h |  groupby domainname, srcip, dstip | having count_col1>=1

stream=configuration where sourcetype="NETWORK-OS" and sourcename="CISCO" and action="CONFIGURATION_CHANGED" | groupby devsrcip, action, config

stream=configuration where sourcetype="NETWORK-OS" and sourcename="CISCO" and action="CONFIGURATION_CHANGED" and devsrcip='{TargetHost}'

stream=threat where sourcename="TREND-MICRO-ENDPOINT" and eventname='Predictive Machine Learning' | groupby dstip, threat | limit 10

stream=threat where sourcename="TREND-MICRO-ENDPOINT" and threat='Predictive Machine Learning' and dstip='{TargetHost}'

stream=threat where sourcetype="IPS" and AtkClass="Security Policy" and srcip='{SuspectHost}'

stream=threat where sourcetype="IPS" and AtkClass="Security Policy" | groupby srcip

stream=DNS where sourcename="INFOBLOX" and sourcetype="NETWORK-OS" and query like "%antimalware%" | groupby srcip

stream=DNS where sourcname="INFOBLOX" and sourcetype="NETWORK-OS" and query like "%antimalware%" and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='CreateAccessKey' and @userIdentity.type='Root' and not @requestParameters='null' and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='CreateAccessKey' and @userIdentity.type='Root' and not @requestParameters='null' | duration 1h | groupby srcip | having count_col1>=1

stream=authentication where sourcetype="LOADBALANCER" and not lcase(user) like "%spiuser%" | groupby user, sourcetype, sourcetype

stream=threat where sourcetype="IPS" and action="THREAT_DETECTED" and atkclass="Reconnaissance" and srcip='{SuspectHost}'

stream=threat where sourcetype="IPS" and action="THREAT_DETECTED" and atkclass="Reconnaissance" | groupby srcip, threat

stream=AUTHENTICATION where Action="LOGIN" and sourcename="WINDOWS" and status="PASSED" | duration 1d | groupby user | limit 10

stream=THREAT where soucename="SMOKESCEEN" and not user='sauatbpmidm' and sourcetype='DECOY' and @cs1ThreatParseIds='credtheft_honeypotbuster' and threat='Privilege Escalation' and @act="Detection IOC Hit" and user='{SuspectUser}'

stream=THREAT where sourcename="SMOKESCREEN" and not user='sauatbpmidm' and sourcetype='DECOY' and ThreatParseID='credtheft_honeypotbuster' |  groupby user | limit 100

stream=threat where sourcetype='WAF' and @IsPassive='True' and srcip='{SuspectHost}'

stream=threat where sourcename="RADWARE" and sourcetype='WAF' and IsPassive='True' | groupby srcip, attackmsg 

stream=threat where sourcename="SMOKESCREEN" and @cs1SubType="conn" or @cs1SubType="conn_init" and threat="Lateral Movement" and atkthreat like "%network_telnet_access%" | groupby @cs1AttackerName

stream=threat where sourcename="SMOKESCREEN" and @cs1SubType="conn" or @cs1SubType="conn_init" and threat="Lateral Movement" and atkthreat like "%network_telnet_access%" and @cs1AttackerName='{SuspectHost}'

stream=authentication where sourcetype="DDAN" and not srcip in ("10.201.2.36", "10.201.2.37", "10.201.2.38") and not lcase(user) like "%spiuser%" | groupby user, sourcetype, sourcetype

stream=THREAT where sourcename='SMOKESCREEN' and Threat like '%windows_powershell_process_start%' | groupby SrcIP | limit 10

stream=THREAT where sourcename='SMOKESCREEN' and Threat like '%windows_powershell_process_start%' and srcip='{TargetHost}'

stream=webserver where sourcetype="WEBSERVER" and returncode like "5%" | duration 30m |  groupby srcip

stream=webserver where sourcetype="WEBSERVER" and returncode like "5%" and srcip='{SuspectHost}'

stream=win-audit where action="POLICY_CHANGED" | groupby action, @Category, devsrcip 

stream=win-audit where action="POLICY_CHANGED" and devsrcip='{TargetHost}'

stream=threat where sourcetype="IPS" and action="THREAT_BLOCKED" and atkclass="Exploits" and severity in ( "Critical", "Major") | groupby srcip, threat

stream=threat where sourcename="TIPPINGPOINT" and action="THREAT_BLOCKED" and logevent like "%Reconnaissance%" and srcip='{SuspectHost}'

stream=threat where sourcename="TIPPINGPOINT" and action="THREAT_BLOCKED" and atkclass like "Reconnaissance" | groupby srcip, threat

stream=authentication where not user="public" and sourcetype="WAF" and not lcase(user) like "%spiuser%" | groupby user, sourcetype, sourcetype

stream=WIN-AUDIT where sourcetype='OS' and action='AUDIT_LOG_CLEARED' | groupby User | limit 100

stream=configuration where sourcetype="FIREWALL" and not config like "%delete%phase" and not config like "%IPsec%phase%" | groupby action, config

stream=configuration where sourcetype="FIREWALL" and not config like "%delete%phase" and not config like "%IPsec%phase%" and action='{SuspectAction}'

stream=threat where SOURCENAME="TIPPINGPOINT" AND logevent LIKE "ProfSvc" AND logevent LIKE "%Privilege%" | duration 1h | groupby srcip

stream=threat where SOURCENAME="TIPPINGPOINT" AND logevent LIKE "ProfSvc" AND logevent LIKE "%Privilege%" and srcip='{SuspectHost}'

stream=ARCOS-EVT where devsrcip='10.201.0.82' and sourcename='ARCOS-DBEVT' and eventid='9700' |  duration 1h |  groupby user

stream=ARCOS-EVT where devsrcip='10.201.0.82' and sourcename='ARCOS-DBEVT' and eventid='9700' and user='{SuspectUser}'

stream=sysmon-file

stream=threat where sourcetype="IPS" and action="THREAT_BLOCKED" and atkclass="Exploits" and severity in ( "Minor", "Low") | groupby srcip, threat

stream=Threat where sourcename="TREND-MICRO-ENDPOINT" and @deviceFacility in ('Apex One', 'Apex One ' ,'Apex') and threat='Spyware Detected' | groupby dstip, action | limit 10

stream=Threat where sourcename="TREND-MICRO-ENDPOINT" and @deviceFacility in ('Apex One', 'Apex One ' ,'Apex') and threat='Spyware/Grayware' and dstip='{TargetHost}'

stream=threat where sourcetype="IPS" and action="THREAT_DETECTED" and atkclass="Exploits" and severity in ( "Critical", "Major") | groupby srcip, threat

stream=webserver where method not in ('GET', 'POST') and srcip='{SuspectHost}'

stream=webserver where method not in ('GET', 'POST') | duration 30m | groupby srcip

stream=authentication where sourcetype="FIREWALL" and not lcase(user) like "%spiuser%" | groupby user, sourcename, sourcetype

stream=authentication where sourcetype="FIREWALL" and not lcase(user) like "%spiuser%" and user='{SuspectUser}'

stream=firewall where not sourcename="CISCO-ASA" and not (srcip like "172.%" or srcip like "192.168%" or srcip like "10.%") |  duration 5m | groupby dstport, srcip, dstip 

stream=threat where sourcetype="IPS" and not srcip="0.0.0.0" and not dstip="2403:0000:0101:0200:000d" and catagory="DNS-Protection" | duration 1h | groupby srcip

stream=threat where sourcetype="IPS" and not srcip="0.0.0.0" and not dstip="2403:0000:0101:0200:000d" and catagory="DNS-Protection" and srcip='{SuspectHost}'

stream=threat where sourcetype="IPS" and action="THREAT_DETECTED" and severity="Critical" and AtkClass="Vulnerabilities" | groupby srcip, threat | limit 10

stream=threat where sourcetype="IPS" and action="THREAT_DETECTED" and severity="Critical" and AtkClass="Vulnerabilities" and srcip='{SuspectHost}'

stream=threat where sourcetype="IPS" and action="THREAT_DETECTED" and atkclass="Exploits" and severity in ( "Minor", "Low") | groupby srcip, threat

stream=authentication where sourcename="JUNOS" and sourcetype="NETWORK-OS" and category="UI_DBASE_LOGIN_EVENT" and logevent like "%entering configuration mode%" and user='{SuspectUser}'

stream=authentication where sourcename="JUNOS" and sourcetype="NETWORK-OS" and category="UI_DBASE_LOGIN_EVENT" and logevent like "%entering configuration mode%" | groupby user

stream=firewall where srctype='PRIVATE' and dsttype='PUBLIC' and dstip='{TargetHost}' and srcip='{SuspectHost}'

stream=firewall where srctype='PRIVATE' and dsttype='PRIVATE' |  select distinct_count(dstport) as port_count,srcip,dstip |  groupby dstport,srcip,dstip |  having port_count > 10 |  duration 1h

stream=firewall where action='PACKET_ALLOWED' and status='PASSED' and dsttype='PRIVATE' and dstip='{TargetHost}' and srcip='{SuspectHost}' and srccn='{SuspectLocation}'

stream=firewall where action='PACKET_ALLOWED' and status='PASSED' and not srccn='IN' and not srccn='-' and srccn is not null and dsttype='PRIVATE' |  groupby srcip, srccn, dstip

stream=EP-REGISTRY where (registrypath like '%\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\%' or registrypath like '%\\SOFTWARE\\Policies\\Microsoft\\WindowsFirewall\\%') and registryvaluename='EnableFirewall' | groupby user, system

stream=EP-REGISTRY where (registrypath like '%\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\%' or registrypath like '%\\SOFTWARE\\Policies\\Microsoft\\WindowsFirewall\\%') and registryvaluename='EnableFirewall' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and srctype='PUBLIC' and (user like 'system%' or user like 'eks%') and @stage='ResponseComplete' | duration 15m |  groupby srcip | having count_col1 >= 1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and srctype='PUBLIC' and (user like 'system%' or user like 'eks%') and stage='ResponseComplete' and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('CreateSecurityGroup','AuthorizeSecurityGroupIngress','AuthorizeSecurityGroupEgress') and useragent like '%HashiCorp/?.0 Terraform/%' and @recipientAccountId in ('11111111111111','112233445566') and userarn in ('Operator','ContinousDeployment') and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('CreateSecurityGroup','AuthorizeSecurityGroupIngress','AuthorizeSecurityGroupEgress') and useragent like '%HashiCorp/?.0 Terraform/%' and @recipientAccountId in ('11111111111111','112233445566') and userarn in ('Operator','ContinousDeployment') | duration 1h | groupby srcip | having count_col1 >=1

stream=webfilter where action='URL_ALLOWED' and status='PASSED' |  duration 1h |  groupby user, url, httpmethod, txlen | having txlen > 1000

stream=webfilter where action='URL_ALLOWED' and status='PASSED' and url='{SuspectURL}' and user='{SuspectUser}' 

stream=cloudtrail where eventname in ('DeleteAccountPublicAccessBlock', 'DeleteDeliveryChannel', 'DeleteDetector', 'DeleteFlowLogs', 'DeleteRule', 'DeleteTrail', 'DisableEbsEncryptionByDefault', 'DisableRule', 'StopConfigurationRecorder', 'StopLogging') and (eventsource='s3.amazonaws.com' or eventsource='cloudtrail.amazonaws.com' or eventsource='config.amazonaws.com' or eventsource='guardduty.amazonaws.com') | duration 1h | groupby user | having count_col1 >=1

stream=cloudtrail where eventname in ('DeleteAccountPublicAccessBlock', 'DeleteDeliveryChannel', 'DeleteDetector', 'DeleteFlowLogs', 'DeleteRule', 'DeleteTrail', 'DisableEbsEncryptionByDefault', 'DisableRule', 'StopConfigurationRecorder', 'StopLogging') and (eventsource='s3.amazonaws.com' or eventsource='cloudtrail.amazonaws.com' or eventsource='config.amazonaws.com' or eventsource='guardduty.amazonaws.com') and user='{SuspectUser}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='CreateNetworkAclEntry' and @requestParameters.cidrBlock='0.0.0.0/0' and @requestParameters.ruleAction='allow' and @requestParameters.egress='false' and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='CreateNetworkAclEntry' and @requestParameters.cidrBlock='0.0.0.0/0' and @requestParameters.ruleAction='allow' and @requestParameters.egress='false' | duration 1h | groupby srcip |  having count_col1>=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and ((eventname='ModifySnapshotAttribute' and @requestParameters.attributeType='CREATE_VOLUME_PERMISSION' and @requestParameters.createVolumePermission.add.items.group='all') or (eventname='ModifyDBClusterSnapshotAttribute' and @requestParameters.valuesToAdd='all')) and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and ((eventname='ModifySnapshotAttribute' and @requestParameters.attributeType='CREATE_VOLUME_PERMISSION' and @requestParameters.createVolumePermission.add.items.group='all') or (eventname='ModifyDBClusterSnapshotAttribute' and @requestParameters.valuesToAdd='all')) | duration 1h |  groupby srcip | having count_col1>= 

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('StopConfigurationRecorder','DeleteDeliveryChannel') | duration 1h | groupby srcip, eventname | having count_col1>=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('StopConfigurationRecorder','DeleteDeliveryChannel') and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('AuthorizeSecurityGroupIngress','AuthorizeSecurityGroupEgress','RevokeSecurityGroupIngress','RevokeSecurityGroupEgress','CreateSecurityGroup','DeleteSecurityGroup') and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('AuthorizeSecurityGroupIngress','AuthorizeSecurityGroupEgress','RevokeSecurityGroupIngress','RevokeSecurityGroupEgress','CreateSecurityGroup','DeleteSecurityGroup') | duration 12h | groupby srcip | having count_col1 >=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventsource='ec2.amazonaws.com' and eventname in ('CreateTrafficMirrorFilter','CreateTrafficMirrorFilterRule','CreateTrafficMirrorSession','CreateTrafficMirrorTarget','DeleteTrafficMirrorFilter','DeleteTrafficMirrorFilterRule','DeleteTrafficMirrorSession','DeleteTrafficMirrorTarget','DescribeTrafficMirrorFilters','DescribeTrafficMirrorSessions','DescribeTrafficMirrorTargets','ModifyTrafficMirrorFilterNetworkServices','ModifyTrafficMirrorFilterRule','ModifyTrafficMirrorSession') | duration 1h | groupby user | having count_col1 >=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventsource='ec2.amazonaws.com' and eventname in ('CreateTrafficMirrorFilter','CreateTrafficMirrorFilterRule','CreateTrafficMirrorSession','CreateTrafficMirrorTarget','DeleteTrafficMirrorFilter','DeleteTrafficMirrorFilterRule','DeleteTrafficMirrorSession','DeleteTrafficMirrorTarget','DescribeTrafficMirrorFilters','DescribeTrafficMirrorSessions','DescribeTrafficMirrorTargets','ModifyTrafficMirrorFilterNetworkServices','ModifyTrafficMirrorFilterRule','ModifyTrafficMirrorSession') and user='{SuspectUser}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and @severity between 7.0 and 8.9 and @accoundId='{SuspectUser}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and @severity between 7.0 and 8.9 | duration 1h | groupby @accountId | having count_col1 >=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('CopyFpgaImage', 'CopyImage', 'CreateFpgaImage', 'CreateImage', 'CreateRestoreImageTask', 'CreateStoreImageTask', 'ImportImage') and eventsource='ec2.amazonaws.com' and not srcip like '%.amazonaws.com' and not usergroup='AWSService' and not invokedby='AWS Internal' and not invokedby like '%.amazonaws.com' and not errorcode='Client.DryRunOperation' and user='{SuspectUser}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('CopyFpgaImage', 'CopyImage', 'CreateFpgaImage', 'CreateImage', 'CreateRestoreImageTask', 'CreateStoreImageTask', 'ImportImage') and eventsource='ec2.amazonaws.com' and not srcip like '%.amazonaws.com' and not usergroup='AWSService' and not invokedby='AWS Internal' and not invokedby like '%.amazonaws.com' and not errorcode='Client.DryRunOperation' | duration 1h | groupby user | having count_col1>=1

stream=cloudtrail where eventname in ('DeleteBucket', 'DeleteBucketPolicy', 'DeleteBucketWebsite') and user='{SuspectUser}'

stream=cloudtrail where eventname in ('DeleteBucket', 'DeleteBucketPolicy', 'DeleteBucketWebsite') | duration 1h | groupby user | having count_col1 >=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and  eventname='AssumeRole' and usergroup in ('IAMUser','FederatedUser') and rolearn in ('arn:aws:iam::123456789012:role/FullAdminRole','arn:aws:iam::122473544600:role/RoleTerraform','arn:aws:iam::171679608487:role/AWS-QuickSetup-StackSet-Local-ExecutionRole','arn:aws:iam::171679608487:role/Role-admin-team','arn:aws:iam::171679608487:role/RoleCloudOpsFromDev','arn:aws:iam::171679608487:role/RoleTerraform','arn:aws:iam::171679608487:role/RoleTerraformTeam','arn:aws:iam::185993409072:role/RoleTerraform') and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and  eventname='AssumeRole' and usergroup in ('IAMUser','FederatedUser') and rolearn in ('arn:aws:iam::123456789012:role/FullAdminRole','arn:aws:iam::122473544600:role/RoleTerraform','arn:aws:iam::171679608487:role/AWS-QuickSetup-StackSet-Local-ExecutionRole','arn:aws:iam::171679608487:role/Role-admin-team','arn:aws:iam::171679608487:role/RoleCloudOpsFromDev','arn:aws:iam::171679608487:role/RoleTerraform','arn:aws:iam::171679608487:role/RoleTerraformTeam','arn:aws:iam::185993409072:role/RoleTerraform') | duration 1h | groupby srcip | having count_col1>=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('CreateNetworkAcl','CreateNetworkAclEntry','DeleteNetworkAcl','DeleteNetworkAclEntry','ReplaceNetworkAclEntry','ReplaceNetworkAclAssociation') and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('CreateNetworkAcl','CreateNetworkAclEntry','DeleteNetworkAcl','DeleteNetworkAclEntry','ReplaceNetworkAclEntry','ReplaceNetworkAclAssociation') | duration 1h | groupby srcip | having count_col1 >=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='PutUserPolicy' and @requestParameters.policyName='AWSExposedCredentialPolicy_DO_NOT_REMOVE' | duration 1h | groupby user | having count_col1>=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='PutUserPolicy' and @requestParameters.policyName='AWSExposedCredentialPolicy_DO_NOT_REMOVE' and user='{Suspectuser}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and errorcode='AccessDenied' and usergroup='IAMUser' and not useragent like 'aws-internal/3%' and ((eventsource like 'dynamodb%' and (eventname like 'List%' or eventname like 'Describe%' or eventname like 'Get%')) or (eventsource like 'ec2%' and (eventname like 'Describe%' or eventname like 'Describe%')) or (eventsource like 'iam%' and (eventname like 'List%' or eventname like 'Get%')) or (eventsource like 's3%' and (eventname like 'List%' or eventname like 'Get%')) or (eventsource like 'rds%' and (eventname like 'Describe%' or eventname like 'List%'))) and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and errorcode='AccessDenied' and usergroup='IAMUser' and not useragent like 'aws-internal/3%' and ((eventsource like 'dynamodb%' and (eventname like 'List%' or eventname like 'Describe%' or eventname like 'Get%')) or (eventsource like 'ec2%' and (eventname like 'Describe%' or eventname like 'Describe%')) or (eventsource like 'iam%' and (eventname like 'List%' or eventname like 'Get%')) or (eventsource like 's3%' and (eventname like 'List%' or eventname like 'Get%')) or (eventsource like 'rds%' and (eventname like 'Describe%' or eventname like 'List%'))) | duration 10m | groupby srcip | having count_col1 >=15

stream=threat where dstport in ('21', '22', '23', '69', '445', '989', '3389') and srctype='PUBLIC' and eventsimplename='networkconnectip4' and srcip='{SuspectHost}'

stream=threat where dstport in ('21', '22', '23', '69', '445', '989', '3389') and srctype='PUBLIC' and eventsimplename='networkconnectip4' | duration 1h | groupby srcip| having count_col1>=1

stream=iam where eventtype='user.account.privilege.grant' and @outcome.result='SUCCESS' and rlike (privilegegranted, '.*[aA]dministrator.*') and user='{SuspectUser}'

stream=okta where @eventtype='user.account.privilege.grant' and @outcome.result='SUCCESS' and rlike (privilegegranted, '.*[aA]dministrator.*') | duration 15m | groupby user | having count_col1 >=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('CreateVpc', 'DeleteVpc', 'ModifyVpcAttribute', 'AcceptVpcPeeringConnection', 'CreateVpcPeeringConnection', 'DeleteVpcPeeringConnection', 'RejectVpcPeeringConnection', 'AttachClassicLinkVpc', 'DetachClassicLinkVpc', 'DisableVpcClassicLink', 'EnableVpcClassicLink') | duration 12h | groupby @recipientAccountId, srcip | having count_col1>=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('CreateVpc', 'DeleteVpc', 'ModifyVpcAttribute', 'AcceptVpcPeeringConnection', 'CreateVpcPeeringConnection', 'DeleteVpcPeeringConnection', 'RejectVpcPeeringConnection', 'AttachClassicLinkVpc', 'DetachClassicLinkVpc', 'DisableVpcClassicLink', 'EnableVpcClassicLink') and srcip='{SuspectHost}'

stream=cloudtrail  where eventsource="cloudtrail.amazonaws.com" and eventname IN ("StopLogging", "UpdateTrail", "DeleteTrail") and user='{SuspectUser}'

stream=cloudtrail  where eventsource="cloudtrail.amazonaws.com" and eventname IN ("StopLogging", "UpdateTrail", "DeleteTrail") | duration 1h | groupby user | having count_col1 >=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and @severity between 0.1 and 3.9 | duration 8h | groupby @accountId | having count_col1>=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and @severity between 0.1 and 3.9 and @accountId='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken='repo.access' and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken='repo.access' |  groupby user

stream=firewall where sourcename='FORTIGATE' and dstport in ('7777','8388','8580','8997','8998','8999','8332') and actiontaken in ('allow','accept') | groupby srcip

stream=firewall where sourcename='FORTIGATE' and dstport in ('7777','8388','8580','8997','8998','8999','8332') and actiontaken in ('allow','accept') and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('DeleteGroupPolicy', 'DeleteRolePolicy', 'DeleteUserPolicy', 'PutGroupPolicy', 'PutRolePolicy', 'PutUserPolicy', 'CreatePolicy', 'DeletePolicy', 'CreatePolicyVersion', 'DeletePolicyVersion', 'AttachRolePolicy', 'DetachRolePolicy', 'AttachUserPolicy', 'DetachUserPolicy', 'AttachGroupPolicy', 'DetachGroupPolicy') | duration 12h | groupby @recipientAccountId, srcip | having count_col1>=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('DeleteGroupPolicy', 'DeleteRolePolicy', 'DeleteUserPolicy', 'PutGroupPolicy', 'PutRolePolicy', 'PutUserPolicy', 'CreatePolicy', 'DeletePolicy', 'CreatePolicyVersion', 'DeletePolicyVersion', 'AttachRolePolicy', 'DetachRolePolicy', 'AttachUserPolicy', 'DetachUserPolicy', 'AttachGroupPolicy', 'DetachGroupPolicy') and srcip='{SuspectHost}'

stream=* |  groupby stream, sourcename |  duration 15m

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('DisableKey', 'ScheduleKeyDeletion') and @resources.type='AWS::KMS::Key' | duration 1h | groupby @resources.ARN, eventname, srcip  | having count_col1>=1

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname in ('DisableKey', 'ScheduleKeyDeletion') and @resources.type='AWS::KMS::Key' and srcip='{SuspectHost}'

stream=gsuite where sourcename='G-SUITE' and name in ('account_disabled_generic','account_disabled_spamming_through_relay','account_disabled_spamming','account_disabled_hijacked') and app='login' and user='{SuspectUser}'

stream=gsuite where sourcename='G-SUITE' and name in ('account_disabled_generic','account_disabled_spamming_through_relay','account_disabled_spamming','account_disabled_hijacked') and app='login' | duration 1h | groupby user | having count_col1 >=1

stream=github where sourcename='GITHUB' and actiontaken='repo.create' and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken='repo.create' | groupby user

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Policies%Microsoft%Windows%PowerShell' and (commandline like '%EnableModuleLogging%' or commandline like '%EnableScriptBlockLogging%' or commandline like '%EnableTranscripting%' or commandline like '%EnableScripts%') and commandline like 'REG_DWORD%/d%0%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Policies%Microsoft%Windows%PowerShell' and (commandline like '%EnableModuleLogging%' or commandline like '%EnableScriptBlockLogging%' or commandline like '%EnableTranscripting%' or commandline like '%EnableScripts%') and commandline like 'REG_DWORD%/d%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=documents where sourcename='G-SUITE' and app='drive' and type='acl_change' and not user like '%acme.com%' and visibility='shared_externally' | duration 1h | groupby user | having count_col1 >=1

stream=documents where sourcename='G-SUITE' and app='drive' and type='acl_change' and not user like '%acme.com%' and visibility='shared_externally' user='{SuspectUser}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventsource='iam.amazonaws.com' and (eventname like 'Add' or eventname like 'Attach' or eventname like 'Change' or eventname like 'Create' or eventname like 'Deactivate' or eventname like 'Delete' or eventname like 'Detach' or eventname like 'Enable' or eventname like 'Put' or eventname like 'Remove' or eventname like 'Set' or eventname like 'Update' or eventname like 'Upload') and srcip='{SuspectHost}'

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventsource='iam.amazonaws.com' and (eventname like 'Add' or eventname like 'Attach' or eventname like 'Change' or eventname like 'Create' or eventname like 'Deactivate' or eventname like 'Delete' or eventname like 'Detach' or eventname like 'Enable' or eventname like 'Put' or eventname like 'Remove' or eventname like 'Set' or eventname like 'Update' or eventname like 'Upload') | duration 12h | groupby srcip | having count_col1>= 1

stream=iam where sourcename='GITHUB' and actiontaken='USER_UPDATED' and user='{SuspectUser}'

stream=iam where sourcename='GITHUB' and action='USER_UPDATED' | duration 1h | groupby user | having count_col1 >=1

stream=duo where actiontaken='bypass_view' and user='{SuspectUser}'

stream=duo where actiontaken='bypass_view' | duration 1h | groupby user | having count_col1>=1

stream=okta where eventtype='user.account.report_suspicious_activity_by_enduser' and user='{SuspectUser}'

stream=okta where eventtype='user.account.report_suspicious_activity_by_enduser' | duration 1h | groupby user | having count_col1 >=1

stream=firewall where sourcetype='FIREWALL' and dstport in ('1604','1970','5800','5931','31337','12345') and not dstcn in ('-','IN') and not actiontaken in ('close','deny') | groupby srcip

stream=firewall where sourcetype='FIREWALL' and dstport in ('1604','1970','5800','5931','31337','12345') and not dstcn in ('-','IN') and not actiontaken in ('close','deny') and srcip='{SuspectHost}'

stream=slack where sourcename='SLACK' and actiontaken='organization_created' and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=slack where sourcename='SLACK' and actiontaken='organization_created' |  groupby user, srcip

stream=github where sourcename='GITHUB' and actiontaken='repo.create' and visibility='public' and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken='repo.create' and visibility='public' | duration 1h | groupby user | having count_col1>=1

stream=calendar where sourcename='G-SUITE' and @name='change_calendar_acls' and @parameters.grantee_email='__public_principal__@public.calendar.google.com' | duration 1h | groupby user | having count_col1>=1

stream=calendar where sourcename='G-SUITE' and @name='change_calendar_acls' and @parameters.grantee_email='__public_principal__@public.calendar.google.com' and user='{SuspectUser}'

stream=slack where sourcename='SLACK' and actiontaken='intune_disabled' and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=slack where sourcename='SLACK' and actiontaken='intune_disabled' |  groupby user, srcip

stream=slack where sourcename='SLACK' and actiontaken='ekm_slackbot_unenroll_notification_sent' and user='{SuspectUser}'

stream=slack where sourcename='SLACK' and actiontaken='ekm_slackbot_unenroll_notification_sent' | groupby user

stream=firewall where sourcename='FORTIGATE' and action='PACKET_ALLOWED' and status='PASSED' and proto='TCP' and srcip='{SuspectHost}'

stream=firewall where sourcename='FORTIGATE' and action='PACKET_ALLOWED' and status='PASSED' and proto='TCP' | duration 1h | groupby srcip, devsrcip, dstport 

stream=gsuite where sourcename='G-SUITE' and app='login' and type='account_warning' and name in ('suspicious_login','suspicious_login_less_secure_app','suspicious_programmatic_login') | duration 1h | groupby user | having count_col1 >=1

stream=gsuite where sourcename='G-SUITE' and app='login' and type='account_warning' and name in ('suspicious_login','suspicious_login_less_secure_app','suspicious_programmatic_login') and user='{SuspectUser}'

stream=cloudtrail where domainname in ('retool.earnin.com','retool.dev.earnin.com') and domainname is not null and srcip='{SuspectHost}' and dstip='{TargetHost}'

stream=cloudtrail where domainname in ('retool.earnin.com','retool.dev.earnin.com') and domainname is not null | duration 1h | groupby srcip, dstip | having count_col1 >=1

stream=duo where actiontaken='admin_lockout' and user='{SuspectUser}'

stream=duo where actiontaken='admin_lockout' | duration 15m | groupby user | having count_col1>=1

stream=github where sourcename='GITHUB' and actiontaken='git.push' | groupby user

stream=github where sourcename='GITHUB' and actiontaken='git.push' and user='{SuspectUser}'

stream=slack where sourcename='SLACK' and actiontaken in ('app_scopes_expanded','app_resources_added','app_resources_granted','bot_token_upgraded') | groupby user, targetworkspace

stream=slack where actiontaken in ('app_scopes_expanded','app_resources_added','app_resources_granted','bot_token_upgraded') and user='{SuspectUser}' and targetworkspace='{TargetResource}'

stream=ep-process where eid='1' and (commandline like '%Get-History%' or  commandline like '%AppData%Roaming%Microsoft%Windows%PowerShell%PSReadline%ConsoleHost_history.txt%' or commandline like '%Get-PSReadlineOption.HistorySavePath%') | groupby user, hash, commandline, system 

stream=ep-process where eid='1' and (commandline like '%Get-History%' or  commandline like '%AppData%Roaming%Microsoft%Windows%PowerShell%PSReadline%ConsoleHost_history.txt%' or commandline like '%Get-PSReadlineOption.HistorySavePath%') 

stream=github where sourcename='GITHUB' and actiontaken in ('org.add_member','org.remove_member') and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken in ('org.add_member','org.remove_member') | duration 1h | groupby user | having count_col1>=1

stream=github where sourcename='GITHUB' and actiontaken='protected_branch.policy_override' and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken='protected_branch.policy_override' | duration 1h | groupby user | having count_col1 >=1

stream=slack where sourcename='SLACK' and actiontaken='app_installed' and srcip='{SuspectHost}' and user='{SuspectUser}'

stream=slack where sourcename='SLACK' and actiontaken='app_installed' | groupby user, srcip, app

stream=okta where eventype='system.api_token.revoke' and outcome.result='SUCCESS' and user='{SuspectUser}'

stream=okta where eventype='system.api_token.revoke' and @outcome.result='SUCCESS' | duration 1h | groupby user | having count_col1 >=1

stream=EP-PROCESS where action='PROCESS_ADDED' and (image like '%netsh.exe%' or image like '%powershell.exe%' or image like '%cmd.exe%') and (commandline like 'netsh%advfirewall%set%currentprofile%state%off%' or commandline like '%powershell.exe%Command%Disable-NetFirewallRule%All%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (image like '%netsh.exe%' or image like '%powershell.exe%' or image like '%cmd.exe%') and (commandline like 'netsh%advfirewall%set%currentprofile%state%off%' or commandline like '%powershell.exe%Command%Disable-NetFirewallRule%All%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe -Version%' or parentcommandline like '%powershell.exe -Version%') and user='{SuspectUser}' and system='{TargetHost}' | duration 5m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe -Version%' or parentcommandline like '%powershell.exe -Version%') | groupby user, system

stream=slack where sourcename='SLACK' and actiontaken='ekm_unenrolled' |  groupby srcip, user

stream=slack where sourcename='SLACK' and actiontaken='ekm_unenrolled' and srcip='{SuspectHost}' and user='{SuspectUser}'

stream=CONFIGURATION where sourcename='FORTIGATE' and action='CONFIGURATION_CHANGED' and status='PASSED' |  groupby user

stream=CONFIGURATION where sourcename='FORTIGATE' and action='CONFIGURATION_CHANGED' and status='PASSED' and user='{SuspectUser}'

stream=authentication where sourcename='FORTIGATE' and action='LOGIN' and status='PASSED' | groupby user, system 

stream=authentication where sourcename='FORTIGATE' and action='LOGIN' and status='PASSED' and user='{SuspectUser}'

stream=cloudtrail where usergroup="Root" and not eventtype="AwsServiceEvent" and user='{SuspectUser}'

stream=cloudtrail where usergroup="Root" and not eventtype="AwsServiceEvent" | duration 1h | groupby user | having count_col1>=1

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline),"(stop\-service|start\-service).*?\-name") | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline),"(stop\-service|start\-service).*?\-name") and user='{SuspectUser}' and system='{TragetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell%exe%New-ItemProperty%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%Name%EnableFirewall%PropertyType%DWORD%Value%0%' or commandline like '%powershell%exe%New-ItemProperty%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%Name%EnableFirewall%PropertyType%DWORD%Value%0%' | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell%exe%New-ItemProperty%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%Name%EnableFirewall%PropertyType%DWORD%Value%0%' or commandline like '%powershell%exe%New-ItemProperty%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%Name%EnableFirewall%PropertyType%DWORD%Value%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=slack where sourcename='SLACK' and actiontaken='ekm_logging_config_set' |  groupby user, targetworkspace, srcip

stream=slack where sourcename='SLACK' and actiontaken='ekm_logging_config_set' and targetworkspace='{TargetResource}' and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=firewall | limit 1

stream=duo where actiontaken='integration_skey_view' | duration 1h |  groupby user | having count_col1 >=1

stream=duo where actiontaken='integration_skey_view' and user='{SuspectUser}'

stream=email-gateway where sourcename='G-SUITE' and @id.applicationName='user_accounts' and @name='email_forwarding_out_of_domain' and not recipient like '%example.com' and user='{SuspectUser}'

stream=email-gateway where sourcename='G-SUITE' and @id.applicationName='user_accounts' and @name='email_forwarding_out_of_domain' and not recipient like '%example.com' | duration 1h | groupby user | having count_col1>=1

stream=duo where reason='bypass_user' and result='success' | duration 5m | groupby user | having count_col1>=1

stream=duo where reason='bypass_user' and result='success' and user='{SuspectUser}'

stream=firewall where sourcename='FORTIGATE' and sourcetype='FIREWALL' and not srccn='-' and not dstcn='-' and action='PACKET_BLOCKED' and status='PASSED' and not srcip like '172.32.%' and @action='deny' and srcip='{SuspectHost}'

stream=firewall where sourcename='FORTIGATE' and sourcetype='FIREWALL' and not srccn='-' and not dstcn='-' and action='PACKET_BLOCKED' and status='PASSED' and not srcip like '172.32.%' and @action='deny'| groupby srcip 

stream=slack where sourcename='SLACK' and actiontaken='legal_hold_policy_updated' and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=slack where sourcename='SLACK' and actiontaken='legal_hold_policy_updated' | groupby user, srcip

stream=iam where sourcename='STRONGDM' and action='PRIVILEGE_CHANGED' and user='{SuspectUser}'

stream=iam where sourcename='STRONGDM' and action='PRIVILEGE_CHANGED' | duration 15m |  groupby user | having count_col1 >=1

stream=authentication where action='LOGIN' and status='FAILED' and reason in ('endpoint_is_not_in_management_system', 'endpoint_failed_google_verification', 'endpoint_is_not_trusted', 'could_not_determine_if_endpoint_was_trusted', 'invalid_device') | duration 15m | groupby user | having count_col1>=1

stream=authentication where action='LOGIN' and status='FAILED' and reason in ('endpoint_is_not_in_management_system', 'endpoint_failed_google_verification', 'endpoint_is_not_trusted', 'could_not_determine_if_endpoint_was_trusted', 'invalid_device') and user='{SuspectUser}'

stream=authentication where sourcename='FORTIGATE' and action='LOGIN' and status='FAILED' and reason='exceed_limit' | duration 15m | groupby srcip 

stream=authentication where sourcename='FORTIGATE' and action='LOGIN' and status='FAILED' and reason='exceed_limit'

stream=slack where sourcename='SLACK' and actiontaken='pref.sso_setting_changed' |  groupby user, targetworkspace, srcip

stream=slack where sourcename='SLACK' and actiontaken='pref.sso_setting_changed' and user='{SuspectUser}' and targetworkspace='{TargetResource}' and srcip='{SuspectHost}'

stream=github where sourcename='GITHUB' and actiontaken='integration_installation.create' and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken='integration_installation.create' | duration 1h | groupby user | having count_col1 >=1

stream=zendesk where @source_type='user_setting' and actiontaken=('create', 'update') and change_description='suspended' | duration 1h | groupby user | having count_col1>=1

stream=zendesk where @source_type='user_setting' and actiontaken=('create', 'update') and change_description='suspended' and user='{SuspectUser}'

stream=sysmon-process where action='PROCESS_ADDED' rlike(image,'dwm.exe|explorer.exe|winlogon.exe|csrss.exe|PresentationHost.exe|dllhost.exe|ppldump.exe') and (commandline like '%.py' or commandline like '%.bat' or commandline like '%.cmd' or commandline like '%.ps1' or commandline like '%.pl' or commandline like '%.rb' or commandline like '%.java' or commandline like '%.jar' or commandline like '%.cpp' or commandline like '%.dll') and user='{SuspectUser}' and system='{TargetSystem}'

stream=sysmon-process where action='PROCESS_ADDED' rlike(image,'dwm.exe|explorer.exe|winlogon.exe|csrss.exe|PresentationHost.exe|dllhost.exe|ppldump.exe') and (commandline like '%.py' or commandline like '%.bat' or commandline like '%.cmd' or commandline like '%.ps1' or commandline like '%.pl' or commandline like '%.rb' or commandline like '%.java' or commandline like '%.jar' or commandline like '%.cpp' or commandline like '%.dll') |  groupby user, system

stream=cloudtrail where eventsource="rds.amazonaws.com" and @responseElements.pendingModifiedValues.masterUserPassword is not null and eventname="ModifyDBInstance" and user='{SuspectUser}'

stream=cloudtrail where eventsource="rds.amazonaws.com" and @responseElements.pendingModifiedValues.masterUserPassword is not null and eventname="ModifyDBInstance" | duration 1h | groupby user | having count_col1 >=1

stream=gcp where @protoPayload.methodName='SetIamPolicy' and rlike (logname,'(?:(organizations|folder).*/logs/cloudaudit.googleapis.com%2Factivity)') | duration 24h | groupby user | having count_col1 >=1

stream=gcp where @protoPayload.methodName='SetIamPolicy' and rlike (logname,'(?:(organizations|folder).*/logs/cloudaudit.googleapis.com%2Factivity)') and user='{SuspectUser}'

stream=threat where @action='THREAT_DETECTED' and activitytype in ('19', '4108', '4003', '4109') and user='{SuspectUser}'

stream=threat where action='THREAT_DETECTED' and activitytype in ('19', '4108', '4003', '4109') | duration 1h | groupby user | having count_col1>=1

stream=gsuite where sourcename='G-SUITE' and app='login' and name='gov_attack_warning' and user='{SuspectUser}'

stream=gsuite where sourcename='G-SUITE' and app='login' and name='gov_attack_warning' | duration 1h | groupby user | having count_col1>=1

stream=gsuite where sourcename='G-SUITE' and app='rules' and @parameters.severity='HIGH' and user='{SuspectUser}'

stream=gsuite where sourcename='G-SUITE' and app='rules' and @parameters.severity='HIGH' | duration 1h | groupby user | having count_col1>=1

stream=WEBFILTER | groupby category, srcip

stream=zoom where actiontaken like '%Update' and category_type='User' and operation_detail like 'Change Role%' and user='{SuspectUser}'

stream=zoom where actiontaken like '%Update' and category_type='User' and operation_detail like 'Change Role%' | duration 1h | groupby user | having count_col1>=1

stream=threat where action='THREAT_DETECTED' and activitytype='3608' | duration 1h | groupby user | having count_col1>=1

stream=threat where @action='THREAT_DETECTED' and activitytype='3608' and user='{SuspectUser}'

stream=EMAIL-GATEWAY where sourcename='MS-O365' and operation in ('Set-Mailbox', 'New-InboxRule') and (paramname='ForwardingSmtpAddress' or paramname='ForwardTo') and user='{SuspectUser}' 

stream=CONFIGURATION where sourcename='MS-O365' and config in ('Set-Mailbox', 'New-InboxRule') and (paramname='ForwardingSmtpAddress' or paramname='ForwardTo') | duration 1h | groupby user, domain | having count_col1 >=1

stream=gsuite where sourcename='G-SUITE' and Role='mobile' and @name='DEVICE_COMPROMISED_EVENT' and @parameters.DEVICE_COMPROMISED_STATE='COMPROMISED' | duration 1h | groupby user | having count_col1 >=1

stream=gsuite where sourcename='G-SUITE' and Role='mobile' and @name='DEVICE_COMPROMISED_EVENT' and @parameters.DEVICE_COMPROMISED_STATE='COMPROMISED' and user='{SuspectUser}'

stream=authentication where @action='2FA_TOKEN_MODIFIED' and @eventtype='user.mfa.factor.suspend' and user='{SuspectUser}'

stream=authentication where action='2FA_TOKEN_MODIFIED' and @eventtype='user.mfa.factor.suspend' | duration 1h | groupby user | having count_col1 >=1

stream=okta where eventtype in ('app.oauth2.as.token.detect_reuse', 'app.oauth2.token.detect_reuse') and user='{SuspectUser}'

stream=okta where eventtype in ('app.oauth2.as.token.detect_reuse', 'app.oauth2.token.detect_reuse') | duration 1h | groupby user | having count_col1 >=1

stream=authentication where sourcename='G-SUITE' and action='2FA_TOKEN_MODIFIED' and @id.applicationName='user_accounts' and @type='2sv_change' and @name='2sv_disable' and user='{SuspectUser}'

stream=authentication where sourcename='G-SUITE' and action='2FA_TOKEN_MODIFIED' and @id.applicationName='user_accounts' and @type='2sv_change' and @name='2sv_disable' | duration 1h | groupby user | having count_col1>=1

stream=gsuite where sourcename='G-SUITE' and app='rules' and @parameters.severity='LOW' user='{SuspectUser}'

stream=gsuite where sourcename='G-SUITE' and app='rules' and @parameters.severity='LOW' | duration 1h | groupby user | having count_col1>=1

stream=calendar where sourcename='G-SUITE' and @name='CHANGE_CALENDAR_SETTING' and @parameters.SETTING_NAME='SHARING_OUTSIDE_DOMAIN' and value in ('READ_WRITE_ACCESS', 'READ_ONLY_ACCESS', 'MANAGE_ACCESS')  | duration 1h | groupby user | having count_col1>=

stream=calendar where sourcename='G-SUITE' and @name='CHANGE_CALENDAR_SETTING' and @parameters.SETTING_NAME='SHARING_OUTSIDE_DOMAIN' and value in ('READ_WRITE_ACCESS', 'READ_ONLY_ACCESS', 'MANAGE_ACCESS')  and user='{SuspectUser}'

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableCMD") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableCMD") and user='{SuspectUser}' and system='{SuspectHost}' | duration 6m

stream=cloudtrail where eventsource="iam.amazonaws.com" and eventname="CreateAccessKey" and user='{SuspectUser}'

stream=cloudtrail where eventsource="iam.amazonaws.com" and eventname="CreateAccessKey" | select userarn, user, @responseElements.accessKey.userName as responseUser | groupby userarn, user, @responseElements.accessKey.userName | duration 1h

stream=cloudtrail where eventSource="rds.amazonaws.com" and @responseElements.publiclyAccessible="true" and eventname="RestoreDBInstanceFromDBSnapshot" | duration 1h | groupby user | having count_col1>=1

stream=cloudtrail where eventSource="rds.amazonaws.com" and @responseElements.publiclyAccessible="true" and eventname="RestoreDBInstanceFromDBSnapshot" and user='{SuspectUser}'

stream=win-audit where action='DIRECTORY_SERVICE_ACCESSED' and event='A directory service object was modified.' | groupby user, system | limit 10

stream=authentication where sourcename='DUO' and action='LOGIN' and status='FAILED' and reason='anomalous_push' and user='{SuspectUser}'

stream=authentication where sourcename='DUO' and action='LOGIN' and status='FAILED' and reason='anomalous_push' | duration 15m | groupby user | having count_col1 >=1

stream=gsuite where sourcename='G-SUITE' and @parameters.SETTING_NAME='ENABLE_G_SUITE_MARKETPLACE' and user='{SuspectUser}'

stream=gsuite where sourcename='G-SUITE' and @parameters.SETTING_NAME='ENABLE_G_SUITE_MARKETPLACE' | duration 1h | groupby user, @parameters.NEW_VALUE, @parameters.OLD_VALUE | having count_col1 >=1

stream=gsuite where sourcename='G-SUITE' and type='EMAIL_SETTINGS' and name='_GMAIL_SETTING' and @parameters.SETTING_NAME='MESSAGE_SECURITY_RULE' | duration 1h | groupby user | having count_col1>=1

stream=gsuite where sourcename='G-SUITE' and type='EMAIL_SETTINGS' and name='_GMAIL_SETTING' and @parameters.SETTING_NAME='MESSAGE_SECURITY_RULE' and user='{SuspectUser}'

stream=gsuite where sourcename='G-SUITE' and action='CALENDAR_SETTING_CHANGE' and status='PASSED' and @name='CHANGE_APPLICATION_SETTING' and @parameters.APPLICATION_NAME='gmail' and @parameters.NEW_VALUE='true' and @parameters.SETTING_NAME='DelayedDeliverySettingsProto disable_delayed_delivery_for_suspicious_email' | duration 1h | groupby user | having count_col1 >=1

stream=calendar where sourcename='G-SUITE' and action='CALENDAR_SETTING_CHANGE' and status='PASSED' and @name='CHANGE_APPLICATION_SETTING' and @parameters.APPLICATION_NAME='gmail' and @parameters.NEW_VALUE='true' and @parameters.SETTING_NAME='DelayedDeliverySettingsProto disable_delayed_delivery_for_suspicious_email' and user='{SuspectUser}'

stream=okta where eventtype in ('app.oauth2.client_id_rate_limit_warning', 'application.integration.rate_limit_exceeded', 'system.client.concurrency_rate_limit.notification', 'system.operation.rate_limit.*', 'system.org.rate_limit.*') | duration 1h | groupby user | having count_col1 >=1

stream=okta where eventtype in ('app.oauth2.client_id_rate_limit_warning', 'application.integration.rate_limit_exceeded', 'system.client.concurrency_rate_limit.notification', 'system.operation.rate_limit.*', 'system.org.rate_limit.*') and user='{SuspectUser}'

stream=gsuite where sourcename='G-SUITE' and name='CHANGE_APPLICATION_SETTING' and type='APPLICATION_SETTINGS' and @parameters.NEW_VALUE='true' and @parameters.SETTING_NAME='Password Management - Enable password reuse' | duration 1h | groupby user | having count_col1>=1

stream=gsuite where sourcename='G-SUITE' and name='CHANGE_APPLICATION_SETTING' and type='APPLICATION_SETTINGS' and @parameters.NEW_VALUE='true' and @parameters.SETTING_NAME='Password Management - Enable password reuse' user='{SuspectUser}'

stream=win-audit where action='DIRECTORY_SERVICE_ACCESSED' and event='A directory service object was created.' | groupby user, system | limit 10

stream=gsuite where sourcename='G-SUITE' and name='CHANGE_APPLICATION_SETTING' and @parameters.APPLICATION_NAME='gmail' and @parameters.NEW_VALUE='false' and @parameters.SETTING_NAME='AttachmentDeepScanningSettingsProto deep_scanning_enabled' | duration 1h | groupby user | having count_col1>=1

stream=gsuite where sourcename='G-SUITE' and name='CHANGE_APPLICATION_SETTING' and @parameters.APPLICATION_NAME='gmail' and @parameters.NEW_VALUE='false' and @parameters.SETTING_NAME='AttachmentDeepScanningSettingsProto deep_scanning_enabled' and user='{SuspectUser}'

stream=gsuite where sourcename='G-SUITE' and app='admin' and name='CHANGE_APPLICATION_SETTING' and type='APPLICATION_SETTINGS' and @parameters.NEW_VALUE='off' and @parameters.SETTING_NAME='Password Management - Enforce strong password' and user='{SuspectUser}'

stream=gsuite where sourcename='G-SUITE' and app='admin' and name='CHANGE_APPLICATION_SETTING' and type='APPLICATION_SETTINGS' and @parameters.NEW_VALUE='off' and @parameters.SETTING_NAME='Password Management - Enforce strong password' | duration 1h | groupby user | having count_col1 >=1

stream=microsoft-graph where @status='newAlert' and user='{SuspectUser}'

stream=microsoft-graph where @status='newAlert' | duration 2d | groupby user | having count_col1>=1

stream=gsuite where sourcename='G-SUITE' and app='drive' and type='access' and name in ('create','move','upload','edit') and visibility in ('people_with_link','public_on_the_web') and user='{SuspectUser}'

stream=gsuite where sourcename='G-SUITE' and app='drive' and type='access' and name in ('create','move','upload','edit') and visibility in ('people_with_link','public_on_the_web') | duration 1h | groupby user | having count_col1 >=1 

stream=iam where action='ROLE_ADDED' and @eventtype='group.privilege.grant' | duration 1h | groupby user | having count_col1 >=1

stream=iam where @action='ROLE_ADDED' and @eventtype='group.privilege.grant' and user='{SuspectUser}'

stream=threat where sourceServiceName="Endpoint Removable Media" and sourcename="FORCEPOINT-DLP" and severityType="HIGH" and user='{SuspectUser}'

stream=threat where sourceServiceName="Endpoint Removable Media" and sourcename="FORCEPOINT-DLP" and severityType="HIGH" | groupby user, system 

stream=authentication where @action='2FA_TOKEN_MODIFIED' and @eventtype='ADMIN_MFA_DISABLED' and user='{SuspectUser}'

stream=authentication where action='2FA_TOKEN_MODIFIED' and @eventtype='ADMIN_MFA_DISABLED' | duration 1h | groupby user | having count_col1 >=1

stream=cloudtrail where eventname IN ("ArchiveFindings", "CreateFindingsFilter", "DeleteMember", "DisassociateFromMasterAccount", "DisassociateMember", "DisableMacie", "DisableOrganizationAdminAccount", "UpdateFindingsFilter", "UpdateMacieSession", "UpdateMemberSession", "UpdateClassificationJob") and user='{SuspectUser}'

stream=cloudtrail where eventname IN ("ArchiveFindings", "CreateFindingsFilter", "DeleteMember", "DisassociateFromMasterAccount", "DisassociateMember", "DisableMacie", "DisableOrganizationAdminAccount", "UpdateFindingsFilter", "UpdateMacieSession", "UpdateMemberSession", "UpdateClassificationJob") | select userarn, user, count(*) as count_col | groupby user | having count_col1> 5 | duration 1h

stream=authentication where action='LOGIN' and @eventtype='app.generic.unauth_app_access_attempt' | duration 1h | groupby user | having count_col1 >=5

stream=authentication where @action='LOGIN' and @eventtype='app.generic.unauth_app_access_attempt' and user='{SuspectUser}'

stream=authentication where sourcename='MS-O365' and action='LOGIN' and status='FAILED' and @Operation='UserLoginFailed' | duration 1h | groupby user | having count_col1 >=1

stream=authentication where sourcename='MS-O365' and action='LOGIN' and status='FAILED' and @Operation='UserLoginFailed' | duration 1h | groupby user | having count_col1 >=1 and user='{SuspectUser}'

stream=win-audit where action='DIRECTORY_SERVICE_ACCESSED' and event='A directory service object was moved.' | groupby user, system | limit 10

stream=gsuite where sourcename='G-SUITE' and type='DOMAIN_SETTINGS' and name like '%_TRUSTED_DOMAINS' and user='{SuspectUser}'

stream=gsuite where sourcename='G-SUITE' and type='DOMAIN_SETTINGS' and name like '%_TRUSTED_DOMAINS' | duration 1h | groupby user | having count_col1 >=1

stream=iam where action='MOVE_DEVICE_TO_ORG_UNIT_DETAILED' and role='admin' and @type='CHROME_OS_SETTINGS' | duration 1h | groupby user | having count_col1 >=1

stream=iam where action='MOVE_DEVICE_TO_ORG_UNIT_DETAILED' and role='admin' and @type='CHROME_OS_SETTINGS' and user='{SuspectUser}'

stream=* | duration 1h | groupby srcip, hash | having count_col1 >=1

stream=ioc where srcip='{SuspectHost}'

stream=panther where event_type='USER_ACCOUNT_MODIFIED' and actionResult='SUCCEEDED' and user='{SuspectUser}'

stream=panther where event_type='USER_ACCOUNT_MODIFIED' and actionResult='SUCCEEDED' | duration 1h | groupby user | having count_col1>=1

stream=cloudtrail where eventsource="securityhub.amazonaws.com" and eventname in ("BatchUpdateFindings", "DeleteInsight", "UpdateFindings", "UpdateInsight") and user='{SuspectUser}'

stream=cloudtrail where eventsource="securityhub.amazonaws.com" and eventname in ("BatchUpdateFindings", "DeleteInsight", "UpdateFindings", "UpdateInsight") | duration 1h | groupby user | having count_col1>=1

stream=ioc where domain like '%.com' and srcip='{SuspectHost}'

stream=ioc where domain like '%.com' | duration 1h | groupby srcip | having count_col1 >=1

stream=gsuite where sourcename='G-SUITE' and name like 'CUSTOMER_TAKEOUT_%' and user='{SuspectUser}'

stream=gsuite where sourcename='G-SUITE' and name like 'CUSTOMER_TAKEOUT_%' | duration 1h | groupby user | having count_col1 >=1

stream=cloudtrail where eventsource="ec2.amazonaws.com" and eventname="ModifySnapshotAttribute" and user='{SuspectUser}'

stream=cloudtrail where eventsource="ec2.amazonaws.com" and eventname="ModifySnapshotAttribute" | duration 1h | groupby user | having count_col1>=1

stream=gsuite where sourcename='G-SUITE' and @name='CREATE_APPLICATION_SETTING' and  @parameters.SETTING_NAME='Advanced Protection Program Settings' and user='{SuspectUser}'

stream=gsuite where sourcename='G-SUITE' and @name='CREATE_APPLICATION_SETTING' and  @parameters.SETTING_NAME='Advanced Protection Program Settings' | duration 1h | groupby user | having count_col1 >=1

stream=win-audit where action='DIRECTORY_SERVICE_ACCESSED' and event='A directory service object was deleted.' | groupby user, system | limit 10

stream=iam where @action='USER_LOCKED' and eventtype in ('user.account.lock', 'user.account.lock.limit') and user='{SuspectUser}'

stream=iam where action='USER_LOCKED' and eventtype in ('user.account.lock', 'user.account.lock.limit') | duration 1h | groupby user | having count_col1 >=1 

stream=zendesk where @sourcetype='account_setting' and actiontaken in ('create', 'destroy') and sourcelabel='Credit Card Redaction' | duration 1h | groupby user | having count_col1>=1

stream=zendesk where @sourcetype='account_setting' and action in ('create', 'destroy') and sourcelabel='Credit Card Redaction' and user='{SuspectUser}'

stream=okta where @eventype='user.session.start' and not @outcome.result='FAILURE' and not @client.geographicalContext.city='null' and not @client.geographicalContext.geolocation.lon='null' and not @client.geographicalContext.geolocation.lat='null' and user='{SuspectUser}'

stream=authentication where @eventype='user.session.start' and not @outcome.result='FAILURE' and not @client.geographicalContext.city='null' and not @client.geographicalContext.geolocation.lon='null' and not @client.geographicalContext.geolocation.lat='null' | select user, distinct_count(srccn) as srccn_cnt | groupby user | duration 1h | having srccn_cnt >=2

stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%network_telnet_access%" |  groupby srcip


stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%network_telnet_access%" and srcip='{SuspectHost}'

stream=authentication where user='{SuspectUser}' and system='{TargetSystem}' 

stream=authentication |  select user, system, distinct_count(action) as action_cnt |  groupby user, system, action |  having action_cnt > 2

stream=threat where action='THREAT_DETECTED' and @eventtype='security.threat.detected' | duration 1h | groupby user | having count_col1 >=1

stream=threat where @action='THREAT_DETECTED' and @eventtype='security.threat.detected' and user='{SuspectUser}'

stream=authentication where @SubjectDomainName is not null | groupby @SubjectDomainName | limit 1

stream=authentication where @SubjectDomainName='{SuspectUser}'

stream=zendesk where @sourcetype='account_setting' and action in ('create', 'update') and sourcelabel='account assumption' and sourcelabel='assumption duration' and user='{SuspectUser}'

stream=zendesk where @sourcetype='account_setting' and action in ('create', 'update') and (sourcelabel='account assumption' or sourcelabel='assumption duration') | duration 1h | groupby user | having count_col1 >=1

stream=authentication where actiontaken='admin_2fa_error' and rlike (error, '.*fraudulent.*') | duration 15m | groupby user | having count_col1 >=1

stream=authentication where actiontaken='admin_2fa_error' and rlike (error, '.*fraudulent.*') and user='{SuspectUser}'

stream=iam where action='PRIVILEGE_CHANGED' and (type like '%admin%' or type like 'admin%') and user='{SuspectUser}'

stream=iam where action='PRIVILEGE_CHANGED' and (type like '%admin%' or type like 'admin%') |  groupby user | duration 1h | having count_col1 >=1

stream=github where sourcename='GITHUB' and actiontaken='public_key.create' and not user='robbfoster-earnin' and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken='public_key.create' and not user='robbfoster-earnin'| duration 1h | groupby user | having count_col1 >=1

stream=authentication where action='LOGIN' and status='PASSED' | groupby user, srcip | limit 100

stream=iam where action='update' and @sourcetype='account' and change_description like 'Owner changed from%' and srcip='{SuspectHost}'


stream=iam where action='update' and @sourcetype='account' and change_description like 'Owner changed from%' | duration 1h | groupby srcip | having count_col1>=1

stream=gsuite where sourcename='G-SUITE' and app='mobile' and name='SUSPICIOUS_ACTIVITY_EVENT' | duration 1h | groupby user | having count_col1>=1

stream=gsuite where sourcename='G-SUITE' and app='mobile' and name='SUSPICIOUS_ACTIVITY_EVENT' and user='{SuspectUser}'

stream=duo where actiontaken='bypass_create' and user='{SuspectUser}'

stream=duo where actiontaken='bypass_create' | duration 1h | groupby user | having count_col1>=1

stream=ep-file where eid='11' and action='FILE_CREATED' and (targetfilename like '%.CRYPTEDPAY' or targetfilename like '%.chaos') |  groupby user, targetfilename, system

stream=authentication where action='LOGIN' and srcip='{SuspectUser}'

stream=authentication where action='LOGIN' | select srcip, system, count_if(status='FAILED') as FailCount, count_if(status='PASSED') as PassCount | groupby system, srcip | duration 1h | having FailCount>=50 | limit 100

stream=gsuite where sourcename='G-SUITE' and @name='ADD_APPLICATION' and @parameters.APPLICATION_ENABLED='true' and user='{SuspectUser}'

stream=gsuite where sourcename='G-SUITE' and @name='ADD_APPLICATION' and  @parameters.APPLICATION_ENABLED='true' | duration 1h | groupby user | having count_col1 >=1

stream=gsuite where sourcename='G-SUITE' and app='drive' and name in ('change_user_access_hierarchy_reconciled','change_document_access_scope_hierarchy_reconciled') and type='acl_change' and actionperfomed='change_document_visibility' and not newvalue='private' and not targetdomain like '%example.com' and visibility in ('people_with_link','people_within_domain_with_link','public_on_the_web','shared_externally','unknown') | duration 1h | groupby user | having count_col1 >=1 

stream=gsuite where sourcename='G-SUITE' and app='drive' and name in ('change_user_access_hierarchy_reconciled','change_document_access_scope_hierarchy_reconciled') and type='acl_change' and actionperfomed='change_document_visibility' and not newvalue='private' and not targetdomain like '%example.com' and visibility in ('people_with_link','people_within_domain_with_link','public_on_the_web','shared_externally','unknown') and user='{SuspectUser}'

stream=authentication where action='LOGIN' and status='FAILED' |  groupby user,system 

stream=authentication where action='LOGIN' and status='FAILED' and user='{SuspectUser}' and system='{TargetHost}' | duration 10m

stream=authentication where sourcename='WINDOWS' and action='LOGIN' and status='PASSED' and user='{SuspectUser}'

stream=authentication where sourcename='WINDOWS' and action='LOGIN' and status='PASSED' | duration 30m | select user, count(action) as login_cnt |  groupby user | having login_cnt > 50

stream=auditd where sourcename='NIX' and action='USER_COMMAND_EXECUTED' and status='PASSED' and rlike(cmd,".*wget.*") | groupby user | limit 10

stream=auditd where sourcename='NIX' and action='USER_COMMAND_EXECUTED' and status='PASSED' and rlike(cmd,".*wget.*") and user='{SuspectUser}'

stream=ep-file where eid='11' and action='FILE_CREATED' and (targetfilename like '%.CRYPTEDPAY' or targetfilename like '%.chaos') |  groupby user, targetfilename, system

stream=gsuite where sourcename='G-SUITE' and @name='ADD_MOBILE_APPLICATION_TO_WHITELIST' and user='{SuspectUser}'

stream=gsuite where sourcename='G-SUITE' and @name='ADD_MOBILE_APPLICATION_TO_WHITELIST' | duration 1h | groupby user | having count_col1>=1

stream=firewall where sourcename='FORTIGATE' and sourcetype='FIREWALL' and action='PACKET_BLOCKED' and status='PASSED' and not (srcip like '103.81.88.%' or srcip like '10.%' or srcip like '172.32.%' or srcip like '103.81.90.%') and @action='deny' | groupby srcip 

stream=firewall where sourcename='FORTIGATE' and sourcetype='FIREWALL' and action='PACKET_BLOCKED' and status='PASSED' and not (srcip like '103.81.88.%' or srcip like '10.%' or srcip like '172.32.%' or srcip like '103.81.90.%') and @action='deny' and srcip='{SuspectHost}'

stream=ep-process where action='PROCESS_ADDED' and status='PASSED' and (image like '%clip.exe' or commandline like '%Get-Clipboard%' or commandline like '%Open-Clipboard%') and eid='1' and system='{TargetHost}' and user='{SuspectUser}'

stream=ep-process where action='PROCESS_ADDED' and status='PASSED' and (image like '%clip.exe' or commandline like '%Get-Clipboard%' or commandline like '%Open-Clipboard%') and eid='1' | select system, image, commandline, user | groupby system, image, commandline, user | duration 5m | limit 10

stream=webfilter where sourcename='CLOUDFLARE' and action='URL_BLOCKED' and status='PASSED' and rlike (requesturl,'\b((?:user\/|users\/|userId\=|savingsuser\/)[0-9]+)\b')i | duration 15m | groupby srcip | having count_col1 >=150

stream=webfilter where sourcename='CLOUDFLARE' and action='URL_BLOCKED' and status='PASSED' and rlike (requesturl,'\b((?:user\/|users\/|userId\=|savingsuser\/)[0-9]+)\b')i and srcip='{SuspectHost}'

stream=slack where sourcename='SLACK' and actiontaken in ('bulk_session_reset_by_admin', 'user_session_invalidated', 'user_session_reset_by_admin') and user='{SuspectUser}'

stream=slack where sourcename='SLACK' and actiontaken in ('bulk_session_reset_by_admin', 'user_session_invalidated', 'user_session_reset_by_admin') | duration 1h | groupby user | having count_col1>1

stream=authentication where action='2FA_TOKEN_MODIFIED' and @eventtype='user.mfa.factor.reset_all' | duration 1h | groupby user | having count_col1 >=1

stream=authentication where @action='2FA_TOKEN_MODIFIED' and @eventtype='user.mfa.factor.reset_all'  and user='{SuspectUser}'

stream=iam where sourcename='G-SUITE' and @type='DELEGATED_ADMIN_SETTINGS' and @name='CREATE_ROLE' | duration 1h | groupby user | having count_col1 >=1

stream=iam where sourcename='G-SUITE' and @type='DELEGATED_ADMIN_SETTINGS' and @name='CREATE_ROLE' and user='{SuspectUser}'

stream=threat where sourcename='MS-O365' and action='THREAT_DETECTED' and status='PASSED' and vector='HOST' and @Operation='FileMalwareDetected' and srcip='{SuspectHost}'

stream=threat where sourcename='MS-O365' and action='THREAT_DETECTED' and status='PASSED' and vector='HOST' and @Operation='FileMalwareDetected' | groupby srcip, file 

stream=threat where action='THREAT_DETECTED' and vector='HOST' and hash in ('1b1a9f4dc26e32684dd3bccb3dc563f1','34b6a1dda32742026b2dce1e75bf75ac','ce58d9e1741ca1f58f0880465ff4e322c9036293d2dba8947cd65e2153f070e4','bd6bf8005075ea1cc5d137bff7d8d4a30eec803e71f0bc6bcd274540433ec829','fdc2219b15b42db3d1626a0855059549a43e5920','aa8e6cad1588892cd63410a4036c325a6957041e') and user='{SuspectUser}' and system='{TargetHost}'

stream=threat where action='THREAT_DETECTED' and vector='HOST' and hash in ('1b1a9f4dc26e32684dd3bccb3dc563f1','34b6a1dda32742026b2dce1e75bf75ac','ce58d9e1741ca1f58f0880465ff4e322c9036293d2dba8947cd65e2153f070e4','bd6bf8005075ea1cc5d137bff7d8d4a30eec803e71f0bc6bcd274540433ec829','fdc2219b15b42db3d1626a0855059549a43e5920','aa8e6cad1588892cd63410a4036c325a6957041e') |  groupby user,system,hash

stream=okta where @eventType='application.user_membership.show_password' and user='{SuspectUser}'

stream=okta where @eventType='application.user_membership.show_password' | select @target[0].type[0] as targetuser, @target[1].type[1] as targetappname , actor.type as actortype, user | groupby targetuser, targetappname, actortype, user| duration 1h 

stream=webfilter where sourcename='CLOUDFLARE' and action='URL_BLOCKED' and status='PASSED' and rlike (ClientRequestURI,'\b((?:user\/|users\/|userId\=|savingsuser\/)[0-9]+)\b')i and srcip='{SuspectHost}'

stream=webfilter where sourcename='CLOUDFLARE' and action='URL_BLOCKED' and status='PASSED' and rlike (ClientRequestURI,'\b((?:user\/|users\/|userId\=|savingsuser\/)[0-9]+)\b')i | duration 15m | groupby srcip | having count_col1 >=150

stream=okta where @outcome.result='SUCCESS' and @eventType='user.session.start' and alternateid like '%ececonsultinggroup.com' and not alternateid in ('bodekirk@ececonsultinggroup.com','csidwell@ececonsultinggroup.com','jeremiah@ececonsultinggroup.com','juanpaolo@ececonsultinggroup.com','harvey@ececonsultinggroup.com','jovi@ececonsultinggroup.com','jsalcedo@ececonsultinggroup.com','janine@ececonsultinggroup.com') | duration 1h | groupby srcip | having count_col1 >=1

stream=okta where @outcome.result='SUCCESS' and @eventType='user.session.start' and alternateid like '%ececonsultinggroup.com' and not alternateid in ('bodekirk@ececonsultinggroup.com','csidwell@ececonsultinggroup.com','jeremiah@ececonsultinggroup.com','juanpaolo@ececonsultinggroup.com','harvey@ececonsultinggroup.com','jovi@ececonsultinggroup.com','jsalcedo@ececonsultinggroup.com','janine@ececonsultinggroup.com') and srcip='{SuspectHost}'

stream=documents where operation in ('AnonymousLinkCreated', 'AddedToSecureLink') and not (sourcerelativeurl like '%/External/%' or sourcerelativeurl like 'External/%') and user='{SuspectUser}'

stream=documents where operation in ('AnonymousLinkCreated', 'AddedToSecureLink') and not (sourcerelativeurl like '%/External/%' or sourcerelativeurl like 'External/%') | duration 1h | groupby user, targetuser | having count_col1 >=1

stream=threat where threat='ISSUE_DEVICE_COMMAND' and role='admin' and @type='CHROME_OS_SETTINGS' and user='{SuspectUser}'

stream=threat where threat='ISSUE_DEVICE_COMMAND' and role='admin' and @type='CHROME_OS_SETTINGS' | duration 1h | groupby user | having count_col1 >=1

stream=authentication where sourcename='SLACK' and action='2FA_TOKEN_MODIFIED' and status='FAILED' | groupby user

stream=authentication where sourcename='SLACK' and action='2FA_TOKEN_MODIFIED' and status='FAILED' and user='{SuspectUser}'

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline),"(stop\-service|start\-service).*?\-name") | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline),"(stop\-service|start\-service).*?\-name") and user="{SuspectUser}" and system="{TargetHost}" | duration 6m

stream=iam where sourcename='NIX' and action='PASSWORD_CHANGED' and status='PASSED' and user='root' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=iam where sourcename='NIX' and action='PASSWORD_CHANGED' and status='PASSED' and user='root' |  groupby user, targetuser | limit 10 

stream=authentication where sourcename='WINDOWS' and action='LOGIN' | duration 15m | select srcip, count_if(status='FAILED') as failed_login_cnt |  groupby srcip | having failed_login_cnt > 50

stream=authentication where sourcename='WINDOWS' and action='LOGIN' and srcip='{SuspectHost}'

stream=threat | duration 1h | groupby sender

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%C:%Windows%Microsoft%.NET%Framework64%v4.0.30319%csc%.exe%" and commandline like "%noconfig%fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%C:%Windows%Microsoft%.NET%Framework64%v4.0.30319%csc%.exe%" and commandline like "%noconfig%fullpaths%" | groupby user, system

stream=* |  groupby stream, sourcename |  duration 15m

stream=WIN-AUDIT where sourcename='WINDOWS' and action='OBJECT_ACCESSED' and status='PASSED' and event='A handle to an object was requested.' and object like '%RunOnce%' and category='NETWORK' and srcip='{SuspectHost}'

stream=WIN-AUDIT where sourcename='WINDOWS' and action='OBJECT_ACCESSED' and status='PASSED' and event='A handle to an object was requested.' and object like '%RunOnce%' and category='NETWORK' |  groupby srcip

stream=authentication where sourcename='WINDOWS' and action='LOGIN' and status='FAILED' | duration 15m | select srcip, distinct_count(user) as user_cnt |  groupby srcip | having user_cnt >= 3

stream=authentication where sourcename='WINDOWS' and action='LOGIN' and status='FAILED' and srcip='{SuspectHost}'

stream=threat where sourcename="FORCEPOINT-DLP" | groupby user

stream=threat where sourcename="FORCEPOINT-DLP" and user='{SuspectUser}'

stream=threat where sourcename="TREND-MICRO-ENDPOINT" and filtername="SpamFilter" and threat="Phishing Rule" and user='{SuspectUser}'

stream=threat where sourcename="TREND-MICRO-ENDPOINT" and filtername="SpamFilter" and threat="Phishing Rule" | groupby sender

stream=WIN-AUDIT where sourcename='WINDOWS' and action='SECURITY_LOG_FULL' and status='PASSED' and event='The security Log is now full.' and category='POLICY' and srcip='{SuspectHost}'

stream=WIN-AUDIT where sourcename='WINDOWS' and action='SECURITY_LOG_FULL' and status='PASSED' and event='The security Log is now full.' and category='POLICY' | groupby srcip 

stream=threat where sourcename='TIPPINGPOINT' and action='THREAT_BLOCKED' and status='PASSED' |  duration 30m | groupby srcip, dstip, threat | having count_col1 3

stream=WIN-AUDIT where sourcetype='OS' and not sourcename='NIX' and action='POLICY_CHANGED' and status='PASSED' and eid in ('4954','4956','4957','4958') and category='POLICY' and srcip='{SuspectHost}'

stream=WIN-AUDIT where sourcetype='OS' and not sourcename='NIX' and action='POLICY_CHANGED' and status='PASSED' and eid in ('4954','4956','4957','4958') and category='POLICY' | groupby srcip 

stream=authentication where sourcename='NIX' and action='LOGIN' and status='FAILED' and reason='INVALID_CREDENTIALS' and actiontaken in ('invalid user', 'Invalid user') |  groupby srcip, user

stream=authentication where sourcename='NIX' and action='LOGIN' and status='FAILED' and reason='INVALID_CREDENTIALS' and actiontaken in ('invalid user', 'Invalid user') and srcip='{SuspectHost}'

stream=iam where sourcename='NIX' and action='GROUP_DELETED' and status='PASSED' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=iam where sourcename='NIX' and action='GROUP_DELETED' and status='PASSED' |  groupby user, targetuser

stream=WEBFILTER where srcip='{SuspectHost}'

stream=WEBFILTER | groupby category, srcip

stream=AUTHENTICATION where sourcename='WINDOWS' and sourcetype='OS' and action='LOGIN' and status='STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT' and srcip='{SuspectHost}'

stream=AUTHENTICATION where sourcename='WINDOWS' and sourcetype='OS' and action='LOGIN' and status='STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT' | groupby srcip

stream=authentication where sourcename='NIX' and action='LOGIN' and status='PASSED' and user='root' | groupby srcip

stream=authentication where sourcename='NIX' and action='LOGIN' and user='root' and srcip='{SuspectHost}'

stream=auditd where sourcename='NIX' and action='USER_COMMAND_EXECUTED' and status='PASSED' and rlike(cmd,".*curl.*") | groupby user | limit 10

stream=auditd where sourcename='NIX' and action='USER_COMMAND_EXECUTED' and status='PASSED' and rlike(cmd,".*curl.*") and user='{SuspectUser}'

stream=authentication where sourcename='NIX' and action='LOGIN' and status='FAILED' and reason='INVALID_CREDENTIALS' and actiontaken='Failed password' and user='{SuspectUser}'

stream=authentication where sourcename='NIX' and action='LOGIN' and status='FAILED' and reason='INVALID_CREDENTIALS' and actiontaken='Failed password' | groupby srcip, user

stream=auditd where sourcename='NIX' and action='SERVICE_STOPED' and status='PASSED' and user='{SuspectUser}'

stream=auditd where sourcename='NIX' and action='SERVICE_STOPED' and status='PASSED' |  groupby user

stream=auditd where sourcename='NIX' and action='USER_COMMAND_EXECUTED' and status='PASSED' and not user='root' | groupby user, cmd

stream=auditd where sourcename='NIX' and action='USER_COMMAND_EXECUTED' and status='PASSED' and not user='root' and user='{SuspectUser}'

stream=threat where sourcename='TIPPINGPOINT' and action='THREAT_DETECTED' and dstport in ('9001', '9030', '9031', '9051', '9050', '9150', '9151') and @actiontken='permit' |  duration 1h | limit 30 | group by dstport

stream=WEBFILTER where srcip='{SsupectHost}'

stream=WEBFILTER | groupby category, srcip

stream=auditd where sourcename='NIX' and action='USER_COMMAND_EXECUTED' and status='PASSED' |  groupby user, cmd

stream=auditd where sourcename='NIX' and action='USER_COMMAND_EXECUTED' and status='PASSED' and user='{SuspectUser}'

stream=* |  groupby stream, sourcename |  duration 15m

stream=WEBFILTER | groupby category, srcip

stream=WEBFILTER where srcip='{SuspectHost}'

stream=iam where sourcename='NIX' and action='USER_ADDED' and status='PASSED' and daemon='useradd' and rlike(message,".*bash.*") |  groupby user 

stream=iam where sourcename='NIX' and action='USER_ADDED' and status='PASSED' and daemon='useradd' and rlike(message,".*bash.*") and user='{SuspectUser}'

stream=auditd where sourcename='NIX' and action='SERVICE_STARTED' and status='PASSED' |  groupby user

stream=auditd where sourcename='NIX' and action='SERVICE_STARTED' and status='PASSED' and user='{SuspectUser}'

stream=WIN-AUDIT where action="PROCESS_CREATED" and ( CommandLine like "%C:%Windows%Microsoft.NET%Framework64%v4.0.30319%csc.exe%noconfig%fullpaths%" | groupby user, system and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and ( CommandLine like "%C:%Windows%Microsoft.NET%Framework64%v4.0.30319%csc.exe%noconfig%fullpaths%" | groupby user, system

stream=authentication where sourcename='NIX' and action='LOGIN' and status='FAILED' and user='root' and srcip='{SuspectHost}'

stream=authentication where sourcename='NIX' and action='LOGIN' and status='FAILED' and user='root' | groupby srcip

stream=auditd where sourcename='NIX' and action='USER_COMMAND_EXECUTED' and status='PASSED' and rlike(cmd,".*socketcall.*") | groupby user | limit 10

stream=auditd where sourcename='NIX' and action='USER_COMMAND_EXECUTED' and status='PASSED' and rlike(cmd,".*socketcall.*") and user='{SuspectUser}'

stream=ep-process where eid='1' and action='PROCESS_ADDED' and status='PASSED' and (parentimage like '%WINWORD.EXE%' or parentimage like '%EXCEL.EXE%' or parentimage like '%POWERPNT.exe%' or parentimage like '%MSPUB.exe%' or parentimage like '%VISIO.exe%' or parentimage like '%OUTLOOK.EXE%') and (image like '%cmd.exe%' or image like '%powershell.exe%' or image like '%wscript.exe%' or image like '%cscript.exe%' or image like '%sh.exe%' or image like '%bash.exe%' or image like '%reg.exe%' or image like '%regsvr32.exe%' or image like '%BITSADMIN%') and system='{TargetHost}' and user='{SuspectUser}' | duration 15m 

stream=ep-process where eid='1' and action='PROCESS_ADDED' and status='PASSED' and (parentimage like '%WINWORD.EXE%' or parentimage like '%EXCEL.EXE%' or parentimage like '%POWERPNT.exe%' or parentimage like '%MSPUB.exe%' or parentimage like '%VISIO.exe%' or parentimage like '%OUTLOOK.EXE%') and (image like '%cmd.exe%' or image like '%powershell.exe%' or image like '%wscript.exe%' or image like '%cscript.exe%' or image like '%sh.exe%' or image like '%bash.exe%' or image like '%reg.exe%' or image like '%regsvr32.exe%' or image like '%BITSADMIN%') | duration 15m | limit 10

stream=threat where sourcename in ("RADWARE" ,"IMPERVA-WAF") | duration 1h | groupby srcip | select srcip, distinct_count(threat)

stream=threat where sourcename in ("RADWARE" ,"IMPERVA-WAF") and srcip='{SuspectHost}'

stream=IAM where sourcename='WINDOWS' and sourcetype='OS' and action='PASSWORD_CHANGED' and status='PASSED' and user like '%adm%' | groupby user, targetuser

stream=IAM where sourcename='WINDOWS' and sourcetype='OS' and action='PASSWORD_CHANGED' and status='PASSED' and user like '%adm%' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=threat where sourcename='TIPPINGPOINT' and action='THREAT_BLOCKED' and status='PASSED' and threat like '%DoS%' |  duration 1h | groupby threat, srcip, dstip | limi 100

stream=github where sourcename='GITHUB' and aciontaken='public_key.delete' and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and aciontaken='public_key.delete' | groupby user 

stream=iam where sourcename='GITHUB' and action in ('USER_ADDED','MEMBER_INVITED','GROUP_DELETED','USER_REMOVED') and role='admin' |  duration 5m | select user, targetuser, count(action) as cnt  | groupby user, targetuser | having cnt > 100

stream=iam where sourcename='GITHUB' and action in ('USER_ADDED','MEMBER_INVITED','GROUP_DELETED','USER_REMOVED') and role='admin' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%AUOptions%REG_DWORD%d%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%AUOptions%REG_DWORD%d%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where sourcename='WINDOWS' and sourcetype='OS' and action='OBJECT_ACCESSED' and status='PASSED' and category='NETWORK' and object like '%lsass%' |  groupby srcip 

stream=WIN-AUDIT where sourcename='WINDOWS' and sourcetype='OS' and action='OBJECT_ACCESSED' and status='PASSED' and category='NETWORK' and object like '%lsass%' and srcip='{SuspectHost}'

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?(StartMenuLogOff|onlogoff)") | groupby user, system

stream=threat where sourcename in ("RADWARE" ,"IMPERVA-WAF") and srcip='{SuspectHost}' 

stream=threat where sourcename in ("RADWARE" ,"IMPERVA-WAF") | duration 10m | groupby threat | select threat, distinct_count(srcip)

stream=IAM where sourcename='WINDOWS' and sourcetype='OS' and action='GROUP_CHANGED' and status='PASSED' and eid in ('4735','4736','4737') and user='ANONYMOUS LOGON' | groupby user, targetuser

stream=IAM where sourcename='WINDOWS' and sourcetype='OS' and action='GROUP_CHANGED' and status='PASSED' and eid in ('4735','4736','4737') and user='ANONYMOUS LOGON' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=IAM where sourcename='WINDOWS' and action='USER_ENABLED' and status='PASSED' and role='User Account Management' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=IAM where sourcename='WINDOWS' and action='USER_ENABLED' and status='PASSED' and role='User Account Management' | groupby user, targetuser

stream=AUTHENTICATION where sourcename='WINDOWS' and sourcetype='OS' and action='LOGIN' and status='FAILED' and  reason='BAD_USER_PASSWORD' and @Category='Logon' and @SubStatus='0xc000006d' and srcip='{SuspectHost}'

stream=AUTHENTICATION where sourcename='WINDOWS' and sourcetype='OS' and action='LOGIN' and status='FAILED' and  reason='BAD_USER_PASSWORD' and @Category='Logon' and @SubStatus='0xc000006d' | groupby srcip, user

stream=ep-process where eid='1' and (image like '%bginfo.exe%' or image like '%odbcconf.exe%' or image like '%dnx.exe%') | duration 2h | select image,system, user | limit 10

stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%filetheft_active_monitoring%" |  groupby srcip


stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%filetheft_active_monitoring%" and srcip='{SuspectHost}'

stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%smb_file_open%" |  groupby srcip

stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%smb_file_open%" and srcip='{SuspectHost}'

stream=IAM where sourcename='WINDOWS' and action='COMPUTER_ACCOUNT_CREATED' and status='PASSED' and role='Computer Account Management' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=IAM where sourcename='WINDOWS' and action='COMPUTER_ACCOUNT_CREATED' and status='PASSED' and role='Computer Account Management' | groupby user, targetuser

stream=EP-PROCESS where sourcename='WINDOWS' and action='PROCESS_ADDED' and status='PASSED' | groupby srcip

stream=EP-PROCESS where sourcename='WINDOWS' and action='PROCESS_ADDED' and status='PASSED' and srcip='{SuspectHost}'

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe -Version%' or parentcommandline like '%powershell.exe -Version%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe -Version%' or parentcommandline like '%powershell.exe -Version%') | groupby user, system

stream=* |  duration 1M | timeslice 1h | limit 10

stream=auditd where sourcename='NIX' and action='USER_COMMAND_EXECUTED' and status='PASSED' and rlike(cmd,".*http.*") and user='{SuspectUser}'

stream=auditd where sourcename='NIX' and action='USER_COMMAND_EXECUTED' and status='PASSED' and rlike(cmd,".*http.*") | groupby user | limit 10

stream=configuration where action='CONFIGURATION_CHANGED' and config='Server Reconfiguration' and user='{SuspectUser}'

stream=configuration where action='CONFIGURATION_CHANGED' and config='Server Reconfiguration' | select user, count(user) as user_cnt | groupby user | having user_cnt >= 1

stream=authentication where action='LOGIN' and status='FAILED' and srcip='{SuspectHost}'

stream=authentication where action='LOGIN' and status='FAILED' | groupby srcip, user, reason | limit 10

stream=WIN-AUDIT where sourcename='WINDOWS' and action='OBJECT_ACCESSED' and status='PASSED' and event='An object was deleted.' and category='NETWORK' | groupby srcip

stream=WIN-AUDIT where sourcename='WINDOWS' and action='OBJECT_ACCESSED' and status='PASSED' and event='An object was deleted.' and category='NETWORK' and srcip='{SuspectHost}'

stream=IAM where sourcename='WINDOWS' and sourcetype='OS' and action in ('GROUP_CREATED','GROUP_CHANGED','GROUP_DELETED') and status='PASSED' and eid in ('4764','4734','4754') and role like 'group' | groupby user

stream=IAM where sourcename='WINDOWS' and sourcetype='OS' and action in ('GROUP_CREATED','GROUP_CHANGED','GROUP_DELETED') and status='PASSED' and eid in ('4764','4734','4754') and role like 'group' and user='{SuspectUser}'

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%powershell.exe -Version%' or parentcommandline like '%powershell.exe -Version%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe -Version%' or parentcommandline like '%powershell.exe -Version%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=CONFIGURATION where sourcename='WINDOWS' and sourcetype='OS' and action='CONFIGURATION_CHANGED' and status='PASSED' and config='Service Installed' | groupby user


stream=CONFIGURATION where sourcename='WINDOWS' and sourcetype='OS' and action='CONFIGURATION_CHANGED' and status='PASSED' and config='Service Installed' and user='{SuspectUser}'

stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%nmap%" and srcip='{SuspectHost}'

stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%nmap%" |  groupby srcip


stream=WIN-AUDIT where sourcename='WINDOWS' and action='OBJECT_ACCESSED' and status='PASSED' and eid in ('4698','4699') and event='A scheduled task was created.' and category='NETWORK' and srcip='{SuspectHost}'

stream=WIN-AUDIT where sourcename='WINDOWS' and action='OBJECT_ACCESSED' and status='PASSED' and eid in ('4698','4699') and event='A scheduled task was created.' and category='NETWORK' | groupby srcip

stream=auditd where sourcename='NIX' and action='USER_COMMAND_EXECUTED' and status='PASSED' and cmd=':(){ :|:& };:' | groupby user | limit 10

stream=auditd where sourcename='NIX' and action='USER_COMMAND_EXECUTED' and status='PASSED' and cmd=':(){ :|:& };:' and user='{SuspectUser}'

stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%smb_file_delete%" and srcip='{SuspectHost}'

stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%smb_file_delete%" |  groupby srcip

stream=IAM where sourcename='WINDOWS' and sourcetype='OS' and action='COMPUTER_ACCOUNT_CREATED' and status='PASSED' and not user like '%$%' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=IAM where sourcename='WINDOWS' and sourcetype='OS' and action='COMPUTER_ACCOUNT_CREATED' and status='PASSED' and not user like '%$%' | groupby user, targetuser


stream=IAM where sourcename='WINDOWS' and sourcetype='OS' and action in ('USER_CREATED','COMPUTER_ACCOUNT_CREATED') and status='PASSED' and not system like '%MMDC%' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=IAM where sourcename='WINDOWS' and sourcetype='OS' and action in ('USER_CREATED','COMPUTER_ACCOUNT_CREATED') and status='PASSED' and not system like '%MMDC%' | groupby user, targetuser, system

stream=other | limit 1

stream=signals | duration 15m | limit 100

stream=WIN-AUDIT where sourcename='WINDOWS' and sourcetype='OS' and action='POLICY_CHANGED' and status='PASSED' and category='POLICY' and eid in ('4865','4866') | groupby srcip

stream=WIN-AUDIT where sourcename='WINDOWS' and sourcetype='OS' and action='POLICY_CHANGED' and status='PASSED' and category='POLICY' and eid in ('4865','4866') and srcip='{SuspectHost}'

stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%ssh_creds_submitted_root%" and srcip='{SuspectHost}'

stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%ssh_creds_submitted_root%" |  groupby srcip


stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%windows_ntlm_logon_failure%" |  groupby srcip


stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%windows_ntlm_logon_failure%" and srcip='{SuspectHost}'

stream=authentication where sourcename='GITHUB' and action='LOGIN' | duration 15m | select user, system, count_if(status='FAILED') as failcount, count_if(status='PASSED') as passcount | groupby user | having failcount >= 50 and failcount >= passcount * 5 | limit 100

stream=authentication where sourcename='GITHUB' and action='LOGIN' and user='{SuspectUser}'

stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%network_ntlm%" |  groupby srcip


stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%threat_wannacry_darkpulsar_ping%" |  groupby srcip


stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%windows_rdp_session%" |  groupby srcip


stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%windows_rdp_session%" and srcip='{SuspectHost}'

stream=github where sourcename='GITHUB' and actiontaken='ip_allow_list.disable' and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken='ip_allow_list.disable' | groupby user

stream=iam where sourcename='NIX' and action='USER_ADDED' and status='PASSED' | groupby user, targetuser 

stream=iam where sourcename='NIX' and action='USER_ADDED' and status='PASSED' and user='{SuspectUser}' and targetuser='{TargetUser}' 

stream=ep-process where sourcename='WINDOWS' and eid='1' and parentimage like '%WSreset.exe%' and image like '%conhost.exe%' | groupby user, system | limit 10 | duration 1m

stream=ep-process where sourcename='WINDOWS' and eid='1' and parentimage like '%WSreset.exe%' and image like '%conhost.exe%' and system='{TargetHost}' and user='{SuspectUser}'

stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%windows_admin_share%" |  groupby srcip

stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%windows_admin_share%" and srcip='{SuspectHost}'

stream=Threat where sourcetype='DECOY' and decoygroup='Active Directory' and srcip='{SuspectHost}'

stream=Threat where sourcetype='DECOY' and decoygroup='Active Directory' |  groupby srcip


stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%filetheft_open%" |  groupby srcip


stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%filetheft_open%" and srcip='{SuspectHost}'

stream=* where sourcetype='DECOY' and decoytype='network' and srcip='{SuspectHost}'

stream=* where sourcetype='DECOY' and decoytype='network' |  groupby decoyappliancename, srcip


stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%network_vnc_access%" |  groupby srcip


stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%network_vnc_access%" and srcip='{SuspectHost}'

stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%recon_creds_submitted%" |  groupby srcip


stream=THREAT where sourcename='SMOKESCREEN' and threatparseid like "%recon_creds_submitted%" and srcip='{SuspectHost}'

stream=github where sourcename='GITHUB' and actiontaken='public_key.create' | groupby user 

stream=github where sourcename='GITHUB' and actiontaken='public_key.create' and user='{SuspectUser}' 

stream=github where sourcename='GITHUB' and actiontaken='repo.transfer' |  groupby user

stream=github where sourcename='GITHUB' and actiontaken='repo.transfer' and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken='secret_scanning_alert.create' and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken='secret_scanning_alert.create' | groupby user

stream=iam where action='PRIVILEGE_CHANGED'  |  groupby user, system

stream=iam where action='PRIVILEGE_CHANGED' and user='{SuspectUser}' and system='{TargetHost}'

stream=github where sourcename='GITHUB' and actiontaken in ('protected_branch.update_name', 'protected_branch.policy_override') | groupby user 

stream=github where sourcename='GITHUB' and actiontaken in ('protected_branch.update_name', 'protected_branch.policy_override') and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken='hook.create' and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken='hook.create' |  groupby user

stream=github where sourcename='GITHUB' and actiontaken in ('dependabot_alerts.disable','dependabot_alerts_new_repos.disable','dependabot_security_updates.disable','dependabot_security_updates_new_repos.disable') | groupby user 

stream=github where sourcename='GITHUB' and actiontaken in ('dependabot_alerts.disable','dependabot_alerts_new_repos.disable','dependabot_security_updates.disable','dependabot_security_updates_new_repos.disable') and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken='two_factor_authentication.disabled' and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken='two_factor_authentication.disabled' | groupby user 

stream=github where sourcename='GITHUB' and actiontaken in ('repository_secret_scanning_push_protection.disable','secret_scanning.disable','secret_scanning_new_repos.disable') | groupby user 

stream=github where sourcename='GITHUB' and actiontaken in ('repository_secret_scanning_push_protection.disable','secret_scanning.disable','secret_scanning_new_repos.disable') and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken='ip_allow_list_entry.create' and user='{SuspectUser}'

stream=github where sourcename='GITHUB' and actiontaken='ip_allow_list_entry.create' | groupby user 

stream=github where sourcename='GITHUB' and actiontaken='repo.disable' | groupby user

stream=github where sourcename='GITHUB' and actiontaken='repo.disable' and user='{SuspectUser}'

stream=authentication where sourcename='GITHUB' and action='LOGIN' and status='PASSED' and countrycode is not null | select user, distinct_count(countrycode) as cnt | groupby user | having cnt >= 2

stream=authentication where sourcename='GITHUB' and action='LOGIN' and status='PASSED' and countrycode is not null and user='{SuspectUser}'

stream=slack where sourcename='SLACK' and actiontaken='legal_hold_policy_entities_deleted' | groupby user, srcip

stream=slack where sourcename='SLACK' and actiontaken='legal_hold_policy_entities_deleted' and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=slack where sourcename='SLACK' and actiontaken='file_malicious_content_detected' |  groupby user, srcip

stream=slack where sourcename='SLACK' and actiontaken='file_malicious_content_detected' and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=authentication where sourcename='SLACK' and action='LOGIN' and status='FAILED' | duration 1h | select user, count(status) as cnt | groupby user | having cnt > 10 

stream=authentication where sourcename='SLACK' and action='LOGIN' and status='FAILED' and user='{SuspectUser}'

stream=slack where sourcename='SLACK' and actiontaken='anomaly' and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=slack where sourcename='SLACK' and actiontaken='anomaly' |  groupby user, srcip

stream=slack where sourcename='SLACK' and actiontaken='idp_prod_configuration_updated' and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=slack where sourcename='SLACK' and actiontaken='idp_prod_configuration_updated' |  groupby user, srcip

stream=slack where sourcename='SLACK' and actiontaken in ('app_restricted','app_uninstalled','org_app_workspace_removed') |  groupby user, app, srcip

stream=slack where sourcename='SLACK' and actiontaken in ('app_restricted','app_uninstalled','org_app_workspace_removed') and app='{TargetResource}' and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=slack where sourcename='SLACK' and actiontaken in ('barrier_deleted', 'barrier_updated') | groupby user

stream=slack where sourcename='SLACK' and actiontaken in ('barrier_deleted', 'barrier_updated') and user='{SuspectUser}'

stream=slack where sourcename='SLACK' and actiontaken='native_dlp_rule_deactivated' and srcip='{SuspectHost}' and user='{SuspectUser}'

stream=slack where sourcename='SLACK' and actiontaken='native_dlp_rule_deactivated' | groupby user, srcip

stream=other

stream=slack where sourcename='SLACK' and actiontaken='native_dlp_violation_deleted' and srcip='{SuspectHost}' and user='{SuspectUser}'

stream=slack where sourcename='SLACK' and actiontaken='native_dlp_violation_deleted' | groupby user, srcip

stream=slack where sourcename='SLACK' and actiontaken='private_channel_converted_to_public' and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=slack where sourcename='SLACK' and actiontaken='private_channel_converted_to_public' |  groupby user, srcip

stream=slack where sourcename='SLACK' and actiontaken='pref.two_factor_auth_changed' and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=slack where sourcename='SLACK' and actiontaken='pref.two_factor_auth_changed' |  groupby user, srcip

stream=ep-process where eid='1' and action='PROCESS_ADDED' and status='PASSED' and (parentimage like '%WINWORD.EXE%' or parentimage like '%EXCEL.EXE%' or parentimage like '%POWERPNT.exe%' or parentimage like '%MSPUB.exe%' or parentimage like '%VISIO.exe%' or parentimage like '%OUTLOOK.EXE%') and (image like '%cmd.exe%' or image like '%powershell.exe%' or image like '%wscript.exe%' or image like '%cscript.exe%' or image like '%sh.exe%' or image like '%bash.exe%' or image like '%reg.exe%' or image like '%regsvr32.exe%' or image like '%BITSADMIN%') and system='{TargetHost}' and user='{SuspectUser}' | duration 15m 

stream=ep-process where eid='1' and action='PROCESS_ADDED' and status='PASSED' and (parentimage like '%WINWORD.EXE%' or parentimage like '%EXCEL.EXE%' or parentimage like '%POWERPNT.exe%' or parentimage like '%MSPUB.exe%' or parentimage like '%VISIO.exe%' or parentimage like '%OUTLOOK.EXE%') and (image like '%cmd.exe%' or image like '%powershell.exe%' or image like '%wscript.exe%' or image like '%cscript.exe%' or image like '%sh.exe%' or image like '%bash.exe%' or image like '%reg.exe%' or image like '%regsvr32.exe%' or image like '%BITSADMIN%') | duration 15m | limit 10

stream=slack where sourcename='SLACK' and actiontaken='organization_deleted' |  groupby user, srcip

stream=slack where sourcename='SLACK' and actiontaken='organization_deleted' and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname in ('powershell.exe','cmd.exe') and commandline like '%netsh%portproxy%v4tov4%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname in ('powershell.exe','cmd.exe') and commandline like '%netsh%portproxy%v4tov4%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=slack where sourcename='SLACK' and actiontaken='legal_hold_policy_exclusion_added' and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=slack where sourcename='SLACK' and actiontaken='legal_hold_policy_exclusion_added' | groupby user, srcip

stream=slack where sourcename='SLACK' and actiontaken in ('owner_transferred','permissions_assigned','role_change_to_admin','role_change_to_owner') | groupby user, srcip

stream=slack where sourcename='SLACK' and actiontaken in ('owner_transferred','permissions_assigned','role_change_to_admin','role_change_to_owner') and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=authentication where sourcename='SLACK' and action='LOGIN' and status='PASSED' and countrycode is not null | select user, distinct_count(countrycode) as cnt | groupby user | having cnt >= 2

stream=authentication where sourcename='SLACK' and action='LOGIN' and status='PASSED' and countrycode is not null and user='{SuspectUser}'

stream=slack where sourcename='SLACK' and actiontaken='service_owner_transferred' |  groupby user, srcip

stream=slack where sourcename='SLACK' and actiontaken='service_owner_transferred' and user='{SuspectUser}' and srcip='{SuspectHost}'

stream=authentication where sourcename='NIX' and action='LOGIN' and status='PASSED' and daemon in ('su', 'sudo') and srcip='{SuspectHost}'

stream=authentication where sourcename='NIX' and action='LOGIN' and status='PASSED' and daemon in ('su', 'sudo') | groupby srcip, user, authproto

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),"(whoami|net\s+user|quser|get-localuser|get-aduser|query\s+user)") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),"(whoami|net\s+user|quser|get-localuser|get-aduser|query\s+user)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where rlike(lower(image), '(powershell.exe|wscript.exe|cscript.exe)') and rlike(lower(commandline), '(iex|invoke-expression|new-object|system.net.webclient|downloadstring)') | groupby user, system

stream=ep-process where rlike(lower(image), '(powershell.exe|wscript.exe|cscript.exe)') and rlike(lower(commandline), '(iex|invoke-expression|new-object|system.net.webclient|downloadstring)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname in ('powershell.exe','cmd.exe') and commandline like '%netsh%portproxy%v4tov4%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'netsh\s+interface\s+portproxy\s+add\s+v4tov4' | groupby user, system

stream=authentication where action="LOGIN" and status="FAILED" |  duration 30m |  groupby user | having count_col1 >1000

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), 'netsh\s+interface\s+portproxy\s+add\s+v4tov4' or rlike(lower(commandline), 'new-netfirewallrule.*-protocol\s+tcp\s+-localport.*-action\s+allow' or rlike(lower(commandline), 'add-netnatstaticmapping.*-protocol\s+tcp.*-externalport.*-internalport') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), 'netsh\s+interface\s+portproxy\s+add\s+v4tov4' or rlike(lower(commandline), 'new-netfirewallrule.*-protocol\s+tcp\s+-localport.*-action\s+allow' or rlike(lower(commandline), 'add-netnatstaticmapping.*-protocol\s+tcp.*-externalport.*-internalport') | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like '%winpwn%printercheck%' | groupby system, user 

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like '%winpwn%printercheck%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=nta-rdp where action = '{TargetUser}' | duration 1h

stream=nta-rdp where action = 'CONNECTION_ESTABLISHED' | duration 1h

stream=iam where sourcename='NIX' and action='USER_DELETED' and status='PASSED' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=iam where sourcename='NIX' and action='USER_DELETED' and status='PASSED' | groupby user, targetuser 

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | groupby user, system

stream=* | duration 7d | limit 1

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like "%eventvwr%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like "%eventvwr%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%.CreationTime =%' or commandline like '%.LastWriteTime =%' or commandline like '%.LastAccessTime =%') | groupby user, system, commandline

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ChildItem%.CreationTime =%' or commandline like '%Get-ChildItem%.LastWriteTime =%' or commandline like '%Get-ChildItem%.LastAccessTime =%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), 'netsh\s+interface\s+portproxy\s+add\s+v4tov4' or rlike(lower(commandline), 'new-netfirewallrule.*-protocol\s+tcp\s+-localport.*-action\s+allow' or rlike(lower(commandline), 'add-netnatstaticmapping.*-protocol\s+tcp.*-externalport.*-internalport') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), 'netsh\s+interface\s+portproxy\s+add\s+v4tov4' or rlike(lower(commandline), 'new-netfirewallrule.*-protocol\s+tcp\s+-localport.*-action\s+allow' or rlike(lower(commandline), 'add-netnatstaticmapping.*-protocol\s+tcp.*-externalport.*-internalport') | groupby user, system

stream=authentication where sourcename='NIX' and action='LOGIN' and status='FAILED' and actiontaken in ( 'Received disconnect', 'Disconnected') | groupby srcip, user, authproto

stream=authentication where sourcename='NIX' and action='LOGIN' and status='FAILED' and actiontaken in ( 'Received disconnect', 'Disconnected') and srcip='{SuspectHost}'

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (rlike(lower(scriptblocktext), 'netsh\s+interface\s+portproxy\s+add\s+v4tov4' or rlike(lower(scriptblocktext), 'new-netfirewallrule.*-protocol\s+tcp\s+-localport.*-action\s+allow' or rlike(lower(scriptblocktext), 'add-netnatstaticmapping.*-protocol\s+tcp.*-externalport.*-internalport') | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (rlike(lower(scriptblocktext), 'netsh\s+interface\s+portproxy\s+add\s+v4tov4' or rlike(lower(scriptblocktext), 'new-netfirewallrule.*-protocol\s+tcp\s+-localport.*-action\s+allow' or rlike(lower(scriptblocktext), 'add-netnatstaticmapping.*-protocol\s+tcp.*-externalport.*-internalport') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=iam where sourcename='NIX' and action='GROUP_CREATED' and status='PASSED' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=iam where sourcename='NIX' and action='GROUP_CREATED' and status='PASSED' |  groupby user, targetuser

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | groupby user, system

stream=CONFIGURATION where action="CONFIGURATION_CHANGED" and rlike(lower(commandline),"set\-mppreference.*?(DisableRealtimeMonitoring|DisableBehaviorMonitoring|DisableBlockAtFirstSeen|DisableScriptScanning|drtm|dbm|dscrptsc|dbaf).*?true") | groupby system 

stream=CONFIGURATION where action="CONFIGURATION_CHANGED" and rlike(lower(commandline),"set\-mppreference.*?(DisableRealtimeMonitoring|DisableBehaviorMonitoring|DisableBlockAtFirstSeen|DisableScriptScanning|drtm|dbm|dscrptsc|dbaf).*?true") and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(parentcommandline), 'netsh\s+interface\s+portproxy\s+add\s+v4tov4' or rlike(lower(parentcommandline), 'new-netfirewallrule.*-protocol\s+tcp\s+-localport.*-action\s+allow' or rlike(lower(parentcommandline), 'add-netnatstaticmapping.*-protocol\s+tcp.*-externalport.*-internalport') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(parentcommandline), 'netsh\s+interface\s+portproxy\s+add\s+v4tov4' or rlike(lower(parentcommandline), 'new-netfirewallrule.*-protocol\s+tcp\s+-localport.*-action\s+allow' or rlike(lower(parentcommandline), 'add-netnatstaticmapping.*-protocol\s+tcp.*-externalport.*-internalport') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action="PROCES_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action="PROCES_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=auditd where sourcename='NIX' and action='USER_COMMAND_EXECUTED' and status='PASSED' and user='{SuspectUser}'

stream=auditd where sourcename='NIX' and action='USER_COMMAND_EXECUTED' and status='PASSED' |  groupby user, cmd

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and  (rlike(lower(commandline),"mkdir .*?windows .*?(system32|syswow64)") or rlike(lower(commandline),"(copy |mlink ).*? .*?windows .*?(system32|syswow64)")) | groupby user, system, commandline

stream=WIN-AUDIT where action="PROCESS_CREATED" and  (rlike(lower(commandline),"mkdir .*?windows .*?(system32|syswow64)") or rlike(lower(commandline),"(copy |mlink ).*? .*?windows .*?(system32|syswow64)")) and user='{SuspectUser}' and system='{TargetHost}' and commandline='{TargetObject}' | duration 6m

stream=iam where sourcename='NIX' and action='PASSWORD_CHANGED' and status='PASSED' |  groupby user, targetuser

stream=iam where sourcename='NIX' and action='PASSWORD_CHANGED' and status='PASSED' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=ep-process where sourcename='WINDOWS' and ((image like '%attrib.exe' and (commandline like '%+h%' or commandline like '%+s%')) or (image like '%VolumeShadowCopy%' or commandline like '%VolumeShadowCopy%')) | duration 1h | select image, commandline, user, system | limit 100

stream=ep-process where sourcename='WINDOWS' and ((image like '%attrib.exe' and (commandline like '%+h%' or commandline like '%+s%')) or (image like '%VolumeShadowCopy%' or commandline like '%VolumeShadowCopy%')) and system='{TargetHost}' and user='{SuspectUser}'

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | groupby user, system

stream=authentication where sourcename='NIX' and action='LOGIN' and status='FAILED' and actiontaken in ( 'Received disconnect', 'Disconnected') | groupby srcip, user, authproto

stream=authentication where sourcename='NIX' and action='LOGIN' and status='FAILED' and actiontaken in ( 'Received disconnect', 'Disconnected') and srcip='{SuspectHost}'

stream=CONFIGURATION where sourcename='MS-O365' and action='CONFIGURATION_CHANGED' and status='PASSED' and @Operation='Disable' and user='{SuspectUser}'

stream=CONFIGURATION where sourcename='MS-O365' and action='CONFIGURATION_CHANGED' and status='PASSED' and @Operation='Disable' | groupby user

stream=authentication where sourcename='NIX' and action='LOGIN' and status='FAILED' and reason='INVALID_CREDENTIALS' and actiontaken in ('authentication failed', 'authentication failure', 'authentication failures') and srcip='{SuspectHost}'

stream=authentication where sourcename='NIX' and action='LOGIN' and status='FAILED' and reason='INVALID_CREDENTIALS' and actiontaken in ('authentication failed', 'authentication failure', 'authentication failures') |  groupby srcip, user

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=auditbeat where system='ar-linux' | select regexp_extract(sourcename, "T([\\w\\-]+)$", 1) as name | groupby sourcename

stream=auditbeat where system='ar-linux' and sourcename like '%{SuspectUser}' | duration 6m

stream=auditbeat where system='ar-linux' | select regexp_extract(sourcename, "T([\\w\\-]+)$", 1) as name | groupby sourcename

stream=auditbeat where system='ar-linux' and sourcename like '%{SuspectUser}' | duration 6m

stream=AUTHENTICATION where action='LOGIN' and srctype='PUBLIC' and authproto='SSH' and srcip='{SuspectHost}' | duration 7d

stream=auditbeat where system='ar-linux' | select regexp_extract(sourcename, "T([\\w\\-]+)$", 1) as name | groupby sourcename

stream=auditbeat where system='ar-linux' and sourcename like '%{SuspectUser}' | duration 6m

stream=firewall | duration 1d | groupby action, srccn

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(icmpsh\_m|nc|ncat|powercat)' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(icmpsh\_m|nc|ncat|powercat)' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe" or parentimage like "%rundll32.exe" or parentimage like "%wscript.exe" or parentimage like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe" or parentimage like "%rundll32.exe" or parentimage like "%wscript.exe" or parentimage like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe" or parentimage like "%rundll32.exe" or parentimage like "%wscript.exe" or parentimage like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=AUTHENTICATION where sourcename='MS-O365' and action='LOGIN' and status='PASSED' and @Operation='UserLoggedIn' and @ResultStatus='Succeeded' and not @Workload='AzureActiveDirectory' | groupby srcip

stream=AUTHENTICATION where sourcename='MS-O365' and action='LOGIN' and status='PASSED' and @Operation='UserLoggedIn' and @ResultStatus='Succeeded' and not @Workload='AzureActiveDirectory' and srcip='{SuspectHost}'

stream=auditbeat where system='ar-linux' | select regexp_extract(sourcename, "T([\\w\\-]+)$", 1) as name | groupby sourcename

stream=auditbeat where system='ar-linux' and sourcename like '%{SuspectUser}' | duration 6m

stream=authentication where action='LOGIN' and status='FAILED' | groupby user, srcip

stream=firewall | duration 1d | groupby action, srccn | limit 5

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(icmpsh\_m|nc|ncat|powercat)' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(icmpsh\_m|nc|ncat|powercat)' | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=signals

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like '%winpwn%printercheck%' | groupby system, user 

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like '%winpwn%printercheck%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like '%get-wmiobject%win32_pnpentity%' | groupby user, system 

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like '%get-wmiobject%win32_pnpentity%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe" or parentimage like "%rundll32.exe" or parentimage like "%wscript.exe" or parentimage like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like "%software%classes%shell%open%command%" and rlike(lower(commandline),"(eventvwr|sdclt|fodhelper|computerdefaults)") and user='{SuspectUser}' and commandline='{SuspectObject}' and system='{TargetSystem}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like "%software%classes%shell%open%command%" and rlike(lower(commandline),"(eventvwr|sdclt|fodhelper|computerdefaults)") | groupby user, system, commandline

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('cmd.exe','powershell.exe') and commandline like '%netsh%firewall%set%opmode%mode=disable%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('cmd.exe','powershell.exe') and commandline like '%netsh%firewall%set%opmode%mode=disable%' |  groupby user, system

stream=authentication where action="LOGIN" and status="FAILED" | duration 15m | groupby user, devsrcip, reason

stream=authentication where action="LOGIN" and status="FAILED" and user='{SuspectUser}'

stream=authentication where action='LOGIN' and status='FAILED' and srcip='{SuspectUser}' and user='{TargetUser}' 

stream=ep-process where action='PROCESS_ADDED'  and (commandline like '%tasklist%' or commandline like '%tasklist%lsass%' or commandline like '%Get-Process%' or commandline like '%get-wmiObject%Win32_Process%' or commandline like '%wmic%process%') and system='{TargetHost}' and commandline='{TargetObject}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%tasklist%' or commandline like '%tasklist%lsass%' or commandline like '%Get-Process%' or commandline like '%get-wmiObject%Win32_Process%' or commandline like '%wmic%process%') | groupby system, user 

stream=AUTHENTICATION where sourcename='MS-O365' and action='LOGIN' and status='PASSED' and @Operation='UserLoggedIn' and @ResultStatus='Succeeded' and not srccn in ('IN','-') |  groupby srcip, srccn

stream=AUTHENTICATION where sourcename='MS-O365' and action='LOGIN' and status='PASSED' and @Operation='UserLoggedIn' and @ResultStatus='Succeeded' and not srccn in ('IN','-') and srcip='{SuspectHost}' and srccn='{SuspectLocation}'

stream=ep-process where eid='1' and ((image like '%SoundRecorder.exe%' and commandline like '%/FILE%' ) or commandline like '%Get-AudioDevice%' or commandline like '%WindowsAudioDevice-Powershell-Cmdlet%') and system='{TargetHost}' and user='{SuspectUser}'

stream=ep-process where eid='1' and ((image like '%SoundRecorder.exe%' and commandline like '%/FILE%' ) or commandline like '%Get-AudioDevice%' or commandline like '%WindowsAudioDevice-Powershell-Cmdlet%') | groupby user, system, commandline | duration 5m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like "%powershell.exe%" and commandline like "%Set-WebConfiguration%system.webServer%httpLogging%dontLog%$true%" | groupby user, system

stream=authentication where action='LOGIN' and status='FAILED' and srcip='{SuspectUser}' and user='{TargetUser}' 

stream=authentication where action='LOGIN' and status='FAILED' and srcip='{SuspectUser}' and user='{TargetUser}' 

stream=authentication

stream=firewall | duration 1d | groupby action, srccn | limit 5

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe" or parentimage like "%rundll32.exe" or parentimage like "%wscript.exe" or parentimage like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe" or parentimage like "%rundll32.exe" or parentimage like "%wscript.exe" or parentimage like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '' | groupby user, system

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%System.IO.Compression.DeflateStream%FromBase64String%' or scriptblocktext like '%System.IO.Compression.GzipStream%FromBase64String%' or scriptblocktext like '%IO.Compression.DeflateStream%FromBase64String%' or scriptblocktext like '%IO.Compression.GzipStream%FromBase64String%') | groupby user, system

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%System.IO.Compression.DeflateStream%FromBase64String%' or scriptblocktext like '%System.IO.Compression.GzipStream%FromBase64String%' or scriptblocktext like '%IO.Compression.DeflateStream%FromBase64String%' or scriptblocktext like '%IO.Compression.GzipStream%FromBase64String%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe" or parentimage like "%rundll32.exe" or parentimage like "%wscript.exe" or parentimage like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe" or parentimage like "%rundll32.exe" or parentimage like "%wscript.exe" or parentimage like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=CONFIGURATION where sourcename='MS-O365' and action='CONFIGURATION_CHANGED' and @Operation='Add policy.' and user='{SuspectUser}'

stream=CONFIGURATION where sourcename='MS-O365' and action='CONFIGURATION_CHANGED' and @Operation='Add policy.' |  groupby user

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(psiphon\$.*python\s+psi\_client\.py)' or rlike(lower(commandline), '(docker\s+(run|start).*psiphon)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(psiphon\$.*python\s+psi\_client\.py)' or rlike(lower(commandline), '(docker\s+(run|start).*psiphon)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(tor.exe|tor\s+browser.*browser.*|\.onion)'  | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(tor.exe|tor\s+browser.*browser.*|\.onion)'  | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(tor.exe|tor\s+browser.*browser.*|\.onion)' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (image like "%powershell.exe" or image like "%cmd.exe" or image like "%rundll32.exe" or image like "%wscript.exe" or image like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe" or parentimage like "%rundll32.exe" or parentimage like "%wscript.exe" or parentimage like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(psiphon\$.*python\s+psi\_client\.py)' or rlike(lower(commandline), '(docker\s+(run|start).*psiphon)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(psiphon\$.*python\s+psi\_client\.py)' or rlike(lower(commandline), '(docker\s+(run|start).*psiphon)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like "%new-object drawing.bitmap%" and lower(commandline) like '%drawing.graphics%fromimage%' and lower(commandline) like '%copyfromscreen%') or lower(commandline) like "%psr%/start%") | duration 1h

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(tor.exe|tor\s+browser.*browser.*|\.onion)'  | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(tor.exe|tor\s+browser.*browser.*|\.onion)' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') AND rlike(lower(commandline), "trufflesnout.*?(domain|forest)") | duration 1h

stream=win-audit where action='PROCESS_CREATED' AND rlike(lower(commandline), "trufflesnout.*?(domain|forest)") and user='{SUspectUser}' and system='{TargetHost}' |duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'get-wmiobject.*?-class.*?(ds_computer.*?-namespace|win32_ntdomain|win32_computersystem)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'get-wmiobject.*?-class.*?(ds_computer.*?-namespace|win32_ntdomain|win32_computersystem)') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%' or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or  lower(commandline) like '%nbtstat%-n%' or  lower(commandline) like '%nbtstat%-s%') | duration 15m |  select system, user, commandline | limit 10000

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%' or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or  lower(commandline) like '%nbtstat%-n%' or  lower(commandline) like '%nbtstat%-s%') and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") and user="{SuspectUser}" and system="{TargetHost}" | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") | groupby user, system, commandline 

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like "%new-object drawing.bitmap%" and lower(commandline) like '%drawing.graphics%fromimage%' and lower(commandline) like '%copyfromscreen%') or lower(commandline) like "%psr%/start%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like "%new-object drawing.bitmap%" and lower(commandline) like '%drawing.graphics%fromimage%' and lower(commandline) like '%copyfromscreen%') or lower(commandline) like "%psr%/start%") | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(tor.exe|tor\s+browser.*browser.*|\.onion)' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(tor.exe|tor\s+browser.*browser.*|\.onion)')  | groupby user, system

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') AND rlike(lower(commandline), "trufflesnout.*?(domain|forest)") and user='{SUspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') AND rlike(lower(commandline), "trufflesnout.*?(domain|forest)") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.*?-accepteula.*?(-c|-f|-v)') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.*?-accepteula.*?(-c|-f|-v)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), "trufflesnout.*?(domain|forest)") and user='{SUspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), "trufflesnout.*?(domain|forest)") | groupby user, system

stream=iam where sourcename='MS-O365' and action='USER_ADDED' and status='PASSED' and role='Delegated Permission Grant' | groupby user 

stream=iam where sourcename='MS-O365' and action='USER_ADDED' and status='PASSED' and role='Delegated Permission Grant' and user='{SuspectUser}'

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%cmd /c "for /l %x in (1,1,%) do start%/p%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%cmd /c "for /l %x in (1,1,%) do start%/p%' | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(newprocessname), ".(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") | groupby NewProcessName, substring_index(NewProcessName,"\\",-1), user, system | select newprocessname, substring_index(NewProcessName,"\\",-1) as processname, user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(newprocessname), ".(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") and newprocessname="{SuspectObject}" and user="{SuspectUser}" and system="{TargetHost}" | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'wevtutil.*?(epl|export-log).*?c:.*?(q|sq|lf|ow):.*?system.*?eventid.*?4776') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'wevtutil.*?(epl|export-log).*?c:.*?(q|sq|lf|ow):.*?system.*?eventid.*?4776') user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=THREAT where sourcename='TIPPINGPOINT' and action='THREAT_BLOCKED' and status='PASSED' and vector='NETWORK' and threat like '%DoS%' and srcip='{SuspectHost}' and dstip='{TargetHost}'

stream=THREAT where sourcename='TIPPINGPOINT' and action='THREAT_BLOCKED' and status='PASSED' and vector='NETWORK' and threat like '%DoS%' |  groupby srcip, dstip

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like "%new-object drawing.bitmap%" and lower(commandline) like '%drawing.graphics%fromimage%' and lower(commandline) like '%copyfromscreen%') or lower(commandline) like "%psr%/start%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like "%new-object drawing.bitmap%" and lower(commandline) like '%drawing.graphics%fromimage%' and lower(commandline) like '%copyfromscreen%') or lower(commandline) like "%psr%/start%") | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(dir|ls|tree|find|locate|get-childitem|get-item|get-content|cat|findstr)\s+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(dir|ls|tree|find|locate|get-childitem|get-item|get-content|cat|findstr)\s+') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%directoryservices.directorysearcher%ObjectCategory=Computer%' or lower(commandline) like '%get-adcomputer%' or lower(commandline) like '%adsisearcher%objectcategory=computer%')  | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%directoryservices.directorysearcher%ObjectCategory=Computer%' or lower(commandline) like '%get-adcomputer%' or lower(commandline) like '%adsisearcher%objectcategory=computer%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%mpcmdrun%-removedefinitions%" or rlike(lower(commandline),"(del|remove).*?programdata.*?microsoft.*?windows.*?defender.*?defination.*?update")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%mpcmdrun%-removedefinitions%" or rlike(lower(commandline),"(del|remove).*?programdata.*?microsoft.*?windows.*?defender.*?defination.*?update")) | groupby user, system, commandline 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%createprocess.cs%' or lower(commandline) like '%get-system%createprocesssystem%' or lower(commandline) like '%get-system%createprocesssystembind%' or lower(commandline) like '%get-system%%namedpipesystem%') |  groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%createprocess.cs%' or lower(commandline) like '%get-system%createprocesssystem%' or lower(commandline) like '%get-system%createprocesssystembind%' or lower(commandline) like '%get-system%%namedpipesystem%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(DirLister)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like "%new-object drawing.bitmap%" and lower(commandline) like '%drawing.graphics%fromimage%' and lower(commandline) like '%copyfromscreen%') or lower(commandline) like "%psr%/start%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like "%new-object drawing.bitmap%" and lower(commandline) like '%drawing.graphics%fromimage%' and lower(commandline) like '%copyfromscreen%') or lower(commandline) like "%psr%/start%") | groupby user, system 

stream=authentication where action="LOGIN" and status="FAILED" |  duration 30m |  groupby user | having count_col1 >1000

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(dir|ls|tree|find|locate|get-childitem|get-item|get-content|cat|findstr)\s+') | groupby user, system

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') AND rlike(lower(commandline), "trufflesnout.*?(domain|forest)") and user='{SUspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') AND rlike(lower(commandline), "trufflesnout.*?(domain|forest)") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powerview%get-domaincontroller%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powerview%get-domaincontroller%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%createprocess.cs%' or lower(commandline) like '%get-system%createprocesssystem%' or lower(commandline) like '%get-system%createprocesssystembind%' or lower(commandline) like '%get-system%%namedpipesystem%') |  groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%createprocess.cs%' or lower(commandline) like '%get-system%createprocesssystem%' or lower(commandline) like '%get-system%createprocesssystembind%' or lower(commandline) like '%get-system%%namedpipesystem%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=* |  groupby stream, sourcename |  duration 1h

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%new-smbshare%' or lower(commandline) like '%remove-smbshare%' or lower(commandline) like '%remove-psdrive%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%new-smbshare%' or lower(commandline) like '%remove-smbshare%' or lower(commandline) like '%remove-psdrive%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%adfind.exe%-f%objectcategory=computer%' or lower(commandline) like '%adfind.exe%-sc%dclist%' or lower(commandline) like '%adfind.exe%-f%objectcategory=ntdsdsa%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%adfind.exe%-f%objectcategory=computer%' or lower(commandline) like '%adfind.exe%-sc%dclist%' or lower(commandline) like '%adfind.exe%-f%objectcategory=ntdsdsa%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wmic /node:% product where \"name like %\" call uninstall' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wmic /node:% product where \"name like %\" call uninstall' | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%cmd.exe%/q /c%1>%$%2>&1%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%cmd.exe%/q /c%1>%$%2>&1%") | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%$%/u%' or lower(commandline) like '%new-psdrive%-psprovider%filesystem%-root%$%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%$%/u%' or lower(commandline) like '%new-psdrive%-psprovider%filesystem%-root%$%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'((sc|schtasks).*?create.*?win32times)')  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'((sc|schtasks).*?create.*?win32times)') |  groupby user, system

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(parentcommandline),'((sc|schtasks).*?create.*?win32times)') and parentuser='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(parentcommandline),'((sc|schtasks).*?create.*?win32times)') | groupby parentuser, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(localappdata.*?md /c echo.*?type|http:|https:|-c write-host.*?net.webclient.*?::new.*?downloadstring|bypass|-exec|schtasks /create /sc daily.*?spawncmd.*?/c echo)') | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(localappdata.*?md /c echo.*?type|http:|https:|-c write-host.*?net.webclient.*?::new.*?downloadstring|bypass|-exec|schtasks /create /sc daily.*?spawncmd.*?/c echo)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),"(net.*?user|wmic.*?useraccount.*?get|powershell.*?(get-localuser|get-localgroupmember|get-wmiobject.*?-class.*?win32_useraccount|get-aduser)|lusrmgr|query.*?user|net.*?localgroup.*?administrators|net.*?group.*?administrators|net.*?group|net.*?accounts|net.*?localgroup|net.*?view|dsquery.*?user|dsget.*?user|reg.*?query.*?profilelist)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),"(net.*?user|wmic.*?useraccount.*?get|powershell.*?(get-localuser|get-localgroupmember|get-wmiobject.*?-class.*?win32_useraccount|get-aduser)|lusrmgr|query.*?user|net.*?localgroup.*?administrators|net.*?group.*?administrators|net.*?group|net.*?accounts|net.*?localgroup|net.*?view|dsquery.*?user|dsget.*?user|reg.*?query.*?profilelist)") | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%get-adcomputer%-properties *%' or rlike(lower(commandline),'get-adcomputer.*?-properties.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)') or lower(commandline) like '%get-adcomputer%-searchscope%subtree%-filter%name%-like %*%-properties *%' or rlike(lower(commandline),'adfind.*?-h.*?-s subtree -f.*?objectclass=computer.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%get-adcomputer%-properties *%' or rlike(lower(commandline),'get-adcomputer.*?-properties.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)') or lower(commandline) like '%get-adcomputer%-searchscope%subtree%-filter%name%-like %*%-properties *%' or rlike(lower(commandline),'adfind.*?-h.*?-s subtree -f.*?objectclass=computer.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe' and commandline like '%wmic /node:% product where \"name like %\" call uninstall' | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe' and commandline like '%wmic /node:% product where \"name like %\" call uninstall' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe' and commandline like '%wmic /node:% product where \"name like %\" call uninstall' | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(dir|ls|tree|find|locate|get-childitem|get-item|get-content|cat|findstr)\s+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(dir|ls|tree|find|locate|get-childitem|get-item|get-content|cat|findstr)\s+') | groupby user, system

stream=documents where sourcename='MS-O365' and action='REJECTED' and status='PASSED' and @Operation='AccessRequestRejected' and srcip='{SuspectHost}'

stream=documents where sourcename='MS-O365' and action='REJECTED' and status='PASSED' and @Operation='AccessRequestRejected' | groupby srcip 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wmic /node:% product where \"name like %\" call uninstall' | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wmic /node:% product where \"name like %\" call uninstall' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%cmd /c%for /l %x in (1,1,%) do start%/p%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%cmd /c%for /l %x in (1,1,%) do start%/p%' | groupby user, system | duration 1h

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%powershell.exe%ConvertTo-SecureString%Get-ChildItem -Path%Export-PfxCertificate%-FilePath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%powershell.exe%ConvertTo-SecureString%Get-ChildItem -Path%Export-PfxCertificate%-FilePath%') | groupby user, system

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'get-wmiobject.*?msacpi_thermalzonetemperature')) or (rlike(lower(commandline) , 'get-wmiobject.*?select-object -expandproperty.*?(manufacturer|model)') and rlike(lower(commandline), 'microsoft corporation.*?(vmware|virtual|virtualbox)')) | groupby user, system 

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'get-wmiobject.*?msacpi_thermalzonetemperature')) or (rlike(lower(commandline) , 'get-wmiobject.*?select-object -expandproperty.*?(manufacturer|model)') and rlike(lower(commandline), 'microsoft corporation.*?(vmware|virtual|virtualbox)')) stream=win-audit where action='OBJECT_ACCESSED' and (rlike(lower(scriptblocktext) , 'get-wmiobject.*?msacpi_thermalzonetemperature')) or (rlike(lower(scriptblocktext) , 'get-wmiobject.*?win32_computersystem.*?select-object -expandproperty.*?(manufacturer|model)') and rlike(lower(scriptblocktext), 'microsoft corporation.*?(vmware|virtual|virtualbox)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(dir|ls|tree|find|locate|get-childitem|get-item|get-content|cat|findstr)\s+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(dir|ls|tree|find|locate|get-childitem|get-item|get-content|cat|findstr)\s+') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '' | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=EP-PROCESS where action="PROCESS-CREATED" and ((parentimage like "explorer.exe" and image like "%.exe" and commandline like "%--encrypt%" or commandline like "%--symmetric%") or (parentimage like "powershell.exe" and commandline like "%New-Object Net.WebClient*DownloadFile%--encrypt%" or commandline like "%New-Object Net.WebClient*DownloadFile%--symmetric%") or (parentimage like "cmd.exe" and (commandline like "%gpg.exe%--encrypt%" or commandline like "%gpg.exe%--symmetric%")) or (parentimage like "cmd.exe" and (commandline like "%gpg2.exe%--encrypt%" or commandline like "%gpg2.exe%--symmetric%")) or parentimage like "cmd.exe" and (commandline like "%kleopatra.exe%--encrypt%" or commandline like "%kleopatra.exe%--symmetric%") or (commandline like "%gpg.exe%"" and parentimage like "%cmd.exe"))

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%createprocess.cs%' or lower(commandline) like '%get-system%createprocesssystem%' or lower(commandline) like '%get-system%createprocesssystembind%' or lower(commandline) like '%get-system%%namedpipesystem%') |  groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%createprocess.cs%' or lower(commandline) like '%get-system%createprocesssystem%' or lower(commandline) like '%get-system%createprocesssystembind%' or lower(commandline) like '%get-system%%namedpipesystem%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(foreach.*get-childitem.*path.*erroraction.*silentlycontinue.*out-file.*append)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%new-smbshare%' or lower(commandline) like '%remove-smbshare%' or lower(commandline) like '%remove-psdrive%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%new-smbshare%' or lower(commandline) like '%remove-smbshare%' or lower(commandline) like '%remove-psdrive%') | groupby user, system

stream=WIN-AUDIT where sourcename='WINDOWS' and sourcetype='OS' and action='POLICY_CHANGED' and status='PASSED' and category='POLICY' and eid in ('4706','4716') | groupby srcip

stream=WIN-AUDIT where sourcename='WINDOWS' and sourcetype='OS' and action='POLICY_CHANGED' and status='PASSED' and category='POLICY' and eid in ('4706','4716') and srcip='{SuspectHost}'

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%CurrentControlSet\\Control\\LSA /v RunAsPPL /t REG_DWORD /d 0%" | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%CurrentControlSet\\Control\\LSA /v RunAsPPL /t REG_DWORD /d 0%" | groupby user, system

stream=* |  groupby stream, sourcename |  duration 1d

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|winzip.*?-min -a -s|wzzip.*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|winzip.*?-min -a -s|wzzip.*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') | groupby user, system

stream=* |  groupby stream, sourcename |  duration 1d

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%CurrentControlSet\\Control\\LSA /v RunAsPPL /t REG_DWORD /d 0%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%CurrentControlSet\\Control\\LSA /v RunAsPPL /t REG_DWORD /d 0%" | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%CurrentControlSet\\Control\\LSA /v RunAsPPL /t REG_DWORD /d 0%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (image like "%powershell.exe" or image like "%cmd.exe" or image like "%rundll32.exe" or image like "%wscript.exe" or image like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe" or parentimage like "%rundll32.exe" or parentimage like "%wscript.exe" or parentimage like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=AUTHENTICATION where sourcename='WINDOWS' and sourcetype='OS' and action='LOGIN' and status='FAILED' and  reason='BAD_USER_PASSWORD' and @SubStatus='0xc000006e' | groupby srcip, user

stream=AUTHENTICATION where sourcename='WINDOWS' and sourcetype='OS' and action='LOGIN' and status='FAILED' and  reason='BAD_USER_PASSWORD' and @SubStatus='0xc000006e' and srcip='{SuspectHost}'

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%CurrentControlSet\\Control\\LSA /v RunAsPPL /t REG_DWORD /d 0%" | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like 'Msxml2.ServerXMLHTTP' or commandline like 'Msxml2.DOMDocument' or commandline like 'Msxml2.FreeThreadedDOMDocument' or commandline like 'Msxml2.MXXMLWriter') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like 'Msxml2.ServerXMLHTTP' or commandline like 'Msxml2.DOMDocument' or commandline like 'Msxml2.FreeThreadedDOMDocument' or commandline like 'Msxml2.MXXMLWriter') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%CurrentControlSet\\Control\\LSA /v RunAsPPL /t REG_DWORD /d 0%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%CurrentControlSet\\Control\\LSA /v RunAsPPL /t REG_DWORD /d 0%" | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=AUTHENTICATION where sourcename='WINDOWS' and sourcetype='OS' and action='LOGIN' and status='FAILED' and  reason='INVALID_USER' and @SubStatus='0XC000015B' | groupby srcip, user

stream=AUTHENTICATION where sourcename='WINDOWS' and sourcetype='OS' and action='LOGIN' and status='FAILED' and  reason='INVALID_USER' and @SubStatus='0XC000015B'and srcip='{SuspectHost}'

stream=WIN-AUDIT where sourcename='WINDOWS' and sourcetype='OS' and action='POLICY_CHANGED' and status='PASSED' and category='POLICY' and eid in ('4706','4707') and srcip='{SuspectHost}'

stream=WIN-AUDIT where sourcename='WINDOWS' and sourcetype='OS' and action='POLICY_CHANGED' and status='PASSED' and category='POLICY' and eid in ('4706','4707') | groupby srcip

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like 'Msxml2.ServerXMLHTTP' or commandline like 'Msxml2.DOMDocument' or commandline like 'Msxml2.FreeThreadedDOMDocument' or commandline like 'Msxml2.MXXMLWriter') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like 'Msxml2.ServerXMLHTTP' or commandline like 'Msxml2.DOMDocument' or commandline like 'Msxml2.FreeThreadedDOMDocument' or commandline like 'Msxml2.MXXMLWriter') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=* |  groupby stream, sourcename |  duration 1d

stream=authentication where action="LOGIN" and status="FAILED" |  duration 30m |  groupby user | having count_col1 >1000

stream=AUTHENTICATION where sourcename='WINDOWS' and sourcetype='OS' and action='LOGIN' and status='FAILED' and eid='4625' and reason='USER_DISABLED' and @SubStatus='0xc0000072' and srcip='{SuspectHost}'

stream=AUTHENTICATION where sourcename='WINDOWS' and sourcetype='OS' and action='LOGIN' and status='FAILED' and eid='4625' and reason='USER_DISABLED' and @SubStatus='0xc0000072' | groupby srcip, user

stream=WIN-AUDIT where sourcetype='OS' and not sourcename='NIX' and action='POLICY_CHANGED' and status='PASSED' and eid in ('4944','4945','4946','4947','4948','4949','4950','4951','4952','4954') and category='POLICY' | groupby srcip

stream=WIN-AUDIT where sourcetype='OS' and not sourcename='NIX' and action='POLICY_CHANGED' and status='PASSED' and eid in ('4944','4945','4946','4947','4948','4949','4950','4951','4952','4954') and category='POLICY' and srcip='{SuspectHost}'

stream=win-audit where action="PROCESS_CREATED" and newprocessname like "%powershell.exe%" and commandline like "%Set-WebConfiguration%system.webServer%httpLogging%dontLog%$true%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and newprocessname like "%powershell.exe%" and commandline like "%Set-WebConfiguration%system.webServer%httpLogging%dontLog%$true%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | duration 6m

stream=* |  groupby stream, sourcename |  duration 15m

stream=win-audit where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg add%Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCAHealth%REG_DWORD /d 1%' | groupby user, system

stream=WIN-AUDIT where sourcename='WINDOWS' and sourcetype='OS' and action='POLICY_CHANGED' and status='PASSED' and eid in ('4715','4780') and event='The audit policy (SACL) on an object was changed.' and category='POLICY' and user='{SuspectUser}'

stream=WIN-AUDIT where sourcename='WINDOWS' and sourcetype='OS' and action='POLICY_CHANGED' and status='PASSED' and eid in ('4715','4780') and event='The audit policy (SACL) on an object was changed.' and category='POLICY' | groupby user

stream=WIN-AUDIT where sourcename='WINDOWS' and sourcetype='OS' and eid in ('5137','5141','5136','4739') and srcip='{SuspectHost}' 

stream=WIN-AUDIT where sourcename='WINDOWS' and sourcetype='OS' and eid in ('5137','5141','5136','4739') | groupby srcip 

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%new-object%system.xml%xmlDoc%xml.load%' or lower(commandline) like 'system%xml%xmldoc%load%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and lower(commandline) like '%new-object%system.xml%xmlDoc%xml.load%' or lower(commandline) like 'system%xml%xmldoc%load%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=IAM where sourcename='WINDOWS' and action='USER_CREATED' and status='PASSED' and not user in ('IDMADM','AMBENE-CONTADM') and role='User Account Management' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=IAM where sourcename='WINDOWS' and action='USER_CREATED' and status='PASSED' and not user in ('IDMADM','AMBENE-CONTADM') and role='User Account Management' | groupby user, targetuser

stream=* |  groupby stream, sourcename |  duration 1d

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%mshta.exe%http%' or lower(commandline) like '%mshta.exe%https%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%mshta.exe%http%' or lower(commandline) like '%mshta.exe%https%') | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell%exe%New-ItemProperty%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%Name%EnableFirewall%PropertyType%DWORD%Value%0%' or commandline like '%powershell%exe%New-ItemProperty%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%Name%EnableFirewall%PropertyType%DWORD%Value%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell%exe%New-ItemProperty%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%Name%EnableFirewall%PropertyType%DWORD%Value%0%' or commandline like '%powershell%exe%New-ItemProperty%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%Name%EnableFirewall%PropertyType%DWORD%Value%0%') | groupby user, system 

stream=WIN-AUDIT where action="PROCESS_CREATED" and parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%" | groupby user, system

stream=* |  groupby stream, sourcename |  duration 15m

stream=* |  groupby stream, sourcename |  duration 1d

stream=* |  groupby stream, sourcename |  duration 15m

stream=EP-PROCESS where action="PROCESS_ADDED" and ( parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%") and (commandline like "%csc.exe%" or commandline like "%/target:exe%" or commandline like "%/code%" or commandline like "%/out%" or commandline like "%*%" ) | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and ( parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%") and (commandline like "%csc.exe%" or commandline like "%/target:exe%" or commandline like "%/code%" or commandline like "%/out%" or commandline like "%*%" ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=* |  groupby stream, sourcename |  duration 1d

stream=WIN-AUDIT where sourcename='WINDOWS' and action='OBJECT_ACCESSED' and status='PASSED' and object like '%Certutil%' | groupby user

stream=WIN-AUDIT where sourcename='WINDOWS' and action='OBJECT_ACCESSED' and status='PASSED' and object like '%Certutil%' and user='{SuspectUser}'

stream=AUTHENTICATION where sourcename='WINDOWS' and action='LOGIN' and status='FAILED' and eid='4625' | groupby srcip, user, eid, @Message 

stream=AUTHENTICATION where sourcename='WINDOWS' and action='LOGIN' and status='FAILED' and eid='4625' and srcip='{SuspectHost}'

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%new-object%system.xml%xmlDoc%xml.load%' or lower(commandline) like 'system%xml%xmldoc%load%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and lower(commandline) like '%new-object%system.xml%xmlDoc%xml.load%' or lower(commandline) like 'system%xml%xmldoc%load%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%powershell%exe%New-ItemProperty%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%Name%EnableFirewall%PropertyType%DWORD%Value%0%' or commandline like '%powershell%exe%New-ItemProperty%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%Name%EnableFirewall%PropertyType%DWORD%Value%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%powershell%exe%New-ItemProperty%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%Name%EnableFirewall%PropertyType%DWORD%Value%0%' or commandline like '%powershell%exe%New-ItemProperty%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%Name%EnableFirewall%PropertyType%DWORD%Value%0%') | groupby user, system 

stream=ep-process where processname='%AdvancedRun.exe%' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=ep-process where processname='%AdvancedRun.exe%' and (command like '%AdvancedRun.exe%' or command like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%system.xml%xmlDoc%xml.load%' or lower(commandline) like 'system%xml%xmldoc%load%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%new-object%system.xml%xmlDoc%xml.load%' or lower(commandline) like 'system%xml%xmldoc%load%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%mshta.exe%http%' or lower(commandline) like '%mshta.exe%https%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%mshta.exe%http%' or lower(commandline) like '%mshta.exe%https%') | groupby user, system

stream=WIN-AUDIT where sourcename='WINDOWS' and action='POLICY_CHANGED' and status='PASSED' and event='The workstation was locked.' and category='POLICY' | groupby srcip 

stream=WIN-AUDIT where sourcename='WINDOWS' and action='POLICY_CHANGED' and status='PASSED' and event='The workstation was locked.' and category='POLICY' and srcip='{SuspectHost}' 

stream=AUTHENTICATION where sourcename='WINDOWS' and action='LOGIN' and status='FAILED' and reason='BAD_USER_PASSWORD' and @Category='Credential Validation' and srcip='{SuspectHost}'

stream=AUTHENTICATION where sourcename='WINDOWS' and action='LOGIN' and status='FAILED' and reason='BAD_USER_PASSWORD' and @Category='Credential Validation' | groupby srcip

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload SysmonDrv%' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload SysmonDrv%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe','powershell.exe') and commandline like '%netsh%firewall%set%opmode%mode=disable%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe','powershell.exe') and commandline like '%netsh%firewall%set%opmode%mode=disable%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=IAM where sourcename='WINDOWS' and action='USER_DISABLED' and status='PASSED' and role='User Account Management' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=IAM where sourcename='WINDOWS' and action='USER_DISABLED' and status='PASSED' and role='User Account Management' | groupby user, targetuser

stream=EP-PROCESS | duration 10d | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe -Version%' or parentcommandline like '%powershell.exe -Version%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe -Version%' or parentcommandline like '%powershell.exe -Version%') | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and ((parentimage like "explorer.exe" and image like "%.exe" and commandline like "%--encrypt%" or commandline like "%--symmetric%") or (parentimage like "powershell.exe" and commandline like "%New-Object Net.WebClient*DownloadFile%--encrypt%" or commandline like "%New-Object Net.WebClient*DownloadFile%--symmetric%") or (parentimage like "cmd.exe" and (commandline like "%gpg.exe%--encrypt%" or commandline like "%gpg.exe%--symmetric%")) or (parentimage like "cmd.exe" and (commandline like "%gpg2.exe%--encrypt%" or commandline like "%gpg2.exe%--symmetric%")) or parentimage like "cmd.exe" and (commandline like "%kleopatra.exe%--encrypt%" or commandline like "%kleopatra.exe%--symmetric%") or (commandline like "%gpg.exe%"" and parentimage like "%cmd.exe")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS | duration 10d | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and ((parentimage like "explorer.exe" and image like "%.exe" and commandline like "%--encrypt%" or commandline like "%--symmetric%") or (parentimage like "powershell.exe" and commandline like "%New-Object Net.WebClient*DownloadFile%--encrypt%" or commandline like "%New-Object Net.WebClient*DownloadFile%--symmetric%") or (parentimage like "cmd.exe" and (commandline like "%gpg.exe%--encrypt%" or commandline like "%gpg.exe%--symmetric%")) or (parentimage like "cmd.exe" and (commandline like "%gpg2.exe%--encrypt%" or commandline like "%gpg2.exe%--symmetric%")) or parentimage like "cmd.exe" and (commandline like "%kleopatra.exe%--encrypt%" or commandline like "%kleopatra.exe%--symmetric%") or (commandline like "%gpg.exe%"" and parentimage like "%cmd.exe")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS | duration 10d | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and ((parentimage like "explorer.exe" and image like "%.exe" and commandline like "%--encrypt%" or commandline like "%--symmetric%") or (parentimage like "powershell.exe" and commandline like "%New-Object Net.WebClient*DownloadFile%--encrypt%" or commandline like "%New-Object Net.WebClient*DownloadFile%--symmetric%") or (parentimage like "cmd.exe" and (commandline like "%gpg.exe%--encrypt%" or commandline like "%gpg.exe%--symmetric%")) or (parentimage like "cmd.exe" and (commandline like "%gpg2.exe%--encrypt%" or commandline like "%gpg2.exe%--symmetric%")) or parentimage like "cmd.exe" and (commandline like "%kleopatra.exe%--encrypt%" or commandline like "%kleopatra.exe%--symmetric%") or (commandline like "%gpg.exe%"" and parentimage like "%cmd.exe")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS | duration 10d | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%powershell.exe -Version%' or parentcommandline like '%powershell.exe -Version%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe -Version%' or parentcommandline like '%powershell.exe -Version%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-REGISTRY where (registrypath like '%SYSTEM%CurrentControlSet%Services%SharedAccess%Parameters%FirewallPolicy%' or registrypath like '%SOFTWARE%Policies%Microsoft%WindowsFirewall%') and registryvaluename='EnableFirewall' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-REGISTRY where (registrypath like '%SYSTEM%CurrentControlSet%Services%SharedAccess%Parameters%FirewallPolicy%' or registrypath like '%SOFTWARE%Policies%Microsoft%WindowsFirewall%') and registryvaluename='EnableFirewall' | groupby user, system

stream=ep-registry where processname='%AdvancedRun.exe%' and (command like '%AdvancedRun.exe%' or command like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system


stream=EP-PROCESS where action="PROCESS_ADDED" and ((parentimage like "explorer.exe" and image like "%.exe" and commandline like "%--encrypt%" or commandline like "%--symmetric%") or (parentimage like "powershell.exe" and commandline like "%New-Object Net.WebClient*DownloadFile%--encrypt%" or commandline like "%New-Object Net.WebClient*DownloadFile%--symmetric%") or (parentimage like "cmd.exe" and (commandline like "%gpg.exe%--encrypt%" or commandline like "%gpg.exe%--symmetric%")) or (parentimage like "cmd.exe" and (commandline like "%gpg2.exe%--encrypt%" or commandline like "%gpg2.exe%--symmetric%")) or parentimage like "cmd.exe" and (commandline like "%kleopatra.exe%--encrypt%" or commandline like "%kleopatra.exe%--symmetric%") or (commandline like "%gpg.exe%"" and parentimage like "%cmd.exe")) | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and ((parentimage like "explorer.exe" and image like "%.exe" and commandline like "%--encrypt%" or commandline like "%--symmetric%") or (parentimage like "powershell.exe" and commandline like "%New-Object Net.WebClient*DownloadFile%--encrypt%" or commandline like "%New-Object Net.WebClient*DownloadFile%--symmetric%") or (parentimage like "cmd.exe" and (commandline like "%gpg.exe%--encrypt%" or commandline like "%gpg.exe%--symmetric%")) or (parentimage like "cmd.exe" and (commandline like "%gpg2.exe%--encrypt%" or commandline like "%gpg2.exe%--symmetric%")) or parentimage like "cmd.exe" and (commandline like "%kleopatra.exe%--encrypt%" or commandline like "%kleopatra.exe%--symmetric%") or (commandline like "%gpg.exe%"" and parentimage like "%cmd.exe")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%System.IO.Compression.DeflateStream%FromBase64String%' or scriptblocktext like '%System.IO.Compression.GzipStream%FromBase64String%' or scriptblocktext like '%IO.Compression.DeflateStream%FromBase64String%' or scriptblocktext like '%IO.Compression.GzipStream%FromBase64String%') | groupby user, system

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%System.IO.Compression.DeflateStream%FromBase64String%' or scriptblocktext like '%System.IO.Compression.GzipStream%FromBase64String%' or scriptblocktext like '%IO.Compression.DeflateStream%FromBase64String%' or scriptblocktext like '%IO.Compression.GzipStream%FromBase64String%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload SysmonDrv%' | groupby user, system

stream=IAM where sourcename='WINDOWS' and action='PASSWORD_CHANGED' and status='PASSED' and role='User Account Management' | groupby user, targetuser

stream=IAM where sourcename='WINDOWS' and action='PASSWORD_CHANGED' and status='PASSED' and role='User Account Management' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=EP-Process where action="PROCESS_ADDED" and (parentcommandline like "%csc.exe%" or parentcommandline like "%/target:exe%" or parentcommandline like "%/code%" or parentcommandline like "%/out%" or parentcommandline like "%*%" ) | groupby sytem, user

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload SysmonDrv%' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload SysmonDrv%' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and ( parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%") and (commandline like "%csc.exe%" or commandline like "%/target:exe%" or commandline like "%/code%" or commandline like "%/out%" or commandline like "%*%" ) | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload SysmonDrv%' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload SysmonDrv%' | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | duration 6m

stream=authentication

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-Process where action="PROCESS_ADDED" and (commandline like "%csc.exe%" or commandline like "%/target:exe%" or commandline like "%/code%" or commandline like "%/out%" or commandline like "%*%" ) | groupby sytem, user

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload SysmonDrv%' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload SysmonDrv%' | groupby user, system

stream=signals

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%cmd /c%for /l %x in (1,1,%) do start%/p%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%cmd /c%for /l %x in (1,1,%) do start%/p%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and ( parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%") and (commandline like "%csc.exe%" or commandline like "%/target:exe%" or commandline like "%/code%" or commandline like "%/out%" or commandline like "%*%" ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and ( parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%") and (commandline like "%csc.exe%" or commandline like "%/target:exe%" or commandline like "%/code%" or commandline like "%/out%" or commandline like "%*%" ) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(foreach.*get-childitem.*path.*erroraction.*silentlycontinue.*out-file.*append)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(foreach.*get-childitem.*path.*erroraction.*silentlycontinue.*out-file.*append)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(net user.*?add.*?net localgroup.*?administrators.*?add|net user.*?add|new-localuser.*?name|createnewlocaladmin.*?\.)') |  groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(net user.*?add.*?net localgroup.*?administrators.*?add|net user.*?add|new-localuser.*?name|createnewlocaladmin.*?\.)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%CurrentControlSet\\Control\\LSA /v RunAsPPL /t REG_DWORD /d 0%" | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%CurrentControlSet\\Control\\LSA /v RunAsPPL /t REG_DWORD /d 0%" | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | duration 6m

stream=EP-Process where action="PROCESS_ADDED" and ( commandline like "csc.exe" or commandline like "target:exe" or commandline like "code" or commandline like "out" )

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "C\:\\\\Windows\\\\Microsoft\.NET\\\\Framework64\\\\v4\.0\.30319\\\\csc\.exe" and parentcommandline like "%/noconfig /fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=console

stream=win-audit where action="OBJECT_ACCESSED" and ScriptBlockText="%Win32_Process%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="OBJECT_ACCESSED" and scriptblocktext like "%Win32_Process%" | groupby system, user

stream=ep-process where action="PROCESS_ADDED" and parentcommandline like "%powershell.exe%" and parentcommandline like "%Win32_Process%" | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(foreach.*get-childitem.*path.*erroraction.*silentlycontinue.*out-file.*append)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(foreach.*get-childitem.*path.*erroraction.*silentlycontinue.*out-file.*append)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'kerbrute.*?userenum.*?(-d|--dc|-t|-o|-safe)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'kerbrute.*?userenum.*?(-d|--dc|-t|-o|-safe)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=threat where sourcetype='ENDPOINT-SECURITY' AND sourcename='PALOALTO-CORTEX' | duration 1h | limit 1 | groupby system, file, threat

stream=threat where sourcetype='ENDPOINT-SECURITY' AND sourcename='PALOALTO-CORTEX' and file='{SuspectObject}' and system='{TargetHost}' | duration 1h

stream=win-audit where action='PROCESS_CREATED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like "%msxsl.exe%.xml%.xsl%" | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like "%msxsl.exe%.xml%.xsl%"  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (image like "%powershell.exe" or image like "%cmd.exe" or image like "%rundll32.exe" or image like "%wscript.exe" or image like "%cscript.exe" ) and commandline like "%.js%" |  groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe" or parentimage like "%rundll32.exe" or parentimage like "%wscript.exe" or parentimage like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=win-audit where action='PROCESS_CREATED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | duration 6m

stream=authentication where eid='4768' and not user like '%$' | groupby user,employee_department | duration 7d

stream=EP-PROCESS where action='PROCESS_ADDED' and (image like '%netsh.exe%' or image like '%powershell.exe%' or image like '%cmd.exe%') and (commandline like 'netsh%advfirewall%set%currentprofile%state%off%' or commandline like '%powershell.exe%Command%Disable-NetFirewallRule%All%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (image like '%netsh.exe%' or image like '%powershell.exe%' or image like '%cmd.exe%') and (commandline like 'netsh%advfirewall%set%currentprofile%state%off%' or commandline like '%powershell.exe%Command%Disable-NetFirewallRule%All%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | groupby user, system

stream=EP-Process where action="PROCESS_ADDED" and ( commandline like "csc.exe" or commandline like "target:exe" or commandline like "code" or commandline like "out" ) | groupby system, user 

stream=EP-Process where action="PROCESS_ADDED" and ( commandline like "csc.exe" or commandline like "target:exe" or commandline like "code" or commandline like "out" ) | system, user and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-File where action="FILE_CREATED" and ( commandline like "csc.exe" or commandline like "target:exe" or commandline like "code" or commandline like "out" ) | groupby system, user

stream=EP-File where action="FILE_CREATED" and ( commandline like "csc.exe" or commandline like "target:exe" or commandline like "code" or commandline like "out" ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-File where action="FILE_CREATED" and ( commandline like "csc.exe" or commandline like "target:exe" or commandline like "code" or commandline like "out" ) | groupby system, user

stream=EP-File where action="FILE_CREATED" and ( commandline like "csc.exe" or commandline like "target:exe" or commandline like "code" or commandline like "out" ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and parentcommandline like "%powershell.exe%" and parentcommandline like "%Win32_Process%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and parentcommandline like "%powershell.exe%" and parentcommandline like "%Win32_Process%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and parentcommandline like "%powershell.exe%" and parentcommandline like "%Win32_Process%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and parentcommandline like "%powershell.exe%" and parentcommandline like "%Win32_Process%" | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like "%sc.exe delete sysmon%" or commandline like "%reg delete%" or commandline like  "%sysmon*" or commandline like "%Remove-Item%" or commandline like "%sysmon%" or commandline like "%sysmon -u%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like "%sc.exe delete sysmon%" or commandline like "%reg delete%" or commandline like  "%sysmon*" or commandline like "%Remove-Item%" or commandline like "%sysmon%" or commandline like "%sysmon -u%") | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | groupby user, system

stream=EP-Process where action="PROCESS_ADDED" and ( commandline like "csc.exe" or commandline like "target:exe" or commandline like "code" or commandline like "out" ) | groupby system, user 

stream=EP-Process where action="PROCESS_ADDED" and ( commandline like "csc.exe" or commandline like "target:exe" or commandline like "code" or commandline like "out" ) | system, user and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-File where action="FILE_CREATED" and ( commandline like "csc.exe" or commandline like "target:exe" or commandline like "code" or commandline like "out" ) | groupby system, user

stream=EP-File where action="FILE_CREATED" and ( commandline like "csc.exe" or commandline like "target:exe" or commandline like "code" or commandline like "out" ) | system, user and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-Process where action="PROCESS_ADDED" and ( commandline like "csc.exe" or commandline like "target:exe" or commandline like "code" or commandline like "out" ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-Process where action="PROCESS_ADDED" and ( commandline like "csc.exe" or commandline like "target:exe" or commandline like "code" or commandline like "out" ) | groupby system, user 

stream=win-audit where action="OBJECT_ACCESSED" and ScriptBlockText="%Win32_Process%" | groupby system, user

stream=win-audit where action="OBJECT_ACCESSED" and scriptblocktext like "%Win32_Process%" | groupby system, user

stream=win-audit where action="OBJECT_ACCESSED" and ScriptBlockText="%Win32_Process%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') | groupby user, system

stream=win-audit where action="OBJECT_ACCESSED" and ScriptBlockText="%Win32_Process%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="OBJECT_ACCESSED" and ScriptBlockText="%Win32_Process%" | groupby system, user

stream=win-audit where action="OBJECT_ACCESSED" and scriptblocktext like "%Win32_Process%" | groupby system, user

stream=win-audit where action="OBJECT_ACCESSED" and ScriptBlockText="%Win32_Process%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-REGISTRY where (registrypath like '%\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\%' or registrypath like '%\\SOFTWARE\\Policies\\Microsoft\\WindowsFirewall\\%') and registryvaluename='EnableFirewall' | groupby user, system

stream=EP-REGISTRY where (registrypath like '%\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\%' or registrypath like '%\\SOFTWARE\\Policies\\Microsoft\\WindowsFirewall\\%') and registryvaluename='EnableFirewall' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe" and commandline like "%New-Object IO.FileStream%Open%Read%ReadWrite%" | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe" and commandline like "%New-Object IO.FileStream%Open%Read%ReadWrite%" and user='{SuspectUser}' and system='{TargetSystem}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (image like '%netsh.exe%' or image like '%powershell.exe%' or image like '%cmd.exe%') and (commandline like 'netsh%advfirewall%set%currentprofile%state%off%' or commandline like '%powershell.exe%Command%Disable-NetFirewallRule%All%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (image like '%netsh.exe%' or image like '%powershell.exe%' or image like '%cmd.exe%') and (commandline like 'netsh%advfirewall%set%currentprofile%state%off%' or commandline like '%powershell.exe%Command%Disable-NetFirewallRule%All%') | groupby user, system

stream=win-audit where action="OBJECT_ACCESSED" and ScriptBlockText="%Win32_Process%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="OBJECT_ACCESSED" and scriptblocktext like "%Win32_Process%" | groupby system, user

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), "trufflesnout.*?(domain|forest)") and user='{SUspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), "trufflesnout.*?(domain|forest)") | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and lower(commandline) like "%msxsl.exe%.xml%.xsl%" | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and lower(commandline) like "%msxsl.exe%.xml%.xsl%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like "%amsiInitFailed%" or commandline like "%ScanContent%" or commandline like "%amsiContext%" or commandline like "%amsiSession%" commandline like "%AmsiUtils.Init()%" or commandline like "%AmsiScanBuffer%" or commandline like "%amsi.dll%")  and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like "%amsiInitFailed%" or commandline like "%ScanContent%" or commandline like "%amsiContext%" or commandline like "%amsiSession%" commandline like "%AmsiUtils.Init()%" or commandline like "%AmsiScanBuffer%" or commandline like "%amsi.dll%") | groupby user, system

stream=nta-rdp where action = '{TargetUser}' | duration 1h

stream=nta-rdp where cookie = 'Administrator' or cookie = 'raiAdmin' | duration 1h

stream=authentication where eid='4771' and not user like '%$' |  groupby user,employee_department,srcip |  duration 7d

stream=ep-process where action="PROCESS_ADDED" and parentcommandline like "%powershell.exe%" and parentcommandline like "%Win32_Process%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and parentcommandline like "%powershell.exe%" and parentcommandline like "%Win32_Process%" | groupby user, system

stream=authentication where eid = "4771" or eid = "4768" | groupby user, eid, employee_department,systemtstamp, cnamtime |  duration 7d

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adfind.*s.*base.*(lockoutduration|lockoutthreshold|lockoutobservationwindow|maxpwdage|minpwdage|minpwdlength|pwdhistorylength|pwdproperties)') or lower(commandline) like '%adfind%-sc admincountdmp%' or lower(commandline) like '%adfind%-f%objectcategory=person%' or lower(commandline) like '%adfind%-sc exchaddresses%' or lower(commandline) like '%adfind%-f%objectcategory=person%objectclass=user%memberof=cn=administrators%' or lower(commandline) like '%adfind%-f%objectcategory=group%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adfind.*s.*base.*(lockoutduration|lockoutthreshold|lockoutobservationwindow|maxpwdage|minpwdage|minpwdlength|pwdhistorylength|pwdproperties)') or lower(commandline) like '%adfind%-sc admincountdmp%' or lower(commandline) like '%adfind%-f%objectcategory=person%' or lower(commandline) like '%adfind%-sc exchaddresses%' or lower(commandline) like '%adfind%-f%objectcategory=person%objectclass=user%memberof=cn=administrators%' or lower(commandline) like '%adfind%-f%objectcategory=group%') | groupby user, system

stream=EP-REGISTRY where (registrypath like '%\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\%' or registrypath like '%\\SOFTWARE\\Policies\\Microsoft\\WindowsFirewall\\%') and registryvaluename='EnableFirewall' | groupby user, system

stream=EP-REGISTRY where (registrypath like '%\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\%' or registrypath like '%\\SOFTWARE\\Policies\\Microsoft\\WindowsFirewall\\%') and registryvaluename='EnableFirewall' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like "%amsiInitFailed%" or commandline like "%ScanContent%" or commandline like "%amsiContext%" or commandline like "%amsiSession%" commandline like "%AmsiUtils.Init()%" or commandline like "%AmsiScanBuffer%" or commandline like "%amsi.dll%")  and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like "%amsiInitFailed%" or commandline like "%ScanContent%" or commandline like "%amsiContext%" or commandline like "%amsiSession%" commandline like "%AmsiUtils.Init()%" or commandline like "%AmsiScanBuffer%" or commandline like "%amsi.dll%") | groupby user, system

stream=authentication where (eid='4768' or eid='4769' or eid='4771' or eid='4776') and not user like '%$%' | groupby user,employee_department,action,eid | duration 7d

stream=signals

stream=WIN-AUDIT where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and (newprocessname like "%powershell.exe%" and rlike(commandline (.*-encodedcommand.*|.*-exec bypass.*|.*Invoke-WmiMethod.*|.*wmic\sprocess\scall\screate.*))) or rlike(scriptblocktext (.*-encodedcommand.*|.*-exec bypass.*|.*Invoke-WmiMethod.*|.*wmic\sprocess\scall\screate.*)) | groupby system

stream=WIN-AUDIT where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and (newprocessname like "%powershell.exe%" and rlike(commandline (.*-encodedcommand.*|.*-exec bypass.*|.*Invoke-WmiMethod.*|.*wmic\sprocess\scall\screate.*))) or rlike(scriptblocktext (.*-encodedcommand.*|.*-exec bypass.*|.*Invoke-WmiMethod.*|.*wmic\sprocess\scall\screate.*)) | groupby system

stream=win-audit where action='PROCESS_CREATED' and (commandline like "%sc.exe delete sysmon%" or commandline like "%reg delete%" or commandline like  "%sysmon*" or commandline like "%Remove-Item%" or commandline like "%sysmon%" or commandline like "%sysmon -u%") | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like "%sc.exe delete sysmon%" or commandline like "%reg delete%" or commandline like  "%sysmon*" or commandline like "%Remove-Item%" or commandline like "%sysmon%" or commandline like "%sysmon -u%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('netsh.exe','cmd.exe','powershell.exe') and (commandline like '%advfirewall firewall set rule group=%remote desktop%new enable=Yes%' or commandline like '%advfirewall firewall set rule group=%file and printer sharing%new enable=Yes%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('netsh.exe','cmd.exe','powershell.exe') and (commandline like '%advfirewall firewall set rule group=%remote desktop%new enable=Yes%' or commandline like '%advfirewall firewall set rule group=%file and printer sharing%new enable=Yes%') | groupby user, system

stream=ep-process,win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(windowsaudiodevice-powershell-cmdlet|get-audiodevice|set-audiodevice|toggle-audiodevice|write-audiodevice|start-audiodevicecapture)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process,win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(windowsaudiodevice-powershell-cmdlet|get-audiodevice|set-audiodevice|toggle-audiodevice|write-audiodevice|start-audiodevicecapture)") | duration 2h

stream=ep-process,win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(windowsaudiodevice-powershell-cmdlet|get-audiodevice|set-audiodevice|toggle-audiodevice|write-audiodevice|start-audiodevicecapture)") | groupby user, system

stream=ep-process,win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(windowsaudiodevice-powershell-cmdlet|get-audiodevice|set-audiodevice|toggle-audiodevice|write-audiodevice|start-audiodevicecapture)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and (newprocessname like "%powershell.exe%" and rlike(commandline (.*-encodedcommand.*|.*-exec bypass.*|.*Invoke-WmiMethod.*|.*wmic\sprocess\scall\screate.*))) or rlike(scriptblocktext (.*-encodedcommand.*|.*-exec bypass.*|.*Invoke-WmiMethod.*|.*wmic\sprocess\scall\screate.*)) | groupby system

stream=ep-process, win-audit where action in ('PROCESS_CRETAED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?microphone') | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CRETAED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?microphone') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and and rlike(lower(targetobject), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?microphone') | groupby user, system

stream=WIN-AUDIT where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and (newprocessname like "%powershell.exe%" and rlike(commandline (.*-encodedcommand.*|.*-exec bypass.*|.*Invoke-WmiMethod.*|.*wmic\sprocess\scall\screate.*))) or rlike(scriptblocktext (.*-encodedcommand.*|.*-exec bypass.*|.*Invoke-WmiMethod.*|.*wmic\sprocess\scall\screate.*)) | groupby user, system

stream=WIN-AUDIT where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and ((newprocessname like "%powershell.exe%" and rlike(commandline, '(.*-encodedcommand.*|.*-exec bypass.*|.*Invoke-WmiMethod.*|.*wmic\sprocess\scall\screate.*)')) or (rlike(scriptblocktext, '(.*-encodedcommand.*|.*-exec bypass.*|.*Invoke-WmiMethod.*|.*wmic\sprocess\scall\screate.*)'))) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like "%\\Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable\\%"	or commandlinelike "%\\CurrentControlSet\\Services\\Amsi%" or commandline like "%\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellServiceObjects\\{B3C418EE-30F7-4E66-B436-725E99247AC5}%" or commandline like "%\\Microsoft\\Windows Defender\\%" or commandline like "%\\SOFTWARE\\Microsoft\\AMSI\\Providers\\{2781761E-28E0-4109-99FE-B9D127C57AFE}%") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like "%\\Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable\\%"	or commandlinelike "%\\CurrentControlSet\\Services\\Amsi%" or commandline like "%\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellServiceObjects\\{B3C418EE-30F7-4E66-B436-725E99247AC5}%" or commandline like "%\\Microsoft\\Windows Defender\\%" or commandline like "%\\SOFTWARE\\Microsoft\\AMSI\\Providers\\{2781761E-28E0-4109-99FE-B9D127C57AFE}%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and (scriptblocktext like "%wmic.exe%" or scriptblocktext like '%Namespace%root%Microsoft%Windows%Defender%' or scriptblocktext like "%call%" scriptblocktext like "%ExclusionPath=%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where action='OBJECT_ACCESSED' and (scriptblocktext like "%wmic.exe%" or scriptblocktext like '%Namespace%root%Microsoft%Windows%Defender%' or scriptblocktext like "%call%" scriptblocktext like "%ExclusionPath=%") | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (scriptblocktext like "%amsiInitFailed%" or scriptblocktext like "%ScanContent%" or scriptblocktext like "%amsiContext%" or scriptblocktext like "%amsiSession%" scriptblocktext like "%AmsiUtils.Init()%" or scriptblocktext like "%AmsiScanBuffer%" or scriptblocktext like "%amsi.dll%") | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (scriptblocktext like "%amsiInitFailed%" or scriptblocktext like "%ScanContent%" or scriptblocktext like "%amsiContext%" or scriptblocktext like "%amsiSession%" scriptblocktext like "%AmsiUtils.Init()%" or scriptblocktext like "%AmsiScanBuffer%" or scriptblocktext like "%amsi.dll%")  and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('netsh.exe','cmd.exe','powershell.exe') and (commandline like '%advfirewall firewall set rule group=%remote desktop%new enable=Yes%' or commandline like '%advfirewall firewall set rule group=%file and printer sharing%new enable=Yes%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('netsh.exe','cmd.exe','powershell.exe') and (commandline like '%advfirewall firewall set rule group=%remote desktop%new enable=Yes%' or commandline like '%advfirewall firewall set rule group=%file and printer sharing%new enable=Yes%') | groupby user, system

stream=nta-files,nta-http where fid='{SespectObject}' | duration 24h

stream=nta-files where fid in (_FID_) and lower(analyzer) like "%pe%" | duration 24h

stream=nta-http where mimetype = 'application/x-dosexec' |  duration 24h

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('netsh.exe','cmd.exe','powershell.exe') and (commandline like '%advfirewall firewall set rule group=%remote desktop%new enable=Yes%' or commandline like '%advfirewall firewall set rule group=%file and printer sharing%new enable=Yes%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('netsh.exe','cmd.exe','powershell.exe') and (commandline like '%advfirewall firewall set rule group=%remote desktop%new enable=Yes%' or commandline like '%advfirewall firewall set rule group=%file and printer sharing%new enable=Yes%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('netsh.exe','cmd.exe','powershell.exe') and (commandline like '%advfirewall firewall set rule group=%remote desktop%new enable=Yes%' or commandline like '%advfirewall firewall set rule group=%file and printer sharing%new enable=Yes%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('netsh.exe','cmd.exe','powershell.exe') and (commandline like '%advfirewall firewall set rule group=%remote desktop%new enable=Yes%' or commandline like '%advfirewall firewall set rule group=%file and printer sharing%new enable=Yes%') | groupby user, system

stream=nta-files where fid in (_FID_) and lower(analyzer) like "%pe%" | duration 24h

stream=nta-http where mimetype = 'application/x-dosexec' |  duration 24h

stream=nta-files,nta-http where fid='{SuspectObject}' | duration 24h

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), "(powerview|powershell)") and rlike(lower(commandline), "(get-domaintrust|get-foresttrust|get-netdomaintrust|get-netforesttrust|get-addomain|get-adgroupmember)") | duration 1h

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), "(powerview|powershell)") and rlike(lower(commandline), "(get-domaintrust|get-foresttrust|get-netdomaintrust|get-netforesttrust|get-addomain|get-adgroupmember)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep_process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace:\\root\\Microsoft\\Windows\\Defender%' or commandline like '%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') |  groupby user, system

stream=ep_process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace:\\root\\Microsoft\\Windows\\Defender%' or commandline like '%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') | groupby user, system

stream=ep-registry where processname='%AdvancedRun.exe%' and (command like '%AdvancedRun.exe%' or command like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=nta-files,nta-http where fid='{SespectObject}' | duration 24h

stream=nta-files where fid in (_FID_) and lower(analyzer) like "%pe%" | duration 24h

stream=nta-http where mimetype = 'application/x-dosexec' |  duration 24h

stream=ep_process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace:\\root\\Microsoft\\Windows\\Defender%' or commandline like '%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') |  groupby user, system

stream=ep_process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace:\\root\\Microsoft\\Windows\\Defender%' or commandline like '%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep_process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace:\\root\\Microsoft\\Windows\\Defender%' or commandline like '%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') |  groupby user, system

stream=ep_process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace:\\root\\Microsoft\\Windows\\Defender%' or commandline like '%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process,win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(windowsaudiodevice-powershell-cmdlet|get-audiodevice|set-audiodevice|toggle-audiodevice|write-audiodevice|start-audiodevicecapture)") | groupby user, system

stream=ep-process,win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(windowsaudiodevice-powershell-cmdlet|get-audiodevice|set-audiodevice|toggle-audiodevice|write-audiodevice|start-audiodevicecapture)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-registry | duration 1h

stream=ep-process where processname='%AdvancedRun.exe%' and (command like '%AdvancedRun.exe%' or command like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | duration 6m

stream=ep-process where processname='%AdvancedRun.exe%' and (command like '%AdvancedRun.exe%' or command like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('netsh.exe','cmd.exe','powershell.exe') and (commandline like '%advfirewall firewall set rule group=%remote desktop%new enable=Yes%' or commandline like '%advfirewall firewall set rule group=%file and printer sharing%new enable=Yes%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('netsh.exe','cmd.exe','powershell.exe') and (commandline like '%advfirewall firewall set rule group=%remote desktop%new enable=Yes%' or commandline like '%advfirewall firewall set rule group=%file and printer sharing%new enable=Yes%') | groupby user, system

stream=ep_process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace:\\root\\Microsoft\\Windows\\Defender%' or commandline like '%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') |  groupby user, system

stream=ep_process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace:\\root\\Microsoft\\Windows\\Defender%' or commandline like '%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=authentication where eid='4769' and not user like '%$%' | groupby user,employee_department | duration 7d

stream=ep_process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace:\\root\\Microsoft\\Windows\\Defender%' or commandline like '%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace:\\root\\Microsoft\\Windows\\Defender%' or commandline like '%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') |  groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace%root%Microsoft%Windows%Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace%root%Microsoft%Windows%Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') |  groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%wmic.exe%' or commandline like '%Namespace:\\root\\Microsoft\\Windows\\Defender%' or commandline like '%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%wmic.exe%' or commandline like '%Namespace:\\root\\Microsoft\\Windows\\Defender%' or commandline like '%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%wmic.exe%' or commandline like '%Namespace:\\root\\Microsoft\\Windows\\Defender%' or commandline like '%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%')and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and (commandline like "%\\Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable\\%"	or commandlinelike "%\\CurrentControlSet\\Services\\Amsi%" or commandline like "%\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellServiceObjects\\{B3C418EE-30F7-4E66-B436-725E99247AC5}%" or commandline like "%\\Microsoft\\Windows Defender\\%" or commandline like "%\\SOFTWARE\\Microsoft\\AMSI\\Providers\\{2781761E-28E0-4109-99FE-B9D127C57AFE}%") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like "%\\Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable\\%"	or commandlinelike "%\\CurrentControlSet\\Services\\Amsi%" or commandline like "%\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellServiceObjects\\{B3C418EE-30F7-4E66-B436-725E99247AC5}%" or commandline like "%\\Microsoft\\Windows Defender\\%" or commandline like "%\\SOFTWARE\\Microsoft\\AMSI\\Providers\\{2781761E-28E0-4109-99FE-B9D127C57AFE}%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') | groupby user, system

stream=EP-REGISTRY where (registrypath like "%\\Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable\\%" or registrypath "%\\CurrentControlSet\\Services\\Amsi%" or registrypath like "%\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellServiceObjects\\{B3C418EE-30F7-4E66-B436-725E99247AC5}%" or registrypath like "%\\Microsoft\\Windows Defender\\%" or registrypath like "%\\SOFTWARE\\Microsoft\\AMSI\\Providers\\{2781761E-28E0-4109-99FE-B9D127C57AFE}%") | groupby user, system

stream=EP-REGISTRY where (registrypath like "%\\Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable\\%" or registrypath "%\\CurrentControlSet\\Services\\Amsi%" or registrypath like "%\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellServiceObjects\\{B3C418EE-30F7-4E66-B436-725E99247AC5}%" or registrypath like "%\\Microsoft\\Windows Defender\\%" or registrypath like "%\\SOFTWARE\\Microsoft\\AMSI\\Providers\\{2781761E-28E0-4109-99FE-B9D127C57AFE}%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where processname='%AdvancedRun.exe%' and (command like '%AdvancedRun.exe%' or command like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | duration 6m

stream=ep-process where processname='%AdvancedRun.exe%' and (command like '%AdvancedRun.exe%' or command like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%wmic.exe%' or commandline like '%Namespace:\\root\\Microsoft\\Windows\\Defender%' or commandline like '%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%wmic.exe%' or commandline like '%Namespace:\\root\\Microsoft\\Windows\\Defender%' or commandline like '%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%')and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%wmic.exe%' or commandline like '%Namespace:\\root\\Microsoft\\Windows\\Defender%' or commandline like '%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%wmic.exe%' or commandline like '%Namespace:\\root\\Microsoft\\Windows\\Defender%' or commandline like '%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where action='OBJECT_ACCESSED' and (scriptblocktext like "%wmic.exe%" or scriptblocktext like "%Namespace:\\root\\Microsoft\\Windows\\Defender%" or scriptblocktext like "%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%" or scriptblocktext like "%call%" scriptblocktext like "%ExclusionPath=%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where action='OBJECT_ACCESSED' and (scriptblocktext like "%wmic.exe%" or scriptblocktext like "%Namespace:\\root\\Microsoft\\Windows\\Defender%" or scriptblocktext like "%Namespace:\\\\root\\\\Microsoft\\\\Windows\\\\Defender%" or scriptblocktext like "%call%" scriptblocktext like "%ExclusionPath=%") | groupby user, system

stream=sysmon-network where dstport="389" | duration 1d | groupby system,dstip,srcip,devsrcip,user | limit 100

stream=ep-process where action='PROCESS_ADDED' and (commandline like "%\\Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable\\%"	or commandlinelike "%\\CurrentControlSet\\Services\\Amsi%" or commandline like "%\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellServiceObjects\\{B3C418EE-30F7-4E66-B436-725E99247AC5}%" or commandline like "%\\Microsoft\\Windows Defender\\%" or commandline like "%\\SOFTWARE\\Microsoft\\AMSI\\Providers\\{2781761E-28E0-4109-99FE-B9D127C57AFE}%") | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like "%\\Software\\Microsoft\\Windows Script\\Settings\\AmsiEnable\\%"	or commandlinelike "%\\CurrentControlSet\\Services\\Amsi%" or commandline like "%\\Microsoft\\Windows\\CurrentVersion\\Explorer\\ShellServiceObjects\\{B3C418EE-30F7-4E66-B436-725E99247AC5}%" or commandline like "%\\Microsoft\\Windows Defender\\%" or commandline like "%\\SOFTWARE\\Microsoft\\AMSI\\Providers\\{2781761E-28E0-4109-99FE-B9D127C57AFE}%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%wmic.exe%' or commandline like '%Namespace%root%Microsoft%Windows%Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%wmic.exe%' or commandline like '%Namespace%root%Microsoft%Windows%Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like 'reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like 'reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like 'reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like 'reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where processname='%AdvancedRun.exe%' and (command like '%AdvancedRun.exe%' or command like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=ep-process where processname='%AdvancedRun.exe%' and (command like '%AdvancedRun.exe%' or command like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | duration 6m

stream=ep-process where processname='%AdvancedRun.exe%' and (command like '%AdvancedRun.exe%' or command like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | duration 6m

stream=ep-process where processname='%AdvancedRun.exe%' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%reg  add%\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCANetwork%REG_DWORD /d 1' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%reg  add%\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCANetwork%REG_DWORD /d 1' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (parentimage like '%powershell.exe' or parentimage like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (image like '%powershell.exe' or image like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like 'reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like 'reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like 'reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like 'reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=nta-files,nta-http where fid='{SespectObject}' | duration 24h

stream=nta-files where fid in (_FID_) and lower(analyzer) like "%pe%" | duration 24h

stream=nta-http where mimetype = 'application/x-dosexec' |  duration 24h

stream=ep-process where processname='%AdvancedRun.exe%' and (command like '%AdvancedRun.exe%' or command like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | duration 6m

stream=ep-process where processname='%AdvancedRun.exe%' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=win-audit where newprocessname='%AdvancedRun.exe%' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=win-audit where newprocessname='%AdvancedRun.exe%' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | duration 6m

stream=EP-PROCESS where action in ('PROCESS_ADDED','OBJECT_ACCESSED') and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action in ('PROCESS_ADDED','OBJECT_ACCESSED') and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') | groupby user, system

stream=ep-registry where action='OBJECT_MODIFIED' and targetobject='%Software%Microsoft%Office%Resiliency%' | groupby system, targetobject, user | limit 100

stream=ep-registry where action='OBJECT_MODIFIED' and targetobject='%Software%Microsoft%Office%Resiliency%' and system='{TargetHost}'

stream=WIN-AUDIT where eid='4663' and @event_category="Removable Storage" and (@access="WriteData%" or @access="%AppendData%") | select distinct_count(object) as DataCopied | groupby user | having DataCopied>100

stream=signals | duration 12m

stream=signals | duration 12m | limit 1

stream=signals | duration 12m | limit 1

stream=signals | duration 12m

stream=signals | duration 12m

stream=win-audit where action='PROCESS_CREATED' and  | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz%exe%crypto%certificate%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6 m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz%exe%crypto%certificate%export%') | groupby user,system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz%exe%crypto%certificate%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6 m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz%exe%crypto%certificate%export%') | groupby user,system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Get-System.ps1%Get-System -Technique NamedPipe -Verbose%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Get-System.ps1%Get-System -Technique NamedPipe -Verbose%" | groupby user, system

stream=* where sourcename="JUNOS" | duration 7d | groupby devsrcip, sourcename | limit 100

stream=* where sourcename="JUNOS" and not stream="OTHER" | duration 7d | groupby stream | limit 100

stream=ep-process where eid='1' and ((image like '%bginfo.exe%' and commandline like '%nolicprompt%' and commandline like '%popup%') or image like '%odbcconf.exe%' or image like '%dnx.exe%') | duration 2d | select image,system, user | limit 10

stream=win-audit where newprocessname='%AdvancedRun.exe%' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=ep-process where eid='1' and ((image like '%bginfo.exe%' and commandline like '%nolicprompt%' and commandline like '%popup%') or image like '%odbcconf.exe%' or image like '%dnx.exe%') | duration 2d | select image,system, user | limit 10

stream=ep-process where eid='1' and ((image like '%bginfo.exe%' and commandline like '%nolicprompt%' and commandline like '%popup%') or image like '%odbcconf.exe%' or image like '%dnx.exe%') and system='{TargetHost}' and user='{SuspectUser}' and duration 2d 

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|winzip.*?-min -a -s|wzzip.*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|winzip.*?-min -a -s|wzzip.*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') | groupby user, system

stream=win-audit where newprocessname='%AdvancedRun.exe%' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=authentication where action='LOGIN' and status='PASSED'

stream=authentication where action='LOGIN' and status='PASSED'

stream=ep-process where eid='1' and action='PROCESS_ADDED' and status='PASSED' and (parentimage like '%WINWORD.EXE%' or parentimage like '%EXCEL.EXE%' or parentimage like '%POWERPNT.exe%' or parentimage like '%MSPUB.exe%' or parentimage like '%VISIO.exe%' or parentimage like '%OUTLOOK.EXE%') and (image like '%cmd.exe%' or image like '%powershell.exe%' or image like '%wscript.exe%' or image like '%cscript.exe%' or image like '%sh.exe%' or image like '%bash.exe%' or image like '%reg.exe%' or image like '%regsvr32.exe%' or image like '%BITSADMIN%') and system='{TargetHost}' and user='{SuspectUser}' | duration 15m 

stream=ep-process where eid='1' and action='PROCESS_ADDED' and status='PASSED' and (parentimage like '%WINWORD.EXE%' or parentimage like '%EXCEL.EXE%' or parentimage like '%POWERPNT.exe%' or parentimage like '%MSPUB.exe%' or parentimage like '%VISIO.exe%' or parentimage like '%OUTLOOK.EXE%') and (image like '%cmd.exe%' or image like '%powershell.exe%' or image like '%wscript.exe%' or image like '%cscript.exe%' or image like '%sh.exe%' or image like '%bash.exe%' or image like '%reg.exe%' or image like '%regsvr32.exe%' or image like '%BITSADMIN%') | duration 15m | limit 10

stream=firewall | duration from 2023-04-29T00:00:00 to 2023-04-29T23:00:00 | groupby srcip, dstip, devsrcip, dstport | limit 10

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%" or newprocessname like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" | groupby system, user

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%" or newprocessname like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=authentication where sourcename='WINDOWS' and eid='4624' and status='passed' and user='%Admin%' and authenticationpackage like '%Negotiate%' | groupby system, user, sourcename, path | duration 1h | limit 10

stream=ep-process, win-audit where action in ('PROCESS_CRETAED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?microphone') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CRETAED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?microphone') | duration 1h| groupby user, system

stream=authentication where  sourcename='G-SUITE' AND action='LOGIN' AND reason='INVALID_CREDENTIALS'  | duration 5m | groupby srcip, system | select srcip, system, count_if(status=='FAILED') as failcount, count_if(status=='PASSED') as passcount | having failcount >= 10 and failcount >= passcount * 1 | limit 100

stream=authentication where action='LOGIN'

stream=authentication where action='LOGIN'

stream=firewall where action='PACKET_BLOCKED'

stream=win-audit where newprocessname='%AdvancedRun.exe%' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=win-audit where newprocessname='%AdvancedRun.exe%' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%') | groupby user, system 

stream=win-audit where newprocessname='%AdvancedRun.exe%' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=win-audit where newprocessname='%AdvancedRun.exe%' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | duration 6m

stream=* | duration 10d | select substring(xhour,0, 8) as date

stream=ep-file where sourcename='WINDOWS' and eid='11' and action='FILE_CREATED' and status='PASSED' and path like '%Drivers%' and system='{TargetHost}' and user='{SuspectUser}' | duration 15m

stream=ep-file where sourcename='WINDOWS' and eid='11' and action='FILE_CREATED' and status='PASSED' and path like '%Drivers%' | groupby system, user, sourcename, path | duration 4h | limit 10

stream=* where category='LIBJSNMP_NS_LOG_INFO' and sourcetype='NETWORK-OS' and sourcename='JUNOS' | duration 24h | groupby devsrcip, system, message

stream=firewall |  groupby srcip, dstip, srcport, dstport | limit 5

stream=* where sourcename="JUNOS" | duration 7d | select substring(xhour,0, 8) as date | limit -1

stream=firewall where sourcename="JUNOS" | duration 7d | groupby srcip, dstip | limit 100

stream=* | duration 10d | select substring(xhour,0, 8) as date

stream=authentication where action ='LOGIN' and status='PASSED' |  groupby user |  having count_col1<100


stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Msxml2.ServerXMLHTTP%' or commandline like '%Msxml2.DOMDocument%' or commandline like '%Msxml2.FreeThreadedDOMDocument%' or commandline like '%Msxml2.MXXMLWriter%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Msxml2.ServerXMLHTTP%' or commandline like '%Msxml2.DOMDocument%' or commandline like '%Msxml2.FreeThreadedDOMDocument%' or commandline like '%Msxml2.MXXMLWriter%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=authentication where sourcename="JUNOS" | duration 7d | select cnamtime, user, system, action, srcip

stream=authentication where sourcename="JUNOS" | duration 7d | select cnamtime, user, system, action, srcip

stream=* where sourcename="JUNOS" | duration 7d | groupby Category | limit 100

stream=* | duration 10d | select substring(xhour,0, 8) as date

stream=* where sourcename="JUNOS" | duration 7d | groupby srcip, devsrcip | limit 100

stream=* | duration 7d | limit -1

stream=* | duration 7d | select substring(xhour,0, 8) as date | limit -1

stream=* where sourcename="JUNOS" | duration 7d | select substring(xhour,0, 8) as date | limit -1

stream=authentication where action='LOGIN' and status='PASSED' | select user, system, distinct_count(srcip) as uniq_srcip | groupby user, system | having uniq_srcip > 2

stream=firewall where sourcename="JUNOS" | duration 7d  | groupby action, status | limit 100

stream=authentication where action='LOGIN' and status='FAILED' and (reason like 'sslvpn_login_permission_denied' or reason like 'sslvpn_login_unknown_user') | groupby system, user, reason, srcip

stream=authentication where action='LOGIN' and status='FAILED' and srcip='{SuspectHost}' and system='{TargetHost}' and (reason like 'sslvpn_login_permission_denied' or reason like 'sslvpn_login_unknown_user')

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%" or newprocessname like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" | groupby system, user

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%" or newprocessname like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=authentication where action='LOGIN' and status='FAILED' and (reason like 'sslvpn_login_permission_denied' or reason like 'sslvpn_login_unknown_user') | groupby system, user, reason, srcip

stream=authentication where action='LOGIN' and status='FAILED' and srcip='{SuspectHost}' and system='{TargetHost}' and (reason like 'sslvpn_login_permission_denied' or reason like 'sslvpn_login_unknown_user')

stream=authentication where (eid='4768' or eid='4769' or eid='4771' or eid='4776') and not user like '%$%' and not user like '%@%' | groupby user,employee_department,action,eid | duration 7d

stream=ep-file where sourcename='WINDOWS' and eid='11' and action='FILE_CREATED' and status='PASSED' and path like '%Drivers%' and system='{TargetHost}' and user='{SuspectUser}' | duration 15m

stream=ep-file where sourcename='WINDOWS' and eid='11' and action='FILE_CREATED' and status='PASSED' and path like '%Drivers%' | groupby system, user, sourcename, path | duration 4h | limit 11

stream=* where sourcename="JUNOS" | duration 7d  | groupby category | limit 100

stream=ep-file where sourcename='WINDOWS' and eid='11' and action='FILE_CREATED' and status='PASSED' and path like '%Drivers%' and system='{TargetHost}' and user='{SuspectUser}' | duration 15m

stream=ep-file where sourcename='WINDOWS' and eid='11' and action='FILE_CREATED' and status='PASSED' and path like '%Drivers%' | groupby system, user, sourcename, path | duration 4h | limit 10

stream=AUDITD where sourcetype='NETWORK-OS' and sourcename='JUNOS' | duration 24h | groupby iface, devsrcip

stream=AUTHENTICATION where sourcetype='NETWORK-OS' and sourcename='JUNOS' and actiontaken='UI_DBASE_LOGIN_EVENT' and actin='LOGIN' | duration 24h | groupby user, devsrcip, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('cmd.exe','cmd') and commandline like '%HKEY_LOCAL_MACHINE%Software%Microsoft%Windows%CurrentVersion%Run%REG_EXPAND_SZ%SecurityHealth%' and user='{SystemUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('cmd.exe','cmd') and commandline like '%HKEY_LOCAL_MACHINE%Software%Microsoft%Windows%CurrentVersion%Run%REG_EXPAND_SZ%SecurityHealth%' | groupby user, system

stream=ep-file where sourcename='WINDOWS' and eid='11' and action='FILE_CREATED' and status='PASSED' and path like '%Drivers%' and system='{TargetHost}' and user='{SuspectUser}' | duration 15m

stream=ep-file where sourcename='WINDOWS' and eid='11' and action='FILE_CREATED' and status='PASSED' and path like '%Drivers%' | groupby system, user, sourcename, path | duration 4h | limit 10

stream=firewall | duration 30m

stream=authentication where action='LOGIN' | groupby user, srcip, system | duration 1d | limit 100

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='reg.exe' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%REG_DWORD%HideFileExt%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='reg.exe' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%REG_DWORD%HideFileExt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%REG_DWORD%HideFileExt%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%REG_DWORD%HideFileExt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (parentimage like '%powershell.exe' or parentimage like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (image like '%powershell.exe' or image like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') | groupby user, system

stream=AUTHENTICATION where category='UI_AUTH_EVENT' and sourcetype='NETWORK-OS' and sourcename='JUNOS' | groupby user, devsrcip, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%CurrentControlSet\\Control\\LSA /v RunAsPPL /t REG_DWORD /d 0%' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%CurrentControlSet\\Control\\LSA /v RunAsPPL /t REG_DWORD /d 0%" | duration 6m

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Microsoft%Windows%Defender%Features%TamperProtection%REG_DWORD%d%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process | duration 30d | groupby system, user

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), "trufflesnout.*?(domain|forest)") | groupby user, system

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), "trufflesnout.*?(domain|forest)") and user='{SuuspectUser}' and system='{TargetHost}' | duration 6m

stream=authentication where action='LOGIN' and status='PASSED' | select user, system, distinct_count(srcip) as uniq_srcip | groupby user, system | having uniq_srcip > 2

stream=authentication where action='LOGIN' and status='PASSED' | select user, system, distinct_count(srcip) as uniq_srcip | groupby user, system | having uniq_srcip > 2

stream=authentication where  action='LOGIN' and status='FAILED' |  groupby user | limit 5

stream=ep-process, win-audit where action in ('PROCESS_CRETAED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?microphone') | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CRETAED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?microphone') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%reg  add%\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCANetwork%REG_DWORD /d 1' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%reg  add%\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCANetwork%REG_DWORD /d 1' | duration 6m

stream=authentication where action='LOGIN' and status='PASSED' | select user, system, distinct_count(srcip) as uniq_srcip | groupby user, system | having uniq_srcip > 2

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload SysmonDrv%' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload SysmonDrv%' | groupby user, system

stream=windows-event where system = 'raigad.netmonastery.network' | duration from 2024-07-03T15:12:00 to 2024-07-03T15:35:00

stream=windows-event where system = 'raigad.netmonastery.network' | duration from 2024-07-03T15:12:00 to 2024-07-03T15:35:00

stream=EP-REGISTRY where processname='reg.exe' and details like '%DWORD%' and targetobject like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%HideFileExt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-REGISTRY where processname='reg.exe' and details like '%DWORD%' and targetobject like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%HideFileExt%' | groupby user, system

stream=* where sourcename="WINDOWS" | groupby sourcename, eid , system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Msxml2.ServerXMLHTTP%' or commandline like '%Msxml2.DOMDocument%' or commandline like '%Msxml2.FreeThreadedDOMDocument%' or commandline like '%Msxml2.MXXMLWriter%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Msxml2.ServerXMLHTTP%' or commandline like '%Msxml2.DOMDocument%' or commandline like '%Msxml2.FreeThreadedDOMDocument%' or commandline like '%Msxml2.MXXMLWriter%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('powershell.exe','pwsh.exe') and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Internet%Settings%ZoneMap%Domains%new-item%2%DWORD%' and user='{SystemUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('powershell.exe','pwsh.exe') and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Internet%Settings%ZoneMap%Domains%new-item%2%DWORD%' | groupby user, system

stream=windows-event where system = 'raigad.netmonastery.network' | duration from 2024-07-03T15:12:00 to 2024-07-03T15:35:00

stream=nta-rdp where action = "{TargetUser}" | duration 1h

stream=nta-rdp where cookie = 'Administrator' or cookie = 'raiAdmin' | duration 1h

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='cmd.exe' and commandline like '%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='cmd.exe' and commandline like '%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=authentication where action='LOGIN' and status='PASSED' | select user, system, distinct_count(srcip) as uniq_srcip | groupby user, system | having uniq_srcip > 2

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and processname='cmd.exe' and targetobject like '%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' | groupby user, system

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and processname='cmd.exe' and targetobject like '%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%reg  add%\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCANetwork%REG_DWORD /d 1' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%reg  add%\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCANetwork%REG_DWORD /d 1' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='cmd.exe' and commandline like '%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='cmd.exe' and commandline like '%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='cmd.exe' and commandline like '%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='cmd.exe' and commandline like '%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='cmd.exe' and commandline like '%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='cmd.exe' and commandline like '%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='cmd.exe' and commandline like '%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='cmd.exe' and commandline like '%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=webserver where returncode like '2%' and (srctype='PUBLIC' and dsttype='PRIVATE') and ((useragent like '%\%3Cscript\%3E%' or useragent like '%\%3C\%2Fscript\%3E%' or useragent like '%<%>%' or useragent like '%</%>%') or (url like '%\%3D\%3B%' or url like '%\%3D\%27%' or url like '%\%3D\%00%' or url like '%\%3D^\n%' or url like '%\%3Cscript\%3E%' or url like '%\%3C\%2Fscript\%3E%' or url like '%<%>%' or url like '%</%>%') or (httpreferer like '%\%3D\%3B%' or httpreferer like '%\%3D\%27%' or httpreferer like '%\%3D\%00%' or httpreferer like '%\%3D^\n%' or httpreferer like '%\%3Cscript\%3E%' or httpreferer like '%\%3C\%2Fscript\%3E%' or httpreferer like '%<%>%' or httpreferer like '%</%>%')) and not (lower(url) regexp ('(.png|.json|.jsf|.png|.jpg|.bmp|.js|.gif|.css|.svg|.html|.ico)(?![a-zA-z\-\/\.\_\?\&\|])')) and not (lower(httpreferer) regexp ('(.png|.json|.jsf|.png|.jpg|.bmp|.js|.gif|.css|.svg|.html|.ico)(?![a-zA-z\-\/\.\_\?\&\|])')) and user not in ('2189437','2140634','2187348','2199485','2063932','2228287','2188693','2236052')  | select srcip, count(*) as countunique | groupby srcip | having countunique>=1

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), "trufflesnout.*?(domain|forest)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), "trufflesnout.*?(domain|forest)") | groupby user, system

stream=nta-rdp where cookie = "{TargetUser}" and srcip = "{SuspectHost}" | duration 1h

stream=nta-rdp where cookie = 'Administrator' or cookie = 'raiAdmin' | duration 1h

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and processname='cmd.exe' and targetobject like '%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' | groupby user, system

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and processname='cmd.exe' and targetobject like '%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=authentication where action='LOGIN' and status='PASSED' | select user, system, distinct_count(srcip) as uniq_srcip | groupby user, system | having uniq_srcip > 2

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='cmd.exe' and commandline like '%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='cmd.exe' and commandline like '%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (image like '%powershell.exe' or image like '%cmd.exe' or image like '%rundll32.exe' or image like '%wscript.exe' or image like '%cscript.exe' ) and commandline like '%.js%' |  groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe" or parentimage like "%rundll32.exe" or parentimage like "%wscript.exe" or parentimage like "%cscript.exe" ) and commandline like "%.js%" user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=* | groupby action | duration 2d

stream=EP-REGISTRY  where action="OBJECT_MODIFIED" and (image like "%gpg.exe" or image like "%gpg2.exe" or image like "%kleopatra.exe") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-REGISTRY where action="OBJECT_MODIFIED" and (image like "%gpg.exe" or image like "%gpg2.exe" or image like "%kleopatra.exe") | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='cmd.exe' and commandline like '%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='cmd.exe' and commandline like '%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-REGISTRY where processname='reg.exe' and details like '%DWORD%' and targetobject like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%HideFileExt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-REGISTRY where processname='reg.exe' and details like '%DWORD%' and targetobject like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%HideFileExt%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe','cmd') and commandline like '%HKEY_LOCAL_MACHINE%Software%Microsoft%Windows%CurrentVersion%Run%REG_EXPAND_SZ%SecurityHealth%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe','cmd') and commandline like '%HKEY_LOCAL_MACHINE%Software%Microsoft%Windows%CurrentVersion%Run%REG_EXPAND_SZ%SecurityHealth%' and user='{SystemUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('cmd.exe','cmd') and commandline like '%HKEY_LOCAL_MACHINE%Software%Microsoft%Windows%CurrentVersion%Run%REG_EXPAND_SZ%SecurityHealth%' and user='{SystemUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('cmd.exe','cmd') and commandline like '%HKEY_LOCAL_MACHINE%Software%Microsoft%Windows%CurrentVersion%Run%REG_EXPAND_SZ%SecurityHealth%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe','cmd','reg.exe') and commandline like '%HKEY_LOCAL_MACHINE%Software%Microsoft%Windows%CurrentVersion%Run%REG_EXPAND_SZ%SecurityHealth%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe','cmd','reg.exe') and commandline like '%HKEY_LOCAL_MACHINE%Software%Microsoft%Windows%CurrentVersion%Run%REG_EXPAND_SZ%SecurityHealth%' and user='{SystemUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('cmd.exe','cmd','reg.exe') and commandline like '%HKEY_LOCAL_MACHINE%Software%Microsoft%Windows%CurrentVersion%Run%REG_EXPAND_SZ%SecurityHealth%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('cmd.exe','cmd','reg.exe') and commandline like '%HKEY_LOCAL_MACHINE%Software%Microsoft%Windows%CurrentVersion%Run%REG_EXPAND_SZ%SecurityHealth%' and user='{SystemUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg add%Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCAHealth%REG_DWORD /d 1%' | groupby user, system

stream=ep-process where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg add%Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCAHealth%REG_DWORD /d 1%' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe' or newprocessname like '%rundll32.exe' or newprocessname like '%wscript.exe' or newprocessname like '%cscript.exe' ) and commandline like '%.js%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe') and (commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%' or commandline like '%IEX (iwr * -UseBasicParsing)%' or commandline like '%Invoke-Maldoc%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe') and (commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%' or commandline like '%IEX (iwr * -UseBasicParsing)%' or commandline like '%Invoke-Maldoc%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe','cmd') and commandline like '%HKEY_LOCAL_MACHINE%Software%Microsoft%Windows%CurrentVersion%Run%REG_EXPAND_SZ%SecurityHealth%' and user='{SystemUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe','cmd') and commandline like '%HKEY_LOCAL_MACHINE%Software%Microsoft%Windows%CurrentVersion%Run%REG_EXPAND_SZ%SecurityHealth%' | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe' or newprocessname like '%rundll32.exe' or newprocessname like '%wscript.exe' or newprocessname like '%cscript.exe' ) and commandline like '%.js%' | groupby user, system

stream=firewall where MaliciousIP='True'

stream=ep-process where action='PROCESS_ADDED' and (image like '%powershell.exe' or image like '%cmd.exe' or image like '%rundll32.exe' or image like '%wscript.exe' or image like '%cscript.exe' ) and commandline like '%.js%' |  groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe" or parentimage like "%rundll32.exe" or parentimage like "%wscript.exe" or parentimage like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe" or newprocessname like "%rundll32.exe" or newprocessname like "%wscript.exe" or newprocessname like "%cscript.exe" ) and commandline like "%.js%" | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe' or newprocessname like '%rundll32.exe' or newprocessname like '%wscript.exe' or newprocessname like '%cscript.exe' ) and commandline like '%.js%' | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe" or newprocessname like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe') and (commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%' or commandline like '%IEX (iwr * -UseBasicParsing)%' or commandline like '%Invoke-Maldoc%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (image like '%powershell.exe' or image like '%cmd.exe') and (commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%' or commandline like '%IEX (iwr * -UseBasicParsing)%' or commandline like '%Invoke-Maldoc%') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%" or commandline like "%IEX (iwr * -UseBasicParsing)%" or commandline like "%Invoke-Maldoc%") | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe") and (commandline like "%cscript.exe%" or commandline like "%wscript.exe%") | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (image like '%powershell.exe' or image like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%SecurityProviders%WDigest%UseLogonCredential%REG_DWORD%1%' and user='{SystemUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%SecurityProviders%WDigest%UseLogonCredential%REG_DWORD%1%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%SecurityProviders%WDigest%UseLogonCredential%REG_DWORD%1%' and user='{SystemUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%SecurityProviders%WDigest%UseLogonCredential%REG_DWORD%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%SecurityProviders%WDigest%UseLogonCredential%REG_DWORD%1%' and user='{SystemUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%SecurityProviders%WDigest%UseLogonCredential%REG_DWORD%1%' | groupby user, system

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%<script>%' or scriptblocktext like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%.js%' or scriptblocktext like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%javascript:%') and user='{SystemUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%<script>%' or scriptblocktext like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%.js%' or scriptblocktext like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%javascript:%') | groupby user, system

stream=ep-registry where action='OBJECT_MODIFIED' and  rlike(lower(targetobject), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?microphone') | groupby user, system 

stream=signals

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' | groupby user, system

stream=ep-process where processname='%AdvancedRun.exe%' and (command like '%AdvancedRun.exe%' or command like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname='%AdvancedRun.exe' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like '%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (image like '%powershell.exe' or image like '%cmd.exe' or image like '%rundll32.exe' or image like '%wscript.exe' or image like '%cscript.exe' ) and commandline like '%.js%' |  groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe" or parentimage like "%cmd.exe" or parentimage like "%rundll32.exe" or parentimage like "%wscript.exe" or parentimage like "%cscript.exe" ) and commandline like "%.js%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe' or newprocessname like '%rundll32.exe' or newprocessname like '%wscript.exe' or newprocessname like '%cscript.exe' ) and commandline like '%.js%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe' or newprocessname like '%rundll32.exe' or newprocessname like '%wscript.exe' or newprocessname like '%cscript.exe' ) and commandline like '%.js%' | groupby user, system

stream=EP-REGISTRY where targetobject like '%HKLM%SYSTEM%CurrentControlSet%Control%SecurityProviders%WDigest%UseLogonCredential%' | groupby user, system

stream=EP-REGISTRY where targetobject like '%HKLM%SYSTEM%CurrentControlSet%Control%SecurityProviders%WDigest%UseLogonCredential%' and user='{SystemUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where processname='%AdvancedRun.exe%' and (command like '%AdvancedRun.exe%' or command like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | duration 6m

stream=ep-process where processname='%AdvancedRun.exe' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like '%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=win-audit where newprocessname='%AdvancedRun.exe%' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname='%AdvancedRun.exe' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=authentication where action='LOGIN' and status='FAILED' |  groupby user

stream=authentication | groupby domain | duration 1h

stream=ep-process where action='PROCESS_ADDED' and (image like '%powershell.exe' or image like '%cmd.exe' or image like '%rundll32.exe' or image like '%wscript.exe' or image like '%cscript.exe' ) and commandline like '%.js%' |  groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (parentimage like '%powershell.exe' or parentimage like '%cmd.exe' or parentimage like '%rundll32.exe' or parentimage like '%wscript.exe' or parentimage like '%cscript.exe' ) and commandline like '%.js%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname='%AdvancedRun.exe' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like '%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=ep-process where processname='%AdvancedRun.exe%' and (command like '%AdvancedRun.exe%' or command like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|winzip.*?-min -a -s|wzzip.*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|winzip.*?-min -a -s|wzzip.*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('powershell.exe','pwsh.exe') and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Internet%Settings%ZoneMap%Domains%new-item%2%DWORD%' and user='{SystemUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('powershell.exe','pwsh.exe') and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Internet%Settings%ZoneMap%Domains%new-item%2%DWORD%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%<script>%' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%.js%' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%javascript:%') and user='{SystemUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%<script>%' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%.js%' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%javascript:%') | groupby user, system

stream=authentication where sourcename='WINDOWS' and eid='4624' and action='LOGIN' and authenticationpackage like '%Negotiate%' and user like '%Admin%' |  groupby user, system, EID, stream  | duration 15m | limit 10

stream=authentication where sourcename='WINDOWS' and eid='4624' and action='LOGIN' and authenticationpackage like '%Negotiate%' and user like '%Admin%' and system='{TargetHost}' and user='{SuspectUser}' | duration 15m

stream=AUTHENTICATION where Category='UI_AUTH_EVENT' and sourcetype='NETWORK-OS' and sourcename='JUNOS' | groupby user, devsrcip, system | duration 24h

stream=authentication |  duration 1h | groupby action

stream=authentication where sourcename='WINDOWS' and eid='4624' and logontype='New Credentials-Based Logon' and authenticationpackage='Negotiate' | groupby  | duration 2h | limit 10

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and scriptblocktext like '%Get-WmiObject%Win32_ShadowCopy%Delete%' | groupby system, user

stream=ep-registry where action='OBJECT_MODIFIED' and  rlike(lower(targetobject), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?microphone') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and  rlike(lower(targetobject), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?microphone') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe' or newprocessname like '%rundll32.exe' or newprocessname like '%wscript.exe' or newprocessname like '%cscript.exe' ) and commandline like '%.js%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe' or newprocessname like '%rundll32.exe' or newprocessname like '%wscript.exe' or newprocessname like '%cscript.exe' ) and commandline like '%.js%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%nltest.exe%' and rlike(lower(commandline), "nltest.*?(domain_trusts|trusted_domains|dclist:|dcname:|dsget|lsaqueryfti:|parentdomain|bdc_query:)")  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%nltest.exe%' and rlike(lower(commandline), "nltest.*?(domain_trusts|trusted_domains|dclist:|dcname:|dsget|lsaqueryfti:|parentdomain|bdc_query:)") | groupby user, system 

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::FILE_HASH' |  duration 10m

stream=authentication where sourcename='WINDOWS' and eid='4624' and action='LOGIN' and authenticationpackage like '%Negotiate%' and user like '%Admin%' |  groupby user, system, EID, stream  | duration 15m | limit 10

stream=authentication where sourcename='WINDOWS' and eid='4624' and action='LOGIN' and authenticationpackage like '%Negotiate%' and user like '%Admin%' and system='{TargetHost}' and user='{SuspectUser}' | duration 15m

stream=signals

stream=ep-process, win-audit where action in('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(dsquery.*?filter.*?objectclass=trusteddomain|nltest.*?(domain_trusts|trusted_domains))") | groupby user, system 

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(commandline), "(dsquery.*?filter.*?objectclass=trusteddomain|nltest.*?(domain_trusts|trusted_domains))") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::FILE_HASH' |  duration 10m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::FILE_HASH' |  duration 10m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::FILE_HASH' |  duration 10m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::FILE_HASH' |  duration 10m

stream=ep-registry where action='OBJECT_MODIFIED' and  rlike(lower(targetobject), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?microphone') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and  rlike(lower(targetobject), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?microphone') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg add%Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCAHealth%REG_DWORD /d 1%' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg add%Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCAHealth%REG_DWORD /d 1%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (parentimage like '%powershell.exe' or parentimage like '%cmd.exe') and (commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%' or commandline like '%IEX (iwr * -UseBasicParsing)%' or commandline like '%Invoke-Maldoc%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (image like '%powershell.exe' or image like '%cmd.exe') and (commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%' or commandline like '%IEX (iwr * -UseBasicParsing)%' or commandline like '%Invoke-Maldoc%') | groupby user, system

stream=authentication | groupby domain | duration 1h

stream=windows-event where system = 'raigad.netmonastery.network' and user is not null | duration from 2024-07-03T15:12:00 to 2024-07-03T15:35:00 |  groupby user , @Subject

stream=win-audit where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg add%Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCAHealth%REG_DWORD /d 1%' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg add%Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCAHealth%REG_DWORD /d 1%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg add%Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCAHealth%REG_DWORD /d 1%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg add%Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCAHealth%REG_DWORD /d 1%' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFind%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFind%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=webserver where (useragent like '%Iceweasel%' or useragent like '%Nikto%' or useragent like '%dirb%' or useragent like '%Wscript%') | select srcip, useragent,count(*) as countunique | groupby srcip, useragent | having countunique>=1

stream=authentication where sourcename='WINDOWS' and eid='4624' and logontype='New Credentials-Based Logon' and authenticationpackage='Negotiate'  and system='{TargetHost}' and user='{SuspectUser}' | duration 2h

stream=authentication where sourcename='WINDOWS' and eid='4624' and logontype='New Credentials-Based Logon' and authenticationpackage='Negotiate' | groupby user, system, srcip | duration 5m | limit 10

stream=authentication where sourcename='WINDOWS' and eid='4624' and logontype='New Credentials-Based Logon' and authenticationpackage='Negotiate' | groupby user, system, srcip | duration 5m | limit 10

stream=authentication where sourcename='WINDOWS' and eid='4624' and logontype='New Credentials-Based Logon' and authenticationpackage='Negotiate'  and system='{TargetHost}' and user='{SuspectUser}' | duration 2h

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=webserver where returncode like '2%' and (srctype='PUBLIC' and dsttype='PRIVATE') and ((useragent like '%\%3Cscript\%3E%' or useragent like '%\%3C\%2Fscript\%3E%' or useragent like '%<%>%' or useragent like '%</%>%') or (url like '%\%3D\%3B%' or url like '%\%3D\%27%' or url like '%\%3D\%00%' or url like '%\%3D^\n%' or url like '%\%3Cscript\%3E%' or url like '%\%3C\%2Fscript\%3E%' or url like '%<%>%' or url like '%</%>%') or (httpreferer like '%\%3D\%3B%' or httpreferer like '%\%3D\%27%' or httpreferer like '%\%3D\%00%' or httpreferer like '%\%3D^\n%' or httpreferer like '%\%3Cscript\%3E%' or httpreferer like '%\%3C\%2Fscript\%3E%' or httpreferer like '%<%>%' or httpreferer like '%</%>%')) and not (lower(url) regexp ('(.png|.json|.jsf|.png|.jpg|.bmp|.js|.gif|.css|.svg|.html|.ico)(?![a-zA-z\-\/\.\_\?\&\|])')) and not (lower(httpreferer) regexp ('(.png|.json|.jsf|.png|.jpg|.bmp|.js|.gif|.css|.svg|.html|.ico)(?![a-zA-z\-\/\.\_\?\&\|])')) and user not in ('2189437','2140634','2187348','2199485','2063932','2228287','2188693','2236052')  | select srcip, count(*) as countunique | groupby srcip | having countunique>=1

stream=AUTHENTICATION where category='UI_AUTH_EVENT' and sourcetype='NETWORK-OS' and sourcename='JUNOS' | groupby user, devsrcip, system | duration 24h

stream=AUTHENTICATION where category='UI_AUTH_EVENT' and sourcetype='NETWORK-OS' and sourcename='JUNOS' | groupby user | duration 24h

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg add%Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCAHealth%REG_DWORD /d 1%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg add%Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCAHealth%REG_DWORD /d 1%' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' | groupby user, system

stream=ep-process where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg add%Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCAHealth%REG_DWORD /d 1%' | groupby user, system

stream=ep-process where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg add%Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCAHealth%REG_DWORD /d 1%' | duration 6m

stream=ep-process where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg add%Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCAHealth%REG_DWORD /d 1%' | groupby user, system

stream=ep-process where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg add%Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer%HideSCAHealth%REG_DWORD /d 1%' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%CurrentControlSet\\Control\\LSA /v RunAsPPL /t REG_DWORD /d 0%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%CurrentControlSet\\Control\\LSA /v RunAsPPL /t REG_DWORD /d 0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-REGISTRY where action='OBJECT_MODIFIED'  and processname in ('cmd.exe', 'powershell.exe') and targetobject like '%reg add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and parentcommandline like "%powershell.exe%Win32_Process%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and parentcommandline like "%powershell.exe%Win32_Process%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and processname in ('cmd.exe', 'powershell.exe') and targetobject like '%reg add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' | groupby user, system

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and processname in ('cmd.exe', 'powershell.exe') and targetobject like '%reg add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (commandline like "reg add" or commandline like "reg delete" or commandline like "New-ItemProperty") and (commandline like "\\Software\\Policies\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon" or commandline like "Software\\\\Policies\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon")

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'cmd.exe.*?assoc.*?.hta.*?\=') or rlike(lower(commandline), 'hkey_classes_root.*?shell.*?command')| groupby system, user 

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'cmd.exe.*?assoc.*?.hta.*?\=') or rlike(lower(commandline), 'hkey_classes_root.*?shell.*?command') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where eid='1' and ((image like '%bginfo.exe%' and commandline like '%nolicprompt%' and commandline like '%popup%') or image like '%odbcconf.exe%' or image like '%dnx.exe%') | duration 1d | select image,system, user | limit 10

stream=ep-process where eid='1' and ((image like '%bginfo.exe%' and commandline like '%nolicprompt%' and commandline like '%popup%') or image like '%odbcconf.exe%' or image like '%dnx.exe%') and system='{TargetHost}' and user='{SuspectUser}' and duration 2d 

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg%add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg%add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload%SysmonDrv%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload%SysmonDrv%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload SysmonDrv%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload SysmonDrv%' | groupby user, system

stream=ep-process where parentimage='powershell.exe' and commandline like '%New-AzureADServicePrincipalCredential%CertificateThumbprint%' | groupby user, system

stream=ep-process where parentimage='powershell.exe' and commandline like '%New-AzureADServicePrincipalCredential%CertificateThumbprint%' and system='{TaregtHost}' and user='{SuspectUser}' | duration 6m

stream=nta-ssl where (version='TLSv10' or version='TLSv12') | groupby devsrcip, version |  duration 1h

stream=nta-ssl where (version='TLSv10' or version='TLSv12') and devsrcip='{TargetResource}'|  duration 1h

stream=ep-registry where action='OBJECT_MODIFIED' and targetobject='%Software%Microsoft%Office%Resiliency%' | groupby system, targetobject, user | limit 100

stream=ep-registry where action='OBJECT_MODIFIED' and targetobject='%Software%Microsoft%Office%Resiliency%' and system='{TargetHost}'

stream=other |  duration 1h | limit 1

stream=win-audit where newprocessname='%AdvancedRun.exe%' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname='%AdvancedRun.exe' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%/cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(dsquery.*?filter.*?objectclass=trusteddomain|nltest.*?(domain_trusts|trusted_domains))")  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(dsquery.*?filter.*?objectclass=trusteddomain|nltest.*?(domain_trusts|trusted_domains))") | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='cmd.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='cmd.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | groupby user, system

stream=* |  duration 1d |  groupby srcip | limit 10

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and processname in ('cmd.exe', 'powershell.exe') and targetobject like '%reg%add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and processname in ('cmd.exe', 'powershell.exe') and targetobject like '%reg%add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and ( parentimage like "%C:%Windows%Microsoft%.NET%Framework64%v4%.0%.30319%csc%.exe%" and parentcommandline like "%noconfig%fullpaths%") and (commandline like "%csc.exe%" or commandline like "%target:exe%" or commandline like "%code%" or commandline like "%out%" or commandline like "%*%" ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and ( parentimage like "%C:%Windows%Microsoft%.NET%Framework64%v4%.0%.30319%csc%.exe%" and parentcommandline like "%noconfig%fullpaths%") and (commandline like "%csc.exe%" or commandline like "%target:exe%" or commandline like "%code%" or commandline like "%out%" or commandline like "%*%" ) | groupby user, system

stream=win-audit where newprocessname='%AdvancedRun.exe%' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname='%AdvancedRun.exe' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and processname like 'bcdedit.exe' and commandline like '%bcdedit%set%safeboot%network%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and processname like 'bcdedit.exe' and commandline like '%bcdedit%set%safeboot%network%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and processname like 'bcdedit.exe' and commandline like '%bcdedit%set%safeboot%network%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and processname like 'bcdedit.exe' and commandline like '%bcdedit%set%safeboot%network%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAHealth%REG_DWORD%/d%1%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAHealth%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoTrayContextMenu%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoTrayContextMenu%REG_DWORD%1%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and processname like 'bcdedit.exe' and commandline like '%bcdedit  /set safeboot network%' | groupby user, system

stream=ep-process where processname='%AdvancedRun.exe%' and (command like '%AdvancedRun.exe%' or command like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname='%AdvancedRun.exe' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like '%Execute%' or commandline like '%EXEFilename%' or commandline like '%cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAVolume%REG_DWORD%/d%1%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAVolume%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe% or image like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Policies%Microsoft%Windows%PowerShell' and (commandline like '%EnableModuleLogging%' or commandline like '%EnableScriptBlockLogging%' or commandline like '%EnableTranscripting%' or commandline like '%EnableScripts%') and commandline like 'REG_DWORD%/d%0%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Policies%Microsoft%Windows%PowerShell' and (commandline like '%EnableModuleLogging%' or commandline like '%EnableScriptBlockLogging%' or commandline like '%EnableTranscripting%' or commandline like '%EnableScripts%') and commandline like 'REG_DWORD%/d%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Policies%Microsoft%Windows%PowerShell' and (commandline like '%EnableModuleLogging%' or commandline like '%EnableScriptBlockLogging%' or commandline like '%EnableTranscripting%' or commandline like '%EnableScripts%') and commandline like 'REG_DWORD%/d%0%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Policies%Microsoft%Windows%PowerShell' and (commandline like '%EnableModuleLogging%' or commandline like '%EnableScriptBlockLogging%' or commandline like '%EnableTranscripting%' or commandline like '%EnableScripts%') and commandline like 'REG_DWORD%/d%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Policies%Microsoft%Windows%PowerShell' and (commandline like '%EnableModuleLogging%' or commandline like '%EnableScriptBlockLogging%' or commandline like '%EnableTranscripting%' or commandline like '%EnableScripts%') and commandline like 'REG_DWORD%/d%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Policies%Microsoft%Windows%PowerShell' and (commandline like '%EnableModuleLogging%' or commandline like '%EnableScriptBlockLogging%' or commandline like '%EnableTranscripting%' or commandline like '%EnableScripts%') and commandline like 'REG_DWORD%/d%0%' | groupby user, system

stream=nta-rdp where cookie = "Administrator"  and srcip = "172.25.10.119" | duration 2h

stream=nta-rdp where cookie = "{TargetUser}" and srcip = "{SuspectHost}" | duration 2h

stream=EP-PROCESS where action="PROCESS_ADDED" and ((parentimage like "explorer.exe" and image like "%.exe" and commandline like "%--encrypt%" or commandline like "%--symmetric%") or (parentimage like "powershell.exe" and commandline like "%New-Object Net.WebClient%DownloadFile%--encrypt%" or commandline like "%New-Object Net.WebClient*DownloadFile%--symmetric%") or (parentimage like "cmd.exe" and (commandline like "%gpg.exe%--encrypt%" or commandline like "%gpg.exe%--symmetric%")) or (parentimage like "cmd.exe" and (commandline like "%gpg2.exe%--encrypt%" or commandline like "%gpg2.exe%--symmetric%")) or parentimage like "cmd.exe" and (commandline like "%kleopatra.exe%--encrypt%" or commandline like "%kleopatra.exe%--symmetric%") or (commandline like "%gpg.exe%"" and parentimage like "%cmd.exe")) | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and ((parentimage like "explorer.exe" and image like "%.exe" and commandline like "%--encrypt%" or commandline like "%--symmetric%") or (parentimage like "powershell.exe" and commandline like "%New-Object Net.WebClient*DownloadFile%--encrypt%" or commandline like "%New-Object Net.WebClient*DownloadFile%--symmetric%") or (parentimage like "cmd.exe" and (commandline like "%gpg.exe%--encrypt%" or commandline like "%gpg.exe%--symmetric%")) or (parentimage like "cmd.exe" and (commandline like "%gpg2.exe%--encrypt%" or commandline like "%gpg2.exe%--symmetric%")) or parentimage like "cmd.exe" and (commandline like "%kleopatra.exe%--encrypt%" or commandline like "%kleopatra.exe%--symmetric%") or (commandline like "%gpg.exe%"" and parentimage like "%cmd.exe")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and ((parentimage like "explorer.exe" and image like "%.exe" and commandline like "%--encrypt%" or commandline like "%--symmetric%") or (parentimage like "powershell.exe" and commandline like "%New-Object Net.WebClient%DownloadFile%--encrypt%" or commandline like "%New-Object Net.WebClient*DownloadFile%--symmetric%") or (parentimage like "cmd.exe" and (commandline like "%gpg.exe%--encrypt%" or commandline like "%gpg.exe%--symmetric%")) or (parentimage like "cmd.exe" and (commandline like "%gpg2.exe%--encrypt%" or commandline like "%gpg2.exe%--symmetric%")) or parentimage like "cmd.exe" and (commandline like "%kleopatra.exe%--encrypt%" or commandline like "%kleopatra.exe%--symmetric%") or (commandline like "%gpg.exe%"" and parentimage like "%cmd.exe")) | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and ((parentimage like "explorer.exe" and image like "%.exe" and commandline like "%--encrypt%" or commandline like "%--symmetric%") or (parentimage like "powershell.exe" and commandline like "%New-Object Net.WebClient*DownloadFile%--encrypt%" or commandline like "%New-Object Net.WebClient%DownloadFile%--symmetric%") or (parentimage like "cmd.exe" and (commandline like "%gpg.exe%--encrypt%" or commandline like "%gpg.exe%--symmetric%")) or (parentimage like "cmd.exe" and (commandline like "%gpg2.exe%--encrypt%" or commandline like "%gpg2.exe%--symmetric%")) or parentimage like "cmd.exe" and (commandline like "%kleopatra.exe%--encrypt%" or commandline like "%kleopatra.exe%--symmetric%") or (commandline like "%gpg.exe%"" and parentimage like "%cmd.exe")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and parentcommandline like "%powershell.exe%" and parentcommandline like "%Win32_Process%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and parentcommandline like "%powershell.exe%Win32_Process%" | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg%add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg%add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (parentimage like '%powershell.exe' or parentimage like '%cmd.exe') and (commandline like '%[Net.ServicePointManager]::SecurityProtocol%=%[Net.SecurityProtocolType]::Tls12%' or commandline like '%IEX%(iwr%*%-UseBasicParsing)%' or commandline like '%Invoke-Maldoc%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (image like '%powershell.exe' or image like '%cmd.exe') and (commandline like '%[Net.ServicePointManager]::SecurityProtocol%=%[Net.SecurityProtocolType]::Tls12%' or commandline like '%IEX%(iwr%*%-UseBasicParsing)%' or commandline like '%Invoke-Maldoc%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%CurrentControlSet%Control%LSA%/v%RunAsPPL%/t%REG_DWORD%/d%0%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%CurrentControlSet%Control%LSA%/v%RunAsPPL%/t%REG_DWORD%/d%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='cmd.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='cmd.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and processname='cmd.exe' and targetobject like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' | groupby user, system

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and processname='cmd.exe' and targetobject like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe') and (commandline like '%[Net.ServicePointManager]::SecurityProtocol%=%[Net.SecurityProtocolType]::Tls12%' or commandline like '%IEX%(iwr%*%-UseBasicParsing)%' or commandline like '%Invoke-Maldoc%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe') and (commandline like '%[Net.ServicePointManager]::SecurityProtocol%=%[Net.SecurityProtocolType]::Tls12%' or commandline like '%IEX%(iwr%*%-UseBasicParsing)%' or commandline like '%Invoke-Maldoc%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where eid='1' and ((image like '%bginfo.exe%' and commandline like '%nolicprompt%' and commandline like '%popup%') or image like '%odbcconf.exe%' or image like '%dnx.exe%') and duration 1d and system='{TargetHost}' and user='{SuspectUser}'

stream=ep-process where eid='1' and ((image like '%bginfo.exe%' and commandline like '%nolicprompt%' and commandline like '%popup%') or image like '%odbcconf.exe%' or image like '%dnx.exe%') | duration 10m | select image,system, user | limit 10

stream=EP-PROCESS where action="PROCESS_ADDED" and ( parentimage like "%C:%Windows%Microsoft%.NET%Framework64%v4%.0%.30319%csc%.exe%" and parentcommandline like "%noconfig%fullpaths%") and (commandline like "%csc.exe%" or commandline like "%target:exe%" or commandline like "%code%" or commandline like "%out%" or commandline like "%*%" ) | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and ( parentimage like "%C:%Windows%Microsoft%.NET%Framework64%v4%.0%.30319%csc%.exe%" and parentcommandline like "%noconfig%fullpaths%") and (commandline like "%csc.exe%" or commandline like "%target:exe%" or commandline like "%code%" or commandline like "%out%" or commandline like "%*%" ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%CurrentControlSet%Control%LSA%/v%RunAsPPL%/t%REG_DWORD%/d%0%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%CurrentControlSet%Control%LSA%/v%RunAsPPL%/t%REG_DWORD%/d%0%' and user='{SuspectUser}' and system='{TargetHost}' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%CurrentControlSet%Control%LSA%/v%RunAsPPL%/t%REG_DWORD%/d%0%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%CurrentControlSet%Control%LSA%/v%RunAsPPL%/t%REG_DWORD%/d%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), "(powerview|powershell)") and rlike(lower(commandline), "(get-domaintrust|get-foresttrust|get-netdomaintrust|get-netforesttrust|get-addomain|get-adgroupmember)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), "(powerview|powershell)") and rlike(lower(commandline), "(get-domaintrust|get-foresttrust|get-netdomaintrust|get-netforesttrust|get-addomain|get-adgroupmember)") | groupby user, system

stream=authentication | limit 10

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%System%LocalAccountTokenFilterPolicy%EnableLinkedConnections%SYSTEM%CurrentControlSet%Control%FileSystem%LongPathsEnabled%DWORD%1%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%System%LocalAccountTokenFilterPolicy%EnableLinkedConnections%SYSTEM%CurrentControlSet%Control%FileSystem%LongPathsEnabled%DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAVolume%REG_DWORD%/d%1%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAVolume%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%" or image like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where rlike(lower(commandline), "(get-childitem.*?recurse.*?file.*?where-object.*?match|get-item.*?path.*?get-itemproperty|get-winevent.*?logname.*?filterxpath.*?where-object.*?match|get-nettcpconnection.*?where-object)") | groupby user, system

stream=ep-process where rlike(lower(commandline), "(get-childitem.*?recurse.*?file.*?where-object.*?match|get-item.*?path.*?get-itemproperty|get-winevent.*?logname.*?filterxpath.*?where-object.*?match|get-nettcpconnection.*?where-object)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), "(powerview|powershell)") and rlike(lower(commandline), "(get-domaintrust|get-foresttrust|get-netdomaintrust|get-netforesttrust|get-addomain|get-adgroupmember|get-adforest)") | groupby user, system

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), "(powerview|powershell)") and rlike(lower(commandline), "(get-domaintrust|get-foresttrust|get-netdomaintrust|get-netforesttrust|get-addomain|get-adgroupmember|get-adforest)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%C:%Windows%Microsoft%.NET%Framework64%v4.0.30319%csc%.exe%" and commandline like "%noconfig%fullpaths%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%C:%Windows%Microsoft%.NET%Framework64%v4.0.30319%csc%.exe%" and commandline like "%noconfig%fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAVolume%REG_DWORD%/d%1%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAVolume%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoTrayContextMenu%REG_DWORD%1%' | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe% or newprocessname like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" | groupby system, user

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%" or newprocessname like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" | groupby system, user

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'cmd.exe.*?assoc.*?.hta.*?\=') or rlike(lower(commandline), 'hkey_classes_root.*?shell.*?command')| groupby system, user

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'cmd.exe.*?assoc.*?.hta.*?\=') or rlike(lower(commandline), 'hkey_classes_root.*?shell.*?command') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like "%C:%Windows%System32%schtasks.exe%" and commandline like "%schtasks%query%Windows Defender%" | groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz%exe%crypto%certificate%export%') | groupby user,system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz%exe%crypto%certificate%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCANetwork%REG_DWORD%/d%1' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCANetwork%REG_DWORD%/d%1' | groupby user, system

stream=ep-process where eid='1' and ((image like '%bginfo.exe%' and commandline like '%nolicprompt%' and commandline like '%popup%') or image like '%odbcconf.exe%' or image like '%dnx.exe%') and duration 1d and system='{TargetHost}' and user='{SuspectUser}'

stream=ep-process where eid='1' and ((image like '%bginfo.exe%' and commandline like '%nolicprompt%' and commandline like '%popup%') or image like '%odbcconf.exe%' or image like '%dnx.exe%') | duration 10m | select image,system, user | limit 10

stream=SYSMON-REGISTRY where action='OBJECT_MODIFIED' and status='PASSED' and user='{SuspectUser}' and targetobject='{TargetResource}' and system='{TargetHost}'

stream=IAM where action='PRIVILEGE_CHANGED' and status='PASSED' and role='Special Logon' | duration 1h | groupby user, targetuser

stream=IAM where action='PRIVILEGE_CHANGED' and status='PASSED' and role='Special Logon' and targetuser='{TargetUser}' and user='{SuspectUser}'

stream=SYSMON-REGISTRY where action='OBJECT_MODIFIED' and status='PASSED' and user='{SuspectUser}' and targetobject='{TargetResource}' and system='{TargetHost}'

stream=* where sourcename="WINDOWS" | duration = 7d | groupby sourcename, eid 

stream=hypercloud

stream=ep-process where action="PROCESS_ADDED" and image like "%C:%Windows%System32%schtasks.exe%" and commandline like "%schtasks%query%Windows Defender%" | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=authentication | groupby srcip,user | having count_col1>500 | duration 15m  | limit 10

stream=* where sourcename="WINDOWS" | duration = 5m | groupby sourcename, eid 

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%PetitPotam%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%PetitPotam%' and user='{SuspectUser}' and system='{TargetHost}'

stream=* where sourcename="WINDOWS" | duration = 7d | groupby sourcename, eid 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Policies%Microsoft%Windows%PowerShell' and (commandline like '%EnableModuleLogging%' or commandline like '%EnableScriptBlockLogging%' or commandline like '%EnableTranscripting%' or commandline like '%EnableScripts%') and commandline like 'REG_DWORD%/d%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Policies%Microsoft%Windows%PowerShell' and (commandline like '%EnableModuleLogging%' or commandline like '%EnableScriptBlockLogging%' or commandline like '%EnableTranscripting%' or commandline like '%EnableScripts%') and commandline like 'REG_DWORD%/d%0%' | groupby user, system

stream=* where sourcename="WINDOWS" | duration = 7d | groupby sourcename, eid 

stream=* where sourcename="WINDOWS" | groupby sourcename, eid 

stream=* where sourcename="WINDOWS" | duration = 7d | groupby sourcename, eid 

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe') and (commandline like '%[Net.ServicePointManager]::SecurityProtocol%=%[Net.SecurityProtocolType]::Tls12%' or commandline like '%IEX%(iwr%*%-UseBasicParsing)%' or commandline like '%Invoke-Maldoc%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe') and (commandline like '%[Net.ServicePointManager]::SecurityProtocol%=%[Net.SecurityProtocolType]::Tls12%' or commandline like '%IEX%(iwr%*%-UseBasicParsing)%' or commandline like '%Invoke-Maldoc%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableNotificationCenter") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableNotificationCenter") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=* where sourcename="WINDOWS" | duration = 5m | groupby sourcename, eid 

stream=* |  groupby stream, sourcename |  duration 15m

stream=WIN-AUDIT where action="PROCESS_CREATED" and ( CommandLine like "%C:%Windows%Microsoft.NET%Framework64%v4.0.30319%csc.exe%noconfig%fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and CommandLine like "%C:%Windows%Microsoft.NET%Framework64%v4.0.30319%csc.exe%noconfig%fullpaths%" | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and CommandLine like "%C:%Windows%Microsoft.NET%Framework64%v4.0.30319%csc.exe%noconfig%fullpaths%" | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and CommandLine like "%C:%Windows%Microsoft.NET%Framework64%v4.0.30319%csc.exe%noconfig%fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=* where sourcename="WINDOWS" | duration = 7d | groupby sourcename, eid 

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), "(powerview|powershell)") and rlike(lower(commandline), "(get-domaintrust|get-foresttrust|get-netdomaintrust|get-netforesttrust|get-addomain|get-adgroupmember|get-adforest)") | groupby user, system

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), "(powerview|powershell)") and rlike(lower(commandline), "(get-domaintrust|get-foresttrust|get-netdomaintrust|get-netforesttrust|get-addomain|get-adgroupmember)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=authentication where action='LOGIN' |  groupby user| limit 2

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%Get-DomainUser%' | groupby system, user 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%Get-DomainUser%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAVolume%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAVolume%REG_DWORD%/d%1%' | groupby user, system

stream=* where sourcename="WINDOWS" | groupby sourcename, eid , system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%System%LocalAccountTokenFilterPolicy%EnableLinkedConnections%SYSTEM%CurrentControlSet%Control%FileSystem%LongPathsEnabled%DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%System%LocalAccountTokenFilterPolicy%EnableLinkedConnections%SYSTEM%CurrentControlSet%Control%FileSystem%LongPathsEnabled%DWORD%1%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Policies%Microsoft%Windows%PowerShell' and (commandline like '%EnableModuleLogging%' or commandline like '%EnableScriptBlockLogging%' or commandline like '%EnableTranscripting%' or commandline like '%EnableScripts%') and commandline like 'REG_DWORD%/d%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Policies%Microsoft%Windows%PowerShell' and (commandline like '%EnableModuleLogging%' or commandline like '%EnableScriptBlockLogging%' or commandline like '%EnableTranscripting%' or commandline like '%EnableScripts%') and commandline like 'REG_DWORD%/d%0%' | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\policies\\\\system.*?DisableRegistryTools") and user='{SuspectUser}' and system='{TargetSystem}' | duration 6m 

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\policies\\\\system.*?DisableRegistryTools") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\policies\\\\system.*?DisableRegistryTools") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\policies\\\\system.*?DisableRegistryTools") and user='{SuspectUser}' and system='{TargetSystem}' | duration 6m 

stream=authentication where action ='LOGIN' and status='PASSED' |  groupby user |  having count_col1>100


stream=authentication where action ='LOGIN' and status='PASSED' |  groupby user |  having count_col1>10


stream=authentication where action ='LOGIN' and status='PASSED' |  groupby user |  having count_col1>100


stream=authentication where action ='LOGIN' and status='PASSED' |  groupby user |  having count_col1>100


stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAVolume%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAVolume%REG_DWORD%/d%1%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAVolume%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAVolume%REG_DWORD%/d%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoTrayContextMenu%REG_DWORD%1%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoTrayContextMenu%REG_DWORD%1%' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\policies\\\\system.*?DisableRegistryTools") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\policies\\\\system.*?DisableRegistryTools") and system='{TargetSystem}' and user='{SuspectHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoTrayContextMenu%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoTrayContextMenu%REG_DWORD%1%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoTrayContextMenu%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoTrayContextMenu%REG_DWORD%1%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%%system%currentcontrolset%control%lsa%DisableRestrictedAdmin%REG_DWORD%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%system%currentcontrolset%control%lsa%DisableRestrictedAdmin%REG_DWORD%0%' | groupby user, system

stream=nta-ssl where (version='TLSv10' or version='TLSv11') | groupby devsrcip, version |  duration 1h

stream=nta-ssl where (version='TLSv10' or version='TLSv12') and devsrcip='{TargetResource}'|  duration 1h

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and processname in ('cmd.exe', 'powershell.exe') and targetobject like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoTrayContextMenu%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and processname in ('cmd.exe', 'powershell.exe') and targetobject like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoTrayContextMenu%REG_DWORD%1%' | groupby user, system

stream=EP-Process where action="PROCESS_ADDED" and ( commandline like "%csc.exe%" or commandline like "%target:exe%" or commandline like "%code%" or commandline like "%out%" ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-Process where action="PROCESS_ADDED" and ( commandline like "%csc.exe%" or commandline like "%target:exe%" or commandline like "%code%" or commandline like "%out%" ) | groupby system, user 

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%HKEY_CURRENT_USER%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%DisallowRun%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%HKEY_CURRENT_USER%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%DisallowRun%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Winlogon%REG_DWORD%AllowMultipleTSSessions%1%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Winlogon%REG_DWORD%AllowMultipleTSSessions%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('reg.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%WOW6432Node%Microsoft%Windows%CurrentVersion%ImmersiveShell%UseActionCenterExperience%REG_DWORD%0' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%WOW6432Node%Microsoft%Windows%CurrentVersion%ImmersiveShell%UseActionCenterExperience%REG_DWORD%0' | groupby user, system

stream=authentication where action ='LOGIN' and status='PASSED' |  groupby user |  having count_col1<100


stream=EP-Process where action="PROCESS_ADDED" and ( commandline like "%csc.exe%" or commandline like "%target:exe%" or commandline like "%code%" or commandline like "%out%" ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-Process where action="PROCESS_ADDED" and ( commandline like "%csc.exe%" or commandline like "%target:exe%" or commandline like "%code%" or commandline like "%out%" ) | groupby system, user 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%powershell.exe%convertto-securestring%-force%new-selfsignedcertificate%-dnsname%-certstorelocation%get-childitem -path%export-pfxcertificate%-filepath%') | duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%powershell.exe%convertto-securestring%-force%new-selfsignedcertificate%-dnsname%-certstorelocation%get-childitem -path%export-pfxcertificate%-filepath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%Microsoft%Windows%NT%CurrentVersion%Event%Viewer%MicrosoftRedirectionURL%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%Microsoft%Windows%NT%CurrentVersion%Event%Viewer%MicrosoftRedirectionURL%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('reg.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('reg.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' | groupby user, system

stream=nta-ssl where (version='TLSv10' or version='TLSv11') | groupby devsrcip, version |  duration 2h

stream=nta-ssl where (version='TLSv10' or version='TLSv11') and devsrcip='{TargetResource}'|  duration 1h

stream=EP-File where action="FILE_CREATED" and ( commandline like "csc.exe" or commandline like "target:exe" or commandline like "code" or commandline like "out" ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-File where action="FILE_CREATED" and ( commandline like "%csc.exe%" or commandline like "%target:exe%" or commandline like "%code%" or commandline like "%out%" ) | groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and commandline like '%bitsadmin.exe%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), 'bitsadmin.*?addfile')  | groupby system, user

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::DOMAIN' and dstip='{TargetHost}' | duration 10m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::DOMAIN' | groupby devsrcip, indicatortype, dstip| duration 10m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%HKEY_CURRENT_USER%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%DisallowRun%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%HKEY_CURRENT_USER%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%DisallowRun%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%Microsoft%Windows%NT%CurrentVersion%Event%Viewer%MicrosoftRedirectionURL%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%Microsoft%Windows%NT%CurrentVersion%Event%Viewer%MicrosoftRedirectionURL%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%WOW6432Node%Microsoft%Windows%CurrentVersion%ImmersiveShell%UseActionCenterExperience%REG_DWORD%0' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%WOW6432Node%Microsoft%Windows%CurrentVersion%ImmersiveShell%UseActionCenterExperience%REG_DWORD%0' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideClock%REG_DWORD%1%' | groupby user, system

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::DOMAIN' and dstip='{TargetHost}' | duration 10m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::DOMAIN' | groupby devsrcip, indicatortype, dstip| duration 10m

stream=WIN-AUDIT where action="PROCESS_CREATED" and CommandLine like "%C:%Windows%Microsoft.NET%Framework64%v4.0.30319%csc.exe%noconfig%fullpaths%" | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and CommandLine like "%C:%Windows%Microsoft.NET%Framework64%v4.0.30319%csc.exe%noconfig%fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%system%currentcontrolset%control%lsa%DisableRestrictedAdmin%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%system%currentcontrolset%control%lsa%DisableRestrictedAdmin%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%system%currentcontrolset%control%lsa%DisableRestrictedAdmin%REG_DWORD%0%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%system%currentcontrolset%control%lsa%DisableRestrictedAdmin%REG_DWORD%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=ep-process where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Network%REG_SZ%/F%/D' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Network%REG_SZ%/F%/D' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('reg.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('reg.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%System%CurrentControlSet%Control%Terminal%Server%fSingleSessionPerUser%REG_DWORD%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%System%CurrentControlSet%Control%Terminal%Server%fSingleSessionPerUser%REG_DWORD%0%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%System%CurrentControlSet%Control%Terminal%Server%fSingleSessionPerUser%REG_DWORD%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%System%CurrentControlSet%Control%Terminal%Server%fSingleSessionPerUser%REG_DWORD%0%' | groupby user, system

stream=nta-ssl where (version='TLSv10' or version='TLSv11') | groupby devsrcip, version |  duration 2h

stream=nta-ssl where (version='TLSv10' or version='TLSv11') and devsrcip='{TargetResource}'|  duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%system%currentcontrolset%control%lsa%DisableRestrictedAdmin%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%system%currentcontrolset%control%lsa%DisableRestrictedAdmin%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('reg.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('reg.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('reg.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('reg.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Winlogon%REG_DWORD%AllowMultipleTSSessions%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Winlogon%REG_DWORD%AllowMultipleTSSessions%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideClock%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideClock%REG_DWORD%1%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideClock%REG_DWORD%1%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideClock%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' | groupby user, system


stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%PushNotifications%ToastEnabled%REG_DWORD%0' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%PushNotifications%ToastEnabled%REG_DWORD%0' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideClock%REG_DWORD%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideClock%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%PushNotifications%ToastEnabled%REG_DWORD%0' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%PushNotifications%ToastEnabled%REG_DWORD%0' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%PushNotifications%ToastEnabled%REG_DWORD%0' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%PushNotifications%ToastEnabled%REG_DWORD%0' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%WOW6432Node%Microsoft%Windows%CurrentVersion%ImmersiveShell%UseActionCenterExperience%REG_DWORD%0' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%WOW6432Node%Microsoft%Windows%CurrentVersion%ImmersiveShell%UseActionCenterExperience%REG_DWORD%0' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('reg.exe') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' | groupby user, system


stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableTaskmgr") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableTaskmgr") and user='{SuspectUser}' and host='{TargetHost}' | duration 6m

stream=authentication where  action='LOGIN' and status='FAILED' |  groupby user | limit 5

stream=authentication where  action='LOGIN' and status='FAILED' |  groupby user | limit 5

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%Microsoft%Windows%NT%CurrentVersion%Event%Viewer%MicrosoftRedirectionProgram%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%Microsoft%Windows%NT%CurrentVersion%Event%Viewer%MicrosoftRedirectionProgram%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Network%REG_SZ%/F%/D' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Network%REG_SZ%/F%/D' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=authentication where  action='LOGIN' and status='FAILED' |  groupby user | limit 5

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe' or newprocessname like '%rundll32.exe' or newprocessname like '%wscript.exe' or newprocessname like '%cscript.exe' ) and commandline like '%.js%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe' or newprocessname like '%rundll32.exe' or newprocessname like '%wscript.exe' or newprocessname like '%cscript.exe' ) and commandline like '%.js%' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|kerberos\\:\\:golden|kerberos\\:\\:tgt)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|kerberos\\:\\:golden|kerberos\\:\\:tgt)") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' | groupby user, system


stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' | groupby user, system


stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableTaskmgr") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableTaskmgr") and user='{SuspectUser}' and host='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%Microsoft%Windows%NT%CurrentVersion%Event%Viewer%MicrosoftRedirectionProgram%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%Microsoft%Windows%NT%CurrentVersion%Event%Viewer%MicrosoftRedirectionProgram%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=* | select user as system | duration 2d | limit 2

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (parentimage like '%powershell.exe' or parentimage like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (image like '%powershell.exe' or image like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableNotificationCenter") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableNotificationCenter") | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%Terminal%Server%Winstations%RDP-Tcp%SecurityLayer%REG_DWORD%d%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%Terminal%Server%Winstations%RDP-Tcp%SecurityLayer%REG_DWORD%d%0%' | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableNotificationCenter") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableNotificationCenter") | groupby user, system

stream=DOCUMENTS | groupby user,srcip | having count_col1>1000 | duration 15m  | last 10

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableTaskmgr") and user='{SuspectUser}' and system='{TargetSystem}'

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableTaskmgr") | groupby user, system

stream=authentication where  action='LOGIN' and status='FAILED' |  groupby user | limit 5

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Network%REG_SZ%/F%/D' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Network%REG_SZ%/F%/D' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (image like '%powershell.exe' or image like '%cmd.exe' or image like '%rundll32.exe' or image like '%wscript.exe' or image like '%cscript.exe' ) and commandline like '%.js%' |  groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (parentimage like '%powershell.exe' or parentimage like '%cmd.exe' or parentimage like '%rundll32.exe' or parentimage like '%wscript.exe' or parentimage like '%cscript.exe' ) and commandline like '%.js%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=* |  groupby stream, sourcename |  duration 15m

stream=ep-process where action="PROCESS-ADDED" and (commandline like "%Disable-WindowsOptionalFeature%-Online%-FeatureName%Windows-Defender%% or commandline like ""%Disable-WindowsOptionalFeature%-FeatureName%Windows-Defender%" | user, system

stream=ep-process where action='PROCESS_ADDED' and (parentimage like '%powershell.exe' or parentimage like '%cmd.exe') and (commandline like '%[Net.ServicePointManager]::SecurityProtocol%=%[Net.SecurityProtocolType]::Tls12%' or commandline like '%IEX%(iwr%*%-UseBasicParsing)%' or commandline like '%Invoke-Maldoc%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (image like '%powershell.exe' or image like '%cmd.exe') and (commandline like '%[Net.ServicePointManager]::SecurityProtocol%=%[Net.SecurityProtocolType]::Tls12%' or commandline like '%IEX%(iwr%*%-UseBasicParsing)%' or commandline like '%Invoke-Maldoc%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Network%REG_SZ%/F%/D' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Network%REG_SZ%/F%/D' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Network%REG_SZ%/F%/D' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Network%REG_SZ%/F%/D' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload%SysmonDrv%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload%SysmonDrv%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where newprocessname='%AdvancedRun.exe%' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname='%AdvancedRun.exe' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=ep-process, win-audit where action in('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(dsquery.*?filter.*?objectclass=trusteddomain|nltest.*?(domain_trusts|trusted_domains))") | groupby user, system 

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(commandline), "(dsquery.*?filter.*?objectclass=trusteddomain|nltest.*?(domain_trusts|trusted_domains))") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAHealth%REG_DWORD%/d%1%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAHealth%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAVolume%REG_DWORD%/d%1%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAVolume%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Policies%Microsoft%Windows%PowerShell%' and (commandline like '%EnableModuleLogging%' or commandline like '%EnableScriptBlockLogging%' or commandline like '%EnableTranscripting%' or commandline like '%EnableScripts%') and commandline like '%REG_DWORD%/d%0%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Policies%Microsoft%Windows%PowerShell%' and (commandline like '%EnableModuleLogging%' or commandline like '%EnableScriptBlockLogging%' or commandline like '%EnableTranscripting%' or commandline like '%EnableScripts%') and commandline like '%REG_DWORD%/d%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Policies%Microsoft%Windows%PowerShell%' and (commandline like '%EnableModuleLogging%' or commandline like '%EnableScriptBlockLogging%' or commandline like '%EnableTranscripting%' or commandline like '%EnableScripts%') and commandline like '%REG_DWORD%/d%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Policies%Microsoft%Windows%PowerShell%' and (commandline like '%EnableModuleLogging%' or commandline like '%EnableScriptBlockLogging%' or commandline like '%EnableTranscripting%' or commandline like '%EnableScripts%') and commandline like '%REG_DWORD%/d%0%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%CurrentControlSet%Control%LSA%/v%RunAsPPL%/t%REG_DWORD%/d%0%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%CurrentControlSet%Control%LSA%/v%RunAsPPL%/t%REG_DWORD%/d%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|winzip.*?-min -a -s|wzzip.*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|winzip.*?-min -a -s|wzzip.*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and processname like 'bcdedit.exe' and commandline like '%bcdedit%set%safeboot%network%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and processname like 'bcdedit.exe' and commandline like '%bcdedit%set%safeboot%network%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableNotificationCenter") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableNotificationCenter") | groupby user, system

stream=ep-process where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Network%REG_SZ%/F%/D%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Network%REG_SZ%/F%/D%' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%start-process%.bat%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and lower(commandline) like "%start-process%.bat%" | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?microphone') | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?microphone') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where processname='%AdvancedRun.exe%' and (command like '%AdvancedRun.exe%' or command like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname='%AdvancedRun.exe' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like '%Execute%' or commandline like '%EXEFilename%' or commandline like '%cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and processname like 'bcdedit.exe' and commandline like '%bcdedit%set%safeboot%network%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and processname like 'bcdedit.exe' and commandline like '%bcdedit%set%safeboot%network%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Control%Terminal%Server%Winstations%RDP-Tcp%SecurityLayer%REG_DWORD%d%0%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Control%Terminal%Server%Winstations%RDP-Tcp%SecurityLayer%REG_DWORD%d%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCANetwork%REG_DWORD%/d%1' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCANetwork%REG_DWORD%/d%1' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Network%REG_SZ%/F%/D%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Network%REG_SZ%/F%/D%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Default%' or commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Servers%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Default%' or commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Servers%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=authentication where sourcename='FORTIGATE' and action='LOGIN' | duration 10m

stream=ep-process where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAHealth%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like 'reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAHealth%REG_DWORD%/d%1%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?shutdownwithoutlogon") and user='{SuspectUser}' and system='{TargetSystem}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?shutdownwithoutlogon") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Default%' or commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Servers%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Default%' or commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Servers%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Default%' or commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Servers%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Default%' or commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Servers%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Default%' or commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Servers%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Default%' or commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Servers%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAVolume%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAVolume%REG_DWORD%/d%1%' | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?shutdownwithoutlogon") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?shutdownwithoutlogon") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Default%' or commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Servers%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Default%' or commandline like '%reg%delete%Software%Microsoft%Terminal%Server%Client%Servers%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%/F%/D%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoRun%REG_DWORD%d%1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoRun%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?shutdownwithoutlogon") and user='{SuspectUser}' and system='{TargetSystem}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?shutdownwithoutlogon") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?shutdownwithoutlogon") and user='{SuspectUser}' and system='{TargetSystem}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?shutdownwithoutlogon") | groupby user, system

stream=authentication where action='LOGIN'

stream=authentication where action='LOGIN'

stream=* | duration 10d | select substring(xhour,0, 8) as date, evtlen

stream=authentication | groupby srcip

stream=authentication | groupby srcip

stream=* | duration 1d | select sum(evtlen) | timeslice 1h

stream=* | duration 1d | select sum(evtlen) | timeslice 1h

stream=authentication | groupby srcip

stream=firewall where srcip= "93.174.93.94" |  groupby srcip | limit 1

stream=* | duration 1d | select substring(xhour,0, 8) as date, evtlen | limit 10000

stream=* | duration 3d | select substring(xhour,0, 8) as date, sum(evtlen) | groupby substring(xhour,0, 8)

stream=* | duration 1d | select substring(xhour,0, 8) as date, sum(evtlen) | groupby substring(xhour,0, 8)

stream=authentication | groupby srcip

stream=ep-process where eid='1' and ((image like '%bginfo.exe%' and commandline like '%nolicprompt%' and commandline like '%popup%') or image like '%odbcconf.exe%' or image like '%dnx.exe%') and duration 1d and system='{TargetHost}' and user='{SuspectUser}'

stream=ep-process where eid='1' and ((image like '%bginfo.exe%' and commandline like '%nolicprompt%' and commandline like '%popup%') or image like '%odbcconf.exe%' or image like '%dnx.exe%') | duration 10m | select image,system, user | limit 10

stream=auditbeat where system='ar-linux' | select regexp_extract(sourcename, "T([\\w\\-]+)$", 1) as name | groupby sourcename

stream=auditbeat where system='ar-linux' and sourcename like '%{SuspectUser}' | duration 6m

stream=authentication | groupby srcip

stream=firewall where srcip= "93.174.93.94" |  groupby srcip | limit 1

stream=authentication where action ='LOGIN' and status='FAILED'|  duration 10m |  groupby user 

stream=authentication where action='LOGIN'

stream=authentication where action='LOGOUT'

stream=authentication where action='LOGOUT'

stream=authentication where action ='LOGIN' and status='FAILED'|  duration 10m |  groupby user 

stream=IAM | duration 1M | limit 10000

stream=nxlog where devsrcip='13.126.168.111' | groupby sourcename, devsrcip | limit 1 

stream=auditbeat where sourcename='AUDITBEAT' | select regexp_extract(sourcename, "T([\\w\\-]+)$", 1) as name | groupby sourcename

stream=auditbeat where sourcename='AUDITBEAT' and name='{SuspectHost}' | duration 6m

stream=auditbeat where sourcename='AUDITBEAT' | select regexp_extract(sourcename, "T([\\w\\-]+)$", 1) as name | groupby sourcename

stream=auditbeat where sourcename='AUDITBEAT' and rlike(sourcename,'T([\\w\\-]+)$') | duration 6m

stream=auditbeat where sourcename='AUDITBEAT' | select regexp_extract(sourcename, "T([\\w\\-]+)$", 1) as name | groupby sourcename

stream=auditbeat where sourcename like '%{SuspectHost}' | duration 6m

stream=auditbeat where sourcename='AUDITBEAT' |  groupby sourcename

stream=auditbeat where sourcename='AUDITBEAT' and name like '%{SuspectHost}' | duration 6m

stream=auditbeat where sourcename='AUDITBEAT' |  groupby sourcename

stream=auditbeat where sourcename='AUDITBEAT' and sourcename='{SuspectHost}' | duration 6m

stream=auditbeat where sourcename='AUDITBEAT' and sourcename='{SuspectHost}' | duration 6m

stream=auditbeat  | select regexp_extract(sourcename, "T([\\w\\-]+)$", 1) as name | groupby sourcename

stream=auditbeat where system='ar-linux' and sourcename like '%{SuspectHost}' | duration 6m

stream=auditbeat where system='ar-linux' | select regexp_extract(sourcename, "T([\\w\\-]+)$", 1) as name | groupby sourcename

stream=auditbeat where system='ar-linux' | select regexp_extract(sourcename, "T([\\w\\-]+)$", 1) as name | groupby sourcename

stream=auditbeat where system='ar-linux' and sourcename like '%{SuspectUser}' | duration 6m

stream=DOCUMENTS | groupby user,srcip | duration 15m  | last 10

stream=authentication

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%msbuild.exe%' or commandline like '%.csproj%' or commandline like '%vb.xml%') | groupby system, user, commandline

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%msbuild.exe%' or commandline like '%.csproj%' or commandline like '%vb.xml%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (parentcommandline like "%powershell.exe%" or parentcommandline like "%reg.exe%") and commandline like "%reg add%HKEY_CURRENT_USER%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoLogOff%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action="PROCES_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%HKEY_CURRENT_USER%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (parentcommandline like "%powershell.exe%" or parentcommandline like "%reg.exe%") and commandline like "%reg add%HKEY_CURRENT_USER%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=EP-NETWORK where action='NETWORK_CONNECTION' and (parentimage like '%cmd.exe%' or parentimage like '%powershell.exe%') and (rlike(commandline,'.*schtasks.*(onlogon|spawn|delete|create)') or rlike(commandline,'.*schtasks.*(onstart|spawn|delete|create)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-NETWORK where action='NETWORK_CONNECTION' and (parentimage like '%cmd.exe%' or parentimage like '%powershell.exe%') and (rlike(commandline,'.*schtasks.*(onlogon|spawn|delete|create)') or rlike(commandline,'.*schtasks.*(onstart|spawn|delete|create)')) | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and event='Creating Scriptblock text' and scriptblocktext like '%$Action%=%New-ScheduledTaskAction%-Execute%\"calc.exe\"%$Trigger%=%New-ScheduledTaskTrigger%-AtLogon%$User%=%New-ScheduledTaskPrincipal%-GroupId%\"BUILTIN%Administrators\"%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet%$object$=$New-ScheduledTask%-Action%$Action%-Principal%$User$-Trigger%$Trigger%-Settings%$Set%Register-ScheduledTask%AtomicTask%-InputObject%$object%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and event='Creating Scriptblock text' and scriptblocktext like '%$Action%=%New-ScheduledTaskAction%-Execute%\"calc.exe\"%$Trigger%=%New-ScheduledTaskTrigger%-AtLogon%$User%=%New-ScheduledTaskPrincipal%-GroupId%\"BUILTIN%Administrators\"%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet%$object$=$New-ScheduledTask%-Action%$Action%-Principal%$User$-Trigger%$Trigger%-Settings%$Set%Register-ScheduledTask%AtomicTask%-InputObject%$object%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='mavinject.exe' and (commandline like '%mavinject%INJECTRUNNING%' or commandline like '%mavinject%hmodule=0x%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='mavinject.exe' and (commandline like '%mavinject%INJECTRUNNING%' or commandline like '%mavinject%hmodule=0x%') | groupby user, system

stream=signals

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace%root%Microsoft%Windows%Defender%' or commandline like '%call%' or commandline like '%ExclusionExtension%') |  groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and parentprocessname in ('powershell.exe','cmd.exe') and parentcommandline like '%netsh%portproxy%v4tov4%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and parentprocessname in ('powershell.exe','cmd.exe') and parentcommandline like '%netsh%portproxy%v4tov4%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('powershell.exe','cmd.exe') and commandline like '%netsh%portproxy%v4tov4%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname in ('powershell.exe','cmd.exe') and commandline like '%netsh%portproxy%v4tov4%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action='OBJECT_ACCESSED' and (scriptblocktext like "%wmic.exe%" or scriptblocktext like '%Namespace%root%Microsoft%Windows%Defender%' or scriptblocktext like "%call%" scriptblocktext like "%ExclusionExtension%") | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (scriptblocktext like "%wmic.exe%" or scriptblocktext like '%Namespace%root%Microsoft%Windows%Defender%' or scriptblocktext like "%call%" scriptblocktext like "%ExclusionExtension%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace%root%Microsoft%Windows%Defender%' or commandline like '%call%' or commandline like '%ExclusionProcess%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace%root%Microsoft%Windows%Defender%' or commandline like '%call%' or commandline like '%ExclusionProcess%') |  groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (scriptblocktext like "%wmic.exe%" or scriptblocktext like '%Namespace%root%Microsoft%Windows%Defender%' or scriptblocktext like "%call%" scriptblocktext like "%ExclusionProcess%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where action='OBJECT_ACCESSED' and (scriptblocktext like "%wmic.exe%" or scriptblocktext like '%Namespace%root%Microsoft%Windows%Defender%' or scriptblocktext like "%call%" scriptblocktext like "%ExclusionProcess%") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%HKEY_CURRENT_USER%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (parentimage like '%cmd.exe%' or parentimage like '%powershell.exe%') and (rlike(commandline,'.*schtasks.*(onlogon|spawn|delete|create)') or rlike(commandline,'.*schtasks.*(onstart|spawn|delete|create)')) | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (parentimage like '%cmd.exe%' or parentimage like '%powershell.exe%') and (rlike(commandline,'.*schtasks.*(onlogon|spawn|delete|create)') or rlike(commandline,'.*schtasks.*(onstart|spawn|delete|create)')) | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (parentimage like '%cmd.exe%' or parentimage like '%powershell.exe%') and (rlike(commandline,'.*schtasks.*(onlogon|spawn|delete|create)') or rlike(commandline,'.*schtasks.*(onstart|spawn|delete|create)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (parentimage like '%cmd.exe%' or parentimage like '%powershell.exe%') and (rlike(commandline,'.*schtasks.*(onlogon|spawn|delete|create)') or rlike(commandline,'.*schtasks.*(onstart|spawn|delete|create)')) | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (parentimage like '%cmd.exe%' or parentimage like '%powershell.exe%') and (rlike(commandline,'.*schtasks.*(onlogon|spawn|delete|create)') or rlike(commandline,'.*schtasks.*(onstart|spawn|delete|create)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (parentimage like '%cmd.exe%' or parentimage like '%powershell.exe%') and (rlike(commandline,'.*schtasks.*(onlogon|spawn|delete|create)') or rlike(commandline,'.*schtasks.*(onstart|spawn|delete|create)')) | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (parentimage like '%cmd.exe%' or parentimage like '%powershell.exe%') and (rlike(commandline,'.*schtasks.*(onlogon|spawn|delete|create)') or rlike(commandline,'.*schtasks.*(onstart|spawn|delete|create)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (parentimage like '%cmd.exe%' or parentimage like '%powershell.exe%') and (rlike(commandline,'.*schtasks.*(onlogon|spawn|delete|create)') or rlike(commandline,'.*schtasks.*(onstart|spawn|delete|create)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (parentimage like '%cmd.exe%' or parentimage like '%powershell.exe%') and (rlike(commandline,'.*schtasks.*(onlogon|spawn|delete|create)') or rlike(commandline,'.*schtasks.*(onstart|spawn|delete|create)')) | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and newprocessname like "%C%Windows%System32%schtasks.exe%" and commandline like "%schtasks%query%Windows Defender%" | groupby system, user

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU%NoAutoUpdate%REG_DWORD /d 1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU%NoAutoUpdate%REG_DWORD /d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCES_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoControlPanel%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and event='Creating Scriptblock text' and scriptblocktext like '%$Action%=%New-ScheduledTaskAction%-Execute%\"calc.exe\"%$Trigger%=%New-ScheduledTaskTrigger%-AtLogon%$User%=%New-ScheduledTaskPrincipal%-GroupId%\"BUILTIN%Administrators\"%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet%$object$=$New-ScheduledTask%-Action%$Action%-Principal%$User$-Trigger%$Trigger%-Settings%$Set%Register-ScheduledTask%AtomicTask%-InputObject%$object%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and event='Creating Scriptblock text' and scriptblocktext like '%$Action%=%New-ScheduledTaskAction%-Execute%\"calc.exe\"%$Trigger%=%New-ScheduledTaskTrigger%-AtLogon%$User%=%New-ScheduledTaskPrincipal%-GroupId%\"BUILTIN%Administrators\"%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet%$object$=$New-ScheduledTask%-Action%$Action%-Principal%$User$-Trigger%$Trigger%-Settings%$Set%Register-ScheduledTask%AtomicTask%-InputObject%$object%' | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and event='Creating Scriptblock text' and scriptblocktext like '%$Action%=%New-ScheduledTaskAction%-Execute%\"calc.exe\"%$Trigger%=%New-ScheduledTaskTrigger%-AtLogon%$User%=%New-ScheduledTaskPrincipal%-GroupId%\"BUILTIN%Administrators\"%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet%$object$=$New-ScheduledTask%-Action%$Action%-Principal%$User$-Trigger%$Trigger%-Settings%$Set%Register-ScheduledTask%AtomicTask%-InputObject%$object%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and event='Creating Scriptblock text' and scriptblocktext like '%$Action%=%New-ScheduledTaskAction%-Execute%\"calc.exe\"%$Trigger%=%New-ScheduledTaskTrigger%-AtLogon%$User%=%New-ScheduledTaskPrincipal%-GroupId%\"BUILTIN%Administrators\"%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet%$object$=$New-ScheduledTask%-Action%$Action%-Principal%$User$-Trigger%$Trigger%-Settings%$Set%Register-ScheduledTask%AtomicTask%-InputObject%$object%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='mavinject.exe' and (commandline like '%mavinject%INJECTRUNNING%' or commandline like '%mavinject%hmodule=0x%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='mavinject.exe' and (commandline like '%mavinject%INJECTRUNNING%' or commandline like '%mavinject%hmodule=0x%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and scriptblocktext like '%netsh%portproxy%v4tov4%' | groupby user, system

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and scriptblocktext like '%netsh%portproxy%v4tov4%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' |  groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace%root%Microsoft%Windows%Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' |  groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and image like "%C%Windows%System32%schtasks.exe%" and commandline like "%schtasks%query%Windows Defender%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like "%C%Windows%System32%schtasks.exe%" and commandline like "%schtasks%query%Windows Defender%" | groupby system, user

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFind%REG_DWORD%d%1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoRun%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like '%System%CurrentControlSet%Control%Terminal Server%fAllowToGetHelp%REG_DWORD%1' | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like '%System%CurrentControlSet%Control%Terminal Server%fAllowToGetHelp%REG_DWORD%1' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='mavinject.exe' and (commandline like '%mavinject.exe%INJECTRUNNING%' or commandline like '%mavinject.exe%hmodule=0x%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='mavinject.exe' and (commandline like '%mavinject.exe%INJECTRUNNING%' or commandline like '%mavinject.exe%hmodule=0x%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit | duration 30d | groupby system, user

stream=ep-process where action="PROCESS_ADDED" and image like "%C%Windows%System32%schtasks.exe%" and commandline like "%schtasks%query%Windows Defender%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%wmic.exe%' or commandline like '%Namespace%root%Microsoft%Windows%Defender%' or commandline like '%call%' or commandline like '%ExclusionExtension%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%wmic.exe%' or commandline like '%Namespace%root%Microsoft%Windows%Defender%' or commandline like '%call%' or commandline like '%ExclusionExtension%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=signals

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%') |  groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace%root%Microsoft%Windows%Defender%' or commandline like '%call%' or commandline like '%ExclusionPath=%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionExtension%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionExtension%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionProcess%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionProcess%' |  groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoControlPanel%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFind%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoRun%REG_DWORD%d%1%" | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%System%CurrentControlSet%Control%Terminal Server%fAllowToGetHelp%REG_DWORD%1' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%System%CurrentControlSet%Control%Terminal Server%fAllowToGetHelp%REG_DWORD%1' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%System%CurrentControlSet%Control%Terminal Server%fAllowToGetHelp%REG_DWORD%1' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%System%CurrentControlSet%Control%Terminal Server%fAllowToGetHelp%REG_DWORD%1' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action='OBJECT_ACCESSED' and event='Creating Scriptblock text' and scriptblocktext like '%$Action%=%New-ScheduledTaskAction%-Execute%\"calc.exe\"%$Trigger%=%New-ScheduledTaskTrigger%-AtLogon%$User%=%New-ScheduledTaskPrincipal%-GroupId%\"BUILTIN%Administrators\"%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet%$object$=$New-ScheduledTask%-Action%$Action%-Principal%$User$-Trigger%$Trigger%-Settings%$Set%Register-ScheduledTask%AtomicTask%-InputObject%$object%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and event='Creating Scriptblock text' and scriptblocktext like '%$Action%=%New-ScheduledTaskAction%-Execute%\"calc.exe\"%$Trigger%=%New-ScheduledTaskTrigger%-AtLogon%$User%=%New-ScheduledTaskPrincipal%-GroupId%\"BUILTIN%Administrators\"%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet%$object$=$New-ScheduledTask%-Action%$Action%-Principal%$User$-Trigger%$Trigger%-Settings%$Set%Register-ScheduledTask%AtomicTask%-InputObject%$object%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mavinject.exe%INJECTRUNNING%' or commandline like '%mavinject.exe%hmodule=0x%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mavinject.exe%INJECTRUNNING%' or commandline like '%mavinject.exe%hmodule=0x%') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoDesktop%REG_DWORD%d%1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoDesktop%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%UX Configuration%Notification_Suppress%REG_DWORD%1' | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%UX Configuration%Notification_Suppress%REG_DWORD%1' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%mavinject%INJECTRUNNING%' or scriptblocktext like '%mavinject%hmodule=0x%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%mavinject%INJECTRUNNING%' or scriptblocktext like '%mavinject%hmodule=0x%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace%root%Microsoft%Windows%Defender%' or commandline like '%call%' or commandline like '%ExclusionExtension%') |  groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%wmic.exe%' or commandline like '%Namespace%root%Microsoft%Windows%Defender%' or commandline like '%call%' or commandline like '%ExclusionExtension%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%wmic.exe%' or commandline like '%Namespace%root%Microsoft%Windows%Defender%' or commandline like '%call%' or commandline like '%ExclusionProcess%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%wmic.exe%' or commandline like '%Namespace%root%Microsoft%Windows%Defender%' or commandline like '%call%' or commandline like '%ExclusionProcess%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionExtension%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionExtension%' |  groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionExtension%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionExtension%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionProcess%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionProcess%' | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionProcess%' | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionProcess%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?(StartMenuLogOff|onlogoff)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?(StartMenuLogOff|onlogoff)") | groupby user, system

stream=ep-process where action="PROCESS-ADDED" and (commandline like "%Disable-WindowsOptionalFeature%-Online%-FeatureName%Windows-Defender%" or commandline like "%Disable-WindowsOptionalFeature%-FeatureName%Windows-Defender%" | user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and ((parentimage like "explorer.exe" and image like "%.exe" and commandline like "%--encrypt%" or commandline like "%--symmetric%") or (parentimage like "powershell.exe" and commandline like "%New-Object Net.WebClient%DownloadFile%--encrypt%" or commandline like "%New-Object Net.WebClient*DownloadFile%--symmetric%") or (parentimage like "cmd.exe" and (commandline like "%gpg.exe%--encrypt%" or commandline like "%gpg.exe%--symmetric%")) or (parentimage like "cmd.exe" and (commandline like "%gpg2.exe%--encrypt%" or commandline like "%gpg2.exe%--symmetric%")) or parentimage like "cmd.exe" and (commandline like "%kleopatra.exe%--encrypt%" or commandline like "%kleopatra.exe%--symmetric%") or (commandline like "%gpg.exe%"" and parentimage like "%cmd.exe")) | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and ((parentimage like "explorer.exe" and image like "%.exe" and commandline like "%--encrypt%" or commandline like "%--symmetric%") or (parentimage like "powershell.exe" and commandline like "%New-Object Net.WebClient%DownloadFile%--encrypt%" or commandline like "%New-Object Net.WebClient%DownloadFile%--symmetric%") or (parentimage like "cmd.exe" and (commandline like "%gpg.exe%--encrypt%" or commandline like "%gpg.exe%--symmetric%")) or (parentimage like "cmd.exe" and (commandline like "%gpg2.exe%--encrypt%" or commandline like "%gpg2.exe%--symmetric%")) or parentimage like "cmd.exe" and (commandline like "%kleopatra.exe%--encrypt%" or commandline like "%kleopatra.exe%--symmetric%") or (commandline like "%gpg.exe%"" and parentimage like "%cmd.exe")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS-ADDED" and (commandline like "%Disable-WindowsOptionalFeature%-Online%-FeatureName%Windows-Defender%" or commandline like "%Disable-WindowsOptionalFeature%-FeatureName%Windows-Defender%" | groupby user, system

stream=win-audit where (action like 'PROCESS_CREATED' or action like 'OBJECT_ACCESSED') and (commandline like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' or scriptblocktext like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (action like 'PROCESS_CREATED' or action like 'OBJECT_ACCESSED') and (commandline like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' or scriptblocktext like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED'  and commandline like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED'  and commandline like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Reporting%DisableEnhancedNotifications%REG_DWORD /d 1%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Reporting%DisableEnhancedNotifications%REG_DWORD /d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-File where action="FILE_CREATED" and commandline like "%csc.exe%" and ( commandline like "%target:exe%" or commandline like "%code%" or commandline like "%out%" ) | groupby system, user

stream=EP-File where action="FILE_CREATED" and commandline like "%csc.exe%" and ( commandline like "%target:exe%" or commandline like "%code%" or commandline like "%out%" ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%C:%Windows%Microsoft%.NET%Framework64%v4.0.30319%csc%.exe%" and commandline like "%noconfig%fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%C:%Windows%Microsoft%.NET%Framework64%v4.0.30319%csc%.exe%" and commandline like "%noconfig%fullpaths%" | groupby user, system

stream=ep-process where action="PROCESS-ADDED" and (commandline like "%Disable-WindowsOptionalFeature%-Online%-FeatureName%Windows-Defender%" or commandline like "%Disable-WindowsOptionalFeature%-FeatureName%Windows-Defender%" | groupby user, system

stream=win-audit where (action like 'PROCESS_CREATED' or action like 'OBJECT_ACCESSED') and (commandline like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' or scriptblocktext like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%') | groupby user, system

stream=win-audit where (action like 'PROCESS_CREATED' or action like 'OBJECT_ACCESSED') and (commandline like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' or scriptblocktext like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg.*?\.exe|gpedit\.msc|cmd\.exe).*?(DisableLockWorkstation).*?\/d\s1") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg.*?\.exe|gpedit\.msc|cmd\.exe).*?(DisableLockWorkstation).*?\/d\s1") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows Defender Security Center\\Notifications%DisableNotifications%REG_DWORD /d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows Defender Security Center\\Notifications%DisableNotifications%REG_DWORD /d 1%" | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%$Action%=%New-ScheduledTaskAction%-Execute%cmd.exe%$Trigger%=%New-ScheduledTaskTrigger%-AtLogon%$User%=%New-ScheduledTaskPrincipal%-GroupId%BUILTIN%Administrators%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet$$object%=%New-ScheduledTask%-Action%$Action%-Principal%$User%-Trigger%$Trigger%-Settings%$Set$Register-ScheduledTask%AtomicTaskModifed%-InputObject%$object%$NewAction%=%New-ScheduledTaskAction%-Execute%Notepad.exe%Set-ScheduledTask%AtomicTaskModifed%-Action%$NewAction}%' | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%$Action%=%New-ScheduledTaskAction%-Execute%cmd.exe%$Trigger%=%New-ScheduledTaskTrigger%-AtLogon%$User%=%New-ScheduledTaskPrincipal%-GroupId%BUILTIN%Administrators%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet$$object%=%New-ScheduledTask%-Action%$Action%-Principal%$User%-Trigger%$Trigger%-Settings%$Set$Register-ScheduledTask%AtomicTaskModifed%-InputObject%$object%$NewAction%=%New-ScheduledTaskAction%-Execute%Notepad.exe%Set-ScheduledTask%AtomicTaskModifed%-Action%$NewAction}%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and processname='wmic.exe' and commandline like '%Namespace%root%Microsoft%Windows%Defender%call%ExclusionExtension%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionExtension%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where (action like 'PROCESS_CREATED' or action like 'OBJECT_ACCESSED') and (commandline like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' or scriptblocktext like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%') | groupby user, system

stream=win-audit where (action like 'PROCESS_CREATED' or action like 'OBJECT_ACCESSED') and (commandline like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' or scriptblocktext like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED'  and commandline like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED'  and commandline like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%$Action%=%New-ScheduledTaskAction%-Execute%cmd.exe%$Trigger%=%New-ScheduledTaskTrigger%-AtLogon%$User%=%New-ScheduledTaskPrincipal%-GroupId%BUILTIN%Administrators%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet$$object%=%New-ScheduledTask%-Action%$Action%-Principal%$User%-Trigger%$Trigger%-Settings%$Set$Register-ScheduledTask%AtomicTaskModifed%-InputObject%$object%$NewAction%=%New-ScheduledTaskAction%-Execute%Notepad.exe%Set-ScheduledTask%AtomicTaskModifed%-Action%$NewAction}%' | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%$Action%=%New-ScheduledTaskAction%-Execute%cmd.exe%$Trigger%=%New-ScheduledTaskTrigger%-AtLogon%$User%=%New-ScheduledTaskPrincipal%-GroupId%BUILTIN%Administrators%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet$$object%=%New-ScheduledTask%-Action%$Action%-Principal%$User%-Trigger%$Trigger%-Settings%$Set$Register-ScheduledTask%AtomicTaskModifed%-InputObject%$object%$NewAction%=%New-ScheduledTaskAction%-Execute%Notepad.exe%Set-ScheduledTask%AtomicTaskModifed%-Action%$NewAction}%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and image like "%C%Windows%System32%schtasks.exe%" and commandline like "%schtasks%query%Windows Defender%" | groupby system, user

stream=ep-process where action="PROCESS_ADDED" and image like "%C%Windows%System32%schtasks.exe%" and commandline like "%schtasks%query%Windows Defender%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows Defender Security Center\\Notifications%DisableNotifications%REG_DWORD /d 1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows Defender Security Center\\Notifications%DisableNotifications%REG_DWORD /d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and processname='wmic.exe' and commandline like '%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and processname='wmic.exe' and commandline like '%Namespace%root%Microsoft%Windows%Defender%call%ExclusionProcess%' |  groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionProcess%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED'  and commandline like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED'  and commandline like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg.*?\.exe|gpedit\.msc|cmd\.exe).*?(DisableLockWorkstation).*?\/d\s1") and user='{SuspectUser}' and system='{TargetHsot}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\.exe|reg.*?\.exe|gpedit\.msc|cmd\.exe).*?(DisableLockWorkstation).*?\/d\s1") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Reporting%DisableEnhancedNotifications%REG_DWORD /d 1%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows Defender\\Reporting%DisableEnhancedNotifications%REG_DWORD /d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and image like "%C%%Windows%System32%schtasks.exe%" and commandline like "%schtasks%query%Windows Defender%" | groupby system, user

stream=ep-process where action="PROCESS_ADDED" and image like "%C%Windows%System32%schtasks.exe%" and commandline like "%schtasks%query%Windows Defender%" | groupby system, user

stream=ep-process where action="PROCESS_ADDED" and image like "%C%Windows%System32%schtasks.exe%" and commandline like "%schtasks%query%Windows Defender%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%$Action%=%New-ScheduledTaskAction%-Execute%cmd.exe%$Trigger%=%New-ScheduledTaskTrigger%-AtLogon%$User%=%New-ScheduledTaskPrincipal%-GroupId%BUILTIN%Administrators%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet$$object%=%New-ScheduledTask%-Action%$Action%-Principal%$User%-Trigger%$Trigger%-Settings%$Set$Register-ScheduledTask%AtomicTaskModifed%-InputObject%$object%$NewAction%=%New-ScheduledTaskAction%-Execute%Notepad.exe%Set-ScheduledTask%AtomicTaskModifed%-Action%$NewAction}%' | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%$Action%=%New-ScheduledTaskAction%-Execute%cmd.exe%$Trigger%=%New-ScheduledTaskTrigger%-AtLogon%$User%=%New-ScheduledTaskPrincipal%-GroupId%BUILTIN%Administrators%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet$$object%=%New-ScheduledTask%-Action%$Action%-Principal%$User%-Trigger%$Trigger%-Settings%$Set$Register-ScheduledTask%AtomicTaskModifed%-InputObject%$object%$NewAction%=%New-ScheduledTaskAction%-Execute%Notepad.exe%Set-ScheduledTask%AtomicTaskModifed%-Action%$NewAction}%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname='wmic.exe' and commandline like '%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' |  groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=authentication

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%" or image like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%" or image like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" | groupby system, user

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU%NoAutoUpdate%REG_DWORD /d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU%NoAutoUpdate%REG_DWORD /d 1%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%" or newprocessname like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" | groupby system, user

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%" or newprocessname like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-Process where action="PROCESS_ADDED" and commandline like "%csc.exe%" and (commandline like "%target:exe%" or commandline like "%code%" or commandline like "%out%" ) | groupby system, user  and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-Process where action="PROCESS_ADDED" and commandline like "%csc.exe%" and (commandline like "%target:exe%" or commandline like "%code%" or commandline like "%out%" ) | groupby system, user 

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows Defender Security Center\\Notifications%DisableNotifications%REG_DWORD /d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows Defender Security Center\\Notifications%DisableNotifications%REG_DWORD /d 1%" | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionExtension%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and processname='wmic.exe' and commandline like '%Namespace%root%Microsoft%Windows%Defender%call%ExclusionExtension%' |  groupby user, system

stream=win-audit where action='PROCESS_CREATED' and processname='wmic.exe' and commandline like '%Namespace%root%Microsoft%Windows%Defender%call%ExclusionProcess%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionProcess%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%" or image like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%" or image like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" | groupby system, user

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU%NoAutoUpdate%REG_DWORD /d 1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU%NoAutoUpdate%REG_DWORD /d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process | duration 30d | groupby system, user

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%" or image like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%" or image like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" | groupby system, user

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%" or image like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%" or image like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" | groupby system, user

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%" or image like "%cmd.exe%") and commandline like "%reg%add%HypervisorEnforcedCodeIntegrity%Enabled%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU%NoAutoRebootWithLoggedOnUsers%REG_DWORD /d 1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU%NoAutoRebootWithLoggedOnUsers%REG_DWORD /d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and CommandLine like "%C:%Windows%Microsoft.NET%Framework64%v4.0.30319%csc.exe%noconfig%fullpaths%" | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and CommandLine like "%C:%Windows%Microsoft.NET%Framework64%v4.0.30319%csc.exe%noconfig%fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=* |  groupby stream, sourcename |  duration 1d

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '((net|sc).*?(stop|delete).*?sysmon|sysmon.*?-u)') | groupby system, user

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '((net|sc).*?(stop|delete).*?sysmon|sysmon.*?-u)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=firewall | duration 1h | groupby action, srccn | limit 5

stream=firewall | duration 1h | groupby action, srccn | limit 5

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add %SOFTWARE%Microsoft%Windows%Defender%Features%TamperProtection%REG_DWORD%d%"

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Microsoft%Windows%Defender%Features%TamperProtection%REG_DWORD%d%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Microsoft%Windows%Defender%Features%TamperProtection%REG_DWORD%d%" | groupby system, user

stream=EP-Process where action="PROCESS_ADDED" and commandline like "%csc.exe%" and (commandline like "%/target:exe%/code%/out%" ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-Process where action="PROCESS_ADDED" and commandline like "%csc.exe%" and (commandline like "%/target:exe%/code%/out%" ) | groupby system, user 

stream=EP-REGISTRY where (targetobject like '%Software%Policies%Microsoft%Windows%OOBE%' or targetobject like '%Software%Microsoft%Windows%CurrentVersion%Privacy%') | groupby user,system

stream=EP-REGISTRY where (targetobject like '%Software%Policies%Microsoft%Windows%OOBE%' or targetobject like '%Software%Microsoft%Windows%CurrentVersion%Privacy%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=* |  groupby stream, sourcename |  duration 1d

stream=ep-process where action="PROCESS_ADDED" and commandline like "%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%MaxConnectionsPerServer%REG_DWORD%d%" | groupby user, system

stream=firewall | groupby action, srccn | having count_col1>9000 | duration 1h |  limit 5

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%DoNotConnectToWindowsUpdateInternetLocations%REG_DWORD%d%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%DoNotConnectToWindowsUpdateInternetLocations%REG_DWORD%d%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%AUOptions%REG_DWORD%d%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%AUOptions%REG_DWORD%d%" | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '

stream=EP-File where action="FILE_CREATED" and commandline like "%csc.exe%" and ( commandline like "%target:exe%" or commandline like "%code%" or commandline like "%out%" ) | groupby system, user

stream=EP-File where action="FILE_CREATED" and commandline like "%csc.exe%" and ( commandline like "%target:exe%" or commandline like "%code%" or commandline like "%out%" ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU%NoAutoRebootWithLoggedOnUsers%REG_DWORD /d 1%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE\\Policies\\Microsoft\\Windows\\WindowsUpdate\\AU%NoAutoRebootWithLoggedOnUsers%REG_DWORD /d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=firewall | duration 1h | groupby action, srccn | limit 5

stream=firewall | duration 1h | groupby action, srccn | having count_col1>9000 | limit 5

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add %SOFTWARE%Microsoft%Windows%Defender%Features%TamperProtection%REG_DWORD%d%" | groupby system, user

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%MaxConnectionsPerServer%REG_DWORD%d%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%DoNotConnectToWindowsUpdateInternetLocations%REG_DWORD%d%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%Defender%Reporting%DisableEnhancedNotifications%REG_DWORD%d%1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%Defender%Reporting%DisableEnhancedNotifications%REG_DWORD%d%1%" | groupby user, system

stream=authentication | groupby srcip,user | having count_col1>500 | limit 10

stream=EMAIL-GATEWAY | groupby action,direction | having count_col1>1000 | duration 15m  | limit 10

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'system.management.automation.amsi.*?(amsiinitfailed|scancontent|amsicontext|amsisession|amsiutils.init|amsiscanbuffer|amsi.dll)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'system.management.automation.amsi.*?(amsiinitfailed|scancontent|amsicontext|amsisession|amsiutils.init|amsiscanbuffer|amsi.dll)') | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), 'system.management.automation.amsi.*?(amsiinitfailed|scancontent|amsicontext|amsisession|amsiutils.init|amsiscanbuffer|amsi.dll)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), 'system.management.automation.amsi.*?(amsiinitfailed|scancontent|amsicontext|amsisession|amsiutils.init|amsiscanbuffer|amsi.dll)') | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%MaxConnectionsPerServer%REG_DWORD%d%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%MaxConnectionsPerServer%REG_DWORD%d%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%SOFTWARE%Microsoft%Windows%Defender%Features%TamperProtection%REG_DWORD%d%" | groupby user, system

stream=firewall | duration 1h | groupby action, srccn | having count_col1>9000 | limit 5

stream=win-audit where action="PROCESS_CREATED" and newprocessname like '%cmd.exe' and (commandline like 'reg%add%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like 'reg%delete%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or Commandline like '%New-ItemProperty%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') | groupby user, system 

stream=win-audit where action="PROCESS_CREATED" and (commandline like 'reg add' or commandline like 'reg delete' or commandline like 'New-ItemProperty' or Commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'system.management.automation.amsi.*?(amsiinitfailed|scancontent|amsicontext|amsisession|amsiutils.init|amsiscanbuffer|amsi.dll)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'system.management.automation.amsi.*?(amsiinitfailed|scancontent|amsicontext|amsisession|amsiutils.init|amsiscanbuffer|amsi.dll)') | groupby user, system

stream=authentication | groupby srcip,user | select user, count_if(srcip == '23.129.64.216') | limit 10

stream=authentication | duration 15m | groupby srcip,user | having count_col1>500 | limit 10

stream=firewall | groupby action, srccn | having count_col1>500 | duration 30m |  limit 5

stream=EMAIL-GATEWAY | groupby action,direction | having count_col1>1000 | duration 15m  | limit 10

stream=ep-process where action='PROCESS_ADDED' and (commandline like 'reg add' or commandline like 'reg delete' or commandline like 'New-ItemProperty' or Commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (commandline like 'reg add' or commandline like 'reg delete' or commandline like 'New-ItemProperty' or Commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell%.exe%" or newprocessname like "%wscript.exe%" or newprocessname like "%cscript.exe%") and (commandline like "%-drtm%" or commandline like "%-dbm%" or commandline like "%-dscrptsc%" or commandline like "%-dbaf%") | groupby system, user

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell%.exe%" or newprocessname like "%wscript.exe%" or newprocessname like "%cscript.exe%") and (commandline like "%-drtm%" or commandline like "%-dbm%" or commandline like "%-dscrptsc%" or commandline like "%-dbaf%") | groupby system, user

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell%.exe%" or parentimage like "%wscript.exe%" or parentimage like "%cscript.exe%") and (commandline like "%Set-MpPreference%-drtm%True%" or commandline like "%Set-MpPreference%-dbm%True%" or commandline like "%Set-MpPreference%-dscrptsc%True%" or commandline like "%Set-MpPreference%-dbaf%True%") 

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell%.exe%" or parentimage like "%wscript.exe%" or parentimage like "%cscript.exe%") and (commandline like "%Set-MpPreference%-drtm%True%" or commandline like "%Set-MpPreference%-dbm%True%" or commandline like "%Set-MpPreference%-dscrptsc%True%" or commandline like "%Set-MpPreference%-dbaf%True%") 

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell%.exe%" or parentimage like "%wscript.exe%" or parentimage like "%cscript.exe%") and (commandline like "%Set-MpPreference%-drtm%True%" or commandline like "%Set-MpPreference%-dbm%True%" or commandline like "%Set-MpPreference%-dscrptsc%True%" or commandline like "%Set-MpPreference%-dbaf%True%") 

stream=ep-process where action='PROCESS_ADDED' and (commandline like 'reg add' or commandline like 'reg delete' or commandline like 'New-ItemProperty' or Commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (commandline like 'reg add' or commandline like 'reg delete' or commandline like 'New-ItemProperty' or Commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (commandline like 'reg add' or commandline like 'reg delete' or commandline like 'New-ItemProperty' or Commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (commandline like 'reg add' or commandline like 'reg delete' or commandline like 'New-ItemProperty' or Commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') | groupby user, system 

stream=win-audit where action="PROCESS_CREATED" and (commandline like 'reg add' or commandline like 'reg delete' or commandline like 'New-ItemProperty' or Commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like '%cmd.exe' and (commandline like 'reg%add%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like 'reg%delete%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%'  Commandline like '%New-ItemProperty%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') | groupby user, system 

stream=ep-process where (lower(parentimage) like "%powershell.exe%" or lower(parentimage) like "%cmd.exe%") and (commandline like "%fileNameToDelete = %.crmlog%" or commandline like "%Remove-Item -Path%") and user='{SuspectUser}' and system='{TargetHost}'

stream=ep-process where (lower(parentimage) like "%powershell.exe%" or lower(parentimage) like "%cmd.exe%") and (commandline like "%fileNameToDelete = %.crmlog%" or commandline like "%Remove-Item -Path%") | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and newprocessname like '%cmd.exe' and (commandline like 'reg%add%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like 'reg%delete%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or Commandline like '%New-ItemProperty%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (commandline like 'reg add' or commandline like 'reg delete' or commandline like 'New-ItemProperty' or Commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell%.exe%" or parentimage like "%wscript.exe%" or parentimage like "%cscript.exe%") and (commandline like "%Set-MpPreference%-drtm%True%" or commandline like "%Set-MpPreference%-dbm%True%" or commandline like "%Set-MpPreference%-dscrptsc%True%" or commandline like "%Set-MpPreference%-dbaf%True%") 

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%sc.exe%" or newprocessname like "%cmd.exe%") and (commandline like "%config WinDefend start=disabled%" or commandline like "%stop WinDefend%" or commandline like "%query WinDefend%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell%.exe%" or newprocessname like "%wscript.exe%" or newprocessname like "%cscript.exe%") and (commandline like "%-drtm%1" or commandline like "%-dbm%1" or commandline like "%-dscrptsc%1" or commandline like "%-dbaf%1") | groupby system, user

stream=win-audit where action="PROCESS_CREATED" and newprocessname like '%powershell.exe' and (commandline like 'reg%add%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like 'reg%delete%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or Commandline like '%New-ItemProperty%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like '%powershell.exe' and (commandline like 'reg%add%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like 'reg%delete%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or Commandline like '%New-ItemProperty%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') | groupby user, system 

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like "%C:%Windows%Microsoft.NET%Framework64%v4.0.30319%csc.exe%noconfig%fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like "%C:%Windows%Microsoft.NET%Framework64%v4.0.30319%csc.exe%noconfig%fullpaths%" | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'wevtutil.*?(epl|export-log).*?c:.*?(q|sq|lf|ow):.*?system.*?eventid=4776') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'wevtutil.*?(epl|export-log).*?c:.*?(q|sq|lf|ow):.*?system.*?eventid=4776') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="OBJECT_ACCESSED" and scriptblocktext like "%Win32_Process%" | groupby system, user

stream=win-audit where action="OBJECT_ACCESSED" and ScriptBlockText="%Win32_Process%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like "%C:%Windows%Microsoft.NET%Framework64%v4.0.30319%csc.exe%noconfig%fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like "%C:%Windows%Microsoft.NET%Framework64%v4.0.30319%csc.exe%noconfig%fullpaths%" | groupby user, system

stream=win-audit where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") and user='{SuspectUser}' and host='{SuspectHost}' | duration 6m

stream=ep-process where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=win-audit where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=win-audit where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") and user='{SuspectUser}' and host='{SuspectHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (NewProcessName like "%.jse" or NewProcessName like "%.js") and rlike(CommandLine, '(\\-\\-decompress|\\-c)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (NewProcessName like "%.jse" or NewProcessName like "%.js") and rlike(CommandLine, '(\\-\\-decompress|\\-c)') and user='{SuspectUser}' and system='{TargetSystem}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=DOCUMENTS | groupby user,srcip | having count_col1>1000 | duration 15m  | limit 10

stream=DOCUMENTS | groupby user,srcip | having count_col1>1000 | duration 15m  | limit 10

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%C:%Windows%Microsoft%.NET%Framework64%v4.0.30319%csc.exe%.exe%noconfig%fullpaths%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%C:%Windows%Microsoft%.NET%Framework64%v4.0.30319%csc.exe%.exe%noconfig%fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-FILE where action="FILE_CREATED" and (commandline like "%csc.exe%target:exe%" or commandline like "%csc.exe%code%" or commandline like "%csc.exe%out%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-FILE where action="FILE_CREATED" and (commandline like "%csc.exe%target:exe%" or commandline like "%csc.exe%code%" or commandline like "%csc.exe%out%") | groupby system, user

stream=EP-PROCESS where action="PROCESS_ADDED" and parentcommandline like "%powershell.exe%Win32_Process%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and parentcommandline like "%powershell.exe%Win32_Process%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where eid = '10' | duration 1d |  groupby @SourceImage 

stream=ep-process where (lower(parentimage) like "%powershell.exe%" or lower(parentimage) like "%cmd.exe%") and (commandline like "%fileNameToDelete = %.crmlog%" or commandline like "%Remove-Item -Path%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where (lower(parentimage) like "%powershell.exe%" or lower(parentimage) like "%cmd.exe%") and (commandline like "%fileNameToDelete = %.crmlog%" or commandline like "%Remove-Item -Path%") | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (NewProcessName like "%.jse" or NewProcessName like "%.js") and rlike(CommandLine, '(\\-\\-decompress|\\-c)') and user='{SuspectUser}' and system='{TargetSystem}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (NewProcessName like "%.jse" or NewProcessName like "%.js") and rlike(CommandLine, '(\\-\\-decompress|\\-c)') | groupby user, system

stream=authentication | groupby user,srcip | duration 15m  | last 10

stream=win-audit where action='PROCESS_CREATED' and commnadline like '%powershell%UseBasicParsing%Get-PasswordVaultCredentials%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%powershell%UseBasicParsing%Get-PasswordVaultCredentials%' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%invoke-wmimethod%" and lower(commandline) like '%class%win32_process%create%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%invoke-wmimethod%" and lower(commandline) like "%class%win32_process%create%") | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(generaldomaininfo|winpwn).*?-(noninteractive|consoleoutput|domainrecon)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(generaldomaininfo|winpwn).*?-(noninteractive|consoleoutput|domainrecon)') | groupby user, system

stream=authentication where (eid='4768' or eid='4769' or eid='4771' or eid='4776') and not user like '%$%' and not user like '%@%' | groupby user, system, action | duration 1d | limit 10

stream=EP-PROCESS where action="PROCESS_ADDED" and parentcommandline like "%powershell.exe%Win32_Process%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and parentcommandline like "%powershell.exe%Win32_Process%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(systeminfo)') | groupby user, system

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'(reg.*?delete|remove|set.*?itemproperty).*?(hklm|hkey_local_machine).*?software.*?amsi.*?provider') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'(reg.*?delete|remove|set.*?itemproperty).*?(hklm|hkey_local_machine).*?software.*?amsi.*?provider') | groupby user, system | duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%' | groupby user, system

stream=authentication | groupby user,srcip,action | duration 15m  | limit 10

stream=authentication | groupby user,srcip,action | duration 15m  | limit 10

stream=authentication

stream=email-gateway where sourcename='TRENDMICRO-EMAIL-SECURITY' AND action='EMAIL_QUARANTINED' and sender is not null |  duration 1d | groupby sender | limit 10

stream=email-gateway where action='EMAIL_BOUNCED' AND sourcename='TRENDMICRO-EMAIL-SECURITY' | duration 1d  |  groupby sourcename

stream=threat where sourcename='TRENDMICRO-EMAIL-SECURITY' AND action='THREAT_DETECTED' and srcip is not null | groupby srcip , recipient | duration 1d | limit 10

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe' and commandline like '%wmic%node:% product where %"name like %" call uninstall' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe' and commandline like '%wmic%node:% product where %"name like %" call uninstall' | groupby system, user

stream=ep-process where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=win-audit where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") and user='{SuspectUser}' and host='{SuspectHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (parentimage like '%powershell.exe' or parentimage like '%cmd.exe') and (commandline like '%[Net.ServicePointManager]::SecurityProtocol%=%[Net.SecurityProtocolType]::Tls12%' or commandline like '%IEX%(iwr%-UseBasicParsing)%' or commandline like '%Invoke-Maldoc%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (image like '%powershell.exe' or image like '%cmd.exe') and (commandline like '%[Net.ServicePointManager]::SecurityProtocol%=%[Net.SecurityProtocolType]::Tls12%' or commandline like '%IEX%(iwr%-UseBasicParsing)%' or commandline like '%Invoke-Maldoc%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe') and (commandline like '%[Net.ServicePointManager]::SecurityProtocol%=%[Net.SecurityProtocolType]::Tls12%' or commandline like '%IEX%(iwr%-UseBasicParsing)%' or commandline like '%Invoke-Maldoc%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe' or newprocessname like '%cmd.exe') and (commandline like '%[Net.ServicePointManager]::SecurityProtocol%=%[Net.SecurityProtocolType]::Tls12%' or commandline like '%IEX%(iwr%-UseBasicParsing)%' or commandline like '%Invoke-Maldoc%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like "%powershell.exe%" and commandline like "%Set-WebConfiguration%system.webServer%httpLogging%dontLog%$true%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like "%powershell.exe%" and commandline like "%Set-WebConfiguration%system.webServer%httpLogging%dontLog%$true%" | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like "%SoftwareMicrosoft%Windows Script%Settings%AmsiEnable%" or commandline like "%CurrentControlSet%Services%Amsi%" or commandline like "%Microsoft%Windows%CurrentVersion%Explorer%ShellServiceObjects%{B3C418EE-30F7-4E66-B436-725E99247AC5}%" or commandline like "%Microsoft%Windows Defender%" or commandline like "%SOFTWARE%Microsoft%AMSI%Providers%{2781761E-28E0-4109-99FE-B9D127C57AFE}%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like "%SoftwareMicrosoft%Windows Script%Settings%AmsiEnable%" or commandline like "%CurrentControlSet%Services%Amsi%" or commandline like "%Microsoft%Windows%CurrentVersion%Explorer%ShellServiceObjects%{B3C418EE-30F7-4E66-B436-725E99247AC5}%" or commandline like "%Microsoft%Windows Defender%" or commandline like "%SOFTWARE%Microsoft%AMSI%Providers%{2781761E-28E0-4109-99FE-B9D127C57AFE}%") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%powershell.exe%Start-Process%.bat%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%powershell.exe%Start-Process%.bat%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Microsoft%Windows%Defender%Features%TamperProtection%REG_DWORD%d%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Microsoft%Windows%Defender%Features%TamperProtection%REG_DWORD%d%" | groupby user, system

stream=authentication where sourcename='TRENDMICRO-EMAIL-SECURITY' AND action='LOGIN' | duration 1d | groupby user | limit 10

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wmic%node:% product where %"name like %" call uninstall' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wmic%node:% product where %"name like %" call uninstall' | groupby system, user

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%C:%Windows%Microsoft%.NET%Framework64%v4.0.30319%csc.exe%.exe%noconfig%fullpaths%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%C:%Windows%Microsoft%.NET%Framework64%v4.0.30319%csc.exe%.exe%noconfig%fullpaths%" | groupby user, system

stream=win-audit where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=win-audit where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") and user='{SuspectUser}' and host='{SuspectHost}' | duration 6m

stream=win-audit where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") and user='{SuspectUser}' and host='{SuspectHost}' | duration 6m

stream=ep-process where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (parentimage like '%powershell.exe' or parentimage like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (image like '%powershell.exe' or image like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%CurrentControlSet%Control%LSA%v%RunAsPPL%t%REG_DWORD%d%0%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%CurrentControlSet%Control%LSA%v%RunAsPPL%t%REG_DWORD%/d%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=DOCUMENTS | groupby user,srcip | duration 15m  | last 10

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload%SysmonDrv%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload%SysmonDrv%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe -Version%' or parentcommandline like '%powershell.exe -Version%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe -Version%' or parentcommandline like '%powershell.exe -Version%') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%MaxConnectionsPerServer%REG_DWORD%d%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%MaxConnectionsPerServer%REG_DWORD%d%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%AUOptions%REG_DWORD%d%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%AUOptions%REG_DWORD%d%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and newprocessname like '%powershell.exe' and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like '%cmd.exe%' and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%sc.exe%" or newprocessname like "%cmd.exe%") and (commandline like "%config WinDefend start=disabled%" or commandline like "%stop WinDefend%" or commandline like "%query WinDefend%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%sc.exe%" or newprocessname like "%cmd.exe%") and (commandline like "%config WinDefend start=disabled%" or commandline like "%stop WinDefend%" or commandline like "%query WinDefend%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Set-ItemProperty%SOFTWARE%Policies%Microsoft%Windows Defender%-Name%DisableAntiSpyware%-Value%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Set-ItemProperty%SOFTWARE%Policies%Microsoft%Windows Defender%-Name%DisableAntiSpyware%-Value%" | groupby user, system

stream=win-audit | duration 30d | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Set-ItemProperty%SOFTWARE%Policies%Microsoft%Windows Defender%-Name%DisableAntiSpyware%-Value%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%powershell.exe -Version%' or parentcommandline like '%powershell.exe -Version%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe -Version%' or parentcommandline like '%powershell.exe -Version%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=ep-process where action="PROCESS_ADDED" and commandline like "%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%MaxConnectionsPerServer%REG_DWORD%d%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process where action="PROCESS_ADDED" and commandline like "%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%MaxConnectionsPerServer%REG_DWORD%d%" | groupby user, system

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'(reg.*?delete|remove|set.*?itemproperty).*?(hklm|hkey_local_machine).*?software.*?amsi.*?provider') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'(reg.*?delete|remove|set.*?itemproperty).*?(hklm|hkey_local_machine).*?software.*?amsi.*?provider') | groupby user, system 

stream=win-audit where action="OBJECT_ACCESSED" and scriptblocktest like "%Set-MpPreference%-DisableRealtimeMonitoring%Set-MpPreference %DisableBehaviorMonitoring%Set-MpPreference%-DisableScriptScanning%Set-MpPreference%-DisableBlockAtFirstSeen%" | groupby user, system 

stream=win-audit where action="OBJECT_ACCESSED" and scriptblocktest like "%Set-MpPreference%-DisableRealtimeMonitoring%Set-MpPreference %DisableBehaviorMonitoring%Set-MpPreference%-DisableScriptScanning%Set-MpPreference%-DisableBlockAtFirstSeen%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="OBJECT_ACCESSED" and scriptblocktext like "%Set-MpPreference%-DisableRealtimeMonitoring%Set-MpPreference%DisableBehaviorMonitoring%Set-MpPreference%-DisableScriptScanning%Set-MpPreference%-DisableBlockAtFirstSeen%" | groupby user, system 

stream=win-audit where action="OBJECT_ACCESSED" and scriptblocktest like "%Set-MpPreference%-DisableRealtimeMonitoring%Set-MpPreference %DisableBehaviorMonitoring%Set-MpPreference%-DisableScriptScanning%Set-MpPreference%-DisableBlockAtFirstSeen%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%bcdedit.exe' and commandline like '%bcdedit%set%safeboot%network%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%bcdedit.exe' and commandline like '%bcdedit%set%safeboot%network%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and processname like '%bcdedit.exe' and commandline like '%bcdedit%set%safeboot%network%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname like '%bcdedit.exe' and commandline like '%bcdedit%set%safeboot%network%' | groupby user, system

stream=EP-REGISTRY where action="OBJECT_MODIFIED" and (image like "%gpg.exe" or image like "%gpg2.exe" or image like "%kleopatra.exe") | groupby user, system

stream=EP-REGISTRY where action="OBJECT_MODIFIED" and (image like "%gpg.exe" or image like "%gpg2.exe" or image like "%kleopatra.exe") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%powershell.exe%Start-Process%.bat%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%powershell.exe%Start-Process%.bat%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Microsoft%Windows%Defender%Features%TamperProtection%REG_DWORD%d%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Microsoft%Windows%Defender%Features%TamperProtection%REG_DWORD%d%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like '%powershell.exe%' and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and newprocessname like '%powershell.exe%' and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%AUOptions%REG_DWORD%d%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%AUOptions%REG_DWORD%d%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process, win-audit where action in('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(dsquery.*?filter.*?objectclass=trusteddomain|nltest.*?(domain_trusts|trusted_domains))") | groupby user, system 

stream=ep-process, win-audit where action in('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(dsquery.*?filter.*?objectclass=trusteddomain|nltest.*?(domain_trusts|trusted_domains))")  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=windows-event where eid = '39' and user is not null | duration 10d |  groupby user , @Subject 

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Set-ItemProperty%SOFTWARE%Policies%Microsoft%Windows Defender%-Name%DisableAntiSpyware%-Value%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Set-ItemProperty%SOFTWARE%Policies%Microsoft%Windows Defender%-Name%DisableAntiSpyware%-Value%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Set-ItemProperty%SOFTWARE%Policies%Microsoft%Windows Defender%-Name%DisableAntiSpyware%-Value%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Set-ItemProperty%SOFTWARE%Policies%Microsoft%Windows Defender%-Name%DisableAntiSpyware%-Value%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Microsoft%Windows%Defender%Features%TamperProtection%REG_DWORD%d%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Microsoft%Windows%Defender%Features%TamperProtection%REG_DWORD%d%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%DoNotConnectToWindowsUpdateInternetLocations%REG_DWORD%d%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%DoNotConnectToWindowsUpdateInternetLocations%REG_DWORD%d%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%AUOptions%REG_DWORD%d%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%AUOptions%REG_DWORD%d%" | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like "%sc.exe delete sysmon%%reg delete%%sysmon%"  or commandline like "%sc.exe delete sysmon%Remove-Item%sysmon%" or commandline like "%sc.exe delete sysmon%sysmon -u%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like "%sc.exe delete sysmon%%reg delete%%sysmon%"  or commandline like "%sc.exe delete sysmon%Remove-Item%sysmon%" or commandline like "%sc.exe delete sysmon%sysmon -u%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%sc.exe%" or newprocessname like "%cmd.exe%") and (commandline like "%config WinDefend start=disabled%" or commandline like "%stop WinDefend%" or commandline like "%query WinDefend%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit | duration 30d | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Set-ItemProperty%SOFTWARE%Policies%Microsoft%Windows Defender%-Name%DisableAntiSpyware%-Value%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Set-ItemProperty%SOFTWARE%Policies%Microsoft%Windows Defender%-Name%DisableAntiSpyware%-Value%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Set-ItemProperty%SOFTWARE%Policies%Microsoft%Windows Defender%-Name%DisableAntiSpyware%-Value%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Set-ItemProperty%SOFTWARE%Policies%Microsoft%Windows Defender%-Name%DisableAntiSpyware%-Value%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like '%cmd.exe%' and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like "%schtasks.exe%" and commandline like "%schtasks%query%Windows Defender%"| groupby system, user

stream=win-audit where action="PROCESS_CREATED" and newprocessname like "%schtasks.exe%" and commandline like "%schtasks%query%Windows Defender%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname='wmic.exe' and commandline like '%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname='wmic.exe' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and image like 'wmic.exe' and commandline like '%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' |  groupby user, system

stream=ep-process where action='PROCESS_ADDED' and image like 'wmic.exe' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and image like '%wmic.exe' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and image like '%wmic.exe' and commandline like '%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' |  groupby user, system

stream=ep-process where action="PROCESS_ADDED" and newprocessname like '%cmd.exe%' and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like '%powershell.exe%' and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and newprocessname like '%powershell.exe%' and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and newprocessname like '%powershell.exe%' and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and newprocessname like '%powershell.exe%' and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="OBJECT_ACCESSED" and newprocessname like '%cmd.exe%' and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="OBJECT_ACCESSED" and newprocessname like '%cmd.exe%' and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") and user='{SuspectUser}' | groupby user, system

stream=ep-process, win-audit where action in('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(dsquery.*?filter.*?objectclass=trusteddomain|nltest.*?(domain_trusts|trusted_domains))") | groupby user, system 

stream=ep-process, win-audit where action in('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(dsquery.*?filter.*?objectclass=trusteddomain|nltest.*?(domain_trusts|trusted_domains))")  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname like 'bcdedit.exe' and commandline like '%bcdedit%set%safeboot%network%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname like 'bcdedit.exe' and commandline like '%bcdedit%set%safeboot%network%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%bcdedit.exe' and commandline like '%bcdedit%set%safeboot%network%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%bcdedit.exe' and commandline like '%bcdedit%set%safeboot%network%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%wmic.exe' and commandline like '%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%wmic.exe' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionPath=%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where action="OBJECT_ACCESSED" and newprocessname like '%cmd.exe%' and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="OBJECT_ACCESSED" and newprocessname like '%cmd.exe%' and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (lower(scriptblocktext) like '%system.management.automation.amsi%amsiinitfailed%' or lower(scriptblocktext) like '%system.management.automation.amsi%scancontent%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsicontext%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsisession%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsiutils.init()%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsiscanbuffer%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsi.dll%') | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (lower(scriptblocktext) like '%system.management.automation.amsi%amsiinitfailed%' or lower(scriptblocktext) like '%system.management.automation.amsi%scancontent%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsicontext%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsisession%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsiutils.init()%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsiscanbuffer%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsi.dll%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-REGISTRY  where action="OBJECT_MODIFIED" and (image like "%gpg.exe" or image like "%gpg2.exe" or image like "%kleopatra.exe") | groupby user, system

stream=EP-REGISTRY  where action="OBJECT_MODIFIED" and (image like "%gpg.exe" or image like "%gpg2.exe" or image like "%kleopatra.exe") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=firewall | groupby dstip,srcip,action | having count_col1>1000 | duration 5h  | last 10

stream=firewall | duration 5h | groupby dstip,srcip,action

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%sc.exe%" or newprocessname like "%cmd.exe%") and (commandline like "%config WinDefend start=disabled%" or commandline like "%stop WinDefend%" or commandline like "%query WinDefend%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%sc.exe%" or newprocessname like "%cmd.exe%") and (commandline like "%config WinDefend start=disabled%" or commandline like "%stop WinDefend%" or commandline like "%query WinDefend%") | groupby user, system

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and (image like '%%AppData%%Temp%' or image like '%%AppData%%Roaming%') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\policies\\\\system.*?DisableRegistryTools") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\policies\\\\system.*?DisableRegistryTools") | groupby user, system

stream=* | groupby pstatus, devsrcip 

stream=authentication | having count_col1>1000 | groupby user,srcip,action | duration 15m  | last 10

stream=win-audit where action="OBJECT_ACCESSED" and (scriptblocktext like "%Set-MpPreference%-DisableRealtimeMonitoring%Set-MpPreference %DisableBehaviorMonitoring%Set-MpPreference%-DisableScriptScanning%Set-MpPreference%-DisableBlockAtFirstSeen%" or scriptblocktext like '%Add-MpPreference%-DisableRealtimeMonitoring%Add-MpPreference %DisableBehaviorMonitoring%Add-MpPreference%-DisableScriptScanning%Add-MpPreference%-DisableBlockAtFirstSeen%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="OBJECT_ACCESSED" and (scriptblocktext like "%Set-MpPreference%-DisableRealtimeMonitoring%Set-MpPreference %DisableBehaviorMonitoring%Set-MpPreference%-DisableScriptScanning%Set-MpPreference%-DisableBlockAtFirstSeen%" or scriptblocktext like '%Add-MpPreference%-DisableRealtimeMonitoring%Add-MpPreference %DisableBehaviorMonitoring%Add-MpPreference%-DisableScriptScanning%Add-MpPreference%-DisableBlockAtFirstSeen%') | groupby user, system 

stream=arcos-evt

stream=hypercloud

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableTaskmgr") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableTaskmgr") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableNotificationCenter") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableNotificationCenter") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%system.management.automation.amsi%amsiinitfailed%' or lower(commandline) like '%system.management.automation.amsi%scancontent%' or lower(commandline) like '%system.management.automation.amsi%amsicontext%' or lower(commandline) like '%system.management.automation.amsi%amsisession%' or lower(commandline) like '%system.management.automation.amsi%amsiutils.init()%' or lower(commandline) like '%system.management.automation.amsi%amsiscanbuffer%' or lower(commandline) like '%system.management.automation.amsi%amsi.dll%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%system.management.automation.amsi%amsiinitfailed%' or lower(commandline) like '%system.management.automation.amsi%scancontent%' or lower(commandline) like '%system.management.automation.amsi%amsicontext%' or lower(commandline) like '%system.management.automation.amsi%amsisession%' or lower(commandline) like '%system.management.automation.amsi%amsiutils.init()%' or lower(commandline) like '%system.management.automation.amsi%amsiscanbuffer%' or lower(commandline) like '%system.management.automation.amsi%amsi.dll%') | groupby user, system

stream=EP-REGISTRY where (image like "%gpg.exe" or image like "%gpg2.exe" or image like "%kleopatra.exe") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-REGISTRY where (image like "%gpg.exe" or image like "%gpg2.exe" or image like "%kleopatra.exe") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%sc.exe%" or newprocessname like "%cmd.exe%") and (commandline like "%config WinDefend start=disabled%" or commandline like "%stop WinDefend%" or commandline like "%query WinDefend%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%sc.exe%" or newprocessname like "%cmd.exe%") and (commandline like "%config WinDefend start=disabled%" or commandline like "%stop WinDefend%" or commandline like "%query WinDefend%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%reg%add%HKCU%" or commandline like "%reg%import%HKCU%" or commandline like "%reg%export%HKCU%") |  groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%PUAProtection%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%DisableAntiSpyware%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%Features%TamperProtection%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%Real-Time Protection%DisableRealtimeMonitoring%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%Real-Time Protection%DisableIntrusionPreventionSystem%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%Real-Time Protection%DisableScriptScanning%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%Windows Defender Exploit Guard%Controlled Folder Access%EnableControlledFolderAccess%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%Real-Time Protection%DisableIOAVProtection%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%Reporting%DisableEnhancedNotifications%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%SpyNet%DisableBlockAtFirstSeen%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%SpyNet%SpynetReporting%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%SpyNet%SubmitSamplesConsent%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%Real-Time Protection%DisableBehaviorMonitoring%') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%PUAProtection%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%DisableAntiSpyware%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%Features%TamperProtection%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%Real-Time Protection%DisableRealtimeMonitoring%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%Real-Time Protection%DisableIntrusionPreventionSystem%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%Real-Time Protection%DisableScriptScanning%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%Windows Defender Exploit Guard%Controlled Folder Access%EnableControlledFolderAccess%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%Real-Time Protection%DisableIOAVProtection%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%Reporting%DisableEnhancedNotifications%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%SpyNet%DisableBlockAtFirstSeen%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%SpyNet%SpynetReporting%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%SpyNet%SubmitSamplesConsent%' or commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%Real-Time Protection%DisableBehaviorMonitoring%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and (lower(scriptblocktext) like '%system.management.automation.amsi%amsiinitfailed%' or lower(scriptblocktext) like '%system.management.automation.amsi%scancontent%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsicontext%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsisession%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsiutils.init()%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsiscanbuffer%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsi.dll%') | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (lower(scriptblocktext) like '%system.management.automation.amsi%amsiinitfailed%' or lower(scriptblocktext) like '%system.management.automation.amsi%scancontent%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsicontext%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsisession%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsiutils.init()%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsiscanbuffer%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsi.dll%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?shutdownwithoutlogon") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?shutdownwithoutlogon") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=authentication | groupby user,srcip,action | having count_col1>1000 | duration 15m  | last 10

stream=firewall | duration 3h | groupby dstip,srcip,action

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and targetobject like '%HKCU%Software%Microsoft%Windows%CurrentVersion%Run' | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and parentprocessname='cmd.exe' and commandline like '%reg%' | groupby user, system

stream=hypercloud

stream=hypercloud

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\policies\\\\system.*?DisableRegistryTools") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\policies\\\\system.*?DisableRegistryTools") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableCMD") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\.exe|reg\.exe|gpedit\.msc|cmd\.exe).*?DisableCMD") and user='{SuspectUser}' and system='{SuspectHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like '%cmd.exe' and (commandline like 'reg%add%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like 'reg%delete%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or Commandline like '%New-ItemProperty%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') | groupby user, system 

stream=win-audit where action="PROCESS_CREATED" and newprocessname like '%cmd.exe' and (commandline like 'reg add' or commandline like 'reg delete' or commandline like 'New-ItemProperty' or Commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoRun%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoRun%REG_DWORD%d%1%" | groupby user, system

stream=* |  groupby stream, sourcename |  duration 15m

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%reg add%HKCU%" or commandline like "%reg import%HKCU%" or commandline like "%reg export%HKCU%") |  groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%system.management.automation.amsi%amsiinitfailed%' or lower(commandline) like '%system.management.automation.amsi%scancontent%' or lower(commandline) like '%system.management.automation.amsi%amsicontext%' or lower(commandline) like '%system.management.automation.amsi%amsisession%' or lower(commandline) like '%system.management.automation.amsi%amsiutils.init()%' or lower(commandline) like '%system.management.automation.amsi%amsiscanbuffer%' or lower(commandline) like '%system.management.automation.amsi%amsi.dll%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%system.management.automation.amsi%amsiinitfailed%' or lower(commandline) like '%system.management.automation.amsi%scancontent%' or lower(commandline) like '%system.management.automation.amsi%amsicontext%' or lower(commandline) like '%system.management.automation.amsi%amsisession%' or lower(commandline) like '%system.management.automation.amsi%amsiutils.init()%' or lower(commandline) like '%system.management.automation.amsi%amsiscanbuffer%' or lower(commandline) like '%system.management.automation.amsi%amsi.dll%') | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableTaskmgr") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableTaskmgr") | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and processname like '%cmd.exe' and (commandline like 'reg add' or commandline like 'reg delete' or commandline like 'New-ItemProperty' or Commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname like '%cmd.exe' and (commandline like 'reg%add%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like 'reg%delete%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or Commandline like '%New-ItemProperty%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') | groupby user, system 

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableCMD") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableCMD") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableTaskmgr") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableTaskmgr") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableNotificationCenter") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableNotificationCenter") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg.*?\\.exe|gpedit\\.msc|cmd\\.exe).*?(DisableLockWorkstation).*?\/d\s1") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg.*?\\.exe|gpedit\\.msc|cmd\\.exe).*?(DisableLockWorkstation).*?\/d\s1") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname='%AdvancedRun.exe' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname='%AdvancedRun.exe%' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableCMD") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableCMD") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableTaskmgr") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableTaskmgr") and user='{SuspectUser}' and system='{TargetSystem}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?shutdownwithoutlogon") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?shutdownwithoutlogon") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?(StartMenuLogOff|onlogoff)") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?(StartMenuLogOff|onlogoff)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and hosttype='windows' and (registrypath like '%SOFTWARE%Microsoft%Office%Security%AccessVBOM%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%VbaWarnings%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableInternetFilesInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableUnsafeLocationsInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableAttachementsInPV%') and registrydatastrings in ('0x00000001', '1') and (processname like '%cscript.exe%' or processname like '%wscript.exe%' or processname like '%mshta.exe%' or processname like '%winword.exe%' or processname like '%excel.exe%') | groupby user, system

stream=ep-registry where action='OBJECT_MODIFIED' and hosttype='windows' and (registrypath like '%SOFTWARE%Microsoft%Office%Security%AccessVBOM%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%VbaWarnings%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableInternetFilesInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableUnsafeLocationsInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableAttachementsInPV%') and registrydatastrings in ('0x00000001', '1') and (processname like '%cscript.exe%' or processname like '%wscript.exe%' or processname like '%mshta.exe%' or processname like '%winword.exe%' or processname like '%excel.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableCMD") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableCMD") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableTaskmgr") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?DisableTaskmgr") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname='dism.exe' or commandline='dism.exe') and (commandline like '%online%' or commandline like '%Disable-Feature%' or commandline like '%Featurename:Windows-Defender%' or commandline like '%Remove%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname='dism.exe' or commandline='dism.exe') and (commandline like '%online%' or commandline like '%Disable-Feature%' or commandline like '%Featurename:Windows-Defender%' or commandline like '%Remove%') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\\.exe|reg.*?\\.exe|gpedit\\.msc|cmd\\.exe).*?(DisableLockWorkstation).*?\/d\s1") and user='{SuspectUser}' and system='{TargetHsot}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "(powershell\\.exe|reg.*?\\.exe|gpedit\\.msc|cmd\\.exe).*?(DisableLockWorkstation).*?\/d\s1") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%UX Configuration%Notification_Suppress%REG_DWORD%1' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%UX Configuration%Notification_Suppress%REG_DWORD%1' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?(StartMenuLogOff|onlogoff)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and rlike(commandline, "(powershell\\.exe|reg\\.exe|gpedit\\.msc|cmd\\.exe).*?(StartMenuLogOff|onlogoff)") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (newprocessname='dism.exe' or commandline='dism.exe') and (commandline like '%online%' or commandline like '%Disable-Feature%' or commandline like '%Featurename:Windows-Defender%' or commandline like '%Remove%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname='dism.exe' or commandline='dism.exe') and (commandline like '%online%' or commandline like '%Disable-Feature%' or commandline like '%Featurename:Windows-Defender%' or commandline like '%Remove%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (newprocessname='dism.exe' or commandline='dism.exe') and (commandline like '%online%' or commandline like '%Disable-Feature%' or commandline like '%Featurename:Windows-Defender%' or commandline like '%Remove%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname='dism.exe' or commandline='dism.exe') and (commandline like '%online%' or commandline like '%Disable-Feature%' or commandline like '%Featurename:Windows-Defender%' or commandline like '%Remove%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (newprocessname='dism.exe' or newprocessname='Dism.exe' or commandline='dism.exe') and (commandline like '%online%' or commandline like '%Disable-Feature%' or commandline like '%Featurename:Windows-Defender%' or commandline like '%Remove%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname='dism.exe' or newprocessname='Dism.exe' or commandline='dism.exe') and (commandline like '%online%' or commandline like '%Disable-Feature%' or commandline like '%Featurename:Windows-Defender%' or commandline like '%Remove%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and processname='%AdvancedRun.exe%' and (command like '%AdvancedRun.exe%' or command like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname='%AdvancedRun.exe' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like '%Execute%' or commandline like '%EXEFilename%' or commandline like '%cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (parentimage like '%netsh.exe%' or parentimage like '%powershell.exe%' or parentimage like '%cmd.exe%') and (commandline like 'netsh%advfirewall%set%currentprofile%state%off%' or commandline like '%powershell.exe%Command%Disable-NetFirewallRule%All%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (parentimage like '%netsh.exe%' or parentimage like '%powershell.exe%' or parentimage like '%cmd.exe%') and (commandline like 'netsh%advfirewall%set%currentprofile%state%off%' or commandline like '%powershell.exe%Command%Disable-NetFirewallRule%All%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (newprocessname like '%netsh.exe%' or newprocessname like '%powershell.exe%' or newprocessname like '%cmd.exe%') and (commandline like 'netsh%advfirewall%set%currentprofile%state%off%' or commandline like '%powershell.exe%Command%Disable-NetFirewallRule%All%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (newprocessname like '%netsh.exe%' or newprocessname like '%powershell.exe%' or newprocessname like '%cmd.exe%') and (commandline like 'netsh%advfirewall%set%currentprofile%state%off%' or commandline like '%powershell.exe%Command%Disable-NetFirewallRule%All%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like '%cmd.exe' and (commandline like 'reg%add%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like 'reg%delete%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or Commandline like '%New-ItemProperty%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') | groupby user, system 

stream=win-audit where action="PROCESS_CREATED" and (commandline like 'reg add' or commandline like 'reg delete' or commandline like 'New-ItemProperty' or Commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname like '%powershell.exe' and (commandline like 'reg%add%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like 'reg%delete%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or Commandline like '%New-ItemProperty%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and processname like '%powershell.exe' and (commandline like 'reg%add%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like 'reg%delete%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or Commandline like '%New-ItemProperty%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like '%powershell.exe' and (commandline like 'reg%add%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like 'reg%delete%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or Commandline like '%New-ItemProperty%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like '%powershell.exe' and (commandline like 'reg%add%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like 'reg%delete%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or Commandline like '%New-ItemProperty%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg%add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and processname in ('cmd.exe', 'powershell.exe') and commandline like '%reg%add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (image like '%netsh.exe%' or image like '%powershell.exe%' or image like '%cmd.exe%') and (commandline like 'netsh%advfirewall%set%currentprofile%state%off%' or commandline like '%powershell.exe%Command%Disable-NetFirewallRule%All%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (image like '%netsh.exe%' or image like '%powershell.exe%' or image like '%cmd.exe%') and (commandline like 'netsh%advfirewall%set%currentprofile%state%off%' or commandline like '%powershell.exe%Command%Disable-NetFirewallRule%All%') | groupby user, system

stream=win-audit where action="PROCES_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action="PROCES_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=ep-registry where action='OBJECT_MODIFIED' and hosttype='windows' and (registrypath like '%SOFTWARE%Microsoft%Office%Security%AccessVBOM%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%VbaWarnings%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableInternetFilesInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableUnsafeLocationsInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableAttachementsInPV%') and registrydatastrings in ('0x00000001', '1') and (processname like '%cscript.exe%' or processname like '%wscript.exe%' or processname like '%mshta.exe%' or processname like '%winword.exe%' or processname like '%excel.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and hosttype='windows' and (registrypath like '%SOFTWARE%Microsoft%Office%Security%AccessVBOM%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%VbaWarnings%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableInternetFilesInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableUnsafeLocationsInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableAttachementsInPV%') and registrydatastrings in ('0x00000001', '1') and (processname like '%cscript.exe%' or processname like '%wscript.exe%' or processname like '%mshta.exe%' or processname like '%winword.exe%' or processname like '%excel.exe%') | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=ep-process | duration 30d | groupby user, system

stream=win-audit where action="PROCES_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}'

stream=win-audit where action="PROCES_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}'

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoRun%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoRun%REG_DWORD%d%1%" | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%WOW6432Node%Microsoft%Windows%CurrentVersion%ImmersiveShell%UseActionCenterExperience%REG_DWORD%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%WOW6432Node%Microsoft%Windows%CurrentVersion%ImmersiveShell%UseActionCenterExperience%REG_DWORD%0%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%WOW6432Node%Microsoft%Windows%CurrentVersion%ImmersiveShell%UseActionCenterExperience%REG_DWORD%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%WOW6432Node%Microsoft%Windows%CurrentVersion%ImmersiveShell%UseActionCenterExperience%REG_DWORD%0%' | groupby user, system

stream=ep-registry where action='OBJECT_MODIFIED' and hosttype='windows' and (registrypath like '%SOFTWARE%Microsoft%Office%Security%AccessVBOM%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%VbaWarnings%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableInternetFilesInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableUnsafeLocationsInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableAttachementsInPV%') and registrydatastrings in ('0x00000001', '1') and (processname like '%cscript.exe%' or processname like '%wscript.exe%' or processname like '%mshta.exe%' or processname like '%winword.exe%' or processname like '%excel.exe%') | groupby user, system

stream=ep-registry where action='OBJECT_MODIFIED' and hosttype='windows' and (registrypath like '%SOFTWARE%Microsoft%Office%Security%AccessVBOM%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%VbaWarnings%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableInternetFilesInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableUnsafeLocationsInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableAttachementsInPV%') and registrydatastrings in ('0x00000001', '1') and (processname like '%cscript.exe%' or processname like '%wscript.exe%' or processname like '%mshta.exe%' or processname like '%winword.exe%' or processname like '%excel.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and hosttype='windows' and (registrypath like '%SOFTWARE%Microsoft%Office%Security%AccessVBOM%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%VbaWarnings%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableInternetFilesInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableUnsafeLocationsInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableAttachementsInPV%') and (registrydatastrings like '0x00000001' or registrydatastrings like '1') and (processname like '%cscript.exe%' or processname like '%wscript.exe%' or processname like '%mshta.exe%' or processname like '%winword.exe%' or processname like '%excel.exe%') | groupby user, system

stream=ep-registry where action='OBJECT_MODIFIED' and hosttype='windows' and (registrypath like '%SOFTWARE%Microsoft%Office%Security%AccessVBOM%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%VbaWarnings%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableInternetFilesInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableUnsafeLocationsInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableAttachementsInPV%') and (registrydatastrings like '0x00000001' or registrydatastrings like '1') and (processname like '%cscript.exe%' or processname like '%wscript.exe%' or processname like '%mshta.exe%' or processname like '%winword.exe%' or processname like '%excel.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoDesktop%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoDesktop%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Network%REG_SZ%F%D%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Network%REG_SZ%F%D%' | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%UX Configuration%Notification_Suppress%REG_DWORD%1' | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%UX Configuration%Notification_Suppress%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%wmic process list%FORMAT:%wmicscript.xsl%' or commandline like '%wmic os get%FORMAT:%https%xsl') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%wmic process list%FORMAT:%wmicscript.xsl%' or commandline like '%wmic os get%FORMAT:%https%xsl') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAHealth%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAHealth%REG_DWORD%/d%1%' | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoControlPanel%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process | duration 30d | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoRun%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoRun%REG_DWORD%d%1%" | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Software%Policies%Microsoft%Windows%PowerShell%EnableModuleLogging%REG_DWORD%d%0%' or commandline like '%Software%Policies%Microsoft%Windows%PowerShell%EnableScriptBlockLogging%REG_DWORD%d%0%' or commandline like '%Software%Policies%Microsoft%Windows%PowerShell%EnableTranscripting%REG_DWORD%d%0%' or commandline like '%Software%Policies%Microsoft%Windows%PowerShell%EnableScripts%REG_DWORD%d%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Software%Policies%Microsoft%Windows%PowerShell%EnableModuleLogging%REG_DWORD%d%0%' or commandline like '%Software%Policies%Microsoft%Windows%PowerShell%EnableScriptBlockLogging%REG_DWORD%d%0%' or commandline like '%Software%Policies%Microsoft%Windows%PowerShell%EnableTranscripting%REG_DWORD%d%0%' or commandline like '%Software%Policies%Microsoft%Windows%PowerShell%EnableScripts%REG_DWORD%d%0%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%F%D%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%F%D%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%F%D%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Minimal%REG_SZ%F%D%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%PushNotifications%ToastEnabled%REG_DWORD%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%PushNotifications%ToastEnabled%REG_DWORD%0%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%PushNotifications%ToastEnabled%REG_DWORD%0%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%PushNotifications%ToastEnabled%REG_DWORD%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-REGISTRY where action="OBJECT_MODIFIED" and rlike(lower(targetobject),'(hklm|hkey_local_machine).*?software.*?amsi.*?provider') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-REGISTRY where action="OBJECT_MODIFIED" and rlike(lower(targetobject),'(hklm|hkey_local_machine).*?software.*?amsi.*?provider') | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action="PROCES_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duation 6m

stream=win-audit where action="PROCES_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoControlPanel%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoControlPanel%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCANetwork%REG_DWORD%/d%1' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and processname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCANetwork%REG_DWORD%/d%1' | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFind%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFind%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFind%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFind%REG_DWORD%d%1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoDesktop%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoDesktop%REG_DWORD%d%1%" | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like "%Win32_ShadowCopy%Delete%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%UX Configuration%Notification_Suppress%REG_DWORD%1%' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%UX Configuration%Notification_Suppress%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%System%CurrentControlSet%Control%Terminal Server%fAllowToGetHelp%REG_DWORD%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%System%CurrentControlSet%Control%Terminal Server%fAllowToGetHelp%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%system%currentcontrolset%control%lsa%DisableRestrictedAdmin%REG_DWORD%0%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%system%currentcontrolset%control%lsa%DisableRestrictedAdmin%REG_DWORD%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=ep-process where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAHealth%REG_DWORD%/d%1%' | groupby user, system

stream=ep-process where action='PROCESS_CREATED' and processname like '%reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAHealth%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action="PROCES_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duation 6m

stream=win-audit where action="PROCES_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFind%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFind%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Policies%Microsoft%Windows%PowerShell%EnableModuleLogging%REG_DWORD%d%0%' or commandline like '%Software%Policies%Microsoft%Windows%PowerShell%EnableScriptBlockLogging%REG_DWORD%d%0%' or commandline like '%Software%Policies%Microsoft%Windows%PowerShell%EnableTranscripting%REG_DWORD%d%0%' or commandline like '%Software%Policies%Microsoft%Windows%PowerShell%EnableScripts%REG_DWORD%d%0%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Policies%Microsoft%Windows%PowerShell%EnableModuleLogging%REG_DWORD%d%0%' or commandline like '%Software%Policies%Microsoft%Windows%PowerShell%EnableScriptBlockLogging%REG_DWORD%d%0%' or commandline like '%Software%Policies%Microsoft%Windows%PowerShell%EnableTranscripting%REG_DWORD%d%0%' or commandline like '%Software%Policies%Microsoft%Windows%PowerShell%EnableScripts%REG_DWORD%d%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoDesktop%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoDesktop%REG_DWORD%d%1%" | groupby user, system

stream=ep-process where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Network%REG_SZ%F%D%' | groupby user, system

stream=ep-process where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%SafeBoot%Network%REG_SZ%F%D%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%WOW6432Node%Microsoft%Windows%CurrentVersion%ImmersiveShell%UseActionCenterExperience%REG_DWORD%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%WOW6432Node%Microsoft%Windows%CurrentVersion%ImmersiveShell%UseActionCenterExperience%REG_DWORD%0%' | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (image like "%powershell.exe%" or image like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=CONFIGURATION where action='CONFIGURATION_CHANGED' and config='Service Stopped' and @winlog.event_data.param1='Volume Shadow Copy' | groupby user

stream=win-audit where action='OBJECT_ACCESSED' and event='Creating Scriptblock text' and scriptblocktext like '%$Action%=%New-ScheduledTaskAction%-Execute%\"calc.exe\"%$Trigger%=%New-ScheduledTaskTrigger%-AtLogon%$User%=%New-ScheduledTaskPrincipal%-GroupId%"BUILTIN%Administrators"%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet%$object$=$New-ScheduledTask%-Action%$Action%-Principal%$User$-Trigger%$Trigger%-Settings%$Set%Register-ScheduledTask%AtomicTask%-InputObject%$object%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and event='Creating Scriptblock text' and scriptblocktext like '%$Action%=%New-ScheduledTaskAction%-Execute%\"calc.exe\"%$Trigger%=%New-ScheduledTaskTrigger%-AtLogon%$User%=%New-ScheduledTaskPrincipal%-GroupId%"BUILTIN%Administrators"%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet%$object$=$New-ScheduledTask%-Action%$Action%-Principal%$User$-Trigger%$Trigger%-Settings%$Set%Register-ScheduledTask%AtomicTask%-InputObject%$object%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname='schtasks.exe' and commandline like '%create%xml%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname='schtasks.exe' and commandline like '%create%xml%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname='wmic.exe' and commandline like '%Namespace%root%Microsoft%Windows%Defender%call%ExclusionProcess%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and newprocessname='wmic.exe' and commandline like '%Namespace%root%Microsoft%Windows%Defender%call%ExclusionProcess%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%UX Configuration%Notification_Suppress%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action="PROCESS_CREATED" and commandline like '%SOFTWARE%Policies%Microsoft%Windows Defender%UX Configuration%Notification_Suppress%REG_DWORD%1%' | groupby user, system

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%mavinject%INJECTRUNNING%' or scriptblocktext like '%mavinject%hmodule=0x%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%mavinject%INJECTRUNNING%' or scriptblocktext like '%mavinject%hmodule=0x%') | groupby user, system

stream=signals

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoControlPanel%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoControlPanel%REG_DWORD%d%1%" | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and parentimage in ('powershell.exe','cmd.exe') and parentcommandline like '%netsh%portproxy%v4tov4%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and parentimage in ('powershell.exe','cmd.exe') and parentcommandline like '%netsh%portproxy%v4tov4%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and scriptblocktext like '%netsh%portproxy%v4tov4%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and scriptblocktext like '%netsh%portproxy%v4tov4%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname='schtasks.exe' and commandline like '%create%xml%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname='schtasks.exe' and commandline like '%create%xml%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname='schtasks.exe' and commandline like '%create%xml%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname='schtasks.exe' and commandline like '%create%xml%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname='schtasks.exe' and commandline like '%create%xml%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=* | select user as system | duration 2d | limit 1

stream=ep-process where action='PROCESS_ADDED' and processname='schtasks.exe' and commandline like '%create%xml%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and processname='schtasks.exe' and commandline like '%create%xml%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and image like '%wmic.exe' and commandline like '%Namespace%root%Microsoft%Windows%Defender%call%ExclusionExtension%' |  groupby user, system

stream=ep-process where action='PROCESS_ADDED' and image like '%wmic.exe' and commandline like '%Namespace%root%Microsoft%Windows%Defender%call%ExclusionExtension%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=win-audit where action="PROCESS_CREATED" and commandline like '%System%CurrentControlSet%Control%Terminal Server%fAllowToGetHelp%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action="PROCESS_CREATED" and commandline like '%System%CurrentControlSet%Control%Terminal Server%fAllowToGetHelp%REG_DWORD%1%' | groupby user, system

stream=win-audit where action="PROCES_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action="PROCES_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duation 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows Defender%Reporting%DisableEnhancedNotifications%REG_DWORD%d 1%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows Defender%Reporting%DisableEnhancedNotifications%REG_DWORD%d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoControlPanel%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoControlPanel%REG_DWORD%d%1%" | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname in ('powershell.exe','cmd.exe') and commandline like '%netsh%portproxy%v4tov4%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname in ('powershell.exe','cmd.exe') and commandline like '%netsh%portproxy%v4tov4%' | groupby user, system

stream=configuration,win-audit,ep-process where action in  ('PROCESS_CREATED', 'PROCESS_ADDED', 'CONFIGURATION_CHANGED') and ( rlike(lower(commandline),"set\-mppreference.*?(disablerealtimemonitoring|disablebehaviormonitoring|disableblockatfirstseen|disablescriptscanning|drtm|dbm|dscrptsc|dbaf).*?(true|1)") or rlike(lower(commandline),"set\-mppreference.*?(mapsreporting|puaprotection|submitsamplesconsent).*?(0|false|2)") or rlike(lower(commandline), "(disable-mpamservice|disable-mpsignatureupdate|uninstall-mpwdoscan)")) and system='{TargetHost}' | duration 6m

stream=configuration,win-audit,ep-process where action in  ('PROCESS_CREATED', 'PROCESS_ADDED', 'CONFIGURATION_CHANGED') and ( rlike(lower(commandline),"set\-mppreference.*?(disablerealtimemonitoring|disablebehaviormonitoring|disableblockatfirstseen|disablescriptscanning|drtm|dbm|dscrptsc|dbaf).*?(true|1)") or rlike(lower(commandline),"set\-mppreference.*?(mapsreporting|puaprotection|submitsamplesconsent).*?(0|false|2)") or rlike(lower(commandline), "(disable-mpamservice|disable-mpsignatureupdate|uninstall-mpwdoscan)")) |  groupby system 

stream=ep-process where action="PROCESS_ADDED" and (commandline like "%Disable-WindowsOptionalFeature%-Online%-FeatureName%Windows-Defender%" or commandline like "%Disable-WindowsOptionalFeature%-FeatureName%Windows-Defender%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (commandline like "%Disable-WindowsOptionalFeature%-Online%-FeatureName%Windows-Defender%" or commandline like "%Disable-WindowsOptionalFeature%-FeatureName%Windows-Defender%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or scriptblocktext like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') | groupby user, system

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or scriptblocktext like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%wmic%shadowcopy%delete%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows Defender Security Center%Notifications%DisableNotifications%REG_DWORD%d 1%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows Defender Security Center%Notifications%DisableNotifications%REG_DWORD%d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoDesktop%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoDesktop%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoDesktop%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell.exe%" or newprocessname like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoDesktop%REG_DWORD%d%1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%NoAutoUpdate%REG_DWORD%d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%NoAutoUpdate%REG_DWORD%d 1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%NoAutoRebootWithLoggedOnUsers%REG_DWORD%d 1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%NoAutoRebootWithLoggedOnUsers%REG_DWORD%d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or scriptblocktext like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') | groupby user, system

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or scriptblocktext like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows Defender Security Center%Notifications%DisableNotifications%REG_DWORD%d 1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows Defender Security Center%Notifications%DisableNotifications%REG_DWORD%d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%AUOptions%REG_DWORD%d%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%AUOptions%REG_DWORD%d%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=* | select user as system | duration 2d | limit 1

stream=ep-process where action='PROCESS_ADDED' and processname='schtasks.exe' and commandline like '%create%xml%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?office test.*?special.*?perf') | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and image like '%cmd.exe%' and (commandline like "%reg%add%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or commandline like "%reg%delete%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or commandline like "%New%ItemProperty%%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and image like '%cmd.exe%' and (commandline like "%reg%add%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or commandline like "%reg%delete%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or commandline like "%New%ItemProperty%%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and newprocessname like '%cmd.exe%' and (commandline like "%reg%add%" or commandline like "%reg%delete%" or commandline like "%New%ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows%OOBE%" or commandline like "%DisablePrivacyExperience%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and newprocessname like '%cmd.exe%' and (commandline like "%reg%add%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or commandline like "%reg%delete%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or commandline like "%New%ItemProperty%%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and image like '%powershell.exe%' and (commandline like "%reg%add%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or commandline like "%reg%delete%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or commandline like "%New%ItemProperty%%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and image like '%powershell.exe%' and (commandline like "%reg%add%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or commandline like "%reg%delete%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or commandline like "%New%ItemProperty%%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFind%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFind%REG_DWORD%d%1%" | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' | groupby user, system

stream=win-audit where action="OBJECT_ACCESSED" and (scriptblocktext like "%cmd.exe%reg%add%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or scriptblocktext like "%cmd.exe%reg%delete%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or scriptblocktext like "%cmd.exe%New%ItemProperty%%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="OBJECT_ACCESSED" and (scriptblocktext like "%cmd.exe%reg%add%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or scriptblocktext like "%cmd.exe%reg%delete%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or scriptblocktext like "%cmd.exe%New%ItemProperty%%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%powershell.exe%Start-Process%.bat%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%powershell.exe%Start-Process%.bat%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%NoAutoUpdate%REG_DWORD%d 1%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%NoAutoUpdate%REG_DWORD%d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=CONFIGURATION where action='CONFIGURATION_CHANGED' and config='Service Stopped' | groupby user

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%NoAutoRebootWithLoggedOnUsers%REG_DWORD%d 1%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%NoAutoRebootWithLoggedOnUsers%REG_DWORD%d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%{$xml%=%[System.IO.File]::ReadAllText%Invoke-CimMethod%-ClassName%-NameSpace%-MethodName%RegisterByXml%-Arguments%@{%Force%=%$true;%Xml%=$xml%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like '%powershell.exe%' and (commandline like "%reg%add%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or commandline like "%reg%delete%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or commandline like "%New%ItemProperty%%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like '%powershell.exe%' and (commandline like "%reg%add%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or commandline like "%reg%delete%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or commandline like "%New%ItemProperty%%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%") | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname in ('netsh.exe','cmd.exe','powershell.exe') and (commandline like '%advfirewall firewall set rule group=%remote desktop%new enable=Yes%' or commandline like '%advfirewall firewall set rule group=%file and printer sharing%new enable=Yes%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname in ('netsh.exe','cmd.exe','powershell.exe') and (commandline like '%advfirewall firewall set rule group=%remote desktop%new enable=Yes%' or commandline like '%advfirewall firewall set rule group=%file and printer sharing%new enable=Yes%') | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%AUOptions%REG_DWORD%d%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows%WindowsUpdate%AU%AUOptions%REG_DWORD%d%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and image like '%powershell.exe%' and (commandline like "%reg%add%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or commandline like "%reg%delete%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or commandline like "%New%ItemProperty%%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and image like '%powershell.exe%' and (commandline like "%reg%add%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or commandline like "%reg%delete%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or commandline like "%New%ItemProperty%%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="OBJECT_ACCESSED" and (scriptblocktext like "%powershell.exe%reg%add%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or scriptblocktext like "%powershell.exe%reg%delete%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or scriptblocktext like "%powershell.exe%New%ItemProperty%%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%") | groupby user, system

stream=win-audit where action="OBJECT_ACCESSED" and (scriptblocktext like "%powershell.exe%reg%add%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or scriptblocktext like "%powershell.exe%reg%delete%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%" or scriptblocktext like "%powershell.exe%New%ItemProperty%%Software%Policies%Microsoft%Windows%OOBE%DisablePrivacyExperience%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (image like '%netsh.exe' or image like '%cmd.exe' or image like '%powershell.exe') and (commandline like '%advfirewall firewall set rule group=%remote desktop%new enable=Yes%' or commandline like '%advfirewall firewall set rule group=%file and printer sharing%new enable=Yes%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (image like '%netsh.exe' or image like '%cmd.exe' or image like '%powershell.exe') and (commandline like '%advfirewall firewall set rule group=%remote desktop%new enable=Yes%' or commandline like '%advfirewall firewall set rule group=%file and printer sharing%new enable=Yes%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname in ('cmd.exe','powershell.exe') and commandline like '%netsh%firewall%set%opmode%mode=disable%' |  groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname in ('cmd.exe','powershell.exe') and commandline like '%netsh%firewall%set%opmode%mode=disable%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (image like '%cmd.exe' or image like '%powershell.exe') and commandline like '%netsh%firewall%set%opmode%mode=disable%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (image like '%cmd.exe' or image like '%powershell.exe') and commandline like '%netsh%firewall%set%opmode%mode=disable%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%DomainProfile%EnableFirewall%REG_DWORD%d%0%' or commandline like '%reg%add%HKLM%SOFTWARE%Policies%Microsoft%WindowsFirewall%StandardProfile%EnableFirewall%REG_DWORD%d%0%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname='reg.exe' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%REG_DWORD%HideFileExt%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname='reg.exe' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%REG_DWORD%HideFileExt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe' and commandline like '%powershell.exe%Set-ExecutionPolicy%Bypass%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe' and commandline like '%powershell.exe%Set-ExecutionPolicy%Bypass%' | groupby user, system

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%System.IO.Compression.DeflateStream%FromBase64String%' or scriptblocktext like '%System.IO.Compression.GzipStream%FromBase64String%' or scriptblocktext like '%IO.Compression.DeflateStream%FromBase64String%' or scriptblocktext like '%IO.Compression.GzipStream%FromBase64String%') | groupby user, system

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%System.IO.Compression.DeflateStream%FromBase64String%' or scriptblocktext like '%System.IO.Compression.GzipStream%FromBase64String%' or scriptblocktext like '%IO.Compression.DeflateStream%FromBase64String%' or scriptblocktext like '%IO.Compression.GzipStream%FromBase64String%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=threat where file='{SuspectObject}' | duration 10d

stream=authentication | duration 3h | groupby srcip, user, subjectusername | having count_col1>3000 | last 10

stream=authentication where action="LOGIN" and status="FAILED" |  groupby user | having count_col1>500

stream=authentication where action="LOGIN"|  groupby srcip, system |  
select srcip, system , count_if(status="PASSED") as passed_count, count_if(status="FAILED") as fail_Count | 
having fail_Count > 50 and fail_Count > 5*passed_count

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|kerberos\\:\\:golden|kerberos\\:\\:tgt)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|kerberos\\:\\:golden|kerberos\\:\\:tgt)") | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%reg.exe' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%REG_DWORD%HideFileExt%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%reg.exe' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%REG_DWORD%HideFileExt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%<script>%' or scriptblocktext like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%.js%' or scriptblocktext like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%javascript:%') | groupby user, system

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and (scriptblocktext like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%<script>%' or scriptblocktext like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%.js%' or scriptblocktext like '%Software%Microsoft%Windows%CurrentVersion%Internet%Settings%javascript:%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname='powershell.exe' and commandline like '%powershell.exe%Set-ExecutionPolicy%Bypass%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname='powershell.exe' and commandline like '%powershell.exe%Set-ExecutionPolicy%Bypass%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%powershell.exe%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%System%LocalAccountTokenFilterPolicy%EnableLinkedConnections%SYSTEM%CurrentControlSet%Control%FileSystem%LongPathsEnabled%DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%powershell.exe%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%System%LocalAccountTokenFilterPolicy%EnableLinkedConnections%SYSTEM%CurrentControlSet%Control%FileSystem%LongPathsEnabled%DWORD%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%System.IO.Compression.DeflateStream%FromBase64String%' or commandline like '%System.IO.Compression.GzipStream%FromBase64String%' or commandline like '%IO.Compression.DeflateStream%FromBase64String%' or commandline like '%IO.Compression.GzipStream%FromBase64String%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%System.IO.Compression.DeflateStream%FromBase64String%' or commandline like '%System.IO.Compression.GzipStream%FromBase64String%' or commandline like '%IO.Compression.DeflateStream%FromBase64String%' or commandline like '%IO.Compression.GzipStream%FromBase64String%') | groupby user, system

stream=firewall | duration 3h | groupby dstip,srcip,action | having count_col1>500 | last 10

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|kerberos\\:\\:golden|kerberos\\:\\:tgt)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|kerberos\\:\\:golden|kerberos\\:\\:tgt)") | groupby user, system

stream=ep-process where parentimage='cmd.exe' and commandline like '%whoami%' and commandline like '%/all%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where parentimage='cmd.exe' and commandline like '%whoami%' and commandline like '%all%' | groupby user, system

stream=ep-process where parentimage='powershell.exe' and commandline like '%New-AzureADApplication%CertValue%' and system='{TaregtHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where parentimage='powershell.exe' and commandline like '%New-AzureADApplication%CertValue%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe' and commandline like '%HKEY_LOCAL_MACHINE%Software%Microsoft%Windows%CurrentVersion%Run%REG_EXPAND_SZ%SecurityHealth%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe' and commandline like '%HKEY_LOCAL_MACHINE%Software%Microsoft%Windows%CurrentVersion%Run%REG_EXPAND_SZ%SecurityHealth%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (image like '%powershell.exe' or image like '%pwsh.exe') and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Internet%Settings%ZoneMap%Domains%new-item%2%DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (image like '%powershell.exe' or image like '%pwsh.exe') and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Internet%Settings%ZoneMap%Domains%new-item%2%DWORD%' | groupby user, system

stream=authentication where action="LOGIN" and status="FAILED" |  groupby user | having count_col1>50

stream=authentication where action="LOGIN"|  groupby srcip, system |  
select srcip, system , count_if(status="PASSED") as passed_count, count_if(status="FAILED") as fail_Count | 
having fail_Count > 50 and fail_Count > 5*passed_count

stream=authentication where action="LOGIN"|  groupby srcip, system |  
select srcip, system , count_if(status="PASSED") as passed_count, count_if(status="FAILED") as fail_Count | 
having fail_Count > 50 and fail_Count > 5*passed_count

stream=AUTHENTICATION where action="LOGIN" and system ='{TargetHost}' and srcip ='{SuspectHost}'

stream=authentication where action="LOGIN"|  groupby srcip, system |  
select srcip, system , count_if(status="PASSED") as passed_count, count_if(status="FAILED") as fail_Count | 
having fail_Count > 50 and fail_Count > 5*passed_count

stream=AUTHENTICATION where action="LOGIN" and system ='{TargetHost}' and srcip ='{SuspectHost}'

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%Get-System.ps1%Get-System -Technique NamedPipe -Verbose%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%Get-System.ps1%Get-System -Technique NamedPipe -Verbose%" | groupby user, system

stream=ep_process where process='cmd.exe' and commandline like '%whoami%' and commandline like '%/all%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep_process where process='cmd.exe' and commandline like '%whoami%' and commandline like '%/all%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname in ('cmd.exe','cmd') and commandline like '%HKEY_LOCAL_MACHINE%Software%Microsoft%Windows%CurrentVersion%Run%REG_EXPAND_SZ%SecurityHealth%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname in ('cmd.exe','cmd') and commandline like '%HKEY_LOCAL_MACHINE%Software%Microsoft%Windows%CurrentVersion%Run%REG_EXPAND_SZ%SecurityHealth%' and user='{SystemUser}' and system='{TargetHost}' | duration 6m

stream=authentication where action="LOGIN" and status="FAILED" |  groupby user | having count_col1>500

stream=authentication where action="LOGIN"|  groupby srcip, system |  
select srcip, system , count_if(status="PASSED") as passed_count, count_if(status="FAILED") as fail_Count | 
having fail_Count > 50 and fail_Count > 5*passed_count

stream=ep_process where process='cmd.exe' and commandline like '%whoami%' and commandline like '%/all%'

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%Get-System.ps1%Get-System -Technique NamedPipe -Verbose%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%Get-System.ps1%Get-System -Technique NamedPipe -Verbose%" | groupby user, system

stream=ep-process where process='cmd.exe' and commandline like '%whoami%' and commandline like '%all%' | groupby user, system

stream=ep-process where process='cmd.exe' and commandline like '%whoami%' and commandline like '%/all%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=IAM where action="PRIVILEGE_CHANGED" and PrivilegeList like "%SeBackupPrivilege%" | groupby user

stream=IAM where action="PRIVILEGE_CHANGED" and PrivilegeList like "%SeBackupPrivilege%" and user='{SuspectUser}' | duration 6m

stream=win-audit where newprocessname='powershell.exe' and commandline like '%New-AzureADServicePrincipalCredential%CertificateThumbprint%' | groupby user, system

stream=win-audit where newprocessname='powershell.exe' and commandline like '%New-AzureADServicePrincipalCredential%CertificateThumbprint%' and system='{TaregtHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname in ('powershell.exe','pwsh.exe') and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Internet%Settings%ZoneMap%Domains%new-item%2%DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname in ('powershell.exe','pwsh.exe') and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Internet%Settings%ZoneMap%Domains%new-item%2%DWORD%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%System.IO.Compression.DeflateStream%FromBase64String%' or commandline like '%System.IO.Compression.GzipStream%FromBase64String%' or commandline like '%IO.Compression.DeflateStream%FromBase64String%' or commandline like '%IO.Compression.GzipStream%FromBase64String%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%System.IO.Compression.DeflateStream%FromBase64String%' or commandline like '%System.IO.Compression.GzipStream%FromBase64String%' or commandline like '%IO.Compression.DeflateStream%FromBase64String%' or commandline like '%IO.Compression.GzipStream%FromBase64String%') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Get-System.ps1%Get-System -Technique NamedPipe -Verbose%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Get-System.ps1%Get-System -Technique NamedPipe -Verbose%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where parentimage='cmd.exe' and commandline like '%whoami%' and commandline like '%all%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where parentimage='cmd.exe' and commandline like '%whoami%' and commandline like '%all%' | groupby user, system

stream=ep-process where parentimage='powershell.exe' and commandline like '%Invoke-WinPwn%' and commandline like '%getsystem%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where parentimage='powershell.exe' and commandline like '%Invoke-WinPwn%' and commandline like '%getsystem%' | groupby user, system

stream=ep-process where parentimage='powershell.exe' and commandline like '%Invoke-WinPwn%' and commandline like '%getsystem%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where parentimage='powershell.exe' and commandline like '%Invoke-WinPwn%' and commandline like '%getsystem%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%' and rlike(commandline, 'bin\\.*?\.') | groupby system, User

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%' and rlike(commandline, 'bin\\.*?\.') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where parentimage='powershell.exe' and commandline like '%New-AzureADApplication%CertValue%' and system='{TaregtHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where parentimage='powershell.exe' and commandline like '%New-AzureADApplication%CertValue%' | groupby user, system

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='CreateAccessKey' | groupby srcip

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='CreateAccessKey' and srcip='{SuspectHost}' | duration 6m

stream=ep-process where parentimage='powershell.exe' and commandline like '%Invoke-WinPwn%getsystem%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where parentimage='powershell.exe' and commandline like '%Invoke-WinPwn%getsystem%' | groupby user, system

stream=ep-process where parentimage='cmd.exe' and commandline like '%whoami%all%' | groupby user, system

stream=ep-process where parentimage='cmd.exe' and commandline like '%whoami%all%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%hashcat.exe%-m%sam%txt%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%hashcat.exe%-m%sam%txt%" and user='{SuspectUser}' and host='{SuspectHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%Print%Environments%Windows%x64%Print%Processors%' | groupby user, system

stream=win-audit where newprocessname='powershell.exe' and commandline like '%New-AzureADApplication%CertValue%' | groupby user, system

stream=win-audit where newprocessname='powershell.exe' and commandline like '%New-AzureADApplication%CertValue%' and system='{TaregtHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where parentimage='powershell.exe' and commandline like '%Invoke-WinPwn%getsystem%' | groupby user, system

stream=ep-process where parentimage='powershell.exe' and commandline like '%Invoke-WinPwn%getsystem%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%hashcat.exe%-m%sam%txt%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%hashcat.exe%-m%sam%txt%" | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe" and commandline like "%New-Object IO.FileStream%Open%Read%ReadWrite%" | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe" and commandline like "%New-Object IO.FileStream%Open%Read%ReadWrite%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe" and commandline like "%New-Object IO.FileStream%Open%Read%ReadWrite%" | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%' and rlike(commandline, 'bin\\.*?\.') | groupby system, User

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%' and rlike(commandline, 'bin\\.*?\.') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%' and rlike(commandline, 'bin\\.*?\.') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%' and rlike(commandline, 'bin\\.*?\.') | groupby system, User

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%' and rlike(commandline, 'bin\\.*?\.') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%' and rlike(commandline, 'bin\\.*?\.') | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline) like 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll')) or (rlike(lower(commandline) like 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll')) or (rlike(lower(commandline) like 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll')) | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline) like 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll')) or (rlike(lower(commandline) like 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll')) or (rlike(lower(commandline) like 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll')) | groupby user, system and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%ConvertTo-SecureString%New-Object%Get-ADUser%-Properties%Remove-ADGroupMember%-Identity%-Members%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%convertto-securestring%new-object%get-aduser%-properties%remove-adgroupmember%-identity%-members%') | groupby user, system

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='CreateAccessKey' | duration 1h | groupby srcip

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='CreateAccessKey' and srcip='{SuspectHost}' | duration 6m

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='CreateAccessKey' | groupby srcip

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='CreateAccessKey' and srcip='{SuspectHost}' | duration 6m

stream=ep-process where parentimage='cmd.exe' and commandline like '%whoami%all%' | groupby user, system

stream=ep-process where parentimage='cmd.exe' and commandline like '%whoami%all%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%ConvertTo-SecureString%New-Object%Get-ADUser%-Properties%Remove-ADGroupMember%-Identity%-Members%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%get-aduser%remove-adgroupmember%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%system%control%print%bin%' or commandline like '%SYSTEM%CurrentControlSet%Control%Print%bin%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'reg add.*?hklm.*?system.*?currentcontrolset.*?control.*?monitor.*?bin.*?\..*?reg_sz') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "powershell.exe" and (commandline like 'Get-DomainTrust%' or commandlinelike '%Get-ForestTrust%') | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"mimikatz.*?(sid\:\:add|kerberos\:\:golden|kerberos\:\:tgt)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|kerberos\\:\\:golden|kerberos\\:\\:tgt)") | groupby user, system

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='CreateAccessKey' and srcip='{SuspectHost}' | duration 6m

stream=cloudtrail where sourcename='AWS-CLOUDTRAIL' and sourcetype='CLOUD' and eventname='CreateAccessKey' | groupby srcip

stream=win-audit where newprocessname='powershell.exe' and commandline like '%New-AzureADApplication%CertValue%' | groupby user, system

stream=win-audit where newprocessname='powershell.exe' and commandline like '%New-AzureADApplication%CertValue%' and system='{TaregtHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where newprocessname='powershell.exe' and commandline like '%New-AzureADServicePrincipalCredential%CertificateThumbprint%' | groupby user, system

stream=win-audit where newprocessname='powershell.exe' and commandline like '%New-AzureADServicePrincipalCredential%CertificateThumbprint%' and system='{TaregtHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe" and commandline like "%New-Object IO.FileStream%Open%Read%ReadWrite%" | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe" and commandline like "%New-Object IO.FileStream%Open%Read%ReadWrite%" and user='{SuspectUser}' and system='{TargetSystem}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%hashcat.exe%-m%sam%txt%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%hashcat.exe%-m%sam%txt%" and user='{SuspectUser}' and host='{SuspectHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (NewProcessName like "%.jse" or NewProcessName like "%.js") and rlike(CommandLine, '(\\-\\-decompress|\\-c)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (NewProcessName like "%.jse" or NewProcessName like "%.js") and rlike(CommandLine, '(\\-\\-decompress|\\-c)') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%hashcat.exe%-m%sam%txt%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%hashcat.exe%-m%sam%txt%" and user='{SuspectUser}' and system='{SuspectHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%Print%Environments%Windows%x64%Print%Processors%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%Print%Environments%Windows%x64%Print%Processors%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%Print%Environments%Windows%x64%Print%Processors%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%Print%Environments%Windows%x64%Print%Processors%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%Print%Environments%Windows%x64%Print%Processors%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%Print%Environments%Windows%x64%Print%Processors%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, '(LaZagne.exe)')

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'powershell.exe' and (commandline like '%Get-DomainTrust%' or commandline like '%Get-ForestTrust%') | groupby user, system | duration 10m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'powershell.exe' and (commandline like '%Get-DomainTrust%' or commandline like '%Get-ForestTrust%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'powershell.exe' and (commandline like '%Get-DomainTrust%' or commandline like '%Get-ForestTrust%') | groupby user, system | duration 10m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'powershell.exe' and (commandline like '%Get-DomainTrust%' or commandline like '%Get-ForestTrust%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'powershell.exe' and (commandline like '%Get-DomainTrust%' or commandline like '%Get-ForestTrust%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image='net.exe' and commandline like '%group%' and commandline like '%Domain%Admins%' and commandline like '%/delete%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and image='net.exe' and commandline like '%group%' and commandline like '%Domain%Admins%' and commandline like '%/delete%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m


stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') | groupby user, system and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%' or commandline like '%Start-Process%BadPotato%' or commandline like '%Start-Process%notepad%' or commandline like '%Stop-Process%BadPotato%' or commandline like '%Stop-Process%notepad%') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%' or commandline like '%Start-Process%BadPotato%' or commandline like '%Start-Process%notepad%' or commandline like '%Stop-Process%BadPotato%' or commandline like '%Stop-Process%notepad%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%' or commandline like '%Start-Process%BadPotato%' or commandline like '%Start-Process%notepad%' or commandline like '%Stop-Process%BadPotato%' or commandline like '%Stop-Process%notepad%') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%' or commandline like '%Start-Process%BadPotato%' or commandline like '%Start-Process%notepad%' or commandline like '%Stop-Process%BadPotato%' or commandline like '%Stop-Process%notepad%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'powershell.exe' and (commandline like '%Get-DomainTrust%' or commandline like '%Get-ForestTrust%') | groupby user, system | duration 10m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'powershell.exe' and (commandline like '%Get-DomainTrust%' or commandline like '%Get-ForestTrust%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'powershell.exe' and (commandline like '%Get-DomainTrust%' or commandline like '%Get-ForestTrust%') | groupby user, system | duration 10m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'powershell.exe' and (commandline like '%Get-DomainTrust%' or commandline like '%Get-ForestTrust%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%' or commandline like '%Start-Process%BadPotato%' or commandline like '%Start-Process%notepad%' or commandline like '%Stop-Process%BadPotato%' or commandline like '%Stop-Process%notepad%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%' or commandline like '%Start-Process%BadPotato%' or commandline like '%Start-Process%notepad%' or commandline like '%Stop-Process%BadPotato%' or commandline like '%Stop-Process%notepad%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Compress-Archive%TEMP%Folder_to_zip.zip%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Compress-Archive%TEMP%Folder_to_zip.zip%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Compress-Archive%TEMP%Folder_to_zip.zip%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Compress-Archive%TEMP%Folder_to_zip.zip%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|kerberos\\:\\:golden|kerberos\\:\\:tgt)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|kerberos\\:\\:golden|kerberos\\:\\:tgt)") | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%' or commandline like '%Start-Process%BadPotato%' or commandline like '%Start-Process%notepad%' or commandline like '%Stop-Process%BadPotato%' or commandline like '%Stop-Process%notepad%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%' or commandline like '%Start-Process%BadPotato%' or commandline like '%Start-Process%notepad%' or commandline like '%Stop-Process%BadPotato%' or commandline like '%Stop-Process%notepad%') | groupby user, system

stream=osquery where packagename like '%pack_d_compliance_usb_storage%' and action='added' | duration 1h |  groupby devsrcip, hostname

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Compress-Archive%TEMP%Folder_to_zip.zip%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Compress-Archive%TEMP%Folder_to_zip.zip%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=nta-rdp where cookie = "Administrator"  and srcip = "172.25.10.119" | duration 2h

stream=nta-rdp where cookie = "{TargetUser}" and srcip = "{SuspectHost}" | duration 2h

stream=signals where detectionseverity="High" or detectionseverity="Medium" or detectionseverity="Low" | duration 1h | limit 1

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'bin\\(LaZagne.exe|LaZagne)') | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|kerberos\\:\\:golden|kerberos\\:\\:tgt)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|kerberos\\:\\:golden|kerberos\\:\\:tgt)") | groupby user, system

stream=nta-rdp where cookie = "Administrator"  or cookie = "raiAdmin"   | duration 1h

stream=nta-rdp where cookie = "{TargetUser}" and srcip = "{SuspectHost}" | duration 1h

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll')) | duration 15m |  groupby user, system, commandline 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll')) and user='{SuspectUser}' and system='{TargetHost}' 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%adfind.exe%-f%objectcategory=computer%' or lower(commandline) like '%adfind.exe%-sc%dclist%') |  duration 1h

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'reg add.*?hklm.*?system.*?currentcontrolset.*?control.*?monitor.*?bin.*?\..*?reg_sz') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'reg add.*?hklm.*?system.*?currentcontrolset.*?control.*?monitor.*?bin.*?\..*?reg_sz') | groupby user, system

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and ((rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)')) or (rlike(lower(scriptblocktext) like '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and ((rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)')) or (rlike(lower(scriptblocktext) like '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) | groupby system, user 

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%chromium%chrome.exe%--load-extension=%' or commandline like '%chromium%chrome.exe%chrome.google.com%webstore%detail%') | select system, user

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%chromium%chrome.exe%--load-extension=%' or commandline like '%chromium%chrome.exe%chrome.google.com%webstore%detail%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%chromium%chrome.exe%--load-extension=%' or commandline like '%chromium%chrome.exe%chrome.google.com%webstore%detail%') | select system, user

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%chromium%chrome.exe%--load-extension=%' or commandline like '%chromium%chrome.exe%chrome.google.com%webstore%detail%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=nta-files,nta-http where srcip='{TargetResource}' and fid='{SuspectObject}' | duration 24h

stream=nta-files where fid in (_FID_) and lower(analyzer) like "%pe%" | duration 24h

stream=nta-http where mimetype = 'application/x-dosexec' |  duration 24h

stream=ep_process where process='cmd.exe' and commandline like '%csc.exe%' and commandline like '%T1010.cs%' or process='T1010.exe'

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|sid\\:\\:patch|sid\\:\\:lookup|sekurlsa::logonpasswords|token::whoami)")  | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline,"mimikatz.*?(sid::add|sid::patch|sid::lookup||sekurlsa::logonpasswords|token::whoami)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%PetitPotam%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%chromium%chrome.exe%--load-extension=%' or commandline like '%chromium%chrome.exe%chrome.google.com%webstore%detail%') | select system, user

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%chromium%chrome.exe%--load-extension=%' or commandline like '%chromium%chrome.exe%chrome.google.com%webstore%detail%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and newprocessname='cmd.exe' and parentcommandline like '%csc.exe%T1010.cs%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and newprocessname='cmd.exe' and parentcommandline like '%csc.exe%T1010.cs%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(generaldomaininfo|winpwn).*?-(noninteractive|consoleoutput|domainrecon)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(generaldomaininfo|winpwn).*?-(noninteractive|consoleoutput|domainrecon)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%PetitPotam%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%PetitPotam%' | groupby user, system | duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%PetitPotam%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%PetitPotam%' | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%get-aduser%remove-adgroupmember%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%get-aduser%remove-adgroupmember%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=IAM where action="PRIVILEGE_CHANGED" and PrivilegeList like "%SeBackupPrivilege%" | groupby user

stream=IAM where action="PRIVILEGE_CHANGED" and PrivilegeList like "%SeBackupPrivilege%" and user='{SuspectUser}' | duration 6m

stream=ep-process where newprocessname='cmd.exe' and parentcommandline like '%csc.exe%T1010.cs%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and newprocessname='cmd.exe' and parentcommandline like '%csc.exe%T1010.cs%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and newprocessname='cmd.exe' and parentcommandline like '%csc.exe%T1010.cs%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%New-Item%Invoke-WebRequest%PetitPotam%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%New-Item%Invoke-WebRequest%PetitPotam%' and user='{SuspectUser}' and system='{TargetHost}'

stream=AUDITD where action='USER_COMMAND_EXECUTED' and (commandline like '%echo%etc%ld.so.preload%' or commandline like '%LD_PRELOAD=%' or commandline like '%DYLD_INSERT_LIBRARIES%') | groupby user, system

stream=AUDITD where action='USER_COMMAND_EXECUTED' and (commandline like '%echo%etc%ld.so.preload%' or commandline like '%LD_PRELOAD=%' or commandline like '%DYLD_INSERT_LIBRARIES%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=AUDITD where action='USER_COMMAND_EXECUTED' and (commandline like '%echo%etc%ld.so.preload%' or commandline like '%LD_PRELOAD=%' or commandline like '%DYLD_INSERT_LIBRARIES%') | groupby user, system

stream=AUDITD where action='USER_COMMAND_EXECUTED' and (commandline like '%echo%etc%ld.so.preload%' or commandline like '%LD_PRELOAD=%' or commandline like '%DYLD_INSERT_LIBRARIES%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname='powershell.exe' and (lower(commandline) like '%Set-PSReadlineOption%HistorySaveStyle SaveNothing%' or lower(commandline) like '%Remove-Item%ConsoleHost_history.txt%') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "%powershell.exe" and lower(parentCommandLine) like "%powershell%-encodedcommand%" |  groupby user, system

stream=EP-PROCESS where eid in ('1', '4104') and parentimage like "%powershell.exe" and lower(parentCommandLine) like "%powershell%-encodedcommand%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((commandline) like '%adfind.exe%-f%objectcategory=computer%' or (commandline) like '%adfind.exe%-sc%dclist%') |  duration 1h

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%adfind.exe%-f%objectcategory=computer%' or lower(commandline) like '%adfind.exe%-sc%dclist%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%adfind.exe%-f%objectcategory=computer%' or lower(commandline) like '%adfind.exe%-sc%dclist%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and parentimage like '%cmd.exe%' and parentcommandline like '%csc.exe%T1010.cs%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and parentimage like '%cmd.exe%' and parentcommandline like '%csc.exe%T1010.cs%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%PetitPotam%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%PetitPotam%' and user='{SuspectUser}' and system='{TargetHost}'

stream=AUDITD where action='USER_COMMAND_EXECUTED' and (commandline like '%echo%etc%ld.so.preload%' or commandline like '%LD_PRELOAD=%' or commandline like '%DYLD_INSERT_LIBRARIES%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=AUDITD where action='USER_COMMAND_EXECUTED' and (commandline like '%echo%etc%ld.so.preload%' or commandline like '%LD_PRELOAD=%' or commandline like '%DYLD_INSERT_LIBRARIES%') | groupby user, system

stream=ep_process where image='powershell.exe' or image='az' and (commandline like '%Remove-AzureADUser%' and commandline like '%-ObjectId%') or (commandline like '%ad%user%delete%' and commandline like '%--id%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep_process where image='powershell.exe' or image='az' and (commandline like '%Remove-AzureADUser%' and commandline like '%-ObjectId%') or (commandline like '%ad%user%delete%' and commandline like '%--id%') | groupby user, system

stream=ep_process where image='powershell.exe' or image='az' and (commandline like '%Remove-AzureADUser%' and commandline like '%-ObjectId%') or (commandline like '%ad%user%delete%' and commandline like '%--id%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep_process where image='powershell.exe' or image='az' and (commandline like '%Remove-AzureADUser%' and commandline like '%-ObjectId%') or (commandline like '%ad%user%delete%' and commandline like '%--id%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powerview%get-domaincontroller%' | duration 1h

stream=win-audit where action='PROCESS_CREATED' and newprocessname='powershell.exe' and (lower(commandline) like '%Set-PSReadlineOption%HistorySaveStyle SaveNothing%' or lower(commandline) like '%Remove-Item%ConsoleHost_history.txt%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname='powershell.exe' and (lower(commandline) like '%Set-PSReadlineOption%HistorySaveStyle SaveNothing%' or lower(commandline) like '%Remove-Item%ConsoleHost_history.txt%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname='powershell.exe' and (commandline like '%Set-PSReadlineOption%HistorySaveStyle SaveNothing%' or commandline like '%Remove-Item%ConsoleHost_history.txt%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and newprocessname='powershell.exe' and (lower(commandline) like '%Set-PSReadlineOption%HistorySaveStyle SaveNothing%' or lower(commandline) like '%Remove-Item%ConsoleHost_history.txt%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%jsc.exe%' or commandline like '%.js%' or commandline like '%Library.dll%' | groupby system, user, commandline

stream=win-audit where action='PROCESS_CREATED' and commandline like '%jsc.exe%' or commandline like '%.js%' or commandline like '%Library.dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where newprocessname='powershell.exe' and commandline like '%AddToHistoryHandler%return $false%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where newprocessname='powershell.exe' and commandline like '%AddToHistoryHandler%return $false%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%New-Item -Path%AppData%Local%Comms%Unistore%data%copy%ItemType Directory -ErrorAction Ignore%Get-ChildItem%-Exclude copy%Remove-Item%-Recurse -Force -ErrorAction Ignore%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%New-Item -Path%AppData%Local%Comms%Unistore%data%copy%ItemType Directory -ErrorAction Ignore%Get-ChildItem%-Exclude copy%Remove-Item%-Recurse -Force -ErrorAction Ignore%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED'  and rlike(lower(commandline), 'powershell.exe.*(copy-item|move-item).*(c//$|d//$|admin//$|a//$|ipc//$|print//$)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED'  and rlike(lower(commandline), 'powershell.exe.*(copy-item|move-item).*(c\\$|d\\$|admin\\$|a\\$|ipc\\$|print\\$)') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and newprocessname='powershell.exe' and (lower(commandline) like '%Set-PSReadlineOption%HistorySaveStyle SaveNothing%' or lower(commandline) like '%Remove-Item%ConsoleHost_history.txt%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname='powershell.exe' and (lower(commandline) like '%Set-PSReadlineOption%HistorySaveStyle SaveNothing%' or lower(commandline) like '%Remove-Item%ConsoleHost_history.txt%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where newprocessname='powershell.exe' and commandline like '%AddToHistoryHandler%return $false%' | groupby user, system

stream=win-audit where newprocessname='powershell.exe' and commandline like '%AddToHistoryHandler%return $false%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where newprocessname='powershell.exe' and commandline like '%AddToHistoryHandler%return $false%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname='fsutil.exe' and (commandline like '%file%' or commandline like '%quota%' or commandline like '%usn%' or commandline like '%setshortname%' or commandline like '%setvaliddata%' or commandline like '%setzerodata%' or commandline like '%create%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname='fsutil.exe' and (commandline like '%file%' or commandline like '%quota%' or commandline like '%usn%' or commandline like '%setshortname%' or commandline like '%setvaliddata%' or commandline like '%setzerodata%' or commandline like '%create%') | groupby user, system

stream=win-audit where newprocessname='%powershell.exe%' and commandline like '%Get-DomainUser%' | groupby system, user 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%Get-DomainUser%' | groupby system, user 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%Get-DomainUser%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image='net.exe' and (commandline like '%group%' or commandline like '%Domain%Admins%' or commandline like '%/delete%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and image='net.exe' and (commandline like '%group%' or commandline like '%Domain%Admins%' or commandline like '%/delete%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%jsc.exe%' or commandline like '%.js%' or commandline like '%Library.dll%') | groupby system, user, commandline

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%jsc.exe%' or commandline like '%.js%' or commandline like '%Library.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname='powershell.exe' and (commandline like '%Set-PSReadlineOption%HistorySaveStyle SaveNothing%' or commandline like '%Remove-Item%ConsoleHost_history.txt%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and newprocessname='powershell.exe' and (commandline like '%Set-PSReadlineOption%HistorySaveStyle SaveNothing%' or commandline like '%Remove-Item%ConsoleHost_history.txt%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname='powershell.exe' and (commandline like '%Set-PSReadlineOption%HistorySaveStyle SaveNothing%' or commandline like '%Remove-Item%ConsoleHost_history.txt%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and newprocessname='powershell.exe' and (commandline like '%Set-PSReadlineOption%HistorySaveStyle SaveNothing%' or commandline like '%Remove-Item%ConsoleHost_history.txt%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%New-Item -Path%AppData%Local%Comms%Unistore%data%copy%ItemType Directory -ErrorAction Ignore%Get-ChildItem%-Exclude copy%Remove-Item%-Recurse -Force -ErrorAction Ignore%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%New-Item -Path%AppData%Local%Comms%Unistore%data%copy%ItemType Directory -ErrorAction Ignore%Get-ChildItem%-Exclude copy%Remove-Item%-Recurse -Force -ErrorAction Ignore%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname='fsutil.exe' and (commandline like '%file%' or commandline like '%quota%' or commandline like '%usn%' or commandline like '%setshortname%' or commandline like '%setvaliddata%' or commandline like '%setzerodata%' or commandline like '%create%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname='fsutil.exe' and (commandline like '%file%' or commandline like '%quota%' or commandline like '%usn%' or commandline like '%setshortname%' or commandline like '%setvaliddata%' or commandline like '%setzerodata%' or commandline like '%create%') | groupby user, system

stream=win-audit where newprocessname='%powershell.exe%' and commandline like '%Get-DomainUser%' | groupby system, user 

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline,"copy.*?(\\$env\\:windir|C\\:\\\Windows).*?(System32|SysWOW64).*\\.exe") | groupby system, user

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline,"copy.*?(\\$env\\:windir|C\\:\\\Windows).*?(System32|SysWOW64).*\\.exe") and system="{TargetHost}" and user='{SuspectUser}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and image='net.exe' and commandline like '%group%' or commandline like '%Domain%Admins%' or commandline like '%/delete%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image='net.exe' and commandline like '%group%' or commandline like '%Domain%Admins%' or commandline like '%/delete%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%msbuild.exe%' or commandline like '%.csproj%' or commandline like '%vb.xml%') | groupby system, user, commandline

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%msbuild.exe%' or commandline like '%.csproj%' or commandline like '%vb.xml%') | groupby system, user, commandline

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%msbuild.exe%' or commandline like '%.csproj%' or commandline like '%vb.xml%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe" and commandline like '%Copy-Item%C$%' | select user, system 

stream=ep_process where action='PROCESS_ADDED' and (image='powershell.exe' or image='az') and (commandline like '%Remove-AzureADUser%' or commandline like '%-ObjectId%' or commandline like '%ad%user%delete%' or commandline like '%--id%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep_process where action='PROCESS_ADDED' and (image='powershell.exe' or image='az') and (commandline like '%Remove-AzureADUser%' or commandline like '%-ObjectId%' or commandline like '%ad%user%delete%' or commandline like '%--id%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%jsc.exe%' or commandline like '%.js%' or commandline like '%Library.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%jsc.exe%' or commandline like '%.js%' or commandline like '%Library.dll%') | groupby system, user, commandline

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%msbuild.exe%' or commandline like '%.csproj%' or commandline like '%vb.xml%') | groupby system, user, commandline

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%msbuild.exe%' or commandline like '%.csproj%' or commandline like '%vb.xml%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%msbuild.exe%' or commandline like '%.csproj%' or commandline like '%vb.xml%') | groupby system, user, commandline

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%msbuild.exe%' or commandline like '%.csproj%' or commandline like '%vb.xml%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_CREATED" and rlike(commandline,"(\\.\\.\\.|cd.*?&&)") | groupby user, system

stream=EP-PROCESS where action="PROCESS_CREATED" and rlike(commandline,"(\\.\\.\\.|cd.*?&&)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%reg%add%hklm%system%CurrentControlSet%Control%Terminal Server%AllowTSConnections%REG_DWORD%' or commandline like '%reg%add%hklm%system%CurrentControlSet%Control%Terminal Server%fDenyTSConnections%REG_DWORD%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%reg%add%hklm%system%CurrentControlSet%Control%Terminal Server%AllowTSConnections%REG_DWORD%' or commandline like '%reg%add%hklm%system%CurrentControlSet%Control%Terminal Server%fDenyTSConnections%REG_DWORD%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"(sc\\s|schtasks\\s).*?(?i)create.*?win32times") |  groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"(sc\\s|schtasks\\s).*?(?i)create.*?win32times") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((certutil\s+-(f|user|silent|split|p|t|v|nocr|nocrlf|csp|unicodetext).*?-(encodehex|dump|dumppfx|asn|decodehex|decode|encode))|system.io.file.*?::copy).*?windows.*?system32.*?config') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((certutil\s+-(f|user|silent|split|p|t|v|nocr|nocrlf|csp|unicodetext).*?-(encodehex|dump|dumppfx|asn|decodehex|decode|encode))|system.io.file.*?::copy).*?windows.*?system32.*?config')  | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%[System.Environment]::UserName%' or commandline like '%$env:UserName%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%[System.Environment]::UserName%' or commandline like '%$env:UserName%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe%" and commandline like '%copy-item%C$%' | select user, system 

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe%" and commandline like '%copy-item%C$%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg%add%hklm%system%CurrentControlSet%Control%Terminal Server%AllowTSConnections%REG_DWORD%' or commandline like '%reg%add%hklm%system%CurrentControlSet%Control%Terminal Server%fDenyTSConnections%REG_DWORD%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg%add%hklm%system%CurrentControlSet%Control%Terminal Server%AllowTSConnections%REG_DWORD%' or commandline like '%reg%add%hklm%system%CurrentControlSet%Control%Terminal Server%fDenyTSConnections%REG_DWORD%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" AND not rlike(ParentProcessName,"%\\\\Windows\\\\System32%") and (commandline like "%system32%" or commandline like "%syswow64%")| groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" AND not rlike(ParentProcessName,"%\\\\Windows\\\\System32%") and (commandline like "%system32%" or commandline like "%syswow64%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" AND not rlike(ParentProcessName,"%\\\\Windows\\\\System32%") and (commandline like "%system32%" or commandline like "%syswow64%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" AND not rlike(ParentProcessName,"%\\\\Windows\\\\System32%") and (commandline like "%system32%" or commandline like "%syswow64%")| groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"(sc\\s|schtasks\\s).*?(?i)create.*?win32times") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"(sc\\s|schtasks\\s).*?(?i)create.*?win32times") |  groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"(sc\\s|schtasks\\s).*?(?i)create.*?win32times") |  groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"(sc\\s|schtasks\\s).*?(?i)create.*?win32times") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"(sc\\s|schtasks\\s).*?(?i)create.*?win32times") and parentuser='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"(sc\\s|schtasks\\s).*?(?i)create.*?win32times") | groupby parentuser, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline), "(netstat|ss\s+-(t|u|n|l|p)|nmap|tcpdump|wireshark|lsof|ip\s+addr|arp\s+-|iftop|netcat|nc\s|iptraf-ng|netdiscover|zenmap|nstat|tcpflow|get-nettcpconnection|get-netudpendpoint|test-netconnection|get-netadapter|get-netipaddress|get-netroute|resolve-dnsname|get-netneighbor|get-nettcpsetting|get-netfirewallrule|get-netfirewallprofile|get-netfirewalladdressfilter|get-netfirewallportfilter|get-netfirewallapplicationfilter|get-netfirewallsecurityfilter|get-netfirewallinterfacefilter)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline), "(netstat|ss\\s+-(t|u|n|l|p)|nmap|tcpdump|wireshark|lsof|ip\\s+addr|arp\\s+-|iftop|netcat|nc\\s|iptraf-ng|netdiscover|zenmap|nstat|tcpflow|get-nettcpconnection|get-netudpendpoint|test-netconnection|get-netadapter|get-netipaddress|get-netroute|resolve-dnsname|get-netneighbor|get-nettcpsetting|get-netfirewallrule|get-netfirewallprofile|get-netfirewalladdressfilter|get-netfirewallportfilter|get-netfirewallapplicationfilter|get-netfirewallsecurityfilter|get-netfirewallinterfacefilter)") | duration 15m |  select system, user, commandline | limit 10000

stream=win-audit where action='PROCESS_CREATED' and commandline like '%sc%config%Fax%powershell%' | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and commandline like '%sc%config%Fax%powershell%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"(sc\\s|schtasks\\s).*?(?i)create.*?win32times") | groupby parentuser, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"(sc\\s|schtasks\\s).*?(?i)create.*?win32times") and parentuser='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%[System.Environment]::UserName%' or commandline like '%$env:UserName%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%[System.Environment]::UserName%' or commandline like '%$env:UserName%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe%" and commandline like '%copy-item%C$%' | select user, system 

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe%" and commandline like '%copy-item%C$%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe%" and commandline like '%copy-item%C$%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe%" and commandline like '%copy-item%C$%' | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%powershell%Invoke-WebRequest%github%' or commandline like '%sc%create%' or commandline like '%sc%start%' or commandline like '%powershell%New-Service%' or commandline like '%powershell%Start-Service%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%powershell%Invoke-WebRequest%github%' or commandline like '%sc%create%' or commandline like '%sc%start%' or commandline like '%powershell%New-Service%' or commandline like '%powershell%Start-Service%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%usebasicparsing%') or (lower(scriptblocktext) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%usebasicparsing%') and (lower(commandline) like '%macrocode%officeproduct%'))  | duration 1d

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%usebasicparsing%ping%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=authentication |  groupby user |  limit 2

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%adfind.exe%-f%objectcategory=computer%' or lower(commandline) like '%adfind.exe%-sc%dclist%') | groupby user, system |  duration 1h

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe%" and commandline like '%copy-item%C$%' | select user, system 

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe%" and commandline like '%copy-item%C$%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe%" and commandline like '%copy-item%C$%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe%" and commandline like '%copy-item%C$%' | groupby user, system 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "at\\s+\\d+:\\d+") |  groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "at\s+\d+:\d+") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "at\\s+\\d+:\\d+") |  groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "at\s+\d+:\d+") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powerview%get-domaincontroller%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powerview%get-domaincontroller%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%sc%config%Fax%powershell%' | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and commandline like '%sc%config%Fax%powershell%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '(\.jse|\.js|\.gz|\.bz2|\.tar|\.7z|-xvf.*?\.tar.*?-c|decompressed_files.*?(\.exe|\.bin|\.html|\.doc|\.txt)|decompressed_files|decompressed|decompress)') and user='{SuspectUser}' and system='{TargetSystem}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '(\.jse|\.js|\.gz|\.bz2|\.tar|\.7z|-xvf.*?\.tar.*?-c|decompressed_files.*?(\.exe|\.bin|\.html|\.doc|\.txt)|decompressed_files|decompressed|decompress)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe%" and commandline like '%copy-item%C$%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe%" and commandline like '%copy-item%C$%' | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%powershell%Invoke-WebRequest%github%' or commandline like '%sc%create%' or commandline like '%sc%start%' or commandline like '%powershell%New-Service%' or commandline like '%powershell%Start-Service%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%powershell%Invoke-WebRequest%github%' or commandline like '%sc%create%' or commandline like '%sc%start%' or commandline like '%powershell%New-Service%' or commandline like '%powershell%Start-Service%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%powershell%Invoke-WebRequest%github%' or commandline like '%sc%create%' or commandline like '%sc%start%' or commandline like '%powershell%New-Service%' or commandline like '%powershell%Start-Service%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%sc%start%w64time%'  | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%adfind.exe%-f%objectcategory=computer%' or lower(commandline) like '%adfind.exe%-sc%dclist%' or lower(commandline) like '%adfind.exe%-f%objectcategory=ntdsdsa%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%adfind.exe%-f%objectcategory=computer%' or lower(commandline) like '%adfind.exe%-sc%dclist%' or lower(commandline) like '%adfind.exe%-f%objectcategory=ntdsdsa%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and commandline like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and commandline like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' |  groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentcommandline like '%certutil.exe%-decode%' or parentcommandline like '%certutil.exe%rename%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentcommandline like '%certutil.exe%-decode%' or parentcommandline like '%certutil.exe%rename%') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"copy.*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe)") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"copy.*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=authentication |  groupby user | limit 2

stream=ep-process where action="PROCESS_ADDED" where commandline like '%curl%https:%file.io%' | groupby system, user

stream=ep-process where action="PROCESS_ADDED" where commandline like '%curl%https:%file.io%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (image='powershell.exe' or image='az') and (commandline like '%Remove%AzureADUser%' or commandline like '%ObjectId%' or commandline like '%ad%user%delete%' or commandline like '%id%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (image='powershell.exe' or image='az') and (commandline like '%Remove%AzureADUser%' or commandline like '%ObjectId%' or commandline like '%ad%user%delete%' or commandline like '%id%') | groupby user, system

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and commandline like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and commandline like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%sc%create%w64time%' or lower(commandline) like '%sc%start%w64time%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%sc%create%w64time%' or lower(commandline) like '%sc%start%w64time%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%adfind.exe%-f%objectcategory=computer%' or lower(commandline) like '%adfind.exe%-sc%dclist%' or lower(commandline) like '%adfind.exe%-f%objectcategory=ntdsdsa%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%adfind.exe%-f%objectcategory=computer%' or lower(commandline) like '%adfind.exe%-sc%dclist%' or lower(commandline) like '%adfind.exe%-f%objectcategory=ntdsdsa%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe)") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=iam where action='USER_ADDED' and targetuser='Administrators' and user='{SuspectUser}' and system='{TargetHost}' and group='{TargetUser}' | duration 6m

stream=iam where action='USER_ADDED' and targetuser='Administrators' | groupby user, group, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"copy.*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"copy.*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe)") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%sc%config%Fax%powershell%' | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and commandline like '%sc%config%Fax%powershell%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%powershell%Invoke-WebRequest%github%' or commandline like '%sc%create%' or commandline like '%sc%start%' or commandline like '%powershell%New-Service%' or commandline like '%powershell%Start-Service%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%powershell%Invoke-WebRequest%github%' or commandline like '%sc%create%' or commandline like '%sc%start%' or commandline like '%powershell%New-Service%' or commandline like '%powershell%Start-Service%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "at\\s+\\d+:\\d+") |  groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "at\s+\d+:\d+") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(parentcommandline), '(.zip|.js).*?(whoami /all|net user|net group)' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(parentcommandline), '(.zip|.js).*?(whoami /all|net user|net group) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%powershell%UseBasicParsing%Get-PasswordVaultCredentials%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%powershell%UseBasicParsing%Get-PasswordVaultCredentials%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'esentutl.*?/y\s+/vss.*?/d') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'esentutl.*?/y\s+/vss.*?/d') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(image), "hashcate.exe") and rlike(lower(commandline), "-a.*-m.*-r") or rlike(lower(commandline), "hashcat.*-a.*-m.*-r")) | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(image), "hashcate.exe") and rlike(lower(commandline), "-a.*-m.*-r") or rlike(lower(commandline), "hashcat.*-a.*-m.*-r")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and scriptblocktext like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and scriptblocktext like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%sc%create%w64time%' or commandline like '%sc%start%w64time%')  | groupby user, system | duration 1h

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and scriptblocktext like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and scriptblocktext like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentcommandline like '%certutil.exe%-decode%' or parentcommandline like '%certutil.exe%rename%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentcommandline like '%certutil.exe%-decode%' or parentcommandline like '%certutil.exe%rename%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and CommandLine like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and CommandLine like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Get-AdfsCertificate -CertificateType Token-Signing%' or commandline like '%Import%Module%AADInternals%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%Import-Module%AADInternals%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%Get-Keystrokes.ps1%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%Get-Keystrokes.ps1%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%sc%create%w64time%' or lower(commandline) like '%sc%start%w64time%')  | groupby user, system 

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentcommandline like '%certutil.exe%-decode%' or parentcommandline like '%certutil.exe%rename%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (parentcommandline like '%certutil.exe%-decode%' or parentcommandline like '%certutil.exe%rename%')

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe)") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe)") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe)") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline),'(invoke-userhunter|find-domainuserlocation|invoke-bloodhound).*?-stealth)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline),'(invoke-userhunter|find-domainuserlocation|invoke-bloodhound).*?-stealth)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Get-AdfsCertificate -CertificateType Token-Signing%' or commandline like '%Get-AdfsCertificate -CertificateType Token-Decrypting%' or commandline like '%Import%Module%AADInternals%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%Import-Module%AADInternals%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'software.*?microsoft.*?active setup.*?installed component') and rlike(lower(commandline), '(run|runonce|runonce.exe|\..*?AlternateShellStartup)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'software.*?microsoft.*?active setup.*?installed component') and rlike(lower(commandline), '(run|runonce|runonce.exe|\..*?AlternateShellStartup)') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%msxslxmlfile.xml%' or commandline like '%msxslscript.xsl%' or commandline like '%msxsl.exe%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%msxslxmlfile.xml%' or commandline like '%msxslscript.xsl%' or commandline like '%msxsl.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%sc%create%w64time%' or lower(commandline) like '%sc%start%w64time%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%sc%create%w64time%' or lower(commandline) like '%sc%start%w64time%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and CommandLine like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and CommandLine like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' | groupby user, system

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and scriptblocktext like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and scriptblocktext like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%[System.Environment]::UserName%' or commandline like '%$env:UserName%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%[System.Environment]::UserName%' or commandline like '%$env:UserName%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(.zip|.js).*?(whoami /all|net user|net group)' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(.zip|.js).*?(whoami /all|net user|net group)' | groupby user, system

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and scriptblocktext like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='OBJECT_ACCESSED' and scriptblocktext like '%[System.Security.Principal.WindowsIdentity]::GetCurrent()%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%' or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or  lower(commandline) like '%nbtstat%-n%' or  lower(commandline) like '%nbtstat%-s%') and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%' or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or  lower(commandline) like '%nbtstat%-n%' or  lower(commandline) like '%nbtstat%-s%') | duration 15m |  select system, user, commandline | limit 10000

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.*?-accepteula.*?(-c|-f|-v)') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.*?-accepteula.*?(-c|-f|-v)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"copy.*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"copy.*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe)") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" where commandline like '%curl%https:%file.io%' | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%Get-Keystrokes.ps1%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%TokenSet%Get-Random%InputObject%rad%$rad%whoami.exe%$env:temp%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%TokenSet%Get-Random%InputObject%rad%$rad%whoami.exe%$env:temp%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like "%appcmd%set config%section:httplogging%dontlog:true%" | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like "%appcmd%set config%section:httplogging%dontlog:true%" and user="{SUspectUser}" and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like "%appcmd%set config%section:httplogging%dontlog:true%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like "%appcmd%set config%section:httplogging%dontlog:true%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" where commandline like '%curl%https:%file.io%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" where commandline like '%curl%https:%file.io%' | groupby system, user

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"copy.*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe|lsm\.exe)") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"copy.*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe|lsm\.exe)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and lower(parentcommandline) like "%appcmd%set config%section:httplogging%dontlog:true%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and lower(parentcommandline) like "%appcmd%set config%section:httplogging%dontlog:true%" | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and parentcommandline like '%TokenSet%Get-Random%InputObject%rad%$rad%whoami.exe%$env:temp%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and parentcommandline like '%TokenSet%Get-Random%InputObject%rad%$rad%whoami.exe%$env:temp%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(newprocessname), "(pcalua.exe|forfiles.exe|conhost.exe)") and (lower(commandline) like  "%pcalua%-a%" or lower(commandline) like  "%forfiles%/c%" or lower(commandline) like  "%conhost%") | duration 1h

stream=ep-process where action="PROCESS_ADDED" where commandline like '%curl%https:%file.io%' | groupby system, user

stream=ep-process where action="PROCESS_ADDED" where commandline like '%curl%https:%file.io%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"copy.*?(\.exe|\.vbs|\.ps1).*?(\.docx|\.pdf|\.ps1|\.xls|\.xlsx|\.png|\.doc|\.pdf|\.rtf)(\.exe|\.vbs|\.ps1)") | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"copy.*?(\.exe|\.vbs|\.ps1).*?(\.docx|\.pdf|\.ps1|\.xls|\.xlsx|\.png|\.doc|\.pdf|\.rtf)(\.exe|\.vbs|\.ps1)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%TokenSet%Get-Random%InputObject%rad%$rad%whoami.exe%$env:temp%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%TokenSet%Get-Random%InputObject%rad%$rad%whoami.exe%$env:temp%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%powershell%UseBasicParsing%Get-PasswordVaultCredentials%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%powershell%UseBasicParsing%Get-PasswordVaultCredentials%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg query HKLM%f%password%t%REG_SZ%' or commandline like '%reg query HKCU%f%password%t%REG_SZ%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg query HKLM%f%password%t%REG_SZ%' or commandline like '%reg query HKCU%f%password%t%REG_SZ%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"copy.*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe|lsm\.exe)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"copy.*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe|lsm\.exe)") | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"copy.*?(\.exe|\.vbs|\.ps1).*?(\.docx|\.pdf|\.ps1|\.xls|\.xlsx|\.png|\.doc|\.pdf|\.rtf)(\.exe|\.vbs|\.ps1)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"copy.*?(\.exe|\.vbs|\.ps1).*?(\.docx|\.pdf|\.ps1|\.xls|\.xlsx|\.png|\.doc|\.pdf|\.rtf)(\.exe|\.vbs|\.ps1)") | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%Get-Keystrokes.ps1%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%Get-Keystrokes.ps1%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Remove-Item%$env:TEMP%windows-credentials.txt%' | groupby user,system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%powershell%UseBasicParsing%Get-PasswordVaultCredentials%' or commandline like '%powershell%UseBasicParsing%Get-CredManCreds%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%powershell%UseBasicParsing%Get-PasswordVaultCredentials%' or commandline like '%powershell%UseBasicParsing%Get-CredManCreds%') | groupby user, system

stream=ep_process where action='PROCESS_ADDED' and (image='powershell.exe' or image='az') and (commandline like '%Remove%AzureADUser%' or commandline like '%%ObjectId%' or commandline like '%ad%user%delete%' or commandline like '%id%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep_process where action='PROCESS_ADDED' and (image='powershell.exe' or image='az') and (commandline like '%Remove%AzureADUser%' or commandline like '%%ObjectId%' or commandline like '%ad%user%delete%' or commandline like '%id%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%msxslxmlfile.xml%' or commandline like '%msxslscript.xsl%' or commandline like '%msxsl.exe%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%msxslxmlfile.xml%' or commandline like '%msxslscript.xsl%' or commandline like '%msxsl.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%appcmd%set config%section:httplogging%dontlog:true%" or lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%" ) | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like "%appcmd%set config%section:httplogging%dontlog:true%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commnadline like '%powershell%UseBasicParsing%Get-PasswordVaultCredentials%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commnadline like '%powershell%UseBasicParsing%Get-PasswordVaultCredentials%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and ( rlike(lower(commandline),"stop.*?(mcafeedlpagentservice|sc\.exe)") or rlike(lower(commandline),"config.*?mcafeedlpagentservice.*?start.*?disabled")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and ( rlike(lower(commandline),"stop.*?(mcafeedlpagentservice|sc\.exe)") or rlike(lower(commandline),"config.*?mcafeedlpagentservice.*?start.*?disabled")) | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like "%mpcmdrun%-removedefinitions%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like "%mpcmdrun%-removedefinitions%" |  groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and lower(parentcommandline) like "%appcmd%set config%section:httplogging%dontlog:true%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and and (lower(commandline) like "%appcmd%set config%section:httplogging%dontlog:true%" or lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%" ) | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Remove-Item%$env:TEMP%windows-credentials.txt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Remove-Item%$env:TEMP%windows-credentials.txt%' | groupby user,system

stream=ep-process where action='PROCESS_ADDED' and image='net.exe' and (commandline like '%group%' or commandline like '%Domain%Admins%' or commandline like '%delete%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image='net.exe' and (commandline like '%group%' or commandline like '%Domain%Admins%' or commandline like '%delete%') | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and ( rlike(lower(commandline),"stop.*?(mcafeedlpagentservice|sc\.exe)") or rlike(lower(commandline),"config.*?mcafeedlpagentservice.*?start.*?disabled")) | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and ( rlike(lower(commandline),"stop.*?(mcafeedlpagentservice|sc\.exe)") or rlike(lower(commandline),"config.*?mcafeedlpagentservice.*?start.*?disabled")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%jsc.exe%' or commandline like '%.js%' or commandline like '%Library.dll%') | groupby system, user, commandline

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%jsc.exe%' or commandline like '%.js%' or commandline like '%Library.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%msbuild.exe%' or commandline like '%.csproj%' or commandline like '%vb.xml%') | groupby system, user, commandline

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%msbuild.exe%' or commandline like '%.csproj%' or commandline like '%vb.xml%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'((copy|ren|rename-item).*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe|lsm\.exe)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'((copy|ren|rename-item).*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe|lsm\.exe)') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m


stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Remove-Item%$env:TEMP%windows-credentials.txt%' | groupby user,system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Remove-Item%$env:TEMP%windows-credentials.txt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Remove-Item%$env:TEMP%windows-credentials.txt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Remove-Item%$env:TEMP%windows-credentials.txt%' | groupby user,system

stream=win-audit where action='PROCESS_CREATED' and commnadline like '%powershell%UseBasicParsing%Get-PasswordVaultCredentials%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commnadline like '%powershell%UseBasicParsing%Get-PasswordVaultCredentials%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commnadline like '%powershell%UseBasicParsing%Get-PasswordVaultCredentials%' | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'(expand-archive|tar -xf).*?\.zip') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'(expand-archive|tar -xf).*?\.zip') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%msbuild.exe%' or commandline like '%.csproj%' or commandline like '%vb.xml%') | groupby system, user, commandline

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%msbuild.exe%' or commandline like '%.csproj%' or commandline like '%vb.xml%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%WinPwn.ps1%printercheck%' | groupby system, user

stream=auditbeat

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%WinPwn.ps1%printercheck%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline),"(stop\-service|start\-service).*?\-name") | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline),"(stop\-service|start\-service).*?\-name") and user='{SUspectUser}' and system='{TragetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline),"(stop\-service|start\-service).*?\-name") | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline),"(stop\-service|start\-service).*?\-name") and user="{SuspectUser}" and system="{TragetHost}" | duration 6m

stream=iam where action='USER_ENABLED' and TargetUser='Guest' and user='{SuspectUser}' and targetuser='{TargetUser}' | duration 6m

stream=iam where action='USER_ENABLED' and TargetUser='Guest' | groupby user, TargetUser

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%cscript.exe%C:%Windows%System32%Printing_Admin_Scripts%en-US%pubprn.vbs localhost%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%cscript.exe%C:%Windows%System32%Printing_Admin_Scripts%en-US%pubprn.vbs localhost%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%CreateProcess.cs%' or parentcommandline like '%Get-System%CreateProcess%Get-CreateProcessSystem.ps1%' or parentcommandline like '%Get-System%CreateProcess%Get-CreateProcessSystemBind.ps1%' or parentcommandline like '%Get-System%NamedPipe%NamedPipeSystem.ps1' |  groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%Get-WMIObject%Win32_PnPEntity%' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%eventvwr%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%eventvwr%" | groupby user, system 

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%Get-WMIObject%Win32_PnPEntity%' | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%Get-WMIObject%Win32_PnPEntity%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%WinPwn.ps1%printercheck%' | groupby system, user

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%WinPwn.ps1%printercheck%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=iam where action='USER_ENABLED' and TargetUser='Guest' | groupby user, TargetUser

stream=iam where action='USER_ENABLED' and TargetUser='Guest' and user='{SuspectUser}' and targetuser='{TargetUser}' | duration 6m

stream=iam where action='USER_ENABLED' and targetuser='Guest' and user='{SuspectUser}' and targetuser='{TargetUser}' | duration 6m

stream=iam where action='USER_ENABLED' and targetuser='Guest' | groupby user, targetuser

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%cscript.exe%C:\Windows%System32%Printing_Admin_Scripts%en-US%pubprn.vbs localhost%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%cscript.exe%C:\Windows%System32%Printing_Admin_Scripts%en-US%pubprn.vbs localhost%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%CreateProcess.cs%' or parentcommandline like '%Get-System%CreateProcess%Get-CreateProcessSystem.ps1%' or parentcommandline like '%Get-System%CreateProcess%Get-CreateProcessSystemBind.ps1%' or parentcommandline like '%Get-System%NamedPipe%NamedPipeSystem.ps1' |  groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%CreateProcess.cs%' or parentcommandline like '%Get-System%CreateProcess%Get-CreateProcessSystem.ps1%' or parentcommandline like '%Get-System%CreateProcess%Get-CreateProcessSystemBind.ps1%' or parentcommandline like '%Get-System%NamedPipe%NamedPipeSystem.ps1' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%CreateProcess.cs%' or parentcommandline like '%Get-System%CreateProcess%Get-CreateProcessSystem.ps1%' or parentcommandline like '%Get-System%CreateProcess%Get-CreateProcessSystemBind.ps1%' or parentcommandline like '%Get-System%NamedPipe%NamedPipeSystem.ps1' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%CreateProcess.cs%' or parentcommandline like '%Get-System%CreateProcess%Get-CreateProcessSystem.ps1%' or parentcommandline like '%Get-System%CreateProcess%Get-CreateProcessSystemBind.ps1%' or parentcommandline like '%Get-System%NamedPipe%NamedPipeSystem.ps1' |  groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%tshark.exe%-i Ethernet%-c 5%' | select user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%tshark.exe%-i Ethernet%-c 5%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like "%software%classes%shell%open%command%" and rlike(lower(commandline),"(eventvwr|sdclt|fodhelper)") and user='{SuspectUser}' and commandline='{SuspectObject}' and system='{TargetSystem}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like "%software%classes%shell%open%command%" and rlike(lower(commandline),"(eventvwr|sdclt|fodhelper)") | groupby user, system, commandline

stream=iam where action='USER_ADDED' and group='Administrators' | groupby user, group

stream=iam where action='USER_ADDED' and group='Administrators' and user='{SuspectUser}' and user='{SuspectUser}' and group='{TargetUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%cscript.exe%C:\Windows%System32%Printing_Admin_Scripts%en-US%pubprn.vbs localhost%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%cscript.exe%C:\Windows%System32%Printing_Admin_Scripts%en-US%pubprn.vbs localhost%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%cscript.exe%C:%Windows%System32%Printing_Admin_Scripts%en-US%pubprn.vbs localhost%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%cscript.exe%C:%Windows%System32%Printing_Admin_Scripts%en-US%pubprn.vbs localhost%' | groupby user, system

stream=CONFIGURATION where action='CONFIGURATION_CHANGED' and ((lower(commandline) like "%csuninstalltool%quiet%") or (lower(commandline) like "%windowssensor%uninstall%quiet%")) and user="{SupectUser}" and system='{TargetHost}' | duration 6m

stream=CONFIGURATION where action='CONFIGURATION_CHANGED' and ((lower(commandline) like "%csuninstalltool%quiet%") or (lower(commandline) like "%windowssensor%uninstall%quiet%")) | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%CreateProcess.cs%' or parentcommandline like '%Get-System%CreateProcess%Get-CreateProcessSystem.ps1%' or parentcommandline like '%Get-System%CreateProcess%Get-CreateProcessSystemBind.ps1%' or parentcommandline like '%Get-System%NamedPipe%NamedPipeSystem.ps1' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%CreateProcess.cs%' or parentcommandline like '%Get-System%CreateProcess%Get-CreateProcessSystem.ps1%' or parentcommandline like '%Get-System%CreateProcess%Get-CreateProcessSystemBind.ps1%' or parentcommandline like '%Get-System%NamedPipe%NamedPipeSystem.ps1' |  groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%tshark.exe%-i Ethernet%-c 5%' | select user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%tshark.exe%-i Ethernet%-c 5%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like "%eventvwr%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like "%eventvwr%" | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),"(net.*?user|wmic.*?useraccount.*?get|powershell.*?(get-localuser|get-localgroupmember|get-wmiobject.*?-class.*?win32_useraccount|get-aduser)|lusrmgr|query.*?user|net.*?localgroup.*?administrators|net.*?group.*?administrators|net.*?group|net.*?accounts|net.*?localgroup|net.*?view|dsquery.*?user|dsget.*?user|reg.*?query.*?profilelist)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),"(net.*?user|wmic.*?useraccount.*?get|powershell.*?(get-localuser|get-localgroupmember|get-wmiobject.*?-class.*?win32_useraccount|get-aduser)|lusrmgr|query.*?user|net.*?localgroup.*?administrators|net.*?group.*?administrators|net.*?group|net.*?accounts|net.*?localgroup|net.*?view|dsquery.*?user|dsget.*?user|reg.*?query.*?profilelist)") | groupby user, system

stream=iam where action='USER_ADDED' and group='Administrators' | groupby user, group

stream=iam where action='USER_ADDED' and group='Administrators' and user='{SuspectUser}' and user='{SuspectUser}' and group='{TargetUser}' | duration 6m

stream=CONFIGURATION where action='CONFIGURATION_CHANGED' and ((lower(commandline) like "%csuninstalltool%quiet%") or (lower(commandline) like "%windowssensor%uninstall%quiet%")) | groupby system

stream=CONFIGURATION where action='CONFIGURATION_CHANGED' and ((lower(commandline) like "%csuninstalltool%quiet%") or (lower(commandline) like "%windowssensor%uninstall%quiet%")) and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%remove-antiphishrule%" or lower(commandline) like "%disable-antiphishrule%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%remove-antiphishrule%" or lower(commandline) like "%disable-antiphishrule%") | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline), "backstab.*?(mssense\.exe|msmpeng\.exe)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline), "backstab.*?(mssense\.exe|msmpeng\.exe)") | groupby user, system

stream=CONFIGURATION where action="CONFIGURATION_CHANGED" and rlike(lower(commandline),"set\-mppreference.*?(DisableRealtimeMonitoring|DisableBehaviorMonitoring|DisableBlockAtFirstSeen|DisableScriptScanning|drtm|dbm|dscrptsc|dbaf).*?true") | groupby system 

stream=CONFIGURATION where action="CONFIGURATION_CHANGED" and rlike(lower(commandline),"set\-mppreference.*?(DisableRealtimeMonitoring|DisableBehaviorMonitoring|DisableBlockAtFirstSeen|DisableScriptScanning|drtm|dbm|dscrptsc|dbaf).*?true") and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Import-Module ADFS%Get-AdfsCertificate -CertificateType Token-Signing%' or commandline like '%Import-Module ADFS%Get-AdfsCertificate -CertificateType Token-Decrypting%' or commandline like '%Import%Module%AADInternals%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%Import-Module%AADInternals%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=CONFIGURATION where action="CONFIGURATION_CHANGED" and rlike(lower(commandline),"set\-mppreference.*?(DisableRealtimeMonitoring|DisableBehaviorMonitoring|DisableBlockAtFirstSeen|DisableScriptScanning|drtm|dbm|dscrptsc|dbaf).*?true") | groupby system  | duration 15m

stream=CONFIGURATION where action="CONFIGURATION_CHANGED" and rlike(lower(commandline),"set\-mppreference.*?(DisableRealtimeMonitoring|DisableBehaviorMonitoring|DisableBlockAtFirstSeen|DisableScriptScanning|drtm|dbm|dscrptsc|dbaf).*?true") and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%tshark.exe%-i Ethernet%-c%5%' | select user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%tshark.exe%-i Ethernet%-c%5%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%Get-WMIObject%Win32_PnPEntity%' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%eventvwr%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%eventvwr%" | groupby user, system | duration 1h

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%Get-WMIObject%Win32_PnPEntity%' | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%Get-WMIObject%Win32_PnPEntity%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'powershell.exe.*?(enable-psremoting|enable-psremoting.*?whoami|evil-winrm|schtasks.exe|gpedit.msc)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'powershell.exe.*?(enable-psremoting|enable-psremoting.*?whoami|evil-winrm|schtasks.exe|gpedit.msc)') | groupby user, system 

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%Get-WMIObject%Win32_PnPEntity%' | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%Get-WMIObject%Win32_PnPEntity%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%WinPwn.ps1%printercheck%' | groupby system, user

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%WinPwn.ps1%printercheck%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=other where devsrcip='114.143.64.202' | limit 1

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(newprocessname), "(pcalua.exe|forfiles.exe|conhost.exe)") and (lower(commandline) like  "%pcalua%-a%" or lower(commandline) like  "%forfiles%/c%" or lower(commandline) like  "%conhost%") | duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(namedpipes_executor|namedpipes_server|namedpipes_client).*?--(pipe|server|client)' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(namedpipes_executor|namedpipes_server|namedpipes_client).*?--(pipe|server|client)' | groupby user, system

stream=win-audit where (scriptblocktext like '%PPID-Spoof%-ppid%-spawnto%.exe%-dllpath%.dll%' or commandline like '%powershell -ep bypass%wget%Import-Module%CreateProcessFromParent%.exe%') | groupby user, system, commandline, scriptblocktext

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%PPID-Spoof%-ppid%-spawnto%.exe%-dllpath%.dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED' , 'OBJECT_ACCESSED') and ((lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(commandline) like '%class%win32_logicaldisk%new-item%itemtype%') or (lower(scriptblocktext) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(scriptblocktext) like '%class%win32_logicaldisk%new-item%itemtype%')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED' , 'OBJECT_ACCESSED') and ((lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(commandline) like '%class%win32_logicaldisk%new-item%itemtype%') or (lower(scriptblocktext) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(scriptblocktext) like '%class%win32_logicaldisk%new-item%itemtype%')) | groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%wmic process list%FORMAT:%wmicscript.xsl%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%wmic process list%FORMAT:%wmicscript.xsl%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%wmic process list%FORMAT:%wmicscript.xsl%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%wmic process list%FORMAT:%wmicscript.xsl%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%wmic process list%FORMAT:%wmicscript.xsl%' or commandline like '%wmic os get%FORMAT:%https%xsl') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%wmic process list%FORMAT:%wmicscript.xsl%' or commandline like '%wmic os get%FORMAT:%https%xsl') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%wmic process list%FORMAT:%wmicscript.xsl%' or commandline like '%wmic os get%FORMAT:%https%xsl') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%wmic process list%FORMAT:%wmicscript.xsl%' or commandline like '%wmic os get%FORMAT:%https%xsl') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'(namedpipes_executor|namedpipes_server|namedpipes_client).*?--(pipe|server|client)' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'(namedpipes_executor|namedpipes_server|namedpipes_client).*?--(pipe|server|client)' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED'  and (commandline like '%tasklist%' or commandline like '%tasklist%lsass%' or commandline like '%Get-Process%' or commandline like '%get-wmiObject%Win32_Process%' or commandline like '%wmic%process%') and system='{TargetHost}' and commandline='{TargetObject}' | duration 6m

stream=ep-process where action='PROCESS_ADDED'  and (commandline like '%tasklist%' or commandline like '%tasklist%lsass%' or commandline like '%Get-Process%' or commandline like '%get-wmiObject%Win32_Process%' or commandline like '%wmic%process%') | groupby system, user 

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%findstr%cpassword %logonserver%sysvol%.xml%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%findstr%cpassword %logonserver%sysvol%.xml%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%findstr%cpassword %logonserver%sysvol%.xml%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%findstr%cpassword %logonserver%sysvol%.xml%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(procdump.*?-accepteula\s+(-ma|-mm).*?lsass.exe|rundll32.*?c:.*?windows.*?system32.*?comsvcs.dll.*?minidump.*?get-process\s+lsass.*?full|dumpert.exe|nanodump.x64.exe\s+-w|pypykatz.*?live\s+lsa|get-process\s+lsass.*?out-minidump|-u\s+-f.*?dotnet-lsass.dmp.*?get-process\s+lsass.*?id|xordump.*?-out.*?-x\s+0x41|rdrleakdiag|nanodump.x64.exe --silent-process-exit)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(procdump.*?-accepteula\s+(-ma|-mm).*?lsass.exe|rundll32.*?c:.*?windows.*?system32.*?comsvcs.dll.*?minidump.*?get-process\s+lsass.*?full|dumpert.exe|nanodump.x64.exe\s+-w|pypykatz.*?live\s+lsa|get-process\s+lsass.*?out-minidump|-u\s+-f.*?dotnet-lsass.dmp.*?get-process\s+lsass.*?id|xordump.*?-out.*?-x\s+0x41|rdrleakdiag|nanodump.x64.exe --silent-process-exit)') | groupby user, system

stream=ep-process where action='PROCESS_ADDED'  and (commandline like '%tasklist%' or commandline like '%tasklist%lsass%' or commandline like '%Get-Process%' or commandline like '%get-wmiObject%Win32_Process%' or commandline like '%wmic%process%') and system='{TargetHost}' and commandline='{TargetObject}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%tasklist%' or commandline like '%tasklist%lsass%' or commandline like '%Get-Process%' or commandline like '%get-wmiObject%Win32_Process%' or commandline like '%wmic%process%') | groupby system, user 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%tasklist%' or commandline like '%tasklist%lsass%' or commandline like '%Get-Process%' or commandline like '%get-wmiObject%Win32_Process%' or commandline like '%wmic%process%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%tasklist%' or commandline like '%tasklist%lsass%' or commandline like '%Get-Process%' or commandline like '%get-wmiObject%Win32_Process%' or commandline like '%wmic%process%') | groupby system, user 

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like 'msxslxmlfile.xml' or commandline like 'msxslscript.xsl' or commandline like 'msxsl.exe') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like 'msxslxmlfile.xml' or commandline like 'msxslscript.xsl' or commandline like 'msxsl.exe') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Remove-Item%$env:TEMP%windows-credentials.txt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Remove-Item%$env:TEMP%windows-credentials.txt%' | groupby user,system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Get-GPPPassword -Verbose%' or commandline like '%Get-GPPPassword.ps1%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Get-GPPPassword -Verbose%' or commandline like '%Get-GPPPassword.ps1%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Get-GPPPassword -Verbose%' or commandline like '%Get-GPPPassword.ps1%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Get-GPPPassword -Verbose%' or commandline like '%Get-GPPPassword.ps1%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%findstr%cpassword %logonserver%sysvol%.xml%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%findstr%cpassword %logonserver%sysvol%.xml%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower (commandline) like '%c:\windows\system32\%%crypto::%certificates%/system%export%systemstore:local_machine%' or lower (commandline) like '%crypto::%certificates%/export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 31m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower (commandline) like '%c:\windows\system32\%%crypto::%certificates%/system%export%systemstore:local_machine%' or lower (commandline) like '%crypto::%certificates%/export%') | groupby user,system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like 'msxslxmlfile.xml' or commandline like 'msxslscript.xsl' or commandline like 'msxsl.exe') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like 'msxslxmlfile.xml' or commandline like 'msxslscript.xsl' or commandline like 'msxsl.exe') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like 'msxslxmlfile.xml' or commandline like 'msxslscript.xsl' or commandline like 'msxsl.exe') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like 'msxslxmlfile.xml' or commandline like 'msxslscript.xsl' or commandline like 'msxsl.exe') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like 'msxslxmlfile.xml' or commandline like 'msxslscript.xsl' or commandline like 'msxsl.exe') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like 'msxslxmlfile.xml' or commandline like 'msxslscript.xsl' or commandline like 'msxsl.exe') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%findstr%cpassword %logonserver%sysvol%.xml%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%findstr%cpassword %logonserver%sysvol%.xml%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=otherstream=WIN-AUDIT where action='PROCESS_CREATED' and sourcename='WINDOWS' and commandline like '%Inveigh%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'powershell.exe.*?(enable-psremoting|enable-psremoting.*?whoami|evil-winrm|schtasks.exe|gpedit.msc)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'powershell.exe.*?(enable-psremoting|enable-psremoting.*?whoami|evil-winrm|schtasks.exe|gpedit.msc)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg query HKLM%f%password%t%REG_SZ%' or commandline like '%reg query HKCU%f%password%t%REG_SZ%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg query HKLM%f%password%t%REG_SZ%' or commandline like '%reg query HKCU%f%password%t%REG_SZ%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "nslookup.*?(_ldap._tcp.dc._msdcs|nameserver=|server=)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "nslookup.*?(_ldap._tcp.dc._msdcs|nameserver=|server=)")) | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like 'msxslxmlfile.xml' or commandline like 'msxslscript.xsl' or commandline like 'msxsl.exe') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like 'msxslxmlfile.xml' or commandline like 'msxslscript.xsl' or commandline like 'msxsl.exe') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Get-GPPPassword -Verbose%' or commandline like '%Get-GPPPassword.ps1%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Get-GPPPassword -Verbose%' or commandline like '%Get-GPPPassword.ps1%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg query HKLM%f%password%t%REG_SZ%' or commandline like '%reg query HKCU%f%password%t%REG_SZ%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg query HKLM%f%password%t%REG_SZ%' or commandline like '%reg query HKCU%f%password%t%REG_SZ%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%reg query HKLM%f%password%t%REG_SZ%' or commandline like '%reg query HKCU%f%password%t%REG_SZ%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%reg query HKLM%f%password%t%REG_SZ%' or commandline like '%reg query HKCU%f%password%t%REG_SZ%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%reg query HKCU%Software%PuTTY%Sessions%t%REG_SZ%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%reg query HKCU%Software%PuTTY%Sessions%t%REG_SZ%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (scriptblocktext like '%PPID-Spoof%-ppid%-spawnto%.exe%-dllpath%.dll%' or commandline like '%powershell -ep bypass%wget%Import-Module%CreateProcessFromParent%.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (scriptblocktext like '%PPID-Spoof%-ppid%-spawnto%.exe%-dllpath%.dll%' or commandline like '%powershell -ep bypass%wget%Import-Module%CreateProcessFromParent%.exe%') | groupby user, system, commandline, scriptblocktext

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Get%Process%explorer%spawnto%iexplore.exe%dllpath%calc.dll%'and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Get%Process%explorer%spawnto%iexplore.exe%dllpath%calc.dll%' | groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Get%Process%explorer%spawnto%iexplore.exe%dllpath%calc.dll%'and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Get%Process%explorer%spawnto%iexplore.exe%dllpath%calc.dll%' | groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%directoryservices.directorysearcher%ObjectCategory=Computer%' or lower(commandline) like '%get-adcomputer%' or lower(commandline) like '%adsisearcher%objectcategory=computer%')  | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%directoryservices.directorysearcher%ObjectCategory=Computer%' or lower(commandline) like '%get-adcomputer%' or lower(commandline) like '%adsisearcher%objectcategory=computer%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%iex%invoke%inveigh%nbns%mdns%') or (commandline like '%HKLM%Software%Policies%Microsoft%Windows NT%DNSClient%')) | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%iex%invoke%inveigh%nbns%mdns%') or (commandline like '%HKLM%Software%Policies%Microsoft%Windows NT%DNSClient%')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' AND rlike(lower(commandline), "powerview.*?get-(domain|forest)trust") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' AND rlike(lower(commandline), "powerview.*?get-(domain|forest)trust") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Get%Process%explorer%spawnto%iexplore.exe%dllpath%calc.dll%' | groupby user, system, commandline

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Get%Process%explorer%spawnto%iexplore.exe%dllpath%calc.dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%PetitPotam%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%PetitPotam%' | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%PetitPotam%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%PetitPotam%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powershell.exe%remotefxvgpudisablement%' or lower(commandline) like '%remotefxvgpudisablement%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powershell.exe%remotefxvgpudisablement%' or lower(commandline) like '%remotefxvgpudisablement%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%hkcu%software%microsoft%windows%control.exe%' | duration 5m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(procdump.*?-accepteula\s+(-ma|-mm).*?lsass.exe|rundll32.*?c:.*?windows.*?system32.*?comsvcs.dll.*?minidump.*?get-process\s+lsass.*?full|dumpert.exe|nanodump.x64.exe\s+-w|pypykatz.*?live\s+lsa|get-process\s+lsass.*?out-minidump|-u\s+-f.*?dotnet-lsass.dmp.*?get-process\s+lsass.*?id|xordump.*?-out.*?-x\s+0x41|rdrleakdiag|nanodump.x64.exe --silent-process-exit)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(procdump.*?-accepteula\s+(-ma|-mm).*?lsass.exe|rundll32.*?c:.*?windows.*?system32.*?comsvcs.dll.*?minidump.*?get-process\s+lsass.*?full|dumpert.exe|nanodump.x64.exe\s+-w|pypykatz.*?live\s+lsa|get-process\s+lsass.*?out-minidump|-u\s+-f.*?dotnet-lsass.dmp.*?get-process\s+lsass.*?id|xordump.*?-out.*?-x\s+0x41|rdrleakdiag|nanodump.x64.exe --silent-process-exit)') | groupby user, system

stream=win-audit where eventid='4688' and (commandline like '%ADFS%' or commandline like '%ADFSDump%') and (commandline like '%Get-ADFSCertificate%' or commandline like '%Export-ADFSCertificate%')

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%PPID-Spoof%-ppid%-spawnto%.exe%-dllpath%.dll%' or parentcommandline like '%powershell -ep bypass%wget%Import-Module%CreateProcessFromParent%.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%PPID-Spoof%-ppid%-spawnto%.exe%-dllpath%.dll%' or parentcommandline like '%powershell -ep bypass%wget%Import-Module%CreateProcessFromParent%.exe%') | groupby user, system, parentcommandline 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Get%Process%explorer%spawnto%iexplore.exe%dllpath%calc.dll%' | groupby user, system, commandline

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Get%Process%explorer%spawnto%iexplore.exe%dllpath%calc.dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and newprocessname like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and newprocessname like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(parentprocessname),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(parentprocessname),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") | groupby user, system

stream=EP-FILE where rlike(lower(targetfilename),"\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") and targetfilename="{SuspectObject}" and user="{SuspectUser}" and system="{TargetHost}" | duraton 6m

stream=EP-FILE where rlike(lower(targetfilename),"\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") | groupby substring_index(targetfilename,"\\",-1), targetfilename, user, system | select substring_index(targetfilename,"\\",-1) as file, targetfilename, user, system | duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(procdump.*?-accepteula\s+(-ma|-mm).*?lsass.exe|rundll32.*?c:.*?windows.*?system32.*?comsvcs.dll.*?minidump.*?get-process\s+lsass.*?full|dumpert.exe|nanodump.x64.exe\s+-w|pypykatz.*?live\s+lsa|get-process\s+lsass.*?out-minidump|-u\s+-f.*?dotnet-lsass.dmp.*?get-process\s+lsass.*?id|xordump.*?-out.*?-x\s+0x41|rdrleakdiag|nanodump.x64.exe --silent-process-exit)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(procdump.*?-accepteula\s+(-ma|-mm).*?lsass.exe|rundll32.*?c:.*?windows.*?system32.*?comsvcs.dll.*?minidump.*?get-process\s+lsass.*?full|dumpert.exe|nanodump.x64.exe\s+-w|pypykatz.*?live\s+lsa|get-process\s+lsass.*?out-minidump|-u\s+-f.*?dotnet-lsass.dmp.*?get-process\s+lsass.*?id|xordump.*?-out.*?-x\s+0x41|rdrleakdiag|nanodump.x64.exe --silent-process-exit)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and commandline like '%Get-CimInstance%Name%.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' | groupby system, commandline

stream=configuration where action='CONFIGURATION_CHANGED' and commandline like '%Get-CimInstance%Name%.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Get%Process%explorer%spawnto%iexplore.exe%dllpath%calc.dll%'and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Get%Process%explorer%spawnto%iexplore.exe%dllpath%calc.dll%' | groupby user, system, commandline

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' | groupby user, system | duration 15m

stream=EP-PROCESS where action='PROCESS_ADDED' and newprocessname like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%Get%Process%explorer%spawnto%iexplore.exe%dllpath%calc.dll%' | groupby user, system, commandline 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Get%Process%explorer%spawnto%iexplore.exe%dllpath%calc.dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and newprocessname like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and newprocessname like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%iex(new-object net.webclient).downloadstring%Invoke-Internalmonologue%' | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%iex(new-object net.webclient).downloadstring%Invoke-Internalmonologue%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and parentcommandline like '%iex(new-object net.webclient).downloadstring%Invoke-Internalmonologue%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and parentcommandline like '%iex(new-object net.webclient).downloadstring%Invoke-Internalmonologue%' | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%PetitPotam%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%PetitPotam%' | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%powershell.exe%%new-selfsignedcertificate%export-certificate%') | duration 10m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%powershell.exe%%new-selfsignedcertificate%export-certificate%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=configuration where action='CONFIGURATION_CHANGED' and commandline like '%Get-CimInstance%Name%svchost.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and commandline like '%Get-CimInstance%Name%svchost.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' | groupby system, commandline

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%iex(new-object net.webclient).downloadstring%Invoke-Internalmonologue%' | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%iex(new-object net.webclient).downloadstring%Invoke-Internalmonologue%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' | groupby user, system | duration 1d

stream=WIN-AUDIT where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%inveigh%nbns%mdns%') or (lower(commandline) like '%hklm%software%policies%microsoft%windows nt%dnsclient%')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%inveigh%nbns%mdns%') or (lower(commandline) like '%hklm%software%policies%microsoft%windows nt%dnsclient%')) | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%rar.exe%' or commandline like '%winrar.exe%' or commandline like '%winzip64.exe%' or commandline like '%7z.exe%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%rar.exe%' or commandline like '%winrar.exe%' or commandline like '%winzip64.exe%' or commandline like '%7z.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=other | duration 5m | select "10.88.102.190" as Value | limit 1

stream=EP-PROCESS where action='PROCESS_ADDED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%inveigh%nbns%mdns%') or (lower(commandline) like '%hklm%software%policies%microsoft%windows nt%dnsclient%')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%inveigh%nbns%mdns%') or (lower(commandline) like '%hklm%software%policies%microsoft%windows nt%dnsclient%')) | groupby user, system | duration 2h

stream=EP-FILE where action="FILE_CREATED" and rlike(lower(targetfilename),"\\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") | groupby substring_index(targetfilename,"\\",-1), targetfilename, user, system | select substring_index(targetfilename,"\\",-1) as file, targetfilename, user, system 

stream=EP-FILE where action="FILE_CREATED" and rlike(lower(targetfilename),"\\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") and targetfilename="{SuspectObject}" and user="{SuspectUser}" and system="{TargetHost}" | duraton 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adfind.*s.*base.*(lockoutduration|lockoutthreshold|lockoutobservationwindow|maxpwdage|minpwdage|minpwdlength|pwdhistorylength|pwdproperties)') or lower(commandline) like '%adfind%-sc admincountdmp%' or lower(commandline) like '%adfind%-f%objectcategory=person%' or lower(commandline) like '%adfind%-sc exchaddresses%' or lower(commandline) like '%adfind%-f%objectcategory=person%objectclass=user%memberof=cn=administrators%' or lower(commandline) like '%adfind%-f%objectcategory=group%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adfind.*s.*base.*(lockoutduration|lockoutthreshold|lockoutobservationwindow|maxpwdage|minpwdage|minpwdlength|pwdhistorylength|pwdproperties)') or lower(commandline) like '%adfind%-sc admincountdmp%' or lower(commandline) like '%adfind%-f%objectcategory=person%' or lower(commandline) like '%adfind%-sc exchaddresses%' or lower(commandline) like '%adfind%-f%objectcategory=person%objectclass=user%memberof=cn=administrators%' or lower(commandline) like '%adfind%-f%objectcategory=group%') | groupby user, system

stream=win-audit where (newprocessname like "%attrib.exe" and (commandline like '%+h%' or commandline like '%+s%')) | groupby user, system | duration 5h

stream=win-audit where (newprocessname like "%attrib.exe" and (commandline like '%+h%' or commandline like '%+s%')) | groupby user, system 

stream=win-audit where (newprocessname like "%attrib.exe" and (commandline like '%+h%' or commandline like '%+s%'))  and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where (commandline like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or commandline like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or commandline like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or commandline like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') or (scriptblocktext like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or scriptblocktext like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or scriptblocktext like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or scriptblocktext like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') | select system, user

stream=other | select "10.88.102.190" as Value | limit 1

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%certutil%exportPFX%' or commandline like '%RemoteCertTrust.ps1%certutil.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%certutil%exportPFX%' or commandline like '%RemoteCertTrust.ps1%certutil.exe%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Import-Module ADFS%Get-AdfsCertificate -CertificateType Token-Signing%' or commandline like '%Import-Module ADFS%Get-AdfsCertificate -CertificateType Token-Decrypting%' or commandline like '%Import%Module%AADInternals%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%Import-Module%AADInternals%Export-AADIntADFSConfiguration%Export-AADIntADFSEncryptionKey%Export-AADIntADFSCertificates -Configuration%-Key%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or commandline like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or commandline like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or commandline like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') | select system, user

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or commandline like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or commandline like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or commandline like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or commandline like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or commandline like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or commandline like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%Winlogon%' and rlike(commandline, '(Shell|Userinit|Notify)\\.*?\.') | groupby system, user and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%Winlogon%' and rlike(commandline, '(Shell|Userinit|Notify)\\.*?\.') | groupby system, user

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%rar.exe%' or commandline like '%winrar.exe%' or commandline like '%winzip64.exe%' or commandline like '%7z.exe%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%rar.exe%' or commandline like '%winrar.exe%' or commandline like '%winzip64.exe%' or commandline like '%7z.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-REGISTRY where eid in ('12', '13', '14') and image like '%reg.exe' and targetobject like '%Hidden%' | duration 5h

stream=win-audit where action='PROCESS_CREATED' and commandline like '%net%time%w32tm%tz%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%crypto::%certificates%export%') | groupby user, system
 and user='{SuspectUser}' and system='{TargetHost}' | duration 31m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%crypto::%certificates%export%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Import-Module ADFS%Get-AdfsCertificate -CertificateType Token-Signing%' or commandline like '%Import-Module ADFS%Get-AdfsCertificate -CertificateType Token-Decrypting%' or commandline like '%Import%Module%AADInternals%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%Import-Module%AADInternals%Export-AADIntADFSConfiguration%Export-AADIntADFSEncryptionKey%Export-AADIntADFSCertificates -Configuration%-Key%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Import-Module ADFS%Get-AdfsCertificate -CertificateType Token-Signing%' or commandline like '%Import-Module ADFS%Get-AdfsCertificate -CertificateType Token-Decrypting%' or commandline like '%Import%Module%AADInternals%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%Import-Module%AADInternals%Export-AADIntADFSConfiguration%Export-AADIntADFSEncryptionKey%Export-AADIntADFSCertificates -Configuration%-Key%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%Winlogon%' and rlike(commandline, '(Shell|Userinit|Notify)\\.*?\.') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%Winlogon%' and rlike(commandline, '(Shell|Userinit|Notify)\\.*?\.') | groupby system, user and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%rar.exe%' or commandline like '%winrar.exe%' or commandline like '%winzip64.exe%' or commandline like '%7z.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%rar.exe%' or commandline like '%winrar.exe%' or commandline like '%winzip64.exe%' or commandline like '%7z.exe%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or commandline like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or commandline like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or commandline like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or commandline like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or commandline like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or commandline like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') | groupby system, user

stream=win-audit where (newprocessname like "%attrib.exe" and (commandline like '%+h%' or commandline like '%+s%')) and eid='4688' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where (newprocessname like "%attrib.exe" and (commandline like '%+h%' or commandline like '%+s%')) and eid='4688' | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%c:\windows\system32\%crypto::%certificates%/system%export%systemstore:local_machine%') or (lower(commandline) like '%crypto::%certificates%/export%') | groupby user,system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%c:\windows\system32\%crypto::%certificates%/system%export%systemstore:local_machine%') or (lower(commandline) like '%crypto::%certificates%/export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 31m

stream=authentication |   duration 1h | select "102.216.84.42" as IP | LIMIT 1

stream=authentication | select "122.162.148.33" as IP | limit 1

stream=other | duration 5m | select "ameer.patel" as user | limit 1

stream=other | duration 5m | select "nitin.udari" as user | limit 1

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((import-module|invoke).*?powerdump|get-passhashes|hashdump)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((import-module|invoke).*?powerdump|get-passhashes|hashdump)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'reg add.*?hklm.*?system.*?currentcontrolset.*?control.*?monitor.*?bin.*?\..*?reg_sz') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'reg add.*?hklm.*?system.*?currentcontrolset.*?control.*?monitor.*?bin.*?\..*?reg_sz') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%TokenSet%Get-Random%InputObject%rad%$rad%whoami.exe%$env:temp%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%TokenSet%Get-Random%InputObject%rad%$rad%whoami.exe%$env:temp%' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like "%csc.exe%target:exe%" or commandline like "%csc.exe%code%" or commandline like "%csc.exe%out%") | groupby system, user 

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like "%csc.exe%target:exe%" or commandline like "%csc.exe%code%" or commandline like "%csc.exe%out%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and parentcommandline like '%TokenSet%Get-Random%InputObject%rad%$rad%whoami.exe%$env:temp%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and parentcommandline like '%TokenSet%Get-Random%InputObject%rad%$rad%whoami.exe%$env:temp%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and parentcommandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' | groupby user, system, logevent

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and parentimage like '%powershell.exe%' and parentcommandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and parentimage like '%powershell.exe%' and parentcommandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' | groupby user, system  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'((copy|ren|rename-item).*?system32.*?\.exe.*?(appdata|systemroot).*?\.exe') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'((copy|ren|rename-item).*?system32.*?\.exe.*?(appdata|systemroot).*?\.exe') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and parentprocessname like '%powershell.exe%' and commandline like '%bitsadmin1_flag.ps1%'and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and parentprocessname like '%powershell.exe%' and commandline like '%bitsadmin1_flag.ps1%'| groupby system, user | duration 10m

stream=EP-PROCESS where action='PROCESS_ADDED' and parentimage like '%powershell.exe%' and parentcommandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and parentimage like '%powershell.exe%' and parentcommandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep_process where action='PROCESS_ADDED' and (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like'%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%'%Security Packages%') | groupby system, user

stream=ep_process where action='PROCESS_ADDED' and (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like'%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%'%Security Packages%') | groupby system, user

stream=ep_process where action='PROCESS_ADDED' and (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like'%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%'%Security Packages%') | groupby system, user

stream=ep_process where action='PROCESS_ADDED' and (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') | groupby system, user

stream=win-audit where (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') | groupby system, user

stream=ep_process where action='PROCESS_ADDED' and (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') | groupby system, user

stream=ep_process where action='PROCESS_ADDED' and (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') | groupby system, user

stream=win-audit where (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep_process where action='PROCESS_ADDED' and commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%dll%' | groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and parentprocessname like '%powershell.exe%' and commandline like '%bitsadmin.exe%' and commandline like '%transfer%' and commandline like '%Download%' and commandline like '%bitsadmin1_flag.ps1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and parentprocessname like '%powershell.exe%' and commandline like '%bitsadmin.exe%' and commandline like '%transfer%' and commandline like '%Download%' and commandline like '%bitsadmin1_flag.ps1%'| groupby system, user | duration 10m

stream=WIN-AUDIT where action='PROCESS_CREATED' and parentprocessname like '%powershell.exe%' and commandline like '%bitsadmin.exe%' and commandline like '%transfer%' and commandline like '%Download%' and commandline like '%bitsadmin1_flag.ps1%'| groupby system, user | duration 10m

stream=WIN-AUDIT where action='PROCESS_CREATED' and parentprocessname like '%powershell.exe%' and commandline like '%bitsadmin.exe%' and commandline like '%transfer%' and commandline like '%Download%' and commandline like '%bitsadmin1_flag.ps1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%dll%' | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'bin.*?(\.|LaZagne.exe|LaZagne)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'bin.*?(\.|LaZagne.exe|LaZagne)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Opera%Stable%Login Data%' or commandline like '%Chrome%User Data%Default%Login Data%' or commandline like '%Mozilla%Firefox%' or commandline like '%Microsoft%Edge%User Data%' )  | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Opera%Stable%Login Data%' or commandline like '%Chrome%User Data%Default%Login Data%' or commandline like '%Mozilla%Firefox%' or commandline like '%Microsoft%Edge%User Data%' ) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where (newprocessname like "%gpg.exe" or newprocessname like "%gpg2.exe" or newprocessname like "%kleopatra.exe") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where (newprocessname like "%gpg.exe" or newprocessname like "%gpg2.exe" or newprocessname like "%kleopatra.exe") | groupby user, system

stream=EP-PROCESS where (image like "%gpg.exe%" or image like "%gpg2.exe%" or image like "%kleopatra.exe%") or (commandline like "%gpg.exe%" or commandline like "%gpg2.exe%" or commandline like "%kleopatra.exe%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where (image like "%gpg.exe%" or image like "%gpg2.exe%" or image like "%kleopatra.exe%") or (commandline like "%gpg.exe%" or commandline like "%gpg2.exe%" or commandline like "%kleopatra.exe%") | groupby user, system |  duration 3h

stream=EP-PROCESS where (image like "%gpg.exe%" or image like "%gpg2.exe%" or image like "%kleopatra.exe%") or (commandline like "%gpg.exe%" or commandline like "%gpg2.exe%" or commandline like "%kleopatra.exe%") | groupby user, system

stream=EP-PROCESS where (image like "%gpg.exe%" or image like "%gpg2.exe%" or image like "%kleopatra.exe%") or (commandline like "%gpg.exe%" or commandline like "%gpg2.exe%" or commandline like "%kleopatra.exe%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%dll%' | groupby system, user

stream=win-audit where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and commandline like '%Get-CimInstance%Name%svchost.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' | groupby user, system

stream=configuration where action='CONFIGURATION_CHANGED' and commandline like '%Get-CimInstance%Name%svchost.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and commandline like '%Get-CimInstance%Name%svchost.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and commandline like '%Get-CimInstance%Name%svchost.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' | groupby system, commandline

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%' or commandline like '%Start-Process%BadPotato%' or commandline like '%Start-Process%notepad%' or commandline like '%Stop-Process%BadPotato%' or commandline like '%Stop-Process%notepad%') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%' or commandline like '%Start-Process%BadPotato%' or commandline like '%Start-Process%notepad%' or commandline like '%Stop-Process%BadPotato%' or commandline like '%Stop-Process%notepad%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%' or commandline like '%Start-Process%BadPotato%' or commandline like '%Start-Process%notepad%' or commandline like '%Stop-Process%BadPotato%' or commandline like '%Stop-Process%notepad%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%' or commandline like '%Start-Process%BadPotato%' or commandline like '%Start-Process%notepad%' or commandline like '%Stop-Process%BadPotato%' or commandline like '%Stop-Process%notepad%') | groupby user, system

stream=EP-PROCESS where (image like "%gpg.exe" or image like "%gpg2.exe" or image like "%kleopatra.exe") | groupby user, system 

stream=EP-PROCESS where (image like "%gpg.exe" or image like "%gpg2.exe" or image like "%kleopatra.exe") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where (newprocessname like "%gpg.exe%" or newprocessname like "%gpg2.exe%" or newprocessname like "%kleopatra.exe%") | groupby user, system

stream=WIN-AUDIT where (newprocessname like "%gpg.exe%" or newprocessname like "%gpg2.exe%" or newprocessname like "%kleopatra.exe%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like '%reg.exe%' and lower(commandline) like '%hklm%software%microsoft%windows%currentversion%policies%system%enablelua%0%' | duration 15m | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like '%reg.exe%' and lower(commandline) like '%hklm%software%microsoft%windows%currentversion%policies%system%enablelua%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep_process where action='PROCESS_ADDED' and commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%dll%' | groupby system, user

stream=ep-pocess where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and commandline like '%powershell.exe%&%{$PWord%=%ConvertTo-SecureString%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and commandline like '%powershell.exe%&%{$PWord%=%ConvertTo-SecureString%' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") and user='{SuspectUser}' and system='{SuspectHost}' | duration 6m

stream=ep-process where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=ep-process where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") and user='{SuspectUser}' and system='{SuspectHost}' | duration 6m

stream=ep-process where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '%findstr%') | groupby 1d

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(targetobject), 'software.*?microsoft.*?office test.*?special.*?perf') | groupby user, system

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(targetobject), 'software.*?microsoft.*?office test.*?special.*?perf') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and parentprocessname like '%powershell.exe%' and commandline like '%bitsadmin.exe%transfer%Download%%bitsadmin1_flag.ps1%'| groupby system, user | duration 10m

stream=WIN-AUDIT where action='PROCESS_CREATED' and parentprocessname like '%powershell.exe%' and commandline like '%bitsadmin.exe%transfer%Download%%bitsadmin1_flag.ps1%'| groupby system, user | duration 10m and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%') | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%' or commandline like '%Start-Process%BadPotato%' or commandline like '%Start-Process%notepad%' or commandline like '%Stop-Process%BadPotato%' or commandline like '%Stop-Process%notepad%') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%' or commandline like '%Start-Process%BadPotato%' or commandline like '%Start-Process%notepad%' or commandline like '%Stop-Process%BadPotato%' or commandline like '%Stop-Process%notepad%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit,ep-process,configuration where action in ('PROCESS_CREATED', 'PROCESS_ADDED', 'CONFIGURATION_CHANGED') and rlike(lower(commandline), "(sc.*?(stop|config.*?windefend.*?start=.*?disabled|query).*?windefend|net.*?stop.*?windefend|reg.*?add.*?hkey_local_machine.*?system.*?currentcontrolset.*?services.*?windefend.*?/v.*?start.*?/t.*?reg_dword.*?/d.*?4.*?/f|schtasks.*?/change.*?/tn.*?microsoft.*?windows.*?windows.*?defender.*?windows.*?defender.*?(scheduled.*?scan|cache.*?maintenance|cleanup|verification).*?/disable|powershell\.exe.*?uninstall-windowsfeature.*?-name.*?windows-defender-features|(reg.*?add|set.*?itemproperty).*?(hkey_local_machine|hklm).*?software.*?policies.*?microsoft.*?windows.*?defender.*?(/v|name).*?disableantispyware.*?(/t.*?reg_dword.*?/d|value).*?1)") |  groupby user, system | duration 6h

stream=win-audit,ep-process,configuration where action in ('PROCESS_CREATED', 'PROCESS_ADDED', 'CONFIGURATION_CHANGED') and rlike(lower(commandline), "(sc.*?(stop|config.*?windefend.*?start=.*?disabled|query).*?windefend|net.*?stop.*?windefend|reg.*?add.*?hkey_local_machine.*?system.*?currentcontrolset.*?services.*?windefend.*?/v.*?start.*?/t.*?reg_dword.*?/d.*?4.*?/f|schtasks.*?/change.*?/tn.*?microsoft.*?windows.*?windows.*?defender.*?windows.*?defender.*?(scheduled.*?scan|cache.*?maintenance|cleanup|verification).*?/disable|powershell\.exe.*?uninstall-windowsfeature.*?-name.*?windows-defender-features|(reg.*?add|set.*?itemproperty).*?(hkey_local_machine|hklm).*?software.*?policies.*?microsoft.*?windows.*?defender.*?(/v|name).*?disableantispyware.*?(/t.*?reg_dword.*?/d|value).*?1)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%dll%' | groupby system, user

stream=win-audit where rlike(newprocessname, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=win-audit where rlike(newprocessname, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") and user='{SuspectUser}' and host='{SuspectHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, '(C.*\\.zip.*exe|C.*\\.rar.*exe|C.*\\.7z.*exe|C.*\\.tar.*exe|C.*\\.zip|C.*\\.rar|C.*\\.7z|C.*\\.tar)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, '(C.*\\.zip.*exe|C.*\\.rar.*exe|C.*\\.7z.*exe|C.*\\.tar.*exe|C.*\\.zip|C.*\\.rar|C.*\\.7z|C.*\\.tar)') |  groupby user, system 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?(screensaver|screensaveactive|screensavetimeout|screensaverissecure|scrnsave)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?(screensaver|screensaveactive|screensavetimeout|screensaverissecure|scrnsave)') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, '(C.*\\.zip.*exe|C.*\\.rar.*exe|C.*\\.7z.*exe|C.*\\.tar.*exe|C.*\\.zip|C.*\\.rar|C.*\\.7z|C.*\\.tar)') |  groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, '(C.*\\.zip.*exe|C.*\\.rar.*exe|C.*\\.7z.*exe|C.*\\.tar.*exe|C.*\\.zip|C.*\\.rar|C.*\\.7z|C.*\\.tar)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=ep-process where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where rlike(newprocessname, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=win-audit where rlike(newprocessname, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and event='Creating Scriptblock text' and scriptblocktext like '%$Action%=%New-ScheduledTaskAction%-Execute%\"calc.exe\"%$Trigger%=%New-ScheduledTaskTrigger%-AtLogon%$User%=%New-ScheduledTaskPrincipal%-GroupId%"BUILTIN%Administrators"%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet%$object$=$New-ScheduledTask%-Action%$Action%-Principal%$User$-Trigger%$Trigger%-Settings%$Set%Register-ScheduledTask%AtomicTask%-InputObject%$object%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and event='Creating Scriptblock text' and scriptblocktext like '%Action%=%New-ScheduledTaskAction%Execute%calc.exe%Trigger%New-ScheduledTaskTrigger%AtLogon%User%New-ScheduledTaskPrincipal%-GroupId%"BUILTIN%Administrators"%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet%object%New-ScheduledTask%Action%Action%Principal%User%Trigger%Trigger%Settings%Set%Register-ScheduledTask%AtomicTask%InputObject%object%' | groupby user, system | duration 1h

stream=win-audit where action='OBJECT_ACCESSED' and event='Creating Scriptblock text' and scriptblocktext like '%$Action%=%New-ScheduledTaskAction%-Execute%\"calc.exe\"%$Trigger%=%New-ScheduledTaskTrigger%-AtLogon%$User%=%New-ScheduledTaskPrincipal%-GroupId%"BUILTIN%Administrators"%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet%$object$=$New-ScheduledTask%-Action%$Action%-Principal%$User$-Trigger%$Trigger%-Settings%$Set%Register-ScheduledTask%AtomicTask%-InputObject%$object%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and event='Creating Scriptblock text' and scriptblocktext like '%Action%=%New-ScheduledTaskAction%Execute%calc.exe%Trigger%New-ScheduledTaskTrigger%AtLogon%User%New-ScheduledTaskPrincipal%-GroupId%"BUILTIN%Administrators"%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet%object%New-ScheduledTask%Action%Action%Principal%User%Trigger%Trigger%Settings%Set%Register-ScheduledTask%AtomicTask%InputObject%object%' | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%new-object%system.xml%xmldoc%xml.load%' or lower(commandline) like 'system%xml%xmldoc%load%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%system.xml%xmldoc%xml.load%' or lower(commandline) like 'system%xml%xmldoc%load%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and image like '%powershell.exe' and (commandline like 'reg%add%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like 'reg%delete%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or Commandline like '%New-ItemProperty%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image like '%powershell.exe' and (commandline like 'reg%add%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like 'reg%delete%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or Commandline like '%New-ItemProperty%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and image like '%cmd.exe' and (commandline like 'reg%add%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like 'reg%delete%%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or Commandline like '%New-ItemProperty%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and image like '%cmd.exe' and (commandline like 'reg add' or commandline like 'reg delete' or commandline like 'New-ItemProperty' or Commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%' or commandline like '%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image like '%wmic.exe%' and commandline like '%wmic.exe%Namespace%root%Microsoft%Windows%Defender%call%ExclusionProcess%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and image like '%wmic.exe%' and commandline like '%Namespace%root%Microsoft%Windows%Defender%call%ExclusionProcess%' |  groupby user, system

stream=ep-process where action='PROCESS_ADDED' and image='jsc.exe' and (commandline like '%.js%' or commandline like '%.dll%') | groupby system, user, commandline

stream=ep-process where action='PROCESS_ADDED' and image='jsc.exe' and (commandline like '%.js%' or commandline like '%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (image like "%.jse" or image like "%.js") and rlike(CommandLine, '(\\-\\-decompress|\\-c)') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (image like "%.jse" or image like "%.js") and rlike(CommandLine, '(\\-\\-decompress|\\-c)') and user='{SuspectUser}' and system='{TargetSystem}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((get-childitem|gci|ls|dir)\s+env|env|printenv|set)\s+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((get-childitem|gci|ls|dir)\s+env|env|printenv|set)\s+') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe' and commandline like '%wmic%node:%product%where%"name%like%"%call%uninstall%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe' and commandline like '%wmic%node:%product%where%"name%like%"%call%uninstall%' | groupby system, user

stream=win-audit where action="OBJECT_ACCESSED" and scriptblocktext like "%Win32_Process%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="OBJECT_ACCESSED" and scriptblocktext like "%Win32_Process%" | groupby system, user

stream=ep-process where action="PROCESS_ADDED" and (commandline like "%Disable-WindowsOptionalFeature%-Online%-FeatureName%Windows-Defender%" or commandline like "%Disable-WindowsOptionalFeature%-FeatureName%Windows-Defender%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like "%Disable%WindowsOptionalFeature%Online%FeatureName%WindowsDefender%" or commandline like "%Disable%WindowsOptionalFeature%FeatureName%Windows%Defender%") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like "%sc.exe delete sysmon%%reg delete%%sysmon%"  or commandline like "%sc.exe delete sysmon%Remove-Item%sysmon%" or commandline like "%sc.exe delete sysmon%sysmon -u%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like "%sc.exe delete sysmon%%reg delete%%sysmon%"  or commandline like "%sc.exe delete sysmon%Remove-Item%sysmon%" or commandline like "%sc.exe delete sysmon%sysmon -u%") | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and NewProcessName like '%cmd.exe%' and commandline like '%bitsadmin.exe%'| groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and NewProcessName like '%cmd.exe%' and commandline like '%bitsadmin.exe%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like "%powershell.exe%" and commandline like "%set%WebConfigurationProperty%PSPath%IIS%system.webServer%httpLogging%name%dontLog%value%true%" | groupby user, system 

stream=win-audit where action="PROCESS_CREATED" and newprocessname like "%powershell.exe%" and commandline like "%set%WebConfigurationProperty%PSPath%IIS%system.webServer%httpLogging%name%dontLog%value%true%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=ep-process where rlike(image, "(powershell\\\\.exe|wscript\\\\.exe|cscript\\\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\\\-Expression|\\\\&.*?\\\\{*?\\\\&\\\\}|\\\\[char\\\\])") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where (image like '%powershell%.exe%' or image like '%wscript%.exe%' or image like '%cscript%.exe%') and (commandline like '%iex%' or commandline like '%Invoke%-Expression%' or commandline like '%New-Object%' or commandline like '%System.Net.WebClient%' or commandline like '%DownloadString%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where (image like '%powershell%.exe%' or image like '%wscript%.exe%' or image like '%cscript%.exe%') and (commandline like '%iex%' or commandline like '%Invoke%-Expression%' or commandline like '%New-Object%' or commandline like '%System.Net.WebClient%' or commandline like '%DownloadString%') | groupby user, system

stream=win-audit where action="OBJECT_ACCESSED" and scriptblocktext="%Win32_Process%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="OBJECT_ACCESSED" and scriptblocktext like "%Win32_Process%" | groupby system, user

stream=win-audit where action='OBJECT_ACCESSED' and event='Creating Scriptblock text' and scriptblocktext like '%Action%=%New-ScheduledTaskAction%Execute%calc.exe%Trigger%New-ScheduledTaskTrigger%AtLogon%User%New-ScheduledTaskPrincipal%-GroupId%"BUILTIN%Administrators"%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet%object%New-ScheduledTask%Action%Action%Principal%User%Trigger%Trigger%Settings%Set%Register-ScheduledTask%AtomicTask%InputObject%object%' | groupby user, system 

stream=win-audit where action='OBJECT_ACCESSED' and event='Creating Scriptblock text' and scriptblocktext like '%Action%=%New-ScheduledTaskAction%Execute%calc.exe%Trigger%New-ScheduledTaskTrigger%AtLogon%User%New-ScheduledTaskPrincipal%-GroupId%"BUILTIN%Administrators"%-RunLevel%Highest%$Set%=%New-ScheduledTaskSettingsSet%object%New-ScheduledTask%Action%Action%Principal%User%Trigger%Trigger%Settings%Set%Register-ScheduledTask%AtomicTask%InputObject%object%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=email-gateway where action='EMAIL_BOUNCED' AND sourcename='TRENDMICRO-EMAIL-SECURITY' and sender is not null | duration 1d |  groupby sender | limit 10

stream=ep-process where action='PROCESS_ADDED' and (parentimage like '%powershell.exe%' or parentimage like '%cmd.exe%') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (parentimage like '%powershell.exe' or parentimage like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (parentimage like '%powershell.exe' or parentimage like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (parentimage like '%powershell.exe' or parentimage like '%cmd.exe') and (commandline like '%cscript.exe%' or commandline like '%wscript.exe%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%msxml2.serverxmlhttp%' or lower(commandline) like '%msxml2.domdocument%' or lower(commandline) like '%msxml2.freethreadeddomdocument%' or lower(commandline) like '%msxml2.mxxmlwriter%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%msxml2.serverxmlhttp%' or lower(commandline) like '%msxml2.domdocument%' or lower(commandline) like '%msxml2.freethreadeddomdocument%' or lower(commandline) like '%msxml2.mxxmlwriter%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and image like '%AdvancedRun.exe' and (commandline like '%AdvancedRun.exe%' or commandline like '%AddToDisableList%' or commandline like '%Execute%' or commandline like '%EXEFilename%' or commandline like '%cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and image like '%AdvancedRun.exe%' and (command like '%AdvancedRun.exe%' or command like '%AddToDisableList%' or commandline like'%Execute%' or commandline like '%EXEFilename%' or commandline like '%cfg%' or commandline like '%RunAs%' or commandline like '%WindowState%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((get-childitem|gci|ls|dir)\s+env|env|printenv|set)\s+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((get-childitem|gci|ls|dir)\s+env|env|printenv|set)\s+') | groupby user, system

stream=ep-process where eid = '10' | duration 1d |  groupby @SourceImage 

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%new-object%system.xml%xmldoc%xml.load%' or lower(commandline) like 'system%xml%xmldoc%load%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%system.xml%xmldoc%xml.load%' or lower(commandline) like 'system%xml%xmldoc%load%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%msxml2.serverxmlhttp%' or lower(commandline) like '%msxml2.domdocument%' or lower(commandline) like '%msxml2.freethreadeddomdocument%' or lower(commandline) like '%msxml2.mxxmlwriter%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%msxml2.serverxmlhttp%' or lower(commandline) like '%msxml2.domdocument%' or lower(commandline) like '%msxml2.freethreadeddomdocument%' or lower(commandline) like '%msxml2.mxxmlwriter%') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell%.exe%" or newprocessname like "%wscript.exe%" or newprocessname like "%cscript.exe%") and (commandline like "%-drtm%1" or commandline like "%-dbm%1" or commandline like "%-dscrptsc%1" or commandline like "%-dbaf%1") | groupby system, user

stream=win-audit where action="PROCESS_CREATED" and (newprocessname like "%powershell%.exe%" or newprocessname like "%wscript.exe%" or newprocessname like "%cscript.exe%") and (commandline like "%-drtm%1" or commandline like "%-dbm%1" or commandline like "%-dscrptsc%1" or commandline like "%-dbaf%1") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and lower(parentcommandline) like "%appcmd%set config%section:httplogging%dontlog:true%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%appcmd%set config%section:httplogging%dontlog:true%" or lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%" ) | groupby user, system

stream=ep-process where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=ep-process where rlike(image, "(powershell%.exe|wscript%.exe|cscript%.exe)") and  rlike(CommandLine, "(iex|Invoke%-Expression|%&.*?%{*?%&%}|%[char%])") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (newprocessname like '%powershell%.exe%' or newprocessname like '%wscript%.exe%' or newprocessname like '%cscript%.exe%') and (commandline like '%iex%' or commandline like '%Invoke%-Expression%' or commandline like '%New-Object%' or commandline like '%System.Net.WebClient%' or commandline like '%DownloadString%') | groupby user, system

stream=win-audit where (newprocessname like '%powershell%.exe%' or newprocessname like '%wscript%.exe%' or newprocessname like '%cscript%.exe%') and (commandline like '%iex%' or commandline like '%Invoke%-Expression%' or commandline like '%New-Object%' or commandline like '%System.Net.WebClient%' or commandline like '%DownloadString%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and NewProcessName like '%powershell.exe%' and commandline like '%Start-BitsTransfer%'| groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and NewProcessName like '%powershell.exe%' and commandline like '%Start-BitsTransfer%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image='jsc.exe' and (commandline like '%.js%' or commandline like '%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image='jsc.exe' and (commandline like '%.js%' or commandline like '%.dll%') | groupby system, user, commandline

stream=ep-process where action="PROCESS_ADDED" and (image like '%cmd.exe%' or image like '%powershell.exe%') and (commandline like '%C:%Windows%System32%.exe%https%' or commandline like '%C:%Windows%System32%.exe%tls%https%') | groupby system, user

stream=ep-process where action="PROCESS_ADDED" and (image like '%cmd.exe%' or image like '%powershell.exe%') and (commandline like '%C:%Windows%System32%.exe%https%' or commandline like '%C:%Windows%System32%.exe%tls%https%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wmic%node:%product%where%"name%like%"%call%uninstall%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wmic%node:%product%where%"name%like%"%call%uninstall%' | groupby system, user

stream=EP-PROCESS where action='PROCESS_ADDED' and lower(commandline) like '%new-object%system.xml%xmldoc%xml.load%' or lower(commandline) like 'system%xml%xmldoc%load%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%new-object%system.xml%xmldoc%xml.load%' or lower(commandline) like 'system%xml%xmldoc%load%') | groupby user, system | duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and NewProcessName like '%cmd.exe%' and commandline like '%bitsadmin.exe%'| groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and NewProcessName like '%cmd.exe%' and commandline like '%bitsadmin.exe%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image like '%bcdedit.exe' and commandline like '%bcdedit%set%safeboot%network%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image like '%bcdedit.exe' and commandline like '%bcdedit%set%safeboot%network%' | groupby user, system

stream=win-audit where rlike(newprocessname, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=win-audit where rlike(newprocessname, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows Defender Security Center%Notifications%DisableNotifications%REG_DWORD%d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows Defender Security Center%Notifications%DisableNotifications%REG_DWORD%d 1%" | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like '%jsc.exe' and (commandline like '%.js%' or commandline like '%.dll%') | groupby system, user, commandline

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%jsc.exe' and (commandline like '%.js%' or commandline like '%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%jsc.exe' and (commandline like '%.js%' or commandline like '%.dll%') | groupby system, user, commandline

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%reg add%" or commandline like "%reg delete%" or commandline like "%New-ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon" or commandline like "%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon") | groupby user, system 

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%reg add%" or commandline like "%reg delete%" or commandline like "%New-ItemProperty%") and (commandline like "%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon" or commandline like "%Software%Policies%Microsoft%Windows NT%CurrentVersion%Winlogon") and system='{TargetHost}' and user='{SuspectUser}' | duration 

stream=ep-registry where action='OBJECT_MODIFIED' and hosttype='windows' and (registrypath like '%SOFTWARE%Microsoft%Office%Security%AccessVBOM%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%VbaWarnings%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableInternetFilesInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableUnsafeLocationsInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableAttachementsInPV%') and (registrydatastrings like '0x00000001' or registrydatastrings like '1') and (image like '%cscript.exe%' or image like '%wscript.exe%' or image like '%mshta.exe%' or image like '%winword.exe%' or image like '%excel.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and hosttype='windows' and (registrypath like '%SOFTWARE%Microsoft%Office%Security%AccessVBOM%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%VbaWarnings%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableInternetFilesInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableUnsafeLocationsInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableAttachementsInPV%') and (registrydatastrings like '0x00000001' or registrydatastrings like '1') and (image like '%cscript.exe%' or image like '%wscript.exe%' or image like '%mshta.exe%' or image like '%winword.exe%' or image like '%excel.exe%') | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell%.exe%" or parentimage like "%wscript.exe%" or parentimage like "%cscript.exe%") and (commandline like "%Set-MpPreference%-drtm%True%" or commandline like "%Set-MpPreference%-dbm%True%" or commandline like "%Set-MpPreference%-dscrptsc%True%" or commandline like "%Set-MpPreference%-dbaf%True%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell%.exe%" or parentimage like "%wscript.exe%" or parentimage like "%cscript.exe%") and (commandline like "%Set-MpPreference%-drtm%True%" or commandline like "%Set-MpPreference%-dbm%True%" or commandline like "%Set-MpPreference%-dscrptsc%True%" or commandline like "%Set-MpPreference%-dbaf%True%") | groupby user, system

stream=EP-REGISTRY where (registrypath like '%SYSTEM%CurrentControlSet%Services%SharedAccess%Parameters%FirewallPolicy%' or registrypath like '%SOFTWARE%Policies%Microsoft%WindowsFirewall%') and registryvalue='EnableFirewall' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-REGISTRY where (registrypath like '%SYSTEM%CurrentControlSet%Services%SharedAccess%Parameters%FirewallPolicy%' or registrypath like '%SOFTWARE%Policies%Microsoft%WindowsFirewall%') and registryvalue='EnableFirewall' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (parentimage like '%netsh.exe%' or parentimage like '%powershell.exe%' or parentimage like '%cmd.exe%') and (commandline like 'netsh%advfirewall%set%currentprofile%state%off%' or commandline like '%powershell.exe%Command%Disable-NetFirewallRule%All%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (parentimage like '%netsh.exe%' or parentimage like '%powershell.exe%' or parentimage like '%cmd.exe%') and (commandline like 'netsh%advfirewall%set%currentprofile%state%off%' or commandline like '%powershell.exe%Command%Disable-NetFirewallRule%All%') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows Defender Security Center%Notifications%DisableNotifications%REG_DWORD%d 1%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%SOFTWARE%Policies%Microsoft%Windows Defender Security Center%Notifications%DisableNotifications%REG_DWORD%d 1%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and commandline like '%cmd.exe%"C:%Windows%System32%.exe%https%' | groupby system, user

stream=ep-process where action="PROCESS_ADDED" and commandline like '%cmd.exe%"C:%Windows%System32%.exe%https%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and (registrypath like '%SOFTWARE%Microsoft%Office%Security%AccessVBOM%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%VbaWarnings%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableInternetFilesInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableUnsafeLocationsInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableAttachementsInPV%') and (registrydatastrings like '0x00000001' or registrydatastrings like '1') and (image like '%cscript.exe%' or image like '%wscript.exe%' or image like '%mshta.exe%' or image like '%winword.exe%' or image like '%excel.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and (registrypath like '%SOFTWARE%Microsoft%Office%Security%AccessVBOM%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%VbaWarnings%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableInternetFilesInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableUnsafeLocationsInPV%' or registrypath like '%SOFTWARE%Microsoft%Office%Security%DisableAttachementsInPV%') and (registrydatastrings like '0x00000001' or registrydatastrings like '1') and (image like '%cscript.exe%' or image like '%wscript.exe%' or image like '%mshta.exe%' or image like '%winword.exe%' or image like '%excel.exe%') | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(dsquery.*?filter.*?objectclass=trusteddomain|nltest.*?(domain_trusts|trusted_domains))")  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m


stream=ep-process, win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(dsquery.*?filter.*?objectclass=trusteddomain|nltest.*?(domain_trusts|trusted_domains))") | groupby user, system 

stream=ep-process where (lower(parentimage) like "%powershell.exe%" or lower(parentimage) like "%cmd.exe%") and (commandline like "%fileNameToDelete%crmlog%" or commandline like "%Remove%Item%Path%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where (lower(parentimage) like "%powershell.exe%" or lower(parentimage) like "%cmd.exe%") and (commandline like "%fileNameToDelete%crmlog%" or commandline like "%Remove%Item%Path%") | groupby user, system

stream=ep-process where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=ep-process where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where rlike(image, "(powershell%.exe|wscript%.exe|cscript%.exe)") and  rlike(CommandLine, "(iex|Invoke%-Expression|%&.*?%{*?%&\\\\}|\\\\[char%])") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where rlike(image, "(powershell\\.exe|wscript\\.exe|cscript\\.exe)") and  rlike(CommandLine, "(iex|Invoke\\-Expression|\\&.*?\\{*?\\&\\}|\\[char\\])") | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%Start-BitsTransfer%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%Start-BitsTransfer%'| groupby system, user

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like '%jsc.exe' and (commandline like '%.js%' or commandline like '%.dll%') | groupby system, user, commandline

stream=ep-process where action="PROCESS_ADDED" and (commandline like '%cmd.exe%"C:%Windows%System32%.exe%https%' or commandline like '%cmd.exe%"C:%Windows%System32%.exe%tls%https%') | groupby system, user

stream=ep-process where action="PROCESS_ADDED" and (commandline like '%cmd.exe%"C:%Windows%System32%.exe%https%' or commandline like '%cmd.exe%"C:%Windows%System32%.exe%tls%https%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%bitsadmin.exe%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%bitsadmin.exe%'| groupby system, user

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%Get-DomainUser%' | groupby system, user 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%Get-DomainUser%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%bitsadmin.exe%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%bitsadmin.exe%'| groupby system, user

stream=ep-process where action='PROCESS_ADDED' and image='MSBuild.exe' and (commandline like '%.csproj%' or commandline like '%.xml%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image='MSBuild.exe' and (commandline like '%.csproj%' or commandline like '%.xml%') | groupby system, user, commandline

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0') | groupby user, system

stream=authentication where action="LOGIN"|  groupby srcip,system | 
select count_if(status="PASSED") as pass_count, count_if(status="FAILED") as fail_count,system,srcip | 
having fail_count> 50 and fail_count>5*pass_count

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%reg.exe%' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideClock%REG_DWORD%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%reg.exe%' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideClock%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%reg.exe%' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideClock%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%reg.exe%' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideClock%REG_DWORD%1%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%reg.exe%' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%reg.exe%' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and NewProcessName like '%cmd.exe%' and commandline like '%bitsadmin.exe%'| groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and NewProcessName like '%cmd.exe%' and commandline like '%bitsadmin.exe%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%msbuild.exe' and (commandline like '%.csproj%' or commandline like '%.xml%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%msbuild.exe' and (commandline like '%.csproj%' or commandline like '%.xml%') | groupby system, user, commandline

stream=firewall |  groupby srcip | limit 10

stream=firewall |  groupby srcip | limit 10

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%d%0') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%d%0') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=authentication where action="LOGIN" and status="FAILED" |  groupby user

stream=ep-process where action='PROCESS_CREATED' and image like '%reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAHealth%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_CREATED' and image like '%reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAHealth%REG_DWORD%/d%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%reg.exe%' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%reg.exe%' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoPropertiesMyDocuments%REG_DWORD%1%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (newprocessname like '%cmd.exe%' or newprocessname like '%powershell.exe%') and commandline like '%reg%add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (newprocessname like '%cmd.exe%' or newprocessname like '%powershell.exe%') and commandline like '%reg%add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (image like '%cmd.exe%' or image like '%powershell.exe%') and commandline like '%reg%add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (image like '%cmd.exe%' or image like '%powershell.exe%') and commandline like '%reg%add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and image like '%jsc.exe%' and (parentcommandline like '%.js%' or parentcommandline like '%.dll%') | groupby system, user, commandline

stream=ep-process where action='PROCESS_ADDED' and image like '%jsc.exe%' and (parentcommandline like '%.js%' or parentcommandline like '%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=firewall |  groupby dstip | limit 10

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCAPower%REG_DWORD%/d%1%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and image='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCANetwork%REG_DWORD%/d%1' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCANetwork%REG_DWORD%/d%1' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (newprocessname like '%cmd.exe%' or newprocessname like '%powershell.exe%') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoTrayContextMenu%REG_DWORD%1%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (newprocessname like '%cmd.exe%' or newprocessname like '%powershell.exe%') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoTrayContextMenu%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and targetobject like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoTrayContextMenu%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and targetobject like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoTrayContextMenu%REG_DWORD%1%' | groupby user, system

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and targetobject like '%reg%add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and targetobject like '%reg%add%SOFTWARE%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' | groupby user, system

stream=ep-process where parentimage='cmd.exe' and commandline like '%whoami%all%' | groupby user, system

stream=ep-process where parentimage='cmd.exe' and commandline like '%whoami%all%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where parentimage='powershell.exe' and commandline like '%Invoke-WinPwn%getsystem%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where parentimage='powershell.exe' and commandline like '%Invoke-WinPwn%getsystem%' | groupby user, system

stream=ep-process where parentimage='cmd.exe' and commandline like '%whoami%all%' | groupby user, system

stream=ep-process where parentimage='cmd.exe' and commandline like '%whoami%all%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where parentimage like '%powershell.exe%' and commandline like '%whoami%' | groupby user, system 

stream=ep-process where parentimage like '%powershell.exe%' and commandline like '%whoami%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%/d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%/d%0') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=authentication where action="LOGIN"|  groupby srcip,system | 
select count_if(status="PASSED") as pass_count, count_if(status="FAILED") as fail_count,system,srcip | 
having fail_count> 50 and fail_count>5*pass_count

stream=authentication where action="LOGIN"|  groupby srcip,system | 
select count_if(status="PASSED") as pass_count, count_if(status="FAILED") as fail_count,system,srcip | 
having fail_count> 50 and fail_count>5*pass_count

stream=iam where action='USER_CREATED' and user='Administrators' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=iam where action='USER_CREATED' and user='Administrators' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Remove%AzureADUser%' or commandline like '%az%ad%user%delete%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Remove%AzureADUser%' or commandline like '%az%ad%user%delete%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%bitsadmin.exe%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%bitsadmin.exe%'| groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and NewProcessName like '%powershell.exe%' and commandline like '%Start-BitsTransfer%'| groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and NewProcessName like '%powershell.exe%' and commandline like '%Start-BitsTransfer%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where parentimage like '%powershell.exe%' and commandline like '%iex%new-object%net.webclient%Get-WinLogonTokenSystem%' | groupby user, system 

stream=ep-process where parentimage like '%powershell.exe%' and commandline like '%iex%new-object%net.webclient%Get-WinLogonTokenSystem%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%d%0') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowInfoTip%REG_DWORD%d%0' or commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%ShowCompColor%REG_DWORD%d%0') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCANetwork%REG_DWORD%/d%1' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCANetwork%REG_DWORD%/d%1' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCANetwork%REG_DWORD%/d%1' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname='reg.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%HideSCANetwork%REG_DWORD%/d%1' | groupby user, system

stream=authentication where action="LOGIN"|  groupby srcip,system | 
select count_if(status="PASSED") as pass_count, count_if(status="FAILED") as fail_count,system,srcip | 
having fail_count> 50 and fail_count>5*pass_count

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Remove-ADGroupMember%Identity%Members%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Remove-ADGroupMember%Identity%Members%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and parentimage like '%powershell.exe%' and parentcommandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and parentimage like '%powershell.exe%' and parentcommandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%Start-BitsTransfer%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%Start-BitsTransfer%'| groupby system, user

stream=ep-process where parentimage like '%powershell.exe%' and (commandline like '%whoami%' or commandline like '%Set-ExecutionPolicy%-Scope%-Force%' or commandline like '%CreateProcessFromParent%Get-Process%lsass%' or commandline like '%Get-Process%Select%') | groupby user, system 

stream=ep-process where parentimage like '%powershell.exe%' and (commandline like '%whoami%' or commandline like '%Set-ExecutionPolicy%-Scope%-Force%' or commandline like '%CreateProcessFromParent%Get-Process%lsass%' or commandline like '%Get-Process%Select%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED' , 'OBJECT_ACCESSED') and ((lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(commandline) like '%class%win32_logicaldisk%new-item%itemtype%') or (lower(scriptblocktext) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(scriptblocktext) like '%class%win32_logicaldisk%new-item%itemtype%')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED' , 'OBJECT_ACCESSED') and ((lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(commandline) like '%class%win32_logicaldisk%new-item%itemtype%') or (lower(scriptblocktext) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(scriptblocktext) like '%class%win32_logicaldisk%new-item%itemtype%')) | groupby system, user

stream=ep-process where parentimage='powershell.exe' and commandline like '%Invoke-WinPwn%getsystem%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where parentimage='powershell.exe' and commandline like '%Invoke-WinPwn%getsystem%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%sc%config%Fax%powershell%' | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and commandline like '%sc%config%Fax%powershell%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%powershell%UseBasicParsing%Get-PasswordVaultCredentials%' or commandline like '%powershell%UseBasicParsing%Get-CredManCreds%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%powershell%UseBasicParsing%Get-PasswordVaultCredentials%' or commandline like '%powershell%UseBasicParsing%Get-CredManCreds%') | groupby user, system

stream=win-audit,ep-process,configuration where action in ('PROCESS_CREATED', 'PROCESS_ADDED', 'CONFIGURATION_CHANGED') and rlike(lower(commandline), "(sc.*?(stop|config.*?windefend.*?start=.*?disabled|query).*?windefend|net.*?stop.*?windefend|reg.*?add.*?hkey_local_machine.*?system.*?currentcontrolset.*?services.*?windefend.*?/v.*?start.*?/t.*?reg_dword.*?/d.*?4.*?/f|schtasks.*?/change.*?/tn.*?microsoft.*?windows.*?windows.*?defender.*?windows.*?defender.*?(scheduled.*?scan|cache.*?maintenance|cleanup|verification).*?/disable|powershell\.exe.*?uninstall-windowsfeature.*?-name.*?windows-defender-features|(reg.*?add|set.*?itemproperty).*?(hkey_local_machine|hklm).*?software.*?policies.*?microsoft.*?windows.*?defender.*?(/v|name).*?disableantispyware.*?(/t.*?reg_dword.*?/d|value).*?1)") |  groupby user, system 

stream=win-audit,ep-process,configuration where action in ('PROCESS_CREATED', 'PROCESS_ADDED', 'CONFIGURATION_CHANGED') and rlike(lower(commandline), "(sc.*?(stop|config.*?windefend.*?start=.*?disabled|query).*?windefend|net.*?stop.*?windefend|reg.*?add.*?hkey_local_machine.*?system.*?currentcontrolset.*?services.*?windefend.*?/v.*?start.*?/t.*?reg_dword.*?/d.*?4.*?/f|schtasks.*?/change.*?/tn.*?microsoft.*?windows.*?windows.*?defender.*?windows.*?defender.*?(scheduled.*?scan|cache.*?maintenance|cleanup|verification).*?/disable|powershell\.exe.*?uninstall-windowsfeature.*?-name.*?windows-defender-features|(reg.*?add|set.*?itemproperty).*?(hkey_local_machine|hklm).*?software.*?policies.*?microsoft.*?windows.*?defender.*?(/v|name).*?disableantispyware.*?(/t.*?reg_dword.*?/d|value).*?1)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%reg.exe%'  and commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%REG_DWORD%HideFileExt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%reg.exe%' and commandline like '%Software%Microsoft%Windows%CurrentVersion%Explorer%Advanced%REG_DWORD%HideFileExt%' | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "Software%Microsoft%Windows%CurrentVersion%policies%system%DisableRegistryTools%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action="PROCESS_CREATED" and commandline like "Software%Microsoft%Windows%CurrentVersion%policies%system%DisableRegistryTools%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "Software%Microsoft%Windows%CurrentVersion%policies%system%DisableRegistryTools%"  and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "Software%Microsoft%Windows%CurrentVersion%policies%system%DisableRegistryTools%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "Software%Microsoft%Windows%CurrentVersion%policies%system%DisableRegistryTools%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Software%Microsoft%Windows%CurrentVersion%policies%system%DisableRegistryTools%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "Software%Microsoft%Windows%CurrentVersion%policies%system%DisableRegistryTools%"  and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%Software%Microsoft%Windows%CurrentVersion%policies%system%DisableRegistryTools%" | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%Software%Microsoft%Windows%CurrentVersion%policies%system%DisableRegistryTools%"  and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and commandline like "%Software%Microsoft%Windows%CurrentVersion%policies%system%DisableRegistryTools%" | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Software%Microsoft%Windows%CurrentVersion%policies%system%DisableRegistryTools%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action="PROCESS_CREATED" and commandline like "%Software%Microsoft%Windows%CurrentVersion%policies%system%DisableRegistryTools%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (commandline like "%powershell%DisableCMD%" or commandline like "%reg%DisableCMD%" or commandline like "%gpedit%DisableCMD%" or commandline like "%cmd%DisableCMD%") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (commandline like "%powershell%DisableCMD%" or commandline like "%reg%DisableCMD%" or commandline like "%gpedit%DisableCMD%" or commandline like "%cmd%DisableCMD%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%powershell%DisableCMD%" or commandline like "%reg%DisableCMD%" or commandline like "%gpedit%DisableCMD%" or commandline like "%cmd%DisableCMD%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%powershell%DisableCMD%" or commandline like "%reg%DisableCMD%" or commandline like "%gpedit%DisableCMD%" or commandline like "%cmd%DisableCMD%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%powershell%DisableTaskmgr%" or commandline like "%reg%DisableTaskmgr%" or commandline like "%gpedit%DisableTaskmgr%" or commandline like "%cmd%DisableTaskmgr%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%powershell%DisableTaskmgr%" or commandline like "%reg%DisableTaskmgr%" or commandline like "%gpedit%DisableTaskmgr%" or commandline like "%cmd%DisableTaskmgr%") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (commandline like "%powershell%DisableTaskmgr%" or commandline like "%reg%DisableTaskmgr%" or commandline like "%gpedit%DisableTaskmgr%" or commandline like "%cmd%DisableTaskmgr%") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (commandline like "%powershell%DisableTaskmgr%" or commandline like "%reg%DisableTaskmgr%" or commandline like "%gpedit%DisableTaskmgr%" or commandline like "%cmd%DisableTaskmgr%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like "%powershell%DisableNotificationCenter%" or commandline like "%reg%DisableNotificationCenter%" or commandline like "%gpedit%DisableNotificationCenter%" or commandline like "%cmd%DisableNotificationCenter%") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like "%powershell%DisableNotificationCenter%" or commandline like "%reg%DisableNotificationCenter%" or commandline like "%gpedit%DisableNotificationCenter%" or commandline like "%cmd%DisableNotificationCenter%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED"  and (commandline like "%powershell%DisableNotificationCenter%" or commandline like "%reg%DisableNotificationCenter%" or commandline like "%gpedit%DisableNotificationCenter%" or commandline like "%cmd%DisableNotificationCenter%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED"  and (commandline like "%powershell%DisableNotificationCenter%" or commandline like "%reg%DisableNotificationCenter%" or commandline like "%gpedit%DisableNotificationCenter%" or commandline like "%cmd%DisableNotificationCenter%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoFileMenu%REG_DWORD%d%1%" | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (newprocessname like '%cmd.exe%' or newprocessname like '%powershell.exe%') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (newprocessname like '%cmd.exe%' or newprocessname like '%powershell.exe%') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' | groupby user, system

stream=audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and commandline like '%pnputil.exe%' | groupby system, user | duration 5m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Import-Module ADFS%Get-AdfsCertificate -CertificateType Token-Signing%' or commandline like '%Import-Module ADFS%Get-AdfsCertificate -CertificateType Token-Decrypting%' or commandline like '%Import%Module%AADInternals%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%Import-Module%AADInternals%Export-AADIntADFSConfiguration%Export-AADIntADFSEncryptionKey%Export-AADIntADFSCertificates -Configuration%-Key%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Import-Module ADFS%Get-AdfsCertificate -CertificateType Token-Signing%' or commandline like '%Import-Module ADFS%Get-AdfsCertificate -CertificateType Token-Decrypting%' or commandline like '%Import%Module%AADInternals%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%Import-Module%AADInternals%Export-AADIntADFSConfiguration%Export-AADIntADFSEncryptionKey%Export-AADIntADFSCertificates -Configuration%-Key%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%pnputil.exe%' | groupby system, user

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%pnputil.exe%'and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and commandline like '%pnputil.exe%add-driver%' | groupby system, user, commandline

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and commandline like '%pnputil.exe%add-driver%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%pnputil.exe%add-driver%' | groupby system, user, commandline 

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%pnputil.exe%add-driver%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%powershell%shutdownwithoutlogon%" or commandline like "%reg%shutdownwithoutlogon%" or commandline like "%gpedit%shutdownwithoutlogon%" or commandline like "%cmd%shutdownwithoutlogon%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%powershell%shutdownwithoutlogon%" or commandline like "%reg%shutdownwithoutlogon%" or commandline like "%gpedit%shutdownwithoutlogon%" or commandline like "%cmd%shutdownwithoutlogon%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (commandline like "%powershell%StartMenuLogOff%" or commandline like "%reg%StartMenuLogOff%" or commandline like "%gpedit%StartMenuLogOff%" or commandline like "%cmd%StartMenuLogOff%" or commandline like "%powershell%onlogoff%" or commandline like "%reg%onlogoff%" or commandline like "%gpedit%onlogoff%" or commandline like "%cmd%onlogoff%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (commandline like "%powershell%StartMenuLogOff%" or commandline like "%reg%StartMenuLogOff%" or commandline like "%gpedit%StartMenuLogOff%" or commandline like "%cmd%StartMenuLogOff%" or commandline like "%powershell%onlogoff%" or commandline like "%reg%onlogoff%" or commandline like "%gpedit%onlogoff%" or commandline like "%cmd%onlogoff%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%powershell%DisableChangePassword%" or commandline like "%reg%DisableChangePassword%" or commandline like "%gpedit%DisableChangePassword%" or commandline like "%cmd%DisableChangePassword%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%powershell%DisableChangePassword%" or commandline like "%reg%DisableChangePassword%" or commandline like "%gpedit%DisableChangePassword%" or commandline like "%cmd%DisableChangePassword%") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like "%powershell%DisableLockWorkstation%" or commandline like "%reg%DisableLockWorkstation%" or commandline like "%gpedit%DisableLockWorkstation%" or commandline like "%cmd%DisableLockWorkstation%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like "%powershell%DisableLockWorkstation%" or commandline like "%reg%DisableLockWorkstation%" or commandline like "%gpedit%DisableLockWorkstation%" or commandline like "%cmd%DisableLockWorkstation%") | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname='cmd.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname='cmd.exe' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and commandline like '%pnputil.exe%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and commandline like '%pnputil.exe%' | groupby system, user

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%pnputil.exe%' | groupby system, user

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%pnputil.exe%'and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%bitsadmin.exe%' | groupby system, user

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%bitsadmin.exe%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?ms-settings.*?(cmd|powershell)") | groupby user, system 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?ms-settings.*?(cmd|powershell)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (commandline like "%powershell%shutdownwithoutlogon%" or commandline like "%reg%shutdownwithoutlogon%" or commandline like "%gpedit%shutdownwithoutlogon%" or commandline like "%cmd%shutdownwithoutlogon%")| groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (commandline like "%powershell%shutdownwithoutlogon%" or commandline like "%reg%shutdownwithoutlogon%" or commandline like "%gpedit%shutdownwithoutlogon%" or commandline like "%cmd%shutdownwithoutlogon%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%powershell%DisableLockWorkstation%" or commandline like "%reg%DisableLockWorkstation%" or commandline like "%gpedit%DisableLockWorkstation%" or commandline like "%cmd%DisableLockWorkstation%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED"and (commandline like "%powershell%DisableLockWorkstation%" or commandline like "%reg%DisableLockWorkstation%" or commandline like "%gpedit%DisableLockWorkstation%" or commandline like "%cmd%DisableLockWorkstation%") and user='{SuspectUser}' and system='{TargetHsot}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoRun%REG_DWORD%d%1%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (parentimage like "%powershell.exe%" or parentimage like "%reg.exe%") and commandline like "%reg add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoRun%REG_DWORD%d%1%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and targetobject like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and targetobject like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (image like '%cmd.exe%' or image like '%powershell.exe%') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (image like '%cmd.exe%' or image like '%powershell.exe%') and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and targetobject like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' | groupby user, system

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and targetobject like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoSetTaskbar%REG_DWORD%1%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%pnputil.exe%'and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%pnputil.exe%add-driver%' | groupby system, user, commandline | duration 1h

stream=EP-FILE where rlike(lower(targetfilename),"\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") and targetfilename="{SuspectObject}" and user="{SuspectUser}" and system="{TargetHost}" | duraton 6m

stream=EP-FILE where rlike(lower(targetfilename),"\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") | groupby substring_index(targetfilename,"\\",-1), targetfilename, user, system | select substring_index(targetfilename,"\\",-1) as file, targetfilename, user, system | duration 1h

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%powershell%DisableNotificationCenter%" or commandline like "%reg%DisableNotificationCenter%" or commandline like "%gpedit%DisableNotificationCenter%" or commandline like "%cmd%DisableNotificationCenter%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%powershell%DisableNotificationCenter%" or commandline like "%reg%DisableNotificationCenter%" or commandline like "%gpedit%DisableNotificationCenter%" or commandline like "%cmd%DisableNotificationCenter%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like "%powershell%DisableChangePassword%" or commandline like "%reg%DisableChangePassword%" or commandline like "%gpedit%DisableChangePassword%" or commandline like "%cmd%DisableChangePassword%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like "%powershell%DisableChangePassword%" or commandline like "%reg%DisableChangePassword%" or commandline like "%gpedit%DisableChangePassword%" or commandline like "%cmd%DisableChangePassword%") | groupby user, system

stream=win-audit where action='PROCESS_CREATED'  and rlike(lower(commandline),'powershell.exe.*(copy-item|move-item).*(c\\$|d\\$|admin\\$|a\\$|ipc\\$|print\\$)') | groupby system, user

stream=win-audit where action='PROCESS_CREATED'  and rlike(lower(commandline),'powershell.exe.*(copy-item|move-item).*(c\\$|d\\$|admin\\$|a\\$|ipc\\$|print\\$)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and commandline like '%pnputil.exe%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and commandline like '%pnputil.exe%' | groupby system, user | duration 5m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%pnputil.exe%add-driver%' | groupby system, user, commandline 

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%pnputil.exe%add-driver%' | groupby system, user, commandline and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%net%user%administrator%domain%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%net%user%administrator%domain%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%c:%windows%system32%crypto::%certificates%system%export%systemstore:local_machine%') or (lower(commandline) like '%crypto::%certificates%export%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%c:%windows%system32%crypto::%certificates%system%export%systemstore:local_machine%') or (lower(commandline) like '%crypto::%certificates%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 31m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline), 'bitsadmin\..*?transfer.*?download.*?priority.*?foreground') or rlike(lower(commandline), 'bitsadmin\..*?(addfile|create|setnotifycmdline|resume|complete|ping -n)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline), 'bitsadmin\..*?transfer.*?download.*?priority.*?foreground') or rlike(lower(commandline), 'bitsadmin\..*?(addfile|create|setnotifycmdline|resume|complete|ping -n)'))| groupby system, user

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%powershell%StartMenuLogOff%" or commandline like "%reg%StartMenuLogOff%" or commandline like "%gpedit%StartMenuLogOff%" or commandline like "%cmd%StartMenuLogOff%" or commandline like "%powershell%onlogoff%" or commandline like "%reg%onlogoff%" or commandline like "%gpedit%onlogoff%" or commandline like "%cmd%onlogoff%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (commandline like "%powershell%StartMenuLogOff%" or commandline like "%reg%StartMenuLogOff%" or commandline like "%gpedit%StartMenuLogOff%" or commandline like "%cmd%StartMenuLogOff%" or commandline like "%powershell%onlogoff%" or commandline like "%reg%onlogoff%" or commandline like "%gpedit%onlogoff%" or commandline like "%cmd%onlogoff%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (commandline like "%powershell%shutdownwithoutlogon%" or commandline like "%reg%shutdownwithoutlogon%" or commandline like "%gpedit%shutdownwithoutlogon%" or commandline like "%cmd%shutdownwithoutlogon%") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (commandline like "%powershell%shutdownwithoutlogon%" or commandline like "%reg%shutdownwithoutlogon%" or commandline like "%gpedit%shutdownwithoutlogon%" or commandline like "%cmd%shutdownwithoutlogon%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and image  liek '%cmd.exe%' and commandline like '%reg%add%Software%Microsoft%Windows%CurrentVersion%Policies%Explorer%NoClose%REG_DWORD%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%pnputil.exe%' | groupby system, user | duration 5m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%pnputil.exe%'and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=authentication where action="LOGIN" |  groupby srcip,system|  select srcip,system , 
count_if(status="PASSED") AS pass_count, count_if(status="FAILED") AS fail_count |  having fail_count>50 and fail_count>5*pass_count

stream=authentication where action="LOGIN" |  groupby srcip,system|  select srcip,system , 
count_if(status="PASSED") AS pass_count, count_if(status="FAILED") AS fail_count |  having fail_count>50 and fail_count>5*pass_count

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and commandline like '%pnputil.exe%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and commandline like '%pnputil.exe%' | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and commandline like '%pnputil.exe%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and commandline like '%pnputil.exe%' | groupby system, user | duration 5m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%') | groupby user, system

stream=authentication where action="LOGIN" |  groupby srcip,system|  select srcip,system , 
count_if(status="PASSED") AS pass_count, count_if(status="FAILED") AS fail_count |  having fail_count>50 and fail_count>5*pass_count

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and commandline like '%bitsadmin.exe%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and commandline like '%bitsadmin.exe%' | groupby system, user

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%Start-BitsTransfer%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%Start-BitsTransfer%' | groupby system, user

stream=EP-FILE where action="FILE_CREATED" and rlike(lower(targetfilename),"\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") | groupby substring_index(targetfilename,"\\",-1), targetfilename, user, system | select substring_index(targetfilename,"\\",-1) as file, targetfilename, user, system | duration 1h

stream=EP-FILE where action="FILE_CREATED" and rlike(lower(targetfilename),"\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") and targetfilename="{SuspectObject}" and user="{SuspectUser}" and system="{TargetHost}" | duraton 6m

stream=win-audit where action='PROCESS_CREATED'  and rlike(lower(commandline),'powershell.exe.*(copy-item|move-item).*(c\\$|d\\$|admin\\$|a\\$|ipc\\$|print\\$)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED'  and rlike(lower(commandline), 'powershell.exe.*(copy-item|move-item).*(c\\$|d\\$|admin\\$|a\\$|ipc\\$|print\\$)') | groupby system, user

stream=authentication where action="LOGIN" |  groupby srcip,system|  select srcip,system , 
count_if(status="PASSED") AS pass_count, count_if(status="FAILED") AS fail_count |  having fail_count>50 and fail_count>5*pass_count

stream=THREAT where Action="THREAT_DETECTED" and Vector="HOST" | groupby srcip

stream=win-audit where (commandline like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or commandline like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or commandline like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or commandline like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') or (scriptblocktext like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or scriptblocktext like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or scriptblocktext like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or scriptblocktext like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') | groupby system, user

stream=win-audit where (commandline like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or commandline like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or commandline like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or commandline like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') or (scriptblocktext like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or scriptblocktext like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or scriptblocktext like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or scriptblocktext like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED'  and rlike(lower(commandline), 'powershell.exe.*(copy-item|move-item).*(c$|d$|admin$|a$|ipc$|print$)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED'  and rlike(lower(commandline), 'powershell.exe.*(copy-item|move-item).*(c\\$|d\\$|admin\\$|a\\$|ipc\\$|print\\$)') | groupby system, user

stream=win-audit where action='PROCESS_CREATED'  and rlike(lower(commandline), 'powershell.exe.*(copy-item|move-item).*(c//$|d//$|admin//$|a//$|ipc//$|print//$)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED'  and rlike(lower(commandline), 'powershell.exe.*(copy-item|move-item).*(c\\$|d\\$|admin\\$|a\\$|ipc\\$|print\\$)') | groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%convertto-securestring%-force%new-selfsignedcertificate%-dnsname%-certstorelocation%') or (lower(commandline) like 'get-childitem -path%export-pfxcertificate%-filepath%') | groupby user , system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%convertto-securestring%-force%new-selfsignedcertificate%-dnsname%-certstorelocation%') or (lower(commandline) like 'get-childitem -path%export-pfxcertificate%-filepath%') | groupby user , system and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%AtomicTest.dll%' | groupby user, system | duration 10m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%AtomicTest.dll%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%AtomicTest.dll%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%AtomicTest.dll%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%AtomicTest.dll%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%AtomicTest.dll%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%AtomicTest.dll%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%Start-BitsTransfer%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%Start-BitsTransfer%' | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%chromium%chrome.exe%--load-extension=%' or commandline like '%chromium%chrome.exe%chrome.google.com%webstore%detail%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%chromium%chrome.exe%--load-extension=%' or commandline like '%chromium%chrome.exe%chrome.google.com%webstore%detail%') | select system, user

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%AtomicTest.dll%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and parentprocessname like '%powershell.exe%' and commandline like '%AtomicTest.dll%' | groupby user, system 

stream=nta-kerberos where action = 'KERBEROS_AUTHENTICATION_SERVICE_USED' and status = 'FAILED' and not client like '%$%' |  duration 1h |  groupby client, action, srcip, status

stream=nta-kerberos where action = 'KERBEROS_AUTHENTICATION_SERVICE_USED' and client = '{TargetUser}' and srcip = '{SuspectHost}' and not client like '%$%' |  duration 1h 

stream=ep-process where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%Get-Keystrokes.ps1%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image like '%powershell.exe%' and commandline like '%Get-Keystrokes.ps1%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%pnputil.exe%add-driver%' | groupby system, user, commandline 

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%pnputil.exe%add-driver%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and parentimage like '%powershell.exe%' and parentcommandline like '%AtomicTest.dll%' | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and parentimage like '%powershell.exe%' and parentcommandline like '%AtomicTest.dll%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and parentimage like '%powershell.exe%' and parentcommandline like '%AtomicTest.dll%' | groupby user, system 

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%tshark.exe%-i%-c 5%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and commandline like '%tshark.exe%-i%-c 5%' | select user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%WinPwn.ps1%mimiload%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%WinPwn.ps1%mimiload%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%AtomicTest.dll%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%AtomicTest.dll%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ammyy%' or commandline like '%RemotePC%' or commandline like '%NetSupport%' or commandline like '%UltraViewer%' or commandline like '%UltraVnc%' or commandline like '%msp360connect%') |  groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ammyy%' or commandline like '%RemotePC%' or commandline like '%NetSupport%' or commandline like '%UltraViewer%' or commandline like '%UltraVnc%' or commandline like '%msp360connect%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and commandline like '%pnputil.exe%add-driver%' | groupby system, user, commandline

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and commandline like '%pnputil.exe%add-driver%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe" and commandline like "%New-Object IO.FileStream%Open%Read%ReadWrite%" | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe" and commandline like "%New-Object IO.FileStream%Open%Read%ReadWrite%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and parentimage like '%powershell.exe%' and parentcommandline like '%AtomicTest.dll%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and parentimage like '%powershell.exe%' and parentcommandline like '%AtomicTest.dll%' | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and parentimage like '%powershell.exe%' and parentcommandline like '%AtomicTest.dll%' | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and parentimage like '%powershell.exe%' and parentcommandline like '%AtomicTest.dll%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%WinPwn.ps1%mimiload%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%WinPwn.ps1%mimiload%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%AtomicTest.dll%' | groupby user, system | duration 5m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%AtomicTest.dll%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ammyy%' or commandline like '%RemotePC%' or commandline like '%NetSupport%' or commandline like '%UltraViewer%' or commandline like '%UltraVnc%' or commandline like '%msp360connect%') |  groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ammyy%' or commandline like '%RemotePC%' or commandline like '%NetSupport%' or commandline like '%UltraViewer%' or commandline like '%UltraVnc%' or commandline like '%msp360connect%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ammyy%' or commandline like '%RemotePC%' or commandline like '%NetSupport%' or commandline like '%UltraViewer%' or commandline like '%UltraVnc%' or commandline like '%msp360connect%') |  groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ammyy%' or commandline like '%RemotePC%' or commandline like '%NetSupport%' or commandline like '%UltraViewer%' or commandline like '%UltraVnc%' or commandline like '%msp360connect%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ScreenConnect.msi%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ScreenConnect.msi%') | groupby user, system | duration 1h

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ScreenConnect.msi%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ScreenConnect.msi%') | groupby user, system | duration 1h

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ScreenConnect.msi%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ScreenConnect.msi%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ScreenConnect.msi%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ScreenConnect.msi%') | groupby user, system 

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663', '4656') and rlike(lower(commandline), '(myanchor.*?document.createelement.*?myanchor.download|myblob.*?new blob|myurl.*?window.url.createobjecturl.*?myanchor.href|myevilblob.*?new blob|url.createobjecturl|remote.html)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663', '4656') and rlike(lower(commandline), '(myanchor.*?document.createelement.*?myanchor.download|myblob.*?new blob|myurl.*?window.url.createobjecturl.*?myanchor.href|myevilblob.*?new blob|url.createobjecturl|remote.html)') | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and Image like '%powershell.exe%' and commandline like '%Authentication%Packages%' | groupby user, system | duration 5m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ScreenConnect.msi%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ScreenConnect.msi%') | groupby user, system | duration 1h

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%Authentication%Packages%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%Authentication%Packages%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%Authentication%Packages%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%Authentication%Packages%' | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and Image like '%powershell.exe%' and commandline like '%Authentication%Packages%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and Image like '%powershell.exe%' and commandline like '%Authentication%Packages%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%Authentication%Packages%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%Authentication%Packages%' | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and Image like '%powershell.exe%' and commandline like '%Authentication%Packages%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and Image like '%powershell.exe%' and commandline like '%Authentication%Packages%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and ((parentprocessname like '%wscript%' and newprocessname like '%cmd.exe%' and rlike(lower(commandline), '(whoami /all|net user|net group)')) or (newprocessname like '%wscript%' and rlike(lower(commandline), '(whoami /all|net user|net group)')) or (newprocessname like '%nltest%' and rlike(lower(commandline), '(domain_trusts|all_trusts)'))) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and ((parentprocessname like '%wscript%' and newprocessname like '%cmd.exe%' and rlike(lower(commandline), '(whoami /all|net user|net group)')) or (newprocessname like '%wscript%' and rlike(lower(commandline), '(whoami /all|net user|net group)')) or (newprocessname like '%nltest%' and rlike(lower(commandline), '(domain_trusts|all_trusts)'))) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%')  | groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') | groupby user, system

stream=win-audit where and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') | groupby user, system

stream=win-audit where and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Set-Clipboard%' or commandline like "%clip.exe%" or commandline like '%powershell%Get-Process%' or  commandline like '%powershell%Set-Clipboard%' or  commandline like '%powershell%Get-Clipboard%' or  commandline like '%cmd%echo%' or commandline like "%cmd%clip%" or commandline like "%VBA%GetClipboard%") | select user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname='powershell.exe' and (commandline like '%Set-PSReadlineOption%HistorySaveStyle SaveNothing%' or commandline like '%Remove-Item%ConsoleHost_history.txt%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and newprocessname='powershell.exe' and (commandline like '%Set-PSReadlineOption%HistorySaveStyle SaveNothing%' or commandline like '%Remove-Item%ConsoleHost_history.txt%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(parentprocessname),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(parentprocessname),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") | groupby user, system

stream=IAM where action="PRIVILEGE_CHANGED" and PrivilegeList like "%SeBackupPrivilege%" | groupby user

stream=IAM where action="PRIVILEGE_CHANGED" and PrivilegeList like "%SeBackupPrivilege%" and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and Image like '%powershell.exe%' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and Image like '%powershell.exe%' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') | groupby user, system

stream=win-audit where and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') | groupby user, system

stream=win-audit where and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(namedpipes_executor|namedpipes_server|namedpipes_client).*?--(pipe|server|client)' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(namedpipes_executor|namedpipes_server|namedpipes_client).*?--(pipe|server|client)' | groupby user, system

stream=ep-process where and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') | groupby user, system

stream=ep-process where and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') | groupby user, system

stream=win-audit where and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%')  | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%HKEY%LOCAL%MACHINE%' or commandline like '%HKLM%' or commandline like '%HKEY%CURRENT%USER%') and ( commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%') and ( commandline like '%%run%' or commandline like '%%runitonce%' or commandline like 'runonce' ) | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and Image like '%powershell.exe%' and (commandline like '%HKEY%LOCAL%MACHINE%' or commandline like '%HKLM%' or commandline like '%HKEY%CURRENT%USER%') and ( commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%') and ( commandline like '%%run%' or commandline like '%%runitonce%' or commandline like 'runonce' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and Image like '%powershell.exe%' and (commandline like '%HKEY%LOCAL%MACHINE%' or commandline like '%HKLM%' or commandline like '%HKEY%CURRENT%USER%') and ( commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%') and ( commandline like '%%run%' or commandline like '%%runitonce%' or commandline like 'runonce' ) | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ChildItem%Bookmarks%' or commandline like '%/R C:%Bookmarks%' or commandline like '%/R C:%places.sqlite%' or commandline like '%/s /b%USERPROFILE%Favorites%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ChildItem%Bookmarks%' or commandline like '%/R C:%Bookmarks%' or commandline like '%/R C:%places.sqlite%' or commandline like '%/s /b%USERPROFILE%Favorites%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%WinPwn.ps1%mimiload%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%WinPwn.ps1%mimiload%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and Image like '%powershell.exe%'and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and Image like '%powershell.exe%'and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%')  and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Set-Clipboard%' or commandline like "%clip.exe%" or commandline like '%powershell%Get-Process%' or  commandline like '%powershell%Set-Clipboard%' or  commandline like '%powershell%Get-Clipboard%' or  commandline like '%cmd%echo%' or commandline like "%cmd%clip%" or commandline like "%VBA%GetClipboard%") | select user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Set-Clipboard%' or commandline like "%clip.exe%" or commandline like '%powershell%Get-Process%' or  commandline like '%powershell%Set-Clipboard%' or  commandline like '%powershell%Get-Clipboard%' or  commandline like '%cmd%echo%' or commandline like "%cmd%clip%" or commandline like "%VBA%GetClipboard%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Set-Clipboard%' or commandline like "%clip.exe%" or commandline like '%powershell%Get-Process%' or  commandline like '%powershell%Set-Clipboard%' or  commandline like '%powershell%Get-Clipboard%' or  commandline like '%cmd%echo%' or commandline like "%cmd%clip%" or commandline like "%VBA%GetClipboard%") | select user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Set-Clipboard%' or commandline like "%clip.exe%" or commandline like '%powershell%Get-Process%' or  commandline like '%powershell%Set-Clipboard%' or  commandline like '%powershell%Get-Clipboard%' or  commandline like '%cmd%echo%' or commandline like "%cmd%clip%" or commandline like "%VBA%GetClipboard%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and Image like '%powershell.exe%' and (commandline like '%HKEY%LOCAL%MACHINE%' or commandline like '%HKLM%' or commandline like '%HKEY%CURRENT%USER%') and ( commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%') and ( commandline like '%%run%' or commandline like '%%runitonce%' or commandline like 'runonce' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and Image like '%powershell.exe%' and (commandline like '%HKEY%LOCAL%MACHINE%' or commandline like '%HKLM%' or commandline like '%HKEY%CURRENT%USER%') and ( commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%') and ( commandline like '%%run%' or commandline like '%%runitonce%' or commandline like 'runonce' ) | groupby user, system 

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%Get-Date%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%Get-Date%' | groupby user, system

stream=wind-audit where action='PROCESS_CREATED' and commandline like '%HKCU%Software%Microsoft%Windows%NT%CurrentVersion%Winlogon%' | groupby system, user 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%WinPwn.ps1%mimiload%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%WinPwn.ps1%mimiload%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%HKEY%LOCAL%MACHINE%' or commandline like '%HKLM%' or commandline like '%HKEY%CURRENT%USER%') and ( commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%') and ( commandline like '%%run%' or commandline like '%%runitonce%' or commandline like 'runonce' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%HKEY%LOCAL%MACHINE%' or commandline like '%HKLM%' or commandline like '%HKEY%CURRENT%USER%') and ( commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%') and ( commandline like '%%run%' or commandline like '%%runitonce%' or commandline like 'runonce' ) | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Set-Clipboard%' or commandline like "%clip.exe%" or commandline like '%powershell%Get-Process%' or  commandline like '%powershell%Set-Clipboard%' or  commandline like '%powershell%Get-Clipboard%' or  commandline like '%cmd%echo%' or commandline like "%cmd%clip%" or commandline like "%VBA%GetClipboard%") | select user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Set-Clipboard%' or commandline like "%clip.exe%" or commandline like '%powershell%Get-Process%' or  commandline like '%powershell%Set-Clipboard%' or  commandline like '%powershell%Get-Clipboard%' or  commandline like '%cmd%echo%' or commandline like "%cmd%clip%" or commandline like "%VBA%GetClipboard%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and  commandline like '%hklm%system%control%print%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and  commandline like '%hklm%system%control%print%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%certutil%')and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%certutil%') | groupby user, system  

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%HKEY%LOCAL%MACHINE%' or commandline like '%HKLM%' or commandline like '%HKEY%CURRENT%USER%') and ( commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%') and ( commandline like '%%run%' or commandline like '%%runitonce%' or commandline like 'runonce' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%HKEY%LOCAL%MACHINE%' or commandline like '%HKLM%' or commandline like '%HKEY%CURRENT%USER%') and ( commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%') and ( commandline like '%%run%' or commandline like '%%runitonce%' or commandline like 'runonce' ) | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Set-Clipboard%' or commandline like "%clip.exe%" or commandline like '%powershell%Get-Process%' or  commandline like '%powershell%Set-Clipboard%' or  commandline like '%powershell%Get-Clipboard%' or  commandline like '%cmd%echo%' or commandline like "%cmd%clip%" or commandline like "%VBA%GetClipboard%") | select user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Set-Clipboard%' or commandline like "%clip.exe%" or commandline like '%powershell%Get-Process%' or  commandline like '%powershell%Set-Clipboard%' or  commandline like '%powershell%Get-Clipboard%' or  commandline like '%cmd%echo%' or commandline like "%cmd%clip%" or commandline like "%VBA%GetClipboard%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=signals | duration 5m |  limit 1

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%HKEY%LOCAL%MACHINE%' or commandline like '%HKLM%' or commandline like '%HKEY%CURRENT%USER%') and ( commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%') and ( commandline like '%%run%' or commandline like '%%runitonce%' or commandline like 'runonce' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%HKEY%LOCAL%MACHINE%' or commandline like '%HKLM%' or commandline like '%HKEY%CURRENT%USER%') and ( commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%') and ( commandline like '%%run%' or commandline like '%%runitonce%' or commandline like 'runonce' ) | groupby user, system | duration 5m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%HKEY%LOCAL%MACHINE%' or commandline like '%HKLM%' or commandline like '%HKEY%CURRENT%USER%') and ( commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%') and ( commandline like '%%run%' or commandline like '%%runitonce%' or commandline like 'runonce' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%HKEY%LOCAL%MACHINE%' or commandline like '%HKLM%' or commandline like '%HKEY%CURRENT%USER%') and ( commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%') and ( commandline like '%%run%' or commandline like '%%runitonce%' or commandline like 'runonce' ) | groupby user, system | duration 5m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and  commandline like '%hklm%system%control%print%'

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and  commandline like '%hklm%system%control%print%' | groupby user, system 

stream=signals | duration 5m |  limit 1

stream=win-audit where action='PROCESS_CREATED' and commandline like 'net%time%w32tm%tz' or scriptblocktext like '%Get%Date%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like 'net%time%w32tm%tz' or scriptblocktext like '%Get%Date%' | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%Get-Date%' | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%Get-Date%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe%' or newprocessname like 'cmd.exe') and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe%' or newprocessname like 'cmd.exe') and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%')  | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%' and commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%')  | groupby user, system

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%' and commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%')  | groupby user, system and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((commandline like '%hklm%system%control%print%' or commandline like '%HKEY%LOCAL%MACHINE%SYSTEM%%system%control%print%' or commandline like 'HKEY%LOCAL%MACHINE%SYSTEM%CurrentControlSet%Control%Print%') and commandline like 'spoolsv.exe' or ((commandline like '%hklm%system%control%print%' or commandline like '%HKEY%LOCAL%MACHINE%SYSTEM%%system%control%print%' or commandline like 'HKEY%LOCAL%MACHINE%SYSTEM%CurrentControlSet%Control%Print%') or commandline like 'spoolsv.exe')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((commandline like '%hklm%system%control%print%' or commandline like '%HKEY%LOCAL%MACHINE%SYSTEM%%system%control%print%' or commandline like 'HKEY%LOCAL%MACHINE%SYSTEM%CurrentControlSet%Control%Print%') and commandline like 'spoolsv.exe' or ((commandline like '%hklm%system%control%print%' or commandline like '%HKEY%LOCAL%MACHINE%SYSTEM%%system%control%print%' or commandline like 'HKEY%LOCAL%MACHINE%SYSTEM%CurrentControlSet%Control%Print%') or commandline like 'spoolsv.exe')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like 'net%time%w32tm%tz' or scriptblocktext like '%Get%Date%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like 'net%time%w32tm%tz' or scriptblocktext like '%Get%Date%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%net%time%w32tm%tz%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%net%time%w32tm%tz%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%net%time%w32tm%tz%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%net%time%w32tm%tz%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%net%time%w32tm%tz%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%net%time%w32tm%tz%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%net%time%w32tm%tz%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%net%time%w32tm%tz%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and parentcommandline like '%Get%Process%PPID%Spoof%spawnto%dllpath%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and parentcommandline like '%Get%Process%PPID%Spoof%spawnto%dllpath%' | groupby user, system, commandline

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%' and commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%')  | groupby user, system

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%' and commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') | groupby user, system  

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%net%time%w32tm%tz%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%net%time%w32tm%tz%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%')  | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%')  | groupby user, system

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%')  | groupby user, system | duration 2d

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%')  | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and ((commandline like '%hklm%system%control%print%' or commandline like '%HKEY%LOCAL%MACHINE%SYSTEM%%system%control%print%' or commandline like 'HKEY%LOCAL%MACHINE%SYSTEM%CurrentControlSet%Control%Print%') and commandline like 'spoolsv.exe' or ((commandline like '%hklm%system%control%print%' or commandline like '%HKEY%LOCAL%MACHINE%SYSTEM%%system%control%print%' or commandline like 'HKEY%LOCAL%MACHINE%SYSTEM%CurrentControlSet%Control%Print%') or commandline like 'spoolsv.exe')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and ((commandline like '%hklm%system%control%print%' or commandline like '%HKEY%LOCAL%MACHINE%SYSTEM%%system%control%print%' or commandline like 'HKEY%LOCAL%MACHINE%SYSTEM%CurrentControlSet%Control%Print%') and commandline like 'spoolsv.exe' or ((commandline like '%hklm%system%control%print%' or commandline like '%HKEY%LOCAL%MACHINE%SYSTEM%%system%control%print%' or commandline like 'HKEY%LOCAL%MACHINE%SYSTEM%CurrentControlSet%Control%Print%') or commandline like 'spoolsv.exe')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net use%IPC%' or commandline like '%DomainPasswordSpray%' or commandline like '%usersdpsLight%' or commandline like '%kerbrute.exe%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net use%IPC%' or commandline like '%DomainPasswordSpray%' or commandline like '%usersdpsLight%' or commandline like '%kerbrute.exe%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((commandline like '%hklm%system%control%print%' or commandline like '%HKEY%LOCAL%MACHINE%SYSTEM%%system%control%print%' or commandline like 'HKEY%LOCAL%MACHINE%SYSTEM%CurrentControlSet%Control%Print%') and commandline like 'spoolsv.exe' or ((commandline like '%hklm%system%control%print%' or commandline like '%HKEY%LOCAL%MACHINE%SYSTEM%%system%control%print%' or commandline like 'HKEY%LOCAL%MACHINE%SYSTEM%CurrentControlSet%Control%Print%') or commandline like 'spoolsv.exe')) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and ((commandline like '%hklm%system%control%print%' or commandline like '%HKEY%LOCAL%MACHINE%SYSTEM%%system%control%print%' or commandline like 'HKEY%LOCAL%MACHINE%SYSTEM%CurrentControlSet%Control%Print%') and commandline like 'spoolsv.exe' or ((commandline like '%hklm%system%control%print%' or commandline like '%HKEY%LOCAL%MACHINE%SYSTEM%%system%control%print%' or commandline like 'HKEY%LOCAL%MACHINE%SYSTEM%CurrentControlSet%Control%Print%') or commandline like 'spoolsv.exe')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like '%reg.exe%' and lower(commandline) like '%hklm%software%microsoft%windows%currentversion%policies%system%enablelua%0%' | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and commandline like '%reg.exe%' and lower(commandline) like '%hklm%software%microsoft%windows%currentversion%policies%system%enablelua%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe%' or newprocessname like 'cmd.exe') and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%')  | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%powershell.exe%' or newprocessname like 'cmd.exe') and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where (commandline like '%kerbrute.exe%') | duration 1d

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net use%IPC%' or commandline like '%DomainPasswordSpray%' or commandline like '%usersdpsLight%' or commandline like '%kerbrute.exe%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net use%IPC%' or commandline like '%DomainPasswordSpray%' or commandline like '%usersdpsLight%' or commandline like '%kerbrute.exe%') | groupby user, system |duration 1d

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%hklm%system%control%print%' or commandline like '%HKEY%LOCAL%MACHINE%SYSTEM%%system%control%print%' or commandline like '%HKEY%LOCAL%MACHINE%SYSTEM%CurrentControlSet%Control%Print%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%hklm%system%control%print%' or commandline like '%HKEY%LOCAL%MACHINE%SYSTEM%%system%control%print%' or commandline like '%HKEY%LOCAL%MACHINE%SYSTEM%CurrentControlSet%Control%Print%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and parentcommandline like '%PPID%Spoof%ppid%spawnto%dllpath%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and parentcommandline like '%PPID%Spoof%ppid%spawnto%dllpath%' | groupby user, system, commandline

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%PPID-Spoof%-ppid%-spawnto%.exe%-dllpath%.dll' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%PPID-Spoof%-ppid%-spawnto%.exe%-dllpath%.dll' | groupby user, system, commandline 

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%PPID-Spoof%-ppid%-spawnto%.exe%-dllpath%.dll' | groupby user, system, commandline

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%PPID-Spoof%-ppid%-spawnto%.exe%-dllpath%.dll' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKCU%' or commandline like '%HKEY_LOCAL_MACHINE%') and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%' and (commandline like '%Winlogon%' or commandline like '%Winlogon%explorer.exe%' or commandline like '%Winlogon%Userinit.exe%' or commandline like '%Winlogon%Userinit%' or commandline like '%Winlogon%Notify%') | groupby system, user 

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKCU%' or commandline like '%HKEY_LOCAL_MACHINE%') and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%' and (commandline like '%Winlogon%' or commandline like '%Winlogon%explorer.exe%' or commandline like '%Winlogon%Userinit.exe%' or commandline like '%Winlogon%Userinit%' or commandline like '%Winlogon%Notify%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%')  | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%REG_MULTI_SZ%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net use%IPC%' or commandline like '%DomainPasswordSpray%' or commandline like '%usersdpsLight%' or commandline like '%kerbrute.exe%') | duration 1d

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net use%IPC%' or commandline like '%DomainPasswordSpray%' or commandline like '%usersdpsLight%' or commandline like '%kerbrute.exe%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net use%IPC%' or commandline like '%DomainPasswordSpray%' or commandline like '%usersdpsLight%' or commandline like '%kerbrute.exe%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and parentcommandline like '%PPID%Spoof%ppid%spawnto%exe%dllpath%dll' | groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and parentcommandline like '%PPID%Spoof%ppid%spawnto%exe%dllpath%dll' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%HKCU%Software%Microsoft%Windows%NT%CurrentVersion%Winlogon%'  | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and commandline like '%HKCU%Software%Microsoft%Windows%NT%CurrentVersion%Winlogon%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=authentication where action="LOGIN" and status="FAILED" |  groupby user |  having count_col1 >1000

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKCU%' or commandline like '%HKEY_LOCAL_MACHINE%') and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%' and (commandline like '%Winlogon%' or commandline like '%Winlogon%explorer.exe%' or commandline like '%Winlogon%Userinit.exe%' or commandline like '%Winlogon%Userinit%' or commandline like '%Winlogon%Notify%') | groupby system, user 

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKCU%' or commandline like '%HKEY_LOCAL_MACHINE%') and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%' and (commandline like '%Winlogon%' or commandline like '%Winlogon%explorer.exe%' or commandline like '%Winlogon%Userinit.exe%' or commandline like '%Winlogon%Userinit%' or commandline like '%Winlogon%Notify%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=firewall | duration 5h | select srcip, dstip, sum(txlen) as sumtxlen | groupby srcip, dstip | timeslice 1h | having sumtxlen > 15000

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKCU%' or commandline like '%HKEY_LOCAL_MACHINE%') and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%' and (commandline like '%Winlogon%' or commandline like '%Winlogon%explorer.exe%' or commandline like '%Winlogon%Userinit.exe%' or commandline like '%Winlogon%Userinit%' or commandline like '%Winlogon%Notify%' or commandline like '%Winlogon%Shell%') and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKCU%' or commandline like '%HKEY_LOCAL_MACHINE%') and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%' and (commandline like '%Winlogon%' or commandline like '%Winlogon%explorer.exe%' or commandline like '%Winlogon%Userinit.exe%' or commandline like '%Winlogon%Userinit%' or commandline like '%Winlogon%Notify%' or commandline like '%Winlogon%Shell%') | groupby system, user 

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.(dll|iso|exe|py|sh)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.(dll|iso|exe|py|sh)') | groupby user, system

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and rlike(commandline, 'REG_MULTI_SZ.*?\.(dll|iso|exe|py|sh)') | groupby user, system

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and rlike(commandline, 'REG_MULTI_SZ.*?\.(dll|iso|exe|py|sh)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%certutil%exportPFX%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%certutil%exportPFX%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and rlike(commandline, 'REG_MULTI_SZ.*?\.(iso|exe|py|sh)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and rlike(commandline, 'REG_MULTI_SZ.*?\.(iso|exe|py|sh)') | groupby user, system

stream=configuration where action='CONFIGURATION_CHANGED' and commandline='%Get-CimInstance%Name%svchost.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' | groupby user, system

stream=configuration where action='CONFIGURATION_CHANGED' and commandline='%Get-CimInstance%Name%svchost.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKCU%' or commandline like '%HKEY_LOCAL_MACHINE%') and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%' and (commandline like '%Winlogon%' or commandline like '%Winlogon%explorer.exe%' or commandline like '%Winlogon%Userinit.exe%' or commandline like '%Winlogon%Userinit%' or commandline like '%Winlogon%Notify%' or commandline like '%Winlogon%Shell%') | groupby system, user  and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKCU%' or commandline like '%HKEY_LOCAL_MACHINE%') and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%' and (commandline like '%Winlogon%' or commandline like '%Winlogon%explorer.exe%' or commandline like '%Winlogon%Userinit.exe%' or commandline like '%Winlogon%Userinit%' or commandline like '%Winlogon%Notify%' or commandline like '%Winlogon%Shell%') | groupby system, user 

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and rlike(commandline, 'REG_MULTI_SZ.*?\.(dll|iso|exe|py|sh)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and rlike(commandline, 'REG_MULTI_SZ.*?\.(dll|iso|exe|py|sh)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and command_line='%Get-CimInstance%Name%svchost.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' | groupby user, system

stream=configuration where action='CONFIGURATION_CHANGED' and command_line='%Get-CimInstance%Name%svchost.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%certutil%exportPFX%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKCU%' or commandline like '%HKEY_LOCAL_MACHINE%') and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%' and (commandline like '%Winlogon%' or commandline like '%Winlogon%explorer.exe%' or commandline like '%Winlogon%Userinit.exe%' or commandline like '%Winlogon%Userinit%' or commandline like '%Winlogon%Notify%' or commandline like '%Winlogon%Shell%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKCU%' or commandline like '%HKEY_LOCAL_MACHINE%') and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%' and (commandline like '%Winlogon%' or commandline like '%Winlogon%explorer.exe%' or commandline like '%Winlogon%Userinit.exe%' or commandline like '%Winlogon%Userinit%' or commandline like '%Winlogon%Notify%' or commandline like '%Winlogon%Shell%') | groupby system, user 

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKCU%' or commandline like '%HKEY_LOCAL_MACHINE%') and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%' and (commandline like '%Winlogon%' or commandline like '%Winlogon%explorer.exe%' or commandline like '%Winlogon%Userinit.exe%' or commandline like '%Winlogon%Userinit%' or commandline like '%Winlogon%Notify%' or commandline like '%Winlogon%Shell%') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKCU%' or commandline like '%HKEY_LOCAL_MACHINE%') and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%' and (commandline like '%Winlogon%' or commandline like '%Winlogon%explorer.exe%' or commandline like '%Winlogon%Userinit.exe%' or commandline like '%Winlogon%Userinit%' or commandline like '%Winlogon%Notify%' or commandline like '%Winlogon%Shell%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and rlike(commandline, 'REG_MULTI_SZ.*?\.(dll|iso|exe|py|sh)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and rlike(commandline, 'REG_MULTI_SZ.*?\.(dll|iso|exe|py|sh)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%certutil%exportPFX%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%certutil%exportPFX%') | groupby user, system

stream=win-audit where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%dll%' | groupby system, user

stream=configuration where action='CONFIGURATION_CHANGED' and command_line='%Get-CimInstance%Name%svchost.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' | groupby user, system

stream=configuration where action='CONFIGURATION_CHANGED' and command_line='%Get-CimInstance%Name%svchost.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-pocess where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep_process where action='PROCESS_ADDED' and commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%dll%' | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Run%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Run%' | groupby system, user

stream=win-audit where (newprocessname like "%attrib.exe" and (commandline like '%+h%' or commandline like '%+s%')) and eid='4688' | groupby user, system 

stream=win-audit where (newprocessname like "%attrib.exe" and (commandline like '%+h%' or commandline like '%+s%'))  and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ChildItem%Bookmarks%' or commandline like '%/R C:%Bookmarks%' or commandline like '%/R C:%places.sqlite%' or commandline like '%/s /b%USERPROFILE%Favorites%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ChildItem%Bookmarks%' or commandline like '%/R C:%Bookmarks%' or commandline like '%/R C:%places.sqlite%' or commandline like '%/s /b%USERPROFILE%Favorites%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ChildItem%Bookmarks%' or commandline like '%/R C:%Bookmarks%' or commandline like '%/R C:%places.sqlite%' or commandline like '%/s /b%USERPROFILE%Favorites%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ChildItem%Bookmarks%' or commandline like '%/R C:%Bookmarks%' or commandline like '%/R C:%places.sqlite%' or commandline like '%/s /b%USERPROFILE%Favorites%') | groupby user, system 

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.') | duration 2d 

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' and (commandline like '%HKEY_LOCAL_MACHINE%SYSTEM%CurrentControlSet%Control%Lsa%' or commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%') and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep_process where action='PROCESS_ADDED' and commandline like '%SOFTWARE%Microsoft%Windows%CurrentVersion%Run%' | groupby system, user

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' and commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%' and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.') | groupby system, user

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' and commandline like '%hklm%SYSTEM%CurrentControlSet%Control%Lsa%' and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where (newprocessname like "%attrib.exe" and (commandline like '%+h%' or commandline like '%+s%')) and eid='4688' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where (newprocessname like "%attrib.exe" and (commandline like '%+h%' or commandline like '%+s%')) and eid='4688' | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and parentcommandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and parentcommandline like '%[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12%IEX%Invoke-Inveigh%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like '%reg.exe%' and lower(commandline) like '%hklm%software%microsoft%windows%currentversion%policies%system%enablelua%0%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and commandline like '%reg.exe%' and lower(commandline) like '%hklm%software%microsoft%windows%currentversion%policies%system%enablelua%0%' | duration 15m | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ChildItem%Bookmarks%' or commandline like '%/R C:%Bookmarks%' or commandline like '%/R C:%places.sqlite%' or commandline like '%/s /b%USERPROFILE%Favorites%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ChildItem%Bookmarks%' or commandline like '%/R C:%Bookmarks%' or commandline like '%/R C:%places.sqlite%' or commandline like '%/s /b%USERPROFILE%Favorites%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%Lsa%' and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%Lsa%' and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Services%W32Time%TimeProviders%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Services%W32Time%TimeProviders%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and eid in ('12', '13', '14') and image like '%reg.exe' and targetobject like '%Hidden%' | groupby user, system, targetobject 

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and eid in ('12', '13', '14') and image like '%reg.exe' and targetobject like '%Hidden%' and system='{TargetHost}' and targetobject='{TargetResource}'and user='{SuspectUser}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and commandline='%Get-CimInstance%Name%svchost.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and commandline='%Get-CimInstance%Name%svchost.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' | groupby user, system

stream=firewall |  groupby dstip | select dstip , sum(txlen) |  having sum_col1> 200000

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%certutil%exportPFX%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%certutil%exportPFX%' or commandline like '%RemoteCertTrust.ps1%certutil.exe%') | groupby user, system 

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' and commandline like '%SYSTEM%CurrentControlSet%Control%Lsa%' and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' and commandline like '%SYSTEM%CurrentControlSet%Control%Lsa%' and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%Lsa%' and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Control%Lsa%' and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.') | groupby user, system

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and eid in ('12', '13', '14') and image like '%reg.exe' and targetobject like '%Hidden%' | groupby user, system, targetobject 

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and eid in ('12', '13', '14') and image like '%reg.exe' and targetobject like '%Hidden%' and system='{TargetHost}' and targetobject='{TargetHost}'and user='{SuspectUser}' | duration 6m

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and eid in ('12', '13', '14') and image like '%reg.exe' and targetobject like '%Hidden%' | groupby user, system, targetobject 

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and eid in ('12', '13', '14') and image like '%reg.exe' and targetobject like '%Hidden%' and system='{TargetHost}' and targetobject='{TargetHost}'and user='{SuspectUser}' | duration 6m

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and eid in ('12', '13', '14') and image like '%reg.exe' and targetobject like '%Hidden%' | groupby user, system, targetobject 

stream=configuration where action='CONFIGURATION_CHANGED' and commandline like '%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%-ParentId%' | groupby user, system

stream=configuration where action='CONFIGURATION_CHANGED' and commandline='%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%-ParentId%' user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and commandline like '%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%-ParentId%' | groupby user, system

stream=configuration where action='CONFIGURATION_CHANGED' and commandline='%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%-ParentId%' user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Control%Lsa%' and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Control%Lsa%' and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and eid in ('12', '13', '14') and image like '%reg.exe' and targetobject like '%Hidden%' and system='{TargetHost}' and targetobject='{TargetHost}'and user='{SuspectUser}' | duration 6m

stream=EP-REGISTRY where action='OBJECT_MODIFIED' and eid in ('12', '13', '14') and image like '%reg.exe' and targetobject like '%Hidden%' | groupby user, system, targetobject 

stream=configuration where action='CONFIGURATION_CHANGED' and (commandline like '%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%-ParentId%' or commandline like '%Start-Process%-FilePath%-PassThru%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and (commandline like '%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%-ParentId%' or commandline like '%Start-Process%-FilePath%-PassThru%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%') | groupby user, system

stream=IAM where user like '% ' or user like '%$%'| duration 1d 

stream=IAM where action='USER_CREATED' and eid='4720' and (targetuser like '% ' or targetuser like '%$%') | groupby user, targetuser 

stream=IAM where action='USER_CREATED' and eid='4720' and (targetuser like '% ' or targetuser like '%$%') and targetuser='{TargetUser}' and user='{SuspectUser}'| duration 6m

stream=IAM where action='USER_CREATED' and eid='4720' and (targetuser like '% ' or targetuser like '%$%') | groupby user, targetuser | duration 1d

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%schtasks%/run%microsoft%windows%diskcleanup%silentcleanup%/i%' and user='{SuspectUser}' and system='{Targethost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%schtasks%/run%microsoft%windows%diskcleanup%silentcleanup%/i%' | groupby user, system

stream=win-audit where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%' | groupby system, user

stream=win-audit where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=IAM where action='USER_CREATED' and eid='4720' and (targetuser like '% ' or targetuser like '%$%') and targetuser='{TargetUser}' and user='{SuspectUser}'| duration 6m

stream=IAM where action='USER_CREATED' and eid='4720' and (targetuser like '% ' or targetuser like '%$%') | groupby user, targetuser 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or commandline like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or commandline like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or commandline like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or commandline like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or commandline like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or commandline like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%' | groupby user, system

stream=win-audit where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%' | groupby system, user

stream=win-audit where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%system%control%print%' or commandline like '%SYSTEM%CurrentControlSet%Control%Print%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%system%control%print%' or commandline like '%SYSTEM%CurrentControlSet%Control%Print%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%' | groupby system, user

stream=ep-pocess where action='PROCESS_ADDED' and commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep_process where action='PROCESS_ADDED' and (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') | groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%Get-ChildItem%Export-PfxCertificate%') | groupby user , system | duration 1d

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Services%W32Time%TimeProviders%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Services%W32Time%TimeProviders%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Services%W32Time%TimeProviders%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Services%W32Time%TimeProviders%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Services%W32Time%TimeProviders%' | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Services%W32Time%TimeProviders%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%' | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%schtasks%/run%microsoft%windows%diskcleanup%silentcleanup%/i%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%schtasks%/run%microsoft%windows%diskcleanup%silentcleanup%/i%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%Winlogon%' and rlike(commandline, '(Shell|Userinit|Notify)\\.*?\.') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%Winlogon%' and rlike(commandline, '(Shell|Userinit|Notify)\\.*?\.') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%sc.exe%create%sc sdset%' | groupby user, system

stream=win-audit where (commandline like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or commandline like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or commandline like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or commandline like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') or (scriptblocktext like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or scriptblocktext like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or scriptblocktext like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or scriptblocktext like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') | groupby system, user

stream=win-audit where (commandline like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or commandline like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or commandline like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or commandline like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') or (scriptblocktext like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or scriptblocktext like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or scriptblocktext like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or scriptblocktext like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%schtasks%/run%microsoft%windows%diskcleanup%silentcleanup%/i%' and user='{SuspectUser}' and system='{Targethost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%schtasks%/run%microsoft%windows%diskcleanup%silentcleanup%/i%' | duration 1h | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%schtasks%/run%microsoft%windows%diskcleanup%silentcleanup%/i%' and user='{SuspectUser}' and system='{Targethost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%schtasks%/run%microsoft%windows%diskcleanup%silentcleanup%/i%' | groupby user, system

stream=win-audit where (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') | groupby system, user

stream=win-audit where (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%schtasks%/run%microsoft%windows%diskcleanup%silentcleanup%/i%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%schtasks%run%microsoft%windows%diskcleanup%silentcleanup%i%' and user='{SuspectUser}' and system='{Targethost}' | duration 6m

stream=ep-pocess where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%dll%' | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%' | groupby system, user

stream=ep-pocess where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-pocess where action='PROCESS_ADDED' and commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 21m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%' | groupby system, user | duration 20m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or commandline like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or commandline like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or commandline like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%mkdir%temp%dir%.docx%findstr%e%.docx%in%copy%temp%' or commandline like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or commandline like '%Get-Service%env:TEMP%.txt%Get-ChildItem%env:%.txt%Get-Process%env:TEMP%.txt%' or commandline like '%sc%query%type=service%TEMP%.txt%doskey%history%TEMP%.txt%wmic%process%list%TEMP%.txt%tree%.txt%') | groupby system, user

stream=ep_process where action='PROCESS_ADDED' and (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') | groupby system, user

stream=ep_process where action='PROCESS_ADDED' and (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%' | groupby system, user

stream=ep-pocess where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%' | groupby system, user

stream=ep-pocess where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%' | groupby system, user

stream=win-audit where commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and upper(commandline) like '%software%microsoft%windows%currentversion%run%' | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and upper(commandline) like '%software%microsoft%windows%currentversion%run%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%powershell.exe%WindowStyle hidden calc.exe%' | duration 2h

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Remove-ADGroupMember%-Identity%Domain%Admins%-Members%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Remove-ADGroupMember%-Identity%Domain%Admins%-Members%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%sc.exe%create%sc sdset%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%sc.exe%create%sc sdset%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%certutil%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%certutil%') | groupby user, system  

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%Get-ChildItem%Export-PfxCertificate%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%Get-ChildItem%Export-PfxCertificate%') | groupby user , system 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%powershell.exe%WindowStyle hidden%calc.exe%') 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%powershell.exe%WindowStyle hidden calc.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Get-ADUser%-Properties%memberof).memberof%-like%CN=Domain%Admins%Remove-ADGroupMember%-Identity%Domain%Admins%-Members%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Get-ADUser%-Properties%memberof).memberof%-like%CN=Domain%Admins%Remove-ADGroupMember%-Identity%Domain%Admins%-Members%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%sc.exe%create%sc sdset%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%sc.exe%create%sc sdset%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%certutil%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%certutil%') | groupby user, system  

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and  (commandline like '%nircmd.exe%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and  (commandline like '%nircmd.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and  (commandline like '%nircmd.exe%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and  (commandline like '%nircmd.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (commandline like '%nircmd.exe%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and lower(commandline) like '%software%microsoft%windows%currentversion%run%' | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and lower(commandline) like '%software%microsoft%windows%currentversion%run%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%powershell.exe%WindowStyle hidden%calc.exe%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%powershell.exe%WindowStyle hidden%calc.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%ConvertTo-SecureString%Get-ChildItem -Path%Export-PfxCertificate%-FilePath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%ConvertTo-SecureString%Get-ChildItem -Path%Export-PfxCertificate%-FilePath%') | groupby user , system 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') | groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell%' commandline like '%Export-PfxCertificate%' or commandline like '%Get-ChildItem%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and  (commandline like '%nircmd.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and  (commandline like '%nircmd.exe%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%powershell.exe%WindowStyle hidden calc.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%powershell.exe%WindowStyle hidden calc.exe%') | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%Get-ChildItem%Export-PfxCertificate%')and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%Get-ChildItem%Export-PfxCertificate%') | groupby user , system | duration 1d

stream=win-audit where action='PROCESS_CREATED'  and rlike(lower(commandline), 'powershell.exe.*(copy-item|move-item).*(c\\$|d\\$|admin\\$|a\\$|ipc\\$|print\\$)') | groupby system, user

stream=win-audit where action='PROCESS_CREATED'  and rlike(lower(commandline), 'powershell.exe.*(copy-item|move-item).*(c\\$|d\\$|admin\\$|a\\$|ipc\\$|print\\$)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%Get-ChildItem%Export-PfxCertificate%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%ConvertTo-SecureString%Get-ChildItem -Path%Export-PfxCertificate%-FilePath%') | groupby user , system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%ConvertTo-SecureString%Get-ChildItem -Path%Export-PfxCertificate%-FilePath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%ConvertTo-SecureString%Get-ChildItem -Path%Export-PfxCertificate%-FilePath%') | groupby user , system 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%ConvertTo-SecureString%Get-ADUser%-Properties%Remove-ADGroupMember%-Identity%-Members%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%ConvertTo-SecureString%Get-ADUser%-Properties%Remove-ADGroupMember%-Identity%-Members%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%system%control%print%' or commandline like '%SYSTEM%CurrentControlSet%Control%Print%') and rlike(commandline, '(bin\\.*?\.)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%system%control%print%' or commandline like '%SYSTEM%CurrentControlSet%Control%Print%') and rlike(commandline, '(bin\\.*?\.)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Export-Certificate%')  | groupby user , system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%%Export-Certificate%')  | duration 2h

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%%Export-Certificate%') | groupby user, system | duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%%Export-Certificate%')and system='{TargetHost}' | duration 6 m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%ConvertTo-SecureString%New-Object%Get-ADUser%-Properties%Remove-ADGroupMember%-Identity%-Members%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%ConvertTo-SecureString%New-Object%Get-ADUser%-Properties%Remove-ADGroupMember%-Identity%-Members%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%ConvertTo-SecureString%New-Object%Get-ADUser%-Properties%Remove-ADGroupMember%-Identity%-Members%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%ConvertTo-SecureString%New-Object%Get-ADUser%-Properties%Remove-ADGroupMember%-Identity%-Members%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz%exe%crypto%certificate%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6 m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz%exe%crypto%certificate%export%') | groupby user,system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz%exe%crypto%certificate%export%') | groupby user,system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz%exe%crypto%certificate%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%Login Data%' and rlike(commandline, 'bin\\.*?\.') 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Get-ADUser%-Properties%memberof%-like%CN=Domain%Admins%Remove-ADGroupMember%-Identity%Domain%Admins%-Members%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Get-ADUser%-Properties%memberof%-like%CN=Domain%Admins%Remove-ADGroupMember%-Identity%Domain%Admins%-Members%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Services%W32Time%TimeProviders%' and rlike(commandline, '(REG_SZ.*?\\.*?\.|REG_DWORD.*?Enabled|REG_DWORD\s+.*?InputProvider)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%SYSTEM%CurrentControlSet%Services%W32Time%TimeProviders%' and rlike(commandline, '(REG_SZ.*?\\.*?\.|REG_DWORD.*?Enabled|REG_DWORD\s+.*?InputProvider)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%powershell.exe%ConvertTo-SecureString%Get-ChildItem -Path%Export-PfxCertificate%-FilePath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%powershell.exe%ConvertTo-SecureString%Get-ChildItem -Path%Export-PfxCertificate%-FilePath%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%ConvertTo-SecureString%Get-ADUser%-Properties%Remove-ADGroupMember%-Identity%-Members%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%ConvertTo-SecureString%Get-ADUser%-Properties%Remove-ADGroupMember%-Identity%-Members%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%ConvertTo-SecureString%New-Object%Get-ADUser%-Properties%Remove-ADGroupMember%-Identity%-Members%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%ConvertTo-SecureString%New-Object%Get-ADUser%-Properties%Remove-ADGroupMember%-Identity%-Members%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Connect-AzureAD%Remove-AzureADUser%-ObjectId%' or commandline like '%az login%az ad user delete%--id%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Connect-AzureAD%Remove-AzureADUser%-ObjectId%' or commandline like '%az login%az ad user delete%--id%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%' and rlike(commandline, 'bin\\.*?\.') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%' and rlike(commandline, 'bin\\.*?\.') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "echo.*?\\>.*?\\\.\.*?pipe") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "echo.*?\\>.*?\\\.\.*?pipe") | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%crypto%certificates%/system%export%' or commandline like '%crypto%certificates%export%' or commandline like 'crypto%key%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower (commandline) like '%crypto%certificates%/system%export%' or lower (commandline) like '%crypto%certificates%export%' or lower(commandline) like 'crypto%key%export%') | groupby user,system 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Services%W32Time%TimeProviders%' and rlike(commandline, '(REG_SZ.*?\\.*?\.|REG_DWORD.*?Enabled|REG_DWORD\s+.*?InputProvider)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Services%W32Time%TimeProviders%' and rlike(commandline, '(REG_SZ.*?\\.*?\.|REG_DWORD.*?Enabled|REG_DWORD\s+.*?InputProvider)') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Services%W32Time%TimeProviders%' and rlike(commandline, '(REG_SZ.*?\\.*?\.|REG_DWORD.*?Enabled|REG_DWORD\s+.*?InputProvider)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%SYSTEM%CurrentControlSet%Services%W32Time%TimeProviders%' and rlike(commandline, '(REG_SZ.*?\\.*?\.|REG_DWORD.*?Enabled|REG_DWORD\s+.*?InputProvider)') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%powershell.exe%ConvertTo-SecureString%Get-ChildItem -Path%Export-PfxCertificate%-FilePath%') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|sid\\:\\:patch|sid\\:\\:lookup|kerberos\\:\\:golden|kerberos\\:\\:tgt)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|sid\\:\\:patch|sid\\:\\:lookup|kerberos\\:\\:golden|kerberos\\:\\:tgt)") | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|sid\\:\\:patch|sid\\:\\:lookup|kerberos\\:\\:golden|kerberos\\:\\:tgt)")  | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|sid\\:\\:patch|sid\\:\\:lookup|kerberos\\:\\:golden|kerberos\\:\\:tgt)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (newprocessname like '%VBoxManage.exe%' and (commandline like 'VBoxManage%register%' or commandline like '%VirtualBox%register%')) or (commandline like '%VBoxManage.exe%startvm%' or commandline like '%VBoxManage.exe%createvm%' or commandline like '%create%VirtualBox%' or commandline like '%VirtualBox%createvm%' or commandline like '%VirtualBox%modifyvm%' or commandline like  '%VirtualBox%startvm%' or commandline like '%powershell.exe%Start-VM%' or commandline like '%powershell.exe%New-VM%' or commandline like '%startvm%VirtualBox%') | | duration 1d 

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (newprocessname like '%VBoxManage.exe%' and (commandline like 'VBoxManage%register%' or commandline like '%VirtualBox%register%')) or (commandline like '%VBoxManage.exe%startvm%' or commandline like '%VBoxManage.exe%createvm%' or commandline like '%create%VirtualBox%' or commandline like '%VirtualBox%createvm%' or commandline like '%VirtualBox%modifyvm%' or commandline like  '%VirtualBox%startvm%' or commandline like '%powershell.exe%Start-VM%' or commandline like '%powershell.exe%New-VM%' or commandline like '%startvm%VirtualBox%') system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (newprocessname like '%VBoxManage.exe%' and (commandline like 'VBoxManage%register%' or commandline like '%VirtualBox%register%')) or (commandline like '%VBoxManage.exe%startvm%' or commandline like '%VBoxManage.exe%createvm%' or commandline like '%create%VirtualBox%' or commandline like '%VirtualBox%createvm%' or commandline like '%VirtualBox%modifyvm%' or commandline like  '%VirtualBox%startvm%' or commandline like '%powershell.exe%Start-VM%' or commandline like '%powershell.exe%New-VM%' or commandline like '%startvm%VirtualBox%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (lower(commandline) like '%reg add%hklm%software%microsoft%windows nt%currentversion%winlogon%specialaccounts%userlist%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (lower(commandline) like '%reg add%hklm%software%microsoft%windows nt%currentversion%winlogon%specialaccounts%userlist%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%ConvertTo-SecureString%Get-ADUser%-Properties%Remove-ADGroupMember%-Identity%-Members%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%ConvertTo-SecureString%Get-ADUser%-Properties%Remove-ADGroupMember%-Identity%-Members%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%ConvertTo-SecureString%Get-ADUser%-Properties%Remove-ADGroupMember%-Identity%-Members%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%ConvertTo-SecureString%Get-ADUser%-Properties%Remove-ADGroupMember%-Identity%-Members%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%%Export-Certificate%') | groupby user , system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%%Export-Certificate%') | groupby user, system | duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%%Export-Certificate%')and system='{TargetHost}' | duration 6 m

stream=ep-process where action='PROCESS_ADDED' and image='jsc.exe' and (parentcommandline like '%.js%' or parentcommandline like '%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image='jsc.exe' and (parentcommandline like '%.js%' or parentcommandline like '%.dll%') | groupby system, user, commandline

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(ParentImage, "(powershell\.exe|cmd\.exe)") and commandline like "%eventvwr%" | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(ParentImage, "(powershell\.exe|cmd\.exe)") and commandline like "%eventvwr%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (newprocessname like '%VBoxManage.exe%' and (commandline like 'VBoxManage%register%' or commandline like '%VirtualBox%register%')) or (commandline like '%VBoxManage.exe%startvm%' or commandline like '%VBoxManage.exe%createvm%' or commandline like '%create%VirtualBox%' or commandline like '%VirtualBox%createvm%' or commandline like '%VirtualBox%modifyvm%' or commandline like  '%VirtualBox%startvm%' or commandline like '%powershell.exe%Start-VM%' or commandline like '%powershell.exe%New-VM%' or commandline like '%startvm%VirtualBox%') | groupby user, system | duration 1d 

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (newprocessname like '%VBoxManage.exe%' and (commandline like 'VBoxManage%register%' or commandline like '%VirtualBox%register%')) or (commandline like '%VBoxManage.exe%startvm%' or commandline like '%VBoxManage.exe%createvm%' or commandline like '%create%VirtualBox%' or commandline like '%VirtualBox%createvm%' or commandline like '%VirtualBox%modifyvm%' or commandline like  '%VirtualBox%startvm%' or commandline like '%powershell.exe%Start-VM%' or commandline like '%powershell.exe%New-VM%' or commandline like '%startvm%VirtualBox%') system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (newprocessname like '%VBoxManage.exe%' and (commandline like 'VBoxManage%register%' or commandline like '%VirtualBox%register%')) or (commandline like '%VBoxManage.exe%startvm%' or commandline like '%VBoxManage.exe%createvm%' or commandline like '%create%VirtualBox%' or commandline like '%VirtualBox%createvm%' or commandline like '%VirtualBox%modifyvm%' or commandline like  '%VirtualBox%startvm%' or commandline like '%powershell.exe%Start-VM%' or commandline like '%powershell.exe%New-VM%' or commandline like '%startvm%VirtualBox%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (newprocessname like '%VBoxManage.exe%' and (commandline like 'VBoxManage%register%' or commandline like '%VirtualBox%register%')) or (commandline like '%VBoxManage.exe%startvm%' or commandline like '%VBoxManage.exe%createvm%' or commandline like '%create%VirtualBox%' or commandline like '%VirtualBox%createvm%' or commandline like '%VirtualBox%modifyvm%' or commandline like  '%VirtualBox%startvm%' or commandline like '%powershell.exe%Start-VM%' or commandline like '%powershell.exe%New-VM%' or commandline like '%startvm%VirtualBox%') | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower (commandline) like '%crypto%certificates%/system%export%' or lower (commandline) like '%crypto%certificates%export%' or lower(commandline) like 'crypto%key%export%') | duration 30m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower (commandline) like '%crypto%certificates%/system%export%' or lower (commandline) like '%crypto%certificates%export%' or lower(commandline) like 'crypto%key%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 31m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%%Export-Certificate%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6 m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%%Export-Certificate%') | groupby user, system | duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%%Export-Certificate%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6 m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%%Export-Certificate%') | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz_exe%%export%%crypto%') | groupby user,system | duration 1 d

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(ParentImage, "(powershell\.exe|cmd\.exe)") and commandline like "%eventvwr%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(ParentImage, "(powershell\.exe|cmd\.exe)") and commandline like "%eventvwr%" | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz_exe%%export%%crypto%') | groupby user,system | duration 1 d

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (newprocessname like '%VBoxManage.exe%' and (commandline like 'VBoxManage%register%' or commandline like '%VirtualBox%register%')) or (commandline like '%VBoxManage.exe%startvm%' or commandline like '%VBoxManage.exe%createvm%' or commandline like '%create%VirtualBox%' or commandline like '%VirtualBox%createvm%' or commandline like '%VirtualBox%modifyvm%' or commandline like  '%VirtualBox%startvm%' or commandline like '%powershell.exe%Start-VM%' or commandline like '%powershell.exe%New-VM%' or commandline like '%startvm%VirtualBox%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (newprocessname like '%VBoxManage.exe%' and (commandline like 'VBoxManage%register%' or commandline like '%VirtualBox%register%')) or (commandline like '%VBoxManage.exe%startvm%' or commandline like '%VBoxManage.exe%createvm%' or commandline like '%create%VirtualBox%' or commandline like '%VirtualBox%createvm%' or commandline like '%VirtualBox%modifyvm%' or commandline like  '%VirtualBox%startvm%' or commandline like '%powershell.exe%Start-VM%' or commandline like '%powershell.exe%New-VM%' or commandline like '%startvm%VirtualBox%') system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "echo.*?\\>.*?\\\.\.*?pipe") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "echo.*?\\>.*?\\\.\.*?pipe") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'bin.*?(LaZagne.exe|LaZagne)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'bin.*?(LaZagne.exe|LaZagne)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (lower(commandline) like '%reg add%hklm%software%microsoft%windows nt%currentversion%winlogon%specialaccounts%userlist%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (lower(commandline) like '%reg add%hklm%software%microsoft%windows nt%currentversion%winlogon%specialaccounts%userlist%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'bin.*?(LaZagne.exe|LaZagne)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'bin.*?(LaZagne.exe|LaZagne)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'split\-path.*?bin.*?(\.|LaZagne.exe|LaZagne)') | groupby user, system | duration 1h

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'split\-path.*?bin.*?(\.|LaZagne.exe|LaZagne)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'split\-path.*?bin.*?(\.|LaZagne.exe|LaZagne)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'split\-path.*?bin.*?(\.|LaZagne.exe|LaZagne)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%PPID-Spoof%-ppid%-spawnto%.exe%-dllpath%.dll%' | groupby user, system, commandline

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%PPID-Spoof%-ppid%-spawnto%.exe%-dllpath%.dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%generaldomaininfo%-noninteractive%-consoleoutput%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%generaldomaininfo%-noninteractive%-consoleoutput%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%get-aduser%remove-adgroupmember%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%get-aduser%remove-adgroupmember%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%remove-adgroupmember%' or lower(commandline) like '%net group%/delete%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%remove-adgroupmember%' or lower(commandline) like '%net group%/delete%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-FILE where action="FILE_CREATED" and rlike(lower(targetfilename),"\\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") | groupby substring_index(targetfilename,"\\",-1), targetfilename, user, system | select substring_index(targetfilename,"\\",-1) as file, targetfilename, user, system 

stream=EP-FILE where action="FILE_CREATED" and rlike(lower(targetfilename),"\\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") and targetfilename="{SuspectObject}" and user="{SuspectUser}" and system="{TargetHost}" | duraton 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and ( lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%"  or lower(commandline) like "%appcmd%set%config%section%httplogging%dontlog%true%" or rlike(lower(commandline),"(hklm|hkey_local_machine).*?software.*?microsoft.*?iis.*?httplogging.*?logextfileflags.*?0"))  | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and ( lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%"  or lower(commandline) like "%appcmd%set%config%section%httplogging%dontlog%true%" or rlike(lower(commandline),"(hklm|hkey_local_machine).*?software.*?microsoft.*?iis.*?httplogging.*?logextfileflags.*?0")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'bin.*?(LaZagne.exe|LaZagne)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'bin.*?(LaZagne.exe|LaZagne)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(generaldomaininfo|winpwn).*?-(noninteractive|consoleoutput|domainrecon)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(generaldomaininfo|winpwn).*?-(noninteractive|consoleoutput|domainrecon)') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(newprocessname), ".(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") | groupby NewProcessName, substring_index(NewProcessName,"\\",-1), user, system | select newprocessname, substring_index(NewProcessName,"\\",-1) as processname, user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(newprocessname), ".(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") and newprocessname="{SuspectObject}" and user="{SuspectUser}" and system="{TargetHost}" | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") | groupby user, system, commandline 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") and user="{SuspectUser}" and system="{TargetHost}" | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'wevtutil.*?(epl|export-log).*?c:.*?(q|sq|lf|ow):.*?system.*?eventid=4776') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'wevtutil.*?(epl|export-log).*?c:.*?(q|sq|lf|ow):.*?system.*?eventid=4776') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%PPID-Spoof%-ppid%-spawnto%.exe%-dllpath%.dll%' | groupby user, system, parentcommandline 

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%PPID-Spoof%-ppid%-spawnto%.exe%-dllpath%.dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline), 'bitsadmin\..*?transfer.*?download.*?priority.*?foreground') or rlike(lower(commandline), 'bitsadmin\..*?(addfile|create|setnotifycmdline|resume|complete|ping -n)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline), 'bitsadmin\..*?transfer.*?download.*?priority.*?foreground') or rlike(lower(commandline), 'bitsadmin\..*?(addfile|create|setnotifycmdline|resume|complete|ping -n)')) | groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline), 'bitsadmin\..*?transfer.*?download.*?priority.*?foreground') or rlike(lower(commandline), 'bitsadmin\..*?(addfile|create|setnotifycmdline|resume|complete|ping -n)')) | groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline), 'bitsadmin\..*?transfer.*?download.*?priority.*?foreground') or rlike(lower(commandline), 'bitsadmin\..*?(addfile|create|setnotifycmdline|resume|complete|ping -n)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe%' and (lower(commandline) like '%start-bitstransfer%priority%foreground%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe%' and (lower(commandline) like '%start-bitstransfer%priority%foreground%') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'system.*?currentcontrolset.*?services.*?w32time.*?timeproviders.*?(reg_z.*?\\.*?\.|reg_dword.*?enabled|reg_dword\s+.*?inputprovider)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'system.*?currentcontrolset.*?services.*?w32time.*?timeproviders.*?(reg_z.*?\\.*?\.|reg_dword.*?enabled|reg_dword\s+.*?inputprovider)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'split\-path.*?bin.*?(\.|LaZagne.exe|LaZagne)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'split\-path.*?bin.*?(\.|LaZagne.exe|LaZagne)') | groupby user, system | duration 1h

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(newprocessname), "(reg.exe|regedit.exe)") and rlike(lower(commandline), "reg.*add.*?/v.*?(showsuperhidden|hidden).*/t.*?(reg_dword|reg_sz|reg_expand|reg_binary).*/d.*/f")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(newprocessname), "(reg.exe|regedit.exe)") and rlike(lower(commandline), "reg.*add.*?/v.*?(showsuperhidden|hidden).*/t.*?(reg_dword|reg_sz|reg_expand|reg_binary).*/d.*/f")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=authentication

stream=configuration where action='CONFIGURATION_CHANGED' and commandline like '%Get-CimInstance%Name%svchost.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' | groupby user, system

stream=configuration where action='CONFIGURATION_CHANGED' and commandline like '%Get-CimInstance%Name%svchost.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image like '%jsc.exe%' and (parentcommandline like '%.js%' or parentcommandline like '%.dll%') | groupby system, user, commandline

stream=ep-process where action='PROCESS_ADDED' and image like '%jsc.exe%' and (parentcommandline like '%.js%' or parentcommandline like '%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%get-childitem%Mozilla%Firefox%Profiles%' and rlike(commandline, 'ExternalPayloads.*?\.') and system='{TargetHost}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%get-childitem%Mozilla%Firefox%Profiles%' and rlike(commandline, 'ExternalPayloads.*?\.') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%net user%/active:yes%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%net user%/active:yes%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like "%powershell.exe%" and commandline like "%set%WebConfigurationProperty%PSPath%IIS%system.webServer%httpLogging%name%dontLog%value%true%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and newprocessname like "%powershell.exe%" and commandline like "%set%WebConfigurationProperty%PSPath%IIS%system.webServer%httpLogging%name%dontLog%value%true%" | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%jsc.exe%' and (commandline like '%.js%' or commandline like '%.dll%') | groupby system, user, commandline

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%jsc.exe%' and (commandline like '%.js%' or commandline like '%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%get-childitem%Mozilla%Firefox%Profiles%' and rlike(commandline, 'ExternalPayloads.*?\.') and system='{TargetHost}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%get-childitem%Mozilla%Firefox%Profiles%' and rlike(commandline, 'ExternalPayloads.*?\.') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%get-childitem%Mozilla%Firefox%Profiles%' and rlike(commandline, 'ExternalPayloads.*?\.') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%get-childitem%Mozilla%Firefox%Profiles%' and rlike(commandline, 'ExternalPayloads.*?\.') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%crypto%certificates%/system%export%' or commandline like '%crypto%certificates%export%' or commandline like 'crypto%key%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%crypto%certificates%/system%export%' or commandline like '%crypto%certificates%export%' or commandline like 'crypto%key%export%') | groupby user,system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%crypto%certificates%/system%export%' or commandline like '%crypto%certificates%export%' or commandline like 'crypto%key%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%crypto%certificates%/system%export%' or commandline like '%crypto%certificates%export%' or commandline like 'crypto%key%export%') | groupby user,system 

stream=ep-process where action='PROCESS_ADDED' and image like '%MSBuild.exe' and (commandline like '%.csproj%' or commandline like '%.xml%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image like '%MSBuild.exe' and (commandline like '%.csproj%' or commandline like '%.xml%') | groupby system, user, commandline

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%net user%/active:yes%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%net user%/active:yes%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') | groupby user, system  

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') | groupby user, system  

stream=configuration where action='CONFIGURATION_CHANGED' and (commandline like '%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%-ParentId%' or commandline like '%Start-Process%-FilePath%-PassThru%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%') and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and (commandline like '%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%-ParentId%' or commandline like '%Start-Process%-FilePath%-PassThru%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%') | groupby system, commandline

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Opera%Stable%Login Data%' or commandline like '%Chrome%User Data%Default%Login Data%' or commandline like '%Mozilla%Firefox%' or commandline like '%Microsoft%Edge%User Data%' )  | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Software%Opera%Stable%Login Data%' or commandline like '%Chrome%User Data%Default%Login Data%' or commandline like '%Mozilla%Firefox%' or commandline like '%Microsoft%Edge%User Data%' ) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%mimikatz%exe%crypto%certificate%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%crypto%certificates%/system%export%' or commandline like '%crypto%certificates%export%' or commandline like 'crypto%key%export%') | groupby user,system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%crypto%certificates%/system%export%' or commandline like '%crypto%certificates%export%' or commandline like 'crypto%key%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%crypto%certificates%/system%export%' or commandline like '%crypto%certificates%export%' or commandline like 'crypto%key%export%') | groupby user,system 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%net user%/active:yes%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%net user%/active:yes%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%net user%/active:yes%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%net user%/active:yes%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') | groupby user, system  

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') | groupby user, system  

stream=signals

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') | groupby user, system  

stream=EP-PROCESS where action='PROCESS_ADDED and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower (commandline) like '%crypto%certificates%/system%export%' or lower (commandline) like '%crypto%certificates%export%' or lower(commandline) like 'crypto%key%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower (commandline) like '%crypto%certificates%/system%export%' or lower (commandline) like '%crypto%certificates%export%' or lower(commandline) like 'crypto%key%export%') | groupby user,system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%convertto-securestring%fet-childitem -path%export-pfxcertificate%-filepath%') | groupby user , system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%convertto-securestring%fet-childitem -path%export-pfxcertificate%-filepath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=azure where action='AZURE_AUDIT' and category='RoleManagement' and activitydisplayname='Add member to role' and result='success' | groupby user, targetuser

stream=azure where action='AZURE_AUDIT' and category='RoleManagement' and activitydisplayname='Add member to role' and result='success' and user='{SuspectUser}' and targetuser='{TargetUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%mmc20.application%calc.exe%') and eid='1' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%mmc20.application%calc.exe%') and eid='1' | groupby system, user 

stream=azure where action='AZURE_AUDIT' and category='ApplicationManagement' and activitydisplayname='Add service principal' and result='success' and user='{SuspectUser}' and targetuser='{TargetUser}' | duration 6m

stream=azure where action='AZURE_AUDIT' and category='ApplicationManagement' and activitydisplayname='Add service principal' and result='success' | groupby user, targetuser

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%iex%invoke%inveigh%nbns%mdns%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%iex%invoke%inveigh%nbns%mdns%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%convertto-securestring%fet-childitem -path%export-pfxcertificate%-filepath%') | groupby user , system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%convertto-securestring%fet-childitem -path%export-pfxcertificate%-filepath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%convertto-securestring%fet-childitem -path%export-pfxcertificate%-filepath%') | groupby user , system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%powershell.exe%convertto-securestring%fet-childitem -path%export-pfxcertificate%-filepath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%powershell.exe%mmc20.application%calc.exe%') and eid='4688' | groupby system, user 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%powershell.exe%mmc20.application%calc.exe%') and eid='4688' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=authentication

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%powershell.exe%Enable-PSRemoting%' or commandline like '%powershell.exe%Enable-PSRemoting%whoami%' or commandline like '%powershell.exe%evil-winrm%') and eid='1' | groupby user, system |duration 4h

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%powershell.exe%Enable-PSRemoting%' or commandline like '%powershell.exe%Enable-PSRemoting%whoami%' or commandline like '%powershell.exe%evil-winrm%') and eid='1' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=AZURE where operationname in ('MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/WRITE', 'MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/RUNBOOKS/WRITE') and status='PASSED' and user='{SuspectUser}' | duration 6m

stream=AZURE where operationname in ('MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/WRITE', 'MICROSOFT.AUTOMATION/AUTOMATIONACCOUNTS/RUNBOOKS/WRITE') and status='PASSED' | groupby user

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') | groupby user, system | duration 1d

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') | groupby user, system | duration 1d

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%mmc20.application%calc.exe%') | groupby system, user | duration 2h

stream=AZURE where operationname in ('MICROSOFT.EVENTHUB/NAMESPACES/EVENTHUBS/DELETE', 'MICROSOFT.EVENTHUB/NAMESPACES/DELETE') and status='PASSED' | groupby user | duration 30d

stream=AZURE where operationname in ('MICROSOFT.EVENTHUB/NAMESPACES/EVENTHUBS/DELETE', 'MICROSOFT.EVENTHUB/NAMESPACES/DELETE') and status='PASSED' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%powershell.exe%Enable-PSRemoting%' or commandline like '%powershell.exe%Enable-PSRemoting%whoami%' or commandline like '%powershell.exe%evil-winrm%') and eid='1' | duration 4h

stream=azure where action='AZURE_AUDIT' and category='RoleManagement' and activitydisplayname='Add member to role' and result='success' | groupby user, targetuser

stream=azure where action='AZURE_AUDIT' and category='RoleManagement' and activitydisplayname='Add member to role' and result='success' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%' and rlike(commandline, 'bin\\.*?\.') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%' and rlike(commandline, 'bin\\.*?\.') | groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower (commandline) like '%crypto%certificates%/system%export%' or lower (commandline) like '%crypto%certificates%export%' or lower(commandline) like 'crypto%key%export%') | groupby user,system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower (commandline) like '%crypto%certificates%/system%export%' or lower (commandline) like '%crypto%certificates%export%' or lower(commandline) like 'crypto%key%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 31m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower (commandline) like '%powershell.exe%ConvertTo-SecureString%Get-ChildItem -Path%Export-PfxCertificate%-FilePath%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower (commandline) like '%powershell.exe%ConvertTo-SecureString%Get-ChildItem -Path%Export-PfxCertificate%-FilePath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%convertto-securestring%get-childitem -path%export-pfxcertificate%-filepath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%convertto-securestring%get-childitem -path%export-pfxcertificate%-filepath%') | groupby user, system | duration 1h

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%convertto-securestring%get-childitem -path%export-pfxcertificate%-filepath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%convertto-securestring%get-childitem -path%export-pfxcertificate%-filepath%') | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%powershell.exe%Enable-PSRemoting%' or commandline like '%powershell.exe%Enable-PSRemoting%whoami%' or commandline like '%powershell.exe%evil-winrm%') and eid='4688' | groupby user, system | duration 5h

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%powershell.exe%Enable-PSRemoting%' or commandline like '%powershell.exe%Enable-PSRemoting%whoami%' or commandline like '%powershell.exe%evil-winrm%') and eid='4688' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%powershell.exe%Enable-PSRemoting%' or commandline like '%powershell.exe%Enable-PSRemoting%whoami%' or commandline like '%powershell.exe%evil-winrm%') and eid='4688' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and and  lower(commandline) like '%radmin%' | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%convertto-securestring%get-childitem -path%export-pfxcertificate%-filepath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%convertto-securestring%get-childitem -path%export-pfxcertificate%-filepath%') | groupby user, system | duration 1h

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%mmc20.application%calc.exe%') and eid='1' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%mmc20.application%calc.exe%') and eid='1' | groupby system, user 

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%mmc20.application%calc.exe%') and eid='1' | groupby system, user 

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%mmc20.application%calc.exe%') and eid='1' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(newprocessname), "(reg.exe|regedit.exe)") and rlike(lower(commandline), "reg.*add.*?/v.*?(showsuperhidden|hidden).*/t.*?(reg_dword|reg_sz|reg_expand|reg_binary).*/d.*/f")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(newprocessname), "(reg.exe|regedit.exe)") and rlike(lower(commandline), "reg.*add.*?/v.*?(showsuperhidden|hidden).*/t.*?(reg_dword|reg_sz|reg_expand|reg_binary).*/d.*/f")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and ( lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%"  or lower(commandline) like "%appcmd%set%config%section%httplogging%dontlog%true%" or rlike(lower(commandline),"(hklm|hkey_local_machine).*?software.*?microsoft.*?iis.*?httplogging.*?logextfileflags.*?0")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and ( lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%"  or lower(commandline) like "%appcmd%set%config%section%httplogging%dontlog%true%" or rlike(lower(commandline),"(hklm|hkey_local_machine).*?software.*?microsoft.*?iis.*?httplogging.*?logextfileflags.*?0"))  | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and lower(commandline) like '%radmin%exe%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and lower(commandline) like '%radmin%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") and user="{SuspectUser}" and system="{TargetHost}" | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") | groupby user, system, commandline 

stream=AZURE where operationname in ('MICROSOFT.EVENTHUB/NAMESPACES/EVENTHUBS/DELETE', 'MICROSOFT.EVENTHUB/NAMESPACES/DELETE') and status='PASSED' and user='{SuspectUser}' | duration 6m

stream=AZURE where operationname in ('MICROSOFT.EVENTHUB/NAMESPACES/EVENTHUBS/DELETE', 'MICROSOFT.EVENTHUB/NAMESPACES/DELETE') and status='PASSED' | groupby user

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%mpcmdrun%-removedefinitions%" or rlike(lower(commandline),"(del|remove).*?programdata.*?microsoft.*?windows.*?defender.*?defination.*?update")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%mpcmdrun%-removedefinitions%" or rlike(lower(commandline),"(del|remove).*?programdata.*?microsoft.*?windows.*?defender.*?defination.*?update")) | groupby user, system, commandline 

stream=azure where action='AZURE_AUDIT' and category='RoleManagement' and activitydisplayname='Add member to role' and result='success' | groupby user, targetuser

stream=azure where action='AZURE_AUDIT' and category='RoleManagement' and activitydisplayname='Add member to role' and result='success' and user='{SuspectUser}' and targetuser='{TargetUser}'

stream=ep-process where action='PROCESS_ADDED' and eid='1' and  lower(commandline) like '%radmin%' | groupby user, system |duration 1h

stream=ep-process where action='PROCESS_ADDED' and eid='1' and  lower(commandline) like '%radmin%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline), "(runas|whoami.*?all|powershell.*get\-token|powershell.*invoke\-tokenmanipulation|mimikatz.*sekurlsa::logonpasswords|mimikatz.*token::elevate|mimikatz.*privilege::debug|set\-executionpolicy.*scope.*force|createprocessfromparent.*?get\-process.*?lsass)") and system="{TargetHost}" and user="{SuspectUser}" | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline), "(runas|whoami.*?all|powershell.*get\-token|powershell.*invoke\-tokenmanipulation|mimikatz.*sekurlsa::logonpasswords|mimikatz.*token::elevate|mimikatz.*privilege::debug|set\-executionpolicy.*scope.*force|createprocessfromparent.*?get\-process.*?lsass)") | groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%jsc.exe%' and (commandline like '%.js%' or commandline like '%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%jsc.exe%' and (commandline like '%.js%.exe%' or commandline like '%.js%.dll%') | groupby system, user

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline),'adsisearcher.*?(objectclass=user|objectcategory=user|objectclass=computer|objectcategory=computer).*?(findall|findone)') or lower(commandline) like '%adsisearcher%objectcategory=organizationalunit%findall%path%' or lower(commandline) like '%adsisearcher%searchroot%path%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline),'adsisearcher.*?(objectclass=user|objectcategory=user|objectclass=computer|objectcategory=computer).*?(findall|findone)') or lower(commandline) like '%adsisearcher%objectcategory=organizationalunit%findall%path%' or lower(commandline) like '%adsisearcher%searchroot%path%') | groupby user, system

stream=signals

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%powershell.exe%Enable-PSRemoting%' or commandline like '%powershell.exe%Enable-PSRemoting%whoami%' or commandline like '%powershell.exe%evil-winrm%') and eid='4688' | groupby user, system | duration 5h

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%powershell.exe%Enable-PSRemoting%' or commandline like '%powershell.exe%Enable-PSRemoting%whoami%' or commandline like '%powershell.exe%evil-winrm%') and eid='4688' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%powershell.exe%Enable-PSRemoting%' or commandline like '%powershell.exe%Enable-PSRemoting%whoami%' or commandline like '%powershell.exe%evil-winrm%') and eid='1' | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%powershell.exe%Enable-PSRemoting%' or commandline like '%powershell.exe%Enable-PSRemoting%whoami%' or commandline like '%powershell.exe%evil-winrm%') and eid='1' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where lower(commandline) like '%radmin%' | duration 1h

stream=ep-process where action='PROCESS_ADDED' and eid='1' and  lower(commandline) like '%radmin%' | groupby user, system |duration 1h

stream=ep-process where action='PROCESS_ADDED' and eid='1' and  lower(commandline) like '%radmin%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and eid='1' and  lower(commandline) like '%radmin%' | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and eid='1' and  lower(commandline) like '%radmin%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=azure where action='AZURE_AUDIT' and category='ApplicationManagement' and activitydisplayname='Add service principal' and result='success' | groupby user, targetuser

stream=azure where action='AZURE_AUDIT' and category='ApplicationManagement' and activitydisplayname='Add service principal' and result='success' and user='{SuspectUser}' and targetuser='{TargetUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and lower(commandline) like '%radmin%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and lower(commandline) like '%radmin%' | groupby user, system | duration 1h

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and lower(commandline) like '%radmin%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and lower(commandline) like '%radmin%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and eid='1' and  lower(commandline) like '%pdqdeploy%exe%' |  groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and eid='1' and  lower(commandline) like '%pdqdeploy%exe%'and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and eid='1' and  lower(commandline) like '%pdqdeploy%exe%'and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and eid='1' and  lower(commandline) like '%pdqdeploy%exe%' |  groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%ExplorerSync.db%' | duration 1h

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and lower(commandline) like '%radmin%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and lower(commandline) like '%radmin%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and eid='1' and  lower(commandline) like '%radmin%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and eid='1' and  lower(commandline) like '%radmin%exe%' | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and eid='1' and  lower(commandline) like '%pdqdeploy%exe%' |  groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%ExplorerSync.db%' | groupby user, system | duration 1h

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%ExplorerSync.db%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and eid='1' and commandline like '%ExplorerSync.db%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%' and rlike(commandline, 'bin\\.*?\.') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%' and commandline like '%bin\\%.%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and  lower(commandline) like '%pdqdeploy%exe%' |  groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and  lower(commandline) like '%pdqdeploy%exe%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and  lower(commandline) like '%pdqdeploy%exe%' |  groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%ExplorerSync.db%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%ExplorerSync.db%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and eid='1' and commandline like '%ExplorerSync.db%' | groupby user, system | duration 1h

stream=ep-process where action='PROCESS_ADDED' and eid='1' and commandline like '%ExplorerSync.db%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like "%mpcmdrun%-removedefinitions%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and lower(commandline) like "%mpcmdrun%-removedefinitions%" | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%' and rlike(commandline, 'bin\\.*?\.') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%' and commandline like '%bin\\%.%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and eid='1' and  lower(commandline) like '%pdqdeploy%exe%' |  groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and eid='1' and  lower(commandline) like '%pdqdeploy%exe%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=azure where action='AZURE_AUDIT' and category='ApplicationManagement' and activitydisplayname='Add service principal' and result='success' and user='{SuspectUser}' and targetuser='{TargetUser}' | duration 6m

stream=azure where action='AZURE_AUDIT' and category='ApplicationManagement' and activitydisplayname='Add service principal' and result='success' | groupby user, targetuser

stream=ep-process where action='PROCESS_ADDED' and eid='1' and commandline like '%ExplorerSync.db%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and eid='1' and commandline like '%ExplorerSync.db%' | groupby user, system | duration 1h

stream=win-audit where action='PROCESS_CREATED' and commandline like '%iex(new-object%net.webclient).downloadstring%' and rlike(commandline, '(PowerSharpPack\/master\/PowerSharpBinaries|WinPwn)\/.*?\.') and (commandline like '%Invoke-Sharpweb%' or commandline like '%kittenz -consoleoutput%')  | duration 1d

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%iex(new-object%net.webclient).downloadstring%Invoke-Sharpweb%' or commandline like '%iex(new-object%net.webclient).downloadstring%kittenz -consoleoutput%' or commandline like '%iex(new-object%net.webclient).downloadstring%browserpwn -consoleoutput%') and rlike(commandline, '(PowerSharpPack\/master\/PowerSharpBinaries|WinPwn)\/.*?\.') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%iex(new-object%net.webclient).downloadstring%Invoke-Sharpweb%' or commandline like '%iex(new-object%net.webclient).downloadstring%kittenz -consoleoutput%' or commandline like '%iex(new-object%net.webclient).downloadstring%browserpwn -consoleoutput%') and rlike(commandline, '(PowerSharpPack\/master\/PowerSharpBinaries|WinPwn)\/.*?\.') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%iex(new-object%net.webclient).downloadstring%Invoke-Sharpweb%' or commandline like '%iex(new-object%net.webclient).downloadstring%kittenz -consoleoutput%' or commandline like '%iex(new-object%net.webclient).downloadstring%browserpwn -consoleoutput%') and rlike(commandline, '(PowerSharpPack\/master\/PowerSharpBinaries|WinPwn)\/.*?\.') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=azure where category='ApplicationManagement' and activitydisplayname='Add app role assignment to service principal' and result='success' | groupby user, targetuser

stream=azure where category='ApplicationManagement' and activitydisplayname='Add app role assignment to service principal' and result='success' and user='{SuspectUser}' and targetuser='{TargetUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and  lower(commandline) like '%pdqdeploy%exe%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and  lower(commandline) like '%pdqdeploy%exe%' |  groupby user, system 

stream=azure where action='AZURE_ADMINISTRATIVE' and status='PASSED' and operationname='MICROSOFT.AUTHORIZATION/ROLEASSIGNMENTS/WRITE' and user='{SuspectUser}' | duration 6m

stream=azure where action='AZURE_ADMINISTRATIVE' and status='PASSED' and operationname='MICROSOFT.AUTHORIZATION/ROLEASSIGNMENTS/WRITE' | groupby user

stream=azure where action='AZURE_AUDIT' and category='RoleManagement' and activitydisplayname='Add member to role' and result='success' and user='{SuspectUser}' and targetuser='{TargetUser}' | duration 6m

stream=azure where action='AZURE_AUDIT' and category='RoleManagement' and activitydisplayname='Add member to role' and result='success' | groupby user, targetuser

stream=ep-process where action='PROCESS_ADDED' and eid='1' and commandline like '%ExplorerSync.db%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and eid='1' and commandline like '%ExplorerSync.db%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%iex(new-object%net.webclient).downloadstring%Invoke-Sharpweb%' or commandline like '%iex(new-object%net.webclient).downloadstring%kittenz -consoleoutput%') and rlike(commandline, '(PowerSharpPack\/master\/PowerSharpBinaries|WinPwn)\/.*?\.') | duration 1d

stream=azure where category='ApplicationManagement' and activitydisplayname='Add app role assignment to service principal' and result='success' | groupby user, targetuser

stream=azure where category='ApplicationManagement' and activitydisplayname='Add app role assignment to service principal' and result='success' and user='{SuspectUser}' and targetuser='{TargetUser}' | duration 6m

stream=ep-registry where image like '%reg.exe' and registrypath like '%HKU%Environment%UserInitMprLogonScript%' | groupby user, system

stream=ep-registry where image like '%reg.exe' and registrypath like '%HKU%Environment%UserInitMprLogonScript%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-registry where image like '%reg.exe' and registrypath like '%HKU%Environment%UserInitMprLogonScript%' | groupby user, system

stream=ep-registry where image like '%reg.exe' and registrypath like '%HKU%Environment%UserInitMprLogonScript%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_CREATED' and commandline like '%REG.exe%ADD HKCU%Environment%UserInitMprLogonScript%' | groupby user, system

stream=ep-process where action='PROCESS_CREATED' and commandline like '%REG.exe%ADD HKCU%Environment%UserInitMprLogonScript%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_CREATED' and commandline like '%REG.exe%ADD HKCU%Environment%UserInitMprLogonScript%' | groupby user, system

stream=ep-process where action='PROCESS_CREATED' and commandline like '%REG.exe%ADD HKCU%Environment%UserInitMprLogonScript%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=azure where category='ApplicationManagement' and activitydisplayname='Add app role assignment to service principal' and result='success' and user='{SuspectUser}' and targetuser='{TargetUser}' | duration 6m

stream=azure where category='ApplicationManagement' and activitydisplayname='Add app role assignment to service principal' and result='success' | groupby user, targetuser |  duration 5d

stream=azure where category='ApplicationManagement' and activitydisplayname='Add app role assignment to service principal' and result='success' | groupby user, targetuser

stream=azure where category='ApplicationManagement' and activitydisplayname='Add app role assignment to service principal' and result='success' and user='{SuspectUser}' and targetuser='{TargetUser}' | duration 6m

stream=webfilter where action in ('URL_ALLOWED', 'URL_ACCESSED') and maliciousip='true' | groupby srcip

stream=ep-process where action='PROCESS_CREATED' and commandline like '%REG.exe%ADD HKCU%Environment%UserInitMprLogonScript%' | groupby user, system

stream=ep-process where action='PROCESS_CREATED' and commandline like '%REG.exe%ADD HKCU%Environment%UserInitMprLogonScript%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-registry where image like '%reg.exe' and registrypath like '%HKU%Environment%UserInitMprLogonScript%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-registry where image like '%reg.exe' and registrypath like '%HKU%Environment%UserInitMprLogonScript%' | groupby user, system

stream=firewall where action='PACKET_ALLOWED' and srctype='PRIVATE' and dsttype='PUBLIC' and srcip in (_srcip_) | groupby srcip

stream=webfilter where action in ('URL_ALLOWED', 'URL_ACCESSED') and intelurl='True' | groupby srcip, dstip

stream=FIREWALL where action="PACKET_ALLOWED" and srctype='PRIVATE' and dsttype="PUBLIC" and srcip="192.168.86.11" | select round(sum(txlen)/1024/1024) as volume | having volume > 500

stream=FIREWALL where action="PACKET_ALLOWED" and srctype='PRIVATE' and srcip="192.168.86.11" | select round(sum(txlen)/1024/1024) as volume | having volume > 500 

stream=firewall where sourcetype="FIREWALL" and dstport="3389" and act in ("accept", "start", "ip-conn") | groupby srcip | duration 1h

Stream=FIREWALL where srcip IN (srcip) and srctype="PRIVATE" and action="PACKET_ALLOWED" | groupby srcip, dstip

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Copy-Item%.dll%reg add%System%CurrentControlSet%Control%Session Manager%AppCertDlls%.dll%' |  groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Copy-Item%.dll%reg add%System%CurrentControlSet%Control%Session Manager%AppCertDlls%.dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline), 'bitsadmin\..*?transfer.*?download.*?priority.*?foreground') or rlike(lower(commandline), 'bitsadmin\..*?(addfile|create|setnotifycmdline|resume|complete|ping -n)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline), 'bitsadmin\..*?transfer.*?download.*?priority.*?foreground') or rlike(lower(commandline), 'bitsadmin\..*?(addfile|create|setnotifycmdline|resume|complete|ping -n)'))| groupby system, user

stream=ep-process where action='PROCESS_ADDED' and commandline like '%REG.exe%ADD HKCU%Environment%UserInitMprLogonScript%' | groupby user, system

stream=ep-process where action='PROCESS_CREATED' and commandline like '%REG.exe%ADD HKCU%Environment%UserInitMprLogonScript%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=webfilter where not dstcn in ('-','') | groupby dstcn |  duration 1h

stream=azure where category='ApplicationManagement' and activitydisplayname='Add app role assignment to service principal' and result='success' | groupby user, targetuser

stream=azure where category='ApplicationManagement' and activitydisplayname='Add app role assignment to service principal' and result='success' and user='{SuspectUser}' and targetuser='{TargetUser}' | duration 6m

stream=firewall where sourcetype="FIREWALL" and srctype="PUBLIC" and not service="" | groupby service | duration 1h | last 10

stream=iam where sourcename="MS-O365" |  groupby config | duration 1h | last 5

stream=authentication where action="LOGIN" and status in ("PASSED", "FAILED") |  groupby status | duration 1h

stream=webfilter where not user in ('-','') | groupby user | duration 1h | last 10

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%get-childitem%bookmarks%' or lower(commandline) like '%/r c:%bookmarks%' or lower(commandline) like '%/r c:%places.sqlite%' or lower(commandline) like '%/s /b%userprofile%favorites%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%get-childitem%bookmarks%' or lower(commandline) like '%/r c:%bookmarks%' or lower(commandline) like '%/r c:%places.sqlite%' or lower(commandline) like '%/s /b%userprofile%favorites%') | groupby user, system 

stream=authentication where action="LOGIN" |  groupby sourcename | duration 1h

stream=firewall where sourcetype="FIREWALL" and dstport="22" and act in ("accept", "start", "ip-conn") | groupby srcip | duration 1h | last 10

stream=signals |  groupby detectionseverity | duration 6h

stream=firewall where sourcetype="FIREWALL" and srctype="PUBLIC" and not srccn="-" |  groupby srccn

stream=threat where not severity="None" | groupby severity | duration 2h

stream=configuration where sourcetype="FIREWALL" and action="CONFIGURATION_CHANGED" |  groupby system, msg | duration 1h | last 10

stream=firewall where sourcetype="FIREWALL" and dstport in ("20", "21") and act in ("accept", "start", "ip-conn") | groupby dstip | duration 1h | last 10

stream=authentication where action="LOGIN" and status="PASSED" and not srccn in ("None", "-") |  groupby srccn | duration 1h

stream=firewall where threattype="Malicious" AND srccn!="-" |  duration 1h |  groupby srccn

stream=authentication where action="LOGIN" and not user like "%$" and not user="None" |  groupby user | duration 1h | last 5

stream=firewall where sourcetype="FIREWALL" and dstport="22" and act in ("accept", "start", "ip-conn") | groupby dstip | duration 1h | last 10

stream=signals |  duration 1h

stream=webfilter where action='URL_BLOCKED' and not user='None'|  groupby user |  duration 1h |  last 10

stream=* |  groupby stream | duration 30m

stream=configuration where sourcename="MS-O365" and operation="AzureActiveDirectory" | groupby config | duration 1h

stream=threat where sourcename in ("MICROSOFT", "MICROSOFT_GRAPH_API") |  groupby category | duration 1h

stream=threat where sourcename="MICROSOFT" and not system="None" |  groupby system | duration 1h

stream=* |  groupby pstatus | duration 30m

stream=firewall where sourcetype="FIREWALL" and dstport="3389" and act in ("accept", "start", "ip-conn") | groupby dstip | duration 1h

stream=authentication where sourcename="MS-O365" and operation="ThreatIntelligence" |  groupby sender2 | duration 1h | last 5

stream=webfilter where action='URL_ALLOWED' | groupby user |  select user, sum(txlen), sum(rxlen) |  duration 1h | last 10

stream=authentication where sourcename="MS-O365" and operation="ThreatIntelligence" |  groupby recipient | duration 1h | last 5

stream=iam where action="USER_LOCKOUT" |  groupby targetuser | duration 1h | last 5

stream=win-audit where action="POLICY_CHANGED" and status="PASSED" and not (user like "%$" or user="-") |  groupby user | duration 1h | last 10

stream=threat |  groupby sourcetype | duration 1h

stream=configuration where sourcename="MS-O365" and operation="Exchange" | groupby config | duration 1h

stream=configuration where action="CONFIGURATION_DELETED" and not user="None" |  groupby user | duration 1h | last 10

stream=documents where sourcename="MS-O365" |  groupby config | duration 1h |  last 5

stream=firewall where sourcetype="FIREWALL" and act in ("accept", "start", "ip-conn") and not app="" | groupby app | select app, sum(txlen)/1048576 as Data_OUT_MBs | duration 1h | last 10

stream=firewall where sourcetype="FIREWALL" and not (dstcn in ("-", "")) |  groupby dstcn

stream=authentication where action="LOGIN" and status="FAILED" and not srccn in ("None", "-") |  groupby srccn | duration 1h

stream=webfilter | groupby domain |  duration 1h |  last 5

stream=webfilter where action='URL_BLOCKED' |  groupby url | duration 1h | last 10

stream=authentication where sourcename="MS-O365" and operation="ThreatIntelligence" and not threat="None" |  groupby threat | duration 1h

stream=firewall where sourcetype="FIREWALL" and dstport in ("20", "21") and act in ("accept", "start", "ip-conn") | groupby srcip | duration 1h | last 10

stream=threat where sourcetype="FIREWALL" and vector="WEB" and not threat="None" |  groupby threat | duration 1h | last 10

stream=signals | groupby detectiontactic | duration 1d

stream=webfilter where not url in ('-','') |  groupby URL |  duration 1h | last 10

stream=authentication where sourcename="MS-O365" and operation="ThreatIntelligence" |  groupby detectionmethod | duration 1h

stream=webfilter where category='Phishing and Other Frauds'|  groupby user | last 100

stream=signals |  groupby detectionseverity, detectionname | duration 6h

stream=cloudtrail  where eventsource="cloudtrail.amazonaws.com" and eventname="StopLogging" and userarn like "%stratus%" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=cloudtrail  where eventsource="cloudtrail.amazonaws.com" and eventname="StopLogging" and userarn like "%stratus%" and userarn like '%{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and  (commandline like '%InfDefaultInstall.exe%inf%') | duration 2h

stream=cloudtrail where eventsource="cloudtrail.amazonaws.com" and eventname="StopLogging" and userarn like "%stratus%" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=cloudtrail  where eventsource="cloudtrail.amazonaws.com" and eventname="StopLogging" and userarn like "%stratus%" and userarn like '%{SuspectUser}' | duration 6m

stream=cloudtrail where eventsource="ec2.amazonaws.com" and eventname="DeleteFlowLogs" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=cloudtrail where eventsource="ec2.amazonaws.com" and eventname="DeleteFlowLogs" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=cloudtrail where eventsource="ec2.amazonaws.com" and eventname="DeleteFlowLogs" and userarn like '%{SuspectUser}' | duration 6m

stream=firewall where srctype='PRIVATE' and dsttype='PUBLIC' and dstip='{TargetHost}' and srcip='{SuspectHost}'

stream=firewall where srctype='PRIVATE' and dsttype='PRIVATE' |  select distinct_count(dstport) as port_count,srcip,dstip |  groupby dstport,srcip,dstip |  having port_count > 10 |  duration 1h

stream=threat |  groupby sourcetype | duration 1h

stream=configuration where sourcename="MS-O365" and operation="Exchange" | groupby config | duration 1h

stream=firewall where srctype='PUBLIC' |  duration 10h |  select srcip, distinct_count(dstport) as dst_cnt | groupby srcip, dstport |  having dst_cnt >100

stream=auditd where action='FILE_DELETED' and logevent like '%auth.log%' | groupby devsrcip | limit 100

stream=authentication where action="LOGIN" and srcip="{SuspectHost}" and system="{TargetHost}"

stream=authentication where action="LOGIN"| groupby srcip, system |  
select srcip, system, count_if(status="PASSED") AS pass_count,count_if(status="FAILED") AS failed_count | 
having failed_count>50 and failed_count >5*pass_count

stream=authentication where action="LOGIN" and srcip="{SuspectHost}" and system="{TargetHost}"

stream=authentication where action="LOGIN"| groupby srcip, system |  
select srcip, system, count_if(status="PASSED") AS pass_count,count_if(status="FAILED") AS failed_count | 
having failed_count>50 and failed_count >5*pass_count

stream=firewall |  duration 1d|groupby srcip |  select srcip, percentage_of(Action="PACKET_BLOCKED") AS percent | 
 having percent <10 and percent >0

stream=cloudtrail where eventsource="ec2.amazonaws.com" and eventname="DeleteFlowLogs" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=configuration where action="CONFIGURATION_DELETED" and not user="None" |  groupby user | duration 1h | last 10

stream=authentication where action="LOGIN" and srcip="{SuspectHost}" and system="{TargetHost}"

stream=authentication where action="LOGIN"| groupby srcip, system |  
select srcip, system, count_if(status="PASSED") AS pass_count,count_if(status="FAILED") AS failed_count | 
having failed_count>50 and failed_count >5*pass_count

stream=authentication where action="LOGIN" and srcip="{SuspectHost}" and system="{TargetHost}"

stream=authentication where action="LOGIN"| groupby srcip, system |  
select srcip, system, count_if(status="PASSED") AS pass_count,count_if(status="FAILED") AS failed_count | 
having failed_count>50 and failed_count >5*pass_count

stream=authentication where action="LOGIN" and srcip="{SuspectHost}" and system="{TargetHost}"

stream=authentication where action="LOGIN"| groupby srcip, system |  
select srcip, system, count_if(status="PASSED") AS pass_count,count_if(status="FAILED") AS failed_count | 
having failed_count>50 and failed_count >5*pass_count

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Get-ADObject%LDAPFilter%-Server%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Get-ADObject%LDAPFilter%-Server%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=cloudtrail where eventsource="ec2.amazonaws.com" and eventname="DeleteFlowLogs" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=cloudtrail where eventsource="ec2.amazonaws.com" and eventname="DeleteFlowLogs" and userarn like '%{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Get-ADObject%LDAPFilter%-Server%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Get-ADObject%LDAPFilter%-Server%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%adsisearcher%objectcategory=user%FindAll%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%adsisearcher%objectcategory=user%FindAll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%adsisearcher%objectcategory=user%FindAll%' or commandline like '%adsisearcher%objectcategory=user%FindOne%' or commandline like '%adsisearcher%objectcategory=organizationalunit%FindAll%' or commandline like '%adsisearcher%SearchRooT%Path%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%adsisearcher%objectcategory=user%FindAll%' or commandline like '%adsisearcher%objectcategory=user%FindOne%' or commandline like '%adsisearcher%objectcategory=organizationalunit%FindAll%' or commandline like '%adsisearcher%SearchRooT%Path%') | groupby user, system

stream=cloudtrail where eventsource="cloudtrail.amazonaws.com" and eventname="StopLogging" and userarn like "%stratus%" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=cloudtrail  where eventsource="cloudtrail.amazonaws.com" and eventname="StopLogging" and userarn like "%stratus%" and userarn like '%{SuspectUser}' | duration 6m

stream=documents where sourcename="MS-O365" |  groupby config | duration 1h |  last 10

stream=ep-process where action='PROCESS_ADDED' and  (commandline like '%InfDefaultInstall.exe%inf%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%InfDefaultInstall.exe%inf%') | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%adsisearcher%objectcategory=user%FindAll%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%adsisearcher%objectcategory=user%FindAll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%adsisearcher%objectcategory=user%FindAll%' or commandline like '%adsisearcher%objectcategory=user%FindOne%' or commandline like '%adsisearcher%objectcategory=organizationalunit%FindAll%' or commandline like '%adsisearcher%SearchRooT%Path%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%adsisearcher%objectcategory=user%FindAll%' or commandline like '%adsisearcher%objectcategory=user%FindOne%' or commandline like '%adsisearcher%objectcategory=organizationalunit%FindAll%' or commandline like '%adsisearcher%SearchRooT%Path%') | groupby user, system

stream=webserver where ((url like "%/tmui/%" or url like "%/hsqldb%") and (url like "%..;/%" or url like "%.jsp/..%")) and status='PASSED' and action='REQUEST_ALLOWED' | groupby system

stream=webserver where ((url like "%/tmui/%" or url like "%/hsqldb%") and (url like "%..;/%" or url like "%.jsp/..%")) and status='PASSED' and action='REQUEST_ALLOWED' and system='{TargetHost}'

stream=firewall where sourcetype="FIREWALL" and act in ("accept", "start", "ip-conn") and not app="" | groupby app | select app, sum(txlen)/1048576 as Data_OUT_MBs | duration 1h | last 10

stream=firewall where sourcetype="FIREWALL" and not (dstcn in ("-", "")) |  groupby dstcn

stream=authentication where action="LOGIN" and status="FAILED" and not srccn in ("None", "-") |  groupby srccn | duration 1h

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%usebasicparsing%ping%' | groupby system, user

stream=authentication where action='LOGIN' and user='root' and sourcename='NIX' | duration 15m | groupby user, action, srcip, system, devsrcip | limit 10

stream=auditd where action='FILE_DELETED' and logevent like '%faillog%' | groupby devsrcip | limit 100

stream=threat where sourcename="PALOALTO" and vector="WEB" and not url="None" |  groupby url | duration 1h | last 10

stream=authentication where action='LOGIN' and status='FAILED' and user is not null and not user='INVALID' | select user, distinct_count(system) as system_cnt | groupby system, user | having system_cnt>10

stream=auditd where action='FILE_DELETED' and logevent like '%boot.log%' | groupby devsrcip | limit 100

stream=authentication where sourcename="MS-O365" and operation="ThreatIntelligence" and not threat="None" |  groupby threat | duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%adsisearcher%objectcategory=user%FindAll%' or commandline like '%adsisearcher%objectcategory=user%FindOne%' or commandline like '%adsisearcher%objectcategory=organizationalunit%FindAll%' or commandline like '%adsisearcher%SearchRooT%Path%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%adsisearcher%objectcategory=user%FindAll%' or commandline like '%adsisearcher%objectcategory=user%FindOne%' or commandline like '%adsisearcher%objectcategory=organizationalunit%FindAll%' or commandline like '%adsisearcher%SearchRooT%Path%') | groupby user, system

stream=win-audit where (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) |  select system, user, commandline | limit 10000

stream=configuration where sourcename='F5BIGIP' and logcode in ('01310053','01070417') and not user in ('fwadmin','root','admin') and user='{SuspectUser}' and system='{TargetHost}'

stream=configuration where sourcename='F5BIGIP' and action='CONFIGURATION_CHANGED' and logcode in ('01310053','01070417') | duration 1h | select user, system, count(*) as CountUnique | groupby user, system | having CountUnique>=5

stream=firewall where sourcetype="FIREWALL" and dstport in ("20", "21") and act in ("accept", "start", "ip-conn") | groupby srcip | duration 1h | last 10

stream=IAM where action='PASSWORD_CHANGED' |  select user,distinct_count(targetuser) as target_cnt |  groupby user, targetuser |  having target_cnt>10

stream=threat where sourcetype="FIREWALL" and vector="WEB" and not threat="None" |  groupby threat | duration 1h | last 10

stream=signals | groupby detectiontactic | duration 1d

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%InfDefaultInstall.exe%inf%') | groupby user, system 

stream=ep-registry where registrypath like '%HKLM%System%CurrentControlSet%Control%Session Manager%AppCertDlls%' user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-registry where registrypath like '%HKLM%System%CurrentControlSet%Control%Session Manager%AppCertDlls%' | groupby user, system, targetobject, registryvalue

stream=ep-registry where registrypath like '%HKLM%System%CurrentControlSet%Control%Session Manager%AppCertDlls%' user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-registry where registrypath like '%HKLM%System%CurrentControlSet%Control%Session Manager%AppCertDlls%' | groupby user, system, targetobject, registryvalue, action

stream=ep-process where action='PROCESS_CREATED' and commandline like '%Copy-Item%.dll%reg add%System%CurrentControlSet%Control%Session Manager%AppCertDlls%.dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_CREATED' and commandline like '%Copy-Item%.dll%reg add%System%CurrentControlSet%Control%Session Manager%AppCertDlls%.dll%' |  groupby user, system, commandline

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'kerbrute.*?userenum.*?(-d|--dc|-t|-o|-safe)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'kerbrute.*?userenum.*?(-d|--dc|-t|-o|-safe)') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%Copy-Item%.dll%reg add%System%CurrentControlSet%Control%Session Manager%AppCertDlls%.dll%' |  groupby user, system, parentcommandline

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Copy-Item%.dll%reg add%System%CurrentControlSet%Control%Session Manager%AppCertDlls%.dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Copy-Item%.dll%reg add%System%CurrentControlSet%Control%Session Manager%AppCertDlls%.dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Copy-Item%.dll%reg add%System%CurrentControlSet%Control%Session Manager%AppCertDlls%.dll%' |  groupby user, system, commandline

stream=ep-registry where registrypath like '%HKLM%System%CurrentControlSet%Control%Session Manager%AppCertDlls%' | groupby user, system, targetobject, registryvalue

stream=authentication where action="LOGIN" and status="FAILED" |  groupby user |  limit 5 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%Copy-Item%.dll%reg add%System%CurrentControlSet%Control%Session Manager%AppCertDlls%.dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%Copy-Item%.dll%reg add%System%CurrentControlSet%Control%Session Manager%AppCertDlls%.dll%' |  groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Copy-Item%.dll%reg add%System%CurrentControlSet%Control%Session Manager%AppCertDlls%.dll%' |  groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Copy-Item%.dll%reg add%System%CurrentControlSet%Control%Session Manager%AppCertDlls%.dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%net user /add%net localgroup administrators%/add%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%net user /add%net localgroup administrators%/add%' |  groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%net user /add%net localgroup administrators%/add%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%net user /add%net localgroup administrators%/add%' |  groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Start-Process%Start-Sleep%Stop-Process%' and rlike(commandline, 'bin.*?\.') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Start-Process%Start-Sleep%Stop-Process%' and rlike(commandline, 'bin.*?\.') | groupby user, system

stream=win-audit where (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') | groupby system, user

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%adsisearcher%objectcategory=user%FindAll%' or commandline like '%adsisearcher%objectcategory=user%FindOne%' or commandline like '%adsisearcher%objectcategory=organizationalunit%FindAll%' or commandline like '%adsisearcher%SearchRooT%Path%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%adsisearcher%objectcategory=user%FindAll%' or commandline like '%adsisearcher%objectcategory=user%FindOne%' or commandline like '%adsisearcher%objectcategory=organizationalunit%FindAll%' or commandline like '%adsisearcher%SearchRooT%Path%') | groupby user, system

stream=threat where sourcetype="FIREWALL" and vector="WEB" and urlcategorylist in ("phishing","malware") and not act="block-url" | groupby user | duration 1h

stream=win-audit where action='POLICY_CHANGED' AND logevent like '%A token right was adjusted%' and not user like '%$%' | duration 7d | groupby user, system | limit 100 

stream=threat where sourcename="PALOALTO" and vector="WEB" and not url="None" and not dstcn="-" |  groupby dstcn | duration 1h

stream=authentication where eventname="ConsoleLogin" and eventsource="signin.amazonaws.com" and action="LOGIN" and status="FAILED" | groupby user

stream=firewall where sourcetype="FIREWALL" and dstport="3389" and act in ("accept", "start", "ip-conn") | groupby srcip | duration 1h

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and commandline like '%New-LocalUser%-Name%-NoPassword%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%New-LocalUser%-Name%-NoPassword%' | groupby user, system, commandline

stream=firewall |  groupby srcip, dstport, dstip | duration 1h | limit 20

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%' and commandline like '%bin\\%.%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Set-Location%path%' and rlike(commandline, 'Sysinternals.*?\.') | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and commandline like '%cmd.exe%echo& type%' | groupby user, system, commandline

stream=ep-process where action='PROCESS_ADDED' and commandline like '%cmd.exe%echo& type%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%echo%& type%' | groupby user, system, commandline

stream=ep-process where action='PROCESS_ADDED' and commandline like '%echo%& type%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%echo%& type%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%echo%& type%' | groupby user, system, commandline

stream=firewall where sourcetype="FIREWALL" and srctype="PUBLIC" | groupby dstport | duration 1h | last 10

stream=threat where sourcename="PALOALTO" and vector="WEB" and not url="None" and act="block-url" and not user="" |  groupby user | duration 1h | last 10

stream=iam where sourcename="MS-O365" |  groupby config | duration 1h | last 5

stream=firewall where sourcetype="FIREWALL" and srctype="PRIVATE" | groupby srcip |  select srcip, sum(txlen), sum(rxlen) |  duration 1h | last 10

stream=IAM where action IN ('USER_CREATED','USER_REMOVED','USER_ADDED','USER_LOCKOUT','USER_UNLOCKED') and targetuser is not null |  groupby targetuser |  duration 1h |  having count_col1>3

stream=win-audit where action='PROCESS_CREATED' and (rlike(commandline, 'Set-Location.*path.*Sysinternals.*?\.') or rlike(Commandline, 'Copy-Item.*?Google\\\\Chrome\\\\User Data\\\\Default\\\\Login Data.*?-Destination')) | groupby system, user | duration 15m

stream=win-audit where action='PROCESS_CREATED' and (rlike(commandline, 'Set-Location.*path.*Sysinternals.*?\.') or rlike(Commandline, 'Copy-Item.*?Google.*Chrome.*User Data.*Default.*Login Data.*?-Destination')) and user='{SuspectUser}' and system='{TargetHost}' | duration 15m 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%fileName =%url =%file = New-Item -Force%-Value%contentType =%Invoke-WebRequest%-Method Put%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%fileName =%url =%file = New-Item -Force%-Value%contentType =%Invoke-WebRequest%-Method Put%' | groupby user, system, commandline

stream=authentication where action="LOGIN" and status in ("PASSED", "FAILED") |  groupby status | duration 1h

stream=authentication where action="LOGIN" |  groupby sourcename | duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(localappdata:~-3,1.*?md /c echo.*?>.*?type|http:|https:|-c write-host.*?([net.webclient]::new.*?downloadstring|bypass|-exec|schtasks /create /sc daily.*?spawncmd.*?/c echo)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(localappdata.*?md /c echo.*?type|http:|https:|-c write-host.*?net.webclient.*?::new.*?downloadstring|bypass|-exec|schtasks /create /sc daily.*?spawncmd.*?/c echo)') | groupby user, system 

stream=firewall where sourcetype="FIREWALL" and dstport="22" and act in ("accept", "start", "ip-conn") | groupby srcip | duration 1h | last 10

stream=signals |  groupby detectionseverity | duration 6h

stream=firewall where sourcetype="FIREWALL" and srctype="PUBLIC" and not srccn="-" |  groupby srccn

stream=threat where sourcename="PALOALTO-CORTEX" |  groupby deviceseverity | duration 2h

stream=configuration where sourcetype="FIREWALL" and action="CONFIGURATION_CHANGED" |  groupby system, msg | duration 1h | last 10

stream=firewall where sourcetype="FIREWALL" and dstport in ("20", "21") and act in ("accept", "start", "ip-conn") | groupby dstip | duration 1h | last 10

stream=authentication where action="LOGIN" and status="PASSED" and not srccn in ("None", "-") |  groupby srccn | duration 1h

stream=firewall where threattype="Malicious" AND srccn!="-" |  duration 1h |  groupby srccn

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Get-ADObject%LDAPFilter%-Server%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Get-ADObject%LDAPFilter%-Server%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=authentication where action="LOGIN" and not user like "%$" and not user="None" |  groupby user | duration 1h | last 5

stream=firewall where sourcetype="FIREWALL" and dstport="22" and act in ("accept", "start", "ip-conn") | groupby dstip | duration 1h | last 10

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%' or lower(commandline) like '%New-SMBShare%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%' or lower(commandline) like '%New-SMBShare%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=* |  groupby stream | duration 30m

stream=IAM where action='PASSWORD_CHANGED' |  duration 3h |  groupby targetuser, user | having count_col1>1

stream=configuration where sourcename="MS-O365" and operation="AzureActiveDirectory" | groupby config | duration 1h

stream=auditd where action='FILE_DELETED' and logevent like '%user.log%' | duration 30m | groupby devsrcip | limit 100

stream=threat where sourcename="PALOALTO-CORTEX" |  groupby category | duration 1h

stream=threat where sourcename="PALOALTO-CORTEX" |  groupby srchost | duration 1h | last 10

stream=* |  groupby pstatus | duration 30m

stream=firewall where sourcetype="FIREWALL" and dstport="3389" and act in ("accept", "start", "ip-conn") | groupby dstip | duration 1h

stream=authentication where sourcename="MS-O365" and operation="ThreatIntelligence" |  groupby sender2 | duration 1h | last 5

stream=authentication where sourcename="MS-O365" and operation="ThreatIntelligence" |  groupby recipient | duration 1h | last 5

stream=threat where sourcename="PALOALTO" and vector="WEB" and not url="None" and act="block-url" |  groupby url | duration 1h | last 10

stream=IAM where sourcename='WINDOWS' and action='USER_DISABLED' and not user like '$%' | duration 1h | groupby user, devsrcip, system | limit 100

stream=ep-process where action='PROCESS_ADDED' and commandline like '%net user /add%net localgroup administrators%/add%' |  groupby user, system, commandline, stream

stream=ep-process where action='PROCESS_ADDED' and commandline like '%net user /add%net localgroup administrators%/add%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%New-LocalUser%-Name%-NoPassword%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%New-LocalUser%-Name%-NoPassword%' | groupby user, system, commandline

stream=configuration where commandline like '%New-LocalUser%-Name%-NoPassword%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=configuration where commandline like '%New-LocalUser%-Name%-NoPassword%' | groupby user, system, commandline

stream=cloudtrail  where eventsource="cloudtrail.amazonaws.com" and eventname in ("StopLogging", "UpdateTrail", "DeleteTrail") | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=cloudtrail where eventsource="cloudtrail.amazonaws.com" and eventname in ("StopLogging", "UpdateTrail", "DeleteTrail") and userarn like '%{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%echo%' | groupby user, system, commandline

stream=ep-process where action='PROCESS_ADDED' and commandline like '%echo%& type%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=FIREWALL where action="PACKET_ALLOWED" and srctype='PRIVATE' and srcip="192.168.86.11" | select round(sum(txlen)/1024/1024) as volume, srcip, dstip | having volume > 500 | duration 2d | groupby srcip, dstip

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%net user /add%net localgroup administrators%/add%' |  groupby user, system, commandline

stream=ep-process where action='PROCESS_ADDED' and commandline like '%net user /add%net localgroup administrators%/add%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%' | groupby system, user

stream=ep-pocess where action='PROCESS_ADDED' and commandline like '%HKLM:%SYSTEM%CurrentControlSet%Services%NTDS%LsaDbExtPt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Start-Process%Start-Sleep%Stop-Process%' and rlike(commandline, 'bin.*?\.') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Start-Process%Start-Sleep%Stop-Process%' and rlike(commandline, 'bin.*?\.') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=cloudtrail  where eventsource="cloudtrail.amazonaws.com" and eventname="StopLogging" and userarn like "%stratus%" and userarn like '%{SuspectUser}' | duration 6m

stream=cloudtrail  where eventsource="cloudtrail.amazonaws.com" and eventname="StopLogging" and userarn like "%stratus%" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=EP-PROCESS where action="PROCESS_ADDED"  and rlike(lower(commandline), '(c.*?windows.*?microsoft.net.*?framework64.*?(csc\.exe|csc|\.exe)|new-item.*?type.*?erroraction.*?invoke-webRequest)')  | groupby system, user 

stream=EP-PROCESS where action="PROCESS_ADDED"  and rlike(lower(commandline), '(c.*?windows.*?microsoft.net.*?framework64.*?(csc\.exe|csc|\.exe)|new-item.*?type.*?erroraction.*?invoke-webRequest)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like "%csc.exe%target:exe%" or commandline like "%csc.exe%code%" or commandline like "%csc.exe%out%") | groupby system, user 

stream=EP-PROCESS where action="PROCESS_ADDED" and (commandline like "%csc.exe%target:exe%" or commandline like "%csc.exe%code%" or commandline like "%csc.exe%out%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Start-Process%Start-Sleep%Stop-Process%' and rlike(commandline, 'bin.*?\.') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Start-Process%Start-Sleep%Stop-Process%' and rlike(commandline, 'bin.*?\.') | groupby user, system

stream=configuration where commandline like '%New-LocalUser%-Name%-NoPassword%' | groupby user, system, commandline

stream=configuration where commandline like '%New-LocalUser%-Name%-NoPassword%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%echo%& type%' | groupby user, system, commandline

stream=ep-process where action='PROCESS_ADDED' and commandline like '%echo%& type%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%echo%& type%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%echo%& type%' | groupby user, system, commandline

stream=threat where sourcename="PALOALTO" and vector="WEB" and not url="None" | groupby url | duration 1h | last 20

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'invoke-expression.*?(adrecon.ps1|adreconscript.ps1)') or rlike(lower(commandline),'(adrecon.ps1|adreconscript.ps1)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'invoke-expression.*?(adrecon.ps1|adreconscript.ps1)') or rlike(lower(commandline),'(adrecon.ps1|adreconscript.ps1)')) | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%New-LocalUser%-Name%-NoPassword%' | groupby user, system, commandline

stream=ep-process where action='PROCESS_ADDED' and commandline='%New-LocalUser%-Name%-NoPassword%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'kerbrute.*?userenum.*?(-d|--dc|-t|-o|-safe)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'kerbrute.*?userenum.*?(-d|--dc|-t|-o|-safe)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=cloudtrail  where eventsource="cloudtrail.amazonaws.com" and eventname in ("StopLogging", "UpdateTrail", "DeleteTrail") | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=cloudtrail where eventsource="cloudtrail.amazonaws.com" and eventname in ("StopLogging", "UpdateTrail", "DeleteTrail") and userarn='{SuspectUser}' | duration 6m

stream=configuration where commandline like '%New-LocalUser%-Name%-NoPassword%' and system='{TargetHost}' | duration 6m

stream=configuration where commandline like '%New-LocalUser%-Name%-NoPassword%' | groupby system, commandline

stream=ep-process where action='PROCESS_ADDED' and commandline like '%echo%' | groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and commandline like '%echo%& type%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%echo%& type%' | groupby user, system, commandline

stream=cloudtrail  where eventsource="cloudtrail.amazonaws.com" and eventname="StopLogging" and userarn like "%stratus%" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Chrome%User%Data%Default%' and commandline like '%bin\\%.%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(commandline, 'Set-Location.*path.*Sysinternals.*?\.') or rlike(Commandline, 'Copy-Item.*?Google\\\\Chrome\\\\User Data\\\\Default\\\\Login Data.*?-Destination')) | groupby system, user, logevent | duration 1h

stream=FIREWALL where action="PACKET_ALLOWED" and srctype='PRIVATE' and srcip="192.168.86.11" | select round(sum(txlen)/1024/1024) as volume | having volume > 500 

stream=win-audit where action='PROCESS_CREATED' and (rlike(commandline, 'Set-Location.*path.*Sysinternals.*?\.') or rlike(Commandline, 'Copy-Item.*?Google\\\\Chrome\\\\User Data\\\\Default\\\\Login Data.*?-Destination')) | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and (rlike(commandline, 'Set-Location.*path.*Sysinternals.*?\.') or rlike(Commandline, 'Copy-Item.*?Google\\\\Chrome\\\\User Data\\\\Default\\\\Login Data.*?-Destination')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(commandline, 'Set-Location.*path.*Sysinternals.*?\.') or rlike(Commandline, 'Copy-Item.*?Google\\\\Chrome\\\\User Data\\\\Default\\\\Login Data.*?-Destination')) | groupby system, user | duration 15m

stream=win-audit where action='PROCESS_CREATED' and (rlike(commandline, 'Set-Location.*path.*Sysinternals.*?\.') or rlike(Commandline, 'Copy-Item.*?Google.*Chrome.*User Data.*Default.*Login Data.*?-Destination')) and user='{SuspectUser}' and system='{TargetHost}' | duration 15m 

stream=ep-process where action='PROCESS_ADDED' and ((lower(commandline) like '%regsvr32.exe% /s%.dll%') and not commandline like '%/n%') | duration 1h

stream=cloudtrail  where eventsource="cloudtrail.amazonaws.com" and eventname="StopLogging" and userarn like "%stratus%" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=auditd where sourcename='F5BIGIP' and logcode='01420007' and us

stream=auditd where sourcename='F5BIGIP' and action='CERTIFICATE_EXPIRED' and logcode='01420007' | groupby user, system 

stream=iam where action="USER_LOCKOUT" |  groupby targetuser | duration 1h | last 5

stream=win-audit where action="POLICY_CHANGED" and status="PASSED" and not (user like "%$" or user="-") |  groupby user | duration 1h | last 10

stream=win-audit where action='PROCESS_CREATED' and (rlike(commandline, 'Set-Location.*path.*Sysinternals.*?\.') or rlike(Commandline, 'Copy-Item.*?Google\\\\Chrome\\\\User Data\\\\Default\\\\Login Data.*?-Destination')) | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and (rlike(commandline, 'Set-Location.*path.*Sysinternals.*?\.') or rlike(Commandline, 'Copy-Item.*?Google\\\\Chrome\\\\User Data\\\\Default\\\\Login Data.*?-Destination')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%fileName =%url =%file = New-Item -Force%-Value%contentType =%Invoke-WebRequest%-Method Put%' | groupby user, system, parentcommandline

stream=win-audit where action='PROCESS_CREATED' and commandline like '%fileName =%url =%file = New-Item -Force%-Value%contentType =%Invoke-WebRequest%-Method Put%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%fileName =%url =%file = New-Item -Force%-Value%contentType =%Invoke-WebRequest%-Method Put%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%fileName =%url =%file = New-Item -Force%-Value%contentType =%Invoke-WebRequest%-Method Put%' | groupby user, system, parentcommandline

stream=win-audit where action='PROCESS_CREATED' and (((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%usebasicparsing%officeproduct%') or (lower(scriptblocktext) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%usebasicparsing%officeproduct%')) and (rlike(lower(commandline), '(macrocode|create_macro_file|macro_code|macro|macro_name|open_macro)'))) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%usebasicparsing%officeproduct%') or (lower(scriptblocktext) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%usebasicparsing%officeproduct%')) and (rlike(lower(commandline), '(macrocode|create_macro_file|macro_code|macro|macro_name|open_macro)'))) | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'createinstance.*?gettypefromprogid.*?(mmc20.application|mmc20|\.).*?document.activeview.executeshellcommand') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'createinstance.*?gettypefromprogid.*?(mmc20.application|mmc20|\.).*?document.activeview.executeshellcommand') | groupby system, user

stream=firewall where action='PACKET_ALLOWED' and status='PASSED' and dsttype='PRIVATE' and dstip='{TargetHost}' and srcip='{SuspectHost}' and srccn='{SuspectLocation}'

stream=firewall where action='PACKET_ALLOWED' and status='PASSED' and not srccn='IN' and not srccn='-' and srccn is not null and dsttype='PRIVATE' |  groupby srcip, srccn, dstip

stream=authentication where sourcename="MS-O365" and operation="ThreatIntelligence" |  groupby detectionmethod | duration 1h

stream=CONFIGURATION where sourcename='NIX' and action='CONFIGURATION_CHANGED' and deamon='crontab' and lower(config) like '%edit%' | groupby devsrcip, user | limit 100

stream=threat where sourcename="PALOALTO" and vector="WEB" and not url="None" and not user="" |  groupby user | duration 1h | last 10

stream=signals |  groupby detectionseverity, detectionname | duration 6h

stream=authentication where action='LOGIN' |  groupby user, srcip |  select user,distinct_count(srcip) as srcip_cnt |  having srcip_cnt>2

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED"  and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'kerbrute.*?userenum.*?(-d|--dc|-t|-o|-safe)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'kerbrute.*?userenum.*?(-d|--dc|-t|-o|-safe)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=cloudtrail where eventsource="logs.amazonaws.com" and eventname="DeleteLogGroup" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=cloudtrail  where eventsource="logs.amazonaws.com" and eventname="DeleteLogStream" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=cloudtrail  where eventsource="logs.amazonaws.com" and eventname="DeleteLogStream" and userarn like '%{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '(system\.security\.principal\.windowsidentity.*?getcurrent)') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '(system\.security\.principal\.windowsidentity.*?getcurrent)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%New-Item%-Path%New-ItemProperty%Name%PropertyType%Start-Process%FilePath%ArgumentList%'

stream=win-audit where action='PROCESS_CREATED' and commandline like '%New-Item%-Path%New-ItemProperty%Name%PropertyType%Start-Process%FilePath%ArgumentList%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%get-adcomputer%-properties *%' or rlike(lower(commandline),'get-adcomputer.*?-properties.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)') or lower(commandline) like '%get-adcomputer%-searchscope%subtree%-filter%name%-like %*%-properties *%' or rlike(lower(commandline),'adfind.*?-h.*?-s subtree -f.*?objectclass=computer.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%get-adcomputer%-properties *%' or rlike(lower(commandline),'get-adcomputer.*?-properties.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)') or lower(commandline) like '%get-adcomputer%-searchscope%subtree%-filter%name%-like %*%-properties *%' or rlike(lower(commandline),'adfind.*?-h.*?-s subtree -f.*?objectclass=computer.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)')) | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and ((lower(commandline) like '%regsvr32.exe% /s%.dll%') and not commandline like '%/n%') | duration 1h

stream=cloudtrail  where eventsource="logs.amazonaws.com" and eventname="DeleteLogStream" and userarn like '%{SuspectUser}' | duration 6m

stream=cloudtrail where eventsource="logs.amazonaws.com" and eventname="DeleteLogStream" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn | duration 10m

stream=ep-process where action= 'PROCESS_ADDED' and eid='1' and  (commandline like '%mavinject%dll%') | groupby user, system

stream=ep-process where action= 'PROCESS_ADDED' and eid='1' and  commandline like '%mavinject%dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%windows%syswow64%register-cimprovider.exe%.dll%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%windows%syswow64%register-cimprovider.exe%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=cloudtrail where eventsource="logs.amazonaws.com" and eventname="DeleteLogStream" and userarn like '%{SuspectUser}' | duration 6m

stream=cloudtrail where eventsource="logs.amazonaws.com" and eventname="DeleteLogStream" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') | groupby user, system 

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline), "(runas|whoami.*?all|powershell.*get\-token|powershell.*invoke\-tokenmanipulation|mimikatz.*sekurlsa::logonpasswords|mimikatz.*token::elevate|mimikatz.*privilege::debug|set\-executionpolicy.*scope.*force|createprocessfromparent.*?get\-process.*?lsass)") | groupby user, system, commandline

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline), "(runas|whoami.*?all|powershell.*get\-token|powershell.*invoke\-tokenmanipulation|mimikatz.*sekurlsa::logonpasswords|mimikatz.*token::elevate|mimikatz.*privilege::debug|set\-executionpolicy.*scope.*force|createprocessfromparent.*?get\-process.*?lsass)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=* | duration 7d | select distinct(devsrcip) as DevIP

stream=ep-process where action='PROCESS_ADDED' and ((lower(commandline) like '%regsvr32.exe% /s%.dll%') and not commandline like '%/n%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and ((lower(commandline) like '%regsvr32.exe% /s%.dll%') and not commandline like '%/n%')and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and ((lower(commandline) like '%regsvr32.exe% /s%.dll%') and not commandline like '%/n%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and ((lower(commandline) like '%regsvr32.exe% /s%.dll%') and not commandline like '%/n%')) | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and ((lower(commandline) like '%regsvr32.exe% /s%.dll%') and not commandline like '%/n%')and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%generaldomaininfo%-noninteractive%-consoleoutput%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%generaldomaininfo%-noninteractive%-consoleoutput%' | groupby user, system

stream=authentication where eventname="ConsoleLogin" and eventsource="signin.amazonaws.com" and action="LOGIN" and status="FAILED" and useragent like "%Go%http%" | groupby user

stream=authentication where eventname="ConsoleLogin" and eventsource="signin.amazonaws.com" and action="LOGIN" and status="FAILED" and useragent like "%Go%http%" and user='{SuspectUser}' | duration 6m

stream=cloudtrail where eventsource="logs.amazonaws.com" and eventname="DeleteLogGroup" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%kerbrute.exe%userenum%-d%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%kerbrute.exe%userenum%-d%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action= 'PROCESS_ADDED' and eid='1' and  commandline like '%mavinject%dll%' | groupby user, system | duration 1h

stream=ep-process where action= 'PROCESS_ADDED' and eid='1' and  commandline like '%mavinject%dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action= 'PROCESS_ADDED' and eid='1' and  commandline like '%mavinject%dll%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action= 'PROCESS_ADDED' and eid='1' and  commandline like '%mavinject%dll%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline), 'bitsadmin\..*?transfer.*?download.*?priority.*?foreground') or rlike(lower(commandline), 'bitsadmin\..*?(addfile|create|setnotifycmdline|resume|complete|ping -n)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline), 'bitsadmin\..*?transfer.*?download.*?priority.*?foreground') or rlike(lower(commandline), 'bitsadmin\..*?(addfile|create|setnotifycmdline|resume|complete|ping -n)')) | groupby system, user | duration 15m

stream=cloudtrail where eventsource="logs.amazonaws.com" and eventname="DeleteLogGroup" and userarn like '%{SuspectUser}' | duration 6m

stream=cloudtrail where eventsource="logs.amazonaws.com" and eventname="DeleteLogGroup" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=ep-process where action= 'PROCESS_ADDED' and eid='1' and  (commandline like '%mavinject%dll%') | groupby user, system

stream=ep-process where action= 'PROCESS_ADDED' and eid='1' and  (commandline like '%mavinject%dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%windows%syswow64%register-cimprovider.exe%.dll%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and  (commandline like '%InfDefaultInstall.exe%inf%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and  (commandline like '%InfDefaultInstall.exe%inf%') | groupby user, system |duration 2h

stream=cloudtrail where eventsource="ec2.amazonaws.com" and eventname="GetPasswordData" and useragent like "%stratus%" and userarn like '%{SuspectUser}' | duration 6m

stream=cloudtrail where eventsource="ec2.amazonaws.com" and eventname="GetPasswordData" and useragent like "%stratus%" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(commandline),'((copy|ren|rename-item).*?system32.*?\.exe.*?(appdata|systemroot).*?\.exe)') | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(commandline),'((copy|ren|rename-item).*?system32.*?\.exe.*?(appdata|systemroot).*?\.exe)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=cloudtrail where eventsource="logs.amazonaws.com" and eventname="DeleteLogGroup" and userarn like '%{SuspectUser}' | duration 6m

stream=cloudtrail where eventsource="logs.amazonaws.com" and eventname="DeleteLogGroup" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=win-audit where action='PROCESS_CREATED' and commandline like '%New-Item%-Path%New-ItemProperty%Name%PropertyType%Start-Process%FilePath%ArgumentList%' | duration 20m

stream=ep-process where action= 'PROCESS_ADDED' and eid='1' and  commandline like '%mavinject%dll%' | duration 1h

stream=EP-PROCESS where action="PROCESS_ADDED" and parentcommandline like '%powershell.exe%' and ((rlike(lower(commandline), 'system.text.encoding.*?(unicode.getbyte|unicode.getstring|utf8.getbytes|utf8.getstring|ascii.getstring)')) and (rlike(lower(commandline), '(convert|unicode.getstring|utf8.getstring).*?((to|from)base64string|(to|from)base64string.*?echo.*?encodedcommand)'))) | groupby system, user

stream=EP-PROCESS where action="PROCESS_ADDED" and parentcommandline like '%powershell.exe%' and ((rlike(lower(commandline), 'system.text.encoding.*?(unicode.getbyte|unicode.getstring|utf8.getbytes|utf8.getstring|ascii.getstring)')) and (rlike(lower(commandline), '(convert|unicode.getstring|utf8.getstring).*?((to|from)base64string|(to|from)base64string.*?echo.*?encodedcommand)'))) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m


stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%windows%syswow64%register-cimprovider.exe%.dll%') | groupby user, system | duration 1h

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%windows%syswow64%register-cimprovider.exe%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.*?-accepteula.*?(-c|-f|-v)') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.*?-accepteula.*?(-c|-f|-v)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%cmd.exe%reg query%' or rlike(lower(commandline), "powershell.exe.*?(get-item|get-childitem|get-itemproperty|get-childitem -path hklm|get-childitem -path hkcr:)")) | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%cmd.exe%reg query%' or rlike(lower(commandline), "powershell.exe.*?(get-item|get-childitem|get-itemproperty|get-childitem -path hklm|get-childitem -path hkcr:)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%wmic.exe%node%IpAddress%ntlmusers.evtx%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%wmic.exe%node%IpAddress%ntlmusers.evtx%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%cmd.exe%/q /c%1>%$%2>&1%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%cmd.exe%/q /c%1>%$%2>&1%") | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%windows%syswow64%register-cimprovider.exe%.dll%') | duration 1h

stream=cloudtrail  where eventsource="logs.amazonaws.com" and eventname="DeleteLogStream" and userarn like '%{SuspectUser}' | duration 6m

stream=cloudtrail where eventsource="logs.amazonaws.com" and eventname="DeleteLogStream" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%windows%syswow64%register-cimprovider.exe%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%windows%syswow64%register-cimprovider.exe%.dll%') | groupby user, system | duration 1h

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%windows%syswow64%register-cimprovider.exe%.dll%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%windows%syswow64%register-cimprovider.exe%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%windows%syswow64%register-cimprovider.exe%.dll%') | groupby user, system | duration 1h

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%windows%syswow64%register-cimprovider.exe%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and  (commandline like '%InfDefaultInstall.exe%inf%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and  (commandline like '%InfDefaultInstall.exe%inf%') | groupby user, system | duration 2h

stream=ep-process where action='PROCESS_ADDED' and  (commandline like '%InfDefaultInstall.exe%inf%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and  (commandline like '%InfDefaultInstall.exe%inf%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%InfDefaultInstall.exe%inf%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%InfDefaultInstall.exe%inf%') | groupby user, system  | duration 2h

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%InfDefaultInstall.exe%inf%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%InfDefaultInstall.exe%inf%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%New-Item%-Path%New-ItemProperty%Name%PropertyType%Start-Process%FilePath%ArgumentList%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%New-Item%-Path%New-ItemProperty%Name%PropertyType%Start-Process%FilePath%ArgumentList%' | groupby user, system

stream=cloudtrail where eventsource="ec2.amazonaws.com" and eventname="GetPasswordData" and useragent like "%stratus%" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=cloudtrail where eventsource="ec2.amazonaws.com" and eventname="GetPasswordData" and useragent like "%stratus%" and userarn like '%{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') | groupby user, system | duration 2h

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adsisearcher.*?(objectclass=user|objectcategory=user|objectclass=computer|objectcategory=computer).*?(findall|findone)') or lower(commandline) like '%adsisearcher%objectcategory=organizationalunit%findall%path%' or lower(commandline) like '%adsisearcher%searchroot%path%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adsisearcher.*?(objectclass=user|objectcategory=user|objectclass=computer|objectcategory=computer).*?(findall|findone)') or lower(commandline) like '%adsisearcher%objectcategory=organizationalunit%findall%path%' or lower(commandline) like '%adsisearcher%searchroot%path%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'reg add.*REG_SZ.*?\.') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'reg add.*REG_SZ.*?\.') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%New-Item%-Path%New-ItemProperty%Name%PropertyType%Start-Process%FilePath%ArgumentList%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%New-Item%-Path%New-ItemProperty%Name%PropertyType%Start-Process%FilePath%ArgumentList%' | groupby user, system

stream=cloudtrail where eventsource="ec2.amazonaws.com" and eventname="GetPasswordData" and useragent like "%stratus%" and userarn like '%{SuspectUser}' | duration 6m

stream=cloudtrail where eventsource="ec2.amazonaws.com" and eventname="GetPasswordData" and useragent like "%stratus%" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=* where commandline like '%HKLM%SOFTWARE%Microsoft%Windows%CurrentVersion%App Paths%Winword.exe%protocolhandler.exe%' | duration 2h

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') | groupby user, system | duration 2h

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32%/s/u/i%.dll%.sct%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32%/s/u/i%.dll%.sct%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(generaldomaininfo|winpwn).*?-(noninteractive|consoleoutput|domainrecon)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(generaldomaininfo|winpwn).*?-(noninteractive|consoleoutput|domainrecon)') | groupby user, system

stream=authentication where eventname="ConsoleLogin" and eventsource="signin.amazonaws.com" and action="LOGIN" and status="FAILED" and useragent like "%Go%http%" and user='{SuspectUser}' | duration 6m

stream=authentication where eventname="ConsoleLogin" and eventsource="signin.amazonaws.com" and action="LOGIN" and status="FAILED" and useragent like "%Go%http%" | groupby user

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') | groupby user, system | duration2h

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'reg add.*REG_SZ.*?\.') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'reg add.*REG_SZ.*?\.') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32.exe% /s%.dll%' and not commandline like '%/n%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and ((lower(commandline) like '%regsvr32.exe% /s%.dll%') and not commandline like '%/n%')and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=cloudtrail where eventname in ("GetCallerIdentity", "ListBuckets", "GetAccountSummary", "ListRoles", "ListUsers", "GetAccountAuthorizationDetails", "DescribeSnapshots", "DescribeTrails", "ListDetectors") | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32%/s/u/i%.sct%.dll%') | groupby user, system , logevent

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32%/s/u/i%.dll%.sct%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'reg add.*REG_SZ.*?\.') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'reg add.*REG_SZ.*?\.') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'reg add.*REG_SZ.*?\.') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, 'reg add.*REG_SZ.*?\.') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32.exe% /s%.dll%' and not commandline like '%/n%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32.exe%%s%.dll%' and not commandline like '%/n%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%windows%microsoft.net%microsoft.workflow.compiler.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%windows%microsoft.net%microsoft.workflow.compiler.exe%') | groupby user, system | duration 1d

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%kerbrute.exe%userenum%-d%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%kerbrute.exe%userenum%-d%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') | groupby user, system | duration2h

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%hklm%software%microsoft%windows%currentversion%app paths%winword.exe%protocolhandler.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32.exe% /s%.dll%' and not commandline like '%/n%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32.exe%%s%.dll%' and not commandline like '%n%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%windows%microsoft.net%microsoft.workflow.compiler.exe%') | groupby user, system | duration 1d

stream=win-audit where action='PROCESS_CREATED' and commandline like '%CreateInstance([type]::GetTypeFromCLSID%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%windows%microsoft.net%microsoft.workflow.compiler.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%windows%microsoft.net%microsoft.workflow.compiler.exe%') | groupby user, system | duration 1d

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%windows%microsoft.net%microsoft.workflow.compiler.exe%') | groupby user, system | duration 1d

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%windows%microsoft.net%microsoft.workflow.compiler.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32.exe%%s%.dll%' and not commandline like '%n%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32.exe% /s%.dll%' and not commandline like '%/n%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%CreateInstance([type]::GetTypeFromCLSID%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%CreateInstance([type]::GetTypeFromCLSID%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32.exe% /s%.dll%' and not commandline like '%/n%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32.exe%s%.dll%' and not commandline like '%n%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32.exe% /s%.dll%' and not commandline like '%/n%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32.exe% /s%.dll%' and not commandline like '%/n%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%CreateInstance([type]::GetTypeFromCLSID%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%CreateInstance([type]::GetTypeFromCLSID%' | groupby user, system

stream=cloudtrail where eventname in ("GetCallerIdentity", "ListBuckets", "GetAccountSummary", "ListRoles", "ListUsers", "GetAccountAuthorizationDetails", "DescribeSnapshots", "DescribeTrails", "ListDetectors") | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=cloudtrail where eventsource="s3.amazonaws.com" and eventname="ListBuckets" and useragent like "%aws-cli%" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=win-audit where action='PROCESS_CREATED' and (rlike(commandline, '(takeown.exe|icacls.exe.*grant|icacls.*grant Everyone:F)') or rlike(commandline, '(attrib.exe -r|mkdir.*?echo.*?attrib.exe)')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(commandline, '(takeown.exe|icacls.exe.*grant|icacls.*grant Everyone:F)') or rlike(commandline, 'attrib.exe -r|mkdir.*?echo.*?attrib.exe')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=cloudtrail where eventname in ("GetCallerIdentity", "ListBuckets", "GetAccountSummary", "ListRoles", "ListUsers", "GetAccountAuthorizationDetails", "DescribeSnapshots", "DescribeTrails", "ListDetectors") | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=cloudtrail where eventname in ("GetCallerIdentity", "ListBuckets", "GetAccountSummary", "ListRoles", "ListUsers", "GetAccountAuthorizationDetails", "DescribeSnapshots", "DescribeTrails", "ListDetectors") and userarn like '%{SuspectUser}' | duration 6m

stream=cloudtrail where eventname in ("GetCallerIdentity", "ListBuckets", "GetAccountSummary", "ListRoles", "ListUsers", "GetAccountAuthorizationDetails", "DescribeSnapshots", "DescribeTrails", "ListDetectors") | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=cloudtrail where eventname in ("GetCallerIdentity", "ListBuckets", "GetAccountSummary", "ListRoles", "ListUsers", "GetAccountAuthorizationDetails", "DescribeSnapshots", "DescribeTrails", "ListDetectors") and userarn like '%{SuspectUser}' | duration 6m

stream=cloudtrail where eventsource="s3.amazonaws.com" and eventname="ListBuckets" and useragent like "%aws-cli%" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=cloudtrail where eventsource="s3.amazonaws.com" and eventname="ListBuckets" and useragent like "%aws-cli%" and userarn like '%{SuspectUser}' | duration 6m

stream=cloudtrail where eventsource="iam.amazonaws.com" and eventname="GetAccountPasswordPolicy" and userarn like '%{SuspectUser}' | duration 6m

stream=cloudtrail where eventsource="iam.amazonaws.com" and eventname="GetAccountPasswordPolicy" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=win-audit where action='PROCESS_CREATED' and rlike(commandline, '(takeown.exe|icacls.exe.*grant|icacls.*grant Everyone:F)') | duration 15m

stream=cloudtrail where eventsource="s3.amazonaws.com" and eventname="ListBuckets" and useragent like "%aws-cli%" and userarn like '%{SuspectUser}' | duration 6m

stream=cloudtrail where eventsource="s3.amazonaws.com" and eventname="ListBuckets" and useragent like "%aws-cli%" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=ep-process where action='PROCESS_ADDED' and commandline like '%cmd.exe%/c%copy%C$%' | groupby user, system, commandline

stream=ep-process where action='PROCESS_ADDED' and commandline like '%cmd.exe%/c%copy%C$%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%powershell.exe%RemoteFXvGPUDisablement%' | duration 1d

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%diskshadow.exe%-S%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%diskshadow.exe%-S%' | groupby user, system | duration 1d

stream=iam where eventsource="iam.amazonaws.com" and eventname="CreateUser" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Start-Process%chrome-win%chrome.exe --load-extension%PassThru%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Start-Process%chrome-win%chrome.exe --load-extension%PassThru%' | groupby user, system

stream=WIN-AUDIT,EP-PROCESS where action in ("PROCESS_CREATED", "PROCESS_ADDED") and ( rlike(lower(commandline), "(net.*?stop|sc.*?stop).*?(windefend|mpssvc|wuauserv|wscsvc|sense|policyagent|wdnissvc|vaultsvc|eventlog|nlasvc|bfe|rpcss|rasman|smartscreen|nissrv|winmgmt|alg|winrm|swprv|securityhealthservice|gpsvc|kdc|lanmanserver|lanmanworkstation|msdtc|efs|bdesvc|napagent|wbiosrvc|wbengine|w32time|dgssvc|scardsvr|wscsvc|winrm|mcafeedlpagentservice)") or rlike(lower(commandline), "sc.*?config.*?(windefend|mpssvc|wuauserv|wscsvc|sense|policyagent|wdnissvc|vaultsvc|eventlog|nlasvc|bfe|rpcss|rasman|smartscreen|nissrv|winmgmt|alg|winrm|swprv|securityhealthservice|gpsvc|kdc|lanmanserver|lanmanworkstation|msdtc|efs|bdesvc|napagent|wbiosrvc|wbengine|w32time|dgssvc|scardsvr|wscsvc|winrm|mcafeedlpagentservice).*?start.*?disable")) | groupby user, system

stream=WIN-AUDIT,EP-PROCESS where action in ("PROCESS_CREATED", "PROCESS_ADDED") and ( rlike(lower(commandline), "(net.*?stop|sc.*?stop).*?(windefend|mpssvc|wuauserv|wscsvc|sense|policyagent|wdnissvc|vaultsvc|eventlog|nlasvc|bfe|rpcss|rasman|smartscreen|nissrv|winmgmt|alg|winrm|swprv|securityhealthservice|gpsvc|kdc|lanmanserver|lanmanworkstation|msdtc|efs|bdesvc|napagent|wbiosrvc|wbengine|w32time|dgssvc|scardsvr|wscsvc|winrm|mcafeedlpagentservice)") or rlike(lower(commandline), "sc.*?config.*?(windefend|mpssvc|wuauserv|wscsvc|sense|policyagent|wdnissvc|vaultsvc|eventlog|nlasvc|bfe|rpcss|rasman|smartscreen|nissrv|winmgmt|alg|winrm|swprv|securityhealthservice|gpsvc|kdc|lanmanserver|lanmanworkstation|msdtc|efs|bdesvc|napagent|wbiosrvc|wbengine|w32time|dgssvc|scardsvr|wscsvc|winrm|mcafeedlpagentservice).*?start.*?disable")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=cloudtrail where eventsource="iam.amazonaws.com" and eventname="GetAccountPasswordPolicy" and userarn like '%{SuspectUser}' | duration 6m

stream=cloudtrail where eventsource="iam.amazonaws.com" and eventname="GetAccountPasswordPolicy" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=win-audit where action='PROCESS_CREATED' and commandline like '%cmd.exe%/c%copy%C$%' | groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and commandline like '%cmd.exe%/c%copy%C$%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%cmd.exe%/c%copy%C$%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%cmd.exe%/c%copy%C$%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%powershell.exe%RemoteFXvGPUDisablement%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%powershell.exe%RemoteFXvGPUDisablement%' | groupby user, system | duration 1d

stream=win-audit where action='PROCESS_CREATED' and (((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%usebasicparsing%officeproduct%') or (lower(scriptblocktext) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%usebasicparsing%officeproduct%')) and (rlike(lower(commandline), '(macrocode|create_macro_file|macro_code|macro|macro_name|open_macro)'))) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%usebasicparsing%officeproduct%') or (lower(scriptblocktext) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%usebasicparsing%officeproduct%')) and (rlike(lower(commandline), '(macrocode|create_macro_file|macro_code|macro|macro_name|open_macro)'))) | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and (rlike(commandline, '(takeown.exe|icacls.exe.*grant|icacls.*grant Everyone:F)') or rlike(commandline, 'attrib.exe -r|mkdir.*?echo.*?attrib.exe')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(commandline, '(takeown.exe|icacls.exe.*grant|icacls.*grant Everyone:F)') or rlike(commandline, 'attrib.exe -r|mkdir.*?echo.*?attrib.exe')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%new-object%net.webclient%downloadstring%safedump%consoleoutput%noninteractive%' | duration 1h

stream=win-audit where action='PROCESS_CREATED' and commandline like '%cmd.exe%/c%copy%C$%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%cmd.exe%/c%copy%C$%' | groupby user, system, commandline

stream=EP-PROCESS where action='PROCESS_ADDED' and parentcommandline like '%Invoke-Internalmonologue%-command%' | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and parentcommandline like '%Invoke-Internalmonologue%-command%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%diskshadow.exe%-S%' | duration 1d

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%diskshadow.exe%-S%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%diskshadow.exe%-S%' | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and eid='1' and commandline like '%diskshadow.exe%-S%' | groupby user, system  | duration 1d

stream=ep-process where action='PROCESS_ADDED' and eid='1' and commandline like '%diskshadow.exe%-S%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and eid='1' and commandline like '%diskshadow.exe%-S%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and eid='1' and commandline like '%diskshadow.exe%-S%' | groupby user, system  

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(start-process .\badpotato|stop-process -name.*?badpotato.*?-force -erroraction silentlycontinue|badpotato)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(start-process .\badpotato|stop-process -name.*?badpotato.*?-force -erroraction silentlycontinue|badpotato)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%wuauclt.exe%.dll%' | groupby user, system | duration 1d

stream=win-audit where commandline like '%Gpscript%' | duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Get-ADComputer%-Properties%' or commandline like '%Get-ADComputer%-Properties ms-Mcs-AdmPwd%ms-Mcs-AdmPwdExpirationTime%' or commandline like '%Get-adcomputer -SearchScope subtree -filter%name -like%-Properties%' or commandline like '%AdFind.exe%subtree -f%objectclass=computer%' or commandline like '%AdFind.exe%subtree%objectclass=computer%ms-Mcs-AdmPwd%ms-Mcs-AdmPwdExpirationTime%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Get-ADComputer%-Properties%' or commandline like '%Get-ADComputer%-Properties ms-Mcs-AdmPwd%ms-Mcs-AdmPwdExpirationTime%' or commandline like '%Get-adcomputer -SearchScope subtree -filter%name -like%-Properties%' or commandline like '%AdFind.exe%subtree -f%objectclass=computer%' or commandline like '%AdFind.exe%subtree%objectclass=computer%ms-Mcs-AdmPwd%ms-Mcs-AdmPwdExpirationTime%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Invoke-Internalmonologue%-command%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Invoke-Internalmonologue%-command%' | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%powershell.exe%RemoteFXvGPUDisablement%' | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%powershell.exe%RemoteFXvGPUDisablement%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%diskshadow.exe%-S%' | groupby user, system | duration 1d

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%diskshadow.exe%-S%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and eid='1' and commandline like '%diskshadow.exe%-S%' | groupby user, system 

stream=iam where eventsource="iam.amazonaws.com" and eventname="CreateUser" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username, targetuser | groupby userarn, targetuser

stream=ep-process where action='PROCESS_ADDED' and commandline like '%powershell.exe%RemoteFXvGPUDisablement%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%powershell.exe%RemoteFXvGPUDisablement%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%powershell.exe%RemoteFXvGPUDisablement%' | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and eid='1' and commandline like '%diskshadow.exe%-S%' | groupby user, system  | duration 1d

stream=ep-process where action='PROCESS_ADDED' and eid='1' and commandline like '%diskshadow.exe%-S%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%Start-Process%chrome-win%chrome.exe --load-extension%PassThru%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%Start-Process%chrome-win%chrome.exe --load-extension%PassThru%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%powershell.exe%RemoteFXvGPUDisablement%' | groupby user, system | duration 1d

stream=win-audit where action='PROCESS_CREATED' and commandline like '%powershell.exe%RemoteFXvGPUDisablement%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%powershell.exe%RemoteFXvGPUDisablement%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%powershell.exe%RemoteFXvGPUDisablement%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?(screensaver|screensaveactive|screensavetimeout|screensaverissecure|scrnsave)') | duration 30m

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|winzip.*?-min -a -s|wzzip.*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|winzip.*?-min -a -s|wzzip.*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wuauclt%' | duration 1d

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%adsisearcher%objectcategory=user%FindAll%' or commandline like '%adsisearcher%objectcategory=user%FindOne%' or commandline like '%adsisearcher%objectcategory=organizationalunit%FindAll%' or commandline like '%adsisearcher%SearchRooT%Path%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%adsisearcher%objectcategory=user%FindAll%' or commandline like '%adsisearcher%objectcategory=user%FindOne%' or commandline like '%adsisearcher%objectcategory=organizationalunit%FindAll%' or commandline like '%adsisearcher%SearchRooT%Path%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%del%' or lower(commandline) like '%erase%' or lower(commandline) like '%rmdir%' or lower(commandline) like '%remove-item%' or lower(commandline) like '%sdelete%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%del%' or lower(commandline) like '%erase%' or lower(commandline) like '%rmdir%' or lower(commandline) like '%remove-item%' or lower(commandline) like '%sdelete%') | groupby user, system | having count_col1 > 5

stream=authentication | duration 1h |  groupby srcip | limit 2

stream=iam where eventsource="iam.amazonaws.com" and eventname="CreateUser" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username, targetuser | groupby userarn, targetuser

stream=iam where eventsource="iam.amazonaws.com" and eventname="CreateUser" and userarn like '%{SuspectUser}' and targetuser='{TargetUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(commandline, '(takeown.exe|icacls.exe.*grant|icacls.*grant Everyone:F)') or rlike(commandline, 'attrib.exe -r|mkdir.*?echo.*?attrib.exe')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(commandline, '(takeown.exe|icacls.exe.*grant|icacls.*grant Everyone:F)') or rlike(commandline, 'attrib.exe -r|mkdir.*?echo.*?attrib.exe')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|winzip.*?-min -a -s|wzzip.*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|winzip.*?-min -a -s|wzzip.*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%del%' or lower(commandline) like '%erase%' or lower(commandline) like '%rmdir%' or lower(commandline) like '%remove-item%' or lower(commandline) like '%sdelete%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%del%' or lower(commandline) like '%erase%' or lower(commandline) like '%rmdir%' or lower(commandline) like '%remove-item%' or lower(commandline) like '%sdelete%') | groupby user, system | having count_col1 > 5

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((get-childitem|get-item).*?(creationtime|astwritetime|astaccesstime))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((get-childitem|get-item).*?(creationtime|astwritetime|astaccesstime))') | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(parentprocessname),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(parentprocessname),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") | groupby user, system

stream=osquery where packagename like '%pack_d_compliance_usb_storage%' and action='added' | duration 1h |  groupby devsrcip, hostname

stream=iam where eventsource="iam.amazonaws.com" and eventname="CreateUser" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username, targetuser | groupby userarn, targetuser

stream=iam where eventsource="iam.amazonaws.com" and eventname="CreateUser" and userarn like '%{SuspectUser}' and targetuser='{TargetUser}' | duration 6m

stream=iam where action="GROUP_CREATED" and eventname="CreateGroup" and eventsource="iam.amazonaws.com" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username, @requestParameters.groupName="aws_group" | groupby userarn, @requestParameters.groupName | duration 10m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-WebRequest%-UserAgent%HttpBrowser%1.0%out-null%' or commandline like 'Invoke-WebRequest%-UserAgent%Wget%cvs-stable%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%Opera%out-null%' or commandline like 'Invoke-WebRequest%-UserAgent%<|>%out-null%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-WebRequest%-UserAgent%HttpBrowser%1.0%out-null%' or commandline like 'Invoke-WebRequest%-UserAgent%Wget%cvs-stable%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%Opera%out-null%' or commandline like 'Invoke-WebRequest%-UserAgent%<|>%out-null%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wuauclt.exe%.dll%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wuauclt.exe%.dll%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((get-childitem|get-item).*?(creationtime|astwritetime|astaccesstime))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((get-childitem|get-item).*?(creationtime|astwritetime|astaccesstime))') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%wuauclt.exe%.dll%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%wuauclt.exe%.dll%' | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and commandline like '%cmd.exe%/c%copy%C$%' | groupby user, system, commandline

stream=ep-process where action='PROCESS_ADDED' and commandline like '%cmd.exe%/c%copy%C$%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), 'powershell -executionpolicy bypass -command.*-file') or rlike(lower(commandline), 'get-childitem -path.*(pst|ost|eml|msg|msf|sbd).*export-csv -Path')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), 'powershell -executionpolicy bypass -command.*-file') or rlike(lower(commandline), 'get-childitem -path.*(pst|ost|eml|msg|msf|sbd).*export-csv -Path')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(parentcommandline), 'invoke-(internalmonologue|mimikatz|ninjacopy|powerdump|psinject|reflectivepeinjection|sharpsploit|thehash|wmicommand)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(parentcommandline), 'invoke-(internalmonologue|mimikatz|ninjacopy|powerdump|psinject|reflectivepeinjection|sharpsploit|thehash|wmicommand)') | groupby user, system 

stream=WEBFILTER where url like "%index%index.php%h=%" and system='{TargetHost}' and srcip='{SuspectHost}' | duration 6m

stream=WEBFILTER where url like "%index%index.php%h=%" | groupby system, srcip

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-WebRequest%-UserAgent%HttpBrowser%1.0%out-null%' or commandline like 'Invoke-WebRequest%-UserAgent%Wget%cvs-stable%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%Opera%out-null%' or commandline like 'Invoke-WebRequest%-UserAgent%<|>%out-null%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-WebRequest%-UserAgent%HttpBrowser%1.0%out-null%' or commandline like 'Invoke-WebRequest%-UserAgent%Wget%cvs-stable%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%Opera%out-null%' or commandline like 'Invoke-WebRequest%-UserAgent%<|>%out-null%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=iam where action="GROUP_CREATED" and eventname="CreateGroup" and eventsource="iam.amazonaws.com" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username, @requestParameters.groupName | groupby userarn, @requestParameters.groupName | duration 10m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wuauclt.exe%.dll%'a and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%wuauclt.exe%.dll%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%wuauclt.exe%.dll%' | groupby user, system | duration 1d

stream=win-audit where action='PROCESS_CREATED' and commandline like '%wuauclt.exe%.dll%' | groupby user, system | duration 1d

stream=win-audit where action='PROCESS_CREATED' and commandline like '%wuauclt.exe%.dll%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%wuauclt.exe%.dll%' | groupby user, system | duration 1d

stream=win-audit where action='PROCESS_CREATED' and commandline like '%wuauclt.exe%.dll%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=iam where action="GROUP_CREATED" and eventname="CreateGroup" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username, groupname | groupby userarn, groupname | duration 10m

stream=iam where action="USER_ADDED" and eventname="AddUserToGroup" and groupname in (_groupname_) | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username, targetuser, groupname | groupby userarn, targetuser, groupname | duration 5m

stream=iam where action="USER_ADDED" and eventname="AddUserToGroup" and userarn like '%{SuspectUser}' and targetuser='{TargetUser}'| duration 11m

stream=cloudtrail where eventsource="s3.amazonaws.com" and eventname in ("GetBucketPublicAccessBlock", "GetBucketOwnershipControls", "GetBucketAcl") | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like  '%cipher%/w:%c:%'  | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like  '%cipher%/w:%c:%'and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%powershell -executionpolicy bypass -command%-file%' | groupby user, system, commandline

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%powershell -executionpolicy bypass -command%-file%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where commandline like '%customshellhost.exe%' | duration 1d

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%-s -A%HttpBrowser%1.0%-m3>nul 2>&1%' or commandline like '%-s -A%Wget%1.9+cvs-stable%-m3%>nul 2>&1%' or commandline like '%-s -A%Opera%8.81%-m3%>nul 2>&1%' or commandline like '%-s -A%<|>%-m3%>nul 2>&1%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%-s -A%HttpBrowser%1.0%-m3>nul 2>&1%' or commandline like '%-s -A%Wget%1.9+cvs-stable%-m3%>nul 2>&1%' or commandline like '%-s -A%Opera%8.81%-m3%>nul 2>&1%' or commandline like '%-s -A%<|>%-m3%>nul 2>&1%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (rlike(commandline, '(takeown.exe|icacls.exe.*grant|icacls.*grant Everyone:F)') or rlike(commandline, '(attrib.exe -r|mkdir.*?echo.*?attrib.exe)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(commandline, '(takeown.exe|icacls.exe.*grant|icacls.*grant Everyone:F)') or rlike(commandline, '(attrib.exe -r|mkdir.*?echo.*?attrib.exe)')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'gpscript.exe' and (commandline like '%Gpscript%logon%' or commandline like '%Gpscript%startup%') | duration 1h

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'gpscript.exe' and (commandline like '%Gpscript%logon%' or commandline like '%Gpscript%startup%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'gpscript.exe' and (commandline like '%Gpscript%logon%' or commandline like '%Gpscript%startup%') | groupby user, system | duration 1h

stream=iam where action="GROUP_CREATED" and eventname="CreateGroup" and eventsource="iam.amazonaws.com" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username, groupname | groupby userarn, groupname | duration 10m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%wmic.exe%node%IpAddress%ntlmusers.evtx%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%wmic.exe%node%IpAddress%ntlmusers.evtx%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%adsisearcher%objectcategory=user%FindAll%' or commandline like '%adsisearcher%objectcategory=user%FindOne%' or commandline like '%adsisearcher%objectcategory=organizationalunit%FindAll%' or commandline like '%adsisearcher%SearchRooT%Path%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%adsisearcher%objectcategory=user%FindAll%' or commandline like '%adsisearcher%objectcategory=user%FindOne%' or commandline like '%adsisearcher%objectcategory=organizationalunit%FindAll%' or commandline like '%adsisearcher%SearchRooT%Path%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'gpscript.exe' and (commandline like '%Gpscript%logon%' or commandline like '%Gpscript%startup%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'gpscript.exe' and (commandline like '%Gpscript%logon%' or commandline like '%Gpscript%startup%') | groupby user, system | duration 1h

stream=ep-process where action='PROCESS_ADDED' and commandline like '%cmd.exe%/c%copy%C$%' | groupby user, system, commandline

stream=ep-process where action='PROCESS_ADDED' and commandline like '%cmd.exe%/c%copy%C$%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=iam where action="GROUP_CREATED" and eventname="CreateGroup" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username, groupname | groupby userarn, groupname | duration 10m

stream=iam where action="USER_ADDED" and eventname="AddUserToGroup" and groupname in (_groupname_) | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username, targetuser | groupby userarn, targetuser | duration 5m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?(screensaver|screensaveactive|screensavetimeout|screensaverissecure|scrnsave)') and system='{TargetHost}' and user='{TargetUser}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?(screensaver|screensaveactive|screensavetimeout|screensaverissecure|scrnsave)') | duration 30m | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%kerbrute.exe%userenum%-d%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%kerbrute.exe%userenum%-d%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%adsisearcher%objectcategory=user%FindAll%' or commandline like '%adsisearcher%objectcategory=user%FindOne%' or commandline like '%adsisearcher%objectcategory=organizationalunit%FindAll%' or commandline like '%adsisearcher%SearchRooT%Path%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%adsisearcher%objectcategory=user%FindAll%' or commandline like '%adsisearcher%objectcategory=user%FindOne%' or commandline like '%adsisearcher%objectcategory=organizationalunit%FindAll%' or commandline like '%adsisearcher%SearchRooT%Path%') | groupby user, system

stream=iam where action="USER_ADDED" and eventname="AddUserToGroup" and eventsource="iam.amazonaws.com" and groupname in (_groupname_)| select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username, targetuser | groupby userarn, targetuser | duration 5m

stream=iam where action="GROUP_CREATED" and eventname="CreateGroup" and eventsource="iam.amazonaws.com" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username, groupname | groupby userarn, groupname | duration 10m

stream=cloudtrail where eventsource="s3.amazonaws.com" and eventname in ("GetBucketPublicAccessBlock", "GetBucketOwnershipControls", "GetBucketAcl") and userarn like '%{SuspectUser}' | duration 6m

stream=cloudtrail where eventsource="s3.amazonaws.com" and eventname in ("GetBucketPublicAccessBlock", "GetBucketOwnershipControls", "GetBucketAcl") | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like  '%cipher%/w:%c:%'  | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like  '%cipher%/w:%c:%'and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where sourcename='WINDOWS' and action='PROCESS_CREATED' and (rlike(lower(newprocessname),'(system32|syswow64|winsxs)')) | groupby parentprocessname, newprocessname

stream=win-audit where sourcename='WINDOWS' and action='PROCESS_CREATED' and (rlike(lower(newprocessname),'(system32|syswow64|winsxs)')) | groupby parentprocessname, newprocessname

stream=configuration,win-audit,ep-process where action in ("PROCESS_CREATED", "PROCESS_ADDED", "CONFIGURATION_CHANGED") and rlike(lower(commandline), "new-itemproperty.*?-path.*?(hkcu|hkey_current_user).*?software.*?microsoft.*?(word|excel|powerpoint).*?security.*?protectedview.*?-name.*?(disableinternetfilesinpv|disableunsafelocationsinpv|disableattachmentsinpv).*?-value.*?1.*?-propertytype.*?dword|new-itemproperty.*?-path.*?(hkcu|hkey_current_user).*?software.*?microsoft.*?office*?(word|excel|powerpoint).*?security.*?-name.*?vbawarnings.*?-value.*?1.*?-propertytype.*?dword") | groupby user, system

stream=configuration,win-audit,ep-process where action in ("PROCESS_CREATED", "PROCESS_ADDED", "CONFIGURATION_CHANGED") and rlike(lower(commandline), "new-itemproperty.*?-path.*?(hkcu|hkey_current_user).*?software.*?microsoft.*?(word|excel|powerpoint).*?security.*?protectedview.*?-name.*?(disableinternetfilesinpv|disableunsafelocationsinpv|disableattachmentsinpv).*?-value.*?1.*?-propertytype.*?dword|new-itemproperty.*?-path.*?(hkcu|hkey_current_user).*?software.*?microsoft.*?office*?(word|excel|powerpoint).*?security.*?-name.*?vbawarnings.*?-value.*?1.*?-propertytype.*?dword") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%cmd.exe%/c%copy%C$%' | groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and commandline like '%cmd.exe%/c%copy%C$%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=cloudtrail where eventsource="s3.amazonaws.com" and eventname in ("GetBucketPublicAccessBlock", "GetBucketOwnershipControls", "GetBucketAcl") and userarn like '%{SuspectUser}' | duration 6m

stream=cloudtrail where eventsource="s3.amazonaws.com" and eventname in ("GetBucketPublicAccessBlock", "GetBucketOwnershipControls", "GetBucketAcl") | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=cloudtrail where eventsource="s3.amazonaws.com" and eventname in ("GetBucketPublicAccessBlock", "GetBucketOwnershipControls", "GetBucketAcl") and userarn like '%{SuspectUser}' | duration 6m

stream=cloudtrail where eventsource="s3.amazonaws.com" and eventname in ("GetBucketPublicAccessBlock", "GetBucketOwnershipControls", "GetBucketAcl") | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username | groupby userarn

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (commandline like '%ie4uinit.exe%ieuinit.inf%') | duration 1d

stream=win-audit where sourcename='WINDOWS' and action='PROCESS_CREATED' and (rlike(lower(newprocessname),'(system32|syswow64|winsxs)')) | groupby parentprocessname, newprocessname

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'copy.*?system.exe.*?\\s.*?appdata.*?\\s.exe') or rlike(lower(commandline),'copy.*?system.exe.*?\\s.*?appdata.*?\\s.dll') | duration 10m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%powershell -executionpolicy bypass -command%-file%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%powershell -executionpolicy bypass -command%-file%' | groupby user, system, commandline

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll') | duration 1d

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll')) | duration 15m |  groupby user, system, commandline 

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(TargetObject), '(reg add|new-itemproperty).*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(TargetObject), '(reg add|new-itemproperty).*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel)') | groupby user, system

stream=iam where action="GROUP_CREATED" and eventname="CreateGroup" | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username, groupname | groupby userarn, groupname | duration 10m

stream=iam where action="USER_ADDED" and eventname="AddUserToGroup" and userarn like '%{SuspectUser}' and targetuser='{TargetUser}'| duration 11m

stream=iam where action="USER_ADDED" and eventname="AddUserToGroup" and groupname in (_groupname_) | select count(*) as count_col, userarn, regexp_extract(userarn, "\/([\\w\\-\\@\\.]+)$", 1) as username, targetuser | groupby userarn, targetuser | duration 5m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like  '%cipher%/w:%c:%'  | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like  '%cipher%/w:%c:%'and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adfind.*s.*base.*(lockoutduration|lockoutthreshold|lockoutobservationwindow|maxpwdage|minpwdage|minpwdlength|pwdhistorylength|pwdproperties)') or lower(commandline) like '%adfind%-sc admincountdmp%' or lower(commandline) like '%adfind%-f%objectcategory=person%' or lower(commandline) like '%adfind%-sc exchaddresses%' or lower(commandline) like '%adfind%-f%objectcategory=person%objectclass=user%memberof=cn=administrators%' or lower(commandline) like '%adfind%-f%objectcategory=group%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adfind.*s.*base.*(lockoutduration|lockoutthreshold|lockoutobservationwindow|maxpwdage|minpwdage|minpwdlength|pwdhistorylength|pwdproperties)') or lower(commandline) like '%adfind%-sc admincountdmp%' or lower(commandline) like '%adfind%-f%objectcategory=person%' or lower(commandline) like '%adfind%-sc exchaddresses%' or lower(commandline) like '%adfind%-f%objectcategory=person%objectclass=user%memberof=cn=administrators%' or lower(commandline) like '%adfind%-f%objectcategory=group%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%powershell -executionpolicy bypass -command%-file%' | groupby user, system, parentcommandline

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%powershell -executionpolicy bypass -command%-file%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%customshellhost.exe%calc.exe%') and eid='1' | groupby  user, system | duration 1d

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%generaldomaininfo%-noninteractive%-consoleoutput%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%generaldomaininfo%-noninteractive%-consoleoutput%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT,EP-PROCESS,CONFIGURATION where action in ("PROCESS_CREATED", "PROCESS_ADDED", "CONFIGURATION_CHANGED") and (lower(commandline) like "%mpcmdrun%-removedefinitions%" or rlike(lower(commandline),"(del|remove).*?programdata.*?microsoft.*?windows.*?defender.*?defination.*?update")) | groupby user, system

stream=WIN-AUDIT,EP-PROCESS,CONFIGURATION where action in ("PROCESS_CREATED", "PROCESS_ADDED", "CONFIGURATION_CHANGED") and (lower(commandline) like "%mpcmdrun%-removedefinitions%" or rlike(lower(commandline),"(del|remove).*?programdata.*?microsoft.*?windows.*?defender.*?defination.*?update")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=authentication where action="LOGIN" and status="FAILED" |  groupby user |  limit 5 |  duration 10m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%windows%control.exe%' | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%windows%control.exe%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%powershell.exe%WindowStyle hidden%calc.exe%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (commandline like '%powershell.exe%WindowStyle hidden%calc.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (commandline like '%ie4uinit.exe%ieuinit.inf%') | groupby user, system | duration 1d

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (commandline like '%ie4uinit.exe%ieuinit.inf%') | groupby user, system | duration 1d

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (commandline like '%ie4uinit.exe%ieuinit.inf%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and ( lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%"  or lower(commandline) like "%appcmd%set%config%section%httplogging%dontlog%true%" or rlike(lower(commandline),"(hklm|hkey_local_machine).*?software.*?microsoft.*?iis.*?httplogging.*?logextfileflags.*?0")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and ( lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%"  or lower(commandline) like "%appcmd%set%config%section%httplogging%dontlog%true%" or rlike(lower(commandline),"(hklm|hkey_local_machine).*?software.*?microsoft.*?iis.*?httplogging.*?logextfileflags.*?0"))  | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%inveigh%nbns%mdns%') or (lower(commandline) like '%hklm%software%policies%microsoft%windows nt%dnsclient%')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%inveigh%nbns%mdns%') or (lower(commandline) like '%hklm%software%policies%microsoft%windows nt%dnsclient%')) | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'%copy%Ssystem%.exe%\s%appdata%') | duration 1h

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll')) | duration 15m |  groupby user, system, commandline 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll')) and user='{SuspectUser}' and system='{TargetHost}' 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll')) | duration 15m |  groupby user, system, commandline 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll')) and user='{SuspectUser}' and system='{TargetHost}' 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (commandline like '%ie4uinit.exe%ieuinit.inf%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (commandline like '%ie4uinit.exe%ieuinit.inf%') | groupby user, system | duration 1d

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (commandline like '%ie4uinit.exe%ieuinit.inf%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (commandline like '%ie4uinit.exe%ieuinit.inf%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll')) and user='{SuspectUser}' and system='{TargetHost}' | duration 16m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll')) | duration 15m |  groupby user, system, commandline 

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), 'system.management.automation.amsi.*?(amsiinitfailed|scancontent|amsicontext|amsisession|amsiutils.init|amsiscanbuffer|amsi.dll)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), 'system.management.automation.amsi.*?(amsiinitfailed|scancontent|amsicontext|amsisession|amsiutils.init|amsiscanbuffer|amsi.dll)') | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'copy.*?system.exe.*?\s.*?appdata\s.exe') | duration 1h

stream=nta-notice where noticeidentifier like "%SSL::Invalid_Server_Cert%" and analyzer like '%Notice::ACTION_LOG%' and errormsg like '%self signed certificate%'| groupby noticeidentifier, srcip, dstip, errormsg |  duration 1h

stream=nta-notice where srcip = "{TargetHost}" and dstip = "SuspectHost" |  duration 1h

stream=EP-PROCESS where action='PROCESS_ADDED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%inveigh%nbns%mdns%') or (lower(commandline) like '%hklm%software%policies%microsoft%windows nt%dnsclient%')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%inveigh%nbns%mdns%') or (lower(commandline) like '%hklm%software%policies%microsoft%windows nt%dnsclient%')) | groupby user, system | duration 2h

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%generaldomaininfo%-noninteractive%-consoleoutput%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%generaldomaininfo%-noninteractive%-consoleoutput%' | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%') | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (rlike(lower(commandline), "curl.exe'.*-k.*-(F|T|d).*?https://file.io/") or rlike(lower(commandline), "curl.exe'.*-k.*(--data|--data-|--form|--upload-file)")) | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (image like '%cmd.exe%' or image like '%powershell.exe%') and (commandline like '%C:%Windows%System32%.exe%https%' or commandline like '%C:%Windows%System32%.exe%tls%https%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Get-ADComputer%-Properties%' or commandline like '%Get-ADComputer%-Properties ms-Mcs-AdmPwd%ms-Mcs-AdmPwdExpirationTime%' or commandline like '%Get-adcomputer -SearchScope subtree -filter%name -like%-Properties%' or commandline like '%AdFind.exe%subtree -f%objectclass=computer%' or commandline like '%AdFind.exe%subtree%objectclass=computer%ms-Mcs-AdmPwd%ms-Mcs-AdmPwdExpirationTime%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Get-ADComputer%-Properties%' or commandline like '%Get-ADComputer%-Properties ms-Mcs-AdmPwd%ms-Mcs-AdmPwdExpirationTime%' or commandline like '%Get-adcomputer -SearchScope subtree -filter%name -like%-Properties%' or commandline like '%AdFind.exe%subtree -f%objectclass=computer%' or commandline like '%AdFind.exe%subtree%objectclass=computer%ms-Mcs-AdmPwd%ms-Mcs-AdmPwdExpirationTime%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%wmic.exe%node%IpAddress%ntlmusers.evtx%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%wmic.exe%node%IpAddress%ntlmusers.evtx%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%.CreationTime =%' or commandline like '%.LastWriteTime =%' or commandline like '%.LastAccessTime =%') | groupby user, system, commandline

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ChildItem%.CreationTime =%' or commandline like '%Get-ChildItem%.LastWriteTime =%' or commandline like '%Get-ChildItem%.LastAccessTime =%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (scriptblocktext like '%Get-ChildItem%.CreationTime =%' or scriptblocktext like '%Get-ChildItem%.LastWriteTime =%' or scriptblocktext like '%Get-ChildItem%.LastAccessTime =%') or (commandline like '%Get-ChildItem%.CreationTime =%' or commandline like '%Get-ChildItem%.LastWriteTime =%' or commandline like '%Get-ChildItem%.LastAccessTime =%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (scriptblocktext like '%.CreationTime =%' or scriptblocktext like '%.LastWriteTime =%' or scriptblocktext like '%.LastAccessTime =%') or (commandline like '%.CreationTime =%' or commandline like '%.LastWriteTime =%' or commandline like '%.LastAccessTime =%') | groupby user, system, commandline, scriptblocktext

stream=configuration where action='CONFIGURATION_CHANGED' and (commandline like '%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%-ParentId%' or commandline like '%Start-ATHProcessUnderSpecificParent%-ParentId%-FilePath%' or commandline like '%Start-Process%-FilePath%-PassThru%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' or commandline like '%Get-Process -Name%Start-ATHProcessUnderSpecificParent -FilePath%-CommandLine%') and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and (commandline like '%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%-ParentId%' or commandline like '%Start-ATHProcessUnderSpecificParent%-ParentId%-FilePath%' or commandline like '%Start-Process%-FilePath%-PassThru%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' or commandline like '%Get-Process -Name%Start-ATHProcessUnderSpecificParent -FilePath%-CommandLine%') | groupby system, commandline

stream=EP-FILE where action="FILE_CREATED" and rlike(lower(targetfilename),"\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") | groupby substring_index(targetfilename,"\\",-1), targetfilename, user, system | select substring_index(targetfilename,"\\",-1) as file, targetfilename, user, system 

stream=EP-FILE where action="FILE_CREATED" and rlike(lower(targetfilename),"\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") and targetfilename="{SuspectObject}" and user="{SuspectUser}" and system="{TargetHost}" | duraton 6m

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%powershell -executionpolicy bypass -command%-file%' | groupby user, system, parentcommandline

stream=ep-process where action='PROCESS_ADDED' and parentcommandline like '%powershell -executionpolicy bypass -command%-file%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%customshellhost.exe%calc.exe%') and eid='1'  and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%customshellhost.exe%calc.exe%') and eid='1' | groupby  user, system | duration 1d

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((get-childitem|get-item).*?(creationtime|astwritetime|astaccesstime))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((get-childitem|get-item).*?(creationtime|astwritetime|astaccesstime))') | groupby user, system, commandline, scriptblocktext

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-p%-exportpfx%.pfx') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-p%-exportpfx%.pfx') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '((get-childitem|get-item).*?(creationtime|astwritetime|astaccesstime))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '((get-childitem|get-item).*?(creationtime|astwritetime|astaccesstime))') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(net localgroup.*?net (list|group).*?domain|net group.*?domain_controllers)') | duration 2h | limit 10 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%customshellhost.exe%calc.exe%') and eid='1'  and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%customshellhost.exe%calc.exe%') and eid='1' | groupby  user, system | duration 1d

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%customshellhost.exe%calc.exe%') and eid='1' | groupby  user, system 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%customshellhost.exe%calc.exe%') and eid='1'  and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%powershell -executionpolicy bypass -command%-file%' | groupby user, system, commandline

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%powershell -executionpolicy bypass -command%-file%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%') or (lower(commandline) like '%hklm%software%policies%microsoft%windows nt%dnsclient%')) | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%') or (lower(commandline) like '%hklm%software%policies%microsoft%windows nt%dnsclient%')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%crypto::%certificates%export%') | groupby user, system
 and user='{SuspectUser}' and system='{TargetHost}' | duration 31m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%crypto::%certificates%export%') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(newprocessname), ".(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") | groupby NewProcessName, substring_index(NewProcessName,"\\",-1), user, system | select newprocessname, substring_index(NewProcessName,"\\",-1) as processname, user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(newprocessname), ".(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") and newprocessname="{SuspectObject}" and user="{SuspectUser}" and system="{TargetHost}" | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and ( lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%"  or lower(commandline) like "%appcmd%set%config%section%httplogging%dontlog%true%" or rlike(lower(commandline),"(hklm|hkey_local_machine).*?software.*?microsoft.*?iis.*?httplogging.*?logextfileflags.*?0")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and ( lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%"  or lower(commandline) like "%appcmd%set%config%section%httplogging%dontlog%true%" or rlike(lower(commandline),"(hklm|hkey_local_machine).*?software.*?microsoft.*?iis.*?httplogging.*?logextfileflags.*?0"))  | groupby user, system

stream=win-audit where (lower(commandline) like '%mkdir%temp%dir%/b%/s%.docx%findstr%/e%.docx%for%/r%in%copy%/y%temp%' or lower(commandline) like '%new-item%-path%env:temp%-itemtype directory%-force%get-childitem%-include%doc%destination%env:temp%' or lower(commandline) like '%get-service%env:temp%get-childitem%env:%get-process%env:temp%' or lower(commandline) like '%sc%query%type=service%temp%doskey%/history%temp%wmic%process%list%temp%tree%') or (lower(scriptblocktext) like '%mkdir%temp%dir%/b%/s%.docx%findstr%/e%.docx%for%/r%in%copy%/y%temp%' or lower(scriptblocktext) like '%new-item%-path%env:temp%-itemtype directory%-force%get-childitem%-include%doc%destination%env:temp%' or lower(scriptblocktext) like '%get-service%env:temp%get-childitem%env:%get-process%env:temp%' or lower(scriptblocktext) like '%sc%query%type=service%temp%doskey%/history%temp%wmic%process%list%temp%tree%') | groupby system, user

stream=win-audit where (lower(commandline) like '%mkdir%temp%dir%/b%/s%.docx%findstr%/e%.docx%for%/r%in%copy%/y%temp%' or lower(commandline) like '%new-item%-path%env:temp%-itemtype directory%-force%get-childitem%-include%doc%destination%env:temp%' or lower(commandline) like '%get-service%env:temp%get-childitem%env:%get-process%env:temp%' or lower(commandline) like '%sc%query%type=service%temp%doskey%/history%temp%wmic%process%list%temp%tree%') or (lower(scriptblocktext) like '%mkdir%temp%dir%/b%/s%.docx%findstr%/e%.docx%for%/r%in%copy%/y%temp%' or lower(scriptblocktext) like '%new-item%-path%env:temp%-itemtype directory%-force%get-childitem%-include%doc%destination%env:temp%' or lower(scriptblocktext) like '%get-service%env:temp%get-childitem%env:%get-process%env:temp%' or lower(scriptblocktext) like '%sc%query%type=service%temp%doskey%/history%temp%wmic%process%list%temp%tree%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), 'powershell -executionpolicy bypass -command.*-file') or rlike(lower(commandline), 'get-childitem -path.*(pst|ost|eml|msg|msf|sbd).*export-csv -Path')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), 'powershell -executionpolicy bypass -command.*-file') or rlike(lower(commandline), 'get-childitem -path.*(pst|ost|eml|msg|msf|sbd).*export-csv -Path')) | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%adsisearcher%objectcategory=user%FindAll%' or commandline like '%adsisearcher%objectcategory=user%FindOne%' or commandline like '%adsisearcher%objectcategory=organizationalunit%FindAll%' or commandline like '%adsisearcher%SearchRooT%Path%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%adsisearcher%objectcategory=user%FindAll%' or commandline like '%adsisearcher%objectcategory=user%FindOne%' or commandline like '%adsisearcher%objectcategory=organizationalunit%FindAll%' or commandline like '%adsisearcher%SearchRooT%Path%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Get-ADObject%LDAPFilter%-Server%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Get-ADObject%LDAPFilter%-Server%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and commandline like '%Get-CimInstance%Name = %svchost.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' | groupby system, commandline

stream=configuration where action='CONFIGURATION_CHANGED' and commandline like '%Get-CimInstance%Name = %svchost.exe%Start-ATHProcessUnderSpecificParent%-FilePath%-CommandLine%' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%') | groupby user, system

stream=authentication where action="LOGIN" and status="FAILED" | duration from 2024-02-27T10:00:00 to 2024-02-27T11:00:00   |groupby srcip, user

stream=win-audit where (scriptblocktext like '%Get-ChildItem%.CreationTime =%' or scriptblocktext like '%Get-ChildItem%.LastWriteTime =%' or scriptblocktext like '%Get-ChildItem%.LastAccessTime =%') or (commandline like '%Get-ChildItem%.CreationTime =%' or commandline like '%Get-ChildItem%.LastWriteTime =%' or commandline like '%Get-ChildItem%.LastAccessTime =%') | groupby user, system, commandline

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), 'powershell -executionpolicy bypass -command.*-file') or rlike(lower(commandline), 'get-childitem -path.*(pst|ost|eml|msg|msf|sbd).*export-csv -Path')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), 'powershell -executionpolicy bypass -command.*-file') or rlike(lower(commandline), 'get-childitem -path.*(pst|ost|eml|msg|msf|sbd).*export-csv -Path')) | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%PetitPotam%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%PetitPotam%' | groupby user, system 

stream=win-audit where (scriptblocktext like '%Get-ChildItem%.CreationTime =%' or scriptblocktext like '%Get-ChildItem%.LastWriteTime =%' or scriptblocktext like '%Get-ChildItem%.LastAccessTime =%') or (commandline like '%Get-ChildItem%.CreationTime =%' or commandline like '%Get-ChildItem%.LastWriteTime =%' or commandline like '%Get-ChildItem%.LastAccessTime =%') | groupby user, system, commandline

stream=win-audit where (scriptblocktext like '%Get-ChildItem%.CreationTime =%' or scriptblocktext like '%Get-ChildItem%.LastWriteTime =%' or scriptblocktext like '%Get-ChildItem%.LastAccessTime =%') or (commandline like '%Get-ChildItem%.CreationTime =%' or commandline like '%Get-ChildItem%.LastWriteTime =%' or commandline like '%Get-ChildItem%.LastAccessTime =%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (scriptblocktext like '%Get-ChildItem%.CreationTime =%' or scriptblocktext like '%Get-ChildItem%.LastWriteTime =%' or scriptblocktext like '%Get-ChildItem%.LastAccessTime =%') or (commandline like '%Get-ChildItem%.CreationTime =%' or commandline like '%Get-ChildItem%.LastWriteTime =%' or commandline like '%Get-ChildItem%.LastAccessTime =%') | groupby user, system, commandline

stream=win-audit where (scriptblocktext like '%Get-ChildItem%.CreationTime =%' or scriptblocktext like '%Get-ChildItem%.LastWriteTime =%' or scriptblocktext like '%Get-ChildItem%.LastAccessTime =%') or (commandline like '%Get-ChildItem%.CreationTime =%' or commandline like '%Get-ChildItem%.LastWriteTime =%' or commandline like '%Get-ChildItem%.LastAccessTime =%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ChildItem%.CreationTime =%' or commandline like '%Get-ChildItem%.LastWriteTime =%' or commandline like '%Get-ChildItem%.LastAccessTime =%') | groupby user, system, commandline

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ChildItem%.CreationTime =%' or commandline like '%Get-ChildItem%.LastWriteTime =%' or commandline like '%Get-ChildItem%.LastAccessTime =%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell%" and commandline like "%Get-ADReplAccount%" | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell%" and commandline like "%Get-ADReplAccount%" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%' or commandline like 'ADRecon.ps1') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe" and rlike(lower(commandline), '\\\\\\\\..*?\\:.*?(open|read|readwrite)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and NewProcessName like "%powershell.exe" and rlike(lower(commandline), '\\\\\..*?\:.*?(open|read|readwrite)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (scriptblocktext like '%Get-ChildItem%.CreationTime =%' or scriptblocktext like '%Get-ChildItem%.LastWriteTime =%' or scriptblocktext like '%Get-ChildItem%.LastAccessTime =%') or (commandline like '%Get-ChildItem%.CreationTime =%' or commandline like '%Get-ChildItem%.LastWriteTime =%' or commandline like '%Get-ChildItem%.LastAccessTime =%') | groupby user, system, commandline, scriptblocktext

stream=win-audit where (scriptblocktext like '%Get-ChildItem%.CreationTime =%' or scriptblocktext like '%Get-ChildItem%.LastWriteTime =%' or scriptblocktext like '%Get-ChildItem%.LastAccessTime =%') or (commandline like '%Get-ChildItem%.CreationTime =%' or commandline like '%Get-ChildItem%.LastWriteTime =%' or commandline like '%Get-ChildItem%.LastAccessTime =%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%gpresult /z%' or rlike(commandline, 'powershell.*nop.*exec.*bypass.*New-Object.*Net.WebClient.*network.*?\.')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%gpresult /z%' or rlike(commandline, 'powershell.*nop.*exec.*bypass.*New-Object.*Net.WebClient.*network.*?\.')) | groupby user, system

stream=osquery where packagename like '%pack_d_compliance_usb_storage%' and action='added' | duration 5m |  groupby devsrcip, hostname

stream=osquery where packagename like '%pack_d_compliance_usb_storage%' and devsrcip='{TargetHost}' and hostname='{SuspectHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%iex(new-object net.webclient).downloadstring%GPOAudit%noninteractive%consoleoutput%' or commandline like '%iex(new-object net.webclient).downloadstring%GPORemoteAccessPolicy%consoleoutput%noninteractive%')  | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%iex(new-object net.webclient).downloadstring%GPOAudit%noninteractive%consoleoutput%' or commandline like '%iex(new-object net.webclient).downloadstring%GPORemoteAccessPolicy%consoleoutput%noninteractive%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=hypercloud | duration 1d |  limit 1

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%gpresult /z%' or rlike(commandline, 'powershell.*nop.*exec.*bypass.*New-Object.*Net.WebClient.*network.*?\.')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%gpresult /z%' or rlike(commandline, 'powershell.*nop.*exec.*bypass.*New-Object.*Net.WebClient.*network.*?\.')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Get-GPO%-Domain%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Get-GPO%-Domain%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%dir%-Recurse%Compress-Archive -DestinationPath%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%dir%-Recurse%Compress-Archive -DestinationPath%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%' or commandline like '%ADRecon.ps1%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%gpresult /z%' or rlike(commandline, 'powershell.*nop.*exec.*bypass.*New-Object.*Net.WebClient.*network.*?\.')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%gpresult /z%' or rlike(commandline, 'powershell.*nop.*exec.*bypass.*New-Object.*Net.WebClient.*network.*?\.')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%pnputil.exe%add-driver%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%cmd.exe%' and commandline like '%pnputil.exe%add-driver%' | groupby system, user 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Import%Module%AADInternals%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%Import-Module%AADInternals%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%system%control%print%bin%' or commandline like '%SYSTEM%CurrentControlSet%Control%Print%bin%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%system%control%print%bin%' or commandline like '%SYSTEM%CurrentControlSet%Control%Print%bin%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'nltest.exe' and (commandline like '%nltest%domain_trusts%' or commandline like '%nltest%trusted_domains%' ) | groupby user, system |duration 1d

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'powershell.exe' and (commandline like '%Get-DomainTrust%' or commandline like '%Get-ForestTrust%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Remove-Item%$env:TEMP%windows-credentials.txt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%windows-credentials.txt%' | groupby user,system

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Get-GPO%-Domain%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Get-GPO%-Domain%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%dir%-Recurse%Compress-Archive -DestinationPath%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%dir%-Recurse%Compress-Archive -DestinationPath%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and commandline like '%pnputil.exe%add-driver%' | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%cmd.exe%' and commandline like '%pnputil.exe%add-driver%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'nltest.exe' and (commandline like '%nltest%domain_trusts%' or commandline like '%nltest%trusted_domains%' ) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'powershell.exe' and (commandline like '%Get-DomainTrust%' or commandline like '%Get-ForestTrust%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%reg add%SYSTEM%CurrentControlSet%Control%Lsa%' and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and commandline like '%reg add%SYSTEM%CurrentControlSet%Control%Lsa%' and rlike(commandline, 'REG_MULTI_SZ.*?\\.*?\.')

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ammyy%' or commandline like '%RemotePC%' or commandline like '%NetSupport%' or commandline like '%UltraViewer%' or commandline like '%UltraVnc%' or commandline like '%msp360connect%') |  groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ammyy%' or commandline like '%RemotePC%' or commandline like '%NetSupport%' or commandline like '%UltraViewer%' or commandline like '%UltraVnc%' or commandline like '%msp360connect%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%new-smbshare%' or lower(commandline) like '%remove-smbshare%' or lower(commandline) like '%remove-psdrive%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%new-smbshare%' or lower(commandline) like '%remove-smbshare%' or lower(commandline) like '%remove-psdrive%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-WebRequest%-UserAgent%HttpBrowser%1.0%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%Wget%cvs-stable%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%Opera%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%<|>%out-null%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-WebRequest%-UserAgent%HttpBrowser%1.0%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%Wget%cvs-stable%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%Opera%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%<|>%out-null%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ChildItem%Bookmarks%' or commandline like '%/R C:%Bookmarks%' or commandline like '%/R C:%places.sqlite%' or commandline like '%/s /b%USERPROFILE%Favorites%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ChildItem%Bookmarks%' or commandline like '%/R C:%Bookmarks%' or commandline like '%/R C:%places.sqlite%' or commandline like '%/s /b%USERPROFILE%Favorites%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%gpresult /z%' or rlike(commandline, 'powershell.*nop.*exec.*bypass.*New-Object.*Net.WebClient.*network.*?\.')) | groupby user, system | duration 30m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%iex(new-object net.webclient).downloadstring%GPOAudit%noninteractive%consoleoutput%' or commandline like '%iex(new-object net.webclient).downloadstring%GPORemoteAccessPolicy%consoleoutput%noninteractive%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%iex(new-object net.webclient).downloadstring%GPOAudit%noninteractive%consoleoutput%' or commandline like '%iex(new-object net.webclient).downloadstring%GPORemoteAccessPolicy%consoleoutput%noninteractive%')  | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts|whoami /all|net view /all|cmd /c set|net share|route print|netstat -nao|qwinsta|wmi query rootcim)")) | duration 15m |  select system, user, commandline | limit 10000

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts|whoami /all|net view /all|cmd /c set|net share|route print|netstat -nao|qwinsta|wmi query rootcim)"))  and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%gpresult /z%' or rlike(commandline, 'powershell.*nop.*exec.*bypass.*New-Object.*Net.WebClient.*network.*?\.')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%gpresult /z%' or rlike(commandline, 'powershell.*nop.*exec.*bypass.*New-Object.*Net.WebClient.*network.*?\.')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Get-GPO%-Domain%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Get-GPO%-Domain%' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "cmdkey.*?(list|delete|add)") and user='{SuspectUser}' and system='{TragetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "cmdkey.*?(list|delete|add|pass)") | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Import%Module%AADInternals%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%Import-Module%AADInternals%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%Import%Module%AADInternals' or commandline like '%Export%AADIntADFSCertificates%' or commandline like '%Import%Module%ActiveDirectory%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%' or commandline like 'ADRecon.ps1') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (commandline like '%Invoke-Expression%ADRecon.ps1%' or commandline like '%Invoke-Expression%ADReconScript.ps1%' or commandline like '%ADRecon.ps1%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%Print%Environments%Windows%x64%Print%Processors%' or commandline like '%HKLM%SYSTEM%ControlSet%Control%Print%Monitors%' or commandline like 'HKLM%SYSTEM%ControlSet%Control%Print%Environments%Windows%Print Processors%' or commandline like '%REGISTRY%MACHINE%SYSTEM%ControlSet%Control%Print%Monitors%' or commandline like '%REGISTRY%MACHINE%SYSTEM%ControlSet%Control%Print%Environments%Windows%Print Processors%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%HKLM%SYSTEM%CurrentControlSet%Control%Print%Environments%Windows%x64%Print%Processors%' or commandline like '%HKLM%SYSTEM%ControlSet%Control%Print%Monitors%' or commandline like 'HKLM%SYSTEM%ControlSet%Control%Print%Environments%Windows%Print Processors%' or commandline like '%REGISTRY%MACHINE%SYSTEM%ControlSet%Control%Print%Monitors%' or commandline like '%REGISTRY%MACHINE%SYSTEM%ControlSet%Control%Print%Environments%Windows%Print Processors%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%nltest.exe%' and rlike(lower(commandline), "nltest.*?(domain_trusts|trusted_domains|dclist:|dcname:|dsget|lsaqueryfti:|parentdomain|bdc_query:)") | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%nltest.exe%' and rlike(lower(commandline), "nltest.*?(domain_trusts|trusted_domains|dclist:|dcname:|dsget|lsaqueryfti:|parentdomain|bdc_query:)")  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=signals |  duration 1h

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(parentprocessname),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(parentprocessname),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") | groupby user, system 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'powershell.exe' and (commandline like '%Get-DomainTrust%' or commandline like '%Get-ForestTrust%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%nltest.exe%' and  (lower(commandline) like '%nltest%domain_trusts%' or lower(commandline) like '%nltest%trusted_domains%') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") or rlike(lower(commandline),'(hkey_classes_root|hkcr).*shell.*nsudo.(exe|bat|cmd|inf|ps1|py|reg|vbs)') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") or rlike(lower(commandline),'(hkey_classes_root|hkcr).*shell.*nsudo.(exe|bat|cmd|inf|ps1|py|reg|vbs)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") or rlike(lower(commandline),'(hkey_classes_root|hkcr).*shell.*nsudo.(exe|bat|cmd|inf|ps1|py|reg|vbs)') | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") or rlike(lower(commandline),'(hkey_classes_root|hkcr).*shell.*nsudo.(exe|bat|cmd|inf|ps1|py|reg|vbs)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%' or commandline like '%Start-Process%BadPotato%' or commandline like '%Start-Process%notepad%' or commandline like '%Stop-Process%BadPotato%' or commandline like '%Stop-Process%notepad%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (commandline like '%Start-Process%' or commandline like '%Start-Sleep%' or commandline like '%Stop-Process%' or commandline like '%Start-Process%BadPotato%' or commandline like '%Start-Process%notepad%' or commandline like '%Stop-Process%BadPotato%' or commandline like '%Stop-Process%notepad%') | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") or rlike(lower(commandline),'(hkey_classes_root|hkcr).*shell.*nsudo.(exe|bat|cmd|inf|ps1|py|reg|vbs)') | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") or rlike(lower(commandline),'(hkey_classes_root|hkcr).*shell.*nsudo.(exe|bat|cmd|inf|ps1|py|reg|vbs)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%nltest.exe%' and rlike(lower(commandline), "nltest.*?(domain_trusts|trusted_domains|dclist:|dcname:|dsget|lsaqueryfti:|parentdomain|bdc_query:)") | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%nltest.exe%' and rlike(lower(commandline), "nltest.*?(domain_trusts|trusted_domains|dclist:|dcname:|dsget|lsaqueryfti:|parentdomain|bdc_query:)")  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and  (rlike(lower(commandline),"mkdir.*?windows .*?(system32|syswow64)") or rlike(lower(commandline),"(copy |mlink ).*?windows .*?(system32|syswow64)")) | groupby user, system, commandline

stream=WIN-AUDIT where action="PROCESS_CREATED" and  (rlike(lower(commandline),"mkdir.*?windows .*?(system32|syswow64)") or rlike(lower(commandline),"(copy |mlink ).*? .*?windows .*?(system32|syswow64)")) and user='{SuspectUser}' and system='{TargetHost}' and commandline='{TargetObject}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and eid='1' and (lower(commandline) like '%radmin%viewer%radmin.exe%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and eid='1' and (lower(commandline) like '%radmin%viewer%radmin.exe%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%c:%windows%system32%certutil%-p%-exportpfx%.pfx') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%c:%windows%system32%certutil%-p%-exportpfx%.pfx') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%c:%windows%system32%certutil%-p%-exportpfx%.pfx') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%c:%windows%system32%certutil%-p%-exportpfx%.pfx') | groupby user, system, logevent

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?ms-settings.*?(cmd|powershell)") | groupby user, system 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?ms-settings.*?(cmd|powershell)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-p%-exportpfx%.pfx' or lower(commandline) like '%certutil%/exportpfx%') | groupby user, system  

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-exportpfx%' or lower(commandline) like '%certutil%/exportpfx%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' (lower(commandline) like '%radmin%viewer%radmin.exe%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (lower(commandline) like '%radmin%viewer%radmin.exe%') | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-p%-exportpfx%.pfx' or lower(commandline) like '%certutil%/exportpfx%') | groupby user, system  

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-p%-exportpfx%.pfx' or lower(commandline) like '%certutil%/exportpfx%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-p%-exportpfx%.pfx') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-p%-exportpfx%.pfx') | groupby user, system | duration 1h

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%c:%windows%system32%certutil%-p%-exportpfx%.pfx') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%c:%windows%system32%certutil%-p%-exportpfx%.pfx') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline), 'bitsadmin\..*?transfer.*?download.*?priority.*?foreground') or rlike(lower(commandline), 'bitsadmin\..*?(addfile|create|setnotifycmdline|resume|complete|ping -n)')) | groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline), 'bitsadmin\..*?transfer.*?download.*?priority.*?foreground') or rlike(lower(commandline), 'bitsadmin\..*?(addfile|create|setnotifycmdline|resume|complete|ping -n)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%iex%invoke%inveigh%nbns%mdns%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%iex%invoke%inveigh%nbns%mdns%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (rlike(lower(commandline), "curl.exe'.*-k.*-(F|T|d).*?https://file.io/") or rlike(lower(commandline), "curl.exe'.*-k.*(--data|--data-|--form|--upload-file)")) | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (rlike(lower(commandline), "curl.exe'.*-k.*-(F|T|d).*?https://file.io/") or rlike(lower(commandline), "curl.exe'.*-k.*(--data|--data-|--form|--upload-file)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%iex%invoke%inveigh%nbns%mdns%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%iex%invoke%inveigh%nbns%mdns%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'kerbrute.*?userenum.*?(-d|--dc|-t|-o|-safe)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'kerbrute.*?userenum.*?(-d|--dc|-t|-o|-safe)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image like '%jsc.exe%' and (parentcommandline like '%.js%' or parentcommandline like '%.dll%') | groupby system, user, parentcommandline

stream=ep-process where action='PROCESS_ADDED' and image like '%jsc.exe%' and (parentcommandline like '%.js%' or parentcommandline like '%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (lower(commandline) like '%start-bitstransfer%priority%foreground%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (lower(commandline) like '%start-bitstransfer%priority%foreground%') | groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%wmic%' and rlike(lower(commandline),'wevtutil.*?(epl|export-log).*?c:.*?(q|sq|lf|ow):.*?system.*?eventid=4776') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%wmic%' and rlike(lower(commandline),'wevtutil.*?(epl|export-log).*?c:.*?(q|sq|lf|ow):.*?system.*?eventid=4776') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%iex%invoke%inveigh%nbns%mdns%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%iex%invoke%inveigh%nbns%mdns%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%') or (lower(commandline) like '%hklm%software%policies%microsoft%windows nt%dnsclient%')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%') or (lower(commandline) like '%hklm%software%policies%microsoft%windows nt%dnsclient%')) | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%msbuild.exe%.csproj%' or commandline like '%msbuild.exe%.xml%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%msbuild.exe%.csproj%' or commandline like '%msbuild.exe%.xml%') | groupby system, user, commandline

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%msbuild.exe%.csproj%' or commandline like '%msbuild.exe%.xml%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%msbuild.exe%.csproj%' or commandline like '%msbuild.exe%.xml%') | groupby system, user, commandline

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%msbuild.exe%proj%' or commandline like '%msbuild.exe%.xml%' or commandline like '%msbuild.exe%.dll%' or commandline like '%msbuild.exe%.rsp%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%msbuild.exe%proj%' or commandline like '%msbuild.exe%.xml%' or commandline like '%msbuild.exe%.dll%' or commandline like '%msbuild.exe%.rsp%') | groupby system, user, commandline

stream=EP-PROCESS where action="PROCESS_ADDED" and ( lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%"  or lower(commandline) like "%appcmd%set%config%section%httplogging%dontlog%true%" or rlike(lower(commandline),"(hklm|hkey_local_machine).*?software.*?microsoft.*?iis.*?httplogging.*?logextfileflags.*?0"))  | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and ( lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%"  or lower(commandline) like "%appcmd%set%config%section%httplogging%dontlog%true%" or rlike(lower(commandline),"(hklm|hkey_local_machine).*?software.*?microsoft.*?iis.*?httplogging.*?logextfileflags.*?0")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (commandline like '%mkdir%temp%dir%/b%/s%.docx%findstr%/e%.docx%for%/R%in%copy%/Y%temp%' or commandline like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or commandline like '%Get-Service%env:TEMP%Get-ChildItem%env:%Get-Process%env:TEMP%' or commandline like '%sc%query%type=service%TEMP%doskey%/history%TEMP%wmic%process%list%TEMP%tree%') or (scriptblocktext like '%mkdir%temp%dir%/b%/s%.docx%findstr%/e%.docx%for%/R%in%copy%/Y%temp%' or scriptblocktext like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or scriptblocktext like '%Get-Service%env:TEMP%Get-ChildItem%env:%Get-Process%env:TEMP%' or scriptblocktext like '%sc%query%type=service%TEMP%doskey%/history%TEMP%wmic%process%list%TEMP%tree%') | groupby system, user

stream=win-audit where (commandline like '%mkdir%temp%dir%/b%/s%.docx%findstr%/e%.docx%for%/R%in%copy%/Y%temp%' or commandline like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or commandline like '%Get-Service%env:TEMP%Get-ChildItem%env:%Get-Process%env:TEMP%' or commandline like '%sc%query%type=service%TEMP%doskey%/history%TEMP%wmic%process%list%TEMP%tree%') or (scriptblocktext like '%mkdir%temp%dir%/b%/s%.docx%findstr%/e%.docx%for%/R%in%copy%/Y%temp%' or scriptblocktext like '%New-Item%-Path%env:TEMP%-ItemType Directory%-Force%Get-ChildItem%-Include%doc%destination%env:TEMP%' or scriptblocktext like '%Get-Service%env:TEMP%Get-ChildItem%env:%Get-Process%env:TEMP%' or scriptblocktext like '%sc%query%type=service%TEMP%doskey%/history%TEMP%wmic%process%list%TEMP%tree%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%mkdir%temp%dir%/b%/s%.docx%findstr%/e%.docx%for%/r%in%copy%/y%temp%' or lower(commandline) like '%new-item%-path%env:temp%-itemtype directory%-force%get-childitem%-include%doc%destination%env:temp%' or lower(commandline) like '%get-service%env:temp%get-childitem%env:%get-process%env:temp%' or lower(commandline) like '%sc%query%type=service%temp%doskey%/history%temp%wmic%process%list%temp%tree%') | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%mkdir%temp%dir%/b%/s%.docx%findstr%/e%.docx%for%/r%in%copy%/y%temp%' or lower(commandline) like '%new-item%-path%env:temp%-itemtype directory%-force%get-childitem%-include%doc%destination%env:temp%' or lower(commandline) like '%get-service%env:temp%get-childitem%env:%get-process%env:temp%' or lower(commandline) like '%sc%query%type=service%temp%doskey%/history%temp%wmic%process%list%temp%tree%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'wevtutil.*?(epl|export-log).*?c:.*?(q|sq|lf|ow):.*?system.*?eventid=4776') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'wevtutil.*?(epl|export-log).*?c:.*?(q|sq|lf|ow):.*?system.*?eventid=4776') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-FILE where action="FILE_CREATED" and rlike(lower(targetfilename),"\\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") and targetfilename="{SuspectObject}" and user="{SuspectUser}" and system="{TargetHost}" | duraton 6m

stream=EP-FILE where action="FILE_CREATED" and rlike(lower(targetfilename),"\\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") | groupby substring_index(targetfilename,"\\",-1), targetfilename, user, system | select substring_index(targetfilename,"\\",-1) as file, targetfilename, user, system | duration 1d

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|sid\\:\\:patch|sid\\:\\:lookup|kerberos\\:\\:golden|kerberos\\:\\:tgt|sekurlsa::logonpasswords|token::whoami)")  | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|sid\\:\\:patch|sid\\:\\:lookup|kerberos\\:\\:golden|kerberos\\:\\:tgt|sekurlsa::logonpasswords|token::whoami)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%msbuild.exe%.csproj%' or commandline like '%msbuild.exe%.xml%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%msbuild.exe%proj%' or commandline like '%msbuild.exe%.xml%') | groupby system, user, commandline

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%msbuild.exe%proj%' or commandline like '%msbuild.exe%.xml%' or commandline like '%msbuild.exe%.dll%' or commandline like '%msbuild.exe%.rsp%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%msbuild.exe%proj%' or commandline like '%msbuild.exe%.xml%' or commandline like '%msbuild.exe%.dll%' or commandline like '%msbuild.exe%.rsp%') | groupby system, user, commandline

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%mkdir%dir%/b%/s%.docx%findstr%/e%.docx%for%/r%in%copy%/y%' or lower(commandline) like '%new-item%-path%-itemtype directory%-force%get-childitem%-include%doc%destination%' or lower(commandline) like '%get-service%get-childitem%env:%get-process%' or lower(commandline) like '%sc%query%type=service%doskey%/history%wmic%process%list%tree%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%mkdir%dir%/b%/s%.docx%findstr%/e%.docx%for%/r%in%copy%/y%' or lower(commandline) like '%new-item%-path%-itemtype directory%-force%get-childitem%-include%doc%destination%' or lower(commandline) like '%get-service%get-childitem%env:%get-process%' or lower(commandline) like '%sc%query%type=service%doskey%/history%wmic%process%list%tree%') | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32%/s%/u%/i%.sct%.dll%') | groupby user, system , logevent

stream=ep-process where action='PROCESS_ADDED'and (lower(commandline) like '%regsvr32%/s%/u%/i%.sct%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'wevtutil.*?(epl|export-log).*?c:.*?(q|sq|lf|ow):.*?system.*?eventid=4776') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'wevtutil.*?(epl|export-log).*?c:.*?(q|sq|lf|ow):.*?system.*?eventid=4776') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (lower(commandline) like '%get-itemproperty%system%currentcontrolset%control%lsa%-name%select-object -expandproperty%set-itemproperty%-path%-name%-value' or lower(commandline) like '%get-itemproperty%system%currentcontrolset%control%lsa%osconfig%-name%select-object -expandproperty%set-itemproperty%-path%-name%-value') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (lower(commandline) like '%get-itemproperty%system%currentcontrolset%control%lsa%-name%select-object -expandproperty%set-itemproperty%-path%-name%-value' or lower(commandline) like '%get-itemproperty%system%currentcontrolset%control%lsa%osconfig%-name%select-object -expandproperty%set-itemproperty%-path%-name%-value') | groupby system, user

stream=win-audit where (lower(commandline) like '%get-itemproperty%system%currentcontrolset%control%lsa%security packages%select-object -expandproperty%set-itemproperty%-path%-name%-value' or lower(commandline) like '%get-itemproperty%system%currentcontrolset%control%lsa%osconfig%security packages%select-object -expandproperty%set-itemproperty%-path%-name%-value') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (lower(commandline) like '%get-itemproperty%system%currentcontrolset%control%lsa%security packages%select-object -expandproperty%set-itemproperty%-path%-name%-value' or lower(commandline) like '%get-itemproperty%system%currentcontrolset%control%lsa%osconfig%security packages%select-object -expandproperty%set-itemproperty%-path%-name%-value') | groupby system, user

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(newprocessname), ".(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") | groupby NewProcessName, substring_index(NewProcessName,"\\",-1), user, system | select newprocessname, substring_index(NewProcessName,"\\",-1) as processname, user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(newprocessname), ".(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") and newprocessname="{SuspectObject}" and user="{SuspectUser}" and system="{TargetHost}" | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(newprocessname), ".(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") and newprocessname="{SuspectObject}" and user="{SuspectUser}" and system="{TargetHost}" | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(newprocessname), ".(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") | groupby NewProcessName, substring_index(NewProcessName,"\\",-1), user, system | select newprocessname, substring_index(NewProcessName,"\\",-1) as processname, user, system

stream=ep-process where action="PROCESS_ADDED" and (rlike(lower(commandline), "curl.exe'.*-k.*-(F|T|d).*?https://") or rlike(lower(commandline), "curl.exe'.*-k.*(--data|--data-|--form|--upload-file)")) | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (rlike(lower(commandline), "curl.exe'.*-k.*-(F|T|d).*?https://") or rlike(lower(commandline), "curl.exe'.*-k.*(--data|--data-|--form|--upload-file)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%Start-BitsTransfer%Priority%foreground%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and commandline like '%Start-BitsTransfer%Priority%foreground%' | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%mkdir%dir%/b%/s%.docx%findstr%/e%.docx%for%/r%in%copy%/y%' or lower(commandline) like '%new-item%-path%-itemtype directory%-force%get-childitem%-include%doc%destination%' or lower(commandline) like '%get-service%get-childitem%env:%get-process%' or lower(commandline) like '%sc%query%type=service%doskey%/history%wmic%process%list%tree%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%mkdir%dir%/b%/s%.docx%findstr%/e%.docx%for%/r%in%copy%/y%' or lower(commandline) like '%new-item%-path%-itemtype directory%-force%get-childitem%-include%doc%destination%' or lower(commandline) like '%get-service%get-childitem%env:%get-process%' or lower(commandline) like '%sc%query%type=service%doskey%/history%wmic%process%list%tree%') | groupby system, user

stream=win-audit where (lower(commandline) like '%mkdir%dir%/b%/s%.docx%findstr%/e%.docx%for%/r%in%copy%/y%' or lower(commandline) like '%new-item%-path%-itemtype directory%-force%get-childitem%-include%doc%destination%' or lower(commandline) like '%get-service%get-childitem%env:%get-process%' or lower(commandline) like '%sc%query%type=service%doskey%/history%wmic%process%list%tree%') or (lower(scriptblocktext) like '%mkdir%dir%/b%/s%.docx%findstr%/e%.docx%for%/r%in%copy%/y%' or lower(scriptblocktext) like '%new-item%-path%-itemtype directory%-force%get-childitem%-include%doc%destination%' or lower(scriptblocktext) like '%get-service%get-childitem%env:%get-process%' or lower(scriptblocktext) like '%sc%query%type=service%doskey%/history%wmic%process%list%tree%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where (lower(commandline) like '%mkdir%dir%/b%/s%.docx%findstr%/e%.docx%for%/r%in%copy%/y%' or lower(commandline) like '%new-item%-path%-itemtype directory%-force%get-childitem%-include%doc%destination%' or lower(commandline) like '%get-service%get-childitem%env:%get-process%' or lower(commandline) like '%sc%query%type=service%doskey%/history%wmic%process%list%tree%') or (lower(scriptblocktext) like '%mkdir%dir%/b%/s%.docx%findstr%/e%.docx%for%/r%in%copy%/y%' or lower(scriptblocktext) like '%new-item%-path%-itemtype directory%-force%get-childitem%-include%doc%destination%' or lower(scriptblocktext) like '%get-service%get-childitem%env:%get-process%' or lower(scriptblocktext) like '%sc%query%type=service%doskey%/history%wmic%process%list%tree%') | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32%/s%/u%/i%.sct%.dll%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED'and (lower(commandline) like '%regsvr32%/s%/u%/i%.sct%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%Security Packages%' or commandline like '%Get-ItemProperty%System%CurrentControlSet%Control%Lsa%OSConfig%Security Packages%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%get-itemproperty%system%currentcontrolset%control%lsa%security packages%select-object -expandproperty%set-itemproperty%-path%-name%-value' or lower(commandline) like '%get-itemproperty%system%currentcontrolset%control%lsa%osconfig%security packages%select-object -expandproperty%set-itemproperty%-path%-name%-value%') | groupby system, user | groupby system, user | duration 2M

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%get-itemproperty%system%currentcontrolset%control%lsa%security packages%select-object -expandproperty%set-itemproperty%-path%-name%-value' or lower(commandline) like '%get-itemproperty%system%currentcontrolset%control%lsa%osconfig%security packages%select-object -expandproperty%set-itemproperty%-path%-name%-value%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%get-itemproperty%system%currentcontrolset%control%lsa%security packages%select-object -expandproperty%set-itemproperty%-path%-name%-value' or lower(commandline) like '%get-itemproperty%system%currentcontrolset%control%lsa%osconfig%security packages%select-object -expandproperty%set-itemproperty%-path%-name%-value%') | groupby system, user | groupby system, user | duration 2M

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe%' and (lower(commandline) like '%start-bitstransfer%priority%foreground%') | groupby system, user

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe%' and (lower(commandline) like '%start-bitstransfer%priority%foreground%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") | groupby user, system | duration 1d

stream=EP-PROCESS where action="PROCESS_ADDED"  and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%nltest.exe%' and rlike(lower(commandline), "nltest.*?(domain_trusts|trusted_domains|dclist:|dcname:|dsget|lsaqueryfti:|parentdomain|bdc_query:)") | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%nltest.exe%' and rlike(lower(commandline), "nltest.*?(domain_trusts|trusted_domains|dclist:|dcname:|dsget|lsaqueryfti:|parentdomain|bdc_query:)")  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") | groupby user, system, commandline 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") and user="{SuspectUser}" and system="{TargetHost}" | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'system.*?currentcontrolset.*?services.*?w32time.*?timeproviders.*?(reg_z.*?\\.*?\.|reg_dword.*?enabled|reg_dword\s+.*?inputprovider)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'system.*?currentcontrolset.*?services.*?w32time.*?timeproviders.*?(reg_z.*?\\.*?\.|reg_dword.*?enabled|reg_dword\s+.*?inputprovider)') | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline), "(runas|whoami.*?all|powershell.*get\-token|powershell.*invoke\-tokenmanipulation|mimikatz.*sekurlsa::logonpasswords|mimikatz.*token::elevate|mimikatz.*privilege::debug|set\-executionpolicy.*scope.*force|createprocessfromparent.*?get\-process.*?lsass)") | groupby user, system, commandline

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline), "(runas|whoami.*?all|powershell.*get\-token|powershell.*invoke\-tokenmanipulation|mimikatz.*sekurlsa::logonpasswords|mimikatz.*token::elevate|mimikatz.*privilege::debug|set\-executionpolicy.*scope.*force|createprocessfromparent.*?get\-process.*?lsass)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline), "(runas|whoami.*?all|powershell.*get\-token|powershell.*invoke\-tokenmanipulation|mimikatz.*sekurlsa::logonpasswords|mimikatz.*token::elevate|mimikatz.*privilege::debug|set\-executionpolicy.*scope.*force|createprocessfromparent.*?get\-process.*?lsass)") | groupby user, system, commandline

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline), "(runas|whoami.*?all|powershell.*get\-token|powershell.*invoke\-tokenmanipulation|mimikatz.*sekurlsa::logonpasswords|mimikatz.*token::elevate|mimikatz.*privilege::debug|set\-executionpolicy.*scope.*force|createprocessfromparent.*?get\-process.*?lsass)") and system="{TargetHost}" and user="{SuspectUser}" | duration 6m

stream=win-audit where action='PROCESS_CREATED' and  (rlike(lower(commandline), 'system.*?currentcontrolset.*?control.*?lsa.*?reg_multi_sz.*?\\.*?\.') or rlike(lower(commandline), 'windir.*?system32.*?pnputil.exe')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and  (rlike(lower(commandline), 'system.*?currentcontrolset.*?control.*?lsa.*?reg_multi_sz.*?\\.*?\.') or rlike(lower(commandline), 'windir.*?system32.*?pnputil.exe')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where (action='PROCESS_CREATED' or action='OBJECT_ACCESSED') and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%' or scriptblocktext like '%Get-Date%') | groupby user, system

stream=win-audit where (action='PROCESS_CREATED' or action='OBJECT_ACCESSED') and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%' or scriptblocktext like '%Get-Date%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "cmdkey.*?(list|delete|add)") and user='{SuspectUser}' and system='{TragetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "cmdkey.*?(list|delete|add|pass)") | groupby user, system 

stream=win-audit where (lower(commandline) like '%get-itemproperty%system%currentcontrolset%control%lsa%security packages%select-object -expandproperty%set-itemproperty%-path%-name%-value' or lower(commandline) like '%get-itemproperty%system%currentcontrolset%control%lsa%osconfig%security packages%select-object -expandproperty%set-itemproperty%-path%-name%-value%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (lower(commandline) like '%get-itemproperty%system%currentcontrolset%control%lsa%security packages%select-object -expandproperty%set-itemproperty%-path%-name%-value' or lower(commandline) like '%get-itemproperty%system%currentcontrolset%control%lsa%osconfig%security packages%select-object -expandproperty%set-itemproperty%-path%-name%-value%') | groupby system, user |  duration 3M

stream=ep-process where action='PROCESS_ADDED' and  ((rlike(lower(image), "(tasklist.exe|wmic.exe|powershell.exe|query.exe|netstat.exe|cmd.exe)")) and (rlike(lower(commandline), "(tasklist|get-process|Win32_Process|process|get-wmiobject)"))) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and  ((rlike(lower(image), "(tasklist.exe|wmic.exe|powershell.exe|query.exe|netstat.exe|cmd.exe)")) and (rlike(lower(commandline), "(tasklist|get-process|Win32_Process|process|get-wmiobject)"))) | groupby user, system | duration 1h

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'system.*?currentcontrolset.*?services.*?w32time.*?timeproviders.*?(reg_z.*?\\.*?\.|reg_dword.*?enabled|reg_dword\s+.*?inputprovider)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'system.*?currentcontrolset.*?services.*?w32time.*?timeproviders.*?(reg_z.*?\\.*?\.|reg_dword.*?enabled|reg_dword\s+.*?inputprovider)') | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline), "(runas|whoami.*?all|powershell.*get\-token|powershell.*invoke\-tokenmanipulation|mimikatz.*sekurlsa::logonpasswords|mimikatz.*token::elevate|mimikatz.*privilege::debug|set\-executionpolicy.*scope.*force|createprocessfromparent.*?get\-process.*?lsass)") | groupby user, system, commandline

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline), "(runas|whoami.*?all|powershell.*get\-token|powershell.*invoke\-tokenmanipulation|mimikatz.*sekurlsa::logonpasswords|mimikatz.*token::elevate|mimikatz.*privilege::debug|set\-executionpolicy.*scope.*force|createprocessfromparent.*?get\-process.*?lsass)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(powershell|cmd).*(copy|copy-item|move-item).*(c\\$|d\\$|admin\\$|a\\$|ipc\\$|print\\$)') | groupby system, user 

stream=win-audit where action='PROCESS_CREATED'  and rlike(lower(commandline), '(powershell|cmd).*(copy|copy-item|move-item).*(c\\$|d\\$|admin\\$|a\\$|ipc\\$|print\\$)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(image), "hashcate.exe") and rlike(lower(commandline), "-a.*-m.*-r") or rlike(lower(commandline), "hashcat.*-a.*-m.*-r")) | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(image), "hashcate.exe") and rlike(lower(commandline), "-a.*-m.*-r") or rlike(lower(commandline), "hashcat.*-a.*-m.*-r")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), 'system.*?currentcontrolset.*?control.*?lsa.*?reg_multi_sz.*?\\.*?\.') or rlike(lower(commandline), 'windir.*?system32.*?pnputil.exe'))

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), 'system.*?currentcontrolset.*?control.*?lsa.*?reg_multi_sz.*?\\.*?\.') or rlike(lower(commandline), 'windir.*?system32.*?pnputil.exe')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (lower(commandline) like '%start-bitstransfer%priority%foreground%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and newprocessname like '%powershell.exe%' and (lower(commandline) like '%start-bitstransfer%priority%foreground%') | groupby system, user

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline), 'bitsadmin\..*?transfer.*?download.*?priority.*?foreground') or rlike(lower(commandline), 'bitsadmin\..*?(addfile|create|setnotifycmdline|resume|complete|ping -n)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline), 'bitsadmin\..*?transfer.*?download.*?priority.*?foreground') or rlike(lower(commandline), 'bitsadmin\..*?(addfile|create|setnotifycmdline|resume|complete|ping -n)')) | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and  ((rlike(lower(image), "(tasklist.exe|wmic.exe|powershell.exe|query.exe|netstat.exe|cmd.exe)")) and (rlike(lower(commandline), "(tasklist|get-process|Win32_Process|process|get-wmiobject)"))) | groupby user, system | duration 1h

stream=ep-process where action='PROCESS_ADDED' and  ((rlike(lower(image), "(tasklist.exe|wmic.exe|powershell.exe|query.exe|netstat.exe|cmd.exe)")) and (rlike(lower(commandline), "(tasklist|get-process|Win32_Process|process|get-wmiobject)"))) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%mpcmdrun%-removedefinitions%" or rlike(lower(commandline),"(del|remove).*?programdata.*?microsoft.*?windows.*?defender.*?defination.*?update")) | groupby user, system, commandline 

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%mpcmdrun%-removedefinitions%" or rlike(lower(commandline),"(del|remove).*?programdata.*?microsoft.*?windows.*?defender.*?defination.*?update")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (lower(commandline) like '%radmin%viewer%radmin.exe%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and eid='4688' (lower(commandline) like '%radmin%viewer%radmin.exe%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED'  and rlike(lower(commandline), '(powershell|cmd).*(copy|copy-item|move-item).*(c\\$|d\\$|admin\\$|a\\$|ipc\\$|print\\$)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(powershell|cmd).*(copy|copy-item|move-item).*(c\\$|d\\$|admin\\$|a\\$|ipc\\$|print\\$)') | groupby system, user 

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(image), "hashcate.exe") and rlike(lower(commandline), "-a.*-m.*-r") or rlike(lower(commandline), "hashcat.*-a.*-m.*-r")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(image), "hashcate.exe") and rlike(lower(commandline), "-a.*-m.*-r") or rlike(lower(commandline), "hashcat.*-a.*-m.*-r")) | groupby user, system

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' and (rlike(lower(commandline), 'system.*?currentcontrolset.*?control.*?lsa.*?reg_multi_sz.*?\\.*?\.') or rlike(lower(commandline), 'windir.*?system32.*?pnputil.exe')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' (rlike(lower(commandline), 'system.*?currentcontrolset.*?control.*?lsa.*?reg_multi_sz.*?\\.*?\.') or rlike(lower(commandline), 'windir.*?system32.*?pnputil.exe')) | groupby system, user

stream=win-audit where (action='PROCESS_CREATED' or action='OBJECT_ACCESSED') and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%' or scriptblocktext like '%Get-Date%') | groupby user, system

stream=win-audit where (action='PROCESS_CREATED' or action='OBJECT_ACCESSED') and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%' or scriptblocktext like '%Get-Date%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

 stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(image) like '%certutil.exe%' and rlike(lower(commandline), "certutil.*?(-rename.*-decode|-decode.*-f:|decodehex|encodehex|exportpfx|-encode|urlcache|-decode)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(image) like '%certutil.exe%' and rlike(lower(commandline), "certutil.*?(-rename.*-decode|-decode.*-f:|decodehex|encodehex|exportpfx|-encode|urlcache|-decode)")) 

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(image) like '%certutil.exe%' and rlike(lower(commandline), "certutil.*?(-rename.*-decode|-decode.*-f:|decodehex|encodehex|exportpfx|-encode|urlcache|-decode)")) | groupby user, system

 stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(image) like '%certutil.exe%' and rlike(lower(commandline), "certutil.*?(-rename.*-decode|-decode.*-f:|decodehex|encodehex|exportpfx|-encode|urlcache|-decode)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED'and (lower(commandline) like '%regsvr32%/s%/u%/i%.sct%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32%/s%/u%/i%.sct%.dll%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%regsvr32%/s%/u%/i%.sct%.dll%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED'and (lower(commandline) like '%regsvr32%/s%/u%/i%.sct%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and eid='1' and (lower(commandline) like '%radmin%viewer%radmin.exe%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and eid='1' and (lower(commandline) like '%radmin%viewer%radmin.exe%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (rlike(lower(commandline), "curl.exe'.*-k.*-(F|T|d).*?https://") or rlike(lower(commandline), "curl.exe'.*-k.*(--data|--data-|--form|--upload-file)")) | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (rlike(lower(commandline), "curl.exe'.*-k.*-(F|T|d).*?https://") or rlike(lower(commandline), "curl.exe'.*-k.*(--data|--data-|--form|--upload-file)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") | groupby user, system, commandline 


stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") and user="{SuspectUser}" and system="{TargetHost}" | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'system.*?currentcontrolset.*?services.*?w32time.*?timeproviders.*?(reg_z.*?\\.*?\.|reg_dword.*?enabled|reg_dword\s+.*?inputprovider)') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'system.*?currentcontrolset.*?services.*?w32time.*?timeproviders.*?(reg_z.*?\\.*?\.|reg_dword.*?enabled|reg_dword\s+.*?inputprovider)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline), "(runas|wmic.*process.*?call.*?create|whoami.*?all|powershell.*get\-token|powershell.*invoke\-tokenmanipulation|mimikatz.*sekurlsa::logonpasswords|mimikatz.*token::elevate|mimikatz.*privilege::debug|set\-executionpolicy.*scope.*force|createprocessfromparent.*?get\-process.*?lsass)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline), "(runas|wmic.*process.*?call.*?create|whoami.*?all|powershell.*get\-token|powershell.*invoke\-tokenmanipulation|mimikatz.*sekurlsa::logonpasswords|mimikatz.*token::elevate|mimikatz.*privilege::debug|set\-executionpolicy.*scope.*force|createprocessfromparent.*?get\-process.*?lsass)") | groupby user, system, commandline

stream=firewall where action="PACKET_BLOCKED" and  srctype="PRIVATE" and  dsttype="PUBLIC" |  groupby srcip

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(image), "hashcate.exe") and rlike(lower(commandline), "-a.*-m.*-r") or rlike(lower(commandline), "hashcat.*-a.*-m.*-r")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(image), "hashcate.exe") and rlike(lower(commandline), "-a.*-m.*-r") or rlike(lower(commandline), "hashcat.*-a.*-m.*-r")) | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%') | groupby user, system

 stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(image) like '%certutil.exe%' and rlike(lower(commandline), "certutil.*?(-rename.*-decode|-decode.*-f:|decodehex|encodehex|exportpfx|-encode|urlcache|-decode)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(image) like '%certutil.exe%' and rlike(lower(commandline), "certutil.*?(-rename.*-decode|-decode.*-f:|decodehex|encodehex|exportpfx|-encode|urlcache|-decode)")) | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(image) like '%certutil.exe%' and rlike(lower(commandline), "certutil.*?(-rename.*-decode|-decode.*-f:|decodehex|encodehex|exportpfx|-encode|urlcache|-decode)")) 

 stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(image) like '%certutil.exe%' and rlike(lower(commandline), "certutil.*?(-rename.*-decode|-decode.*-f:|decodehex|encodehex|exportpfx|-encode|urlcache|-decode)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),"(net.*?user|wmic.*?useraccount.*?get|powershell.*?(get-localuser|get-localgroupmember|get-wmiobject.*?-class.*?win32_useraccount|get-aduser)|lusrmgr|query.*?user|net.*?localgroup.*?administrators|net.*?group.*?administrators|net.*?group|net.*?accounts|net.*?localgroup|net.*?view|dsquery.*?user|dsget.*?user|reg.*?query.*?profilelist)") | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),"(net.*?user|wmic.*?useraccount.*?get|powershell.*?(get-localuser|get-localgroupmember|get-wmiobject.*?-class.*?win32_useraccount|get-aduser)|lusrmgr|query.*?user|net.*?localgroup.*?administrators|net.*?group.*?administrators|net.*?group|net.*?accounts|net.*?localgroup|net.*?view|dsquery.*?user|dsget.*?user|reg.*?query.*?profilelist)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%get-adcomputer%-properties *%' or rlike(lower(commandline), 'get-adcomputer.*?-properties.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)') or lower(commandline) like '%get-adcomputer%-searchscope%subtree%-filter%name%-like %*%-properties *%' or rlike(lower(commandline), 'adfind.*?-h.*?-s subtree -f.*?objectclass=computer.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime|\*)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%get-adcomputer%-properties *%' or rlike(lower(commandline), 'get-adcomputer.*?-properties.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)') or lower(commandline) like '%get-adcomputer%-searchscope%subtree%-filter%name%-like %*%-properties *%' or rlike(lower(commandline), 'adfind.*?-h.*?-s subtree -f.*?objectclass=computer.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime|\*)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%get-adcomputer%-properties *%' or rlike(lower(commandline),'get-adcomputer.*?-properties.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)') or lower(commandline) like '%get-adcomputer%-searchscope%subtree%-filter%name%-like %*%-properties *%' or rlike(lower(commandline),'adfind.*?-h.*?-s subtree -f.*?objectclass=computer.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)'))  | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%get-adcomputer%-properties *%' or rlike(lower(commandline),'get-adcomputer.*?-properties.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)') or lower(commandline) like '%get-adcomputer%-searchscope%subtree%-filter%name%-like %*%-properties *%' or rlike(lower(commandline),'adfind.*?-h.*?-s subtree -f.*?objectclass=computer.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and  ((rlike(lower(image), "(tasklist.exe|wmic.exe|powershell.exe|query.exe|netstat.exe|cmd.exe)")) and (rlike(lower(commandline), "(tasklist|get-process|Win32_Process|process|get-wmiobject)"))) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and  ((rlike(lower(image), "(tasklist.exe|wmic.exe|powershell.exe|query.exe|netstat.exe|cmd.exe)")) and (rlike(lower(commandline), "(tasklist|get-process|Win32_Process|process|get-wmiobject)"))) | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%get-adcomputer%-properties *%' or rlike(lower(commandline),'get-adcomputer.*?-properties.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)') or lower(commandline) like '%get-adcomputer%-searchscope%subtree%-filter%name%-like %*%-properties *%' or rlike(lower(commandline),'adfind.*?-h.*?-s subtree -f.*?objectclass=computer.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)')) | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%get-adcomputer%-properties *%' or rlike(lower(commandline),'get-adcomputer.*?-properties.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)') or lower(commandline) like '%get-adcomputer%-searchscope%subtree%-filter%name%-like %*%-properties *%' or rlike(lower(commandline),'adfind.*?-h.*?-s subtree -f.*?objectclass=computer.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),"(net.*?user|wmic.*?useraccount.*?get|powershell.*?(get-localuser|get-localgroupmember|get-wmiobject.*?-class.*?win32_useraccount|get-aduser)|lusrmgr|query.*?user|net.*?localgroup.*?administrators|net.*?group.*?administrators|net.*?group|net.*?accounts|net.*?localgroup|net.*?view|dsquery.*?user|dsget.*?user|reg.*?query.*?profilelist)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),"(net.*?user|wmic.*?useraccount.*?get|powershell.*?(get-localuser|get-localgroupmember|get-wmiobject.*?-class.*?win32_useraccount|get-aduser)|lusrmgr|query.*?user|net.*?localgroup.*?administrators|net.*?group.*?administrators|net.*?group|net.*?accounts|net.*?localgroup|net.*?view|dsquery.*?user|dsget.*?user|reg.*?query.*?profilelist)") | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline) like 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline)like 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline)like 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline) like 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline)like 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline)like 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') | groupby user, system and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),"(net.*?user|wmic.*?useraccount.*?get|powershell.*?(get-localuser|get-localgroupmember|get-wmiobject.*?-class.*?win32_useraccount|get-aduser)|lusrmgr|query.*?user|net.*?localgroup.*?administrators|net.*?group.*?administrators|net.*?group|net.*?accounts|net.*?localgroup|net.*?view|dsquery.*?user|dsget.*?user|reg.*?query.*?profilelist)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),"(net.*?user|wmic.*?useraccount.*?get|powershell.*?(get-localuser|get-localgroupmember|get-wmiobject.*?-class.*?win32_useraccount|get-aduser)|lusrmgr|query.*?user|net.*?localgroup.*?administrators|net.*?group.*?administrators|net.*?group|net.*?accounts|net.*?localgroup|net.*?view|dsquery.*?user|dsget.*?user|reg.*?query.*?profilelist)") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%net user%guest%/active:yes%'and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%net user%guest%/active:yes%' | groupby user, system


stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') | groupby user, system and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'software.*?microsoft.*?active setup.*?installed component') and rlike(lower(commandline), '(run|runonce|runonce.exe|\..*?AlternateShellStartup)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'software.*?microsoft.*?active setup.*?installed component') and rlike(lower(commandline), '(run|runonce|runonce.exe|\..*?AlternateShellStartup)') | groupby user, system

stream=win-audit where (action='PROCESS_CREATED' or action='OBJECT_ACCESSED') and (lower(scriptblocktext) like '%ppid-spoof%-ppid%') or (lower(commandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%') or (lower(commandline) like '%import-module%createprocessfromparent%') or (lower(commandline) like '%ImpersonateFromParentPid -ppid%') | groupby user, system

stream=win-audit where (action='PROCESS_CREATED' or action='OBJECT_ACCESSED') and (lower(scriptblocktext) like '%ppid-spoof%-ppid%') or (lower(commandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%') or (lower(commandline) like '%import-module%createprocessfromparent%') or (lower(commandline) like '%ImpersonateFromParentPid -ppid%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m


stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') | groupby user, system and user='{SuspectUser}' and system='{TargetHost}' | duration 6m


stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m


stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') | groupby user, system

stream=configuration where action='CONFIGURATION_CHANGED' and (lower(commandline) like '%start-athprocessunderspecificparent%') or lower(commandline) like '%start-athprocessunderspecificparent%') or (lower(commandline) like '%start-process%start-athprocessunderspecificparent%') or (lower(commandline) like '%get-process -name%start-athprocessunderspecificparent%') | groupby system

stream=configuration where action='CONFIGURATION_CHANGED' and (lower(commandline) like '%start-athprocessunderspecificparent%') or lower(commandline) like '%start-athprocessunderspecificparent%') or (lower(commandline) like '%start-process%start-athprocessunderspecificparent%') or (lower(commandline) like '%get-process -name%start-athprocessunderspecificparent%') and system='{TargetHost}' | duration 6m

stream=win-audit where (action='PROCESS_CREATED' or action='OBJECT_ACCESSED') and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%' or scriptblocktext like '%Get-Date%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (action='PROCESS_CREATED' or action='OBJECT_ACCESSED') and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%' or scriptblocktext like '%Get-Date%') | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%Get-Date%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and scriptblocktext like '%Get-Date%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%' or lower(commandline) like '%import-module%createprocessfromparent%') or lower(commandline) like '%ImpersonateFromParentPid -ppid%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%' or lower(commandline) like '%import-module%createprocessfromparent%') or lower(commandline) like '%ImpersonateFromParentPid -ppid%') | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (lower(scriptblocktext) like '%ppid-spoof%-ppid%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and (lower(scriptblocktext) like '%ppid-spoof%-ppid%') | groupby user, system

stream=configuration where action='CONFIGURATION_CHANGED' and lower(commandline) like '%get-ciminstance%name = %svchost.exe%start-athprocessunderspecificparent%' | groupby system

stream=configuration where action='CONFIGURATION_CHANGED' and lower(commandline) like '%get-ciminstance%name = %svchost.exe%start-athprocessunderspecificparent%' and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and (lower(commandline) like '%start-athprocessunderspecificparent%' or lower(commandline) like '%start-process%start-athprocessunderspecificparent%') or lower(commandline) like '%get-process -name%start-athprocessunderspecificparent%') and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and (lower(commandline) like '%start-athprocessunderspecificparent%' or lower(commandline) like '%start-process%start-athprocessunderspecificparent%') or lower(commandline) like '%get-process -name%start-athprocessunderspecificparent%') | groupby system

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%convertto-securestring%new-object%get-aduser%-properties%remove-adgroupmember%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%convertto-securestring%new-object%get-aduser%-properties%remove-adgroupmember%') | groupby user, system

stream=*  where logevent like '%Category\":\"Thread\%' | duration 1m | limit 100

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adsisearcher.*?(objectclass=user|objectcategory=user|objectclass=computer|objectcategory=computer).*?(findall|findone)') or lower(commandline) like '%adsisearcher%objectcategory=organizationalunit%findall%path%' or lower(commandline) like '%adsisearcher%searchroot%path%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adsisearcher.*?(objectclass=user|objectcategory=user|objectclass=computer|objectcategory=computer).*?(findall|findone)') or lower(commandline) like '%adsisearcher%objectcategory=organizationalunit%findall%path%' or lower(commandline) like '%adsisearcher%searchroot%path%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(powershell|cmd).*(copy|copy-item|move-item).*(c\\$|d\\$|admin\\$|a\\$|ipc\\$|print\\$)') | groupby system, user 

stream=win-audit where action='PROCESS_CREATED'  and rlike(lower(commandline), '(powershell|cmd).*(copy|copy-item|move-item).*(c\\$|d\\$|admin\\$|a\\$|ipc\\$|print\\$)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%') | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (lower(scriptblocktext) like '%ppid-spoof%-ppid%') | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (lower(scriptblocktext) like '%ppid-spoof%-ppid%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%get-ciminstance%name = %svchost.exe%start-athprocessunderspecificparent%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%get-ciminstance%name = %svchost.exe%start-athprocessunderspecificparent%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%get-ciminstance%name = %svchost.exe%start-athprocessunderspecificparent%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%get-ciminstance%name = %svchost.exe%start-athprocessunderspecificparent%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%get-ciminstance%name = %svchost.exe%start-athprocessunderspecificparent%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and  ((rlike(lower(image), "(tasklist.exe|wmic.exe|powershell.exe|query.exe|netstat.exe|cmd.exe)")) and (rlike(lower(commandline), "(tasklist|get-process|Win32_Process|process|get-wmiobject)"))) | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and  ((rlike(lower(image), "(tasklist.exe|wmic.exe|powershell.exe|query.exe|netstat.exe|cmd.exe)")) and (rlike(lower(commandline), "(tasklist|get-process|Win32_Process|process|get-wmiobject)"))) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%c:%windows%system32%certutil%-p%-exportpfx%.pfx') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%c:%windows%system32%certutil%-p%-exportpfx%.pfx') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%-ep bypass%wget%import-module%createprocessfromparent%' or lower(commandline) like '%import-module%createprocessfromparent%') or lower(commandline) like '%impersonatefromparentpid -ppid%' or lower(commandline) like '%ppid-spoof%-ppid%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%' or lower(commandline) like '%import-module%createprocessfromparent%') or lower(commandline) like '%impersonatefromparentpid -ppid%' or lower(commandline) like '%ppid-spoof%-ppid%') | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (lower(scriptblocktext) like '%ppid-spoof%-ppid%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and (lower(scriptblocktext) like '%ppid-spoof%-ppid%') | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (lower(scriptblocktext) like '%ppid-spoof%-ppid%' or lower(scriptblocktext) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%' or lower(scriptblocktext) like '%import-module%createprocessfromparent%' or lower(scriptblocktext) like '%ImpersonateFromParentPid -ppid%') | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (lower(scriptblocktext) like '%ppid-spoof%-ppid%' or lower(scriptblocktext) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%' or lower(scriptblocktext) like '%import-module%createprocessfromparent%' or lower(scriptblocktext) like '%ImpersonateFromParentPid -ppid%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%attrib.exe%" and rlike(lower(commandline "attrib.*?(+h|+s|+c|+r|+a)"))) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%attrib.exe%" and rlike(lower(commandline "attrib.*?(+h|+s|+c|+r|+a)"))) | groupby user, system | duration 1h

stream=win-audit where action='OBJECT_ACCESSED' and (lower(scriptblocktext) like '%ppid-spoof%-ppid%' or lower(scriptblocktext) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%' or lower(scriptblocktext) like '%import-module%createprocessfromparent%' or lower(scriptblocktext) like '%impersonatefromparentpid -ppid%') | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (lower(scriptblocktext) like '%ppid-spoof%-ppid%' or lower(scriptblocktext) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%' or lower(scriptblocktext) like '%import-module%createprocessfromparent%' or lower(scriptblocktext) like '%impersonatefromparentpid -ppid%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=* | groupby @Opcode | limit 100

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%attrib.exe%" and rlike(lower(commandline), "attrib.*?(\\+h|\\+s|\\+c|\\+r|\\+a)")) | groupby user, system | duration1d

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%attrib.exe%" and rlike(lower(commandline), "attrib.*?(\+h|\+s|\+c|\+r|\+a)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 1d

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%attrib.exe%" and rlike(lower(commandline), "attrib.*?(\\+h|\\+s|\\+c|\\+r|\\+a)")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%attrib.exe%" and rlike(lower(commandline), "attrib.*?(\+h|\+s|\+c|\+r|\+a)")) and system='{TargetHost}' and user='{SuspectUser}' 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%' or lower(commandline) like '%import-module%createprocessfromparent%') or lower(commandline) like '%ImpersonateFromParentPid -ppid%' or lower(commandline) like '%ppid-spoof%-ppid%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%' or lower(commandline) like '%import-module%createprocessfromparent%') or lower(commandline) like '%ImpersonateFromParentPid -ppid%' or lower(commandline) like '%ppid-spoof%-ppid%') | groupby user, system

stream=configuration where action='CONFIGURATION_CHANGED' and lower(commandline) like '%get-ciminstance%name = %svchost.exe%start-athprocessunderspecificparent%' and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and lower(commandline) like '%get-ciminstance%name = %svchost.exe%start-athprocessunderspecificparent%' | groupby system

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%ppid-spoof%-ppid%' or lower(parentcommandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%ppid-spoof%-ppid%' or lower(parentcommandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%convertto-securestring%new-object%get-aduser%-properties%remove-adgroupmember%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%convertto-securestring%new-object%get-aduser%-properties%remove-adgroupmember%') | groupby user, system

stream=*  where logevent like '%Category\":\"Registry\%' | duration 1h | limit 100

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(image) like '%certutil.exe%' and rlike(lower(commandline), "certutil.*?(-rename.*-decode|-decode.*-f:|decodehex|encodehex|exportpfx|-encode|urlcache|-decode)")) | groupby user, system

 stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(image) like '%certutil.exe%' and rlike(lower(commandline), "certutil.*?(-rename.*-decode|-decode.*-f:|decodehex|encodehex|exportpfx|-encode|urlcache|-decode)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%') or (lower(commandline) like '%hklm%software%policies%microsoft%windows nt%dnsclient%')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%') or (lower(commandline) like '%hklm%software%policies%microsoft%windows nt%dnsclient%')) | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%') or (lower(commandline) like '%hklm%software%policies%microsoft%windows nt%dnsclient%')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%') or (lower(commandline) like '%hklm%software%policies%microsoft%windows nt%dnsclient%')) | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'system.*?currentcontrolset.*?services.*?w32time.*?timeproviders.*?(reg_z.*?\\.*?\.|reg_dword.*?enabled|reg_dword\s+.*?inputprovider)') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'system.*?currentcontrolset.*?services.*?w32time.*?timeproviders.*?(reg_z.*?\\.*?\.|reg_dword.*?enabled|reg_dword\s+.*?inputprovider)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-p%-exportpfx%.pfx') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%certutil%-p%-exportpfx%.pfx') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%convertto-securestring%-force%new-selfsignedcertificate%-dnsname%-certstorelocation%') or (lower(commandline) like 'get-childitem -path%export-pfxcertificate%-filepath%') | groupby user , system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%convertto-securestring%-force%new-selfsignedcertificate%-dnsname%-certstorelocation%') or (lower(commandline) like 'get-childitem -path%export-pfxcertificate%-filepath%') | groupby user , system and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline),'invoke-expression.*?(adrecon.ps1|adreconscript.ps1)') or rlike(lower(commandline),'(adrecon.ps1|adreconscript.ps1)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline),'invoke-expression.*?(adrecon.ps1|adreconscript.ps1)') or rlike(lower(commandline),'(adrecon.ps1|adreconscript.ps1)')) | groupby user, system

stream=configuration where action='CONFIGURATION_CHANGED' and lower(commandline) like '%get-ciminstance%name = %svchost.exe%start-athprocessunderspecificparent%' and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and lower(commandline) like '%get-ciminstance%name = %svchost.exe%start-athprocessunderspecificparent%' | groupby system, commandline

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%get-ciminstance%name = %svchost.exe%start-athprocessunderspecificparent%' | groupby user, system

stream=configuration where action='CONFIGURATION_CHANGED' and (lower(commandline) like '%start-athprocessunderspecificparent%' or lower(commandline) like '%start-process%start-athprocessunderspecificparent%') or lower(commandline) like '%get-process -name%start-athprocessunderspecificparent%') and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and (lower(commandline) like '%start-athprocessunderspecificparent%' or lower(commandline) like '%start-process%start-athprocessunderspecificparent%') or lower(commandline) like '%get-process -name%start-athprocessunderspecificparent%') | groupby system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%start-athprocessunderspecificparent%' or lower(commandline) like '%start-process%start-athprocessunderspecificparent%') or lower(commandline) like '%get-process -name%start-athprocessunderspecificparent%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%start-athprocessunderspecificparent%' or lower(commandline) like '%start-process%start-athprocessunderspecificparent%') or lower(commandline) like '%get-process -name%start-athprocessunderspecificparent%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%attrib.exe%" and rlike(lower(commandline), "attrib.*?(+h|+s|+c|+r|+a)")) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%attrib.exe%" and rlike(lower(commandline), "attrib.*?(+h|+s|+c|+r|+a)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%ppid-spoof%-ppid%' or lower(parentcommandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%ppid-spoof%-ppid%' or lower(parentcommandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%' or lower(commandline) like '%import-module%createprocessfromparent%') or lower(commandline) like '%impersonatefromparentpid -ppid%' or lower(commandline) like '%ppid-spoof%-ppid%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%' or lower(commandline) like '%import-module%createprocessfromparent%') or lower(commandline) like '%impersonatefromparentpid -ppid%' or lower(commandline) like '%ppid-spoof%-ppid%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%attrib.exe%" and rlike(lower(commandline), "attrib.*?(\\+h|\\+s|\\+c|\\+r|\\+a)")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%attrib.exe%" and rlike(lower(commandline), "attrib.*?(\+h|\+s|\+c|\+r|\+a)")) and system='{TargetHost}' and user='{SuspectUser}' 

stream=win-audit where action='PROCESS_CREATED' and  (rlike(lower(commandline), 'system.*?currentcontrolset.*?control.*?lsa.*?reg_multi_sz.*?\\.*?\.') or rlike(lower(commandline), 'windir.*?system32.*?pnputil.exe')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and  (rlike(lower(commandline), 'system.*?currentcontrolset.*?control.*?lsa.*?reg_multi_sz.*?\\.*?\.') or rlike(lower(commandline), 'windir.*?system32.*?pnputil.exe')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and (lower(scriptblocktext) like '%ppid-spoof%-ppid%' or lower(scriptblocktext) like '%-ep bypass%wget%import-module%createprocessfromparent%' or lower(scriptblocktext) like '%import-module%createprocessfromparent%' or lower(scriptblocktext) like '%impersonatefromparentpid -ppid%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and (lower(scriptblocktext) like '%ppid-spoof%-ppid%' or lower(scriptblocktext) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%' or lower(scriptblocktext) like '%import-module%createprocessfromparent%' or lower(scriptblocktext) like '%impersonatefromparentpid -ppid%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adsisearcher.*?(objectclass=user|objectcategory=user|objectclass=computer|objectcategory=computer).*?(findall|findone)') or lower(commandline) like '%adsisearcher%objectcategory=organizationalunit%findall%path%' or lower(commandline) like '%adsisearcher%searchroot%path%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adsisearcher.*?(objectclass=user|objectcategory=user|objectclass=computer|objectcategory=computer).*?(findall|findone)') or lower(commandline) like '%adsisearcher%objectcategory=organizationalunit%findall%path%' or lower(commandline) like '%adsisearcher%searchroot%path%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), 'system.*?currentcontrolset.*?control.*?lsa.*?reg_multi_sz.*?\\.*?\.') or rlike(lower(commandline), 'windir.*?system32.*?pnputil.exe')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), 'system.*?currentcontrolset.*?control.*?lsa.*?reg_multi_sz.*?\\.*?\.') or rlike(lower(commandline), 'windir.*?system32.*?pnputil.exe')) | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), 'system.*?currentcontrolset.*?control.*?lsa.*?reg_multi_sz.*?\\.*?\.') or rlike(lower(commandline), 'windir.*?system32.*?pnputil.exe')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), 'system.*?currentcontrolset.*?control.*?lsa.*?reg_multi_sz.*?\\.*?\.') or rlike(lower(commandline), 'windir.*?system32.*?pnputil.exe')) | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%crypto::%certificates%export%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%crypto::%certificates%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and ((lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-signing%' or lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-decrypting%' or lower(commandline) like '%import%module%aadinternals%export%aadintadfscertificates%' or lower(commandline) like '%import%module%activedirectory%import-module%aadinternals%export-aadintadfsconfiguration%export-aadintadfsencryptionkey%export-aadintadfscertificates -configuration%-key%')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and ((lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-signing%' or lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-decrypting%' or lower(commandline) like '%import%module%aadinternals%export%aadintadfscertificates%' or lower(commandline) like '%import%module%activedirectory%import-module%aadinternals%export-aadintadfsconfiguration%export-aadintadfsencryptionkey%export-aadintadfscertificates -configuration%-key%')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-signing%' or lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-decrypting%' or lower(commandline) like '%import%module%aadinternals%export%aadintadfscertificates%' or lower(commandline) like '%import%module%activedirectory%import-module%aadinternals%export-aadintadfsconfiguration%export-aadintadfsencryptionkey%export-aadintadfscertificates -configuration%-key%')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-signing%' or lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-decrypting%' or lower(commandline) like '%import%module%aadinternals%export%aadintadfscertificates%' or lower(commandline) like '%import%module%activedirectory%import-module%aadinternals%export-aadintadfsconfiguration%export-aadintadfsencryptionkey%export-aadintadfscertificates -configuration%-key%')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%get-ciminstance%name = %svchost.exe%start-athprocessunderspecificparent%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%get-ciminstance%name = %svchost.exe%start-athprocessunderspecificparent%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and lower(commandline) like '%get-ciminstance%name = %svchost.exe%start-athprocessunderspecificparent%' | groupby system

stream=configuration where action='CONFIGURATION_CHANGED' and lower(commandline) like '%get-ciminstance%name = %svchost.exe%start-athprocessunderspecificparent%' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%invoke%webrequest%uri%outfile%') or (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%')) and rlike(lower(commandline), '(temp.*?\.|PhishingAttachment.xlsm)') | groupby user, system | duration 15m and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%invoke%webrequest%uri%outfile%') or (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%')) and rlike(lower(commandline), '(temp.*?\.|PhishingAttachment.xlsm)') | groupby user, system | duration 15m

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline),'adsisearcher.*?(objectclass=user|objectcategory=user|objectclass=computer|objectcategory=computer).*?(findall|findone)') or lower(commandline) like '%adsisearcher%objectcategory=organizationalunit%findall%path%' or lower(commandline) like '%adsisearcher%searchroot%path%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline),'adsisearcher.*?(objectclass=user|objectcategory=user|objectclass=computer|objectcategory=computer).*?(findall|findone)') or lower(commandline) like '%adsisearcher%objectcategory=organizationalunit%findall%path%' or lower(commandline) like '%adsisearcher%searchroot%path%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' and (rlike(lower(commandline), 'system.*?currentcontrolset.*?control.*?lsa.*?reg_multi_sz.*?\\.*?\.') or rlike(lower(commandline), 'windir.*?system32.*?pnputil.exe')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='AUTHENTICATION_PACKAGE_LOADED' and eid='4610' | groupby system, user

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%convertto-securestring%-force%new-selfsignedcertificate%-dnsname%-certstorelocation%get-childitem -path%export-pfxcertificate%-filepath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%convertto-securestring%-force%new-selfsignedcertificate%-dnsname%-certstorelocation%get-childitem -path%export-pfxcertificate%-filepath%') | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%convertto-securestring%-force%new-selfsignedcertificate%-dnsname%-certstorelocation%') or (lower(commandline) like 'get-childitem -path%export-pfxcertificate%-filepath%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%convertto-securestring%-force%new-selfsignedcertificate%-dnsname%-certstorelocation%') or (lower(commandline) like 'get-childitem -path%export-pfxcertificate%-filepath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%crypto::%certificates%export%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%crypto::%certificates%export%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%ppid-spoof%-ppid%' or lower(parentcommandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%ppid-spoof%-ppid%' or lower(parentcommandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%start-athprocessunderspecificparent%' or lower(commandline) like '%start-process%start-athprocessunderspecificparent%') or lower(commandline) like '%get-process -name%start-athprocessunderspecificparent%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%start-athprocessunderspecificparent%' or lower(commandline) like '%start-process%start-athprocessunderspecificparent%') or lower(commandline) like '%get-process -name%start-athprocessunderspecificparent%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and (lower(commandline) like '%start-athprocessunderspecificparent%' or lower(commandline) like '%start-process%start-athprocessunderspecificparent%') or lower(commandline) like '%get-process -name%start-athprocessunderspecificparent%') and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and (lower(commandline) like '%start-athprocessunderspecificparent%' or lower(commandline) like '%start-process%start-athprocessunderspecificparent%') or lower(commandline) like '%get-process -name%start-athprocessunderspecificparent%') | groupby system

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%attrib.exe%" and rlike(lower(commandline), "attrib.*?(\\+h|\\+s|\\+c|\\+r|\\+a)")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%attrib.exe%" and rlike(lower(commandline), "attrib.*?(\+h|\+s|\+c|\+r|\+a)")) and system='{TargetHost}' and user='{SuspectUser}' 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%invoke%webrequest%uri%outfile%') and rlike(lower(commandline), '(temp.*?\.|PhishingAttachment.xlsm)') | groupby user, system | duration 15m

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%invoke%webrequest%uri%outfile%') or (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%')) and rlike(lower(commandline), '(temp.*?\.|PhishingAttachment.xlsm)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%invoke%webrequest%uri%outfile%') or (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%')) and rlike(lower(commandline), '(temp.*?\.|PhishingAttachment.xlsm)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%invoke%webrequest%uri%outfile%') and rlike(lower(commandline), '(temp.*?\.|PhishingAttachment.xlsm)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%invoke%webrequest%uri%outfile%') and rlike(lower(commandline), '(temp.*?\.|PhishingAttachment.xlsm)') | groupby user, system | duration 15m

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline), 'bitsadmin.*?(transfer|setcustomheader|resume|setminretrydelay|addfile|create|setnotifycmdline|resume|complete|ping -n)') or rlike(lower(commandline),"powershell.*?(start-bitstransfer|add-bitsfile|resume-bitstransfer|set-bitstransfer|bits.manager)")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline), 'bitsadmin.*?(transfer|setcustomheader|resume|setminretrydelay|addfile|create|setnotifycmdline|resume|complete|ping -n)') or rlike(lower(commandline),"powershell.*?(start-bitstransfer|add-bitsfile|resume-bitstransfer|set-bitstransfer|bits.manager)")) | groupby system, user, commandline 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline), 'bitsadmin.*?(transfer|setcustomheader|resume|setminretrydelay|addfile|create|setnotifycmdline|resume|complete|ping -n)') or rlike(lower(commandline),"powershell.*?(start-bitstransfer|add-bitsfile|resume-bitstransfer|set-bitstransfer|bits.manager)")) | groupby system, user

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline), 'bitsadmin.*?(transfer|setcustomheader|resume|setminretrydelay|addfile|create|setnotifycmdline|resume|complete|ping -n)') or rlike(lower(commandline),"powershell.*?(start-bitstransfer|add-bitsfile|resume-bitstransfer|set-bitstransfer|bits.manager)")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%jsc.exe%' and (lower(commandline) like '%jsc.exe%.js%' or lower(commandline) like '%jsc.exe%/t:library%.js%') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%jsc.exe%' and (lower(commandline) like '%jsc.exe%.js%' or lower(commandline) like '%jsc.exe%/t:library%.js%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%jsc.exe%' and rlike(lower(commandline),'jsc.exe.*?(t:library.*?js|js)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%jsc.exe%' and rlike(lower(commandline),'jsc.exe.*?(t:library.*?js|js)') | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and image like '%jsc.exe%' and rlike(lower(parentcommandline),'jsc.exe.*?(t:library.*?js|js)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image like '%jsc.exe%' and rlike(lower(parentcommandline),'jsc.exe.*?(t:library.*?js|js)') | groupby system, user

stream=authentication

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%del%' or lower(commandline) like '%erase%' or lower(commandline) like '%rmdir%' or lower(commandline) like '%remove-item%' or lower(commandline) like '%sdelete.exe%') |  groupby user, system

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%invoke%webrequest%uri%outfile%') or (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%')) and rlike(lower(commandline), '(temp.*?\.|PhishingAttachment.xlsm)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%invoke%webrequest%uri%outfile%') or (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%')) and rlike(lower(commandline), '(temp.*?\.|PhishingAttachment.xlsm)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%jsc.exe%' and (lower(commandline like '%jsc.exe%.js%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%jsc.exe%' and (lower(commandline like '%jsc.exe%.js%') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%usebasicparsing%ping%' | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%usebasicparsing%ping%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image like '%jsc.exe%' and (lower(parentcommandline) like '%jsc.exe%.js%' or lower(parentcommandline) like '%jsc.exe%/t:library%.js%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image like '%jsc.exe%' and (lower(parentcommandline) like '%jsc.exe%.js%' or lower(parentcommandline) like '%jsc.exe%/t:library%.js%') | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and image like '%jsc.exe%' and rlike(lower(parentcommandline),'jsc.exe.*?(?:t:library.*?js|js)') | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and image like '%jsc.exe%' and rlike(lower(parentcommandline),'jsc.exe.*?(?:t:library.*?js|js)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' | groupby system, user

stream=* | duration 7d | select distinct(devsrcip)

stream=ep-process where action='PROCESS_ADDED' and image like '%jsc.exe%' and (lower(parentcommandline like '%jsc.exe%.js%') | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and image like '%jsc.exe%' and (lower(parentcommandline like '%jsc.exe%.js%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%jsc.exe%' and rlike(lower(commandline),'jsc.exe.*?(?:t:library.*?js|js)') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%jsc.exe%' and rlike(lower(commandline),'jsc.exe.*?(?:t:library.*?js|js)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%del%' or lower(commandline) like '%erase%' or lower(commandline) like '%rmdir%' or lower(commandline) like '%remove-item%' or lower(commandline) like '%sdelete.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%del%' or lower(commandline) like '%erase%' or lower(commandline) like '%rmdir%' or lower(commandline) like '%remove-item%' or lower(commandline) like '%sdelete.exe%') |  groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%localappdata:~-3,1%md /c echo%>%type%' | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%localappdata:~-3,1%md /c echo%>%type%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), ".*?(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), ".*?(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%usebasicparsing%ping%' | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%usebasicparsing%ping%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%' and commandline like '%Removable Drive Found%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%' and commandline like '%Removable Drive Found%' | groupby system, user, commandline

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%del%' or lower(commandline) like '%erase%' or lower(commandline) like '%rmdir%' or lower(commandline) like '%remove-item%' or lower(commandline) like '%sdelete.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%del%' or lower(commandline) like '%erase%' or lower(commandline) like '%rmdir%' or lower(commandline) like '%remove-item%' or lower(commandline) like '%sdelete.exe%') |  groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%del%' or lower(commandline) like '%erase%' or lower(commandline) like '%rmdir%' or lower(commandline) like '%remove-item%' or lower(commandline) like '%sdelete%') |  groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%del%' or lower(commandline) like '%erase%' or lower(commandline) like '%rmdir%' or lower(commandline) like '%remove-item%' or lower(commandline) like '%sdelete%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(localappdata:~-3,1.*?md /c echo.*?>.*?type|http:|https:|-c write-host.*?([net.webclient]::new.*?downloadstring|bypass|-exec|schtasks /create /sc daily.*?spawncmd.*?/c echo)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(localappdata:~-3,1.*?md /c echo.*?>.*?type|http:|https:|-c write-host.*?([net.webclient]::new.*?downloadstring|bypass|-exec|schtasks /create /sc daily.*?spawncmd.*?/c echo)') | groupby user, system 

stream=signals | duration 5m |  limit 1

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), ".*?(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") | groupby user, system | duration 1h

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), ".*?(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'import-module.*?(sharphound|bloodhound)') or rlike(lower(commandline),'(invoke-bloodhound|sharphound).*?-collectionmethod.*?-domain')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(newprocessname), "(pcalua.exe|forfiles.exe|conhost.exe)") and (lower(commandline) like  "%pcalua%-a%" or lower(commandline) like  "%forfiles%/c%" or lower(commandline) like  "%conhost%") | groupby user, system | duration 1h

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(newprocessname), "(pcalua.exe|forfiles.exe|conhost.exe)") and (lower(commandline) like  "%pcalua%-a%" or lower(commandline) like  "%forfiles%/c%" or lower(commandline) like  "%conhost%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(newprocessname) like '%schtasks.exe%' and lower(commandline) like '%schtask%create%/tn%/tr%/sc%') or  (lower(newprocessname) like '%schtasks.exe%' and rlike(lower(commandline), "schtask.*?create.*?/s.*?/(ru|u).*?/(rp|p)")) | duration 3h

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline),"(reg.*?add|new-itemporperty.*?path|set-itemproperty.*?path).*?(hklm|hkeylocalmachine).*?currentcontrolset.*?control.*?lsa.*?security packages") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline),"(reg.*?add|new-itemporperty.*?path|set-itemproperty.*?path).*?(hklm|hkeylocalmachine).*?currentcontrolset.*?control.*?lsa.*?security packages") | groupby system, user

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|sid\\:\\:patch|sid\\:\\:lookup|sekurlsa::logonpasswords|token::whoami)")  | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline,"mimikatz.*?(sid::add|sid::patch|sid::lookup||sekurlsa::logonpasswords|token::whoami)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=* | duration 10m | select distinct(devsrcip) as DevIP

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), ".*?(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") | groupby user, system | duration 1h

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), ".*?(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%cmd /c "for /l %x in (1,1,%) do start%/p%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%cmd /c "for /l %x in (1,1,%) do start%/p%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'import-module.*?(sharphound|bloodhound)') or rlike(lower(commandline),'(invoke-bloodhound|sharphound).*?(-collectionmethod.*?-domain|-outputdirectory)')) | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'import-module.*?(sharphound|bloodhound)') or rlike(lower(commandline),'(invoke-bloodhound|sharphound).*?(-collectionmethod.*?-domain|-outputdirectory)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(newprocessname) like '%schtasks.exe%' and lower(commandline) like '%schtask%create%/tn%/tr%/sc%') or  (lower(newprocessname) like '%schtasks.exe%' and rlike(lower(commandline), "schtask.*?create.*?/s.*?/(ru|u).*?/(rp|p)")) | duration 3h

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),"(reg.*?add|new-itemporperty.*?path|set-itemproperty.*?path).*?(hklm|hkeylocalmachine).*?currentcontrolset.*?control.*?lsa.*?security packages")  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),"(reg.*?add|new-itemporperty.*?path|set-itemproperty.*?path).*?(hklm|hkeylocalmachine).*?currentcontrolset.*?control.*?lsa.*?security packages") | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline),"(reg.*?add|new-itemporperty.*?path|set-itemproperty.*?path).*?(hklm|hkeylocalmachine).*?currentcontrolset.*?control.*?lsa.*?security packages") | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline),"(reg.*?add|new-itemporperty.*?path|set-itemproperty.*?path).*?(hklm|hkeylocalmachine).*?currentcontrolset.*?control.*?lsa.*?security packages") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|sid\\:\\:patch|sid\\:\\:lookup|sekurlsa::logonpasswords|token::whoami)")  | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"mimikatz.*?(sid::add|sid::patch|sid::lookup||sekurlsa::logonpasswords|token::whoami)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(localappdata.*?md /c echo.*?type|http:|https:|-c write-host.*?net.webclient.*?::new.*?downloadstring|bypass|-exec|schtasks /create /sc daily.*?spawncmd.*?/c echo)') | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(localappdata.*?md /c echo.*?type|http:|https:|-c write-host.*?net.webclient.*?::new.*?downloadstring|bypass|-exec|schtasks /create /sc daily.*?spawncmd.*?/c echo)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) |  select system, user, commandline | limit 10000

stream=win-audit where (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) |  select system, user, commandline | limit 10000

stream=win-audit where action="PROCESS_CREATED" and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) |  select system, user, commandline | limit 10000

stream=signals | duration 5m |  limit 1

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(newprocessname), "(pcalua.exe|forfiles.exe|conhost.exe)") and (lower(commandline) like  "%pcalua%-a%" or lower(commandline) like  "%forfiles%/c%" or lower(commandline) like  "%conhost%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(newprocessname), "(pcalua.exe|forfiles.exe|conhost.exe)") and (lower(commandline) like  "%pcalua%-a%" or lower(commandline) like  "%forfiles%/c%" or lower(commandline) like  "%conhost%") | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(newprocessname) like '%schtasks.exe%' and lower(commandline) like '%schtask%create%/tn%/tr%/sc%') or  (lower(newprocessname) like '%schtasks.exe%' and rlike(lower(commandline), "schtask.*?create.*?/s.*?/(ru|u).*?/(rp|p)")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(newprocessname) like '%schtasks.exe%' and lower(commandline) like '%schtask%create%/tn%/tr%/sc%') or  (lower(newprocessname) like '%schtasks.exe%' and rlike(lower(commandline), "schtask.*?create.*?/s.*?/(ru|u).*?/(rp|p)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=other where devsrcip='114.143.64.202' | limit 1

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%cmd /c "for /l %x in (1,1,%) do start%/p%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%cmd /c "for /l %x in (1,1,%) do start%/p%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%invoke-maldoc -macrofile% -officeproduct%-sub%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%invoke-maldoc -macrofile% -officeproduct%-sub%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%import-module .\invoke-cradlecrafter%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%import-module .\invoke-cradlecrafter%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(newprocessname) like '%schtasks.exe%' and lower(commandline) like '%schtask%create%/tn%/tr%/sc%') or  (lower(newprocessname) like '%schtasks.exe%' and rlike(lower(commandline), "schtask.*?create.*?/s.*?/(ru|u).*?/(rp|p)")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(newprocessname) like '%schtasks.exe%' and lower(commandline) like '%schtask%create%/tn%/tr%/sc%') or  (lower(newprocessname) like '%schtasks.exe%' and rlike(lower(commandline), "schtask.*?create.*?/s.*?/(ru|u).*?/(rp|p)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=other where devsrcip='114.143.64.202' | limit 1

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(namedpipes_executor|namedpipes_server|namedpipes_client).*?--(pipe|server|client)' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(namedpipes_executor|namedpipes_server|namedpipes_client).*?--(pipe|server|client)' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net user%' or lower(commandline) like '%New-SMBShare%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(newprocessname) like '%schtasks.exe%' and lower(commandline) like '%schtask%create%/tn%/tr%/sc%') or  (lower(newprocessname) like '%schtasks.exe%' and rlike(lower(commandline), "schtask.*?create.*?/s.*?/(ru|u).*?/(rp|p)")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(newprocessname) like '%schtasks.exe%' and lower(commandline) like '%schtask%create%/tn%/tr%/sc%') or  (lower(newprocessname) like '%schtasks.exe%' and rlike(lower(commandline), "schtask.*?create.*?/s.*?/(ru|u).*?/(rp|p)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net user%' or lower(commandline) like '%New-SMBShare%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net user%' or lower(commandline) like '%New-SMBShare%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%' or lower(commandline) like '%New-SMBShare%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%' or lower(commandline) like '%New-SMBShare%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%New-SMBShare%' or lower(commandline) like '%Remove-SmbShare%' or lower(commandline) like '%Remove-PSDrive%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%New-SMBShare%' or lower(commandline) like '%Remove-SmbShare%' or lower(commandline) like '%Remove-PSDrive%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%New-SMBShare%' or lower(commandline) like '%Remove-SmbShare%' or lower(commandline) like '%Remove-PSDrive%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%New-SMBShare%' or lower(commandline) like '%Remove-SmbShare%' or lower(commandline) like '%Remove-PSDrive%') | groupby user, system

stream=* | duration 7d | select distinct(devsrcip)

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'invoke-webrequest.*?-(useragent.*?httpbrowser/1.0|useragent.*?wget/1.9.*?stable|useragent.*?opera/8.81|useragent.*?<.*?>).*?out-null') or rlike(lower(commandline),'-s -a.*?(httpbrowser/1.0.*?-m3|wget/1.9.*?cvs-stable.*?-m3|opera/8.81.*?-m3|<.*?>.*?-m3)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'invoke-webrequest.*?-(useragent.*?httpbrowser/1.0|useragent.*?wget/1.9.*?stable|useragent.*?opera/8.81|useragent.*?<.*?>).*?out-null') or rlike(lower(commandline),'-s -a.*?(httpbrowser/1.0.*?-m3|wget/1.9.*?cvs-stable.*?-m3|opera/8.81.*?-m3|<.*?>.*?-m3)')) | groupby user, system

stream=* | duration 10m | select distinct(devsrcip) as DevIP

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%' or lower(commandline) like '%New-SMBShare%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%' or lower(commandline) like '%New-SMBShare%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%net use%' or lower(commandline) like '%New-SMBShare%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%net use%' or lower(commandline) like '%New-SMBShare%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(newprocessname), "(pcalua.exe|forfiles.exe|conhost.exe)") and (lower(commandline) like  "%pcalua%-a%" or lower(commandline) like  "%forfiles%/c%" or lower(commandline) like  "%conhost%") | groupby user, system | duration 1h

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(newprocessname), "(pcalua.exe|forfiles.exe|conhost.exe)") and (lower(commandline) like  "%pcalua%-a%" or lower(commandline) like  "%forfiles%/c%" or lower(commandline) like  "%conhost%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%New-SMBShare%' or lower(commandline) like '%Remove-SmbShare%' or lower(commandline) like '%Remove-PSDrive%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%New-SMBShare%' or lower(commandline) like '%Remove-SmbShare%' or lower(commandline) like '%Remove-PSDrive%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%New-SMBShare%' or lower(commandline) like '%Remove-SmbShare%' or lower(commandline) like '%Remove-PSDrive%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%New-SMBShare%' or lower(commandline) like '%Remove-SmbShare%' or lower(commandline) like '%Remove-PSDrive%') | groupby user, system

stream=* | duration 7d | select distinct(devsrcip)

stream=* | duration 10m | select distinct(devsrcip) as DevIP

stream=ep-process where action='PROCESS_ADDED' and and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%New-SMBShare%' or lower(commandline) like '%Remove-SmbShare%' or lower(commandline) like '%Remove-PSDrive%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%New-SMBShare%' or lower(commandline) like '%Remove-SmbShare%' or lower(commandline) like '%Remove-PSDrive%') | groupby user, system

stream=* | duration 7d | select distinct(devsrcip) as DevIP

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline),'invoke-webrequest.*?-(useragent.*?httpbrowser/1.0|useragent.*?wget/1.9.*?stable|useragent.*?opera/8.81|useragent.*?<.*?>).*?out-null') or rlike(lower(commandline),'-s -a.*?(httpbrowser/1.0.*?-m3|wget/1.9.*?cvs-stable.*?-m3|opera/8.81.*?-m3|<.*?>.*?-m3)')) | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline),'invoke-webrequest.*?-(useragent.*?httpbrowser/1.0|useragent.*?wget/1.9.*?stable|useragent.*?opera/8.81|useragent.*?<.*?>).*?out-null') or rlike(lower(commandline),'-s -a.*?(httpbrowser/1.0.*?-m3|wget/1.9.*?cvs-stable.*?-m3|opera/8.81.*?-m3|<.*?>.*?-m3)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-WebRequest%-UserAgent%HttpBrowser%1.0%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%Wget%cvs-stable%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%Opera%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%<|>%out-null%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-WebRequest%-UserAgent%HttpBrowser%1.0%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%Wget%cvs-stable%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%Opera%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%<|>%out-null%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-WebRequest%-UserAgent%HttpBrowser%1.0%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%Wget%cvs-stable%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%Opera%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%<|>%out-null%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%Invoke-WebRequest%-UserAgent%HttpBrowser%1.0%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%Wget%cvs-stable%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%Opera%out-null%' or commandline like '%Invoke-WebRequest%-UserAgent%<|>%out-null%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'invoke-webrequest.*?-(useragent.*?httpbrowser/1.0|useragent.*?wget/1.9.*?stable|useragent.*?opera/8.81|useragent.*?<.*?>).*?out-null') or rlike(lower(commandline),'-s -a.*?(httpbrowser/1.0.*?-m3|wget/1.9.*?cvs-stable.*?-m3|opera/8.81.*?-m3|<.*?>.*?-m3)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'invoke-webrequest.*?-(useragent.*?httpbrowser/1.0|useragent.*?wget/1.9.*?stable|useragent.*?opera/8.81|useragent.*?<.*?>).*?out-null') or rlike(lower(commandline),'-s -a.*?(httpbrowser/1.0.*?-m3|wget/1.9.*?cvs-stable.*?-m3|opera/8.81.*?-m3|<.*?>.*?-m3)')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%usebasicparsing%(macrocode|create_macro_file|macro_code|macro|macro_name|open_macro)%officeproduct%')   | duration 1d

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%usebasicparsing%ping%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((rar|rar.exe)\s+a -r|(rar|rar.exe)\s+a -hp|(winzip|winzip.exe).*?-min -a -s|(wzzip|wzzip.exe).*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((rar|rar.exe)\s+a -r|(rar|rar.exe)\s+a -hp|(winzip|winzip.exe).*?-min -a -s|(wzzip|wzzip.exe).*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%new-object%net.webclient%downloadstring%safedump%consoleoutput%noninteractive%') or (rlike(lower(commandline), '(hklm.*?software.*?microsoft.*?windows.*?currentversion.*?run|windows.*?system32.*?config|hklm.*?security.*?cache)')) or (rlike(lower(commandline), '(downloadstring|lsass.exe|keyscan_dump|keysscan_start|keyscan_stop|minidump|safedump|hashdump)'))) | duration 1h

stream=ep-process where action='PROCESS_ADDED' and and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%new-smbshare%' or lower(commandline) like '%remove-smbshare%' or lower(commandline) like '%remove-psdrive%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%new-smbshare%' or lower(commandline) like '%remove-smbshare%' or lower(commandline) like '%remove-psdrive%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'schtasks.*?/Create.*?(/f|/tn|/tr).*?frombase64string.*?get-itemproperty.*?(hkcu|hklm|registry::|hkey_current_user|hkey_local_machine)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'schtasks.*?/Create.*?(/f|/tn|/tr).*?frombase64string.*?get-itemproperty.*?(hkcu|hklm|registry::|hkey_current_user|hkey_local_machine)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), "start-process.*?(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%ammyy%' or commandline like '%RemotePC%' or commandline like '%NetSupport%' or commandline like '%UltraViewer%' or commandline like '%UltraVnc%' or commandline like '%msp360connect%') |  groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), "start-process.*?(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect)") | groupby user, sysytem

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), "start-process.*?(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), "start-process.*?(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect)") | groupby user, sysytem

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), "start-process.*?(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect)") | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), "start-process.*?(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action= 'PROCESS_ADDED' and (lower(image) like '%mavinject.exe%' and rlike(lower(commandline), "mavinject.*?injectrunning.*?dll")) | duration 1h and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action= 'PROCESS_ADDED' and (lower(image) like '%mavinject.exe%' and rlike(lower(commandline), "mavinject.*?injectrunning.*?dll")) | duration 1h

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'((rar|rar.exe)\s+a -r|(rar|rar.exe)\s+a -hp|(winzip|winzip.exe).*?-min -a -s|(wzzip|wzzip.exe).*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'((rar|rar.exe)\s+a -r|(rar|rar.exe)\s+a -hp|(winzip|winzip.exe).*?-min -a -s|(wzzip|wzzip.exe).*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|(winzip|winzip.exe).*?-min -a -s|(wzzip|wzzip.exe).*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|(winzip|winzip.exe).*?-min -a -s|(wzzip|wzzip.exe).*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%new-object%net.webclient%downloadstring%safedump%consoleoutput%noninteractive%') or (rlike(lower(commandline), '(hklm.*?software.*?microsoft.*?windo.*?currentversion.*?run|windo.*?system32.*?config|hklm.*?security.*?cache)')) or (rlike(lower(commandline), '(downloadstring|lsass.exe|keyscan_dump|keysscan_start|keyscan_stop|minidump|safedump|hashdump)'))) | duration 1h

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%new-object%net.webclient%downloadstring%safedump%consoleoutput%noninteractive%') or (rlike(lower(commandline), '(hklm.*?software.*?microsoft.*?windo.*?currentversion.*?run|windo.*?system32.*?config|hklm.*?security.*?cache)')) or (rlike(lower(commandline), '(downloadstring|lsass.exe|keyscan_dump|keysscan_start|keyscan_stop|minidump|safedump|hashdump|ntds.dit|cachedlogons.kdt|services.xml|groups.xml)'))) | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%new-object%net.webclient%downloadstring%safedump%consoleoutput%noninteractive%') or (rlike(lower(commandline), '(hklm.*?software.*?microsoft.*?windo.*?currentversion.*?run|windo.*?system32.*?config|hklm.*?security.*?cache)')) or (rlike(lower(commandline), '(downloadstring|lsass.exe|keyscan_dump|keysscan_start|keyscan_stop|minidump|safedump|hashdump|ntds.dit|cachedlogons.kdt|services.xml|groups.xml)'))) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'schtasks.*?/Create.*?(/f|/tn|/tr).*?frombase64string.*?get-itemproperty.*?(hkcu|hklm|registry::|hkey_current_user|hkey_local_machine)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'schtasks.*?/Create.*?(/f|/tn|/tr).*?frombase64string.*?get-itemproperty.*?(hkcu|hklm|registry::|hkey_current_user|hkey_local_machine)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=* where not sourcename='null' | duration 5m | select distinct(sourcename), (((sum(evtlen)/1024)/1024)/1024) as VolumeinGB, current_date() | groupby sourcename | limit 5

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|(winzip|winzip.exe).*?-min -a -s|(wzzip|wzzip.exe).*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|(winzip|winzip.exe).*?-min -a -s|(wzzip|wzzip.exe).*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%new-object%net.webclient%downloadstring%safedump%consoleoutput%noninteractive%') or (rlike(lower(commandline), '(hklm.*?software.*?microsoft.*?windo.*?currentversion.*?run|windo.*?system32.*?config|hklm.*?security.*?cache)')) or (rlike(lower(commandline), '(downloadstring|lsass.exe|keyscan_dump|keysscan_start|keyscan_stop|minidump|safedump|hashdump|ntds.dit|cachedlogons.kdt|services.xml|groups.xml)'))) | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%new-object%net.webclient%downloadstring%safedump%consoleoutput%noninteractive%') or (rlike(lower(commandline), '(hklm.*?software.*?microsoft.*?windo.*?currentversion.*?run|windo.*?system32.*?config|hklm.*?security.*?cache)')) or (rlike(lower(commandline), '(downloadstring|lsass.exe|keyscan_dump|keysscan_start|keyscan_stop|minidump|safedump|hashdump|ntds.dit|cachedlogons.kdt|services.xml|groups.xml)'))) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'schtasks.*?/Create.*?(/f|/tn|/tr).*?frombase64string.*?get-itemproperty.*?(hkcu|hklm|registry::|hkey_current_user|hkey_local_machine)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'schtasks.*?/Create.*?(/f|/tn|/tr).*?frombase64string.*?get-itemproperty.*?(hkcu|hklm|registry::|hkey_current_user|hkey_local_machine)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), "start-process.*?(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect)") | groupby user, sysytem

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), "start-process.*?(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'invoke-cimmethod.*?-classname.*?-namespace.*?microsoft.*?windows.*?taskscheduler.*?-arguments.*?force\s+=\s+\$true') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'invoke-cimmethod.*?-classname.*?-namespace.*?microsoft.*?windows.*?taskscheduler.*?-arguments.*?force\s+=\s+\$true') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and ((lower(image) like "%msiexec%" and lower(commandline) like "%/i%screenconnect.msi%/qn%") or (lower(image) like "%powershell.exe%" and lower(commandline) like "%invoke%webrequest%screenconnect%release.msi%/i%/qn%")) | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and ((lower(image) like "%msiexec%" and lower(commandline) like "%/i%screenconnect.msi%/qn%") or (lower(image) like "%powershell.exe%" and lower(commandline) like "%invoke%webrequest%screenconnect%release.msi%/i%/qn%")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(image), "(msiexec|powershell)") and rlike(lower(commandline), "(invoke.*?webrequest.*?msi.*?/i|/i.*?screenconnect.msi.*?/qn)")) | duration 1h

stream=ep-process where action='PROCESS_ADDED' and ((lower(image) like "%msiexec%" and lower(commandline) like "%/i%screenconnect.msi%/qn%") or (lower(image) like "%powershell.exe%" and lower(commandline) like "%invoke%webrequest%screenconnect%release.msi%/i%/qn%")) | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and ((lower(image) like "%msiexec%" and lower(commandline) like "%/i%screenconnect.msi%/qn%") or (lower(image) like "%powershell.exe%" and lower(commandline) like "%invoke%webrequest%screenconnect%release.msi%/i%/qn%")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action= 'PROCESS_ADDED' and (lower(image) like '%mavinject.exe%' and rlike(lower(commandline), "mavinject.*?injectrunning.*?dll")) | groupby user, system

stream=ep-process where action= 'PROCESS_ADDED' and (lower(image) like '%mavinject.exe%' and rlike(lower(commandline), "mavinject.*?injectrunning.*?dll")) | duration 1h and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where eid='1' and ((image like '%bginfo.exe%' and commandline like '%nolicprompt%' and commandline like '%popup%') or image like '%odbcconf.exe%' or image like '%dnx.exe%') and duration 1d and system='{TargetHost}' and user='{SuspectUser}'

stream=ep-process where eid='1' and ((image like '%bginfo.exe%' and commandline like '%nolicprompt%' and commandline like '%popup%') or image like '%odbcconf.exe%' or image like '%dnx.exe%') | duration 10m | select image,system, user | limit 10

stream=osquery where packagename like '%rootkit%' | select @columns.path as ColumnPath, DevSrcIP, UserName | duration 20m

stream=osquery where packagename like '%rootkit%' | select @columns.path as ColumnPath, DevSrcIP, UserName | duration 20m

stream=osquery where packagename like '%rootkit%' and devsrcip='{TargetHost}' and @columns.path='{SuspectObject}' | duration 20m

stream=win-audit where action="PROCESS_CREATED" and lower(commandline) like "%mimikatz%lsadump::dcsync%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and lower(commandline) like "%mimikatz%lsadump::dcsync%" | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(dir.*?-recurse.*?compress-archive -destinationpath|write-zip -inputpath.*?-outputpath)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(dir.*?-recurse.*?compress-archive -destinationpath|write-zip -inputpath.*?-outputpath)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(invoke-webrequest -uri.*?\$chromium -outfile.*?chrome|start-process.*?chrome-win.*?chrome.exe --load-extension.*?passthru)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(invoke-webrequest -uri.*?\$chromium -outfile.*?chrome|start-process.*?chrome-win.*?chrome.exe --load-extension.*?passthru)') | groupby user, system

stream=osquery where packagename like '%pack_d_compliance_usb_storage%' and action='added' and devsrcip='{TargetHost}' and hostname='{SuspectHost}' | duration 1h

stream=osquery where packagename like '%pack_d_compliance_usb_storage%' and action='added' | duration 1h |  groupby devsrcip, hostname

stream=ep-process where eid='1' and ((image like '%bginfo.exe%' and commandline like '%nolicprompt%' and commandline like '%popup%') or image like '%odbcconf.exe%' or image like '%dnx.exe%') and duration 1d and system='{TargetHost}' and user='{SuspectUser}'

stream=ep-process where eid='1' and ((image like '%bginfo.exe%' and commandline like '%nolicprompt%' and commandline like '%popup%') or image like '%odbcconf.exe%' or image like '%dnx.exe%') | duration 10m | select image,system, user | limit 10

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and lower(commandline) like '%hklm%oftware%wow6432node%google%chrome%extensions%' 

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and ((lower(commandline) like '%hklm%oftware%wow6432node%google%chrome%extensions%') or ((lower(scriptblocktext) like '%hklm%oftware%wow6432node%google%chrome%extensions%')))

stream=osquery where packagename like '%rootkit%' | select @columns.path as ColumnPath, DevSrcIP, UserName | duration 20m

stream=osquery where packagename like '%rootkit%' and devsrcip='{TargetHost}' and @columns.path='{SuspectObject}' | duration 20m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'schtasks.*?/create.*?(/f|/tn|/tr).*?frombase64string.*?get-itemproperty.*?(hkcu|hklm|registry::|hkey_current_user|hkey_local_machine)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'schtasks.*?/create.*?(/f|/tn|/tr).*?frombase64string.*?get-itemproperty.*?(hkcu|hklm|registry::|hkey_current_user|hkey_local_machine)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'(invoke-webrequest -uri.*?\$chromium -outfile.*?chrome|start-process.*?chrome-win.*?chrome.exe --load-extension.*?passthru)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'(invoke-webrequest -uri.*?\$chromium -outfile.*?chrome|start-process.*?chrome-win.*?chrome.exe --load-extension.*?passthru)') | groupby user, system

stream=ep-process where action= 'PROCESS_ADDED' and (lower(image) like '%mavinject.exe%' and rlike(lower(commandline), "mavinject.*?injectrunning.*?dll")) | groupby user, system

stream=ep-process where action= 'PROCESS_ADDED' and (lower(image) like '%mavinject.exe%' and rlike(lower(commandline), "mavinject.*?injectrunning.*?dll")) | duration 1h and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and ((lower(commandline) like '%hklm%oftware%wow6432node%google%chrome%extensions%') or ((lower(scriptblocktext) like '%hklm%oftware%wow6432node%google%chrome%extensions%'))) | groupby system, user 

stream=osquery where packagename like '%pack_d_compliance_usb_storage%' and action='added' and devsrcip='{TargetHost}' and hostname='{SuspectHost}' | duration 1h

stream=osquery where packagename like '%pack_d_compliance_usb_storage%' and action='added' | duration 1h |  groupby devsrcip, hostname

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and (rlike(lower(commandline), 'hklm.*?software.*?wow6432node.*?google.*?chrome.*?extensions') or (rlike(lower(scriptblocktext) like 'hklm.*?software.*?wow6432node.*?google.*?chrome.*?extensions'))) | groupby system, user 

stream=osquery where packagename like '%rootkit%' | select @columns.path as ColumnPath, DevSrcIP, UserName | duration 20m

stream=osquery where packagename like '%rootkit%' and devsrcip='{TargetHost}' and @columns.path='{SuspectObject}' | duration 20m

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and (rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') or (rlike(lower(scriptblocktext) like '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) | groupby system, user 

stream=osquery where packagename like '%pack_d_compliance_usb_storage%' and action='added' and devsrcip='{TargetHost}' and hostname='{SuspectHost}' | duration 1h

stream=osquery where packagename like '%pack_d_compliance_usb_storage%' and action='added' | duration 1h |  groupby devsrcip, hostname

stream=osquery where packagename like '%pack_d_compliance_usb_storage%' and devsrcip='{TargetHost}' and hostname='{SuspectHost}' | duration 1h

stream=osquery where packagename like '%pack_d_compliance_usb_storage%' and action='added' | duration 1h |  groupby devsrcip, hostname

stream=osquery where packagename like '%pack_d_compliance_usb_storage%' and devsrcip='{TargetHost}' and hostname='{SuspectHost}' | duration 6m

stream=osquery where packagename like '%pack_d_compliance_usb_storage%' and not rlike (lower(columnmodel),"(webcam|mouse|wireless|keyboard|0026)") and action='added' | duration 5m | groupby devsrcip, hostname

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and (rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') or (rlike(lower(scriptblocktext) like '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) | groupby system, user 

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and (rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') or (rlike(lower(scriptblocktext) like '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and lower(commandline) like "%mimikatz%lsadump::dcsync%" | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and lower(commandline) like "%mimikatz%lsadump::dcsync%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and ((rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)')) or (rlike(lower(scriptblocktext) like '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and ((rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)')) or (rlike(lower(scriptblocktext) like '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) | groupby system, user 

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and ((rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)')) or (rlike(lower(scriptblocktext) like '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and ((rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)')) or (rlike(lower(scriptblocktext) like '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) | groupby system, user 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%powershell.exe%mmc20.application%calc.exe%') and eid='4688' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'createinstance.*?gettypefromprogid.*?(mmc20.application|mmc20|\.).*?document.activeview.executeshellcommand') | groupby system, user

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline, "cmdkey.*?(list|delete|add|pass)") and user='{SupectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline, "cmdkey.*?(list|delete|add|pass)") | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'gsecdump.*?(-a|sam|cached|secrets|ntds|policy|lsa|kerberos)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'gsecdump.*?(-a|sam|cached|secrets|ntds|policy|lsa|kerberos)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'gsecdump.*?(-a|sam|cached|secrets|ntds|policy|lsa|kerberos)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'gsecdump.*?(-a|sam|cached|secrets|ntds|policy|lsa|kerberos)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and (rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') or (rlike(lower(scriptblocktext) like '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) | groupby system, user 

stream=ep-process where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and (rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') or (rlike(lower(scriptblocktext) like '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and lower(commandline) like "%mimikatz%lsadump::dcsync%" | groupby user, system | duration 1d

stream=win-audit where action="PROCESS_CREATED" and lower(commandline) like "%mimikatz%lsadump::dcsync%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'createinstance.*?gettypefromprogid.*?(mmc20.application|mmc20|\.).*?document.activeview.executeshellcommand') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'createinstance.*?gettypefromprogid.*?(mmc20.application|mmc20|\.).*?document.activeview.executeshellcommand') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%$%/u%' or lower(commandline) like '%new-psdrive%-psprovider%filesystem%-root%$%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%$%/u%' or lower(commandline) like '%new-psdrive%-psprovider%filesystem%-root%$%') | groupby user, system | duration 1h 

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),"(tasklist|sc.*?query|net.*?(start|stop|pause|continue)|wmic.*?service.*?list|get-service|psservice)") | groupby user, system 

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),"(tasklist|sc.*?query|net.*?(start|stop|pause|continue)|get-service|wmic.*?service.*?list|psservice)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'c:.*?windows.*?system32.*?inetsrv.*?appcmd.exe list apppool.*?(@t:*|@text:*|text:*|config)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'c:.*?windows.*?system32.*?inetsrv.*?appcmd.exe list apppool.*?(@t:*|@text:*|text:*|config)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.exe.*?-accepteula.*?(-c|-f|-v)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.exe.*?-accepteula.*?(-c|-f|-v)') | groupby user, system | duration 1h 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.exe.*?-accepteula.*?(-c|-f|-v)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.exe.*?-accepteula.*?(-c|-f|-v)') | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'powerview.*?-usebasicparsing.*?invoke-userhunter -stealth -verbose') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'powerview.*?-usebasicparsing.*?invoke-userhunter -stealth -verbose') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and (rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') or (rlike(lower(scriptblocktext) like '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) | groupby system, user 

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and (rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') or (rlike(lower(scriptblocktext) like '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and (rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') or (rlike(lower(scriptblocktext) like '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) | groupby system, user 

stream=ep-process where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and (rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') or (rlike(lower(scriptblocktext) like '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(new-item|new-itemproperty).*?-path hklm:.*?system.*?currentcontrolset.*?services.*?nppspy.*?(-name.*?-value|-name.*?-propertytype expandstring -value.*?system32.*?nppspy).*?-erroraction ignore') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(new-item|new-itemproperty).*?-path hklm:.*?system.*?currentcontrolset.*?services.*?nppspy.*?(-name.*?-value|-name.*?-propertytype expandstring -value.*?system32.*?nppspy).*?-erroraction ignore') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%$%/u%' or lower(commandline) like '%new-psdrive%-psprovider%filesystem%-root%$%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%$%/u%' or lower(commandline) like '%new-psdrive%-psprovider%filesystem%-root%$%') | groupby user, system | duration 1h 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%$%/u%' or lower(commandline) like '%new-psdrive%-psprovider%filesystem%-root%$%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%$%/u%' or lower(commandline) like '%new-psdrive%-psprovider%filesystem%-root%$%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),"(tasklist|sc.*?query|net.*?(start|stop|pause|continue)|get-service|wmic.*?service.*?list|psservice)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),"(tasklist|sc.*?query|net.*?(start|stop|pause|continue)|wmic.*?service.*?list|get-service|psservice)") | groupby user, system | duration 1h

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and ((rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)')) or (rlike(lower(scriptblocktext), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) | groupby system, user 

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and (rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') or (rlike(lower(scriptblocktext), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, '\\\\\\\\.\\\\.*?:') | duration 1d

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'get-nettcpconnection -localport 3389 -state established -erroraction ignore') and rlike(lower(commandline),'rundll32.*?c:.*?system32.*?comsvcs.dll,\s+minidump.*?full')) | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'get-nettcpconnection -localport 3389 -state established -erroraction ignore') and rlike(lower(commandline),'rundll32.*?c:.*?system32.*?comsvcs.dll,\s+minidump.*?full')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'get-nettcpconnection -localport 3389.*?-state established') and rlike(lower(commandline),'rundll32.*?c:.*?system32.*?comsvcs.dll,\s+minidump.*?full')) | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'get-nettcpconnection -localport 3389.*?-state established') and rlike(lower(commandline),'rundll32.*?c:.*?system32.*?comsvcs.dll,\s+minidump.*?full')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'c:.*?windows.*?system32.*?inetsrv.*?appcmd.exe list apppool.*?(@t:*|@text:*|text:*|config)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'c:.*?windows.*?system32.*?inetsrv.*?appcmd.exe list apppool.*?(@t:*|@text:*|text:*|config)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'c:.*?windows.*?system32.*?inetsrv.*?appcmd.exe list apppool.*?(@t:*|@text:*|text:*|config)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'c:.*?windows.*?system32.*?inetsrv.*?appcmd.exe list apppool.*?(@t:*|@text:*|text:*|config)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%psexe%accepteula%' | duration 1h 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline),  'psexec.exe.*?-accepteula.*?(-c|-f|-v)') | groupby user, system | duration 1h 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.exe.*?-accepteula.*?(-c|-f|-v)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.exe.*?-accepteula.*?(-c|-f|-v)') | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'rundll32.exe.*?(keymgr|krshowkeymgr)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'rundll32.exe.*?(keymgr|krshowkeymgr)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'rundll32.exe.*?(keymgr|krshowkeymgr)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'rundll32.exe.*?(keymgr|krshowkeymgr)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'(new-item|new-itemproperty).*?-path hklm:.*?system.*?currentcontrolset.*?services.*?nppspy.*?(-name.*?-value|-name.*?-propertytype expandstring -value.*?system32.*?nppspy).*?-erroraction ignore') or rlike(lower(commandline),'get-itemproperty -path.*?(hkey_local_machine|hklm):.*?system.*?currentcontrolset.*?control.*?networkprovider.*?order.*?-name providerorder')) | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'(new-item|new-itemproperty).*?-path hklm:.*?system.*?currentcontrolset.*?services.*?nppspy.*?(-name.*?-value|-name.*?-propertytype expandstring -value.*?system32.*?nppspy).*?-erroraction ignore') or rlike(lower(commandline),'get-itemproperty -path.*?(hkey_local_machine|hklm):.*?system.*?currentcontrolset.*?control.*?networkprovider.*?order.*?-name providerorder')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'(new-item|new-itemproperty).*?-path hklm:.*?system.*?currentcontrolset.*?services.*?nppspy.*?(-name.*?-value|-name.*?-propertytype expandstring -value.*?system32.*?nppspy).*?-erroraction ignore') or rlike(lower(commandline),'get-itemproperty -path.*?(hkey_local_machine|hklm):.*?system.*?currentcontrolset.*?control.*?networkprovider.*?order.*?-name providerorder')) | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'(new-item|new-itemproperty).*?-path hklm:.*?system.*?currentcontrolset.*?services.*?nppspy.*?(-name.*?-value|-name.*?-propertytype expandstring -value.*?system32.*?nppspy).*?-erroraction ignore') or rlike(lower(commandline),'get-itemproperty -path.*?(hkey_local_machine|hklm):.*?system.*?currentcontrolset.*?control.*?networkprovider.*?order.*?-name providerorder')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%$%/u%' or lower(commandline) like '%new-psdrive%-psprovider%filesystem%-root%$%') | duration 1h 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline),"(tasklist|sc.*?query|net.*?(start|stop|pause|continue)|wmic.*?service.*?list|get-service|psservice)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline),"(tasklist|sc.*?query|net.*?(start|stop|pause|continue)|wmic.*?service.*?list|get-service|psservice)") | groupby user, system | duration 1h

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline),"(tasklist|sc.*?query|net.*?(start|stop|pause|continue)|wmic.*?service.*?list|get-service|psservice)") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline),"(tasklist|sc.*?query|net.*?(start|stop|pause|continue)|wmic.*?service.*?list|get-service|psservice)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and (rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') or (rlike(lower(scriptblocktext),'(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and (rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') or (rlike(lower(scriptblocktext), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) | groupby system, user 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.exe.*?-accepteula.*?(-c|-f|-v)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.exe.*?-accepteula.*?(-c|-f|-v)') | groupby user, system | duration 1h 

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),"(whoami|net\s+user|quser|get-localuser|get-aduser|query\s+user)") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%cmd.exe%/q%/c%$%") | duration 1d

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%cmd.exe%/q /c%1>%$%2>&1%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%cmd.exe%/q /c%1>%$%2>&1%") | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts)")) | groupby user, system 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline), "(system.codedom.*?new compilerparameters|csharpcodeprovider.*?new csharpcodeprovider|process.start|csc.exe.*?(target:exe|target:library|target:winexe|target:module|target:appcontainerexe|target:winmdobj)|csc.exe.*?code|csc.exe.*?out)") | groupby system, user

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline), "(system.codedom.*?new compilerparameters|csharpcodeprovider.*?new csharpcodeprovider|process.start|csc.exe.*?(target:exe|target:library|target:winexe|target:module|target:appcontainerexe|target:winmdobj)|csc.exe.*?code|csc.exe.*?out)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=other

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%netsh.exe%" and lower(commandline) like "%netsh%advfirewall%firewall%show rule name=all%") | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%netsh.exe%" and lower(commandline) like "%netsh%advfirewall%firewall%show rule name=all%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=threat where vector='HOST' and action='THREAT_DETECTED' and threat is not null and system is not null and file is not null and system='{TargetHost}' and file='{SuspectObject}' | duration 6m

stream=threat where vector='HOST' and action='THREAT_DETECTED' and threat is not null and system is not null and file is not null | groupby threat, system, file 

stream=ep-process where action='PROCESS_ADDED' and ((lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-signing%' or lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-decrypting%' or lower(commandline) like '%import%module%aadinternals%export%aadintadfscertificates%' or lower(commandline) like '%import%module%activedirectory%import-module%aadinternals%export-aadintadfsconfiguration%export-aadintadfsencryptionkey%export-aadintadfscertificates -configuration%-key%')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and ((lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-signing%' or lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-decrypting%' or lower(commandline) like '%import%module%aadinternals%export%aadintadfscertificates%' or lower(commandline) like '%import%module%activedirectory%import-module%aadinternals%export-aadintadfsconfiguration%export-aadintadfsencryptionkey%export-aadintadfscertificates -configuration%-key%')) | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),"(whoami|net\s+user|quser|get-localuser|get-aduser|query\s+user)") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),"(whoami|net\s+user|quser|get-localuser|get-aduser|query\s+user)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%cmd.exe%/q /c%1>%$%2>&1%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%cmd.exe%/q /c%1>%$%2>&1%") | groupby user, system | duration 1d

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and rlike(lower(commandline), "(vboxsvc.*?reregserver|regsvr32.*?virtualbox.*?vboxc.dll|(sc create|sc create).*?vboxdrv)") or rlike(lower(commandline), "(vboxmanage.*?(createvm --name|modifyvm|startvm)|(new-vm|set-vmfirmware|start-vm))") | groupby user, system | duration 3h

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (newprocessname like '%VBoxManage.exe%' and (commandline like 'VBoxManage%register%' or commandline like '%VirtualBox%register%')) or (commandline like '%VBoxManage.exe%startvm%' or commandline like '%VBoxManage.exe%createvm%' or commandline like '%create%VirtualBox%' or commandline like '%VirtualBox%createvm%' or commandline like '%VirtualBox%modifyvm%' or commandline like  '%VirtualBox%startvm%' or commandline like '%powershell.exe%Start-VM%' or commandline like '%powershell.exe%New-VM%' or commandline like '%startvm%VirtualBox%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and ((rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') or rlike(lower(commandline), 'appdata.*?local.*?microsoft.*?windowsapps.*?(\.|foxprow|foxprow.exe)')) or (rlike(lower(scriptblocktext), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) | groupby system, user 

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and ((rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') or rlike(lower(commandline), 'appdata.*?local.*?microsoft.*?windowsapps.*?(\.|foxprow|foxprow.exe)')) or (rlike(lower(scriptblocktext), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') or rlike(lower(commandline), 'appdata.*?local.*?microsoft.*?windowsapps.*?(\.|foxprow|foxprow.exe)'))| groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') or rlike(lower(commandline), 'appdata.*?local.*?microsoft.*?windowsapps.*?(\.|foxprow|foxprow.exe)')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%cmd.exe%reg query%' or rlike(lower(commandline), "powershell.exe.*?(get-item|get-childitem|get-itemproperty|get-childitem -path hklm|get-childitem -path hkcr:)")) | groupby user, system | duration 1h

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%$%/u%' or lower(commandline) like '%new-psdrive%-psprovider%filesystem%-root%$%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%$%/u%' or lower(commandline) like '%new-psdrive%-psprovider%filesystem%-root%$%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),"(whoami|net\s+user|quser|get-localuser|get-aduser|query\s+user)") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),"(whoami|net\s+user|quser|get-localuser|get-aduser|query\s+user)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%cmd.exe%/q /c%1>%$%2>&1%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%cmd.exe%/q /c%1>%$%2>&1%") | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like ''%reg.exe%add hkcu%environment%/v%userinitmprlogonscript%/t%/d% /f%' | groupby user, system and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%reg.exe%add hkcu%environment%/v%userinitmprlogonscript%/t%/d% /f%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%reg.exe%add hkcu%environment%/v%userinitmprlogonscript%/t%/d% /f%') | groupby user, system and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%reg.exe%add hkcu%environment%/v%userinitmprlogonscript%/t%/d% /f%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%reg.exe%add hkcu%environment%/v%userinitmprlogonscript%/t%/d% /f%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%reg.exe%add hkcu%environment%/v%userinitmprlogonscript%/t%/d% /f%') | groupby user, system

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and ((rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') or rlike(lower(commandline), 'appdata.*?local.*?microsoft.*?windowsapps.*?(\.|foxprow|foxprow.exe)')) or (rlike(lower(scriptblocktext), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) | groupby system, user 

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and (rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)') or (rlike(lower(scriptblocktext), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%cmd.exe%reg query%' or rlike(lower(commandline), "powershell.exe.*?(get-item|get-childitem|get-itemproperty|get-childitem -path hklm|get-childitem -path hkcr:)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%cmd.exe%reg query%' or rlike(lower(commandline), "powershell.exe.*?(get-item|get-childitem|get-itemproperty|get-childitem -path hklm|get-childitem -path hkcr:)")) | groupby user, system 

stream=ep-process where action="PROCESS_ADDED" and lower(commandline) like "%dnsexfiltrator%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and lower(commandline) like "%dnsexfiltrator%" | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%cmd.exe%/q /c%1>%$%2>&1%") | duration 1d

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%cmd.exe%/q /c%1>%$%2>&1%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%cmd.exe%/q /c%1>%$%2>&1%") | groupby user, system | duration 1d

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%reg.exe%add hkcu%environment%/v%userinitmprlogonscript%/t%reg_sz%/d% /f%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%reg.exe%add hkcu%environment%/v%userinitmprlogonscript%/t%reg_sz%/d% /f%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts)")) | duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(invoke-mimikatz|invoke-mimikatz\s+-dumpcreds|invoke-mimikatz.*?privilege::debug.*?sekurlsa::logonpasswords)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(invoke-mimikatz|invoke-mimikatz\s+-dumpcreds|invoke-mimikatz.*?privilege::debug.*?sekurlsa::logonpasswords)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'powershell.exe.*?(enable-psremoting|enable-psremoting.*?whoami|evil-winrm|schtasks.exe|gpedit.msc)') | groupby user, system and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'powershell.exe.*?(enable-psremoting|enable-psremoting.*?whoami|evil-winrm|schtasks.exe|gpedit.msc)') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like ''%reg.exe%add hkcu%environment%/v%userinitmprlogonscript%/t%/d% /f%' | groupby user, system and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%reg.exe%add hkcu%environment%/v%userinitmprlogonscript%/t%/d% /f%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%cmd.exe%reg query%' or rlike(lower(commandline), "powershell.exe.*?(get-item|get-childitem|get-itemproperty|get-childitem -path hklm|get-childitem -path hkcr:)")) | groupby user, system | duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%cmd.exe%reg query%' or rlike(lower(commandline), "powershell.exe.*?(get-item|get-childitem|get-itemproperty|get-childitem -path hklm|get-childitem -path hkcr:)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts)")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts)")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%netsh.exe%" and lower(commandline) like "%netsh%advfirewall%firewall%show rule name=all%") | duration 1d

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'powershell.exe.*?(enable-psremoting|enable-psremoting.*?whoami|evil-winrm|schtasks.exe|gpedit.msc)') | groupby user, system and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'powershell.exe.*?(enable-psremoting|enable-psremoting.*?whoami|evil-winrm|schtasks.exe|gpedit.msc)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%AdFind.exe%' and rlike(lower(commandline), "adfind.exe.*?-f.*?(objectcategory=subnet)")) | duration 1d

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%AdFind.exe%' and rlike(lower(commandline), "adfind.exe.*?-f.*?(objectcategory=subnet)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m    

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%AdFind.exe%' and rlike(lower(commandline), "adfind.exe.*?-f.*?objectcategory=subnet")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(newprocessname) like '%adfind.exe%' and rlike(lower(commandline), "adfind.exe.*?-f.*?objectcategory=subnet")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m    

stream=win-audit where action='PROCESS_CREATED' and (lower(newprocessname) like '%adfind.exe%' and rlike(lower(commandline), "adfind.exe.*?-f.*?objectcategory=subnet")) | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%cmd.exe%reg query%' or rlike(lower(commandline), "powershell.exe.*?(get-item|get-childitem|get-itemproperty|get-childitem -path hklm|get-childitem -path hkcr:)")) | groupby user, system | duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%cmd.exe%reg query%' or rlike(lower(commandline), "powershell.exe.*?(get-item|get-childitem|get-itemproperty|get-childitem -path hklm|get-childitem -path hkcr:)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts)")) | groupby user, system | duration 1h

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts)")) | groupby user, system | duration 1h

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%netsh.exe%" and lower(commandline) like "%netsh%advfirewall%firewall%show rule name=all%") | groupby user, system | duration 1d

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%netsh.exe%" and lower(commandline) like "%netsh%advfirewall%firewall%show rule name=all%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and ( lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%"  or lower(commandline) like "%appcmd%set%config%section%httplogging%dontlog%true%" or rlike(lower(commandline),"(hklm|hkey_local_machine).*?software.*?microsoft.*?iis.*?httplogging.*?logextfileflags.*?0"))  | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and ( lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%"  or lower(commandline) like "%appcmd%set%config%section%httplogging%dontlog%true%" or rlike(lower(commandline),"(hklm|hkey_local_machine).*?software.*?microsoft.*?iis.*?httplogging.*?logextfileflags.*?0")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'powershell.exe.*?(Enable-PSRemoting|Enable-PSRemoting.*?whoami|evil-winrm)') | groupby user, system | duration 1d

stream=win-audit where action='PROCESS_CREATED' and (commandline like '%powershell.exe%Enable-PSRemoting%' or commandline like '%powershell.exe%Enable-PSRemoting%whoami%' or commandline like '%powershell.exe%evil-winrm%') and eid='4688' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%netsh.exe%" and lower(commandline) like "%netsh%advfirewall%firewall%show rule name=all%") | groupby user, system | duration 1d

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%netsh.exe%" and lower(commandline) like "%netsh%advfirewall%firewall%show rule name=all%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%adfind%subnet%' | duration 1d

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%AdFind.exe%' and rlike(lower(commandline), "adfind.exe.*?-f.*?(objectcategory=subnet)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m    

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%AdFind.exe%' and rlike(lower(commandline), "adfind.exe.*?-f.*?(objectcategory=subnet)")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%AdFind.exe%' and rlike(lower(commandline), "adfind.exe.*?-f.*?(objectcategory=subnet)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m    

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%AdFind.exe%' and rlike(lower(commandline), "adfind.exe.*?-f.*?objectcategory=subnet")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%AdFind.exe%' and rlike(lower(commandline), "adfind.exe.*?-f.*?(objectcategory=subnet)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m    

stream=win-audit where action='PROCESS_CREATED' and (lower(newprocessname) like '%adfind.exe%' and rlike(lower(commandline), "adfind.exe.*?-f.*?objectcategory=subnet")) | groupby user, system 

stream=other

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%AdFind.exe%' and rlike(lower(commandline), "adfind.exe.*?-f.*?(objectcategory=subnet)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m    

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like '%AdFind.exe%' and rlike(lower(commandline), "adfind.exe.*?-f.*?objectcategory=subnet")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "nslookup.*?(_ldap._tcp.dc._msdcs|nameserver=|server=)")) | duration 1d

stream=win-audit where action="PROCESS_CREATED" and lower(commandline) like "%dnsexfiltrator%" | groupby user, system 

stream=win-audit where action="PROCESS_CREATED" and lower(commandline) like "%dnsexfiltrator%" and user='{SuspectUser}' and system='{TragetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and eid='1' and (lower(commandline) like '%radmin%viewer%radmin.exe%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and eid='1' and (lower(commandline) like '%radmin%viewer%radmin.exe%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline),"(reg.*?add|new-itemporperty.*?path|set-itemproperty.*?path).*?(hklm|hkeylocalmachine).*?currentcontrolset.*?control.*?lsa.*?security packages") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline),"(reg.*?add|new-itemporperty.*?path|set-itemproperty.*?path).*?(hklm|hkeylocalmachine).*?currentcontrolset.*?control.*?lsa.*?security packages") | groupby system, user

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") | groupby user, system 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts)"))| select user, system, commandline | duration 1d

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "nslookup.*?(_ldap._tcp.dc._msdcs|nameserver=|server=)")) | groupby user, system | duration 1d

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "nslookup.*?(_ldap._tcp.dc._msdcs|nameserver=|server=)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "nslookup.*?(_ldap._tcp.dc._msdcs|nameserver=|server=)")) | groupby user, system | duration 1d

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "nslookup.*?(_ldap._tcp.dc._msdcs|nameserver=|server=)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) |  select system, user, commandline | limit 10000

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%') | groupby user, system

stream=win-audit where rlike(lower(newprocessname), '(powershell.exe|wscript.exe|cscript.exe)') and rlike(lower(commandline), '(iex|invoke-expression|new-object|system.net.webclient|downloadstring)')  | groupby user, system, logevent, commandline | duration 1h

stream=win-audit where (newprocessname like '%powershell%.exe%' or newprocessname like '%wscript%.exe%' or newprocessname like '%cscript%.exe%') and (commandline like '%iex%' or commandline like '%Invoke%-Expression%' or commandline like '%New-Object%' or commandline like '%System.Net.WebClient%' or commandline like '%DownloadString%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) |  select system, user, commandline | limit 10000

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?ms-settings.*?(cmd|powershell)") | groupby user, system 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?ms-settings.*?(cmd|powershell)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%convertto-securestring%-force%new-selfsignedcertificate%-dnsname%-certstorelocation%get-childitem -path%export-pfxcertificate%-filepath%') | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%convertto-securestring%-force%new-selfsignedcertificate%-dnsname%-certstorelocation%get-childitem -path%export-pfxcertificate%-filepath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) |  select system, user, commandline | limit 10000

stream=ep-process where action='PROCESS_ADDED' and  ((rlike(lower(image), "(tasklist.exe|wmic.exe|powershell.exe|query.exe|netstat.exe|cmd.exe)")) and (rlike(lower(commandline), "(tasklist|get-process|Win32_Process|process|get-wmiobject)"))) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and  ((rlike(lower(image), "(tasklist.exe|wmic.exe|powershell.exe|query.exe|netstat.exe|cmd.exe)")) and (rlike(lower(commandline), "(tasklist|get-process|Win32_Process|process|get-wmiobject)"))) | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and eid='1' and (lower(commandline) like '%radmin%viewer%radmin.exe%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and eid='1' and (lower(commandline) like '%radmin%viewer%radmin.exe%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(image), "hashcate.exe") and rlike(lower(commandline), "-a.*-m.*-r") or rlike(lower(commandline), "hashcat.*-a.*-m.*-r")) | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(image), "hashcate.exe") and rlike(lower(commandline), "-a.*-m.*-r") or rlike(lower(commandline), "hashcat.*-a.*-m.*-r")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%ppid-spoof%-ppid%' or lower(parentcommandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%ppid-spoof%-ppid%' or lower(parentcommandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(image) like '%certutil.exe%' and rlike(lower(commandline), "certutil.*?(-rename.*-decode|-decode.*-f:|decodehex|encodehex|exportpfx|-encode|urlcache|-decode)")) | groupby user, system

 stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(image) like '%certutil.exe%' and rlike(lower(commandline), "certutil.*?(-rename.*-decode|-decode.*-f:|decodehex|encodehex|exportpfx|-encode|urlcache|-decode)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline), 'bitsadmin.*?(transfer|setcustomheader|resume|setminretrydelay|addfile|create|setnotifycmdline|resume|complete|ping -n)') or rlike(lower(commandline),"powershell.*?(start-bitstransfer|add-bitsfile|resume-bitstransfer|set-bitstransfer|bits.manager)")) | groupby system, user, commandline 

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline), 'bitsadmin.*?(transfer|setcustomheader|resume|setminretrydelay|addfile|create|setnotifycmdline|resume|complete|ping -n)') or rlike(lower(commandline),"powershell.*?(start-bitstransfer|add-bitsfile|resume-bitstransfer|set-bitstransfer|bits.manager)")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), 'system.*?currentcontrolset.*?control.*?lsa.*?reg_multi_sz.*?\\.*?\.') or rlike(lower(commandline), 'windir.*?system32.*?pnputil.exe')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), 'system.*?currentcontrolset.*?control.*?lsa.*?reg_multi_sz.*?\\.*?\.') or rlike(lower(commandline), 'windir.*?system32.*?pnputil.exe')) | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),"(net.*?user|wmic.*?useraccount.*?get|powershell.*?(get-localuser|get-localgroupmember|get-wmiobject.*?-class.*?win32_useraccount|get-aduser)|lusrmgr|query.*?user|net.*?localgroup.*?administrators|net.*?group.*?administrators|net.*?group|net.*?accounts|net.*?localgroup|net.*?view|dsquery.*?user|dsget.*?user|reg.*?query.*?profilelist)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),"(net.*?user|wmic.*?useraccount.*?get|powershell.*?(get-localuser|get-localgroupmember|get-wmiobject.*?-class.*?win32_useraccount|get-aduser)|lusrmgr|query.*?user|net.*?localgroup.*?administrators|net.*?group.*?administrators|net.*?group|net.*?accounts|net.*?localgroup|net.*?view|dsquery.*?user|dsget.*?user|reg.*?query.*?profilelist)") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline), "(runas|whoami.*?all|powershell.*get\-token|powershell.*invoke\-tokenmanipulation|mimikatz.*sekurlsa::logonpasswords|mimikatz.*token::elevate|mimikatz.*privilege::debug|set\-executionpolicy.*scope.*force|createprocessfromparent.*?get\-process.*?lsass)") and system="{TargetHost}" and user="{SuspectUser}" | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline), "(runas|whoami.*?all|powershell.*get\-token|powershell.*invoke\-tokenmanipulation|mimikatz.*sekurlsa::logonpasswords|mimikatz.*token::elevate|mimikatz.*privilege::debug|set\-executionpolicy.*scope.*force|createprocessfromparent.*?get\-process.*?lsass)") | groupby user, system, commandline

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline), "(runas|whoami.*?all|powershell.*get\-token|powershell.*invoke\-tokenmanipulation|mimikatz.*sekurlsa::logonpasswords|mimikatz.*token::elevate|mimikatz.*privilege::debug|set\-executionpolicy.*scope.*force|createprocessfromparent.*?get\-process.*?lsass)") | groupby user, system, commandline

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline), "(runas|whoami.*?all|powershell.*get\-token|powershell.*invoke\-tokenmanipulation|mimikatz.*sekurlsa::logonpasswords|mimikatz.*token::elevate|mimikatz.*privilege::debug|set\-executionpolicy.*scope.*force|createprocessfromparent.*?get\-process.*?lsass)") and system="{TargetHost}" and user="{SuspectUser}" | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%ppid-spoof%-ppid%' or lower(parentcommandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%ppid-spoof%-ppid%' or lower(parentcommandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'system.*?currentcontrolset.*?services.*?w32time.*?timeproviders.*?(reg_z.*?\\.*?\.|reg_dword.*?enabled|reg_dword\s+.*?inputprovider)') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'system.*?currentcontrolset.*?services.*?w32time.*?timeproviders.*?(reg_z.*?\\.*?\.|reg_dword.*?enabled|reg_dword\s+.*?inputprovider)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline),"(reg.*?add|new-itemporperty.*?path|set-itemproperty.*?path).*?(hklm|hkeylocalmachine).*?currentcontrolset.*?control.*?lsa.*?security packages") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline),"(reg.*?add|new-itemporperty.*?path|set-itemproperty.*?path).*?(hklm|hkeylocalmachine).*?currentcontrolset.*?control.*?lsa.*?security packages") | groupby system, user

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") | groupby user, system, commandline 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") and user="{SuspectUser}" and system="{TargetHost}" | duration 6m

stream=ep-process where action="PROCESS_ADDED" and (rlike(lower(commandline), "curl.exe'.*-k.*-(F|T|d).*?https://") or rlike(lower(commandline), "curl.exe'.*-k.*(--data|--data-|--form|--upload-file)")) | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and (rlike(lower(commandline), "curl.exe'.*-k.*-(F|T|d).*?https://") or rlike(lower(commandline), "curl.exe'.*-k.*(--data|--data-|--form|--upload-file)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m


stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%') or (lower(commandline) like '%hklm%software%policies%microsoft%windows nt%dnsclient%')) | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%') or (lower(commandline) like '%hklm%software%policies%microsoft%windows nt%dnsclient%')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe%' and (lower(commandline) like '%start-bitstransfer%priority%foreground%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and image like '%powershell.exe%' and (lower(commandline) like '%start-bitstransfer%priority%foreground%') | groupby system, user

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED"  and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m


stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and ((lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-signing%' or lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-decrypting%' or lower(commandline) like '%import%module%aadinternals%export%aadintadfscertificates%' or lower(commandline) like '%import%module%activedirectory%import-module%aadinternals%export-aadintadfsconfiguration%export-aadintadfsencryptionkey%export-aadintadfscertificates -configuration%-key%')) | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and ((lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-signing%' or lower(commandline) like '%import-module adfs%get-adfscertificate -certificatetype token-decrypting%' or lower(commandline) like '%import%module%aadinternals%export%aadintadfscertificates%' or lower(commandline) like '%import%module%activedirectory%import-module%aadinternals%export-aadintadfsconfiguration%export-aadintadfsencryptionkey%export-aadintadfscertificates -configuration%-key%')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%mpcmdrun%-removedefinitions%" or rlike(lower(commandline),"(del|remove).*?programdata.*?microsoft.*?windows.*?defender.*?defination.*?update")) | groupby user, system, commandline 

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%mpcmdrun%-removedefinitions%" or rlike(lower(commandline),"(del|remove).*?programdata.*?microsoft.*?windows.*?defender.*?defination.*?update")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and ( lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%"  or lower(commandline) like "%appcmd%set%config%section%httplogging%dontlog%true%" or rlike(lower(commandline),"(hklm|hkey_local_machine).*?software.*?microsoft.*?iis.*?httplogging.*?logextfileflags.*?0"))  | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and ( lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%"  or lower(commandline) like "%appcmd%set%config%section%httplogging%dontlog%true%" or rlike(lower(commandline),"(hklm|hkey_local_machine).*?software.*?microsoft.*?iis.*?httplogging.*?logextfileflags.*?0")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'psexec.*?-accepteula\s+-s\s+reg\s+save\s+(hklm|hkey_local_machine).*?security.*?policy') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'psexec.*?-accepteula\s+-s\s+reg\s+save\s+(hklm|hkey_local_machine).*?security.*?policy') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts|whoami /all|net view /all|cmd /c set|net share|route print|netstat -nao|qwinsta|wmi query rootcim)"))  and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts|whoami /all|net view /all|cmd /c set|net share|route print|netstat -nao|qwinsta|wmi query rootcim)")) | select user, system, commandline 

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(pypykatz.*?(live\s+lsa|registry|registry.*?--sam.*?(--security|--o|--o.*?--json))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(pypykatz.*?(live\s+lsa|registry|registry.*?--sam.*?(--security|--o|--o.*?--json))') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%'  or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or  lower(commandline) like '%adidnsdump%-u%-p%print-zones%') lower(commandline) like '%adidnsdump%-u%-p%print-zones%') | duration 2h | groupby user, system, commandline

stream=authentication

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%convertto-securestring%-force%new-selfsignedcertificate%-dnsname%-certstorelocation%get-childitem -path%export-pfxcertificate%-filepath%') | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%convertto-securestring%-force%new-selfsignedcertificate%-dnsname%-certstorelocation%get-childitem -path%export-pfxcertificate%-filepath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'psexec.*?-accepteula\s+-s\s+reg\s+save\s+(hklm|hkey_local_machine).*?security.*?policy') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'psexec.*?-accepteula\s+-s\s+reg\s+save\s+(hklm|hkey_local_machine).*?security.*?policy') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts|whoami /all|net view /all|cmd /c set|net share|route print|netstat -nao|qwinsta|wmi query rootcim)"))| select user, system, commandline | duration 1d

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts|whoami /all|net view /all|cmd /c set|net share|route print|netstat -nao|qwinsta|wmi query rootcim)"))  and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts|whoami /all|net view /all|cmd /c set|net share|route print|netstat -nao|qwinsta|wmi query rootcim)")) | select user, system, commandline | duration 1d

stream=ep-porcess where action="PROCESS_ADDED" and rlike(lower(commandline), "(netstat|ss\s+-(t|u|n|l|p)|nmap|tcpdump|wireshark|lsof|ip\s+addr|arp\s+-|iftop|netcat|nc\s|iptraf-ng|netdiscover|zenmap|nstat|tcpflow|get-nettcpconnection|get-netudpendpoint|test-netconnection|get-netadapter|get-netipaddress|get-netroute|resolve-dnsname|get-netneighbor|get-nettcpsetting|get-netfirewallrule|get-netfirewallprofile|get-netfirewalladdressfilter|get-netfirewallportfilter|get-netfirewallapplicationfilter|get-netfirewallsecurityfilter|get-netfirewallinterfacefilter)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(commandline), "(netstat|ss\\s+-(t|u|n|l|p)|nmap|tcpdump|wireshark|lsof|ip\\s+addr|arp\\s+-|iftop|netcat|nc\\s|iptraf-ng|netdiscover|zenmap|nstat|tcpflow|get-nettcpconnection|get-netudpendpoint|test-netconnection|get-netadapter|get-netipaddress|get-netroute|resolve-dnsname|get-netneighbor|get-nettcpsetting|get-netfirewallrule|get-netfirewallprofile|get-netfirewalladdressfilter|get-netfirewallportfilter|get-netfirewallapplicationfilter|get-netfirewallsecurityfilter|get-netfirewallinterfacefilter)") | duration 15m |  select system, user, commandline | limit 10000

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'pypykatz.*?(live\s+lsa|registry|registry.*?--sam.*?(--security|--o|--o.*?--json))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'pypykatz.*?(live\s+lsa|registry|registry.*?--sam.*?(--security|--o|--o.*?--json))') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED"  and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") | groupby user, system, commandline 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") and user="{SuspectUser}" and system="{TargetHost}" | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts|whoami /all|net view /all|cmd /c set|net share|route print|netstat -nao|qwinsta|wmi query rootcim)"))| select user, system, commandline | duration 1d

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline), "(netstat|ss\\s+-(t|u|n|l|p)|nmap|tcpdump|wireshark|lsof|ip\\s+addr|arp\\s+-|iftop|netcat|nc\\s|iptraf-ng|netdiscover|zenmap|nstat|tcpflow|get-nettcpconnection|get-netudpendpoint|test-netconnection|get-netadapter|get-netipaddress|get-netroute|resolve-dnsname|get-netneighbor|get-nettcpsetting|get-netfirewallrule|get-netfirewallprofile|get-netfirewalladdressfilter|get-netfirewallportfilter|get-netfirewallapplicationfilter|get-netfirewallsecurityfilter|get-netfirewallinterfacefilter)") | duration 15m |  select system, user, commandline | limit 10000

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline), "(netstat|ss\s+-(t|u|n|l|p)|nmap|tcpdump|wireshark|lsof|ip\s+addr|arp\s+-|iftop|netcat|nc\s|iptraf-ng|netdiscover|zenmap|nstat|tcpflow|get-nettcpconnection|get-netudpendpoint|test-netconnection|get-netadapter|get-netipaddress|get-netroute|resolve-dnsname|get-netneighbor|get-nettcpsetting|get-netfirewallrule|get-netfirewallprofile|get-netfirewalladdressfilter|get-netfirewallportfilter|get-netfirewallapplicationfilter|get-netfirewallsecurityfilter|get-netfirewallinterfacefilter)") and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=authentication

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%'  or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%') | duration 2h | groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%'  or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%') | duration 2h | groupby user, system, commandline

stream=authentication

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%'  or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or  lower(commandline) like '%nbtstat%-n%' or  lower(commandline) like '%nbtstat%-s%') | duration 2h |  select system, user, commandline | limit 10000

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline),"(reg.*?add|new-itemporperty.*?path|set-itemproperty.*?path).*?(hklm|hkeylocalmachine).*?currentcontrolset.*?control.*?lsa.*?security packages") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline),"(reg.*?add|new-itemporperty.*?path|set-itemproperty.*?path).*?(hklm|hkeylocalmachine).*?currentcontrolset.*?control.*?lsa.*?security packages") | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%'  or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%') | duration 2h | groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%'  or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or  lower(commandline) like '%nbtstat%-n%' or  lower(commandline) like '%nbtstat%-s%') | duration 2h |  select system, user, commandline | limit 10000

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%'  or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or  lower(commandline) like '%nbtstat%-n%' or  lower(commandline) like '%nbtstat%-s%') | duration 16m | groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%'  or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or  lower(commandline) like '%nbtstat%-n%' or  lower(commandline) like '%nbtstat%-s%') | duration 15m |  select system, user, commandline | limit 10000

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts|whoami /all|net view /all|cmd /c set|net share|route print|netstat -nao|qwinsta|wmi query rootcim)")) | duration 15m |  select system, user, commandline | limit 10000

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts|whoami /all|net view /all|cmd /c set|net share|route print|netstat -nao|qwinsta|wmi query rootcim)"))  and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%'  or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or  lower(commandline) like '%nbtstat%-n%' or  lower(commandline) like '%nbtstat%-s%') | duration 15m |  select system, user, commandline | limit 10000

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%'  or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or  lower(commandline) like '%nbtstat%-n%' or  lower(commandline) like '%nbtstat%-s%') | duration 16m | groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%' or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or  lower(commandline) like '%nbtstat%-n%' or  lower(commandline) like '%nbtstat%-s%') and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%' or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or  lower(commandline) like '%nbtstat%-n%' or  lower(commandline) like '%nbtstat%-s%') | duration 15m |  select system, user, commandline | limit 10000

stream=win-audit where rlike(lower(newprocessname), '(powershell.exe|wscript.exe|cscript.exe)') and rlike(lower(commandline), '(iex|invoke-expression|new-object|system.net.webclient|downloadstring)')  | groupby user, system

stream=win-audit where rlike(lower(newprocessname), '(powershell.exe|wscript.exe|cscript.exe)') and rlike(lower(commandline), '(iex|invoke-expression|new-object|system.net.webclient|downloadstring)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%directoryservices.directorysearcher%ObjectCategory=Computer%' or lower(commandline) like '%get-adcomputer%' or lower(commandline) like '%adsisearcher%objectcategory=computer%')  | duration 1d

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powerview%get-domaincontroller%' | groupby user, system |duration 1h

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powerview%get-domaincontroller%' and systeem='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powerview%get-domaincontroller%' and systeem='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powerview%get-domaincontroller%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%get-childitem env:username%' or lower(commandline) like '%[system.environment]::username%' or lower(commandline) like '%$env:username%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%get-childitem env:username%' or lower(commandline) like '%[system.environment]::username%' or lower(commandline) like '%$env:username%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'(expand-archive|tar -xf).*?\.zip') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'(expand-archive|tar -xf).*?\.zip') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"copy.*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe|lsm\.exe)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"copy.*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe|lsm\.exe)") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%directoryservices.directorysearcher%ObjectCategory=Computer%' or lower(commandline) like '%get-adcomputer%' or lower(commandline) like '%adsisearcher%objectcategory=computer%')  | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%directoryservices.directorysearcher%ObjectCategory=Computer%' or lower(commandline) like '%get-adcomputer%' or lower(commandline) like '%adsisearcher%objectcategory=computer%') and system='{TargetHost}' and suer='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%directoryservices.directorysearcher%ObjectCategory=Computer%' or lower(commandline) like '%get-adcomputer%' or lower(commandline) like '%adsisearcher%objectcategory=computer%')  | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%directoryservices.directorysearcher%ObjectCategory=Computer%' or lower(commandline) like '%get-adcomputer%' or lower(commandline) like '%adsisearcher%objectcategory=computer%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '(system\.security\.principal\.windowsidentity.*?getcurrent|\(whoami\)\.Split\(.*?\)\[\1\]|qwinsta \/server\:)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '(system\.security\.principal\.windowsidentity.*?getcurrent|\(whoami\)\.Split\(.*?\)\[\1\]|qwinsta \/server\:)') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powerview%get-domaincontroller%' and systeem='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powerview%get-domaincontroller%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(\.jse|\.js|\.gz|\.bz2|\.tar|\.7z|-xvf.*?\.tar.*?-c|decompressed_files.*?(\.exe|\.bin|\.html|\.doc|\.txt)|decompressed_files|decompressed|decompress)')| groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(\.jse|\.js|\.gz|\.bz2|\.tar|\.7z|-xvf.*?\.tar.*?-c|decompressed_files.*?(\.exe|\.bin|\.html|\.doc|\.txt)|decompressed_files|decompressed|decompress)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'') | groupby system, user

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'(rxpand-archive|tar -xf).*?.zip') | groupby system, user

stream=win-audit where rlike(lower(newprocessname), '(powershell.exe|wscript.exe|cscript.exe)') and rlike(lower(commandline), '(iex|invoke-expression|new-object|system.net.webclient|downloadstring)')  | groupby user, system | duration 1d

stream=win-audit where rlike(lower(newprocessname), '(powershell.exe|wscript.exe|cscript.exe)') and rlike(lower(commandline), '(iex|invoke-expression|new-object|system.net.webclient|downloadstring)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%directoryservices.directorysearcher%ObjectCategory=Computer%' or lower(commandline) like '%get-adcomputer%' or lower(commandline) like '%adsisearcher%objectcategory=computer%')  | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%directoryservices.directorysearcher%ObjectCategory=Computer%' or lower(commandline) like '%get-adcomputer%' or lower(commandline) like '%adsisearcher%objectcategory=computer%') and system='{TargetHost}' and suer='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (NewProcessName like "%.jse" or NewProcessName like "%.js") and rlike(CommandLine, '(\\-\\-decompress|\\-c|.gz|.bz2|.tar|.7z|.gz|-xvf.*?\.tar.*?-C)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (NewProcessName like "%.jse" or NewProcessName like "%.js") and rlike(CommandLine, '(\\-\\-decompress|\\-c)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powerview%get-domaincontroller%' | groupby user, system |duration 1h

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powerview%get-domaincontroller%' and systeem='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), '(system\.security\.principal\.windowsidentity.*?getcurrent|\(whoami\)\.Split\(.*?\)\[\1\]|qwinsta \/server\:)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), '(system\.security\.principal\.windowsidentity.*?getcurrent|\(whoami\)\.Split\(.*?\)\[\1\]|qwinsta \/server\:)') | groupby user, system

stream=ep-process where (lower(parentimage) like "%powershell.exe%" or lower(parentimage) like "%cmd.exe%") and (commandline like "%fileNameToDelete%crmlog%" or commandline like "%Remove%Item%Path%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where rlike(lower(parentimage), "(powershell.exe|cmd.exe)") and rlike(lower(commandline), "(filenametodelete.*?crmlog|remove.*?item.*?path)") | groupby user, system | duration 1d

stream = authentication where system = 'raigad.netmonastery.network' and eid ='4771' and not reason = 'KDC_ERR_PREAUTH_FAILED' and not reason = '-' | duration 1h 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%directoryservices.directorysearcher%ObjectCategory=Computer%' or lower(commandline) like '%get-adcomputer%' or lower(commandline) like '%adsisearcher%objectcategory=computer%')  | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%directoryservices.directorysearcher%ObjectCategory=Computer%' or lower(commandline) like '%get-adcomputer%' or lower(commandline) like '%adsisearcher%objectcategory=computer%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), '(system\.security\.principal\.windowsidentity.*?getcurrent|\(whoami\)\.Split\(.*?\)\[\1\]|qwinsta \/server\:)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), '(system\.security\.principal\.windowsidentity.*?getcurrent|\(whoami\)\.Split\(.*?\)\[\1\]|qwinsta \/server\:)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(\.jse|\.js|\.gz|\.bz2|\.tar|\.7z|-xvf.*?\.tar.*?-c|decompressed_files.*?(\.exe|\.bin|\.html|\.doc|\.txt)|decompressed_files|decompressed|decompress)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(\.jse|\.js|\.gz|\.bz2|\.tar|\.7z|-xvf.*?\.tar.*?-c|decompressed_files.*?(\.exe|\.bin|\.html|\.doc|\.txt)|decompressed_files|decompressed|decompress)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'(expand-archive|tar -xf).*?.zip')

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(winpwn|samfile|dotnetsearch|kittielocal|uacbypass).*?-(consoleoutput|noninteractive|domainrecon|localrecon|powersharppack|browsercredentials)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(winpwn|samfile|dotnetsearch|kittielocal|uacbypass).*?-(consoleoutput|noninteractive|domainrecon|localrecon|powersharppack|browsercredentials)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"copy.*?(\.exe|\.vbs|\.ps1).*?(\.docx|\.pdf|\.ps1|\.xls|\.xlsx|\.png|\.doc|\.pdf|\.rtf)(\.exe|\.vbs|\.ps1)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline),'(copy|rename-item|ren).*?(\.exe|\.vbs|\.ps1).*?(\.docx|\.pdf|\.ps1|\.xls|\.xlsx|\.png|\.doc|\.pdf|\.rtf)(\.exe|\.vbs|\.ps1)') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'(copy|rename-item|ren).*?(\.exe|\.vbs|\.ps1).*?(\.docx|\.pdf|\.ps1|\.xls|\.xlsx|\.png|\.doc|\.pdf|\.rtf)(\.exe|\.vbs|\.ps1)') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'(copy|rename-item|ren).*?(\.exe|\.vbs|\.ps1).*?(\.docx|\.pdf|\.ps1|\.xls|\.xlsx|\.png|\.doc|\.pdf|\.rtf)(\.exe|\.vbs|\.ps1)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), ".*?(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), ".*?(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'((copy|ren|rename-item).*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe|lsm\.exe|explorer\.exe)') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'((copy|ren|rename-item).*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe|lsm\.exe|explorer\.exe)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentcommandline,"copy.*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe|lsm\.exe)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(parentcommandline),'((copy|ren|rename-item).*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe|lsm\.exe|explorer\.exe)') | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(parentcommandline),'((copy|ren|rename-item).*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe|lsm\.exe|explorer\.exe)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(parentcommandline),'((copy|ren|rename-item).*?System32.*?(cmd\.exe|cscript\.exe|wscript\.exe|powershell\.exe).*?(APPDATA|SystemRoot).*?(lsass\.exe|notepad\.exe|svchost\.exe|taskhostw\.exe|lsm\.exe|explorer\.exe)') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'((sc|schtasks).*?create.*?win32times)' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'((sc|schtasks).*?create.*?win32times)' |  groupby user, system

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(parentcommandline),'((sc|schtasks).*?create.*?win32times)' | groupby parentuser, system

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(parentcommandline),'((sc|schtasks).*?create.*?win32times)' and parentuser='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%sc%create%sc sdset%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%sc%create%sc sdset%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=osquery where packagename like '%pack_d_compliance_usb_storage%' and devsrcip='{TargetHost}' and hostname='{SuspectHost}' | duration 6m

stream=osquery where packagename like '%pack_d_compliance_usb_storage%' and not rlike (lower(columnmodel),"(webcam|mouse|wireless|keyboard|audio|0026)") and action='added' | duration 5m | groupby devsrcip, hostname

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|sid\\:\\:patch|sid\\:\\:lookup|sekurlsa::logonpasswords|token::whoami)")  | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"mimikatz.*?(sid::add|sid::patch|sid::lookup||sekurlsa::logonpasswords|token::whoami)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "nslookup.*?(_ldap._tcp.dc._msdcs|nameserver=|server=)")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "nslookup.*?(_ldap._tcp.dc._msdcs|nameserver=|server=)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where rlike(lower(parentimage), "(powershell.exe|cmd.exe)") and rlike(lower(commandline), "(filenametodelete.*?crmlog|remove.*?item.*?path|New-Item.*?File created|Invoke-WebRequest.*?OutFile|malware.exe|Invoke-Expression.*?New-Object.*?Net.WebClient)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where rlike(lower(parentimage), "(powershell.exe|cmd.exe)") and rlike(lower(commandline), "(filenametodelete.*?crmlog|remove.*?item.*?path|New-Item.*?File created|Invoke-WebRequest.*?OutFile|malware.exe|Invoke-Expression.*?New-Object.*?Net.WebClient)") | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%' | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%SOFTWARE%Microsoft%Active%Setup%Installed%Components%atomic%test%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),"(reg.*?add|new-itemporperty.*?path|set-itemproperty.*?path).*?(hklm|hkeylocalmachine).*?currentcontrolset.*?control.*?lsa.*?security packages")  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),"(reg.*?add|new-itemporperty.*?path|set-itemproperty.*?path).*?(hklm|hkeylocalmachine).*?currentcontrolset.*?control.*?lsa.*?security packages") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), ".*?(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") | groupby user, system | duration 1h

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), ".*?(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%invoke%webrequest%uri%outfile%') or (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%')) and rlike(lower(commandline), '(temp.*?\.|PhishingAttachment.xlsm)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%invoke%webrequest%uri%outfile%') or (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%')) and rlike(lower(commandline), '(temp.*?\.|PhishingAttachment.xlsm)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%invoke-maldoc -macrofile% -officeproduct%-sub%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%invoke-maldoc -macrofile% -officeproduct%-sub%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(namedpipes_executor|namedpipes_server|namedpipes_client).*?--(pipe|server|client)' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(namedpipes_executor|namedpipes_server|namedpipes_client).*?--(pipe|server|client)' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "%powershell.exe" and lower(parentCommandLine) like "%powershell%-encodedcommand%" and lower(commandline) like "%system%text%encoding%unicode%getbytes%tobase64string%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and parentimage like "%powershell.exe" and lower(parentCommandLine) like "%powershell%-encodedcommand%" and lower(commandline) like "%system%text%encoding%unicode%getbytes%tobase64string%" |  groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%send-mailmessage%' | duration 1d | limit 10

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|sid\\:\\:patch|sid\\:\\:lookup|sekurlsa\\:\\:logonpasswords|token\\:\\:whoami)")  | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline,"mimikatz.*?(sid\:\:add|sid\:\:patch|sid\:\:lookup||sekurlsa\:\:logonpasswords|token\:\:whoami)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'get-wmiobject.*?-class.*?(ds_computer.*?-namespace|win32_ntdomain|win32_computersystem)') | system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'get-wmiobject.*?-class.*?(ds_computer.*?-namespace|win32_ntdomain|win32_computersystem)') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m


stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(newprocessname), "(reg.exe|regedit.exe)") and rlike(lower(commandline), "reg.*add.*?/v.*?(showsuperhidden|hidden).*/t.*?(reg_dword|reg_sz|reg_expand|reg_binary).*/d.*/f")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(newprocessname), "(reg.exe|regedit.exe)") and rlike(lower(commandline), "reg.*add.*?/v.*?(showsuperhidden|hidden).*/t.*?(reg_dword|reg_sz|reg_expand|reg_binary).*/d.*/f")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(localappdata.*?md /c echo.*?type|http:|https:|-c write-host.*?net.webclient.*?::new.*?downloadstring|bypass|-exec|schtasks /create /sc daily.*?spawncmd.*?/c echo)') | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(localappdata.*?md /c echo.*?type|http:|https:|-c write-host.*?net.webclient.*?::new.*?downloadstring|bypass|-exec|schtasks /create /sc daily.*?spawncmd.*?/c echo)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%import-module .\invoke-cradlecrafter%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%import-module .\invoke-cradlecrafter%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'get-wmiobject.*?-class.*?(ds_computer.*?-namespace|win32_ntdomain|win32_computersystem)') | duration 2h

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(send.*?mailmessage.*?from|emailitem.htmlbody|send email.*?from|invoke\-webrequest.*?uri|emailitem.attachments.add source|emailitem.send)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(send.*?mailmessage.*?from|emailitem.htmlbody|send email.*?from|invoke\-webrequest.*?uri|emailitem.attachments.add source|emailitem.send)') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%filename =%url =%file = new-item -force%-value%contenttype =%invoke-webrequest%-method put%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%filename =%url =%file = new-item -force%-value%contenttype =%invoke-webrequest%-method put%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%filename =%url =%file = new-item -force%-value%contenttype =%invoke-webrequest%-method put%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%filename =%url =%file = new-item -force%-value%contenttype =%invoke-webrequest%-method put%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and rlike(lower(commandline), "(vboxsvc.*?reregserver|regsvr32.*?virtualbox.*?vboxc.dll|(sc create|sc create).*?vboxdrv)") or rlike(lower(commandline), "(vboxmanage.*?(createvm --name|modifyvm|startvm)|(new-vm|set-vmfirmware|start-vm))") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and rlike(lower(commandline), "(vboxsvc.*?reregserver|regsvr32.*?virtualbox.*?vboxc.dll|(sc create|sc create).*?vboxdrv)") or rlike(lower(commandline), "(vboxmanage.*?(createvm --name|modifyvm|startvm)|(new-vm|set-vmfirmware|start-vm))") | groupby user, system and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(c.*?windows.*?microsoft.net.*?framework64.*?(csc\.exe|csc|\.exe)|new-item.*?type.*?erroraction.*?invoke-webRequest)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(c.*?windows.*?microsoft.net.*?framework64.*?(csc\.exe|csc|\.exe)|new-item.*?type.*?erroraction.*?invoke-webRequest)') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?office.*?excel.*?security.*?trusted)') or rlike(lower(commandline), 'powershell.exe.*?createinstance.*?gettypefromprogid.*?(mmc20.application|mmc20|\.).*?document.activeview.executeshellcommand') or rlike(lower(commandline), 'createinstance.*?gettypefromprogid.*?(excel.application|\.application)') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?office.*?excel.*?security.*?trusted)') or rlike(lower(commandline), 'powershell.exe.*?createinstance.*?gettypefromprogid.*?(mmc20.application|mmc20|\.).*?document.activeview.executeshellcommand') or rlike(lower(commandline), 'createinstance.*?gettypefromprogid.*?(excel.application|\.application)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%remove-adgroupmember%' or lower(commandline) like '%net group%/delete%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%remove-adgroupmember%' or lower(commandline) like '%net group%/delete%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and image like '%jsc.exe%' and rlike(lower(parentcommandline),'jsc.exe.*?(t:library.*?js|js)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image like '%jsc.exe%' and rlike(lower(parentcommandline),'jsc.exe.*?(t:library.*?js|js)') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%jsc.exe%' and rlike(lower(commandline),'jsc.exe.*?(t:library.*?js|js)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%jsc.exe%' and rlike(lower(commandline),'jsc.exe.*?(t:library.*?js|js)') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and (lower(newprocessname) like '%schtasks.exe%' and lower(commandline) like '%schtask%create%/tn%/tr%/sc%') or  (lower(newprocessname) like '%schtasks.exe%' and rlike(lower(commandline), "schtask.*?create.*?/s.*?/(ru|u).*?/(rp|p)")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(newprocessname) like '%schtasks.exe%' and lower(commandline) like '%schtask%create%/tn%/tr%/sc%') or  (lower(newprocessname) like '%schtasks.exe%' and rlike(lower(commandline), "schtask.*?create.*?/s.*?/(ru|u).*?/(rp|p)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%new-smbshare%' or lower(commandline) like '%remove-smbshare%' or lower(commandline) like '%remove-psdrive%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%new-smbshare%' or lower(commandline) like '%remove-smbshare%' or lower(commandline) like '%remove-psdrive%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'get-wmiobject.*?-class.*?(ds_computer.*?-namespace|win32_ntdomain|win32_computersystem)') | groupby user, system | duration 2h

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'get-wmiobject.*?-class.*?(ds_computer.*?-namespace|win32_ntdomain|win32_computersystem)') | system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"mimikatz.*?(sid\:\:add|sid\:\:patch|sid\:\:lookup|sekurlsa\:\:logonpasswords|token\:\:whoami)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline,"mimikatz.*?(sid\\:\\:add|sid\\:\\:patch|sid\\:\\:lookup|sekurlsa\\:\\:logonpasswords|token\\:\\:whoami)")  | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and ((parentprocessname like '%wscript%' and newprocessname like '%cmd.exe%' and rlike(lower(commandline), '(whoami /all|net user|net group)')) or (newprocessname like '%wscript%' and rlike(lower(commandline), '(whoami /all|net user|net group)')) or (newprocessname like '%nltest%' and rlike(lower(commandline), '(domain_trusts|all_trusts)'))) | groupby user, system and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((parentprocessname like '%wscript%' and newprocessname like '%cmd.exe%' and rlike(lower(commandline), '(whoami /all|net user|net group)')) or (newprocessname like '%wscript%' and rlike(lower(commandline), '(whoami /all|net user|net group)')) or (newprocessname like '%nltest%' and rlike(lower(commandline), '(domain_trusts|all_trusts)'))) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?office.*?excel.*?security.*?trusted)') or rlike(lower(commandline), 'powershell.exe.*?createinstance.*?gettypefromprogid.*?(mmc20.application|mmc20|\.).*?document.activeview.executeshellcommand') or rlike(lower(commandline), 'createinstance.*?gettypefromprogid.*?(excel.application|\.application)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?office.*?excel.*?security.*?trusted)') or rlike(lower(commandline), 'powershell.exe.*?createinstance.*?gettypefromprogid.*?(mmc20.application|mmc20|\.).*?document.activeview.executeshellcommand') or rlike(lower(commandline), 'createinstance.*?gettypefromprogid.*?(excel.application|\.application)') | groupby system, user

stream=EP-PIPE where action in ('PIPE_CREATED','PIPE_CONNECTED') and rlike(lower(logevent),'(start-process .\badpotato|stop-process -name.*?badpotato.*?-force -erroraction silentlycontinue|badpotato)') | groupby user, system

stream=EP-PIPE where action in ('PIPE_CREATED','PIPE_CONNECTED') and rlike(lower(logevent),'(start-process .\badpotato|stop-process -name.*?badpotato.*?-force -erroraction silentlycontinue|badpotato)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%get-aduser%remove-adgroupmember%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%get-aduser%remove-adgroupmember%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%new-smbshare%' or lower(commandline) like '%remove-smbshare%' or lower(commandline) like '%remove-psdrive%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%new-smbshare%' or lower(commandline) like '%remove-smbshare%' or lower(commandline) like '%remove-psdrive%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'import-module.*?(sharphound|bloodhound)') or rlike(lower(commandline),'(invoke-bloodhound|sharphound).*?(-collectionmethod.*?-domain|-outputdirectory)')) | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'import-module.*?(sharphound|bloodhound)') or rlike(lower(commandline),'(invoke-bloodhound|sharphound).*?(-collectionmethod.*?-domain|-outputdirectory)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'(namedpipes_executor|namedpipes_server|namedpipes_client).*?--(pipe|server|client)' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'(namedpipes_executor|namedpipes_server|namedpipes_client).*?--(pipe|server|client)' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, 'C.*?(.zip.*exe|.rar.*exe|.7z.*exe|.tar.*exe|.zip|.rar|.7z|.tar|.dll|.bat|.msi)') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, 'C.*?(.zip.*exe|.rar.*exe|.7z.*exe|.tar.*exe|.zip|.rar|.7z|.tar|.dll|.bat|.msi)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(copy.*?windows.*?ntds.*?ntds.dit.*?ntds.dit|copy.*?windows.*?system32.*?config.*?system.*?vsc_system_hive|reg\s+save\s+hklm.*?system.*?system_hive)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(copy.*?windows.*?ntds.*?ntds.dit.*?ntds.dit|copy.*?windows.*?system32.*?config.*?system.*?vsc_system_hive|reg\s+save\s+hklm.*?system.*?system_hive)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'ntdsutil.*?ac\s+i\s+ntds.*?ifm.*?create\s+full.*?q\s+q') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'ntdsutil.*?ac\s+i\s+ntds.*?ifm.*?create\s+full.*?q\s+q') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'get-wmiobject.*?-class.*?(ds_computer.*?-namespace|win32_ntdomain|win32_computersystem)') | system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'get-wmiobject.*?-class.*?(ds_computer.*?-namespace|win32_ntdomain|win32_computersystem)') | groupby user, system | duration 2h

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(newprocessname), "(pcalua.exe|forfiles.exe|conhost.exe)") and (lower(commandline) like  "%pcalua%-a%" or lower(commandline) like  "%forfiles%/c%" or lower(commandline) like  "%conhost%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(newprocessname), "(pcalua.exe|forfiles.exe|conhost.exe)") and (lower(commandline) like  "%pcalua%-a%" or lower(commandline) like  "%forfiles%/c%" or lower(commandline) like  "%conhost%") | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%cmd /c "for /l %x in (1,1,%) do start%/p%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%cmd /c "for /l %x in (1,1,%) do start%/p%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'get-wmiobject.*?-class.*?(ds_computer.*?-namespace|win32_ntdomain|win32_computersystem)') | system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'get-wmiobject.*?-class.*?(ds_computer.*?-namespace|win32_ntdomain|win32_computersystem)') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'get-wmiobject.*?-class.*?(ds_computer.*?-namespace|win32_ntdomain|win32_computersystem)') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'get-wmiobject.*?-class.*?(ds_computer.*?-namespace|win32_ntdomain|win32_computersystem)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%fileName =%url =%file = New-Item -Force%-Value%contentType =%Invoke-WebRequest%-Method Put%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%filename =%url =%file = new-item -force%-value%contenttype =%invoke-webrequest%-method put%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%filename =%url =%file = new-item -force%-value%contenttype =%invoke-webrequest%-method put%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%filename =%url =%file = new-item -force%-value%contenttype =%invoke-webrequest%-method put%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?microsoft.*?office.*?excel.*?security.*?trusted') or rlike(lower(commandline), 'powershell.exe.*?createinstance.*?gettypefromprogid.*?(mmc20.application|mmc20|\.).*?document.activeview.executeshellcommand') or rlike(lower(commandline), 'createinstance.*?gettypefromprogid.*?(excel.application|\.application)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?microsoft.*?office.*?excel.*?security.*?trusted') or rlike(lower(commandline), 'powershell.exe.*?createinstance.*?gettypefromprogid.*?(mmc20.application|mmc20|\.).*?document.activeview.executeshellcommand') or rlike(lower(commandline), 'createinstance.*?gettypefromprogid.*?(excel.application|\.application)') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and (lower(newprocessname) like '%adfind.exe%' and rlike(lower(commandline), "adfind.exe.*?-f.*?objectcategory=subnet")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m    

stream=win-audit where action='PROCESS_CREATED' and (lower(newprocessname) like '%adfind.exe%' and rlike(lower(commandline), "adfind.exe.*?-f.*?objectcategory=subnet")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%netsh.exe%" and lower(commandline) like "%netsh%advfirewall%firewall%show rule name=all%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (newprocessname like "%netsh.exe%" and lower(commandline) like "%netsh%advfirewall%firewall%show rule name=all%") | groupby user, system 

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663', '4656') and rlike(lower(commandline), '(t1027_006_remote|myAnchor.*?document.createelement.*?myanchor.download|myblob.*?new blob|myurl.*?window.url.createobjecturl.*?myanchor.href|myevilblob.*?new blob|url.createobjecturl)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663', '4656') and rlike(lower(commandline), '(t1027_006_remote|myAnchor.*?document.createelement.*?myanchor.download|myblob.*?new blob|myurl.*?window.url.createobjecturl.*?myanchor.href|myevilblob.*?new blob|url.createobjecturl)') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%' or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or  lower(commandline) like '%nbtstat%-n%' or  lower(commandline) like '%nbtstat%-s%') | duration 15m |  select system, user, commandline | limit 10000

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%' or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or  lower(commandline) like '%nbtstat%-n%' or  lower(commandline) like '%nbtstat%-s%') and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), '(system\.security\.principal\.windowsidentity.*?getcurrent)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), '(system\.security\.principal\.windowsidentity.*?getcurrent)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?microsoft.*?office.*?excel.*?security.*?trusted') or rlike(lower(commandline), 'powershell.exe.*?createinstance.*?gettypefromprogid.*?(mmc20.application|mmc20|\.).*?document.activeview.executeshellcommand') or rlike(lower(commandline), 'createinstance.*?gettypefromprogid.*?(excel.application|\.application)') | groupby system, user and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?microsoft.*?office.*?excel.*?security.*?trusted') or rlike(lower(commandline), 'powershell.exe.*?createinstance.*?gettypefromprogid.*?(mmc20.application|mmc20|\.).*?document.activeview.executeshellcommand') or rlike(lower(commandline), 'createinstance.*?gettypefromprogid.*?(excel.application|\.application)') | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), 'windows.*?powershell.exe.*?(enable-psremoting.*?(force|whoami)|evil-winrm)')) or rlike(lower(commandline), '(new-pssession|enter-pssession|enable-psremoting)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), 'windows.*?powershell.exe.*?(enable-psremoting.*?(force|whoami)|evil-winrm)')) or rlike(lower(commandline), '(new-pssession|enter-pssession|enable-psremoting)') | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(dsquery.*?filter.*?objectclass=trusteddomain|nltest.*?(domain_trusts|trusted_domains))")  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_ADDED', 'PROCESS_CREATED') and rlike(lower(commandline), "(dsquery.*?filter.*?objectclass=trusteddomain|nltest.*?(domain_trusts|trusted_domains))") | groupby user, system 

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663') and rlike(lower(commandline), '(t1027_006_remote|myAnchor.*?document.createelement.*?myanchor.download|myblob.*?new blob|myurl.*?window.url.createobjecturl.*?myanchor.href|myevilblob.*?new blob|url.createobjecturl)') | groupby system, user

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663') and rlike(lower(commandline), '(t1027_006_remote|myAnchor.*?document.createelement.*?myanchor.download|myblob.*?new blob|myurl.*?window.url.createobjecturl.*?myanchor.href|myevilblob.*?new blob|url.createobjecturl)')  and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action= 'PROCESS_ADDED' and (lower(image) like '%mavinject%' and rlike(lower(commandline), "mavinject.*?injectrunning.*?dll")) | duration 1h and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action= 'PROCESS_ADDED' and (lower(image) like '%mavinject%' and rlike(lower(commandline), "mavinject.*?injectrunning.*?dll")) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts|whoami /all|net view /all|cmd /c set|net share|route print|netstat -nao|qwinsta|wmi query rootcim)"))  and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts|whoami /all|net view /all|cmd /c set|net share|route print|netstat -nao|qwinsta|wmi query rootcim)")) | duration 15m |  select system, user, commandline | limit 10000

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%adfind.exe%-f%objectcategory=computer%' or lower(commandline) like '%adfind.exe%-sc%dclist%' or lower(commandline) like '%adfind.exe%-f%objectcategory=ntdsdsa%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%adfind.exe%-f%objectcategory=computer%' or lower(commandline) like '%adfind.exe%-sc%dclist%' or lower(commandline) like '%adfind.exe%-f%objectcategory=ntdsdsa%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),"(whoami|net\s+user|quser|get-localuser|get-aduser|query\s+user|wmic\s+useraccount\s+get|qwinsta)") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),"(whoami|net\s+user|quser|get-localuser|get-aduser|query\s+user|wmic\s+useraccount\s+get|qwinsta)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where rlike(lower(newprocessname), 'powershell.exe') and lower(commandline) like '%get-content%path%select-string%pattern%'  | groupby user, system

stream=win-audit where rlike(lower(newprocessname), 'powershell.exe') and lower(commandline) like '%get-content%path%select-string%pattern%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), 'windows.*?powershell.exe.*?(enable-psremoting.*?(force|whoami)|evil-winrm)')) or rlike(lower(commandline), '(new-pssession|enter-pssession|enable-psremoting)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), 'windows.*?powershell.exe.*?(enable-psremoting.*?(force|whoami)|evil-winrm)')) or rlike(lower(commandline), '(new-pssession|enter-pssession|enable-psremoting)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663', '4656') and rlike(lower(commandline), '(t1027_006_remote|myAnchor.*?document.createelement.*?myanchor.download|myblob.*?new blob|myurl.*?window.url.createobjecturl.*?myanchor.href|myevilblob.*?new blob|url.createobjecturl)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663', '4656') and rlike(lower(commandline), '(t1027_006_remote|myAnchor.*?document.createelement.*?myanchor.download|myblob.*?new blob|myurl.*?window.url.createobjecturl.*?myanchor.href|myevilblob.*?new blob|url.createobjecturl)') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(c.*?windows.*?microsoft.net.*?framework64.*?(csc\.exe|csc|\.exe)|new-item.*?type.*?erroraction.*?invoke-webRequest)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(c.*?windows.*?microsoft.net.*?framework64.*?(csc\.exe|csc|\.exe)|new-item.*?type.*?erroraction.*?invoke-webRequest)') | groupby system, user

stream=EP-PROCESS where action="PROCESS_ADDED"  and rlike(lower(commandline), '(c.*?windows.*?microsoft.net.*?framework64.*?(csc\.exe|csc|\.exe)|new-item.*?type.*?erroraction.*?invoke-webRequest)')  | groupby system, user 

stream=EP-PROCESS where action="PROCESS_ADDED"  and rlike(lower(commandline), '(c.*?windows.*?microsoft.net.*?framework64.*?(csc\.exe|csc|\.exe)|new-item.*?type.*?erroraction.*?invoke-webRequest)')  and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and parentcommandline like '%powershell.exe%' and ((lower(commandline) like "%system.text.encoding%unicode.getbytes%encodedcommand%tobase64string%") or (rlike(lower(commandline), 'powershell.*?(unicode.getbytes|encodedcommand.*?tobse64string)'))) | groupby system, user

stream=EP-PROCESS where action="PROCESS_ADDED" and parentcommandline like '%powershell.exe%' and ((lower(commandline) like "%system.text.encoding%unicode.getbytes%encodedcommand%tobase64string%") or (rlike(lower(commandline), 'powershell.*?(unicode.getbytes|encodedcommand.*?tobse64string)'))) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'get-wmiobject.*?-class.*?(ds_computer.*?-namespace|win32_ntdomain|win32_computersystem)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'get-wmiobject.*?-class.*?(ds_computer.*?-namespace|win32_ntdomain|win32_computersystem)') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powerview%get-domaincontroller%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powerview%get-domaincontroller%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%adfind.exe%-f%objectcategory=computer%' or lower(commandline) like '%adfind.exe%-sc%dclist%' or lower(commandline) like '%adfind.exe%-f%objectcategory=ntdsdsa%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%adfind.exe%-f%objectcategory=computer%' or lower(commandline) like '%adfind.exe%-sc%dclist%' or lower(commandline) like '%adfind.exe%-f%objectcategory=ntdsdsa%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (rlike(lower(commandline),'(start-process.*nsudo|nsudo)') and commandline like "%-U:T -P:E%") | groupby user, system

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663', '4656') and rlike(lower(commandline), '(t1027_006_remote|myAnchor.*?document.createelement.*?myanchor.download|myblob.*?new blob|myurl.*?window.url.createobjecturl.*?myanchor.href|myevilblob.*?new blob|url.createobjecturl)') | groupby system, user

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663', '4656') and rlike(lower(commandline), '(t1027_006_remote|myAnchor.*?document.createelement.*?myanchor.download|myblob.*?new blob|myurl.*?window.url.createobjecturl.*?myanchor.href|myevilblob.*?new blob|url.createobjecturl)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(c.*?windows.*?microsoft.net.*?framework64.*?(csc.exe|csc|\.exe)|new-item.*?type.*?erroraction.*?invoke-webRequest)') | groupby system, user, commandline | duration 1h| limit 10 

stream=ep-process where action= 'PROCESS_ADDED' and (lower(image) like '%mavinject%' and rlike(lower(commandline), "mavinject.*?injectrunning.*?dll")) | groupby user, system

stream=ep-process where action= 'PROCESS_ADDED' and (lower(image) like '%mavinject%' and rlike(lower(commandline), "mavinject.*?injectrunning.*?dll")) | duration 1h and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663', '4656') and rlike(lower(commandline), '(t1027_006_remote|myAnchor.*?document.createelement.*?myanchor.download|myblob.*?new blob|myurl.*?window.url.createobjecturl.*?myanchor.href|myevilblob.*?new blob|url.createobjecturl)') | groupby system, user

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663', '4656') and rlike(lower(commandline), '(t1027_006_remote|myAnchor.*?document.createelement.*?myanchor.download|myblob.*?new blob|myurl.*?window.url.createobjecturl.*?myanchor.href|myevilblob.*?new blob|url.createobjecturl)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(invoke-mimikatz|invoke-mimikatz\s+-dumpcreds|invoke-mimikatz.*?privilege::debug.*?sekurlsa::logonpasswords|mimikatz.*?sekurlsa::minidump.*?sekurlsa::logonpasswords)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(invoke-mimikatz|invoke-mimikatz\s+-dumpcreds|invoke-mimikatz.*?privilege::debug.*?sekurlsa::logonpasswords|mimikatz.*?sekurlsa::minidump.*?sekurlsa::logonpasswords)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((parentprocessname like '%wscript%' and newprocessname like '%cmd.exe%' and rlike(lower(commandline), '(whoami /all|net user|net group)')) or (newprocessname like '%wscript%' and rlike(lower(commandline), '(whoami /all|net user|net group)')) or (newprocessname like '%nltest%' and rlike(lower(commandline), '(domain_trusts|all_trusts)'))) | groupby user, system and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((parentprocessname like '%wscript%' and newprocessname like '%cmd.exe%' and rlike(lower(commandline), '(whoami /all|net user|net group)')) or (newprocessname like '%wscript%' and rlike(lower(commandline), '(whoami /all|net user|net group)')) or (newprocessname like '%nltest%' and rlike(lower(commandline), '(domain_trusts|all_trusts)'))) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and ((parentprocessname like '%wscript%' and newprocessname like '%cmd.exe%' and rlike(lower(commandline), '(whoami /all|net user|net group)')) or (newprocessname like '%wscript%' and rlike(lower(commandline), '(whoami /all|net user|net group)')) or (newprocessname like '%nltest%' and rlike(lower(commandline), '(domain_trusts|all_trusts)'))) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and ((parentprocessname like '%wscript%' and newprocessname like '%cmd.exe%' and rlike(lower(commandline), '(whoami /all|net user|net group)')) or (newprocessname like '%wscript%' and rlike(lower(commandline), '(whoami /all|net user|net group)')) or (newprocessname like '%nltest%' and rlike(lower(commandline), '(domain_trusts|all_trusts)'))) | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline),"(reg.*?add|new-itemporperty.*?path|set-itemproperty.*?path).*?(hklm|hkeylocalmachine).*?currentcontrolset.*?control.*?lsa.*?security packages") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline),"(reg.*?add|new-itemporperty.*?path|set-itemproperty.*?path).*?(hklm|hkeylocalmachine).*?currentcontrolset.*?control.*?lsa.*?security packages") | groupby system, user

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'((copy|ren|rename-item).*?system32.*?\.exe.*?(appdata|systemroot).*?\.exe)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'((copy|ren|rename-item).*?system32.*?\.exe.*?(appdata|systemroot).*?\.exe)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%invoke%webrequest%uri%outfile%') or (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%')) and rlike(lower(commandline), '(temp.*?\.|phishingattachment.xlsm)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%tls12%invoke%webrequest%uri%outfile%') or (lower(commandline) like '%net.servicepointmanager%securityprotocol%net.securityprotocoltype%')) and rlike(lower(commandline), '(temp.*?\.|phishingattachment.xlsm)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(vssadmin.*?create shadow|)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(vssadmin.*?create\s+shadow|wmic shadowcopy call create|wmic\s+/node.*?shadowcopy call create|wmic\s+/node.*?process call create.*?esentutl.exe.*?/vss|gwmi -list win32_shadowcopy.*?create.*?clientaccessible|mklink\s+/d.*?globalroot.*?device|diskshadow.*?/s)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(vssadmin.*?create\s+shadow|wmic shadowcopy call create|wmic\s+/node.*?shadowcopy call create|wmic\s+/node.*?process call create.*?esentutl.exe.*?/vss|gwmi -list win32_shadowcopy.*?create.*?clientaccessible|mklink\s+/d.*?globalroot.*?device|diskshadow.*?/s)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-FILE where action="FILE_CREATED" and rlike(lower(commandline), "(system.codedom.*?new compilerparameters|csharpcodeprovider.*?new csharpcodeprovider|process.start|csc.exe.*?(target:exe|target:library|target:winexe|target:module|target:appcontainerexe|target:winmdobj)|csc.exe.*?code|csc.exe.*?out)")  | groupby system, user

stream=EP-FILE where action="FILE_CREATED" and rlike(lower(commandline), "(system.codedom.*?new compilerparameters|csharpcodeprovider.*?new csharpcodeprovider|process.start|csc.exe.*?(target:exe|target:library|target:winexe|target:module|target:appcontainerexe|target:winmdobj)|csc.exe.*?code|csc.exe.*?out)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '(expand-archive.*?path.*?(|destinationpathforce|passthru|whatif|confirm)|add-type.*?assemblyname.*?extracttodirectory|decompressed_files.*?(\.mjs|\.js|\jsx|\json|\.ts|\.vue))') and user='{SuspectUser}' and system='{TargetSystem}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '(expand-archive.*?path.*?(|destinationpathforce|passthru|whatif|confirm)|add-type.*?assemblyname.*?extracttodirectory|decompressed_files.*?(\.mjs|\.js|\jsx|\json|\.ts|\.vue))') | groupby user, system

stream=EP-PIPE where action in ('PIPE_CREATED','PIPE_CONNECTED') and rlike(lower(logevent),'(start-process .\badpotato|stop-process -name.*?badpotato.*?-force -erroraction silentlycontinue|badpotato)') | groupby user, system

stream=EP-PIPE where action in ('PIPE_CREATED','PIPE_CONNECTED') and rlike(lower(logevent),'(start-process .\badpotato|stop-process -name.*?badpotato.*?-force -erroraction silentlycontinue|badpotato)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where rlike(lower(commandline), "(remove.*?item.*?path|new-item.*?file created|get-childitem.*?recurse.*?file.*?where-object.*?match|get-item.*?path.*?get-itemproperty|get-winevent.*?logname.*?filterxpath.*?where-object.*?match|get-nettcpconnection.*?where-object)") | groupby user, system, commandline | duration 1d | limit 10

stream=ep-process where rlike(lower(commandline), "(remove.*?item.*?path|new-item.*?file created|get-childitem.*?recurse.*?file.*?where-object.*?match|get-item.*?path.*?get-itemproperty|get-winevent.*?logname.*?filterxpath.*?where-object.*?match|get-nettcpconnection.*?where-object)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED'  and rlike(lower(commandline), 'software.*?microsoft.*?active setup.*?installed component') and rlike(lower(commandline), '(run|runonce|runonce.exe|\..*?alternateshellstartup)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED'  and rlike(lower(commandline), 'software.*?microsoft.*?active setup.*?installed component') and rlike(lower(commandline), '(run|runonce|runonce.exe|\..*?alternateshellstartup)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(vssadmin.*?create shadow|)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(vssadmin.*?create\s+shadow|wmic shadowcopy call create|wmic\s+/node.*?shadowcopy call create|wmic\s+/node.*?process call create.*?esentutl.exe.*?/vss|gwmi -list win32_shadowcopy.*?create.*?clientaccessible|mklink\s+/d.*?globalroot.*?device|diskshadow.*?/s)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(vssadmin.*?create\s+shadow|wmic shadowcopy call create|wmic\s+/node.*?shadowcopy call create|wmic\s+/node.*?process call create.*?esentutl.exe.*?/vss|gwmi -list win32_shadowcopy.*?create.*?clientaccessible|mklink\s+/d.*?globalroot.*?device|diskshadow.*?/s)')and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline), "(system.codedom.*?new compilerparameters|csharpcodeprovider.*?new csharpcodeprovider|process.start|csc.exe.*?target:exe|csc.exe.*?target:library|csc.exe.*?code|csc.exe.*?out)") | groupby system, user and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline), "(system.codedom.*?new compilerparameters|csharpcodeprovider.*?new csharpcodeprovider|process.start|csc.exe.*?target:exe|csc.exe.*?target:library|csc.exe.*?code|csc.exe.*?out)") | groupby system, user

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'(expand-archive.*?\.zip.*?Start-Process.*?(\.exe|\.dll|\.txt|\.com|\.bat|\.cmd|\.ps1|\.psm1|\.vbs|\.js|\.wsf|\.sh|\.bash|\.py|\.pl|\.rb|\.php|\.jsp|\.aspx|\.cgi|\.lua|\.sql|\.yml|\.yaml|\.json))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'(expand-archive.*?\.zip.*?Start-Process.*?(\.exe|\.dll|\.txt|\.com|\.bat|\.cmd|\.ps1|\.psm1|\.vbs|\.js|\.wsf|\.sh|\.bash|\.py|\.pl|\.rb|\.php|\.jsp|\.aspx|\.cgi|\.lua|\.sql|\.yml|\.yaml|\.json))') | groupby user, system

stream=ep-porcess where action="PROCESS_ADDED" and rlike(lower(commandline), "(netstat|ss\s+-(t|u|n|l|p)|nmap|tcpdump|wireshark|lsof|ip\s+addr|arp\s+-|iftop|netcat|nc\s|iptraf-ng|netdiscover|zenmap|nstat|tcpflow|get-nettcpconnection|get-netudpendpoint|test-netconnection|get-netadapter|get-netipaddress|get-netroute|resolve-dnsname|get-netneighbor|get-nettcpsetting|get-netfirewallrule|get-netfirewallprofile|get-netfirewalladdressfilter|get-netfirewallportfilter|get-netfirewallapplicationfilter|get-netfirewallsecurityfilter|get-netfirewallinterfacefilter)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(commandline), "(netstat|ss\\s+-(t|u|n|l|p)|nmap|tcpdump|wireshark|lsof|ip\\s+addr|arp\\s+-|iftop|netcat|nc\\s|iptraf-ng|netdiscover|zenmap|nstat|tcpflow|get-nettcpconnection|get-netudpendpoint|test-netconnection|get-netadapter|get-netipaddress|get-netroute|resolve-dnsname|get-netneighbor|get-nettcpsetting|get-netfirewallrule|get-netfirewallprofile|get-netfirewalladdressfilter|get-netfirewallportfilter|get-netfirewallapplicationfilter|get-netfirewallsecurityfilter|get-netfirewallinterfacefilter)") | duration 15m |  select system, user, commandline | limit 10000

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),"(net.*?user|wmic.*?useraccount.*?get|powershell.*?(get-localuser|get-localgroupmember|get-wmiobject.*?-class.*?win32_useraccount|get-aduser)|lusrmgr|query.*?user|net.*?localgroup.*?administrators|net.*?group.*?administrators|net.*?group|net.*?accounts|net.*?localgroup|net.*?view|dsquery.*?user|dsget.*?user|reg.*?query.*?profilelist)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),"(net.*?user|wmic.*?useraccount.*?get|powershell.*?(get-localuser|get-localgroupmember|get-wmiobject.*?-class.*?win32_useraccount|get-aduser)|lusrmgr|query.*?user|net.*?localgroup.*?administrators|net.*?group.*?administrators|net.*?group|net.*?accounts|net.*?localgroup|net.*?view|dsquery.*?user|dsget.*?user|reg.*?query.*?profilelist)") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline), "(runas|whoami.*?all|powershell.*get\-token|powershell.*invoke\-tokenmanipulation|mimikatz.*sekurlsa::logonpasswords|mimikatz.*token::elevate|mimikatz.*privilege::debug|set\-executionpolicy.*scope.*force|createprocessfromparent.*?get\-process.*?lsass)") and system="{TargetHost}" and user="{SuspectUser}" | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline), "(runas|whoami.*?all|powershell.*get\-token|powershell.*invoke\-tokenmanipulation|mimikatz.*sekurlsa::logonpasswords|mimikatz.*token::elevate|mimikatz.*privilege::debug|set\-executionpolicy.*scope.*force|createprocessfromparent.*?get\-process.*?lsass)") | groupby user, system, commandline

stream=ep-process where rlike(lower(commandline), "(remove.*?item.*?path|new-item.*?file created|get-childitem.*?recurse.*?file.*?where-object.*?match|get-item.*?path.*?get-itemproperty|get-winevent.*?logname.*?filterxpath.*?where-object.*?match|get-nettcpconnection.*?where-object)") | groupby user, system, commandline

stream=ep-process where rlike(lower(commandline), "(remove.*?item.*?path|new-item.*?file created|get-childitem.*?recurse.*?file.*?where-object.*?match|get-item.*?path.*?get-itemproperty|get-winevent.*?logname.*?filterxpath.*?where-object.*?match|get-nettcpconnection.*?where-object)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and not rlike(lower(ParentProcessName),('Windows.*?System32')) and (lower(commandline) like '%system32%' or lower(commandline) like '%syswow64%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and not rlike(lower(ParentProcessName),('Windows.*?System32') and (lower(commandline) like '%system32%' or lower(commandline) like '%syswow64%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and not rlike(lower(parentprocessname),('windows.*?system32') and (lower(commandline) like '%system32%' or lower(commandline) like '%syswow64%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and not rlike(lower(parentprocessname),('windows.*?system32') and (lower(commandline) like '%system32%' or lower(commandline) like '%syswow64%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(expand-archive.*?path.*?(|destinationpathforce|passthru|whatif|confirm)|add-type.*?assemblyname.*?extracttodirectory|decompressed_files.*?(\.mjs|\.js|\jsx|\json|\.ts|\.vue))') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(expand-archive.*?path.*?(|destinationpathforce|passthru|whatif|confirm)|add-type.*?assemblyname.*?extracttodirectory|decompressed_files.*?(\.mjs|\.js|\jsx|\json|\.ts|\.vue))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'(namedpipes_executor|namedpipes_server|namedpipes_client).*?--(pipe|server|client)' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'(namedpipes_executor|namedpipes_server|namedpipes_client).*?--(pipe|server|client)' | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") | groupby user, system, commandline 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") and user="{SuspectUser}" and system="{TargetHost}" | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED"  and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?ms-settings.*?(cmd|powershell)") | groupby user, system 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?ms-settings.*?(cmd|powershell)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action= 'PROCESS_ADDED' and (lower(image) like '%mavinject%' and rlike(lower(commandline), "mavinject.*?injectrunning.*?dll")) | groupby user, system

stream=ep-process where action= 'PROCESS_ADDED' and (lower(image) like '%mavinject%' and rlike(lower(commandline), "mavinject.*?injectrunning.*?dll")) | duration 1h and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and eid='1' and (lower(commandline) like '%radmin%viewer%radmin.exe%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and eid='1' and (lower(commandline) like '%radmin%viewer%radmin.exe%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%convertto-securestring%-force%new-selfsignedcertificate%-dnsname%-certstorelocation%get-childitem -path%export-pfxcertificate%-filepath%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (lower(commandline) like '%powershell.exe%convertto-securestring%-force%new-selfsignedcertificate%-dnsname%-certstorelocation%get-childitem -path%export-pfxcertificate%-filepath%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'software.*?microsoft.*?active setup.*?installed component') and rlike(lower(commandline), '(run|runonce|runonce.exe|\..*?alternateshellstartup)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'software.*?microsoft.*?active setup.*?installed component') and rlike(lower(commandline), '(run|runonce|runonce.exe|\..*?alternateshellstartup)') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'(expand-archive.*?\.zip.*?start-process.*?(\.exe|\.dll|\.txt|\.com|\.bat|\.cmd|\.ps1|\.psm1|\.vbs|\.js|\.wsf|\.sh|\.bash|\.py|\.pl|\.rb|\.php|\.jsp|\.aspx|\.cgi|\.lua|\.sql|\.yml|\.yaml|\.json))') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'(expand-archive.*?\.zip.*?start-process.*?(\.exe|\.dll|\.txt|\.com|\.bat|\.cmd|\.ps1|\.psm1|\.vbs|\.js|\.wsf|\.sh|\.bash|\.py|\.pl|\.rb|\.php|\.jsp|\.aspx|\.cgi|\.lua|\.sql|\.yml|\.yaml|\.json))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%new-smbshare%' or lower(commandline) like '%remove-smbshare%' or lower(commandline) like '%remove-psdrive%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%new-smbshare%' or lower(commandline) like '%remove-smbshare%' or lower(commandline) like '%remove-psdrive%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline),'adsisearcher.*?(objectclass=user|objectcategory=user|objectclass=computer|objectcategory=computer).*?(findall|findone)') or lower(commandline) like '%adsisearcher%objectcategory=organizationalunit%findall%path%' or lower(commandline) like '%adsisearcher%searchroot%path%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline),'adsisearcher.*?(objectclass=user|objectcategory=user|objectclass=computer|objectcategory=computer).*?(findall|findone)') or lower(commandline) like '%adsisearcher%objectcategory=organizationalunit%findall%path%' or lower(commandline) like '%adsisearcher%searchroot%path%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%get-aduser%remove-adgroupmember%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%get-aduser%remove-adgroupmember%') | groupby user, system

stream=authentication | duration 10m | limit 100

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) |  select system, user, commandline | limit 10000

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image like '%jsc.exe%' and rlike(lower(parentcommandline),'jsc.exe.*?(t:library.*?js|js)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and image like '%jsc.exe%' and rlike(lower(parentcommandline),'jsc.exe.*?(t:library.*?js|js)') | groupby system, user

stream=EP-FILE where action="FILE_CREATED" and rlike(lower(targetfilename),"\\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") | groupby substring_index(targetfilename,"\\",-1), targetfilename, user, system | select substring_index(targetfilename,"\\",-1) as file, targetfilename, user, system 

stream=EP-FILE where action="FILE_CREATED" and rlike(lower(targetfilename),"\\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") and targetfilename="{SuspectObject}" and user="{SuspectUser}" and system="{TargetHost}" | duraton 6m

stream=ep-process where action='PROCESS_CREATED' and rlike(lower(commandline), '([\'\w\']+\,)|(convert.*?tobase64string.*?unicode.getbytes|base64_encoded_script|obfuscatedcommand.*?-replace|get-random.*?-count.*?-join)') | groupby user, system

stream=ep-process where action='PROCESS_CREATED' and rlike(lower(commandline), '([\'\w\']+\,)|(convert.*?tobase64string.*?unicode.getbytes|base64_encoded_script|obfuscatedcommand.*?-replace|get-random.*?-count.*?-join)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and not rlike(lower(parentprocessname),('windows.*?(system32|syswow64)') and (lower(commandline) like '%system32%' or lower(commandline) like '%syswow64%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and not rlike(lower(parentprocessname),('windows.*?system32') and (lower(commandline) like '%system32%' or lower(commandline) like '%syswow64%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'python.*?.py.*?-i.*?[\d\.]+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'python.*?.py.*?-i.*?[\d\.]+') | groupby user, system 


stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), "start-process") and rlike(lower(commandline),"(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect|teamviewer|anydesk|logmein|gotoassist)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), "start-process") and rlike(lower(commandline),"(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect|teamviewer|anydesk|logmein|gotoassist)")) | duration 2h

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), "start-process") and rlike(lower(commandline),"(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect|teamviewer|anydesk|logmein|gotoassist)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), "start-process") and rlike(lower(commandline),"(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect|teamviewer|anydesk|logmein|gotoassist)")) | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%ppid-spoof%-ppid%' or lower(parentcommandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(parentcommandline) like '%ppid-spoof%-ppid%' or lower(parentcommandline) like '%powershell -ep bypass%wget%import-module%createprocessfromparent%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline),'(recon-ad-domain|recon-ad-users|recon-ad-groups|recon-ad-computers|recon-ad-spns|recon-ad-alllocalgroups|recon-ad-localgroups)') or rlike(lower(commandline),'(get-addomaincontroller -filter|get-adfinegrainedpasswordpolicy -filter|get-addefaultdomainpasswordpolicy|get-aduser.*?-properties|get-aduser -filter.*?-properties|get-adgroupmember -identity|get-adcomputer -filter|get-gpo -all)')) | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline),'(recon-ad-domain|recon-ad-users|recon-ad-groups|recon-ad-computers|recon-ad-spns|recon-ad-alllocalgroups|recon-ad-localgroups)') or rlike(lower(commandline),'(get-addomaincontroller -filter|get-adfinegrainedpasswordpolicy -filter|get-addefaultdomainpasswordpolicy|get-aduser.*?-properties|get-aduser -filter.*?-properties|get-adgroupmember -identity|get-adcomputer -filter|get-gpo -all)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'python.*?.py.*?-i.*?[\d\.]+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'python.*?.py.*?-i.*?[\d\.]+') | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'(compress-archive.*?-destinationpath|write-zip -inputpath.*?-outputpath)') or rlike(lower(commandline),'(scp\s+-i|copy-item|move-item|get-process.*?out-file|start-bitstransfer -source|send-sftpfile)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'(compress-archive.*?-destinationpath|write-zip -inputpath.*?-outputpath)') or rlike(lower(commandline),'(scp\s+-i|copy-item|move-item|get-process.*?out-file|start-bitstransfer -source|send-sftpfile)')) | select user, system, distinct_count(commandline) as distinct_command | groupby user, system | having distinct_command >= 2 | duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'(compress-archive.*?-destinationpath|write-zip -inputpath.*?-outputpath)') or rlike(lower(commandline),'(scp\s+-i|copy-item|move-item|get-process.*?out-file|start-bitstransfer -source|send-sftpfile)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'(compress-archive.*?-destinationpath|write-zip -inputpath.*?-outputpath)') or rlike(lower(commandline),'(scp\s+-i|copy-item|move-item|get-process.*?out-file|start-bitstransfer -source|send-sftpfile)')) | select user, system, distinct_count(commandline) as distinct_command | groupby user, system | having distinct_command >= 2 | duration 1h

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), "start-process") and rlike(lower(commandline),"(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect|teamviewer|anydesk|logmein|gotoassist)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), "start-process") and rlike(lower(commandline),"(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect|teamviewer|anydesk|logmein|gotoassist)")) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and not rlike(parentprocessname),'(Windows.*?(System32|SysWOW64))' and rlike(lower(commandline), '(.exe)') | groupby user, system | having count_col1 >= 10

stream=win-audit where action='PROCESS_CREATED' and not rlike(parentprocessname),'(Windows.*?(System32|SysWOW64))' and rlike(lower(commandline), '(.exe)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fsutil.exe%' and rlike(lower(commandline), '(fsutil\s+(usn|file).*?(deletejournal|createjournal|setzerodata))') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fsutil.exe%' and rlike(lower(commandline), '(fsutil\s+(usn|file).*?(deletejournal|createjournal|setzerodata))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'invoke-webrequest.*?-(useragent.*?httpbrowser/1.0|useragent.*?wget/1.9.*?stable|useragent.*?opera/8.81|useragent.*?<.*?>).*?out-null') or rlike(lower(commandline),'-s -a.*?(httpbrowser/1.0.*?-m3|wget/1.9.*?cvs-stable.*?-m3|opera/8.81.*?-m3|<.*?>.*?-m3)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'invoke-webrequest.*?-(useragent.*?httpbrowser/1.0|useragent.*?wget/1.9.*?stable|useragent.*?opera/8.81|useragent.*?<.*?>).*?out-null') or rlike(lower(commandline),'-s -a.*?(httpbrowser/1.0.*?-m3|wget/1.9.*?cvs-stable.*?-m3|opera/8.81.*?-m3|<.*?>.*?-m3)')) | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and ( lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%"  or lower(commandline) like "%appcmd%set%config%section%httplogging%dontlog%true%" or rlike(lower(commandline),"(hklm|hkey_local_machine).*?software.*?microsoft.*?iis.*?httplogging.*?logextfileflags.*?0"))  | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and ( lower(commandline) like "%set-webconfigurationproperty%pspath%filter%httplogging%dontlog%value%true%"  or lower(commandline) like "%appcmd%set%config%section%httplogging%dontlog%true%" or rlike(lower(commandline),"(hklm|hkey_local_machine).*?software.*?microsoft.*?iis.*?httplogging.*?logextfileflags.*?0")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '([\'\w\']+\,)|(convert.*?tobase64string.*?unicode.getbytes|base64_encoded_script|obfuscatedcommand.*?-replace|get-random.*?-count.*?-join)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '([\'\w\']+\,)|(convert.*?tobase64string.*?unicode.getbytes|base64_encoded_script|obfuscatedcommand.*?-replace|get-random.*?-count.*?-join)')  | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'(recon-ad-domain|recon-ad-users|recon-ad-groups|recon-ad-computers|recon-ad-spns|recon-ad-alllocalgroups|recon-ad-localgroups)') or rlike(lower(commandline),'(get-addomaincontroller -filter|get-adfinegrainedpasswordpolicy -filter|get-addefaultdomainpasswordpolicy|get-aduser.*?-properties|get-aduser -filter.*?-properties|get-adgroupmember -identity|get-adcomputer -filter|get-gpo -all)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'(recon-ad-domain|recon-ad-users|recon-ad-groups|recon-ad-computers|recon-ad-spns|recon-ad-alllocalgroups|recon-ad-localgroups)') or rlike(lower(commandline),'(get-addomaincontroller -filter|get-adfinegrainedpasswordpolicy -filter|get-addefaultdomainpasswordpolicy|get-aduser.*?-properties|get-aduser -filter.*?-properties|get-adgroupmember -identity|get-adcomputer -filter|get-gpo -all)')) | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'python.*?.py.*?-i.*?[\d\.]+') | groupby user, system


stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), "start-process") and rlike(lower(commandline),"(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect|teamviewer|anydesk|logmein|gotoassist)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), "start-process") and rlike(lower(commandline),"(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect|teamviewer|anydesk|logmein|gotoassist)")) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and not rlike(lower(parentprocessname),('windows.*?(system32|syswow64)') and rlike(lower(commandline), '(.exe)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and not rlike(lower(parentprocessname),'(C:.*?Windows.*?(System32|SysWOW64))') and rlike(lower(commandline), '(.exe)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and not rlike(parentprocessname),'(C:.*?Windows.*?(System32|SysWOW64))' and rlike(lower(commandline), '(.exe)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and not rlike(lower(parentprocessname),('windows.*?(system32|syswow64)') and rlike(lower(commandline), '(.exe)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and not rlike(parentprocessname),'(Windows.*?(System32|SysWOW64))' and rlike(lower(commandline), '(.exe)') | groupby user, system | having count_col1 >= 10

stream=win-audit where action='PROCESS_CREATED' and not rlike(parentprocessname),'(Windows.*?(System32|SysWOW64))' and rlike(lower(commandline), '(.exe)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%filename =%url =%file = new-item -force%-value%contenttype =%invoke-webrequest%-method put%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%filename =%url =%file = new-item -force%-value%contenttype =%invoke-webrequest%-method put%' | groupby user, system 

stream=win-audit where action in ('PROCESS_CREATED' , 'OBJECT_ACCESSED') and ((lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(commandline) like '%class%win32_logicaldisk%new-item%itemtype%') or (lower(scriptblocktext) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(scriptblocktext) like '%class%win32_logicaldisk%new-item%itemtype%')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED' , 'OBJECT_ACCESSED') and ((lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(commandline) like '%class%win32_logicaldisk%new-item%itemtype%') or (lower(scriptblocktext) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(scriptblocktext) like '%class%win32_logicaldisk%new-item%itemtype%')) | groupby system, user

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and ((rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)')) or (rlike(lower(scriptblocktext) like '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and ((rlike(lower(commandline), '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)')) or (rlike(lower(scriptblocktext) like '(hkcu|hkey_current_user|hklm|hkey_local_machine).*?software.*?(microsoft.*?windows.*currentversion|wow6432node.*?google.*?chrome.*?extensions)'))) | groupby system, user 

stream=win-audit where rlike(lower(commandline), '([\'\w\']+\,)|(convert.*?tobase64string.*?unicode.getbytes|base64_encoded_script|obfuscatedcommand.*?-replace|get-random.*?-count.*?-join)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where rlike(lower(commandline), '([\'\w\']+\,)|(convert.*?tobase64string.*?unicode.getbytes|base64_encoded_script|obfuscatedcommand.*?-replace|get-random.*?-count.*?-join)')  | groupby user, system

stream=ep-process where rlike(lower(commandline), "(remove.*?item.*?path|new-item.*?file created|get-childitem.*?recurse.*?file.*?where-object.*?match|get-item.*?path.*?get-itemproperty|get-winevent.*?logname.*?filterxpath.*?where-object.*?match|get-nettcpconnection.*?where-object)") | groupby user, system

stream=ep-process where rlike(lower(commandline), "(remove.*?item.*?path|new-item.*?file created|get-childitem.*?recurse.*?file.*?where-object.*?match|get-item.*?path.*?get-itemproperty|get-winevent.*?logname.*?filterxpath.*?where-object.*?match|get-nettcpconnection.*?where-object)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'python.*?.py.*?-i.*?[\d\.]+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'python.*?.py.*?-i.*?[\d\.]+') | groupby user, system


stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'python.*?.py.*?-i.*?[\d\.]+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'python.*?.py.*?-i.*?[\d\.]+') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and not rlike(lower(parentprocessname),('windows.*?(system32|syswow64)') and rlike(lower(commandline), '(.exe)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and not rlike(lower(parentprocessname),('windows.*?(system32|syswow64)') and rlike(lower(commandline), '(.exe)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%new-object%net.webclient%downloadstring%safedump%consoleoutput%noninteractive%') or (rlike(lower(commandline), '(hklm.*?software.*?microsoft.*?windo.*?currentversion.*?run|windo.*?system32.*?config|hklm.*?security.*?cache)')) or (rlike(lower(commandline), '(downloadstring|lsass.exe|keyscan_dump|keysscan_start|keyscan_stop|minidump|safedump|hashdump|ntds.dit|cachedlogons.kdt|services.xml|groups.xml)'))) | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like '%new-object%net.webclient%downloadstring%safedump%consoleoutput%noninteractive%') or (rlike(lower(commandline), '(hklm.*?software.*?microsoft.*?windo.*?currentversion.*?run|windo.*?system32.*?config|hklm.*?security.*?cache)')) or (rlike(lower(commandline), '(downloadstring|lsass.exe|keyscan_dump|keysscan_start|keyscan_stop|minidump|safedump|hashdump|ntds.dit|cachedlogons.kdt|services.xml|groups.xml)'))) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(python.*?.py.*?-i|nmap).*?[\d\.]+') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(python.*?.py.*?-i|nmap).*?[\d\.]+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(python.*?.py.*?-i|nmap).*?[\d\.]+') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(python.*?.py.*?-i|nmap).*?[\d\.]+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'(expand-archive.*?\.zip.*?start-process.*?(.exe|.dll|.com|.bat|.cmd|.ps1|.psm1|.vbs|.js|.wsf|.sh|.bash|.py|.pl|.rb|.php|.jsp|.aspx|.cgi|.lua|.sql|.yml|.yaml|.json))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'(expand-archive.*?\.zip.*?start-process.*?(.exe|.dll|.com|.bat|.cmd|.ps1|.psm1|.vbs|.js|.wsf|.sh|.bash|.py|.pl|.rb|.php|.jsp|.aspx|.cgi|.lua|.sql|.yml|.yaml|.json))') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'(copy|rename-item|ren).*?(.exe|.vbs|.ps1|.docx|.pdf|.ps1|.xls|.xlsx|.png|.doc|.pdf|.rtf)(.exe|.vbs|.ps1|.docx|.pdf|.ps1|.xls|.xlsx|.png|.doc|.pdf|.rtf)') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'(copy|rename-item|ren).*?(.exe|.vbs|.ps1|.docx|.pdf|.ps1|.xls|.xlsx|.png|.doc|.pdf|.rtf)(.exe|.vbs|.ps1|.docx|.pdf|.ps1|.xls|.xlsx|.png|.doc|.pdf|.rtf)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'(copy|rename-item|ren).*?(.exe|.vbs|.ps1|.docx|.pdf|.ps1|.xls|.xlsx|.png|.doc|.pdf|.rtf)(.exe|.vbs|.ps1|.docx|.pdf|.ps1|.xls|.xlsx|.png|.doc|.pdf|.rtf)') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'(copy|rename-item|ren).*?(.exe|.vbs|.ps1|.docx|.pdf|.ps1|.xls|.xlsx|.png|.doc|.pdf|.rtf)(.exe|.vbs|.ps1|.docx|.pdf|.ps1|.xls|.xlsx|.png|.doc|.pdf|.rtf)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(python.*?.py.*?-i|nmap).*?[\d\.]+') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(python.*?.py.*?-i|nmap).*?[\d\.]+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline),'(python.*?.py.*?-i|nmap).*?[\d\.]+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline),'(python.*?.py.*?-i|nmap).*?[\d\.]+') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(username.*?userdomainname|get-credential.*?message.*?(new-localuser.*?-password|-name.*?secret)|read-host.*?(-assecurestring|-prompt)|get-credential.*?message)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(username.*?userdomainname|get-credential.*?message.*?(new-localuser.*?-password|-name.*?secret)|read-host.*?(-assecurestring|-prompt)|get-credential.*?message)') | groupby system, user | duration 1h

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), "start-process") and rlike(lower(commandline),"(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect|teamviewer|anydesk|logmein|gotoassist)")) | duration 2h

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), "start-process.*?(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, 'C.*?(.zip.*exe|.rar.*exe|.7z.*exe|.tar.*exe|.zip|.rar|.7z|.tar|.dll|.bat|.msi)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(parentimage, '(cmd\\.exe|powershell\\.exe)') and  rlike(parentcommandline, 'C.*?(.zip.*exe|.rar.*exe|.7z.*exe|.tar.*exe|.zip|.rar|.7z|.tar|.dll|.bat|.msi)') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|winzip.*?-min -a -s|wzzip.*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|winzip.*?-min -a -s|wzzip.*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'schtasks.*?/create.*?(/f|/tn|/tr).*?frombase64string.*?get-itemproperty.*?(hkcu|hklm|registry::|hkey_current_user|hkey_local_machine)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'schtasks.*?/create.*?(/f|/tn|/tr).*?frombase64string.*?get-itemproperty.*?(hkcu|hklm|registry::|hkey_current_user|hkey_local_machine)') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'(invoke-webrequest -uri.*?\$chromium -outfile.*?chrome|start-process.*?chrome-win.*?chrome.exe --load-extension.*?passthru)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),'(invoke-webrequest -uri.*?\$chromium -outfile.*?chrome|start-process.*?chrome-win.*?chrome.exe --load-extension.*?passthru)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'rundll32.exe.*?(keymgr|krshowkeymgr)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'rundll32.exe.*?(keymgr|krshowkeymgr)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and lower(commandline) like "%mimikatz%lsadump::dcsync%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and lower(commandline) like "%mimikatz%lsadump::dcsync%" | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline),'(invoke-userhunter|find-domainuserlocation|invoke-bloodhound).*?-stealth)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline),'(invoke-userhunter|find-domainuserlocation|invoke-bloodhound).*?-stealth)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%get-childitem env:username%' or lower(commandline) like '%[system.environment]::username%' or lower(commandline) like '%$env:username%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%get-childitem env:username%' or lower(commandline) like '%[system.environment]::username%' or lower(commandline) like '%$env:username%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and lower(commandline) like "%dnsexfiltrator%" | groupby user, system 

stream=win-audit where action="PROCESS_CREATED" and lower(commandline) like "%dnsexfiltrator%" and user='{SuspectUser}' and system='{TragetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(username.*?userdomainname|get-credential.*?message.*?(new-localuser.*?-password|-name.*?secret)|read-host.*?(-assecurestring|-prompt)|get-credential.*?message)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(username.*?userdomainname|get-credential.*?message.*?(new-localuser.*?-password|-name.*?secret)|read-host.*?(-assecurestring|-prompt)|get-credential.*?message)') | groupby system, user | duration 1h

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline),'invoke-webrequest.*?-(useragent.*?httpbrowser/1.0|useragent.*?wget/1.9.*?stable|useragent.*?opera/8.81|useragent.*?<.*?>).*?out-null') or rlike(lower(commandline),'-s -a.*?(httpbrowser/1.0.*?-m3|wget/1.9.*?cvs-stable.*?-m3|opera/8.81.*?-m3|<.*?>.*?-m3)')) | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline),'invoke-webrequest.*?-(useragent.*?httpbrowser/1.0|useragent.*?wget/1.9.*?stable|useragent.*?opera/8.81|useragent.*?<.*?>).*?out-null') or rlike(lower(commandline),'-s -a.*?(httpbrowser/1.0.*?-m3|wget/1.9.*?cvs-stable.*?-m3|opera/8.81.*?-m3|<.*?>.*?-m3)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|winzip.*?-min -a -s|wzzip.*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((rar|rar.exe)\s+(a -r|a -hp)|winzip.*?-min -a -s|wzzip.*?-min -a -s|(7z|7z.exe|7zip|7zip.exe)\s+u.*?-p)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'invoke-cimmethod.*?-classname.*?-namespace.*?microsoft.*?windows.*?taskscheduler.*?-arguments.*?force\s+=\s+\$true') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'invoke-cimmethod.*?-classname.*?-namespace.*?microsoft.*?windows.*?taskscheduler.*?-arguments.*?force\s+=\s+\$true') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(invoke-webrequest -uri.*?\$chromium -outfile.*?chrome|start-process.*?chrome-win.*?chrome.exe --load-extension.*?passthru)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(invoke-webrequest -uri.*?\$chromium -outfile.*?chrome|start-process.*?chrome-win.*?chrome.exe --load-extension.*?passthru)') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), "start-process") and rlike(lower(commandline),"(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect|teamviewer|anydesk|logmein|gotoassist)")) | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), "start-process") and rlike(lower(commandline),"(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect|teamviewer|anydesk|logmein|gotoassist)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), "start-process") and rlike(lower(commandline),"(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect|teamviewer|anydesk|logmein|gotoassist)")) | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), "start-process") and rlike(lower(commandline),"(ammyy|remotepc|netsupport|ultraviewer|ultravnc|msp360connect|teamviewer|anydesk|logmein|gotoassist)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and ((lower(image) like "%msiexec%" and lower(commandline) like "%/i%screenconnect.msi%/qn%") or (lower(image) like "%powershell.exe%" and lower(commandline) like "%invoke%webrequest%screenconnect%release.msi%/i%/qn%")) | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and ((lower(image) like "%msiexec%" and lower(commandline) like "%/i%screenconnect.msi%/qn%") or (lower(image) like "%powershell.exe%" and lower(commandline) like "%invoke%webrequest%screenconnect%release.msi%/i%/qn%")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "cmdkey.*?(list|delete|add)") and user='{SuspectUser}' and system='{TragetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "cmdkey.*?(list|delete|add|pass)") | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'gsecdump.*?(-a|sam|cached|secrets|ntds|policy|lsa|kerberos)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'gsecdump.*?(-a|sam|cached|secrets|ntds|policy|lsa|kerberos)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'(new-item|new-itemproperty).*?-path hklm:.*?system.*?currentcontrolset.*?services.*?nppspy.*?(-name.*?-value|-name.*?-propertytype expandstring -value.*?system32.*?nppspy).*?-erroraction ignore') or rlike(lower(commandline),'get-itemproperty -path.*?(hkey_local_machine|hklm):.*?system.*?currentcontrolset.*?control.*?networkprovider.*?order.*?-name providerorder')) | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'(new-item|new-itemproperty).*?-path hklm:.*?system.*?currentcontrolset.*?services.*?nppspy.*?(-name.*?-value|-name.*?-propertytype expandstring -value.*?system32.*?nppspy).*?-erroraction ignore') or rlike(lower(commandline),'get-itemproperty -path.*?(hkey_local_machine|hklm):.*?system.*?currentcontrolset.*?control.*?networkprovider.*?order.*?-name providerorder')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and lower(commandline) like "%dnsexfiltrator%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and lower(commandline) like "%dnsexfiltrator%" | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(username.*?userdomainname|get-credential.*?message.*?(new-localuser.*?-password|-name.*?secret)|read-host.*?(-assecurestring|-prompt)|get-credential.*?message)') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(username.*?userdomainname|get-credential.*?message.*?(new-localuser.*?-password|-name.*?secret)|read-host.*?(-assecurestring|-prompt)|get-credential.*?message)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(send.*?mailmessage.*?from|emailitem.htmlbody|send email.*?from|invoke\-webrequest.*?uri|emailitem.attachments.add source|emailitem.send)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(send.*?mailmessage.*?from|emailitem.htmlbody|send email.*?from|invoke\-webrequest.*?uri|emailitem.attachments.add source|emailitem.send)') | groupby system, user

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline, "cmdkey.*?(list|delete|add|pass)") and user='{SupectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline, "cmdkey.*?(list|delete|add|pass)") | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'get-nettcpconnection -localport 3389.*?-state established') and rlike(lower(commandline),'rundll32.*?c:.*?system32.*?comsvcs.dll,\s+minidump.*?full')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'get-nettcpconnection -localport 3389.*?-state established') and rlike(lower(commandline),'rundll32.*?c:.*?system32.*?comsvcs.dll,\s+minidump.*?full')) | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'c:.*?windows.*?system32.*?inetsrv.*?appcmd.exe list apppool.*?(@t:*|@text:*|text:*|config)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'c:.*?windows.*?system32.*?inetsrv.*?appcmd.exe list apppool.*?(@t:*|@text:*|text:*|config)') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and lower(commandline) like "%mimikatz%lsadump::dcsync%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and lower(commandline) like "%mimikatz%lsadump::dcsync%" | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(procdump.*?-accepteula\s+(-ma|-mm).*?lsass.exe|rundll32.*?c:.*?windows.*?system32.*?comsvcs.dll.*?minidump.*?get-process\s+lsass.*?full|dumpert.exe|nanodump.x64.exe\s+-w|pypykatz.*?live\s+lsa|get-process\s+lsass.*?out-minidump|-u\s+-f.*?dotnet-lsass.dmp.*?get-process\s+lsass.*?id|xordump.*?-out.*?-x\s+0x41|rdrleakdiag|nanodump.x64.exe --silent-process-exit)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(procdump.*?-accepteula\s+(-ma|-mm).*?lsass.exe|rundll32.*?c:.*?windows.*?system32.*?comsvcs.dll.*?minidump.*?get-process\s+lsass.*?full|dumpert.exe|nanodump.x64.exe\s+-w|pypykatz.*?live\s+lsa|get-process\s+lsass.*?out-minidump|-u\s+-f.*?dotnet-lsass.dmp.*?get-process\s+lsass.*?id|xordump.*?-out.*?-x\s+0x41|rdrleakdiag|nanodump.x64.exe --silent-process-exit)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'reg\s+save.*?(hklm|hkey_local_machine).*?(sam|system|security).*?temp.*?(sam|system|security)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'reg\s+save.*?(hklm|hkey_local_machine).*?(sam|system|security).*?temp.*?(sam|system|security)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'pypykatz.*?(live\s+lsa|registry|registry.*?--sam.*?(--security|--o|--o.*?--json))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'pypykatz.*?(live\s+lsa|registry|registry.*?--sam.*?(--security|--o|--o.*?--json))') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((import-module|invoke).*?powerdump|get-passhashes|hashdump)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((import-module|invoke).*?powerdump|get-passhashes|hashdump)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((certutil\s+-(f|user|silent|split|p|t|v|nocr|nocrlf|csp|unicodetext).*?-(encodehex|dump|dumppfx|asn|decodehex|decode|encode))|system.io.file.*?::copy).*?windows.*?system32.*?config') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((certutil\s+-(f|user|silent|split|p|t|v|nocr|nocrlf|csp|unicodetext).*?-(encodehex|dump|dumppfx|asn|decodehex|decode|encode))|system.io.file.*?::copy).*?windows.*?system32.*?config')  | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(copy.*?windows.*?ntds.*?ntds.dit.*?ntds.dit|copy.*?windows.*?system32.*?config.*?system.*?vsc_system_hive|reg\s+save\s+hklm.*?system.*?system_hive)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(copy.*?windows.*?ntds.*?ntds.dit.*?ntds.dit|copy.*?windows.*?system32.*?config.*?system.*?vsc_system_hive|reg\s+save\s+hklm.*?system.*?system_hive)') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "at\s+\d+:\d+") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "at\\s+\\d+:\\d+") |  groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'get-childitem.*?-exclude copy.*?copy-item.*?-path.*?-destination.*?-recurse -force') or rlike(lower(commandline),'remove-item.*?-path.*?-recurse.*?-force')) and user='{SuspectUser}' and system='{TargetHost}' | duration 31m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'get-childitem.*?-exclude copy.*?copy-item.*?-path.*?-destination.*?-recurse -force') or rlike(lower(commandline),'remove-item.*?-path.*?-recurse.*?-force')) | duration 30m | select user, system, distinct_count(commandline) as distinct_command | groupby user, system | having distinct_command >= 2 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'get-childitem.*?-exclude copy.*?copy-item.*?-path.*?-destination.*?-recurse -force') or rlike(lower(commandline),'remove-item.*?-path.*?-recurse.*?-force')) and user='{SuspectUser}' and system='{TargetHost}' | duration 31m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'get-childitem.*?-exclude copy.*?copy-item.*?-path.*?-destination.*?-recurse -force') or rlike(lower(commandline),'remove-item.*?-path.*?-recurse.*?-force')) | duration 30m | select user, system, distinct_count(commandline) as distinct_command | groupby user, system | having distinct_command >= 2 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'get-childitem.*?-exclude copy.*?copy-item.*?-path.*?-destination.*?-recurse -force') or rlike(lower(commandline),'remove-item.*?-path.*?-recurse.*?-force')) and user='{SuspectUser}' and system='{TargetHost}' | duration 31m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'get-childitem.*?-exclude copy.*?copy-item.*?-path.*?-destination.*?-recurse -force') or rlike(lower(commandline),'remove-item.*?-path.*?-recurse.*?-force')) | duration 30m | select user, system, distinct_count(commandline) as distinct_command | groupby user, system | having distinct_command >= 2 

stream=WIN-AUDIT where rlike(lower(commandline),'(spoolvulnscan|ms17-10|bluekeep|fruit).*?-(noninteractive|consoleoutput)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and  rlike(lower(commandline),'(spoolvulnscan|ms17-10|bluekeep|fruit).*?-(noninteractive|consoleoutput)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%mavinject%usebasicparsing' | duration 1d | limit 10

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663', '4656') and rlike(lower(commandline), '(t1027_006_remote|myanchor.*?document.createelement.*?myanchor.download|myblob.*?new blob|myurl.*?window.url.createobjecturl.*?myanchor.href|myevilblob.*?new blob|url.createobjecturl)') | groupby system, user

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663', '4656') and rlike(lower(commandline), '(t1027_006_remote|myanchor.*?document.createelement.*?myanchor.download|myblob.*?new blob|myurl.*?window.url.createobjecturl.*?myanchor.href|myevilblob.*?new blob|url.createobjecturl)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(winpwn|samfile|dotnetsearch|kittielocal|uacbypass).*?-(consoleoutput|noninteractive|domainrecon|localrecon|powersharppack|browsercredentials)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(winpwn|samfile|dotnetsearch|kittielocal|uacbypass).*?-(consoleoutput|noninteractive|domainrecon|localrecon|powersharppack|browsercredentials)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline), "(netstat|ss\s+-(t|u|n|l|p)|nmap|tcpdump|wireshark|lsof|ip\s+addr|arp\s+-|iftop|netcat|nc\s|iptraf-ng|netdiscover|zenmap|nstat|tcpflow|get-nettcpconnection|get-netudpendpoint|test-netconnection|get-netadapter|get-netipaddress|get-netroute|resolve-dnsname|get-netneighbor|get-nettcpsetting|get-netfirewallrule|get-netfirewallprofile|get-netfirewalladdressfilter|get-netfirewallportfilter|get-netfirewallapplicationfilter|get-netfirewallsecurityfilter|get-netfirewallinterfacefilter)") and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline), "(netstat|ss\\s+-(t|u|n|l|p)|nmap|tcpdump|wireshark|lsof|ip\\s+addr|arp\\s+-|iftop|netcat|nc\\s|iptraf-ng|netdiscover|zenmap|nstat|tcpflow|get-nettcpconnection|get-netudpendpoint|test-netconnection|get-netadapter|get-netipaddress|get-netroute|resolve-dnsname|get-netneighbor|get-nettcpsetting|get-netfirewallrule|get-netfirewallprofile|get-netfirewalladdressfilter|get-netfirewallportfilter|get-netfirewallapplicationfilter|get-netfirewallsecurityfilter|get-netfirewallinterfacefilter)") | duration 15m |  select system, user, commandline | limit 10000

stream=win-audit |  groupby stream |  limit 1

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(c.*?windows.*?microsoft.net.*?framework64.*?(csc\.exe|csc|\.exe)|new-item.*?type.*?erroraction.*?invoke-webRequest)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(c.*?windows.*?microsoft.net.*?framework64.*?(csc\.exe|csc|\.exe)|new-item.*?type.*?erroraction)') | groupby system, user | duration 1w | limit 10

stream=EP-PROCESS where action="PROCESS_ADDED"  and rlike(lower(commandline), '(c.*?windows.*?microsoft.net.*?framework64.*?(csc\.exe|csc|\.exe)|new-item.*?type.*?erroraction)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED"  and rlike(lower(commandline), '(c.*?windows.*?microsoft.net.*?framework64.*?(csc\.exe|csc|\.exe)|new-item.*?type.*?erroraction)')  | groupby system, user 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(c.*?windows.*?microsoft.net.*?framework64.*?(csc\.exe|csc|\.exe)|new-item.*?type.*?erroraction)') | groupby system, user | duration 1w | limit 10

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(c.*?windows.*?microsoft.net.*?framework64.*?(csc\.exe|csc|\.exe)|new-item.*?type.*?erroraction)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(set-psreadlineoption.*?(-addtohistoryhandler|-historysavestyle).*?(\{\s+return\s+\$false\s+\}|savenothing))') or rlike(lower(commandline), '((remove-item|del).*?(get-psreadlineoption).historysavepath)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(set-psreadlineoption.*?(-addtohistoryhandler|-historysavestyle).*?(\{\s+return\s+\$false\s+\}|savenothing))') or rlike(lower(commandline), '((remove-item|del).*?(get-psreadlineoption).historysavepath)')) | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '((get-childitem|get-item).*?\.(creationtime|lastwritetime|lastaccesstime).*?\=))') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '((get-childitem|get-item).*?\.(creationtime|lastwritetime|lastaccesstime).*?\=))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '((get-childitem|get-item).*?(creationtime|lastwritetime|lastaccesstime))') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '((get-childitem|get-item).*?(creationtime|lastwritetime|lastaccesstime))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'ntdsutil.*?ac\s+i\s+ntds.*?ifm.*?create\s+full.*?q\s+q') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'ntdsutil.*?ac\s+i\s+ntds.*?ifm.*?create\s+full.*?q\s+q') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'psexec.*?-accepteula\s+-s\s+reg\s+save\s+(hklm|hkey_local_machine).*?security.*?policy') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'psexec.*?-accepteula\s+-s\s+reg\s+save\s+(hklm|hkey_local_machine).*?security.*?policy') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'((sc|schtasks).*?create.*?win32times)' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'((sc|schtasks).*?create.*?win32times)' |  groupby user, system

stream=win-audit |  groupby stream |  limit 1

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'get-childitem.*?-exclude copy.*?copy-item.*?-path.*?-destination.*?-recurse -force') or rlike(lower(commandline),'remove-item.*?-path.*?-recurse.*?-force')) and user='{SuspectUser}' and system='{TargetHost}' | duration 31m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'get-childitem.*?-exclude copy.*?copy-item.*?-path.*?-destination.*?-recurse -force') or rlike(lower(commandline),'remove-item.*?-path.*?-recurse.*?-force')) | duration 30m | select user, system, distinct_count(commandline) as distinct_command | groupby user, system | having distinct_command >= 2 

stream=WIN-AUDIT where action='PROCESS_CREATED' and  rlike(lower(commandline),'(spoolvulnscan|ms17-10|bluekeep|fruit).*?-(noninteractive|consoleoutput)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and  rlike(lower(commandline),'(spoolvulnscan|ms17-10|bluekeep|fruit).*?-(noninteractive|consoleoutput)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(expand-archive.*?path.*?(destinationpath|destinationpathforce|passthru|whatif|confirm)|add-type.*?assemblyname.*?extracttodirectory|decompressed_files.*?(\.mjs|\.js|\jsx|\json|\.ts|\.vue))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(expand-archive.*?path.*?(destinationpath|destinationpathforce|passthru|whatif|confirm)|add-type.*?assemblyname.*?extracttodirectory|decompressed_files.*?(\.mjs|\.js|\jsx|\json|\.ts|\.vue))') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(set\-psreadlineoption.*?(\-addtohistoryhandler|\-historysavestyle).*?(return.*?false|savenothing))') or rlike(lower(commandline), '((remove\-item|del).*?(get\-psreadlineoption)\.historysavepath)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(set\-psreadlineoption.*?(\-addtohistoryhandler|\-historysavestyle).*?(return.*?false|savenothing))') or rlike(lower(commandline), '((remove\-item|del).*?(get\-psreadlineoption)\.historysavepath)')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((get-childitem|get-item).*?(creationtime|lastwritetime|lastaccesstime))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((get-childitem|get-item).*?(creationtime|lastwritetime|lastaccesstime))') | groupby user, system, commandline, scriptblocktext

stream=ep-porcess where action="PROCESS_ADDED" and rlike(lower(commandline), "(netstat|ss\s+-(t|u|n|l|p)|nmap|tcpdump|wireshark|lsof|ip\s+addr|arp\s+-|iftop|netcat|nc\s|iptraf-ng|netdiscover|zenmap|nstat|tcpflow|get-nettcpconnection|get-netudpendpoint|test-netconnection|get-netadapter|get-netipaddress|get-netroute|resolve-dnsname|get-netneighbor|get-nettcpsetting|get-netfirewallrule|get-netfirewallprofile|get-netfirewalladdressfilter|get-netfirewallportfilter|get-netfirewallapplicationfilter|get-netfirewallsecurityfilter|get-netfirewallinterfacefilter)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(commandline), "(netstat|ss\\s+-(t|u|n|l|p)|nmap|tcpdump|wireshark|lsof|ip\\s+addr|arp\\s+-|iftop|netcat|nc\\s|iptraf-ng|netdiscover|zenmap|nstat|tcpflow|get-nettcpconnection|get-netudpendpoint|test-netconnection|get-netadapter|get-netipaddress|get-netroute|resolve-dnsname|get-netneighbor|get-nettcpsetting|get-netfirewallrule|get-netfirewallprofile|get-netfirewalladdressfilter|get-netfirewallportfilter|get-netfirewallapplicationfilter|get-netfirewallsecurityfilter|get-netfirewallinterfacefilter)") | duration 15m |  select system, user, commandline | limit 10000

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "at\\s+\\d+:\\d+") |  groupby user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(commandline, "at\s+\d+:\d+") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(parentcommandline),'((sc|schtasks).*?create.*?win32times)' and parentuser='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(parentcommandline),'((sc|schtasks).*?create.*?win32times)' | groupby parentuser, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(spoolvulnscan|ms17-10|bluekeep|fruit).*?-noninteractive\s+-consoleoutput') | groupby user, system

stream=win-audit |  groupby stream |  limit 1

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(reg\s+add.*?services.*?lanmanserver.*?parameters.*?(autosharewks|autoshareserver).*?reg\_dword.*?0)') or rlike(lower(commandline), '(new-itemproperty.*?(autosharewks|autoshareserver).*?aervices.*?lanmanserver.*?parameters.*?\-type\s+dword\s+-value\s+0)')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(reg\s+add.*?services.*?lanmanserver.*?parameters.*?(autosharewks|autoshareserver).*?reg\_dword.*?0)') or rlike(lower(commandline), '(new-itemproperty.*?(autosharewks|autoshareserver).*?aervices.*?lanmanserver.*?parameters.*?\-type\s+dword\s+-value\s+0)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(reg\s+add.*?services.*?lanmanserver.*?parameters.*?(autosharewks|autoshareserver).*?reg\_dword.*?0)') or rlike(lower(commandline), '(new-itemproperty.*?(autosharewks|autoshareserver).*?aervices.*?lanmanserver.*?parameters.*?\-type\s+dword\s+-value\s+0)')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(reg\s+add.*?services.*?lanmanserver.*?parameters.*?(autosharewks|autoshareserver).*?reg\_dword.*?0)') or rlike(lower(commandline), '(new-itemproperty.*?(autosharewks|autoshareserver).*?aervices.*?lanmanserver.*?parameters.*?\-type\s+dword\s+-value\s+0)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'((sc|schtasks).*?create.*?win32times)' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'((sc|schtasks).*?create.*?win32times)' |  groupby user, system

stream=firewall |  groupby stream |  limit 1

stream=win-audit |  groupby stream |  limit 1

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'get-childitem.*?-exclude copy.*?copy-item.*?-path.*?-destination.*?-recurse -force') or rlike(lower(commandline),'get-childitem.*?-path.*?add-content.*?-path.*?-erroraction')) | duration 30m | select user, system, distinct_count(commandline) as distinct_command | groupby user, system | having distinct_command >= 2 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'get-childitem.*?-exclude copy.*?copy-item.*?-path.*?-destination.*?-recurse -force') or rlike(lower(commandline),'get-childitem.*?-path.*?add-content.*?-path.*?-erroraction')) and user='{SuspectUser}' and system='{TargetHost}' | duration 31m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(net localgroup.*?net (list|group).*?(domain|net group.*?domain_controllers|domain_admin|domain_users|domain_guests)|get-(localgroupmember|adgroup|adgroupmember|acl))') | duration 2h | limit 10 

stream=ep-process where action='PROCESS_ADDED' and (lower(image) like '%powershell%' and lower(commandline) like '%get-keystrokes%-logpath%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(image) like '%powershell%' and lower(commandline) like '%get-keystrokes%-logpath%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(net localgroup.*?net (list|group).*?(domain|net group.*?domain_controllers|domain_admin|domain_users|domain_guests)|get-(localgroupmember|adgroup|adgroupmember|acl))') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(net localgroup.*?net (list|group).*?(domain|net group.*?domain_controllers|domain_admin|domain_users|domain_guests)|get-(localgroupmember|adgroup|adgroupmember|acl))') | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and (lower(image) like '%powershell%' and lower(commandline) like '%get-keystrokes%-logpath%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(image) like '%powershell%' and lower(commandline) like '%get-keystrokes%-logpath%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(image) like '%powershell%' and lower(commandline) like '%get-keystrokes%-logpath%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(image) like '%powershell%' and lower(commandline) like '%get-keystrokes%-logpath%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(takeown.*?/f|icacls.*?/grant.*?:f|icacls.*grant everyone:f)') or  rlike(lower(commandline), "attrib.*?(\\+h|\\-r)")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(takeown.*?/f|icacls.*?/grant.*?:f|icacls.*grant everyone:f)') or  rlike(lower(commandline), "attrib.*?(\\+h|\\-r)")) | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and lower(commandline) like '%net user%guest%/active:yes%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and lower(commandline) like '%net user%guest%/active:yes%' | groupby user, system

stream=* where commandline like '%Discovery.bat%' | duration 1h

stream=ep-process where action='PROCESS_ADDED' and  lower(commandline) like '%invoke-webrequest%discovery%' | duration 1h

stream=ep-process where action='PROCESS_ADDED' and  lower(commandline) like '%invoke-webrequest%discovery.bat%' | groupby user, system |duration 1h

stream=ep-process where action='PROCESS_ADDED' and  lower(commandline) like '%invoke-webrequest%discovery.bat%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and  lower(commandline) like '%invoke-webrequest%discovery.bat%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and  lower(commandline) like '%invoke-webrequest%discovery.bat%' | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and  lower(commandline) like '%invoke-webrequest%discovery.bat%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%invoke-webrequest%discovery.bat%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and  lower(commandline) like '%invoke-webrequest%discovery.bat%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%invoke-webrequest%discovery.bat%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Compress-Archive%TEMP%Folder_to_zip.zip%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'compress-archive.*?-path.*?-destinationpath.*?(\\$env:temp|temp)') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'compress-archive.*?-path.*?-destinationpath.*?(\\$env:temp|temp)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'compress-archive.*?-path.*?-destinationpath.*?(\\$env:temp|temp)') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'compress-archive.*?-path.*?-destinationpath.*?(\\$env:temp|temp)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'compress-archive.*?-path.*?-destinationpath.*?(\\$env:temp|temp)') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(net localgroup.*?net (list|group).*?(domain|net group.*?domain_controllers|domain_admin|domain_users|domain_guests)|get-(localgroupmember|adgroup|adgroupmember|acl))') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(net localgroup.*?net (list|group).*?(domain|net group.*?domain_controllers|domain_admin|domain_users|domain_guests)|get-(localgroupmember|adgroup|adgroupmember|acl))') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'compress-archive.*?-path.*?-destinationpath.*?(\\$env:temp|temp)') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'compress-archive.*?-path.*?-destinationpath.*?(\\$env:temp|temp)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline), '.*?reg.*?add.*?hklm.*?system.*?currentcontrolset.*?control.*?terminal server.*?(allow|fdeny).*?tsconnections.*?reg_dword') | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline), '.*?reg.*?add.*?hklm.*?system.*?currentcontrolset.*?control.*?terminal server.*?(allow|fdeny).*?tsconnections.*?reg_dword') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and lower(parentcommandline) like '%start-process%notepad%injectcontext%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and lower(parentcommandline) like '%start-process%notepad%injectcontext%' | groupby user, system 

stream=authentication where action="LOGIN" and status="FAILED" | groupby user |  having count_col1>1000

stream=win-audit where commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%Verbose%' or commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%ComputerName%' or rlike(lower(commandline), 'get-adprincipalgroupmembership.*?(authtype|credential|identity|partition|resourcecontextpartition|resourcecontextserver|server|commonparameters)|get-adcomputer|get-localgroupmember') | duration 1d

stream=win-audit where commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%Verbose%' or commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%ComputerName%' or rlike(lower(commandline), 'get-adprincipalgroupmembership.*?(authtype|credential|identity|partition|resourcecontextpartition|resourcecontextserver|server|commonparameters)|get-adcomputer|get-localgroupmember') | groupby system, user 

stream=win-audit where commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%Verbose%' or commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%ComputerName%' or rlike(lower(commandline), 'get-adprincipalgroupmembership.*?(authtype|credential|identity|partition|resourcecontextpartition|resourcecontextserver|server|commonparameters)|get-adcomputer|get-localgroupmember') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=authentication where user!=""|  duration from 2024-06-20T12:00:00 to 2024-06-21T00:00:00 |  groupby user,action,status

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), '.*?reg.*?add.*?hklm.*?system.*?currentcontrolset.*?control.*?terminal server.*?(allow|fdent).*?tsconnections.*?reg_dword'

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), '.*?reg.*?add.*?hklm.*?system.*?currentcontrolset.*?control.*?terminal server.*?(allow|fdeny).*?tsconnections.*?reg_dword') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg%add%hklm%system%CurrentControlSet%Control%Terminal Server%AllowTSConnections%REG_DWORD%' or commandline like '%reg%add%hklm%system%CurrentControlSet%Control%Terminal Server%fDenyTSConnections%REG_DWORD%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and lower(parentcommandline) like '%start-process%notepad%injectcontext%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%net user%guest%/active:yes%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%net user%guest%/active:yes%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%Verbose%' or commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%ComputerName%' or rlike(lower(commandline), 'get-adprincipalgroupmembership.*?(authtype|credential|identity|partition|resourcecontextpartition|resourcecontextserver|server|commonparameters)|get-adcomputer|get-localgroupmember') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%Verbose%' or commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%ComputerName%' or rlike(lower(commandline), 'get-adprincipalgroupmembership.*?(authtype|credential|identity|partition|resourcecontextpartition|resourcecontextserver|server|commonparameters)|get-adcomputer|get-localgroupmember') | select system, user, commandline

stream=win-audit where commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%Verbose%' or commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%ComputerName%' or rlike(lower(commandline), 'get-adprincipalgroupmembership.*?(authtype|credential|identity|partition|resourcecontextpartition|resourcecontextserver|server|commonparameters)|get-adcomputer|get-localgroupmember') | select system, user, commandline | duration 15m

stream=win-audit where commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%Verbose%' or commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%ComputerName%' or rlike(lower(commandline), 'get-adprincipalgroupmembership.*?(authtype|credential|identity|partition|resourcecontextpartition|resourcecontextserver|server|commonparameters)|get-adcomputer|get-localgroupmember') and system='{TargetHost}' and user='{SuspectUser}' | duration 15m

stream=win-audit where commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%Verbose%' or commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%ComputerName%' or rlike(lower(commandline), 'get-adprincipalgroupmembership.*?(authtype|credential|identity|partition|resourcecontextpartition|resourcecontextserver|server|commonparameters)|get-adcomputer|get-localgroupmember') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%Verbose%' or commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%ComputerName%' or rlike(lower(commandline), 'get-adprincipalgroupmembership.*?(authtype|credential|identity|partition|resourcecontextpartition|resourcecontextserver|server|commonparameters)|get-adcomputer|get-localgroupmember') | select system, user, commandline

stream=win-audit where commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%Verbose%' or commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%ComputerName%' or rlike(lower(commandline), '(get-adcomputer|get-localgroupmember|get-adprincipalgroupmembership).*?(authtype|credential|identity|partition|resourcecontextpartition|resourcecontextserver|server|commonparameters)') or rlike(lower(commandline),'(get-domaingroup|get-domaingroupmember).*?(-domaingroup|-identity|-memberidentity|-admincount|-domain|-ldapfilter|-properties|-searchbase|-server|-searchscope|-resultpagesize|-servertimelimit|-securitymasks|-tombstone|-findone|-credential|-raw)') | select system, user, commandline

stream=win-audit where commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%Verbose%' or commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%ComputerName%' or rlike(lower(commandline), '(get-adcomputer|get-localgroupmember|get-adprincipalgroupmembership).*?(authtype|credential|identity|partition|resourcecontextpartition|resourcecontextserver|server|commonparameters)') or rlike(lower(commandline),'(get-domaingroup|get-domaingroupmember).*?(-domaingroup|-identity|-memberidentity|-admincount|-domain|-ldapfilter|-properties|-searchbase|-server|-searchscope|-resultpagesize|-servertimelimit|-securitymasks|-tombstone|-findone|-credential|-raw)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where commandline like '%ldifde%-f%-p%' or rlike(lower(commandline), 'get-aduser.*?properties|adsisearcher.*?objectcategory.*?group.*?(findall|findone)|get-adgroup.*?(-authtype|-credential|-identit|-filter|-ldapfilter|-properties)|adfind.*?-f.*?list') | duration 1h

stream=win-audit where commandline like '%ldifde%-f%-p%' or rlike(lower(commandline), 'get-aduser.*?properties|adsisearcher.*?objectcategory.*?group.*?(findall|findone)|get-adgroup.*?(-authtype|-credential|-identit|-filter|-ldapfilter|-properties)|adfind.*?-f.*?list') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where commandline like '%ldifde%-f%-p%' or rlike(lower(commandline), 'get-aduser.*?properties|adsisearcher.*?objectcategory.*?group.*?(findall|findone)|get-adgroup.*?(-authtype|-credential|-identit|-filter|-ldapfilter|-properties)|adfind.*?-f.*?list') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), '.*?reg.*?add.*?hklm.*?system.*?currentcontrolset.*?control.*?terminal server.*?(allow|fdeny).*?tsconnections.*?reg_dword') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), '.*?reg.*?add.*?hklm.*?system.*?currentcontrolset.*?control.*?terminal server.*?(allow|fdeny).*?tsconnections.*?reg_dword') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and lower(parentcommandline) like '%start-process%notepad%injectcontext%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and lower(parentcommandline) like '%start-process%notepad%injectcontext%' | groupby user, system | duration1h

stream=firewall where action="PACKET_BLOCKED" |  groupby srcip | having count_col1>=50

stream=win-audit where commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%Verbose%' or commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%ComputerName%' or rlike(lower(commandline), '(get-adcomputer|get-localgroupmember|get-adprincipalgroupmembership).*?(authtype|credential|identity|partition|resourcecontextpartition|resourcecontextserver|server|commonparameters)') or rlike(lower(commandline),'(get-domaingroup|get-domaingroupmember|get-domainuser|get-domaincomputer|get-domaintrust|get-domainpolicy|get-domainobjectacl|get-domaincontroller).*?(-domaingroup|-identity|-memberidentity|-admincount|-domain|-ldapfilter|-properties|-searchbase|-server|-searchscope|-resultpagesize|-servertimelimit|-securitymasks|-tombstone|-findone|-credential|-raw)') | select system, user, commandline

stream=win-audit where commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%Verbose%' or commandline like '%Net.ServicePointManager%SecurityProtocol%UseBasicParsing%ComputerName%' or rlike(lower(commandline), '(get-adcomputer|get-localgroupmember|get-adprincipalgroupmembership).*?(authtype|credential|identity|partition|resourcecontextpartition|resourcecontextserver|server|commonparameters)') or rlike(lower(commandline),'(get-domaingroup|get-domaingroupmember|get-domainuser|get-domaincomputer|get-domaintrust|get-domainpolicy|get-domainobjectacl|get-domaincontroller).*?(-domaingroup|-identity|-memberidentity|-admincount|-domain|-ldapfilter|-properties|-searchbase|-server|-searchscope|-resultpagesize|-servertimelimit|-securitymasks|-tombstone|-findone|-credential|-raw)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '((get-childitem|get-item).*?(creationtime|astwritetime|astaccesstime))') or rlike(lower(commandline), '(timestomp)' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '((get-childitem|get-item).*?(creationtime|astwritetime|astaccesstime))') or rlike(lower(commandline), '(timestomp)' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and rlike(lower(commandline), "(vboxsvc.*?reregserver|regsvr32.*?virtualbox.*?vboxc.dll|(sc create|sc create).*?vboxdrv)") or rlike(lower(commandline), "(vboxmanage.*?(createvm --name|modifyvm|startvm)|(new-vm|set-vmfirmware|start-vm))") | groupby user, system and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and rlike(lower(commandline), "(vboxsvc.*?reregserver|regsvr32.*?virtualbox.*?vboxc.dll|(sc create|sc start).*?vboxdrv)") or rlike(lower(commandline), "(vboxmanage.*?(createvm --name|modifyvm|startvm)|(new-vm|set-vmfirmware|start-vm))") | groupby user, system

stream=*  | groupby eventid  | select eventid, count() as count  | _sort by count DESC  | limit 10

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline), '.*?reg.*?add.*?hklm.*?system.*?currentcontrolset.*?control.*?terminal server.*?(allow|fdeny).*?tsconnections.*?reg_dword') | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline), '.*?reg.*?add.*?hklm.*?system.*?currentcontrolset.*?control.*?terminal server.*?(allow|fdeny).*?tsconnections.*?reg_dword') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and lower(commandline) like '%net user%guest%/active:yes%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and lower(commandline) like '%net user%guest%/active:yes%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%net user%guest%/active:yes%'and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%net user%guest%/active:yes%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and lower(parentcommandline) like '%start-process%notepad%injectcontext%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and lower(parentcommandline) like '%start-process%notepad%injectcontext%' | groupby user, system | duration1h

stream=win-audit where action='PROCESS_CREATED' and (rlike(commandline, '(takeown.exe|icacls.exe.*grant|icacls.*grant Everyone:F)') or rlike(commandline, '(attrib.exe -r|mkdir.*?echo.*?attrib.exe)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(takeown.*?/f|icacls.*?/grant.*?:f|icacls.*grant everyone:f)') or  rlike(lower(commandline), "attrib.*?(\\+h|\\-r)")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(takeown.*?/f|icacls.*?/grant.*?:f|icacls.*grant everyone:f)') or  rlike(lower(commandline), "attrib.*?(\\+h|\\-r)")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(takeown.*?/f|icacls.*?/grant.*?:f|icacls.*grant everyone:f)') or  rlike(lower(commandline), "attrib.*?(\\+h|\\-r)")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%reg add%hklm%software%microsoft%.netframework%etwenabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%.netframework%etwenabled%' or lower(commandline) like '%reg add%hklm%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%' or lower(commandline) like '%-accepteula%-i%logman update trace%-p%-ets%' | duration 1d

stream=win-audit where  lower(logevent) like "%encoded%"| duration 10d | select regexp_extract(commandline, "\\-EncodedCommand\\s(\\S+)", 1) as commandline, regexp_extract(scriptblocktext, "\\-EncodedCommand\\s(\\S+)", 1) as scriptblocktext | limit 10

stream=win-audit where action='OBJECT_ACCESSED' and (rlike(lower(scriptblocktext), 'netsh\s+interface\s+portproxy\s+add\s+v4tov4') or rlike(lower(scriptblocktext), 'new-netfirewallrule.*-protocol\s+tcp\s+-localport.*-action\s+allow') or rlike(lower(scriptblocktext), 'add-netnatstaticmapping.*-protocol\s+tcp.*-externalport.*-internalport')) | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (rlike(lower(scriptblocktext), 'netsh\s+interface\s+portproxy\s+add\s+v4tov4') or rlike(lower(scriptblocktext), 'new-netfirewallrule.*-protocol\s+tcp\s+-localport.*-action\s+allow') or rlike(lower(scriptblocktext), 'add-netnatstaticmapping.*-protocol\s+tcp.*-externalport.*-internalport')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(icmpsh\_m|nc|ncat|powercat)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(icmpsh\_m|nc|ncat|powercat)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(dirlister\.)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(dirlister\.)') | groupby user, system

stream=ep-process where eid = '10' | duration 1d |  groupby @SourceImage , system , user

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Remove-Item%$env:TEMP%windows-credentials.txt%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%windows-credentials.txt%' or rlike(lower(commandline), '(appdata*?local.*?microsoft.*?credentials|appdata.*?roaming.*?microsoft.*?credentials|-credentials.*?-target.*?-persist localmachine|-module.*?credentialmanager)') | groupby user,system

stream=win-audit where lower(commandline) like '%systemrestore%' | duration 1d

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), 'netsh\s+interface\s+portproxy\s+add\s+v4tov4') or rlike(lower(commandline), 'new-netfirewallrule.*-protocol\s+tcp\s+-localport.*-action\s+allow') or rlike(lower(commandline), 'add-netnatstaticmapping.*-protocol\s+tcp.*-externalport.*-internalport')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), 'netsh\s+interface\s+portproxy\s+add\s+v4tov4') or rlike(lower(commandline), 'new-netfirewallrule.*-protocol\s+tcp\s+-localport.*-action\s+allow') or rlike(lower(commandline), 'add-netnatstaticmapping.*-protocol\s+tcp.*-externalport.*-internalport')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(dirlister\.)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(dirlister\.)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where eid = '1' | duration 1d  | checkif image in dropped_file_store.dropped_file

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%windows-credentials.txt%' or rlike(lower(commandline), '(appdata*?local.*?microsoft.*?credentials|appdata.*?roaming.*?microsoft.*?credentials|-credentials.*?-target.*?-persist localmachine|-module.*?credentialmanager)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%windows-credentials.txt%' or rlike(lower(commandline), '(appdata*?local.*?microsoft.*?credentials|appdata.*?roaming.*?microsoft.*?credentials|-credentials.*?-target.*?-persist localmachine|-module.*?credentialmanager)') | groupby user,system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%windows-credentials.txt%' or rlike(lower(commandline), '(appdata*?local.*?microsoft.*?credentials|appdata.*?roaming.*?microsoft.*?credentials|-credentials.*?-target.*?-persist localmachine|-module.*?credentialmanager)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%windows-credentials.txt%' or rlike(lower(commandline), '(appdata*?local.*?microsoft.*?credentials|appdata.*?roaming.*?microsoft.*?credentials|-credentials.*?-target.*?-persist localmachine|-module.*?credentialmanager)') | groupby user,system

stream=win-audit where action="PROCESS_CREATED" and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) | duration 15m | select system, user, commandline | limit 10000

stream=win-audit where action="PROCESS_CREATED" and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=win-audit where rlike(lower(commandline), "((export-certificate|export-pfxcertificate).*?cert.*?filepath.*?(cer|cert.pfx|pfx)|certutil.*?store.*?cer|certutil.*?exportpfx.*?(cert.pfx|pfx))") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where rlike(lower(commandline), "((export-certificate|export-pfxcertificate).*?cert.*?filepath.*?(cer|cert.pfx|pfx)|certutil.*?store.*?cer|certutil.*?exportpfx.*?(cert.pfx|pfx))") | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(parentcommandline), 'netsh\s+interface\s+portproxy\s+add\s+v4tov4') or rlike(lower(parentcommandline), 'new-netfirewallrule.*-protocol\s+tcp\s+-localport.*-action\s+allow') or rlike(lower(parentcommandline), 'add-netnatstaticmapping.*-protocol\s+tcp.*-externalport.*-internalport')) | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(parentcommandline), 'netsh\s+interface\s+portproxy\s+add\s+v4tov4') or rlike(lower(parentcommandline), 'new-netfirewallrule.*-protocol\s+tcp\s+-localport.*-action\s+allow') or rlike(lower(parentcommandline), 'add-netnatstaticmapping.*-protocol\s+tcp.*-externalport.*-internalport')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%net use%ipc$%/user%" or lower(commandline) like "%invoke-domainpasswordspray%" or lower(commandline) like "%winpwn%domainpassspray%" or lower(commandline) like "%invoke-dpslight%usersdpslight%") | duration 2h

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net use%IPC%' or commandline like '%DomainPasswordSpray%' or commandline like '%usersdpsLight%' or commandline like '%kerbrute.exe%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%net use%ipc$%/user%" or lower(commandline) like "%invoke-domainpasswordspray%" or lower(commandline) like "%winpwn%domainpassspray%" or lower(commandline) like "%invoke-dpslight%usersdpslight%") | duration 2h

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%net use%ipc$%/user%" or lower(commandline) like "%invoke-domainpasswordspray%" or lower(commandline) like "%winpwn%domainpassspray%" or lower(commandline) like "%invoke-dpslight%usersdpslight%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) | duration 15m | select system, user, commandline | limit 10000

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), "(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), "(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'rundll32.exe.*?(keymgr|krshowkeymgr)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'rundll32.exe.*?(keymgr|krshowkeymgr)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'get-nettcpconnection -localport 3389.*?-state established') and rlike(lower(commandline),'rundll32.*?c:.*?system32.*?comsvcs.dll,\s+minidump.*?full')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'get-nettcpconnection -localport 3389.*?-state established') and rlike(lower(commandline),'rundll32.*?c:.*?system32.*?comsvcs.dll,\s+minidump.*?full')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(psiphon\$.*python\s+psi\_client\.py)') or rlike(lower(commandline), '(docker\s+(run|start).*psiphon)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), '(psiphon\$.*python\s+psi\_client\.py)') or rlike(lower(commandline), '(docker\s+(run|start).*psiphon)')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(dirlister\.)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(dirlister\.)') | groupby user, system

stream=ep-process where eid = '10' | duration 1d |  groupby @SourceImage , system , user

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net use%IPC%' or commandline like '%DomainPasswordSpray%' or commandline like '%usersdpsLight%' or commandline like '%kerbrute.exe%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%net use%ipc$%/user%" or lower(commandline) like "%invoke-domainpasswordspray%" or lower(commandline) like "%winpwn%domainpassspray%" or lower(commandline) like "%invoke-dpslight%usersdpslight%") | duration 2h

stream=win-audit where action="PROCESS_CREATED" and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) |  select system, user, commandline | limit 10000

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), ".*?(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") | groupby user, system | duration 1h

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), ".*?(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), "(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), "(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'c:.*?windows.*?system32.*?inetsrv.*?appcmd.exe list apppool.*?(@t:*|@text:*|text:*|config)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'c:.*?windows.*?system32.*?inetsrv.*?appcmd.exe list apppool.*?(@t:*|@text:*|text:*|config)') | groupby user, system

stream=authentication where (eid='4768' or eid='4769' or eid='4771' or eid='4776') and not user like '%$%' and not user like '%@%' | groupby user, system, action | duration 1d | limit 10

stream=iam where eid='4720' and not user like '%$%' and not user like '%@%'  | duration 7d |  groupby targetuser, displayname, user   | limit 10

stream=authentication where eid='4768' and not user like '%$%' and not user like '%@%' | groupby user, system, action | duration 7d | limit 10

stream=win-audit where (eid='5136' or eid='5137') and not user like '%$%' and not user like '%@%' | groupby user, objectclass | duration 7d | limit 10

stream=authentication where eid='4740' and not user like '%$%' and not user like '%@%' | groupby user | duration 7d | limit 10

stream=authentication where eid='4771' and not user like '%$%' and not user like '%@%' | groupby user, system | duration 7d | limit 10

stream=iam where (eid='4728' or eid='4729' or eid='4732' or eid='4733') and not user like '%$%' and not user like '%@%'  | duration 7d |  groupby group, user, action, membername | limit 10

stream=iam where (eid='4723' or eid='4724') and not user like '%$%' and not user like '%@%' | groupby targetUser, user | duration 7d | limit 10

stream=ep-image-load |  duration 1h | checkif image in dropped_file_store.dropped_file |  groupby system, user , signed, imageloaded

stream=iam where eid IN (4728,4732,4756) | groupby cnamtime, eid, user, group, action |  duration 7d

stream=ep-file where eid='11'| duration 1d |  groupby system , user, image, targetfilename, systemtstamp | select system, user, image as dropper_process, targetfilename as dropped_file, systemtstamp as file_creation_time 

stream=ep-network where eid = '3' | duration 1h  | checkif image in dropped_file_store.dropped_file |  groupby system, user , image , dstip , dstport

stream=ep-process where eid = '10' | duration 1d |  groupby @SourceImage , system , user

stream=ep-process where eid = '1' | duration 1h  | checkif image in dropped_file_store.dropped_file

stream=iam where eid='4720' and not user like '%$%' and not user like '%@%'  | duration 7d |  groupby targetuser, displayname, user   | limit 10

stream=win-audit where (eid='5136' or eid='5137') and not user like '%$%' and not user like '%@%' | groupby user, objectclass | duration 7d | limit 10

stream=iam where (eid='4728' or eid='4729' or eid='4732' or eid='4733') and not user like '%$%' and not user like '%@%'  | duration 7d |  groupby group, user, action, membername | limit 10

stream=iam where (eid='4723' or eid='4724') and not user like '%$%' and not user like '%@%' | groupby targetUser, user | duration 7d | limit 10

stream=ep-process where eid = '10' | duration 1d |  groupby @SourceImage , system , user

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like "%kerbrute%-dc%-d%") and rlike(lower(commandline), "kerbrute.*?(bruteforce|userenum|passwordspray|bruteuser)")) | duration 1d

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like "%kerbrute%-dc%-d%") and rlike(lower(commandline), "kerbrute.*?(bruteforce|userenum|passwordspray|bruteuser)")) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like "%kerbrute%-dc%-d%") and rlike(lower(commandline), "kerbrute.*?(bruteforce|userenum|passwordspray|bruteuser)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like "%kerbrute%-dc%-d%") and rlike(lower(commandline), "kerbrute.*?(bruteforce|userenum|passwordspray|bruteuser)")) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like "%kerbrute%-dc%-d%") and rlike(lower(commandline), "kerbrute.*?(bruteforce|userenum|passwordspray|bruteuser)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%net use%ipc$%/user%" or lower(commandline) like "%invoke-domainpasswordspray%" or lower(commandline) like "%winpwn%domainpassspray%" or lower(commandline) like "%invoke-dpslight%usersdpslight%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%net use%ipc$%/user%" or lower(commandline) like "%invoke-domainpasswordspray%" or lower(commandline) like "%winpwn%domainpassspray%" or lower(commandline) like "%invoke-dpslight%usersdpslight%") | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) |  select system, user, commandline | limit 10000

stream=win-audit where action="PROCESS_CREATED" and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) |  select system, user, commandline | limit 10000

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'reg\s+save.*?(hklm|hkey_local_machine).*?(sam|system|security).*?temp.*?(sam|system|security)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'reg\s+save.*?(hklm|hkey_local_machine).*?(sam|system|security).*?temp.*?(sam|system|security)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like "%kerbrute%-dc%-d%") and rlike(lower(commandline), "kerbrute.*?(bruteforce|userenum|passwordspray|bruteuser)")) | duration 1d | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and ((lower(commandline) like "%kerbrute%-dc%-d%") and rlike(lower(commandline), "kerbrute.*?(bruteforce|userenum|passwordspray|bruteuser)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), ".*?(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), ".*?(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'reg\s+save.*?(hklm|hkey_local_machine).*?(sam|system|security).*?temp.*?(sam|system|security)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'reg\s+save.*?(hklm|hkey_local_machine).*?(sam|system|security).*?temp.*?(sam|system|security)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((import-module|invoke).*?powerdump|get-passhashes|hashdump)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((import-module|invoke).*?powerdump|get-passhashes|hashdump)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'ntdsutil.*?ac\s+i\s+ntds.*?ifm.*?create\s+full.*?q\s+q') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'ntdsutil.*?ac\s+i\s+ntds.*?ifm.*?create\s+full.*?q\s+q') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(copy.*?windows.*?ntds.*?ntds.dit.*?ntds.dit|copy.*?windows.*?system32.*?config.*?system.*?vsc_system_hive|reg\s+save\s+hklm.*?system.*?system_hive)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(copy.*?windows.*?ntds.*?ntds.dit.*?ntds.dit|copy.*?windows.*?system32.*?config.*?system.*?vsc_system_hive|reg\s+save\s+hklm.*?system.*?system_hive)') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and lower(commandline) like "%mimikatz%lsadump::dcsync%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and lower(commandline) like "%mimikatz%lsadump::dcsync%" | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline), 'get-nettcpconnection -localport 3389.*?-state established') and rlike(lower(commandline), 'rundll32.*?c:.*?system32.*?comsvcs.dll.*?minidump.*?full')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline), 'get-nettcpconnection -localport 3389.*?-state established') and rlike(lower(commandline), 'rundll32.*?c:.*?system32.*?comsvcs.dll.*?minidump.*?full')) | groupby user, system

stream=win-audit where action in ('PROCESS_CREATED' , 'OBJECT_ACCESSED') and ((lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(commandline) like '%class%win32_logicaldisk%new-item%itemtype%') or (lower(scriptblocktext) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(scriptblocktext) like '%class%win32_logicaldisk%new-item%itemtype%')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED' , 'OBJECT_ACCESSED') and ((lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(commandline) like '%class%win32_logicaldisk%new-item%itemtype%') or (lower(scriptblocktext) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(scriptblocktext) like '%class%win32_logicaldisk%new-item%itemtype%')) | groupby system, user

stream=win-audit where action in ('PROCESS_CREATED' , 'OBJECT_ACCESSED') and ((lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(commandline) like '%class%win32_logicaldisk%new-item%itemtype%') or (lower(scriptblocktext) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(scriptblocktext) like '%class%win32_logicaldisk%new-item%itemtype%')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED' , 'OBJECT_ACCESSED') and ((lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(commandline) like '%class%win32_logicaldisk%new-item%itemtype%') or (lower(scriptblocktext) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(scriptblocktext) like '%class%win32_logicaldisk%new-item%itemtype%')) | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), "(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), ".*?(get-clipboard|getclipboard|getfromclipboard|getdatafromclipboard|pastefromclipboard|vba_getclipboardata|clipboard.gettext|clipboard.getdata|-EncodedCommand)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'pypykatz.*?(live\s+lsa|registry|registry.*?--sam.*?(--security|--o|--o.*?--json))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'pypykatz.*?(live\s+lsa|registry|registry.*?--sam.*?(--security|--o|--o.*?--json))') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(winpwn|samfile|dotnetsearch|kittielocal|uacbypass).*?-(consoleoutput|noninteractive|domainrecon|localrecon|powersharppack|browsercredentials)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(winpwn|samfile|dotnetsearch|kittielocal|uacbypass).*?-(consoleoutput|noninteractive|domainrecon|localrecon|powersharppack|browsercredentials)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline, "cmdkey.*?(list|delete|add|pass)") and user='{SupectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline, "cmdkey.*?(list|delete|add|pass)") | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), 'reg.*?save.*?(hklm|hkey_local_machine).*?(sam|system|security).*?temp.*?(sam|system|security)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), 'reg.*?save.*?(hklm|hkey_local_machine).*?(sam|system|security).*?temp.*?(sam|system|security)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.*?-accepteula.*?-s.*?reg.*?save.*?(hklm|hkey_local_machine).*?security.*?policy') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.*?-accepteula.*?-s.*?reg.*?save.*?(hklm|hkey_local_machine).*?security.*?policy') | groupby user, system and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.*?-accepteula.*?-s.*?reg.*?save.*?(hklm|hkey_local_machine).*?security.*?policy') | groupby user, system and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.*?-accepteula.*?-s.*?reg.*?save.*?(hklm|hkey_local_machine).*?security.*?policy') | groupby user, system

stream=win-audit where action in ('PROCESS_CREATED' , 'OBJECT_ACCESSED') and ((lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(commandline) like '%class%win32_logicaldisk%new-item%itemtype%') or (lower(scriptblocktext) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(scriptblocktext) like '%class%win32_logicaldisk%new-item%itemtype%')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED' , 'OBJECT_ACCESSED') and ((lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(commandline) like '%class%win32_logicaldisk%new-item%itemtype%') or (lower(scriptblocktext) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(scriptblocktext) like '%class%win32_logicaldisk%new-item%itemtype%')) | groupby system, user

stream=win-audit where action in ('PROCESS_CREATED' , 'OBJECT_ACCESSED') and ((lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(commandline) like '%class%win32_logicaldisk%new-item%itemtype%') or (lower(scriptblocktext) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(scriptblocktext) like '%class%win32_logicaldisk%new-item%itemtype%')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED' , 'OBJECT_ACCESSED') and ((lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(commandline) like '%class%win32_logicaldisk%new-item%itemtype%') or (lower(scriptblocktext) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(scriptblocktext) like '%class%win32_logicaldisk%new-item%itemtype%')) | groupby system, user

stream=AUTHENTICATION where action='LOGIN' and devsrcip='crowdstrike_connector' | duration 1d |  groupby srccn | limit 10

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'(new-item|new-itemproperty).*?-path hklm:.*?system.*?currentcontrolset.*?services.*?nppspy.*?(-name.*?-value|-name.*?-propertytype expandstring -value.*?system32.*?nppspy).*?-erroraction ignore') or rlike(lower(commandline),'get-itemproperty -path.*?(hkey_local_machine|hklm):.*?system.*?currentcontrolset.*?control.*?networkprovider.*?order.*?-name providerorder')) | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'(new-item|new-itemproperty).*?-path hklm:.*?system.*?currentcontrolset.*?services.*?nppspy.*?(-name.*?-value|-name.*?-propertytype expandstring -value.*?system32.*?nppspy).*?-erroraction ignore') or rlike(lower(commandline),'get-itemproperty -path.*?(hkey_local_machine|hklm):.*?system.*?currentcontrolset.*?control.*?networkprovider.*?order.*?-name providerorder')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'psexec.*?-accepteula\s+-s\s+reg\s+save\s+(hklm|hkey_local_machine).*?security.*?policy') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'psexec.*?-accepteula\s+-s\s+reg\s+save\s+(hklm|hkey_local_machine).*?security.*?policy') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((certutil\s+-(f|user|silent|split|p|t|v|nocr|nocrlf|csp|unicodetext).*?-(encodehex|dump|dumppfx|asn|decodehex|decode|encode))|system.io.file.*?::copy).*?windows.*?system32.*?config') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'((certutil\s+-(f|user|silent|split|p|t|v|nocr|nocrlf|csp|unicodetext).*?-(encodehex|dump|dumppfx|asn|decodehex|decode|encode))|system.io.file.*?::copy).*?windows.*?system32.*?config')  | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline), 'get-nettcpconnection -localport 3389.*?-state established') and rlike(lower(commandline), 'rundll32.*?c:.*?system32.*?comsvcs.dll.*?minidump.*?full')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline), 'get-nettcpconnection -localport 3389.*?-state established') and rlike(lower(commandline), 'rundll32.*?c:.*?system32.*?comsvcs.dll.*?minidump.*?full')) | groupby user, system, commandline 

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'ntdsutil.*?ac.*?i.*?ntds.*?ifm.*?create.*?full.*?q.*?q') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'ntdsutil.*?ac.*?i.*?ntds.*?ifm.*?create.*?full.*?q.*?q') | groupby user, system, commandline | duration 1h

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(systeminfo|tasklist\s+\v|arp\s+-a|netstat\s+-ano\s+reg\s+query|ipconfig\s+\all|dnscmd.*enumrecords|netsh.*show|wmic.*(list|brief|full))') | groupby user, system

stream=windows-event where eid = '39' and user is not null | duration 10d |  groupby user , @Subject 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel') | groupby user, system | duration 1h

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'gsecdump.*?(-a|sam|cached|secrets|ntds|policy|lsa|kerberos)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'gsecdump.*?(-a|sam|cached|secrets|ntds|policy|lsa|kerberos)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(procdump.*?-accepteula\s+(-ma|-mm).*?lsass.exe|rundll32.*?c:.*?windows.*?system32.*?comsvcs.dll.*?minidump.*?get-process\s+lsass.*?full|dumpert.exe|nanodump.x64.exe\s+-w|pypykatz.*?live\s+lsa|get-process\s+lsass.*?out-minidump|-u\s+-f.*?dotnet-lsass.dmp.*?get-process\s+lsass.*?id|xordump.*?-out.*?-x\s+0x41|rdrleakdiag|nanodump.x64.exe --silent-process-exit)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(procdump.*?-accepteula\s+(-ma|-mm).*?lsass.exe|rundll32.*?c:.*?windows.*?system32.*?comsvcs.dll.*?minidump.*?get-process\s+lsass.*?full|dumpert.exe|nanodump.x64.exe\s+-w|pypykatz.*?live\s+lsa|get-process\s+lsass.*?out-minidump|-u\s+-f.*?dotnet-lsass.dmp.*?get-process\s+lsass.*?id|xordump.*?-out.*?-x\s+0x41|rdrleakdiag|nanodump.x64.exe --silent-process-exit)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline, "cmdkey.*?(list|delete|add|pass)") and user='{SupectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(commandline, "cmdkey.*?(list|delete|add|pass)") | groupby user, system

stream=ep-process where action="PROCESS_ADDED" and lower(commandline) like "%mimikatz%lsadump::dcsync%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and lower(commandline) like "%mimikatz%lsadump::dcsync%" | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%cmd.exe%reg query%' or rlike(lower(commandline), "powershell.exe.*?(get-item|get-childitem|get-itemproperty|get-childitem -path hklm|get-childitem -path hkcr:)")) | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%cmd.exe%reg query%' or rlike(lower(commandline), "powershell.exe.*?(get-item|get-childitem|get-itemproperty|get-childitem -path hklm|get-childitem -path hkcr:)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED' , 'OBJECT_ACCESSED') and ((lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(commandline) like '%class%win32_logicaldisk%new-item%itemtype%') or (lower(scriptblocktext) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(scriptblocktext) like '%class%win32_logicaldisk%new-item%itemtype%')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED' , 'OBJECT_ACCESSED') and ((lower(commandline) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(commandline) like '%class%win32_logicaldisk%new-item%itemtype%') or (lower(scriptblocktext) like '%class%win32_logicaldisk%filter%expandproperty%removable drive found%' or lower(scriptblocktext) like '%class%win32_logicaldisk%new-item%itemtype%')) | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(systeminfo|tasklist\s+\v|arp\s+-a|netstat\s+-ano\s+reg\s+query|ipconfig\s+\all|dnscmd.*enumrecords|netsh.*show|wmic.*(list|brief|full)|hostname|net\s+|quser\s+|qwinsta\s+|dsquery|whoami)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(systeminfo|tasklist\s+\v|arp\s+-a|netstat\s+-ano\s+reg\s+query|ipconfig\s+\all|dnscmd.*enumrecords|netsh.*show|wmic.*(list|brief|full)|hostname|net\s+|quser\s+|qwinsta\s+|dsquery|whoami)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((reg\s+query|get-itemproperty).*software.*microsoft.*cryptography.*machineguid)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((reg\s+query|get-itemproperty).*software.*microsoft.*cryptography.*machineguid)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%cmd.exe%reg query%' or rlike(lower(commandline), "powershell.exe.*?(get-item|get-childitem|get-itemproperty).*?-path.*?(hklm|hkcr|hkcu)")) | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%cmd.exe%reg query%' or rlike(lower(commandline), "powershell.exe.*?(get-item|get-childitem|get-itemproperty|get-childitem -path hklm|get-childitem -path hkcr:)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=*  where extractorid='710' | duration 7d  | groupby devsrcip |  select distinct_count(devsrcip)

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "cmdkey.*?(list|delete|add)") and user='{SuspectUser}' and system='{TragetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(commandline, "cmdkey.*?(list|delete|add|pass)") | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(systeminfo|tasklist\s+\v|arp\s+-a|netstat\s+-ano\s+reg\s+query|ipconfig\s+\all|dnscmd.*enumrecords|netsh.*show|wmic.*(list|brief|full)|hostname|net\s+|quser\s+|qwinsta\s+|dsquery|whoami)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(systeminfo|tasklist\s+\v|arp\s+-a|netstat\s+-ano\s+reg\s+query|ipconfig\s+\all|dnscmd.*enumrecords|netsh.*show|wmic.*(list|brief|full)|hostname|net\s+|quser\s+|qwinsta\s+|dsquery|whoami)') | groupby user, system

stream=win-audit

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((reg\s+query|get-itemproperty).*software.*microsoft.*cryptography.*machineguid)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((reg\s+query|get-itemproperty).*software.*microsoft.*cryptography.*machineguid)') | groupby user, system

stream=threat where sourcename='NETSKOPE' and action='THREAT_DETECTED' | groupby srcip, alerttype | duration 1h

stream=threat where sourcename="MS-O365" | duration 1d |  groupby threat, @ThreatsAndDetectionTech[1] 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%cmd.exe%reg query%' or rlike(lower(commandline), "powershell.exe.*?(get-item|get-childitem|get-itemproperty).*?-path.*?(hklm|hkcr|hkcu)")) | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%cmd.exe%reg query%' or rlike(lower(commandline), "powershell.exe.*?(get-item|get-childitem|get-itemproperty).*?-path.*?(hklm|hkcr|hkcu)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=windows-event where eid = '39' and user is not null | duration 15m |  groupby user , @Subject 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((get-childitem|gci|ls|dir)\s+env|env|printenv|set)\s+') | duration 1d

stream=signals where falsepositive = "true" | groupby detectionname |  duration 7d

stream=authentication where SourceName="MS-O365" and action="LOGIN" and status="PASSED" | groupby user | select user, distinct_count(srccn) as country_count | duration 1h | having country_count > 1 | limit 10

stream=email-gateway where sourcename="MS-O365" and action="EMAIL_ACCEPTED"  | duration 1h | groupby sender | select sender, count(*) as acceptance_count | limit 10

stream=azure where sourcename='AZURE' and action='AZURE_POLICY' and category='Policy' | groupby operationname | duration 1d | limit 10

stream=threat where sourcename='NETSKOPE' and action='THREAT_DETECTED' and not hash='' | groupby hash, alertname | duration 1h | limit 10

stream=configuration where action="CONFIGURATION_CHANGED" and ( rlike(lower(commandline),"set\-mppreference.*?(disablerealtimemonitoring|disablebehaviormonitoring|disableblockatfirstseen|disablescriptscanning|drtm|dbm|dscrptsc|dbaf).*?(true|1)") or rlike(lower(commandline),"set\-mppreference.*?(mapsreporting|puaprotection|submitsamplesconsent).*?(0|false|2)") or rlike(lower(commandline), "(disable-mpamservice|disable-mpsignatureupdate|uninstall-mpwdoscan)")) and system='{TargetHost}' | duration 6m

stream=configuration where action="CONFIGURATION_CHANGED" and ( rlike(lower(commandline),"set\-mppreference.*?(disablerealtimemonitoring|disablebehaviormonitoring|disableblockatfirstseen|disablescriptscanning|drtm|dbm|dscrptsc|dbaf).*?(true|1)") or rlike(lower(commandline),"set\-mppreference.*?(mapsreporting|puaprotection|submitsamplesconsent).*?(0|false|2)") or rlike(lower(commandline), "(disable-mpamservice|disable-mpsignatureupdate|uninstall-mpwdoscan)")) |  groupby system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((get-childitem|gci|ls|dir)\s+env|env|printenv|set)\s+') | duration 1d

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '((get-childitem|gci|ls|dir)\s+env|env|printenv|set)\s+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=* | groupby user | duration 1d

stream=signals where falsepositive = "true" |  groupby workbook, signal_url |  duration 7d

stream=authentication where SourceName="MS-O365" and action='LOGIN' and not user="Not Available" | duration 1h | groupby user, status | select user, status, count(*) as login_attempts | limit 10

stream=threat where sourcename='NETSKOPE' and action='THREAT_DETECTED' | groupby threat | duration 1d

stream=AUTHENTICATION where sourcename='AZURE' and action='LOGIN' and status='PASSED' | groupby user | limit 10 | duration 1d

stream=iam where sourcename='AZURE' and action='USER_UPDATED' and not targetuser='' | groupby targetuser | duration 1d | limit 20

stream=EP-PROCESS where rlike(image, "(sc|net|net1|services|svchost|cmd|powershell|pwsh).*?exe") and rlike(lower(commandline),"(start|run|exec|service|launch|begin|start-service|new-service|set-service)") | groupby user, system | duration 7d

stream=AUTHENTICATION where Action="LOGIN" and Status="PASSED" and not user in ("", "null") | groupby user | duration 7d

stream=*  where extractorid='710' | duration 7d  | groupby eid | limit 10

stream=documents where sourcename="MS-O365" | duration 1h | groupby action, operation

stream=threat where sourcename='NETSKOPE' and alerttype='Malware' | groupby alertname  | duration 1d

stream=email-gateway where sourcename = "MS-O365" and action="EMAIL_DELETED" |  groupby Sender | duration 1d | limit 10

stream=IAM where sourcename="MS-O365" | duration 1h |  groupby action, operation

stream=AUTHENTICATION where action='LOGIN' and devsrcip='crowdstrike_connector' | duration 1d |  groupby srcip | limit 10

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (lower(newprocessname) like '%nircmd%' and rlike(lower(commandline), "(execmd|.exe script|.exe shexec|runinteractive)")) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (lower(newprocessname) like '%nircmd%' and rlike(lower(commandline), "(execmd|.exe script|.exe shexec|runinteractive)"))and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=threat where sourcetype='ENDPOINT-SECURITY' AND sourcename='PALOALTO-CORTEX' and file like '%{SuspectObject}%' and system='{TargetHost}' | duration 1M

stream=threat where sourcetype='ENDPOINT-SECURITY' AND sourcename='PALOALTO-CORTEX' | duration 1M | limit 1 | select substring_index(file,"\\",-1) as file, system, threat |  groupby file, system, threat

stream=EP-PROCESS where rlike(image, "(sc|net|net1|services|svchost|cmd|powershell|pwsh).*?exe") and rlike(lower(commandline),"(start|run|exec|service|launch|begin|start-service|new-service|set-service)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where rlike(image, "(sc|net|net1|services|svchost|cmd|powershell|pwsh).*?exe") and rlike(lower(commandline),"(start|run|exec|service|launch|begin|start-service|new-service|set-service)") | groupby user, system

stream=threat where sourcename='NETSKOPE' and action='THREAT_DETECTED' and not severity IN ("", "unknown") |  groupby upper(severity) | select upper(severity) as Severity, count(*) | duration 1d

stream=threat where sourcename='NETSKOPE' and action='THREAT_BLOCKED' | groupby threat | duration 7d

stream=DOCUMENTS where sourcename="MS-O365" and action="UPLOADED"  | duration 1d | groupby user | select user, count(*) as upload_count | limit 10

stream=threat where sourcename='NETSKOPE' and alerttype='Compromised Credential' | groupby user | duration 1d

stream=DOCUMENTS where action='ACCESSED' AND sourcename="MS-O365" | duration 1d | groupby user | select user, count(*) as access_count | limit 10

stream=authentication |  groupby action

stream=threat where sourcename='NETSKOPE' and action='THREAT_BLOCKED' and not srccn like 'null' | groupby srccn | duration 1d

stream=CROWDSTRIKE-FALCON where eventType = "AuthActivityAuditEvent" and status = "PASSED" | groupby OperationName | duration 1d

stream=threat where sourcename='NETSKOPE' and action='THREAT_DETECTED' and not srccn like 'null' | groupby srccn | duration 1d

stream=email-gateway where sourcename="MS-O365" | duration 1h |  groupby action, operation

stream=iam where sourcename='AZURE' and action='MEMBER_REMOVED' and not targetuser='' | groupby targetuser | duration 7d

stream=DOCUMENTS where sourcename="MS-O365" and action="VIEWED"  | duration 1d | groupby user | select user, count(*) as view_count | limit 10

stream=configuration where sourcename="MS-O365" and action="CONFIGURATION_CHANGED" |  groupby config | duration 1d | limit 10

stream=THREAT where sourcename="MS-O365" |  groupby threat | duration 5d 

stream=AUTHENTICATION where Action="LOGIN" and Status="PASSED" and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=threat where sourcename='NETSKOPE' and alerttype='Compromised Credential' | groupby user | duration 1h | limit 10

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%reg add%hklm%software%microsoft%.netframework%etwenabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%.netframework%etwenabled%' or lower(commandline) like '%reg add%hklm%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%' or lower(commandline) like '%-accepteula%-i%logman update trace%-p%-ets%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%reg add%hklm%software%microsoft%.netframework%etwenabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%.netframework%etwenabled%' or lower(commandline) like '%reg add%hklm%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%' or lower(commandline) like '%-accepteula%-i%logman update trace%-p%-ets%' | groupby user, system

stream=win-audit where user="dsgdsg" | duration 1h | groupby user, system 

stream=win-audit where user="Administrator" | duration 1h | groupby user, system 

stream=win-audit where user="Administrator" | duration 1h | groupby user, system, commandline

stream=win-audit where user="dgregre" | duration 1h | groupby user, system 

stream=win-audit where user="Administrator" | duration 1h | groupby user, system 

stream=AUTHENTICATION where action='LOGIN' and sourcename='CROWDSTRIKE-FALCON' | duration 1d |  groupby srccn | limit 10

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline),  '(net view|net share|get-smbshare|dir.*?\\$|get-wmiobject.*?win32_share|invoke-sharefinder|shareenumeratio)') | groupby user, system

stream=signals | duration 1M

stream=threat where sourcename='NETSKOPE' and alerttype='Malware' | groupby alertname  | duration 1h | limit 10

stream=win-audit where user="Administrator" | duration 1h | groupby user, system, commandline

stream=win-audit where user="dgregre" | duration 1h | groupby user, system 

stream=win-audit where user="Administrator" | duration 1h | groupby user, system 

stream=win-audit where user="dgregre" | duration 1h | groupby user, system 

stream=win-audit where user="Administrator" | duration 1h | groupby user, system 

stream=win-audit where user="asdc" | duration 1h | groupby user, system, commandline

stream=AUTHENTICATION where action='LOGIN' and sourcename='CROWDSTRIKE-FALCON' | duration 1d |  groupby srcip | limit 10

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline),  '(net view|net share|get-smbshare|dir.*?\\$|get-wmiobject.*?win32_share|invoke-sharefinder|shareenumeratio)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline),  '(net view|net share|get-smbshare|dir.*?\\$|get-wmiobject.*?win32_share|invoke-sharefinder|shareenumeratio)') | groupby user, system | duration1d

stream=IAM where action='USER_CREATED' and eid='4720' and (targetuser like '% ' or targetuser like '%$%') and targetuser='{TargetUser}' and user='{SuspectUser}'| duration 6m

stream=IAM where action='USER_CREATED' and eid='4720' and (targetuser like '% ' or targetuser like '%$%') | groupby user, targetuser 

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%reg add%hklm%software%microsoft%.netframework%etwenabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%.netframework%etwenabled%' or lower(commandline) like '%reg add%hklm%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%' or lower(commandline) like '%-accepteula%-i%logman update trace%-p%-ets%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%reg add%hklm%software%microsoft%.netframework%etwenabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%.netframework%etwenabled%' or lower(commandline) like '%reg add%hklm%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%' or lower(commandline) like '%-accepteula%-i%logman update trace%-p%-ets%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%reg add%hklm%software%microsoft%.netframework%etwenabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%.netframework%etwenabled%' or lower(commandline) like '%reg add%hklm%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%' or lower(commandline) like '%-accepteula%-i%logman update trace%-p%-ets%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%reg add%hklm%software%microsoft%.netframework%etwenabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%.netframework%etwenabled%' or lower(commandline) like '%reg add%hklm%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%' or lower(commandline) like '%-accepteula%-i%logman update trace%-p%-ets%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and rlike(lower(commandline), "(vboxsvc.*?reregserver|regsvr32.*?virtualbox.*?vboxc.dll|(sc create|sc create).*?vboxdrv)") or rlike(lower(commandline), "(vboxmanage.*?(createvm --name|modifyvm|startvm)|(new-vm|set-vmfirmware|start-vm))") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and rlike(lower(commandline), "(vboxsvc.*?reregserver|regsvr32.*?virtualbox.*?vboxc.dll|(sc create|sc start).*?vboxdrv)") or rlike(lower(commandline), "(vboxmanage.*?(createvm --name|modifyvm|startvm)|(new-vm|set-vmfirmware|start-vm))") | groupby user, system

Stream=EP-PROCESS where not user in ("-", "", "null") | groupby user | duration 7d

stream=iam where eventid IN (4720, 4722, 4725, 4728, 4732, 4756, 4740)  | duration 7d | limit 10

Stream=EP-PROCESS where not user in ("-", "", "null") and status="PASSED" | groupby user | duration 7d

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (lower(newprocessname) like '%nircmd%' and rlike(lower(commandline),  "(execmd|.exe script|.exe shexec|runinteractive)"))and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (lower(newprocessname) like '%nircmd%' and rlike(lower(commandline),  "(execmd|.exe script|.exe shexec|runinteractive)")) | groupby user, system

stream=win-audit | duration 1h | groupby user, system 

stream=win-audit where user="Administrator" | duration 1h | groupby user, system 

stream=win-audit where user="Administrator" | duration 1h | groupby user, system, commandline

stream=win-audit where user="dgregre" | duration 1h | groupby user, system 

stream=win-audit where user="Administrator" | duration 1h | groupby user, system 

stream=win-audit where rlike(lower(commandline), 'net.webclient.*?downloadstring.*?winpwn\.') and rlike(lower(commandline), '(lazagnemodule|wificreds|decryptteamviewer)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where rlike(lower(commandline), 'net.webclient.*?downloadstring.*?winpwn\.') and rlike(lower(commandline), '(lazagnemodule|wificreds|decryptteamviewer)') | groupby system, user 

stream=*  where extractorid='710' | duration 7d  | groupby devsrcip |  select distinct_count(devsrcip)

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline),  "(net.*?accounts|net.*?accounts /domain)") or rlike(lower(commandline), "(powerview.*?get-domainpolicy|get-addefaultdomainpasswordpolicy)") or rlike(lower(commandline), "secedit.*?/export.*?/cfg")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline),  "(net.*?accounts|net.*?accounts /domain)") or rlike(lower(commandline), "(powerview.*?get-domainpolicy|get-addefaultdomainpasswordpolicy)") or rlike(lower(commandline), "secedit.*?/export.*?/cfg")) | groupby user, system 

stream=win-audit where user="dsgdsg" | duration 1h | groupby user, system 

stream=win-audit where user="dgregre" | duration 1h | groupby user, system 

stream=win-audit where user="Administrator" | duration 1h | groupby user, system 

stream=win-audit where user="Administrator" | duration 1h | groupby user, system, commandline

stream=win-audit where user="dgregre" | duration 1h | groupby user, system 

stream=win-audit where user="Administrator" | duration 1h | groupby user, system 

stream=signals | duration 7d | groupby detectionconfidence, detectionseverity | select detectionconfidence, detectionseverity, count(*) as signal_count

stream=signals | duration 7d | groupby detectiontechnique | select detectiontechnique, sum(detectionscore) as total_score | limit 10

stream=signals | duration 7d | groupby detectiontechnique | select detectiontechnique, sum(detectionscore) as total_score | limit 10

stream=signals where falsepositive = "true" |  select count (signal_url) |  duration 7d

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (lower(newprocessname) like '%nircmd%' and rlike(lower(commandline),  "(execmd|.exe script|.exe shexec|runinteractive)")) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (lower(newprocessname) like '%nircmd%' and rlike(lower(commandline),  "(execmd|.exe script|.exe shexec|runinteractive)"))and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where user="Administrator" | duration 1h | groupby user, system, commandline

stream=win-audit where user="dgregre" | duration 1h | groupby user, system 

stream=win-audit where user="Administrator" | duration 1h | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline),  "(net.*?accounts|net.*?accounts /domain)") or rlike(lower(commandline), "(powerview.*?get-domainpolicy|get-addefaultdomainpasswordpolicy)") or rlike(lower(commandline), "secedit.*?/export.*?/cfg")) | groupby userr, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline),  "(net.*?accounts|net.*?accounts /domain)") or rlike(lower(commandline), "(powerview.*?get-domainpolicy|get-addefaultdomainpasswordpolicy)") or rlike(lower(commandline), "secedit.*?/export.*?/cfg")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline),  "(net.*?accounts|net.*?accounts /domain)") or rlike(lower(commandline), "(powerview.*?get-domainpolicy|get-addefaultdomainpasswordpolicy)") or rlike(lower(commandline), "secedit.*?/export.*?/cfg")) | groupby user, system | duration 2h

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline),  "(net.*?accounts|net.*?accounts /domain)") or rlike(lower(commandline), "(powerview.*?get-domainpolicy|get-addefaultdomainpasswordpolicy)") or rlike(lower(commandline), "secedit.*?/export.*?/cfg")) | groupby user, system | duration 2h

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline),  "(net.*?accounts|net.*?accounts /domain)") or rlike(lower(commandline), "(powerview.*?get-domainpolicy|get-addefaultdomainpasswordpolicy)") or rlike(lower(commandline), "secedit.*?/export.*?/cfg")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline),  "(net.*?accounts|net.*?accounts /domain)") or rlike(lower(commandline), "(powerview.*?get-domainpolicy|get-addefaultdomainpasswordpolicy)") or rlike(lower(commandline), "secedit.*?/export.*?/cfg")) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline),  "(net.*?accounts|net.*?accounts /domain)") or rlike(lower(commandline), "(powerview.*?get-domainpolicy|get-addefaultdomainpasswordpolicy)") or rlike(lower(commandline), "secedit.*?/export.*?/cfg")) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%sc%create%sc sdset%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%sc%create%sc sdset%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (lower(newprocessname) like '%nircmd%' and rlike(lower(commandline), "(execmd|.exe script|.exe shexec|runinteractive)")) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (lower(newprocessname) like '%nircmd%' and rlike(lower(commandline), "(execmd|.exe script|.exe shexec|runinteractive)"))and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=firewall |  duration 1d |  limit 1

stream=win-audit where rlike(lower(commandline), 'net localgroup|net localgroup administrators|get-localgroup|get-localgroupmember|wmic group|sharphound|get-wmiobject win32_group') | duration 1h

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), 'powershell -executionpolicy bypass -command.*-file') or rlike(lower(commandline), 'get-childitem -path.*(pst|ost|eml|msg|msf|sbd).*export-csv -Path')) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), 'powershell -executionpolicy bypass -command.*-file') or rlike(lower(commandline), 'get-childitem -path.*(pst|ost|eml|msg|msf|sbd).*export-csv -Path')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline), "wmic.*?((useraccount|process|qfe).*?get|service)") or  rlike(lower(commandline), "wmic.*?(process call create|process call create.*?rundll32)")) | duration 15m |  select system, user, commandline | limit 10000

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline), "wmic.*?((useraccount|process|qfe).*?get|service)") or  rlike(lower(commandline), "wmic.*?(process call create|process call create.*?rundll32)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=win-audit where rlike(lower(commandline), '(cscript|wscript)|(cscript|node|wscript).*?gather_info|new-object.*?comobject.*?wscript.*?gather_info') | duration 1h

stream=EP-PROCESS where action='PROCESS_ADDED' and parentcommandline like '%Invoke-Internalmonologue%-command%' | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and parentcommandline like '%Invoke-Internalmonologue%-command%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'invoke-internalmonologue.*?-command') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'invoke-internalmonologue.*?-command') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=authentication where action="LOGIN" and status="FAILED" and crownjewel="Yes" and authproto="RDP" and user is not null and user='{SuspectUser}' and system='{TargetHost}' | duration 1d

stream=authentication where action="LOGIN" and status="FAILED" and crownjewel="Yes" and authproto="RDP" and user is not null | select user, system, distinct_count(system) as systemcount | groupby user, system | having systemcount > 1 | duration 1d

stream=firewall |  duration 1d |  limit 1

stream=authentication where SourceName="MS-O365" and action='LOGIN' and not user="Not Available" | duration 1h | groupby user, status | select user, status, count(*) as login_attempts | limit 10

stream=documents where sourcename="MS-O365" | duration 1h | groupby action, operation

stream=email-gateway where sourcename = "MS-O365" and action="EMAIL_DELETED" |  groupby Sender | duration 1d | limit 10

stream=IAM where sourcename="MS-O365" | duration 1h |  groupby action, operation

stream=DOCUMENTS where sourcename="MS-O365" and action="UPLOADED"  | duration 1d | groupby user | select user, count(*) as upload_count | limit 10

stream=DOCUMENTS where action='ACCESSED' AND sourcename="MS-O365" | duration 1d | groupby user | select user, count(*) as access_count | limit 10

stream=authentication where authproto="SSH" | groupby user, system, xhour | select user, system, substring(xhour, 9,10) as houroftheday | having '03' > houroftheday < '16' 

stream=authentication where authproto="SSH" and user='{SuspectUser}' and system'{TartgetHost}' | duration 6m

stream=threat where sourcename="MS-O365" | duration 1d |  groupby threat, @ThreatsAndDetectionTech[1] 

stream=authentication where SourceName="MS-O365" and action="LOGIN" and status="PASSED" | groupby user | select user, distinct_count(srccn) as country_count | duration 1h | having country_count > 1 | limit 10

stream=email-gateway where sourcename="MS-O365" and action="EMAIL_ACCEPTED"  | duration 1h | groupby sender | select sender, count(*) as acceptance_count | limit 10

stream=email-gateway where sourcename="MS-O365" | duration 1h |  groupby action, operation

stream=win-audit where rlike(lower(commandline), 'net localgroup|net localgroup administrators|get-localgroup|get-localgroupmember|wmic group|sharphound|get-wmiobject win32_group|docker build|docker run|dscacheutil|dscl|groups|getent') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where rlike(lower(commandline), 'net localgroup|net localgroup administrators|get-localgroup|get-localgroupmember|wmic group|sharphound|get-wmiobject win32_group|docker build|docker run|dscacheutil|dscl|groups|getent') | groupby system, user

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline), "wmic.*?((useraccount|process|qfe).*?get|service)") or  rlike(lower(commandline), "wmic.*?(process call create|process call create.*?rundll32)")) | duration 2h

stream=firewall |  duration 1d |  limit 1

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline), "wmic.*?((useraccount|process|qfe).*?get|service)") or  rlike(lower(commandline), "wmic.*?(process call create|process call create.*?rundll32)")) | duration 15m |  select system, user, commandline | limit 10000

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "wmic.*?((useraccount|process|qfe).*?get|service)") or  rlike(lower(commandline), "wmic.*?(process call create|process call create.*?rundll32)")) | duration 15m |  select system, user, commandline | limit 10000

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline), "wmic.*?((useraccount|process|qfe).*?get|service)") or  rlike(lower(commandline), "wmic.*?(process call create|process call create.*?rundll32)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%PetitPotam%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%PetitPotam%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), 'python3.*?petitpotam') or rlike(lower(commandline),'invoke-petitpotam')) | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), 'python3.*?petitpotam') or rlike(lower(commandline),'invoke-petitpotam')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Invoke-Internalmonologue%-command%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%Invoke-Internalmonologue%-command%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%wmic%product%where%name%call%uninstall%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%wmic%product%where%name%call%uninstall%') | groupby system, user 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%wmic%product%where%name%call%uninstall%') | groupby system, user 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%wmic%product%where%name%call%uninstall%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(TargetObject), 'Software.*?Policies.*?microsoft.*?windows.*?control Panel.*?desktop.*?(screensaver|screensaveactive|screensavetimeout|screensaverissecure|scrnsave)') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline), "wmic.*?((useraccount|process|qfe).*?get|service)") or  rlike(lower(commandline), "wmic.*?(process call create|process call create.*?rundll32)")) | duration 15m |  select system, user, commandline | limit 10000

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline), "wmic.*?((useraccount|process|qfe).*?get|service)") or  rlike(lower(commandline), "wmic.*?(process call create|process call create.*?rundll32)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "wmic.*?((useraccount|process|qfe).*?get|service)")  or rlike(lower(commandline), "wmic.*?(process call create|process call create.*?rundll32)")) | duration 15m |  select system, user, commandline | limit 10000

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline), "wmic.*?((useraccount|process|qfe).*?get|service)") or  rlike(lower(commandline), "wmic.*?(process call create|process call create.*?rundll32)")) and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), 'python3.*?petitpotam') or rlike(lower(commandline),'invoke-petitpotam')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), 'python3.*?petitpotam') or rlike(lower(commandline),'invoke-petitpotam')) | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and parentcommandline like '%Invoke-Internalmonologue%-command%' | groupby user, system 

stream=EP-PROCESS where action='PROCESS_ADDED' and parentcommandline like '%Invoke-Internalmonologue%-command%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), 'powershell -executionpolicy bypass -command.*-file') or rlike(lower(commandline), 'get-(childitem|item) -path.*(pst|ost|eml|msg|msf|sbd).*export') or rlike(lower(commandline), '(new-mailboxexportrequest|get-mailbox|search-mailbox|new-mailboxsearch)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), 'powershell -executionpolicy bypass -command.*-file') or rlike(lower(commandline), 'get-(childitem|item) -path.*(pst|ost|eml|msg|msf|sbd).*export') or rlike(lower(commandline), '(new-mailboxexportrequest|get-mailbox|search-mailbox|new-mailboxsearch)') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%wmic%product%where%name%call%uninstall%') | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%wmic%product%where%name%call%uninstall%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where rlike(lower(commandline), '(cscript|wscript)|(cscript|node|wscript).*?gather_info|new-object.*?comobject.*?wscript.*?gather_info|call gather_info') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where rlike(lower(commandline), '(cscript|wscript)|new-object.*?comobject.*?wscript.*?gather_info|call gather_info') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(powershell|start-process).*-windowstyle.*hidden') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(powershell|start-process).*-windowstyle.*hidden') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(-headless.*disable-gpu.*(mockbin|mocky))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(-headless.*disable-gpu.*(mockbin|mocky))') | groupby user, system

stream=ep-process where eid = '1' | duration 1h  | checkif image in dropped_file_store.dropped_file

stream=ep-process where eid = '10' | duration 1d |  groupby @SourceImage 

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), 'powershell -executionpolicy bypass -command.*-file') or rlike(lower(commandline), 'get-(childitem|item) -path.*(pst|ost|eml|msg|msf|sbd).*export') or rlike(lower(commandline), '(new-mailboxexportrequest|get-mailbox|search-mailbox|new-mailboxsearch)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (rlike(lower(commandline), 'powershell -executionpolicy bypass -command.*-file') or rlike(lower(commandline), 'get-(childitem|item) -path.*(pst|ost|eml|msg|msf|sbd).*export') or rlike(lower(commandline), '(new-mailboxexportrequest|get-mailbox|search-mailbox|new-mailboxsearch)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(-headless.*disable-gpu.*(mockbin|mocky))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(-headless.*disable-gpu.*(mockbin|mocky))') | groupby user, system

stream=ep-file where eid='11'| duration 1d |  groupby system , user, image, targetfilename, systemtstamp | select system, user, image as dropper_process, targetfilename as dropped_file, systemtstamp as file_creation_time 

stream=ep-file where eid='11'| duration 1d |  groupby system , user, image, targetfilename, systemtstamp | select system, user, image as dropper_process, targetfilename as dropped_file, systemtstamp as file_creation_time 

stream=ep-process where eid = '1' | duration 1d

stream=ep-process where eid = '1' |  duration 1d  | checkif image in dropped_file_store.dropped_file

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%mavinject%usebasicparsing%' or rlike(lower(commandline), 'start-tlslistener.*?system.net.sockets.tcplistener.*?new.*?system.net.ipaddress|start-tlscapture.*?start-process.*?filepath.*?-argumentlist|start-tlspacketcapture.*?alllocalmachine.*?where-object') or rlike(lower(commandline), 'wh_callwndproc|wh_callwndprocret|wh_cbt|wh_debug|wh_foregroundidle|wh_getmessage|wh_journalplayback|wh_journalrecord|wh_keyboard|wh_keyboard_ll|wh_mouse|wh_mouse_ll|wh_msgfilter|wh_shell|wh_sysmsgfilter') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%mavinject%usebasicparsing%' or rlike(lower(commandline), 'start-tlslistener.*?system.net.sockets.tcplistener.*?new.*?system.net.ipaddress|start-tlscapture.*?start-process.*?filepath.*?-argumentlist|start-tlspacketcapture.*?alllocalmachine.*?where-object') or rlike(lower(commandline), 'wh_callwndproc|wh_callwndprocret|wh_cbt|wh_debug|wh_foregroundidle|wh_getmessage|wh_journalplayback|wh_journalrecord|wh_keyboard|wh_keyboard_ll|wh_mouse|wh_mouse_ll|wh_msgfilter|wh_shell|wh_sysmsgfilter') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%invoke-wmimethod%" and lower(commandline) like '%class%win32_process%create%') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%invoke-wmimethod%" and lower(commandline) like '%class%win32_process%create%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'invoke-(internalmonologue|mimikatz|ninjacopy|powerdump|psinject|reflectivepeinjection|sharpsploit|thehash|wmicommand)') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'invoke-(internalmonologue|mimikatz|ninjacopy|powerdump|psinject|reflectivepeinjection|sharpsploit|thehash|wmicommand)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(parentcommandline), 'invoke-(internalmonologue|mimikatz|ninjacopy|powerdump|psinject|reflectivepeinjection|sharpsploit|thehash|wmicommand)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(parentcommandline), 'invoke-(internalmonologue|mimikatz|ninjacopy|powerdump|psinject|reflectivepeinjection|sharpsploit|thehash|wmicommand)') | groupby user, system 

stream=ep-file where eid='11'| duration 1d |  groupby system , user, image, targetfilename, systemtstamp | select system, user, image as dropper_process, targetfilename as dropped_file, systemtstamp as file_creation_time 

stream=ep-file where eid='11'| duration 1d |  groupby system , user, image, targetfilename, systemtstamp | select system, user, image as dropper_process, targetfilename as dropped_file, systemtstamp as file_creation_time 

stream=win-audit where action="OBJECT_ACCESSED" and and (lower(commandline) like "%invoke-wmimethod%" and lower(commandline) like '%class%win32_process%create%') | groupby user, system

stream=win-audit where action="OBJECT_ACCESSED" and and (lower(commandline) like "%invoke-wmimethod%" and lower(commandline) like '%class%win32_process%create%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (lower(commandline) like "%invoke-wmimethod%" and lower(commandline) like "%class%win32_process%create%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (lower(commandline) like "%invoke-wmimethod%" and lower(commandline) like "%class%win32_process%create%") | groupby user, system

stream=ep-process where eid = '10' | duration 1d |  groupby @SourceImage , system , user

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(-headless.*disable-gpu.*(mockbin|mocky))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(-headless.*disable-gpu.*(mockbin|mocky))') | groupby user, system

stream=win-audit where rlike(lower(commandline), 'cscript|wscript|new-object.*?comobject.*?wscript.*?gather_info|call gather_info') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where rlike(lower(commandline), 'cscript|wscript|new-object.*?comobject.*?wscript.*?gather_info|call gather_info') | groupby user, system

stream=ep-file where eid='11'| duration 1d |  groupby system , user, image, targetfilename, systemtstamp | select system, user, image as dropper_process, targetfilename as dropped_file, systemtstamp as file_creation_time 

stream=ep-image-load |  duration 1h | checkif image in dropped_file_store.dropped_file |  groupby system, user , signed, imageloaded

stream=win-audit where action="PROCESS_CREATED" and (lower(commandline) like "%invoke-wmimethod%" and lower(commandline) like '%class%win32_process%create%') | groupby user, system

stream=win-audit where action="OBJECT_ACCESSED" and and (lower(commandline) like "%invoke-wmimethod%" and lower(commandline) like '%class%win32_process%create%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where eid = '1' | duration 1h  | checkif image in dropped_file_store.dropped_file

stream=ep-image-load |  duration 1h | checkif image in dropped_file_store.dropped_file |  groupby system, user , signed, imageloaded

stream=ep-file where eid='11'| duration 1d |  groupby system , user, image, targetfilename, systemtstamp | select system, user, image as dropper_process, targetfilename as dropped_file, systemtstamp as file_creation_time 

stream=ep-network where eid = '3' | duration 1h  | checkif image in dropped_file_store.dropped_file |  groupby system, user , image , dstip , dstport

stream=ep-image-load |  duration 1h | checkif image in dropped_file_store.dropped_file |  groupby system, user , signed, imageloaded

stream=win-audit where action="PROCESS_CREATED" and (lower(commandline) like "%invoke-wmimethod%" and lower(commandline) like "%class%win32_process%create%") | groupby user, system

stream=win-audit where action="OBJECT_ACCESSED" and and (lower(commandline) like "%invoke-wmimethod%" and lower(commandline) like '%class%win32_process%create%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where eid='10' |  duration 1d | checkif SourceImage in dropped_file_store.dropped_file

stream=ep-process where eid = '10' | duration 1d |  groupby @SourceImage

stream=ep-process where eid = '1' | duration 1h  | checkif image in dropped_file_store.dropped_file

stream=ep-process where eid = '10' | duration 1d |  groupby @SourceImage , system , user

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%winpwn%' and rlike(lower(commandline), '(winpeas|itm4nprivesc|privesccheck|allchecks|oldchecks|otherchecks|generalrecon|morerecon|rbcd-check|powersharppack.*?(watson|sharpup|powerup|seatbelt))') | duration 1d

stream=ep-network where eid = '3' | duration 1h  | checkif image in dropped_file_store.dropped_file |  groupby system, user , image , dstip , dstport

stream=ep-image-load |  duration 1h | checkif image in dropped_file_store.dropped_file |  groupby system, user , signed, imageloaded

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%invoke-wmimethod%" and lower(commandline) like "%class%win32_process%create%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%invoke-wmimethod%" and lower(commandline) like "%class%win32_process%create%") | groupby user, system 

stream=win-audit where action="OBJECT_ACCESSED" and and (lower(commandline) like "%invoke-wmimethod%" and lower(commandline) like "%class%win32_process%create%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (lower(commandline) like "%invoke-wmimethod%" and lower(commandline) like "%class%win32_process%create%") | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and and (lower(commandline) like "%invoke-wmimethod%" and lower(commandline) like "%class%win32_process%create%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and (lower(commandline) like "%invoke-wmimethod%" and lower(commandline) like "%class%win32_process%create%") | groupby user, system

stream=ep-process where eid = '10' | duration 1d |  groupby @SourceImage , system , user

stream=ep-process where eid = '1' | duration 1h  | checkif image in dropped_file_store.dropped_file

stream=ep-network where eid = '3' | duration 1h  | checkif image in dropped_file_store.dropped_file |  groupby system, user , image , dstip , dstport

stream=threat where sourcename='TRENDMICRO-EMAIL-SECURITY' AND action='THREAT_DETECTED' AND eventtype is not null | duration 1d |  groupby devsrcip, eventtype

stream=email-gateway where sourcename='TRENDMICRO-EMAIL-SECURITY' AND action='EMAIL_QUARANTINED' |  duration 1d | groupby @cs4Label

stream=threat where sourcename='TRENDMICRO-EMAIL-SECURITY' AND action='THREAT_DETECTED' |  duration 1d | groupby sourcename

stream=email-gateway where action='EMAIL_DELIVERED' AND sourcename='TRENDMICRO-EMAIL-SECURITY' | duration 1d |  groupby devsrcip, direction

stream=email-gateway where action='EMAIL_QUARANTINED' AND sourcename='TRENDMICRO-EMAIL-SECURITY'|  duration 1d |  groupby sourcename

stream=authentication where eid='4771' and not user like '%$%' and not user like '%@%' | groupby user, system | duration 7d | limit 10

stream=ep-process where eid = '1' | duration 1h  | checkif image in dropped_file_store.dropped_file

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adsisearcher.*?(objectclass=user|objectcategory=user|objectclass=computer|objectcategory=computer).*?(findall|findone)') or lower(commandline) like '%adsisearcher%objectcategory=organizationalunit%findall%path%' or lower(commandline) like '%adsisearcher%searchroot%path%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adsisearcher.*?(objectclass=user|objectcategory=user|objectclass=computer|objectcategory=computer).*?(findall|findone)') or lower(commandline) like '%adsisearcher%objectcategory=organizationalunit%findall%path%' or lower(commandline) like '%adsisearcher%searchroot%path%') | groupby user, system

stream=threat where sourcetype='ENDPOINT-SECURITY' AND sourcename='PALOALTO-CORTEX' and file like '%{SuspectObject}%' and system='{TargetHost}' | duration 1h

stream=threat where sourcetype='ENDPOINT-SECURITY' AND sourcename='PALOALTO-CORTEX' | duration 1h | limit 1 | select substring_index(file,"\\",-1) as file, system, threat |  groupby file, system, threat

stream=authentication where (eid='4768' or eid='4769' or eid='4771' or eid='4776') and not user like '%$%' and not user like '%@%' | groupby user, system, action | duration 1d | limit 10

stream=authentication where eid='4771' and not user like '%$%' and not user like '%@%' | groupby user, system | duration 7d | limit 10

stream=authentication where eid='4768' and not user like '%$%' and not user like '%@%' | groupby user, system, action | duration 7d | limit 10

stream=EP-FILE where action="FILE_CREATED" and rlike(lower(targetfilename),"\\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") | groupby substring_index(targetfilename,"\\",-1), targetfilename, user, system | select substring_index(targetfilename,"\\",-1) as file, targetfilename, user, system 

stream=EP-FILE where action="FILE_CREATED" and rlike(lower(targetfilename),"\\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") and targetfilename="{SuspectObject}" and user="{SuspectUser}" and system="{TargetHost}" | duraton 6m

stream=authentication where eid='4768' and not user like '%$%' and not user like '%@%' | groupby user, system, action | duration 7d | limit 10

stream=signals | duration 7d | groupby detectiontechnique | select detectiontechnique, sum(detectionscore) as total_score | limit 10

stream=signals where suspecthost is not null and targethost is not null | duration 7d | groupby suspecthost, targethost | select suspecthost, targethost, count(*) as correlation_count | limit 10

stream=*  where extractorid='710' | duration 7d  | groupby eid | limit 10

stream=iam where eid IN (4720, 4722, 4725, 4728, 4732, 4756, 4740)  | duration 7d |  groupby eid | limit 10

stream=configuration where eid IN (7036,7040) and object is not null  | duration 7d |  groupby object , action, cnamtime

stream=win-audit where eid = "5140" |  duration 7d | limit 1

stream=authentication where action="LOGIN" and status="PASSED" and authproto="RDP" and user='{SuspectUser}' and system="{TragetHost}" | duration 1h

stream=authentication where action="LOGIN" and status="PASSED" and authproto="RDP" | duration 1h | select system, user, distinct_count(srcip) as srcipcount | groupby system, user | having srcipcount > 3

stream=authentication where eid='4740' and not user like '%$%' and not user like '%@%' | groupby user | duration 7d | limit 10

stream=signals  where NOT falsepositive='true' | duration 7d | groupby detectionname, detectionseverity | limit 10

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline),  '(net view|net share|get-smbshare|dir.*?\\$|get-wmiobject.*?win32_share|invoke-sharefinder|shareenumeratio)') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline),  '(net view|net share|get-smbshare|dir.*?\\$|get-wmiobject.*?win32_share|invoke-sharefinder|shareenumeratio)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(TargetObject), 'Software.*?Policies.*?microsoft.*?windows.*?control Panel.*?desktop.*?(screensaver|screensaveactive|screensavetimeout|screensaverissecure|scrnsave)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(TargetObject), 'Software.*?Policies.*?microsoft.*?windows.*?control Panel.*?desktop.*?(screensaver|screensaveactive|screensavetimeout|screensaverissecure|scrnsave)') | groupby user, system

stream=configuration where eid IN (7036,7040) and object is not null  | duration 7d |  groupby object , action, cnamtime

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows nt.*?currentversion.*?winlogon.*?(shell|userinit|notify)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows nt.*?currentversion.*?winlogon.*?(shell|userinit|notify)') | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and  ((rlike(lower(image), "(tasklist.exe|wmic.exe|powershell.exe|query.exe|netstat.exe|cmd.exe)")) and (rlike(lower(commandline), "(tasklist|get-process|Win32_Process|process|get-wmiobject)"))) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and  ((rlike(lower(image), "(tasklist.exe|wmic.exe|powershell.exe|query.exe|netstat.exe|cmd.exe)")) and (rlike(lower(commandline), "(tasklist|get-process|Win32_Process|process|get-wmiobject)"))) | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m


stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), 'regsvr32.*?/s(?:.*?/n)?.*?/u.*?/i.*?.sct.*?scrobj.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?.dll') or rlike(lower(commandline), 'regsvr32.*?/s.*?(?:.*/n)?.*?/i.*?.dll') | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") | groupby user, system, commandline 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") and user="{SuspectUser}" and system="{TargetHost}" | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") | groupby user, system

stream=EP-PROCESS where action="PROCESS_ADDED"  and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%mpcmdrun%-removedefinitions%" or rlike(lower(commandline),"(del|remove).*?programdata.*?microsoft.*?windows.*?defender.*?defination.*?update")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%mpcmdrun%-removedefinitions%" or rlike(lower(commandline),"(del|remove).*?programdata.*?microsoft.*?windows.*?defender.*?defination.*?update")) | groupby user, system, commandline 

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") | groupby user, system

stream=WIN-AUDIT where action="PROCESS_CREATED" and (lower(commandline) like "%net%stop%" or lower(commandline) like "%sc%config%start%disable%" or  lower(commandline) like "%stop%service%name%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%mpcmdrun%-removedefinitions%" or rlike(lower(commandline),"(del|remove).*?programdata.*?microsoft.*?windows.*?defender.*?defination.*?update")) | groupby user, system, commandline 

stream=EP-PROCESS where action="PROCESS_ADDED" and (lower(commandline) like "%mpcmdrun%-removedefinitions%" or rlike(lower(commandline),"(del|remove).*?programdata.*?microsoft.*?windows.*?defender.*?defination.*?update")) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") and user="{SuspectUser}" and system="{TargetHost}" | duration 6m

stream=WIN-AUDIT where action="PROCESS_CREATED" and rlike(lower(commandline),"(stop\-service|remove\-service|disable\-service|sc\.exe.*stop|sc\.exe.*delete|sc\.exe.*config|powershell.*stop\-service|powershell.*remove\-service|powershell.*set\-service|wmic\.exe.*stopservice).*?\-name") | groupby user, system, commandline 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?software.*?mscfile.*?(cmd|powershell)") | groupby user, system 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?ms-settings.*?(cmd|powershell)") | groupby user, system 

stream=EP-PROCESS where action="PROCESS_ADDED" and rlike(lower(parentimage),"(powershell|cmd)") and rlike(lower(commandline), "reg.*?add.*?(hkcu|hkey_current_user).*?ms-settings.*?(cmd|powershell)") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=authentication where eid IN (4624,4625)| groupby cnamtime, action, user, system |  duration 7d

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'wevtutil.*?(epl|export-log).*?c:.*?(q|sq|lf|ow):.*?system.*?eventid.*?4776') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'wevtutil.*?(epl|export-log).*?c:.*?(q|sq|lf|ow):.*?system.*?eventid.*?4776') user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),"(net.*?user|wmic.*?useraccount.*?get|powershell.*?(get-localuser|get-localgroupmember|get-wmiobject.*?-class.*?win32_useraccount|get-aduser)|lusrmgr|query.*?user|net.*?localgroup.*?administrators|net.*?group.*?administrators|net.*?group|net.*?accounts|net.*?localgroup|net.*?view|dsquery.*?user|dsget.*?user|reg.*?query.*?profilelist)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),"(net.*?user|wmic.*?useraccount.*?get|powershell.*?(get-localuser|get-localgroupmember|get-wmiobject.*?-class.*?win32_useraccount|get-aduser)|lusrmgr|query.*?user|net.*?localgroup.*?administrators|net.*?group.*?administrators|net.*?group|net.*?accounts|net.*?localgroup|net.*?view|dsquery.*?user|dsget.*?user|reg.*?query.*?profilelist)") | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%get-adcomputer%-properties *%' or rlike(lower(commandline),'get-adcomputer.*?-properties.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)') or lower(commandline) like '%get-adcomputer%-searchscope%subtree%-filter%name%-like %*%-properties *%' or rlike(lower(commandline),'adfind.*?-h.*?-s subtree -f.*?objectclass=computer.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%get-adcomputer%-properties *%' or rlike(lower(commandline),'get-adcomputer.*?-properties.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)') or lower(commandline) like '%get-adcomputer%-searchscope%subtree%-filter%name%-like %*%-properties *%' or rlike(lower(commandline),'adfind.*?-h.*?-s subtree -f.*?objectclass=computer.*?(ms-mcs-admpwd|ms-mcs-admpwdexpirationtime)')) | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adsisearcher.*?(objectclass=user|objectcategory=user|objectclass=computer|objectcategory=computer).*?(findall|findone)') or lower(commandline) like '%adsisearcher%objectcategory=organizationalunit%findall%path%' or lower(commandline) like '%adsisearcher%searchroot%path%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adsisearcher.*?(objectclass=user|objectcategory=user|objectclass=computer|objectcategory=computer).*?(findall|findone)') or lower(commandline) like '%adsisearcher%objectcategory=organizationalunit%findall%path%' or lower(commandline) like '%adsisearcher%searchroot%path%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'kerbrute.*?userenum.*?(-d|--dc|-t|-o|-safe)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'kerbrute.*?userenum.*?(-d|--dc|-t|-o|-safe)') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline),'adsisearcher.*?(objectclass=user|objectcategory=user|objectclass=computer|objectcategory=computer).*?(findall|findone)') or lower(commandline) like '%adsisearcher%objectcategory=organizationalunit%findall%path%' or lower(commandline) like '%adsisearcher%searchroot%path%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and (rlike(lower(commandline),'adsisearcher.*?(objectclass=user|objectcategory=user|objectclass=computer|objectcategory=computer).*?(findall|findone)') or lower(commandline) like '%adsisearcher%objectcategory=organizationalunit%findall%path%' or lower(commandline) like '%adsisearcher%searchroot%path%') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adfind.*s.*base.*(lockoutduration|lockoutthreshold|lockoutobservationwindow|maxpwdage|minpwdage|minpwdlength|pwdhistorylength|pwdproperties)') or lower(commandline) like '%adfind%-sc admincountdmp%' or lower(commandline) like '%adfind%-f%objectcategory=person%' or lower(commandline) like '%adfind%-sc exchaddresses%' or lower(commandline) like '%adfind%-f%objectcategory=person%objectclass=user%memberof=cn=administrators%' or lower(commandline) like '%adfind%-f%objectcategory=group%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adfind.*s.*base.*(lockoutduration|lockoutthreshold|lockoutobservationwindow|maxpwdage|minpwdage|minpwdlength|pwdhistorylength|pwdproperties)') or lower(commandline) like '%adfind%-sc admincountdmp%' or lower(commandline) like '%adfind%-f%objectcategory=person%' or lower(commandline) like '%adfind%-sc exchaddresses%' or lower(commandline) like '%adfind%-f%objectcategory=person%objectclass=user%memberof=cn=administrators%' or lower(commandline) like '%adfind%-f%objectcategory=group%') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),"(net.*?user|wmic.*?useraccount.*?get|powershell.*?(get-localuser|get-localgroupmember|get-wmiobject.*?-class.*?win32_useraccount|get-aduser)|lusrmgr|query.*?user|net.*?localgroup.*?administrators|net.*?group.*?administrators|net.*?group|net.*?accounts|net.*?localgroup|net.*?view|dsquery.*?user|dsget.*?user|reg.*?query.*?profilelist)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline),"(net.*?user|wmic.*?useraccount.*?get|powershell.*?(get-localuser|get-localgroupmember|get-wmiobject.*?-class.*?win32_useraccount|get-aduser)|lusrmgr|query.*?user|net.*?localgroup.*?administrators|net.*?group.*?administrators|net.*?group|net.*?accounts|net.*?localgroup|net.*?view|dsquery.*?user|dsget.*?user|reg.*?query.*?profilelist)") | groupby user, system

stream=firewall where dstport="22" and srctype="PRIVATE" and dsttype="PUBLIC" and crownjewel="Yes" and action="PACKET_ALLOWED" | groupby dstip, srcip

stream=firewall where dstport="22" and srctype="PRIVATE" and dsttype="PUBLIC" and crownjewel="Yes" and action="PACKET_ALLOWED" and dstip='{TargetHost}' and srcip='{SuspectHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(generaldomaininfo|winpwn).*?-(noninteractive|consoleoutput|domainrecon)') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(generaldomaininfo|winpwn).*?-(noninteractive|consoleoutput|domainrecon)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%new-smbshare%' or lower(commandline) like '%remove-smbshare%' or lower(commandline) like '%remove-psdrive%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%new-smbshare%' or lower(commandline) like '%remove-smbshare%' or lower(commandline) like '%remove-psdrive%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%new-smbshare%' or lower(commandline) like '%remove-smbshare%' or lower(commandline) like '%remove-psdrive%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%' or lower(commandline) like '%net share%/delete%' or lower(commandline) like '%new-smbshare%' or lower(commandline) like '%remove-smbshare%' or lower(commandline) like '%remove-psdrive%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(localappdata.*?md /c echo.*?type|http:|https:|-c write-host.*?net.webclient.*?::new.*?downloadstring|bypass|-exec|schtasks /create /sc daily.*?spawncmd.*?/c echo)') | groupby user, system 

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline),'(localappdata.*?md /c echo.*?type|http:|https:|-c write-host.*?net.webclient.*?::new.*?downloadstring|bypass|-exec|schtasks /create /sc daily.*?spawncmd.*?/c echo)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-FILE where action="FILE_CREATED" and rlike(lower(targetfilename),"\\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") | groupby substring_index(targetfilename,"\\",-1), targetfilename, user, system | select substring_index(targetfilename,"\\",-1) as file, targetfilename, user, system 

stream=EP-FILE where action="FILE_CREATED" and rlike(lower(targetfilename),"\\.(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") and targetfilename="{SuspectObject}" and user="{SuspectUser}" and system="{TargetHost}" | duraton 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(newprocessname), ".(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") | groupby NewProcessName, substring_index(NewProcessName,"\\",-1), user, system | select newprocessname, substring_index(NewProcessName,"\\",-1) as processname, user, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(newprocessname), ".(bat|cmd|ps1|vbs|js|wsf|py|pl|rb|ahk|reg|sql|sh|lnk|hta|batm|msc|mst|xsl|xml|css|hta|pl|php|java)") and newprocessname="{SuspectObject}" and user="{SuspectUser}" and system="{TargetHost}" | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%cmd /c%for /l %x in (1,1,%) do start%/p%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and lower(commandline) like '%cmd /c%for /l %x in (1,1,%) do start%/p%' | groupby user, system 

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(parentcommandline),'((sc|schtasks).*?create.*?win32times)') and parentuser='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(parentcommandline),'((sc|schtasks).*?create.*?win32times)') | groupby parentuser, system

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'((sc|schtasks).*?create.*?win32times)')  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="PROCESS_CREATED" and rlike(lower(commandline),'((sc|schtasks).*?create.*?win32times)') |  groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%cmd.exe%/q /c%1>%$%2>&1%") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like "%cmd.exe%/q /c%1>%$%2>&1%") | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%$%/u%' or lower(commandline) like '%new-psdrive%-psprovider%filesystem%-root%$%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net use%$%/u%' or lower(commandline) like '%new-psdrive%-psprovider%filesystem%-root%$%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.*?-accepteula.*?(-c|-f|-v)') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'psexec.*?-accepteula.*?(-c|-f|-v)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'get-wmiobject.*?-class.*?(ds_computer.*?-namespace|win32_ntdomain|win32_computersystem)') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'get-wmiobject.*?-class.*?(ds_computer.*?-namespace|win32_ntdomain|win32_computersystem)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%directoryservices.directorysearcher%ObjectCategory=Computer%' or lower(commandline) like '%get-adcomputer%' or lower(commandline) like '%adsisearcher%objectcategory=computer%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%new-object%directoryservices.directorysearcher%ObjectCategory=Computer%' or lower(commandline) like '%get-adcomputer%' or lower(commandline) like '%adsisearcher%objectcategory=computer%')  | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%adfind.exe%-f%objectcategory=computer%' or lower(commandline) like '%adfind.exe%-sc%dclist%' or lower(commandline) like '%adfind.exe%-f%objectcategory=ntdsdsa%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%adfind.exe%-f%objectcategory=computer%' or lower(commandline) like '%adfind.exe%-sc%dclist%' or lower(commandline) like '%adfind.exe%-f%objectcategory=ntdsdsa%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powerview%get-domaincontroller%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%powerview%get-domaincontroller%' | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%' or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or  lower(commandline) like '%nbtstat%-n%' or  lower(commandline) like '%nbtstat%-s%') and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%net%view%domain%net%view%' or lower(commandline) like '%net%group%domain%computers%domain%' or lower(commandline) like '%nltest.exe /dclist%' or lower(commandline) like '%nltest.exe /dsgetdc%' or lower(commandline) like '%ping -n%-w%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%nslookup%_ldap._tcp.dc.%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or lower(commandline) like '%adidnsdump%-u%-p%print-zones%' or  lower(commandline) like '%nbtstat%-n%' or  lower(commandline) like '%nbtstat%-s%') | duration 15m |  select system, user, commandline | limit 10000

stream=signals | groupby falsepositive |  duration 7d

stream=iam where eid IN (4720, 4722, 4725, 4728, 4732, 4756, 4740)  | duration 7d |  groupby eid | limit 10

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline),  '(net view|net share|get-smbshare|dir.*?\\$|get-wmiobject.*?win32_share|invoke-sharefinder|shareenumeration)') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline),  '(net view|net share|get-smbshare|dir.*?\\$|get-wmiobject.*?win32_share|invoke-sharefinder|shareenumeration)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=iam where eid IN (4720,4722,4725,4740)|  groupby cnamtime, eid, user,action |  duration 7d

stream=iam where eid IN (4728,4732,4756) | groupby cnamtime, eid, user, group, action |  duration 7d

stream=win-audit where eid = "5140" and user not like "%$%" and user not like "%@%" | groupby cnamtime, user, sharename, objecttype | duration 1d

stream=*  where extractorid='128' | duration 1d  | groupby eid | limit 10

stream=authentication where eid IN (4624,4625) and user not like "%@%" and user not like "%$%"| groupby cnamtime, action, user, system |  duration 1d

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(net user.*?add.*?net localgroup.*?administrators.*?add|net user.*?add|new-localuser.*?name|createnewlocaladmin.*?\.)') |  groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and commandline like '%net user /add%net localgroup administrators%/add%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' AND lower(commandline) like '%pdqdeployconsole%' | 

stream=FIREWALL where Action="CONNECTION_ESTABLISHED" and DstPort in ("139", "445") | groupby system | duration 7d

stream=win-audit where action="AUDIT_LOG_CLEARED" and EID="1102" and status="PASSED" | groupby user, system 

stream=win-audit where action="AUDIT_LOG_CLEARED" and EID="1102" and status="PASSED" and user='{SUspectUser}' and system='{TargetHost}' | duration 6m

stream=signals

stream=iam where eid IN (4720,4722,4725,4740)|  groupby cnamtime, eid, user,action |  duration 1d

stream=iam where eid IN (4720, 4722, 4725, 4728, 4732, 4756, 4740)  | duration 1d |  groupby eid | limit 10

stream=win-audit where action='PROCESS_CREATED' AND lower(commandline) like '%pdqdeployconsole%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' AND lower(commandline) like '%pdqdeployconsole%' | groupby user, system | duration 5d

stream=win-audit where action='PROCESS_CREATED' AND lower(commandline) like '%pdqdeployconsole%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' AND lower(commandline) like '%pdqdeployconsole%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and commandline like '%Software%Microsoft%Windows%NT%CurrentVersion%Winlogon%' and rlike(commandline, '(Shell|Userinit|Notify)\\.*?\.') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows nt.*?currentversion.*?winlogon.*?(shell|userinit|notify)') | groupby system, user

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows nt.*?currentversion.*?winlogon.*?(shell|userinit|notify)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows nt.*?currentversion.*?winlogon.*?(shell|userinit|notify)') | groupby system, user

stream=iam where eid IN (4720,4722,4725,4740)|  groupby cnamtime, eid, user,action |  duration 7d

stream=authentication where eid IN (4624,4625)| groupby cnamtime, action, user, system |  duration 7d

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%msbuild%proj%' or lower(commandline) like '%msbuild%.xml%' or lower(commandline) like '%msbuild%.dll%' or lower(commandline) like '%msbuild%.rsp%') | groupby system, user

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%msbuild%proj%' or lower(commandline) like '%msbuild%.xml%' or lower(commandline) like '%msbuild%.dll%' or lower(commandline) like '%msbuild%.rsp%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%cscript%pubprn%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where action='PROCESS_ADDED' and commandline like '%cscript%pubprn%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), 'reg query.*?(hklm.*?f.*?password.*?t.*?reg_sze|hkcu.*?f.*?password.*?t.*?reg_sz|hkcu.*?software.*?putty.*?sessions.*?t.*?reg_sz)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), 'reg query.*?(hklm.*?f.*?password.*?t.*?reg_sze|hkcu.*?f.*?password.*?t.*?reg_sz|hkcu.*?software.*?putty.*?sessions.*?t.*?reg_sz)') | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline), "wmic.*?(process list|os get).*?format.*?xsl") | groupby user, system

stream=EP-PROCESS where action='PROCESS_ADDED' and rlike(lower(commandline), "wmic.*?(process list|os get).*?format.*?xsl") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), "wmic.*?(process list|os get).*?format.*?xsl") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), "wmic.*?(process list|os get).*?format.*?xsl") | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%schtasks%create%tn%explorersync%tr%javaw%jar%microsoft%explorersync.db%sc%f%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%schtasks%create%tn%explorersync%tr%javaw%jar%microsoft%explorersync.db%sc%f%') | groupby user, system 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll')) | duration 1d |  groupby user, system, commandline 

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(net.*?stop|sc.*?stop|taskkill.*?/f)') | duration 1d

stream=authentication where eid IN (4624,4625)| groupby cnamtime, action, user, system |  duration 1d

stream=configuration where eid IN (7036,7040) and object is not null  | duration 1d |  groupby object , action, cnamtime

stream=*  where extractorid='128' | duration 1d  | groupby devsrcip |  select distinct_count(devsrcip)

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%msbuild%proj%' or lower(commandline) like '%msbuild%.xml%' or lower(commandline) like '%msbuild%.dll%' or lower(commandline) like '%msbuild%.rsp%')  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%msbuild%proj%' or lower(commandline) like '%msbuild%.xml%' or lower(commandline) like '%msbuild%.dll%' or lower(commandline) like '%msbuild%.rsp%') | groupby system, user

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(net user.*?add.*?net localgroup.*?administrators.*?add|net user.*?add|new-localuser.*?name|createnewlocaladmin.*?\.)') |  groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(net user.*?add.*?net localgroup.*?administrators.*?add|net user.*?add|new-localuser.*?name|createnewlocaladmin.*?\.)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(net user.*?add.*?net localgroup.*?administrators.*?add|net user.*?add|new-localuser.*?name|createnewlocaladmin.*?\.)') |  groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(net user.*?add.*?net localgroup.*?administrators.*?add|net user.*?add|new-localuser.*?name|createnewlocaladmin.*?\.)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg query HKLM%f%password%t%REG_SZ%' or commandline like '%reg query HKCU%f%password%t%REG_SZ%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), 'reg query.*?hklm.*?f.*?password.*?t.*?reg_sze|reg query.*?hkcu.*?f.*?password.*?t.*?reg_sz|reg query.*?hkcu.*?software.*?putty.*?sessions.*?t.*?reg_sz') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%schtasks%create%tn%explorersync%tr%javaw -jar%microsoft%explorersync.db%sc%f%') | groupby user, system |duration 1d

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and commandline like '%ExplorerSync.db%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%schtasks%create%tn%explorersync%tr%javaw%jar%microsoft%explorersync.db%sc%f%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%schtasks%create%tn%explorersync%tr%javaw%jar%microsoft%explorersync.db%sc%f%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%get-wmiobject%shadowcopy%delete%' or lower(commandline) like '%vssadmin%delete%shadows%' or lower(commandline) like '%wmic%shadowcopy%delete%' | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%get-wmiobject%shadowcopy%delete%' or lower(commandline) like '%vssadmin%delete%shadows%' or lower(commandline) like '%wmic%shadowcopy%delete%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=iam where eid IN (4728,4732,4756) | groupby cnamtime, eid, user, group, action |  duration 1d

stream=authentication where eid IN (4624,4625) and user not like "%@%" and user not like "%$%"| groupby cnamtime, action, user, system |  duration 1d

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%cscript%pubprn%' | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and commandline like '%cscript%pubprn%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (commandline like '%reg query HKLM%f%password%t%REG_SZ%' or commandline like '%reg query HKCU%f%password%t%REG_SZ%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), 'reg query.*?hklm.*?f.*?password.*?t.*?reg_sze|reg query.*?hkcu.*?f.*?password.*?t.*?reg_sz|reg query.*?hkcu.*?software.*?putty.*?sessions.*?t.*?reg_sz') | groupby user, system

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), 'reg query.*?hklm.*?f.*?password.*?t.*?reg_sze|reg query.*?hkcu.*?f.*?password.*?t.*?reg_sz|reg query.*?hkcu.*?software.*?putty.*?sessions.*?t.*?reg_sz') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and rlike(lower(commandline), 'reg query.*?hklm.*?f.*?password.*?t.*?reg_sze|reg query.*?hkcu.*?f.*?password.*?t.*?reg_sz|reg query.*?hkcu.*?software.*?putty.*?sessions.*?t.*?reg_sz') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%schtasks%create%tn%explorersync%tr%javaw%jar%microsoft%explorersync.db%sc%f%') | groupby user, system | duration 1d

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%schtasks%create%tn%explorersync%tr%javaw%jar%microsoft%explorersync.db%sc%f%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%schtasks%create%tn%explorersync%tr%javaw%jar%microsoft%explorersync.db%sc%f%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%schtasks%create%tn%explorersync%tr%javaw%jar%microsoft%explorersync.db%sc%f%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'windows.*?syswow64.*?register-cimprovider.exe.*?.dll|register-cimprovider.*?path.*?evil.*?dll') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%windows%syswow64%register-cimprovider.exe%.dll%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=signals | duration 5m

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(commandline), "(dsquery.*?filter.*?objectclass=trusteddomain|nltest.*?(domain_trusts|trusted_domains))") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action="PROCESS_ADDED" and rlike(lower(commandline), "(dsquery.*?filter.*?objectclass=trusteddomain|nltest.*?(domain_trusts|trusted_domains))") | groupby user, system 

stream=nta-intel  | groupby indicatortype, msg, srcip, dstip | duration 30m

stream=nta-intel where indicatortype="{TargetResource}" and srcip="{}SuspectHost" |  duration 30m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (lower(commandline) like '%diskshadow.exe%-s%' or lower(commandline) like '%system32%diskshadow.exe%' or lower(commandline) like '%system64%diskshadow.exe%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and (lower(commandline) like '%diskshadow.exe%-s%' or lower(commandline) like '%system32%diskshadow.exe%' or lower(commandline) like '%system64%diskshadow.exe%') | groupby user, system

stream=ep-process where action='PROCESS_ADDED' AND rlike(lower(commandline), "trufflesnout.*?(domain|forest)") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' AND rlike(lower(commandline), "trufflesnout.*?(domain|forest)") | groupby user, system 

stream=email-gateway where sourcename="MS-O365" and action="EMAIL_ACCEPTED"  | duration 1h | groupby sender | select sender, count(*) as acceptance_count | limit 10

stream=IAM where sourcename="MS-O365" | duration 1h |  groupby action, operation

stream=email-gateway where sourcename="MS-O365" | duration 1h |  groupby action, operation

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'gpscript.exe' and (lower(commandline) like '%gpscript%logon%' or lower(commandline) like '%gpscript%startup%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like 'gpscript.exe' and (lower(commandline) like '%gpscript%logon%' or lower(commandline) like '%gpscript%startup%') | groupby user, system | duration 1h

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(hklm.*?software.*?microsoft.*?windows.*?currentversion.*?app paths.*?winword.exe.*?protocolhandler.*?(exe|\.)|microsoft office.*?root.*?protocolhandler.*?(exe|\.)|microsoft_wordpath.*?protocolhandler.*?(exe|\.))') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(hklm.*?software.*?microsoft.*?windows.*?currentversion.*?app paths.*?winword.exe.*?protocolhandler.*?(exe|\.)|microsoft office.*?root.*?protocolhandler.*?(exe|\.)|microsoft_wordpath.*?protocolhandler.*?(exe|\.))') | groupby user, system

stream=* where sourcetype='OS' |  duration 10m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%windows%microsoft.net%microsoft.workflow.compiler.exe%') or (lower(commandline) like '%microsoft.workflow.compiler.exe%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%windows%microsoft.net%microsoft.workflow.compiler.exe%') or (lower(commandline) like '%microsoft.workflow.compiler.exe%') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' AND rlike(lower(commandline), "powerview.*?get-(domain|forest)trust") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' AND rlike(lower(commandline), "powerview.*?get-(domain|forest)trust") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' AND rlike(lower(commandline), "powerview.*?get-(domain|forest)trust") | groupby user, system

stream=win-audit where action='PROCESS_CREATED' AND rlike(lower(commandline), "powerview.*?get-(domain|forest)trust") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' AND rlike(lower(commandline), "trufflesnout.*?(domain|forest)") | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' AND rlike(lower(commandline), "trufflesnout.*?(domain|forest)") and user='{SUspectUser}' and system='{TargetHost}' |duration 6m

stream=AUTHENTICATION where action='LOGIN' AND NOT user in ('user1', 'user2')| duration 15m | select srcip, user, system, count_if(status='FAILED') as failcount, count_if(status='PASSED') as passcount | groupby srcip, system, user | having failcount >=50 and failcount >= passcount * 5

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and ((commandline like '%ie4uinit.exe%ieuinit.inf%') or lower(commandline) like '%ie4unit.exe%' or lower(commandline) like '%ieunit.inf%' ) | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and eid='4688' and ((commandline like '%ie4uinit.exe%ieuinit.inf%') or lower(commandline) like '%ie4unit.exe%' or lower(commandline) like '%ieunit.inf%' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where rlike(lower(commandline), "(export-certificate.*?cert.*?filepath.*?(cer|pfx)|export-pfxcertificate.*?cert.*?filepath.*?(cer|pfx)|certutil.*?store.*?(cer|pfx)|certutil.*?exportpfx.*?(cert.pfx|pfx))") | groupby system, user

stream=win-audit where rlike(lower(commandline), "(export-certificate.*?cert.*?filepath.*?(cer|pfx)|export-pfxcertificate.*?cert.*?filepath.*?(cer|pfx)|certutil.*?store.*?(cer|pfx)|certutil.*?exportpfx.*?(cert.pfx|pfx))") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'windows.*?syswow64.*?register-cimprovider.exe.*?.dll|register-cimprovider.*?path.*?evil.*?dll') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'windows.*?syswow64.*?register-cimprovider.exe.*?.dll|register-cimprovider.*?path.*?evil.*?dll') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=AUTHENTICATION where action='LOGIN' AND user NOT IN [117.08.96.22, 117.08.96.23] | duration 15m | select srcip, user, system, count_if(status='FAILED') as failcount, count_if(status='PASSED') as passcount | groupby srcip, system, user | having failcount >=50 and failcount >= passcount * 5

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%wuauclt.exe%.dll%' or lower(commandline) like '%wuauclt.exe%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%wuauclt.exe%.dll%' or lower(commandline) like '%wuauclt.exe%' | groupby user, system

stream=ep-process where action='PROCESS_ADDED' and ((commandline like '%customshellhost.exe%calc.exe%') and eid='1') or rlike(lower(commandline), 'destination.*?(customshellhost.exe|explorer.exe).*?force') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and ((commandline like '%customshellhost.exe%calc.exe%') and eid='1') or rlike(lower(commandline), 'destination.*?(customshellhost.exe|explorer.exe).*?force') | groupby  user, system

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like "%hklm%software%microsoft%provlaunch.exe%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like "%hklm%software%microsoft%provlaunch.exe%" | duration 1h

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like "%hklm%software%microsoft%provlaunch.exe%" and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like "%hklm%software%microsoft%provlaunch.exe%" | groupby system, user

stream=win-audit where rlike(lower(commandline), "(export-certificate.*?cert.*?filepath.*?(cer|pfx)|export-pfxcertificate.*?cert.*?filepath.*?(cer|pfx)|certutil.*?store.*?(cer|pfx)|certutil.*?exportpfx.*?(cert.pfx|pfx))") | groupby system, user

stream=win-audit where rlike(lower(commandline), "(export-certificate.*?cert.*?filepath.*?(cer|pfx)|export-pfxcertificate.*?cert.*?filepath.*?(cer|pfx)|certutil.*?store.*?(cer|pfx)|certutil.*?exportpfx.*?(cert.pfx|pfx))") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(windows.*?(system32|system64).*?infdefaultinstall.exe|infdefaultinstall.exe)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(windows.*?(system32|system64).*?infdefaultinstall.exe|infdefaultinstall.exe)') | groupby user, system

stream=email-gateway where sourcename = "MS-O365" and action="EMAIL_DELETED" |  groupby Sender | duration 1d | limit 10

stream=DOCUMENTS where action='ACCESSED' AND sourcename="MS-O365" | duration 1d | groupby user | select user, count(*) as access_count | limit 10

stream=documents where sourcename="MS-O365" | duration 1h | groupby action, operation

stream=threat where sourcename="MS-O365" | duration 1d |  groupby threat, @ThreatsAndDetectionTech[1] 

stream=DOCUMENTS where sourcename="MS-O365" and action="UPLOADED"  | duration 1d | groupby user | select user, count(*) as upload_count | limit 10

stream=authentication where SourceName="MS-O365" and action='LOGIN' and not user="Not Available" | duration 1h | groupby user, status | select user, status, count(*) as login_attempts | limit 10

stream=authentication where SourceName="MS-O365" and action="LOGIN" and status="PASSED" | groupby user | select user, distinct_count(srccn) as country_count | duration 1h | having country_count > 1 | limit 10

stream=win-audit where eid="4670" |  duration 7d | groupby objecttype, objectserver, object, processname, @OldSd , @NewSd

stream=win-audit where rlike(lower(commandline), "((export-certificate|export-pfxcertificate).*?cert.*?filepath.*?(cer|cert.pfx|pfx)|certutil.*?store.*?cer|certutil.*?exportpfx.*?(cert.pfx|pfx))") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where rlike(lower(commandline), "((export-certificate|export-pfxcertificate).*?cert.*?filepath.*?(cer|cert.pfx|pfx)|certutil.*?store.*?cer|certutil.*?exportpfx.*?(cert.pfx|pfx))") | groupby system, user

stream=win-audit where rlike(lower(commandline), "(export-certificate.*?cert.*?filepath.*?(cer|pfx)|export-pfxcertificate.*?cert.*?filepath.*?(cer|pfx)|certutil.*?store.*?(cer|pfx)|certutil.*?exportpfx.*?(cert.pfx|pfx))") | groupby system, user

stream=win-audit where rlike(lower(commandline), "(export-certificate.*?cert.*?filepath.*?(cer|pfx)|export-pfxcertificate.*?cert.*?filepath.*?(cer|pfx)|certutil.*?store.*?(cer|pfx)|certutil.*?exportpfx.*?(cert.pfx|pfx))") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where eid="4670" |  duration 7d | groupby objecttype, objectserver, object, processname, @OldSd , @NewSd

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%get-childitem%bookmarks%' or lower(commandline) like '%r c:%bookmarks%' or lower(commandline) like '%r c:%places.sqlite%' or lower(commandline) like '%s %b%userprofile%favorites%') | groupby user, system 

stream=ep-process where action='PROCESS_ADDED' and (lower(commandline) like '%get-childitem%bookmarks%' or lower(commandline) like '%r c:%bookmarks%' or lower(commandline) like '%r c:%places.sqlite%' or lower(commandline) like '%s %b%userprofile%favorites%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(export-certificate.*?cert.*?filepath.*?(cer|pfx)|export-pfxcertificate.*?cert.*?filepath.*?(cer|pfx)|certutil.*?store.*?(cer|pfx)|certutil.*?exportpfx.*?(cert.pfx|pfx))') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(export-certificate.*?cert.*?filepath.*?(cer|pfx)|export-pfxcertificate.*?cert.*?filepath.*?(cer|pfx)|certutil.*?store.*?(cer|pfx)|certutil.*?exportpfx.*?(cert.pfx|pfx))') | groupby system, user

stream=configuration where action='CONFIGURATION_CHANGED' and (rlike(lower(commandline) , 'findstr.*?si.*?pass.*?.(xml|doc|txt|xls)')) 

stream=nta-notice where srcip = "{TargetHost}" and dstip = "SuspectHost" |  duration 1h

stream=nta-notice where noticeidentifier like "%SSL::Invalid_Server_Cert%" and analyzer like '%Notice::ACTION_LOG%' and errormsg like '%self signed certificate%' or errormsg like '%certificate has expired%'| groupby noticeidentifier, srcip, dstip, errormsg |  duration 1h

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), 'system.management.automation.amsi.*?(amsiinitfailed|scancontent|amsicontext|amsisession|amsiutils.init|amsiscanbuffer|amsi.dll)') | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (lower(scriptblocktext) like '%system.management.automation.amsi%amsiinitfailed%' or lower(scriptblocktext) like '%system.management.automation.amsi%scancontent%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsicontext%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsisession%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsiutils.init()%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsiscanbuffer%' or lower(scriptblocktext) like '%system.management.automation.amsi%amsi.dll%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=nta-notice where noticeidentifier like "%SSL::Invalid_Server_Cert%" and analyzer like '%Notice::ACTION_LOG%' and errormsg like '%self signed certificate%' or errormsg like '%certificate has expired%'| groupby noticeidentifier, srcip, dstip, errormsg |  duration 1h |  limit 1

stream=nta-notice where srcip = "{SuspectHost}" and dstip = "{TargetHost}" |  duration 1h

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'system.management.automation.amsi.*?(amsiinitfailed|scancontent|amsicontext|amsisession|amsiutils.init|amsiscanbuffer|amsi.dll)') | groupby user, system

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline),'system.management.automation.amsi.*?(amsiinitfailed|scancontent|amsicontext|amsisession|amsiutils.init|amsiscanbuffer|amsi.dll)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=firewall | timeslice 1m

stream=FIREWALL where not txlen in ("", "null") and Action="PACKET_ALLOWED" and not DstPort in ("443","80","53","25","22","123","8080","110","3389","161","143","20","21","23") | groupby srcip, dstport, txlen | duration 7d

stream=configuration where action="CONFIGURATION_CHANGED" and ( rlike(lower(commandline),"set\-mppreference.*?(disablerealtimemonitoring|disablebehaviormonitoring|disableblockatfirstseen|disablescriptscanning|drtm|dbm|dscrptsc|dbaf).*?(true|1)") or rlike(lower(commandline),"set\-mppreference.*?(mapsreporting|puaprotection|submitsamplesconsent).*?(0|false|2)") or rlike(lower(commandline), "(disable-mpamservice|disable-mpsignatureupdate|uninstall-mpwdoscan)")) and system='{TargetHost}' | duration 6m

stream=configuration where action="CONFIGURATION_CHANGED" and ( rlike(lower(commandline),"set\-mppreference.*?(disablerealtimemonitoring|disablebehaviormonitoring|disableblockatfirstseen|disablescriptscanning|drtm|dbm|dscrptsc|dbaf).*?(true|1)") or rlike(lower(commandline),"set\-mppreference.*?(mapsreporting|puaprotection|submitsamplesconsent).*?(0|false|2)") or rlike(lower(commandline), "(disable-mpamservice|disable-mpsignatureupdate|uninstall-mpwdoscan)")) |  groupby system 

stream=threat where sourcetype='ENDPOINT-SECURITY' AND sourcename='PALOALTO-CORTEX' and file like '%{SuspectObject}%' and system='{TargetHost}' | duration 1M

stream=threat where sourcetype='ENDPOINT-SECURITY' AND sourcename='PALOALTO-CORTEX' | duration 1M | limit 1 | select substring_index(file,"\\",-1) as file, system, threat |  groupby file, system, threat

stream=threat where sourcetype='ENDPOINT-SECURITY' AND sourcename='PALOALTO-CORTEX' and file like '%{SuspectObject}%' and system='{TargetHost}' | duration 1M

stream=threat where sourcetype='ENDPOINT-SECURITY' AND sourcename='PALOALTO-CORTEX' | duration 1M | limit 1 | select substring_index(file,"\\",-1) as file, system, threat |  groupby file, system, threat

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%winpwn%' and rlike(lower(commandline), '(winpeas|itm4nprivesc|privesccheck|allchecks|oldchecks|otherchecks|generalrecon|morerecon|rbcd-check|powersharppack.*?(watson|sharpup|powerup|seatbelt))')) and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%winpwn%' and rlike(lower(commandline), '(winpeas|itm4nprivesc|privesccheck|allchecks|oldchecks|otherchecks|generalrecon|morerecon|rbcd-check|powersharppack.*?(watson|sharpup|powerup|seatbelt))'))| duration 15m | select system, user, commandline | limit 10000

stream=win-audit where action='PROCESS_CREATED' AND (lower(commandline) like '%driverquery /v%' or lower(commandline) like '%driverquery /si%' or lower(commandline) like '%driverquery /fo%') | duration 2d

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%winpwn%' and rlike(lower(commandline), '(winpeas|itm4nprivesc|privesccheck|allchecks|oldchecks|otherchecks|generalrecon|morerecon|rbcd-check|powersharppack.*?(watson|sharpup|powerup|seatbelt))')) and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%winpwn%' and rlike(lower(commandline), '(winpeas|itm4nprivesc|privesccheck|allchecks|oldchecks|otherchecks|generalrecon|morerecon|rbcd-check|powersharppack.*?(watson|sharpup|powerup|seatbelt))'))| duration 15m | select system, user, commandline | limit 10000

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%winpwn%' and rlike(lower(commandline), '(winpeas|itm4nprivesc|privesccheck|allchecks|oldchecks|otherchecks|generalrecon|morerecon|rbcd-check|powersharppack.*?(watson|sharpup|powerup|seatbelt))')) and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%winpwn%' and rlike(lower(commandline), '(winpeas|itm4nprivesc|privesccheck|allchecks|oldchecks|otherchecks|generalrecon|morerecon|rbcd-check|powersharppack.*?(watson|sharpup|powerup|seatbelt))'))| duration 15m | select system, user, commandline | limit 10000

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%winpwn%' and rlike(lower(commandline), '(winpeas|itm4nprivesc|privesccheck|allchecks|oldchecks|otherchecks|generalrecon|morerecon|rbcd-check|powersharppack.*?(watson|sharpup|powerup|seatbelt))')) and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%winpwn%' and rlike(lower(commandline), '(winpeas|itm4nprivesc|privesccheck|allchecks|oldchecks|otherchecks|generalrecon|morerecon|rbcd-check|powersharppack.*?(watson|sharpup|powerup|seatbelt))'))| duration 15m | select system, user, commandline | limit 10000

stream=win-audit where action='PROCESS_CREATED' AND (lower(commandline) like '%driverquery /v%' or lower(commandline) like '%driverquery /si%' or lower(commandline) like '%driverquery /fo%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' AND (lower(commandline) like '%driverquery /v%' or lower(commandline) like '%driverquery /si%' or lower(commandline) like '%driverquery /fo%') | groupby user, system 

stream=win-audit where action='PROCESS_CREATED' AND (lower(commandline) like '%driverquery /v%' or lower(commandline) like '%driverquery /si%' or lower(commandline) like '%driverquery /fo%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' AND (lower(commandline) like '%driverquery /v%' or lower(commandline) like '%driverquery /si%' or lower(commandline) like '%driverquery /fo%') | groupby user, system 

stream=nta-ssl where (version='TLSv10' or version='TLSv11') | groupby devsrcip, version |  duration 2h

stream=nta-ssl where (version='TLSv10' or version='TLSv11') and devsrcip='{TargetResource}'|  duration 1h

stream=DNS where query like "%api.telegram.org/bot%" | groupby srcip

stream=DNS where query like "%api.telegram.org/bot%" and srcip='{SuspectHost}' | duration 6m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::DOMAIN' and dstip='{TargetHost}' | duration 10m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::DOMAIN' | groupby devsrcip, indicatortype, dstip| duration 10m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::DOMAIN' and dstip='{TargetHost}' | duration 10m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::DOMAIN' | groupby devsrcip, indicatortype, dstip| duration 10m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::DOMAIN' | groupby devsrcip, indicatortype, dstip| duration 10m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::DOMAIN' and dstip='{TargetHost}' | duration 10m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::FILE_HASH' |  duration 10m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::FILE_HASH' |  duration 10m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%winpwn%' and rlike(lower(commandline), '(winpeas|itm4nprivesc|privesccheck|allchecks|oldchecks|otherchecks|generalrecon|morerecon|rbcd-check|powersharppack.*?(watson|sharpup|powerup|seatbelt))'))| duration 15m | select system, user, commandline | limit 10000

stream=WIN-AUDIT where action='PROCESS_CREATED' and (lower(commandline) like '%winpwn%' and rlike(lower(commandline), '(winpeas|itm4nprivesc|privesccheck|allchecks|oldchecks|otherchecks|generalrecon|morerecon|rbcd-check|powersharppack.*?(watson|sharpup|powerup|seatbelt))')) and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=authentication where user!="" |  duration 6h

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts|whoami /all|net view /all|cmd /c set|net share|route print|netstat -nao|qwinsta|wmi query rootcim)"))  and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=win-audit where action='PROCESS_CREATED' and (rlike(lower(commandline), "(ipconfig /all|netsh interface show interface|arp -a|nbtstat -n|net config workstation|net view /all /domain|nltest /domain_trusts|whoami /all|net view /all|cmd /c set|net share|route print|netstat -nao|qwinsta|wmi query rootcim)")) | duration 15m |  select system, user, commandline | limit 10000

stream=DNS where action="DNS_QUERIED" and responsecode="NXDOMAIN" and status="PASSED" | groupby srcip, query |  select srcip, query, count(*) as count | having count > 500 

stream=DNS where action="DNS_QUERIED" and responsecode="NXDOMAIN" and status="PASSED" and srcip='{SuspectHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' AND rlike(lower(scriptblocktext), '(hklm|hkey_local_machine).*?hardware.*?description.*?system%bios') | duration 1h

stream=DNS where action="DNS_QUERIED" and responsecode="NXDOMAIN" and status="FAILED" and srcip='{SuspectHost}' | duration 6m

stream=DNS where action="DNS_QUERIED" and responsecode="NXDOMAIN" and status="FAILED" | groupby srcip |  select srcip, count(*) as count | having count > 500 

stream=DNS where action="REQUEST_ALLOWED" and status="PASSED" | groupby srcip | select count(action) as totalcount | having totalcount > 10000

stream=DNS where action="REQUEST_ALLOWED" and status="PASSED" and srcip='{SuspectHost}' | duration 6m

stream=documents where action in ('ACCESSED', 'DOWNLOADED') and srccn in ('CN', 'KP') | groupby user

stream=documents where action in ('ACCESSED', 'DOWNLOADED') and srccn in ('CN', 'KP') and user='{SuspectUser}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and (rlike(lower(scriptblocktext), '(hklm|hkey_local_machine).*?hardware.*?description.*?system') and lower(scriptblocktext) like '%bios%') | duration 2h

stream=win-audit where action='OBJECT_ACCESSED' and (rlike(lower(scriptblocktext), '(hklm|hkey_local_machine).*?hardware.*?description.*?system') and lower(scriptblocktext) like '%bios%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and (rlike(lower(scriptblocktext), '(hklm|hkey_local_machine).*?hardware.*?description.*?system') and lower(scriptblocktext) like '%bios%') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and (rlike(lower(scriptblocktext), '(hklm|hkey_local_machine).*?hardware.*?description.*?system') and lower(scriptblocktext) like '%bios%') | groupby user, system

stream=win-audit where action="PROCESS_CREATED" and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) | duration 15m | select system, user, commandline | limit 10000

stream=win-audit where action="PROCESS_CREATED" and (lower(commandline) like '%systeminfo%' or lower(commandline) like '%ipconfig /all%' or lower(commandline) like '%arp -a%' or lower(commandline) like '%dir%' or lower(commandline) like '%tree%' or lower(commandline) like '%net user%' or lower(commandline) like '%tasklist%' or lower(commandline) like '%reg query%' or lower(commandline) like '%ping%') or (lower(commandline) like '%get-wmiobject -class win32_computersystem%' or lower(commandline) like '%get-wmiobject -class win32_operatingsystem%' or lower(commandline) like '%get-wmiobject -class win32_bios%' or lower(commandline) like '%get-netipaddress%' or lower(commandline) like '%get-netadapter%' or lower(commandline) like '%get-childitem%' or lower(commandline) like '%get-item%' or lower(commandline) like '%get-localuser%' or lower(commandline) like '%get-localgroupmember%' or lower(commandline) like '%get-process%' or lower(commandline) like '%get-itemproperty%' or lower(commandline) like '%test-connection%' or lower(commandline) like '%dir% /b /s %.docx%findstr% /e %.docx%for /r%in%copy /y%' or lower(commandline) like '%new-item% -path% -itemtype directory% -force%' or lower(commandline) like '%get-service%' or lower(commandline) like '%get-childitem% env:%' or lower(commandline) like '%get-process%' or lower(commandline) like '%sc% query type=service%' or lower(commandline) like '%doskey% /history%' or lower(commandline) like '%wmic% process% list%' ) and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=EMAIL-GATEWAY where action='EMAIL_REDIRECTED' and rlike(recipient,"(gmail|yahoo|rediffmail|outlook|hotmail|proton)") and sender='{SuspectUser}' | duration 6m

stream=EMAIL-GATEWAY where action='EMAIL_REDIRECTED' and rlike(recipient,"(gmail|yahoo|rediffmail|outlook|hotmail|proton)") | select sender, count(action) as CntEmails | groupby sender | having CntEmails >= 2

stream=DNS where query like "%==.%" | groupby srcip

stream=DNS where query like "%==.%" and srcip='{SuspectHost}' and srcip='{SuspectHost}' | duration 6m

stream=DNS where query like "%api.telegram.org/bot%" and srcip='{SuspectHost}' | duration 6m

stream=DNS where query like "%api.telegram.org/bot%" | groupby srcip

stream=EMAIL-GATEWAY where action='EMAIL_REDIRECTED' and (recipient like "%gmail%" or recipient like "%yahoo%" or recipient like "%rediffmail%" or recipient like "%outlook% or recipient like "%hotmail%" or recipient like "%proton%") and sender='{SuspectUser}' | duration 6m

stream=EMAIL-GATEWAY where action='EMAIL_REDIRECTED' and rlike(recipient,"(gmail|yahoo|rediffmail|outlook|hotmail|proton)") | select sender, count(action) as CntEmails | groupby sender | having CntEmails >= 2

stream=email-gateway where action='EMAIL_ACCEPTED' and rlike(file, "\\.(apk|app|bat|bin|cgi|com|dll|dmg|exe|jar|js|jse|msi|py|scr|sh|vbs|wsf|wsh|xap|x86|xex)\\.") and sender='{SuspectUser}' | duration 6m

stream=email-gateway where action='EMAIL_ACCEPTED' and rlike(file, "\\.(apk|app|bat|bin|cgi|com|dll|dmg|exe|jar|js|jse|msi|py|scr|sh|vbs|wsf|wsh|xap|x86|xex)\\.") | groupby sender

stream=iam where action in ('MAILBOX_PERMISSION_ADDED','MAILBOX_PERMISSION_REMOVED') | duration 30m | select user, distinct_count(action) as cnt_action | groupby user | having cnt_action==2

stream=iam where action in ('MAILBOX_PERMISSION_ADDED','MAILBOX_PERMISSION_REMOVED') and user='{SuspectUser}' | duration 31m

stream=authentication where action="LOGIN" and status="PASSED" and authproto="SSH" | duration 1h | select system, user, distinct_count(srcip) as srcipcount | groupby system, user | having srcipcount > 3

stream=authentication where action="LOGIN" and status="PASSED" and authproto="SSH" and user='{SuspectUser}' and system='{TargeHost}' | duration 1h

stream=documents where action='DELETED' and user='{SuspectUser}' | duration 7d

stream=documents where action='UPLOADED' AND status='PASSED' AND visibility='PUBLIC' | groupby user

stream=documents where action='UPLOADED' AND status='PASSED' AND visibility='PUBLIC' and user='{SuspectUser}' | duration 6m

stream=documents where action='DOWNLOADED' and user='{SuspectUser}' | duration 7d

stream=documents where action='ACCESSED' and user='{SuspectUser}' | duration 7d

stream=documents where action in ('ACCESSED', 'DOWNLOADED') and srccn in ('CN', 'KR') and user='{SuspectUser}' | duration 6m

stream=documents where action in ('ACCESSED', 'DOWNLOADED') and srccn in ('CN', 'KR') | groupby user

stream=documents where action='DOWNLOADED' and srcip='{SuspectHost}' | duration 7d

stream=email-gateway where action='EMAIL_ACCEPTED' and (file like "%.exe.%" or file like "%.scr.%" or file like "%.js.%" or file like "%.bat.%") | groupby sender

stream=email-gateway where action='EMAIL_ACCEPTED' and (file like "%.exe.%" or file like "%.scr.%" or file like "%.js.%" or file like "%.bat.%") and sender='{SuspectUser}' | duration 6m

stream=EMAIL-GATEWAY where action='EMAIL_REDIRECTED' and (recipient like "%gmail%" or recipient like "%yahoo%" or recipient like "%rediffmail%" or recipient like "%outlook% or recipient like "%hotmail%" or recipient like "%proton%") and sender='{SuspectUser}' | duration 6m

stream=EMAIL-GATEWAY where action='EMAIL_REDIRECTED' and (recipient like "%gmail%" or recipient like "%yahoo%" or recipient like "%rediffmail% or recipient like "%outlook% or recipient like "%hotmail%" or recipient like "%proton%") | select sender, count(action) as CntEmails | groupby sender | having CntEmails > 100

stream=authentication where action="LOGIN" and status="PASSED" and authproto="RDP" | duration 1h | select system, user, distinct_count(srcip) as srcipcount | groupby system, user | having srcipcount > 3

stream=authentication where action="LOGIN" and status="PASSED" and authproto="RDP" and user='{SuspectUser}' and system="{TragetHost}" | duration 1h

stream=DNS where action="REQUEST_ALLOWED" and status="PASSED" | groupby srcip | select count(action) as totalcount | having totalcount > 10000

stream=DNS where action="REQUEST_ALLOWED" and status="PASSED" and srcip='{SuspectHost}' | duration 6m

stream=DNS where query in ("ifferfsodp9ifjaposdfjhgosurijfaewrwergwea.testing", "ifferfsodp9ifjaposdfjhgosurijfaewrwergwea.test", "ifferfsodp9ifjaposdfjhgosurijfaewrwergwea.com", "ayylmaotjhsstasdfasdfasdfasdfasdfasdfasdf.com", "iuqssfsodp9ifjaposdfjhgosurijfaewrwergwea.com", "iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com", "iuqerfsodp9ifjaposdfjhgosurijfaewrwergweb.com", "iuqssfsodp9ifjaposdfjhgosurijfaewrwergwea.com", "ayylmaotjhsstasdfasdfasdfasdfasdfasdfasdf.com") | groupby srcip

stream=DNS where query in ("ifferfsodp9ifjaposdfjhgosurijfaewrwergwea.testing", "ifferfsodp9ifjaposdfjhgosurijfaewrwergwea.test", "ifferfsodp9ifjaposdfjhgosurijfaewrwergwea.com", "ayylmaotjhsstasdfasdfasdfasdfasdfasdfasdf.com", "iuqssfsodp9ifjaposdfjhgosurijfaewrwergwea.com", "iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com", "iuqerfsodp9ifjaposdfjhgosurijfaewrwergweb.com", "iuqssfsodp9ifjaposdfjhgosurijfaewrwergwea.com", "ayylmaotjhsstasdfasdfasdfasdfasdfasdfasdf.com") AND srcip='{SuspectHost}' | duration 6m

stream=DNS where query like "%==.%" | groupby srcip

stream=DNS where query like "%==.%" and srcip='{SuspectHost}' and srcip='{SuspectHost}' | duration 6m

stream=DNS where (query LIKE "aaa.stage.%" OR query LIKE "post.1%") and srcip='{SuspectHost}' | duration 6m

stream=DNS where (query LIKE "aaa.stage.%" OR query LIKE "post.1%") | groupby srcip

stream=DNS where action="DNS_QUERIED" and responsecode="NXDOMAIN" and status="PASSED" | groupby srcip, query |  select srcip, query, count(*) as count | having count > 500 

stream=DNS where action="DNS_QUERIED" and responsecode="NXDOMAIN" and status="PASSED" and srcip='{SuspectHost}' | duration 6m

stream=iam where action in ('MAILBOX_PERMISSION_ADDED','MAILBOX_PERMISSION_REMOVED') | duration 30m | select user, distinct_count(action) as cnt_action | groupby user | having cnt_action=2

stream=iam where action in ('MAILBOX_PERMISSION_ADDED','MAILBOX_PERMISSION_REMOVED') and user='{SuspectUser}' | duration 31m

stream=EMAIL-GATEWAY where action='EMAIL_ACCEPTED' and (file like "%.exe%" or file like "%.scr%" or file like "%.js%" or file like "%.dll%") | groupby sender

stream=EMAIL-GATEWAY where action='EMAIL_ACCEPTED' and (file like "%.exe%" or file like "%.scr%" or file like "%.js%" or file like "%.dll%") and sender='{SuspectUser}' | duration 6m

stream=EMAIL-GATEWAY where action='EMAIL_SENT' and direction='Outgoing' and sender='{SuspectHost}' | duration 7d

stream=authentication where action="LOGIN" and srcip!="" and system!=""| groupby srcip,system | select srcip, system, count_if(status="PASSED") |  having count_if_col2>1

stream=win-audit where action='OBJECT_ACCESSED' and (rlike(lower(scriptblocktext), '(hklm|hkey_local_machine).*?hardware.*?description.*?system') and lower(scriptblocktext) like '%bios%') | duration 2h

stream=email-gateway where action='EMAIL_ACCEPTED' and rlike(file, "\\.(apk|app|bat|bin|cgi|com|dll|dmg|exe|jar|js|jse|msi|py|scr|sh|vbs|wsf|wsh|xap|x86|xex)") | groupby sender

stream=EMAIL-GATEWAY where action='EMAIL_ACCEPTED' and (file like "%.exe%" or file like "%.scr%" or file like "%.js%" or file like "%.dll%") and sender='{SuspectUser}' | duration 6m

stream=auditd where action='process_ADDED' and ((process like '%ufw%' and (processargs like '%allow%' or processargs like '%disable%' or processargs like '%reset%')) or ((process like '%service%' and processargs like '%stop%') or (process like '%chkconfig%' and processargs like '%off%') or ((process='%systemctl' and processArgs like '%disable%') or (process like '%systemctl%' and processargs like '%stop%') or (process like '%systemctl%' and processargs like '%kill%')) and processargs like '%firewalld%' or processargs like '%ip6tables%' or processargs like '%iptables%'))) and system='{TargetHost}' | duration 6m

stream=auditd where action='process_ADDED' and ((process like '%ufw%' and (processargs like '%allow%' or processargs like '%disable%' or processargs like '%reset%')) or ((process like '%service%' and processargs like '%stop%') or (process like '%chkconfig%' and processargs like '%off%') or ((process='%systemctl' and processArgs like '%disable%') or (process like '%systemctl%' and processargs like '%stop%') or (process like '%systemctl%' and processargs like '%kill%')) and processargs like '%firewalld%' or processargs like '%ip6tables%' or processargs like '%iptables%'))) | groupby system

stream=auditd where action='PROCESS_ADDED' and process like "%nping%" and system='{TargetHost}' | duration 6m

stream=auditd where action='PROCESS_ADDED' and process like "%nping%" | groupby system

stream=firewall where dstport="22" and srctype="PRIVATE" and dsttype="PUBLIC" and crownjewel="Yes" and action="PACKET_ALLOWED" | groupby dstip, srcip

stream=firewall where dstport="22" and srctype="PRIVATE" and dsttype="PUBLIC" and crownjewel="Yes" and action="PACKET_ALLOWED" and dstip='{TargetHost}' and srcip='{SuspectHost}' | duration 6m

stream=AUDITD where action='PROCESS_ADDED' and (process like "%iodine" or process like "%iodined") | groupby system

stream=AUDITD where action='PROCESS_ADDED' and (process like "%iodine" or process like "%iodined") and system='{TargetHost}' | duration 6m

stream=AUDITD where action='PROCESS_ADDED' and (processargs like "%sudo%rmmod%") or (processargs like "%sudo%modprobe%" and (processargs like "%remove%" or processargs like "%-r%")) | groupby system

stream=AUDITD where action='PROCESS_ADDED' and (processargs like "%sudo%rmmod%") or (processargs like "%sudo%modprobe%" and (processargs like "%remove%" or processargs like "%-r%")) and system='{TargetHost}' | duration 6m

stream=auditd where action="FILE_MODIFIED" and filepath like "%/etc/sudoers%" and system='{TargetHost}' | duration 6m

stream=auditd where action="FILE_MODIFIED" and filepath like "%/etc/sudoers%" | groupby system

stream=AUDITD where action='PROCESS_ADDED' and process like "%perl" and (processargs like "%exec%bin%sh%" or processargs like "%exec%bin%dash%" or processargs like "%exec%bin%bash%") | groupby system

stream=AUDITD where action='PROCESS_ADDED' and process like "%perl" and (processargs like "%exec%bin%sh%" or processargs like "%exec%bin%dash%" or processargs like "%exec%bin%bash%") and system='{TargetHost}' | duration 6m

stream=auditd where action='PROCESS_ADDED' and process like '%strace' and system='{TargetHost}' | duration 6m

stream=auditd where action='PROCESS_ADDED' and process like '%strace' | groupby system

stream=auditd where action='PROCESS_ADDED' and process like "%setenforce" and processargs like "%0%" | groupby system

stream=auditd where action='PROCESS_ADDED' and process like "%setenforce" and processargs like "%0%" and  system='{TargetHost}' | duration 6m

stream=auditd Where action='PROCESS_ADDED' and (process like '%\/tmp%' or process like '\/var\/tmp' or process like '%\/dev\/shm%') and processArgs like '%\_\-%\_\-\.%' and (process!='ls' or Process!='find') | groupby system

stream=auditd Where action='PROCESS_ADDED' and (process like '%\/tmp%' or process like '\/var\/tmp' or process like '%\/dev\/shm%') and processArgs like '%\_\-%\_\-\.%' and (process!='ls' or Process!='find') and system='{TargetHost}' | duration 6m '

stream=AUDITD where action="PROCESS_ADDED" and (processargs like "%sys%class%dmi%id%bios%version%" or processargs like "%sys%class%dmi%id%product%name%" or processargs like "%sys%class%dmi%id%chassis%vendor%" or processargs like "%proc%scsi%scsi%" or processargs like "%proc%ide%hd0%model%") and not user="root" | groupby system

stream=AUDITD where action="PROCESS_ADDED" and (processargs like "%sys%class%dmi%id%bios%version%" or processargs like "%sys%class%dmi%id%product%name%" or processargs like "%sys%class%dmi%id%chassis%vendor%" or processargs like "%proc%scsi%scsi%" or processargs like "%proc%ide%hd0%model%") and not user="root" and system='{TargetHost}' | duration 6m

stream=AUDITD where action='PROCESS_ADDED' and process like "%socat" and processargs like "%-V%" | groupby system

stream=AUDITD where action='PROCESS_ADDED' and process like "%socat" and processargs like "%-V%" and system='{TargetHost}' | duration 6m

stream=auditd where action='PROCESS_ADDED' and (processargs like '%kmod%list%sudo%') or (processargs like '%sudo%' and (processargs like '%depmod%' or processargs like '%lsmod%' or processargs like '%modinfo%')) and system='{TargetHost}' | duration 6m

stream=auditd where action='PROCESS_ADDED' and (processargs like '%kmod%list%sudo%') or (processargs like '%sudo%' and (processargs like '%depmod%' or processargs like '%lsmod%' or processargs like '%modinfo%')) | groupby system

stream=auditd where action='PROCESS_ADDED' and (process='hexdump' or process='od' or process='xxd') | groupby system

stream=auditd where action='PROCESS_ADDED' and (process='hexdump' or process='od' or process='xxd') and system='{TargetHost}' | duration 6m

stream=AUDITD where action='PROCESS_ADDED' and (process like '%base64%' or process like '%base64plain%' or process like '%base64url%' or process like '%base64mime%' or process like '%base64pem%') and system='{TargetHost}'

stream=AUDITD where action='PROCESS_ADDED' and (process like '%base64%' or process like '%base64plain%' or process like '%base64url%' or process like '%base64mime%' or process like '%base64pem%') | groupby system

stream=auditd where action='PROCESS_ADDED' and process like '%chmod' and (processargs like '%g%+%s%' or processargs like '%2%') and not user='root' and system='{TargetHost}' | duration 6m

stream=auditd where action='PROCESS_ADDED' and process like '%chmod' and (processargs like '%g%+%s%' or processargs like '%2%') and not user='root' | groupby system

stream=AUDITD where action="PROCESS_ADDED" and process like "%whoami%" and system='{TargetHost}' | duration 6m

stream=AUDITD where action="PROCESS_ADDED" and process like "%whoami%" | groupby system

stream=auditd where action='PROCESS_ADDED' and (process like '%bash%' or process like '%dash%') and (user='apache' or user='nginx' or user='www' or user='www\-data') | groupby system

stream=auditd where action='PROCESS_ADDED' and (process like '%bash%' or process like '%dash%') and (user='apache' or user='nginx' or user='www' or user='www\-data') and system='{TargetHost}' | duration 6m

stream=win-audit where action="AUDIT_LOG_CLEARED" and EID="1102" and status="PASSED" and user='{SUspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action="AUDIT_LOG_CLEARED" and EID="1102" and status="PASSED" | groupby user, system 

stream=AUDITD where action='PROCESS_ADDED' and (process='nc' or process like "%ncat%" or process like "%netcat%" or process like "%nc\.openbsd%" or process like "%nc\.traditional%") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=AUDITD where action='PROCESS_ADDED' and (process='nc' or process like "%ncat%" or process like "%netcat%" or process like "%nc\.openbsd%" or process like "%nc\.traditional%") | groupby system, user

stream=auditd where action='PROCESS_ADDED' and process like '%rm%' and processargs like '%home%bash%history%' and system='{TargetHost}' | duration 6m

stream=auditd where action='PROCESS_ADDED' and process like '%rm%' and processargs like '%home%bash%history%' | groupby system

stream=AUDITD where action='PROCESS_ADDED' and status='PASSED' and (process like '%ngrok%' or processargs like '%tscon%') | groupby system

stream=AUDITD where action='PROCESS_ADDED' and status='PASSED' and (process like '%ngrok%' or processargs like '%tscon%') and system='{TargetHost}' | duration 6m

stream=auditd where action='FILE_DELETED' AND (filepath like "%/var/run/utmp%" or filepath like "%/var/log/wtmp%" or filepath like "%/var/run/btmp%" or filepath like "%/var/run/lastlog%" or filepath like "%/var/run/faillog%" or filepath like "%/var/run/syslog%" or filepath like "%/var/run/messages%" or filepath like "%/var/run/secure%" or filepath like "%/var/run/auth.log%") and system='{TargetHost}' | duration 6m

stream=auditd where action='FILE_DELETED' AND (filepath like "%/var/run/utmp%" or filepath like "%/var/log/wtmp%" or filepath like "%/var/run/btmp%" or filepath like "%/var/run/lastlog%" or filepath like "%/var/run/faillog%" or filepath like "%/var/run/syslog%" or filepath like "%/var/run/messages%" or filepath like "%/var/run/secure%" or filepath like "%/var/run/auth.log%") | groupby system

stream=AUDITD where action='PROCESS_ADDED' and process='telnet' and dsttype='PUBLIC' | groupby system

stream=AUDITD where action='PROCESS_ADDED' and process='telnet' and dsttype='PUBLIC' and system='{TargetHost}' | duration 6m

stream=AUDITD where action='PROCESS_ADDED' and ((process='ufw' and (processargs like "allow" or processargs like "disable" or processargs like "reset")) or ((process='service' and processargs like "%stop%") or (process='chkconfig' and processargs like "%off%") or ((process='%systemctl' and processargs like "%disable%") or (process='systemctl' and processargs like "%stop%") or (process='systemctl' and processargs like "%kill%")) and (processargs like "%firewalld%" or processargs like "%syslog%" or processargs like "%syslog\-ng%"))) | groupby system

stream=AUDITD where action='PROCESS_ADDED' and ((process='ufw' and (processargs like "allow" or processargs like "disable" or processargs like "reset")) or ((process='service' and processargs like "%stop%") or (process='chkconfig' and processargs like "%off%") or ((process='%systemctl' and processargs like "%disable%") or (process='systemctl' and processargs like "%stop%") or (process='systemctl' and processargs like "%kill%")) and (processargs like "%firewalld%" or processargs like "%syslog%" or processargs like "%syslog\-ng%"))) and system='{TargetHost}'| duration 6m

stream=AUDITD where action='PROCESS_ADDED' and process like "%python%" and (processargs like "%import%pty%pty%spawn%bin%sh%" or processargs like "%import%pty%pty%spawn%bin%dash%" or processargs like "%import%pty%pty%spawn%bin%bash%") | groupby system

stream=AUDITD where action='PROCESS_ADDED' and process like "%python%" and (processargs like "%import%pty%pty%spawn%bin%sh%" or processargs like "%import%pty%pty%spawn%bin%dash%" or processargs like "%import%pty%pty%spawn%bin%bash%") and system='{TargetHost}' | duration 6m

stream=AUDITD where action='PROCESS_ADDED' and (process like "%hping%" or process like "%hping2%" or process like "%hping3%") | groupby system

stream=AUDITD where action='PROCESS_ADDED' and (process like "%hping%" or process like "%hping2%" or process like "%hping3%") and system='{TargetHost}' | duration 6m

stream=AUDITD where action='PROCESS_ADDED' and (processargs like "%insmod%" or processargs like "%kmod%" or processargs like "%modprobe%" or processargs like "%rmod%") and process like "%kmod%" | groupby system

stream=AUDITD where action='PROCESS_ADDED' and (processargs like "%insmod%" or processargs like "%kmod%" or processargs like "%modprobe%" or processargs like "%rmod%") and process like "%kmod%"  and system='{TargetHost}' | duration 6m

stream=AUDITD where action='PROCESS_ADDED' and process like '%\/tmp%' | groupby system

stream=AUDITD where action='PROCESS_ADDED' and process like '%\/tmp%' and system='{TargetHost}'

stream=AUDITD where action='PROCESS_ADDED' and process like "%touch%" and (processargs like "%\-r%" or processargs like "%\-t%" or processargs like "%\-a%" or processargs like "%\-m%") | groupby system

stream=AUDITD where action='PROCESS_ADDED' and process like "%touch%" and (processargs like "%\-r%" or processargs like "%\-t%" or processargs like "%\-a%" or processargs like "%\-m%") and system='{TargetHost}' | duration 6m

stream=AUDITD where action='PROCESS_ADDED' and (process like "%mknod%" or process like '%MKNOD%') | groupby system

stream=AUDITD where action='PROCESS_ADDED' and (process like "%mknod%" or process like '%MKNOD%') and system='{TargetHost}' | duration 6m

stream=auditd where action='PROCESS_ADDED' and process like '%nslookup%' and processargs like 'nslookup' and  system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=auditd where action='PROCESS_ADDED' and process like '%nslookup%' and processargs like 'nslookup' and | duration 5m | select system, user, count(action) as count | groupby system, user | having count>10

stream=auditd where action='PROCESS_ADDED' and process like "%tcpdump" and system='{TargetHost}' | duration 6m

stream=auditd where action='PROCESS_ADDED' and process like "%tcpdump" | groupby system

stream=AUDITD where action='PROCESS_ADDED' and process='telnet' and dsttype='PRIVATE' and system='{TargetHost}' | duration 6m

stream=AUDITD where action='PROCESS_ADDED' and process='telnet' and dsttype='PRIVATE' | groupby system

stream=auditd where action='PROCESS_ADDED' and process like "%nmap" and system='{TargetHost}' | duration 6m

stream=auditd where action='PROCESS_ADDED' and process like "%nmap" | groupby system

stream=auditd where action='PROCESS_ADDED' and process like '%shred' and (processargs like '%-u%' or processargs like '%--remove%' or processargs like '%-z%' or processargs like '%--zero%') |  groupby system

stream=auditd where action='PROCESS_ADDED' and process like '%shred' and (processargs like '%-u%' or processargs like '%--remove%' or processargs like '%-z%' or processargs like '%--zero%') and system='{TargetHost}' | duration 6m

stream=auditd where action='PROCESS_ADDED' and (process='base16' or process='base32' or process='base32plain' or process='base32hex') | groupby system

stream=auditd where action='PROCESS_ADDED' and (process='base16' or process='base32' or process='base32plain' or process='base32hex') and system='{TargetHost}'

stream=auditd where action='PROCESS_ADDED' and process like '%chmod%' and (processargs like '%u%s%' or processargs like '%4%') and not user='root' |  groupby system

stream=auditd where action='PROCESS_ADDED' and process like '%chmod%' and (processargs like '%u%s%' or processargs like '%4%') and not user='root' and system='{TargetHost}' | duration 6m

stream=auditd where action='PROCESS_ADDED' and (process like '%chmod%' or process like '%chown%' or process like '%chattr%' or process like '%chgrp%') and (processargs like '%tmp%' or processargs like '%var%tmp%' or processargs like '%dev%shm%') and not user='root' | groupby system

stream=auditd where action='PROCESS_ADDED' and (process like '%chmod%' or process like '%chown%' or process like '%chattr%' or process like '%chgrp%') and (processargs like '%tmp%' or processargs like '%var%tmp%' or processargs like '%dev%shm%') and not user='root' and system='{TargetHost}' | duration 6m

stream=windows-event where eid = '39' and user is not null | duration 10d |  groupby user , @Subject 

stream=* where sourcetype='OS' |  duration 5m

stream=auditd where action='process_ADDED' and ((process like '%ufw%' and (processargs like '%allow%' or processargs like '%disable%' or processargs like '%reset%')) or ((process like '%service%' and processargs like '%stop%') or (process like '%chkconfig%' and processargs like '%off%') or ((process='%systemctl' and processArgs like '%disable%') or (process like '%systemctl%' and processargs like '%stop%') or (process like '%systemctl%' and processargs like '%kill%')) and processargs like '%firewalld%' or processargs like '%ip6tables%' or processargs like '%iptables%'))) and system='{TargetHost}' | duration 6m

stream=auditd where action='process_ADDED' and ((process like '%ufw%' and (processargs like '%allow%' or processargs like '%disable%' or processargs like '%reset%')) or ((process like '%service%' and processargs like '%stop%') or (process like '%chkconfig%' and processargs like '%off%') or ((process='%systemctl' and processArgs like '%disable%') or (process like '%systemctl%' and processargs like '%stop%') or (process like '%systemctl%' and processargs like '%kill%')) and processargs like '%firewalld%' or processargs like '%ip6tables%' or processargs like '%iptables%'))) | groupby system

stream=auditd where action='PROCESS_ADDED' and ((process like '%ufw%' and (processargs like '%allow%' or processargs like '%disable%' or processargs like '%reset%')) or ((process like '%service%' and processargs like '%stop%') or (process like '%chkconfig%' and processargs like '%off%') or ((process='%systemctl' and processArgs like '%disable%') or (process like '%systemctl%' and processargs like '%stop%') or (process like '%systemctl%' and processargs like '%kill%')) and processargs like '%firewalld%' or processargs like '%ip6tables%' or processargs like '%iptables%'))) and system='{TargetHost}' | duration 6m

stream=auditd where action='PROCESS_ADDED' and ((process like '%ufw%' and (processargs like '%allow%' or processargs like '%disable%' or processargs like '%reset%')) or ((process like '%service%' and processargs like '%stop%') or (process like '%chkconfig%' and processargs like '%off%') or ((process='%systemctl' and processArgs like '%disable%') or (process like '%systemctl%' and processargs like '%stop%') or (process like '%systemctl%' and processargs like '%kill%')) and processargs like '%firewalld%' or processargs like '%ip6tables%' or processargs like '%iptables%'))) | groupby system

stream=AUDITD where action='PROCESS_ADDED' and ((process='ufw' and (processargs like "allow" or processargs like "disable" or processargs like "reset")) or ((process='service' and processargs like "%stop%") or (process='chkconfig' and processargs like "%off%") or ((process='%systemctl' and processargs like "%disable%") or (process='systemctl' and processargs like "%stop%") or (process='systemctl' and processargs like "%kill%")) and (processargs like "%firewalld%" or processargs like "%syslog%" or processargs like "%syslog%-ng%"))) | groupby system

stream=AUDITD where action='PROCESS_ADDED' and ((process='ufw' and (processargs like "allow" or processargs like "disable" or processargs like "reset")) or ((process='service' and processargs like "%stop%") or (process='chkconfig' and processargs like "%off%") or ((process='%systemctl' and processargs like "%disable%") or (process='systemctl' and processargs like "%stop%") or (process='systemctl' and processargs like "%kill%")) and (processargs like "%firewalld%" or processargs like "%syslog%" or processargs like "%syslog\-ng%"))) and system='{TargetHost}'| duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(net user.*?add.*?net localgroup.*?administrators.*?add|net user.*?add|new-localuser.*?name|createnewlocaladmin.*?\.)') |  groupby user, system, commandline

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(net user.*?add.*?net localgroup.*?administrators.*?add|net user.*?add|new-localuser.*?name|createnewlocaladmin.*?\.)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=CONFIGURATION,WIN-AUDIT,EP-PROCESS where action in ("PROCESS_CREATED", "PROCESS_ADDED", "CONFIGURATION_CHANGED") and ((lower(commandline) like "%csuninstalltool%quiet%") or (lower(commandline) like "%windowssensor%uninstall%quiet%")) and system='{TargetHost}' | duration 6m

stream=CONFIGURATION,WIN-AUDIT,EP-PROCESS where action in ("PROCESS_CREATED", "PROCESS_ADDED", "CONFIGURATION_CHANGED") and ((lower(commandline) like "%csuninstalltool%quiet%") or (lower(commandline) like "%windowssensor%uninstall%quiet%")) | groupby system

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adfind.*s.*base.*(lockoutduration|lockoutthreshold|lockoutobservationwindow|maxpwdage|minpwdage|minpwdlength|pwdhistorylength|pwdproperties)') or lower(commandline) like '%adfind%-sc admincountdmp%' or lower(commandline) like '%adfind%-sc trustdmp%' or lower(commandline) like '%adfind%-f%objectcategory=person%' or lower(commandline) like '%adfind%-sc exchaddresses%' or lower(commandline) like '%adfind%-f%objectcategory=person%objectclass=user%memberof=cn=administrators%' or lower(commandline) like '%adfind%-f%objectcategory=group%' or lower(commandline) like '%adfind%-f%objectcategory=organizationalunit%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT where action='PROCESS_CREATED' and (rlike(lower(commandline),'adfind.*s.*base.*(lockoutduration|lockoutthreshold|lockoutobservationwindow|maxpwdage|minpwdage|minpwdlength|pwdhistorylength|pwdproperties)') or lower(commandline) like '%adfind%-sc admincountdmp%' or lower(commandline) like '%adfind%-sc trustdmp%' or lower(commandline) like '%adfind%-f%objectcategory=person%' or lower(commandline) like '%adfind%-sc exchaddresses%' or lower(commandline) like '%adfind%-f%objectcategory=person%objectclass=user%memberof=cn=administrators%' or lower(commandline) like '%adfind%-f%objectcategory=group%' or lower(commandline) like '%adfind%-f%objectcategory=organizationalunit%') | groupby user, system 

stream=auditd where action='PROCESS_ADDED' and rlike(process, "(.*base16.*|.*base32.*|.*base32plain.*|.*base32hex.*|.*base64.*|.*base64plain.*|.*base64url.*|.*base64mime.*|.*base64pem.*)") and system='{TargetHost}'

stream=auditd where action='PROCESS_ADDED' and rlike(process, "(.*base16.*|.*base32.*|.*base32plain.*|.*base32hex.*|.*base64.*|.*base64plain.*|.*base64url.*|.*base64mime.*|.*base64pem.*)") | groupby system

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663', '4656') and rlike(lower(commandline), '(new websocket|url.createobjecturl|new xmlhttprequest|new blob|remote.html)') | groupby system, user and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663', '4656') and rlike(lower(commandline), '(new websocket|url.createobjecturl|new xmlhttprequest|new blob|remote.html)') | groupby system, user

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel') | groupby user, system | duration 1h

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel') and user='{SuspectUser}' and system='{TargetHost}' | duration 6ma

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(reg add|new-itemproperty).*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(reg add|new-itemproperty).*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel)') | groupby user, system

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(commandline), '(reg add|new-itemproperty).*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel)') | groupby user, system

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663', '4656') and rlike(lower(commandline), '(new WebSocket|url.createobjecturl|new xmlhttprequest|new blob|remote.html)') | groupby system, user

stream=win-audit where action in ('PROCESS_CREATED', 'OBJECT_ACCESSED') and eid in ('4688', '4663', '4656') and rlike(lower(commandline), '(new WebSocket|url.createobjecturl|new xmlhttprequest|new blob|remote.html)') | groupby system, user and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=windows-event where eid = '39' and user is not null | duration 15m |  groupby user , @Subject 

stream=other | limit 1

stream=auditd Where action='PROCESS_ADDED' and (process like '%/tmp%' or process like '%/var%/tmp%' or process like '%\/dev%/shm%') and processArgs like '%.%' and not (process like '%ls %' or process like '%find %') | groupby system

stream=auditd Where action='PROCESS_ADDED' and (process like '%/tmp%' or process like '%/var%/tmp%' or process like '%\/dev%/shm%') and processArgs like '%.%' and not (process like '%ls %' or process like '%find %') and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel') | groupby user, system | duration 1h

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel') and user='{SuspectUser}' and system='{TargetHost}' | duration 6ma

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(reg add|new-itemproperty).*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel)') | duration 2h

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(reg add|new-itemproperty).*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  rlike(lower(commandline), 'pktmon.*?(start|capture|filter)') | groupby user , system

stream=other | limit 1

stream=auditd where action='PROCESS_ADDED' and rlike(process, "(.*base16.*|.*base32.*|.*base32plain.*|.*base32hex.*|.*base64.*|.*base64plain.*|.*base64url.*|.*base64mime.*|.*base64pem.*)") and system='{TargetHost}'

stream=auditd where action='PROCESS_ADDED' and rlike(process, "(.*base16.*|.*base32.*|.*base32plain.*|.*base32hex.*|.*base64.*|.*base64plain.*|.*base64url.*|.*base64mime.*|.*base64pem.*)") | groupby system

stream=auditd where action='PROCESS_ADDED' and ( (process like '%rm%' and processargs like '%/home/%/.bash_history%') or (process like '%shred%' and processargs like '%/home/%/.bash_history%') or (process like '%truncate%' and processargs like '%/home/%/.bash_history%') or (process like '%cat%' and processargs like '%/dev/null > /home/%/.bash_history%') or (process like '%echo%' and processargs like '%"" > /home/%/.bash_history%') or (process like '%>%' and processargs like '%/home/%/.bash_history%') or (process like '%vim%' and processargs like '%/home/%/.bash_history%') or (process like '%nano%' and processargs like '%/home/%/.bash_history%') or (process like '%mv%' and processargs like '%/home/%/.bash_history%') or (process like '%chmod%' and processargs like '%/home/%/.bash_history%') or (process like '%chown%' and processargs like '%/home/%/.bash_history%') or (process like '%export%' and processargs like '%HISTFILE%')) and system='{TargetHost}' | duration 6m

stream=auditd where action='PROCESS_ADDED' and ( (process like '%rm%' and processargs like '%/home/%/.bash_history%') or (process like '%shred%' and processargs like '%/home/%/.bash_history%') or (process like '%truncate%' and processargs like '%/home/%/.bash_history%') or (process like '%cat%' and processargs like '%/dev/null > /home/%/.bash_history%') or (process like '%echo%' and processargs like '%"" > /home/%/.bash_history%') or (process like '%>%' and processargs like '%/home/%/.bash_history%') or (process like '%vim%' and processargs like '%/home/%/.bash_history%') or (process like '%nano%' and processargs like '%/home/%/.bash_history%') or (process like '%mv%' and processargs like '%/home/%/.bash_history%') or (process like '%chmod%' and processargs like '%/home/%/.bash_history%') or (process like '%chown%' and processargs like '%/home/%/.bash_history%') or (process like '%export%' and processargs like '%HISTFILE%'))| groupby system

stream=signals where sourceid='33d4111a90fd496ba5ee547c95e2c03e' 

stream=authentication | duration 1h |  groupby srcip | limit 3

stream=authentication | duration 1h |  groupby srcip,evtlen | limit 3

stream=nta-notice |  duration 1h |  groupby action, servercertsubject

stream=CONFIGURATION,WIN-AUDIT,EP-PROCESS where action in ("PROCESS_CREATED", "PROCESS_ADDED", "CONFIGURATION_CHANGED") and rlike(lower(commandline),"((add-mppreference|set-mppreference).*?-exclusion(path|process|extension)|reg.*?add.*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?defender.*?exclusions.*?(paths|processes|extensions))") and system='{TargetHost}' and user='{SuspectUser}' | duration 6m 

stream=CONFIGURATION,WIN-AUDIT,EP-PROCESS where action in ("PROCESS_CREATED", "PROCESS_ADDED", "CONFIGURATION_CHANGED") and rlike(lower(commandline),"((add-mppreference|set-mppreference).*?-exclusion(path|process|extension)|reg.*?add.*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?defender.*?exclusions.*?(paths|processes|extensions))") |  groupby user, system 

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(hklm.*?software.*?microsoft.*?windows.*?currentversion.*?app paths.*?winword.exe.*?protocolhandler.*?\.|microsoft office.*?root.*?protocolhandler.*?\.|microsoft_wordpath.*?protocolhandler.*?\.)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(hklm.*?software.*?microsoft.*?windows.*?currentversion.*?app paths.*?winword.exe.*?protocolhandler.*?\.|microsoft office.*?root.*?protocolhandler.*?\.|microsoft_wordpath.*?protocolhandler.*?\.)') | groupby user, system

stream=signals where sourceid='33d4111a90fd496ba5ee547c95e2c03e' 

stream=other

stream=authentication | duration 1h |  groupby srcip,evtlen | limit 3

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%del%' or lower(commandline) like '%erase%' or lower(commandline) like '%rmdir%' or lower(commandline) like '%remove-item%' or lower(commandline) like '%sdelete%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%del%' or lower(commandline) like '%erase%' or lower(commandline) like '%rmdir%' or lower(commandline) like '%remove-item%' or lower(commandline) like '%sdelete%') | duration 15m |  select system, user, commandline | limit 10000

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%del%' or lower(commandline) like '%erase%' or lower(commandline) like '%rmdir%' or lower(commandline) like '%remove-item%' or lower(commandline) like '%sdelete%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and (lower(commandline) like '%del%' or lower(commandline) like '%erase%' or lower(commandline) like '%rmdir%' or lower(commandline) like '%remove-item%' or lower(commandline) like '%sdelete%') | duration 15m |  select system, user, commandline | limit 10000

stream=WINDOWS-EVENT where user is not null | duration 1h |  select User | limit 1

stream=WINDOWS-EVENT where user is not null and user='{SuspectUser}' | duration 1h | limit 1

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'del.*?(.vhd|.bac|.bak|.wbcat|.bkf|backup|.set|.win|.dsk|.vhdx|.tib|.gho|.iso|.img|.dbk|.xml|.cfg|.recovery|.rstrui)') | duration 15m | select system, user, commandline | limit 10000

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'del.*?(.vhd|.bac|.bak|.wbcat|.bkf|backup|.set|.win|.dsk|.vhdx|.tib|.gho|.iso|.img|.dbk|.xml|.cfg|.recovery|.rstrui)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=configuration where action='CONFIGURATION_CHANGED' and (rlike(lower(commandline) , 'findstr.*?pass.*?\\.(xml|doc|txt|xls|json|csv|html)')) | duration 1d

stream=AUTHENTICATION where sourcename="AWS-CLOUDTRAIL" and EventName="ConsoleLogin" and reason in ("UnauthorizedOperation", "AccessDenied") | groupby srcip, user

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%reg add%hklm%software%microsoft%.netframework%etwenabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%.netframework%etwenabled%' or lower(commandline) like '%reg add%hklm%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%' or lower(commandline) like '%-accepteula%-i%logman update trace%-p%-ets%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%reg add%hklm%software%microsoft%.netframework%etwenabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%.netframework%etwenabled%' or lower(commandline) like '%reg add%hklm%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%' or lower(commandline) like '%-accepteula%-i%logman update trace%-p%-ets%' | groupby user, system

stream=CONFIGURATION | duration 1M |  groupby user , config

stream=CONFIGURATION where sourcename="AWS-CLOUDTRAIL" and eventsource="iam.amazonaws.com" and eventname in ("PutUserPolicy", "PutGroupPolicy", "PutRolePolicy") |  groupby user , config

stream=CONFIGURATION,WIN-AUDIT,EP-PROCESS where action in ("PROCESS_CREATED", "PROCESS_ADDED", "CONFIGURATION_CHANGED") and rlike(lower(commandline),"dism.*?online.*?(disable-feature|remove-package).*?(featurename|packagename).*?windows.*?defender") | groupby user, system 

stream=CONFIGURATION,WIN-AUDIT,EP-PROCESS where action in ("PROCESS_CREATED", "PROCESS_ADDED", "CONFIGURATION_CHANGED") and rlike(lower(commandline),"dism.*?online.*?(disable-feature|remove-package).*?(featurename|packagename).*?windows.*?defender") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=* | duration from 2024-07-08T05:30:00 to 2024-07-09T05:30:00 |  groupby stream

stream=nta-files where fid in (_FID_) and lower(analyzer) like "%pe%" | duration 24h

stream=nta-http where mimetype = 'application/x-dosexec' |  duration 24h

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(w32tm.*?tz|net.*?time|time|echo.*?time|get-date|get-timezone|w32tm.*stripchart)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(w32tm.*?tz|net.*?time|time|echo.*?time|get-date|get-timezone|w32tm.*stripchart)') | groupby user, system  | duration 1h

stream=win-audit where action='PROCESS_CREATED' and not rlike(parentprocessname),'(Windows.*?(System32|SysWOW64))' and rlike(lower(commandline), 'copy.*?(cmd.exe|cscript.exe|wscript.exe|powershell.exe|explorer.exe|svchost.exe|lsass.exe|services.exe|winlogon.exe|notepad.exe|taskhostw.exe|lsm.exe)') | groupby user, system | having count_col1 >= 10

stream=win-audit where action='PROCESS_CREATED' and not rlike(parentprocessname),'(Windows.*?(System32|SysWOW64))' and rlike(lower(commandline), 'copy.*?(cmd.exe|cscript.exe|wscript.exe|powershell.exe|explorer.exe|svchost.exe|lsass.exe|services.exe|winlogon.exe|notepad.exe|taskhostw.exe|lsm.exe)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(w32tm.*?tz|net.*?time|time|echo.*?time|get-date|get-timezone|w32tm.*stripchart)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(w32tm.*?tz|net.*?time|time|echo.*?time|get-date|get-timezone|w32tm.*stripchart)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'del.*?(.vhd|.bac|.bak|.wbcat|.bkf|backup|.set|.win|.dsk|.vhdx|.tib|.gho|.iso|.img|.dbk|.xml|.cfg|.recovery|.rstrui)') | duration 1h

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(reg add|new-itemproperty).*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(reg add|new-itemproperty).*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel)') | duration 2h

stream=ep-dns

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  rlike(lower(commandline), 'pktmon.*?(start|capture|filter)') | groupby user , system

stream=* where sourcetype='OS' |  duration 5m

stream=win-audit where action='PROCESS_CREATED' and not rlike(parentprocessname),'(Windows.*?(System32|SysWOW64))' and rlike(lower(commandline), 'copy.*?(cmd.exe|cscript.exe|wscript.exe|powershell.exe|explorer.exe|svchost.exe|lsass.exe|services.exe|winlogon.exe|notepad.exe|taskhostw.exe|lsm.exe)') | groupby user, system | having count_col1 >= 10

stream=win-audit where action='PROCESS_CREATED' and not rlike(parentprocessname),'(Windows.*?(System32|SysWOW64))' and rlike(lower(commandline), 'copy.*?(cmd.exe|cscript.exe|wscript.exe|powershell.exe|explorer.exe|svchost.exe|lsass.exe|services.exe|winlogon.exe|notepad.exe|taskhostw.exe|lsm.exe)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(reg add|new-itemproperty).*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(reg add|new-itemproperty).*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel)') | groupby user, system

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(commandline), '(reg add|new-itemproperty).*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(commandline), '(reg add|new-itemproperty).*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel)') | groupby user, system

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  rlike(lower(commandline), 'pktmon.*?(start|capture|filter)')  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  rlike(lower(commandline), 'pktmon.*?(start|capture|filter)') | groupby user , system | duration 30m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED')and (lower(commandline) like '%netsh%trace%start%capture%yes%')| groupby user , system 

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED')and (lower(commandline) like '%netsh%trace%start%capture%yes%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=CONFIGURATION where action="CONFIGURATION_CHANGED" and EventSource="iam.amazonaws.com" and EventName in ("PutUserPolicy", "PutGroupPolicy", "PutRolePolicy") |  groupby user , config

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%reg add%hklm%software%microsoft%.netframework%etwenabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%.netframework%etwenabled%' or lower(commandline) like '%reg add%hklm%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%' or lower(commandline) like '%-accepteula%-i%logman update trace%-p%-ets%' and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%reg add%hklm%software%microsoft%.netframework%etwenabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%.netframework%etwenabled%' or lower(commandline) like '%reg add%hklm%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%reg_dword%d 0%' or lower(commandline) like '%new-itemproperty%software%microsoft%windows%currentversion%winevt%channels%microsoft-windows-windows%defender/operational%enabled%' or lower(commandline) like '%-accepteula%-i%logman update trace%-p%-ets%' | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'del.*?(.vhd|.bac|.bak|.wbcat|.bkf|backup|.set|.win|.dsk|.vhdx|.tib|.gho|.iso|.img|.dbk|.xml|.cfg|.recovery|.rstrui)') | duration 1h | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'del.*?(.vhd|.bac|.bak|.wbcat|.bkf|backup|.set|.win|.dsk|.vhdx|.tib|.gho|.iso|.img|.dbk|.xml|.cfg|.recovery|.rstrui)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '(w32tm.*?tz|net.*?time|time|echo.*?time|get-date|get-timezone|w32tm.*stripchart)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '(w32tm.*?tz|net.*?time|time|echo.*?time|get-date|get-timezone|w32tm.*stripchart)') | groupby user, system 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(reg add|new-itemproperty).*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(reg add|new-itemproperty).*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel)') | groupby user, system

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  rlike(lower(commandline), 'pktmon.*?(start|capture|filter)')  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  rlike(lower(commandline), 'pktmon.*?(start|capture|filter)') | groupby user , system | duration 30m

stream=win-audit,ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED')and (lower(commandline) like '%netsh%trace%start%capture%yes%')| groupby user , system 

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%filename =%url =%file = new-item -force%-value%contenttype =%invoke-webrequest%-method put%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and lower(commandline) like '%filename =%url =%file = new-item -force%-value%contenttype =%invoke-webrequest%-method put%' | groupby user, system | having count_col1 >= 5

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(commandline), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows nt.*?currentversion.*?winlogon.*?(shell|userinit|notify)') | groupby system, user 

stream=ep-process where action='PROCESS_ADDED' and (commandline like '%net%time%' or commandline like '%time%/t%' or commandline like '%echo%time%' or commandline like '%Get-Date%') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process where action='PROCESS_ADDED' and rlike(lower(commandline), '(w32tm.*?tz|net.*?time|time|echo.*?time|get-date|get-timezone|w32tm.*stripchart)') | groupby user, system 

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(commandline), '(reg add|new-itemproperty).*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel)') | groupby user, system

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(commandline), '(reg add|new-itemproperty).*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(commandline), '(reg add|new-itemproperty).*?(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?system.*?(grouppolicyrefreshtimedc|grouppolicyrefreshtimeoffsetdc|grouppolicyrefreshtime|grouppolicyrefreshtimeoffset|enablesmartscreen|shellsmartscreenlevel)') | groupby user, system

stream=authentication where action="LOGIN" and status="PASSED" and authproto="VPN" | duration 1h | select system, user, distinct_count(srcip) as srcipcount | groupby system, user | having srcipcount > 3

stream=authentication where action="LOGIN" and status="PASSED" and authproto="VPN" and user='{SuspectUser}' and system='{TragetHost}' | duration 1h

stream=authentication where action="LOGIN" and status="FAILED" and crownjewel="Yes" and authproto="SSH" and user is not null | select user, system, distinct_count(system) as systemcount | groupby user, system | having systemcount > 1 | duration 1d

stream=authentication where action="LOGIN" and status="FAILED" and crownjewel="Yes" and authproto="SSH" and user is not null and user='{SuspectUser}' and system='{TargetHost}' | duration 1d

stream=firewall where Action="CONNECTION_TERMINATED" and DstPort in ("139", "445") and srcip='{SuspectHost}' and system='{TargetHost}' | duration 6m

stream=firewall where Action="CONNECTION_TERMINATED" and DstPort in ("139", "445") | groupby system, srcip

stream=AUDITD where action="SERVICE_STOPPED" and status="PASSED" and not user in ("", "null") | groupby user, system

stream=AUDITD where action="SERVICE_STOPPED" and status="PASSED" and not user in ("", "null") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=configuration where action="CONFIGURATION_CHANGED" and status="PASSED" and config="Service Stopped" and not user in ("", "null") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=configuration where action="CONFIGURATION_CHANGED" and status="PASSED" and config="Service Stopped" and not user in ("", "null") | groupby user, system 

Stream=EP-PROCESS where Action="PROCESS_ADDED" and Status="PASSED" | duration 7d | groupby image

Stream=IAM where not user in ("", "-", "null") and status="PASSED" | groupby user | duration 7d

stream=IAM where Action="PASSWORD_CHANGED" AND Status="PASSED" and user='{SuspectUser}' and targetuser='{TargetUser}' | duration 6m

stream=IAM where Action="PASSWORD_CHANGED" AND Status="PASSED" | groupby user, targetuser 

stream=EP-PROCESS where ( Image LIKE "%C%PerfLogs%" OR Image LIKE "%C%\Recycle\.bin%" OR Image LIKE "%C%Intel%Logs%" OR Image LIKE "%C%Users%Default%" OR Image LIKE "%C%Users%Public%" OR Image LIKE "%C%Users%NetworkService%" OR Image LIKE "%C%Windows%Fonts%" OR Image LIKE "%C%Windows%Debug%" OR Image LIKE "%C%Windows%Media%" OR Image LIKE "%C%Windows%Help%" OR Image LIKE "%C%Windows%addins%" OR Image LIKE "%C%Windows%repair%" OR Image LIKE "%C%Windows%security%" OR Image LIKE "%RSA%MachineKeys%" OR Image LIKE "%C%Windows%system32%config%systemprofile%" OR Image LIKE "%C%Windows%Tasks%" OR Image LIKE "%C%Windows%System32%Tasks%" OR Image LIKE "%C%Program Files%" OR Image LIKE "%C%Program Files (x86)%" OR Image LIKE "%C%ProgramData%" OR Image LIKE "%C%Windows%" OR Image LIKE "%C%System32%" OR Image LIKE "%C%SysWOW64%" ) and crownjewel="Yes"  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where ( Image LIKE "%C%PerfLogs%" OR Image LIKE "%C%\Recycle\.bin%" OR Image LIKE "%C%Intel%Logs%" OR Image LIKE "%C%Users%Default%" OR Image LIKE "%C%Users%Public%" OR Image LIKE "%C%Users%NetworkService%" OR Image LIKE "%C%Windows%Fonts%" OR Image LIKE "%C%Windows%Debug%" OR Image LIKE "%C%Windows%Media%" OR Image LIKE "%C%Windows%Help%" OR Image LIKE "%C%Windows%addins%" OR Image LIKE "%C%Windows%repair%" OR Image LIKE "%C%Windows%security%" OR Image LIKE "%RSA%MachineKeys%" OR Image LIKE "%C%Windows%system32%config%systemprofile%" OR Image LIKE "%C%Windows%Tasks%" OR Image LIKE "%C%Windows%System32%Tasks%" OR Image LIKE "%C%Program Files%" OR Image LIKE "%C%Program Files (x86)%" OR Image LIKE "%C%ProgramData%" OR Image LIKE "%C%Windows%" OR Image LIKE "%C%System32%" OR Image LIKE "%C%SysWOW64%" ) and crownjewel="Yes" | groupby user, system, image 

stream=authentication where action="LOGIN" and status="FAILED" and crownjewel="Yes" and authproto="VPN" and user is not null and user='{SuspectUser}' and system='{TargetHost}' | duration 1d

stream=authentication where action="LOGIN" and status="FAILED" and crownjewel="Yes" and authproto="VPN" and user is not null | select user, system, distinct_count(system) as systemcount | groupby user, system | having systemcount > 1 | duration 1d

stream=firewall where dstport="3389" and srctype="PRIVATE" and dsttype="PUBLIC" and crownjewel="Yes" and action="PACKET_ALLOWED" | groupby dstip, srcip

stream=firewall where dstport="3389" and srctype="PRIVATE" and dsttype="PUBLIC" and crownjewel="Yes" and action="PACKET_ALLOWED" and dstip='{TargetHost}' and srcip='{SuspectHost}' | duration 6m

Stream=EP-PROCESS where Action="PROCESS_ADDED" and Status="PASSED" and user='{SuspectUser}' and image='{SUspectProcess}' and system='{TargetHost}' | duration 6m

Stream=EP-PROCESS where Action="PROCESS_ADDED" and Status="PASSED" | groupby user, image, system

stream=nta-notice where srcip = "{SuspectHost}" and dstip = "{TargetHost}" |  duration 1h

stream=nta-notice where noticeidentifier like "%SSL::Invalid_Server_Cert%" and analyzer like '%Notice::ACTION_LOG%' and errormsg like '%self signed certificate%' or errormsg like '%certificate has expired%'| groupby noticeidentifier, srcip, dstip, errormsg |  duration 1h

stream=nta-notice where noticeidentifier like "%ATTACK::%" and analyzer like '%Notice::ACTION_LOG%' | groupby noticeidentifier, srcip, dstip, errormsg |  duration 1h

stream=signals where detectionseverity="High" or detectionseverity="Medium" or detectionseverity="Low" | duration 1h | limit 1

stream=signals where detectionseverity="High" or detectionseverity="Medium" or detectionseverity="Low" | duration 5m | limit 100

stream=signals where detectionseverity="High" or detectionseverity="Medium" or detectionseverity="Low" | duration 5m | limit 100

stream=signals where detectionseverity="High" or detectionseverity="Medium" or detectionseverity="Low" | duration 1h | limit 1

stream=signals where detectionseverity="High" or detectionseverity="Medium" or detectionseverity="Low" | duration 5m | limit 100

stream=signals where detectionseverity="High" or detectionseverity="Medium" or detectionseverity="Low" | duration 5m | limit 100

stream=signals where detectionseverity="High" or detectionseverity="Medium" or detectionseverity="Low" | duration 10m | limit 100

stream=DNS where action="REQUEST_ALLOWED" and status="PASSED" | groupby srcip | select srcip, count(action) as totalcount | having totalcount > 10000

stream=DNS where action="REQUEST_ALLOWED" and status="PASSED" and srcip='{SuspectHost}' | duration 6m

stream=signals where detectionseverity="High" or detectionseverity="Medium" or detectionseverity="Low" | duration 5m | limit 100

stream=signals where detectionseverity="High" or detectionseverity="Medium" or detectionseverity="Low" | duration 5m | limit 100

stream=documents where action in ('ACCESSED', 'DOWNLOADED') and srccn in ('CN', 'KP') | groupby user

stream=documents where action in ('ACCESSED', 'DOWNLOADED') and srccn in ('CN', 'KP') and user='{SuspectUser}' | duration 6m

stream=signals where detectionseverity="High" or detectionseverity="Medium" or detectionseverity="Low" | duration 5m | select *, lower(detectionconfidence) as detectionconfidence | limit 100

stream=* where sourcetype='OS' |  duration 5m

stream=signals where detectionseverity="High" or detectionseverity="Medium" or detectionseverity="Low" | duration 5m | limit 100

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(net.*?stop|sc.*?stop|taskkill.*?/f)') | groupby user, system | duration 1d

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(net.*?stop|sc.*?stop|taskkill.*?/f)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(net.*?stop|sc.*?stop|taskkill.*?/f)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(net.*?stop|sc.*?stop|taskkill.*?/f)') | groupby user, system 

stream=win-audit where action in ('PROCESS_CREATED' , 'PROCESS_ADDED') and rlike(lower(commandline), 'start.*?\w+\.\w+' | groupby user, system

stream=win-audit where action in ('PROCESS_CREATED' , 'PROCESS_ADDED') and rlike(lower(commandline), 'start.*?\\w+.\\w+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED' , 'PROCESS_ADDED') and rlike(lower(commandline), 'start.*?\\w+.\\w+') | groupby user, system

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::FILE_HASH' |  duration 10m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::FILE_HASH' and srcip="{TargetHost}" and dstip="{SuspectHost}"  |  duration 10m

stream=nta-intel where srcip="{TargetHost}" and indicator="{SuspectObject}" |  duration 30m

stream=nta-intel  | groupby indicatortype, indicator,  msg, srcip | duration 30m

stream=nta-intel where indicator like "%yanquisorigan.shop%"  | duration 24h |  limit 1

stream=nta-intel where srcip="{TargetHost}" and indicator="{SuspectObject}" |  duration 30m

stream=authentication where action="LOGIN" and status="FAILED"

stream=authentication where action="LOGIN" and status="FAILED" |  groupby user , system |  having count_col1>=5

stream=authentication where action="LOGIN" and status="FAILED" and system ='{TargetHost}' and user ='{SuspectUser}'

stream=authentication where action="LOGIN" and status="FAILED" |  groupby user , system |  having count_col1>=5

stream=authentication where action="LOGIN" and status="FAILED" and system ='{TargetHost}' and user ='{SuspectUser}'

stream=firewall where action="PACKET_BLOCKED"|  duration 30m  |  groupby srcip 

stream=win-audit where action in ('PROCESS_CREATED' , 'PROCESS_ADDED') and rlike(lower(commandline), 'start.*?\\w+.\\w+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED' , 'PROCESS_ADDED') and rlike(lower(commandline), 'start.*?\\w+.\\w+') | groupby user, system

stream=nta-intel where srcip="{TargetHost}" and indicator="{SuspectObject}" |  duration 15m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::DOMAIN' | groupby srcip, indicatortype, indicator, msg | duration 15m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDxED') and rlike(lower(commandline), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?wallpaper') | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDxED') and rlike(lower(commandline), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?wallpaper') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'start.*?\\w+.\\w+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'start.*?\\w+.\\w+') | groupby user, system

stream=other

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?wallpaper') | groupby user, system | duration 1h

stream=win-audit where action in ('PROCESS_CREATED' , 'PROCESS_ADDED') and rlike(lower(commandline), 'start.*?\\w+.\\w+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action in ('PROCESS_CREATED' , 'PROCESS_ADDED') and rlike(lower(commandline), 'start.*?\\w+.\\w+') | groupby user, system

stream=nta-intel where srcip="{TargetHost}" and indicator="{SuspectObject}" |  duration 30m

stream=nta-intel  | groupby indicatortype, indicator,  msg, srcip | duration 30m

stream=other

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::DOMAIN' | groupby srcip, indicatortype, indicator, msg | duration 15m

stream=nta-intel where srcip="{TargetHost}" and indicator="{SuspectObject}" |  duration 15m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::DOMAIN' | groupby srcip, indicatortype, indicator, msg | duration 15m

stream=nta-intel where srcip="{TargetHost}" and indicator="{SuspectObject}" |  duration 15m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDxED') and rlike(lower(commandline), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?wallpaper') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?wallpaper') | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDxED') and rlike(lower(commandline), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?wallpaper') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?wallpaper') | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDxED') and rlike(lower(commandline), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?wallpaper') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?wallpaper') | groupby user, system

stream=authentication where action="LOGIN" and status="FAILED" and crownjewel="Yes" and authproto="RDP" and user is not null | select user, system, distinct_count(system) as systemcount | groupby user, system | having systemcount > 1 | duration 1d

stream=authentication where action="LOGIN" and status="FAILED" and crownjewel="Yes" and authproto="RDP" and user is not null and user='{SuspectUser}' and system='{TargetHost}' | duration 1d

stream=authentication where authproto="SSH" | groupby user, system, xhour | select user, system, substring(xhour, 9,10) as houroftheday | having '03' > houroftheday < '16' 

stream=authentication where authproto="SSH" and user='{SuspectUser}' and system'{TartgetHost}' | duration 6m

stream=authentication where action="LOGIN" and status="PASSED" and authproto="VPN" and user='{SuspectUser}' and system='{TragetHost}' | duration 1h

stream=authentication where action="LOGIN" and status="PASSED" and authproto="VPN" | duration 1h | select system, user, distinct_count(srcip) as srcipcount | groupby system, user | having srcipcount > 3

stream=authentication where action="LOGIN" and status="FAILED" and crownjewel="Yes" and authproto="SSH" and user is not null | select user, system, distinct_count(system) as systemcount | groupby user, system | having systemcount > 1 | duration 1d

stream=authentication where action="LOGIN" and status="FAILED" and crownjewel="Yes" and authproto="SSH" and user is not null and user='{SuspectUser}' and system='{TargetHost}' | duration 1d

stream=firewall where Action="CONNECTION_TERMINATED" and DstPort in ("139", "445") and srcip='{SuspectHost}' and system='{TargetHost}' | duration 6m

stream=firewall where Action="CONNECTION_TERMINATED" and DstPort in ("139", "445") | groupby system, srcip

stream=AUDITD where action="SERVICE_STOPPED" and status="PASSED" and not user in ("", "null") | groupby user, system

stream=AUDITD where action="SERVICE_STOPPED" and status="PASSED" and not user in ("", "null") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=configuration where action="CONFIGURATION_CHANGED" and status="PASSED" and config="Service Stopped" and not user in ("", "null") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=configuration where action="CONFIGURATION_CHANGED" and status="PASSED" and config="Service Stopped" and not user in ("", "null") | groupby user, system 

Stream=EP-PROCESS where Action="PROCESS_ADDED" and Status="PASSED" | duration 7d | groupby image

stream=authentication where action="LOGIN" and status="PASSED" and authproto="SSH" | duration 1h | select system, user, distinct_count(srcip) as srcipcount | groupby system, user | having srcipcount > 3

stream=authentication where action="LOGIN" and status="PASSED" and authproto="SSH" and user='{SuspectUser}' and system='{TargeHost}' | duration 1h

Stream=IAM where not user in ("", "-", "null") and status="PASSED" | groupby user | duration 7d

stream=IAM where Action="PASSWORD_CHANGED" AND Status="PASSED" and user='{SuspectUser}' and targetuser='{TargetUser}' | duration 6m

stream=IAM where Action="PASSWORD_CHANGED" AND Status="PASSED" | groupby user, targetuser 

stream=EP-PROCESS where ( Image LIKE "%C%PerfLogs%" OR Image LIKE "%C%\Recycle\.bin%" OR Image LIKE "%C%Intel%Logs%" OR Image LIKE "%C%Users%Default%" OR Image LIKE "%C%Users%Public%" OR Image LIKE "%C%Users%NetworkService%" OR Image LIKE "%C%Windows%Fonts%" OR Image LIKE "%C%Windows%Debug%" OR Image LIKE "%C%Windows%Media%" OR Image LIKE "%C%Windows%Help%" OR Image LIKE "%C%Windows%addins%" OR Image LIKE "%C%Windows%repair%" OR Image LIKE "%C%Windows%security%" OR Image LIKE "%RSA%MachineKeys%" OR Image LIKE "%C%Windows%system32%config%systemprofile%" OR Image LIKE "%C%Windows%Tasks%" OR Image LIKE "%C%Windows%System32%Tasks%" OR Image LIKE "%C%Program Files%" OR Image LIKE "%C%Program Files (x86)%" OR Image LIKE "%C%ProgramData%" OR Image LIKE "%C%Windows%" OR Image LIKE "%C%System32%" OR Image LIKE "%C%SysWOW64%" ) and crownjewel="Yes"  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=EP-PROCESS where ( Image LIKE "%C%PerfLogs%" OR Image LIKE "%C%\Recycle\.bin%" OR Image LIKE "%C%Intel%Logs%" OR Image LIKE "%C%Users%Default%" OR Image LIKE "%C%Users%Public%" OR Image LIKE "%C%Users%NetworkService%" OR Image LIKE "%C%Windows%Fonts%" OR Image LIKE "%C%Windows%Debug%" OR Image LIKE "%C%Windows%Media%" OR Image LIKE "%C%Windows%Help%" OR Image LIKE "%C%Windows%addins%" OR Image LIKE "%C%Windows%repair%" OR Image LIKE "%C%Windows%security%" OR Image LIKE "%RSA%MachineKeys%" OR Image LIKE "%C%Windows%system32%config%systemprofile%" OR Image LIKE "%C%Windows%Tasks%" OR Image LIKE "%C%Windows%System32%Tasks%" OR Image LIKE "%C%Program Files%" OR Image LIKE "%C%Program Files (x86)%" OR Image LIKE "%C%ProgramData%" OR Image LIKE "%C%Windows%" OR Image LIKE "%C%System32%" OR Image LIKE "%C%SysWOW64%" ) and crownjewel="Yes" | groupby user, system, image 

stream=authentication where action="LOGIN" and status="FAILED" and crownjewel="Yes" and authproto="VPN" and user is not null and user='{SuspectUser}' and system='{TargetHost}' | duration 1d

stream=authentication where action="LOGIN" and status="FAILED" and crownjewel="Yes" and authproto="VPN" and user is not null | select user, system, distinct_count(system) as systemcount | groupby user, system | having systemcount > 1 | duration 1d

stream=firewall where dstport="3389" and srctype="PRIVATE" and dsttype="PUBLIC" and crownjewel="Yes" and action="PACKET_ALLOWED" | groupby dstip, srcip

stream=firewall where dstport="3389" and srctype="PRIVATE" and dsttype="PUBLIC" and crownjewel="Yes" and action="PACKET_ALLOWED" and dstip='{TargetHost}' and srcip='{SuspectHost}' | duration 6m

Stream=EP-PROCESS where Action="PROCESS_ADDED" and Status="PASSED" and user='{SuspectUser}' and image='{SUspectProcess}' and system='{TargetHost}' | duration 6m

Stream=EP-PROCESS where Action="PROCESS_ADDED" and Status="PASSED" | groupby user, image, system

stream=authentication

stream=nta-intel where srcip="{TargetHost}" and indicator="{SuspectObject}" |  duration 15m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::DOMAIN' | groupby srcip, indicatortype, indicator, msg | duration 30m

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(targetobject),  '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?webcam') | groupby user, system 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%hkey_current_user%control panel%wallpaper%' | duration 1d

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?wallpaper') | duration 1d

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::DOMAIN' | groupby srcip, indicatortype, indicator, msg | duration 30m

stream=nta-intel where srcip="{TargetHost}" and indicator="{SuspectObject}" |  duration 15m

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?wallpaper') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?wallpaper') | groupby user, system 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?policies.*?system.*?(legalnoticecaption|legalnoticetext)') | duration 1d |

stream=IAM where action="USER_REMOVED"|  groupby user |  having count_col1>=4

stream=nta-intel where indicator like "%yanquisorigan.shop%"  | duration 24h |  limit 1

stream=nta-intel where srcip="{TargetHost}" and indicator="{SuspectObject}" |  duration 30m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%current_user%'

stream=nta-intel where srcip="{TargetHost}" and indicator="{SuspectObject}" |  duration 30m

stream=nta-intel where not indicatortype like "%Intel::DOMAIN%" | groupby indicatortype, indicator,  msg, srcip | duration 30m

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?wallpaper') | groupby user, system | duration 1h

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?policies.*?system.*?(legalnoticecaption|legalnoticetext)') | duration 1d |  groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?policies.*?system.*?(legalnoticecaption|legalnoticetext)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?policies.*?system.*?(legalnoticecaption|legalnoticetext)') | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?policies.*?system.*?(legalnoticecaption|legalnoticetext)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(targetobject), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?webcam') | groupby user, system 

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(targetobject), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?webcam') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=nta-intel where srcip="{TargetHost}" and indicator="{SuspectObject}" |  duration 30m

stream=nta-intel  | groupby indicatortype, indicator,  msg, srcip | duration 30m

stream=nta-intel where action='THREAT_DETECTED' and indicatortype='Intel::DOMAIN' | groupby srcip, indicatortype, indicator, msg | duration 10m

stream=nta-intel where srcip="{TargetHost}" and indicator="{SuspectObject}" |  duration 30m

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?wallpaper') | groupby user, system 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?policies.*?system.*?(legalnoticecaption|legalnoticetext)') | duration 1d |  groupby user, system

stream=win-audit  where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?policies.*?system.*?(legalnoticecaption|legalnoticetext)') | groupby user, system | duration 1d

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?policies.*?system.*?(legalnoticecaption|legalnoticetext)') | groupby user, system 

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext), '(hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?policies.*?system.*?(legalnoticecaption|legalnoticetext)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(targetobject), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?webcam') | groupby user, system 

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(targetobject), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?webcam') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%shutdown%/r%' or lower(commandline) like '%shutdown%/s%' or lower(commandline) like '%shutdown%/l%' | duration 1d

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%shutdown%/r%' or lower(commandline) like '%shutdown%/s%' or lower(commandline) like '%shutdown%/l%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%shutdown%/r%' or lower(commandline) like '%shutdown%/s%' or lower(commandline) like '%shutdown%/l%' | duration 1d |  groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'del.*?(.vhd|.bac|.bak|.wbcat|.bkf|backup|.set|.win|.dsk|.vhdx|.tib|.gho|.iso|.img|.dbk|.xml|.cfg|.recovery|.rstrui)') | duration 15m | select system, user, commandline | limit 10000

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'del.*?(.vhd|.bac|.bak|.wbcat|.bkf|backup|.set|.win|.dsk|.vhdx|.tib|.gho|.iso|.img|.dbk|.xml|.cfg|.recovery|.rstrui)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(install-transportagent.*?name.*?assemblypath|enable-transportagent|get-transportagent|set-transportagent|uninstall-transportagent)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(install-transportagent.*?name.*?assemblypath|enable-transportagent|get-transportagent|set-transportagent|uninstall-transportagent)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(install-transportagent.*?name.*?assemblypath|enable-transportagent|get-transportagent|set-transportagent|uninstall-transportagent)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(install-transportagent.*?name.*?assemblypath|enable-transportagent|get-transportagent|set-transportagent|uninstall-transportagent)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline),'((hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language|chcp)')) | groupby user, system 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline),'((hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language|chcp)')) user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline),'((hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language|chcp)')) | groupby user, system 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline),'((hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language|chcp)')) user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=IAM where action="USER_REMOVED" and user='{SuspectUser}'

stream=IAM where action="USER_REMOVED"|  groupby user |  having count_col1>=4

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'del.*?(.vhd|.bac|.bak|.wbcat|.bkf|backup|.set|.win|.dsk|.vhdx|.tib|.gho|.iso|.img|.dbk|.xml|.cfg|.recovery|.rstrui)') and user='{SuspectUser}' and system='{TargetHost}' | duration 16m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'del.*?(.vhd|.bac|.bak|.wbcat|.bkf|backup|.set|.win|.dsk|.vhdx|.tib|.gho|.iso|.img|.dbk|.xml|.cfg|.recovery|.rstrui)') | duration 15m | select system, user, commandline | limit 10000

stream=threat where sourcename = "TREND-MICRO-ENDPOINT" |  groupby @cs5 as Action , file , threat , user , devsrcip | duration 1d

stream=IAM where eid='4726' AND action='PASSWORD_CHANGED' | groupby user, targetuser 

stream=IAM where eid='4726' AND action='PASSWORD_CHANGED' and targetuser='{TargetUser}' and user='{SuspectUser}' | duration 6m

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'cmd.exe.*?assoc.*?.hta.*?\=') or rlike(lower(commandline), 'hkey_classes_root.*?shell.*?command')| groupby system, user

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'cmd.exe.*?assoc.*?.hta.*?\=') or rlike(lower(commandline), 'hkey_classes_root.*?shell.*?command') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'cmd.exe.*?assoc.*?.hta.*?\=') or rlike(lower(commandline), 'hkey_classes_root.*?shell.*?command') | groupby system, user

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%shutdown%/r%' or lower(commandline) like '%shutdown%/s%' or lower(commandline) like '%shutdown%/l%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%shutdown%/r%' or lower(commandline) like '%shutdown%/s%' or lower(commandline) like '%shutdown%/l%' | duration 1d |  groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%shutdown%/r%' or lower(commandline) like '%shutdown%/s%' or lower(commandline) like '%shutdown%/l%' | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%shutdown%/r%' or lower(commandline) like '%shutdown%/s%' or lower(commandline) like '%shutdown%/l%'  and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(install-transportagent.*?name.*?assemblypath|enable-transportagent|get-transportagent|set-transportagent|uninstall-transportagent)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(install-transportagent.*?name.*?assemblypath|enable-transportagent|get-transportagent|set-transportagent|uninstall-transportagent)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(install-transportagent.*?name.*?assemblypath|enable-transportagent|get-transportagent|set-transportagent|uninstall-transportagent)') | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), '(install-transportagent.*?name.*?assemblypath|enable-transportagent|get-transportagent|set-transportagent|uninstall-transportagent)') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=threat where sourcename = "TREND-MICRO-ENDPOINT" |  groupby @cs5 as Action , file , threat , user , devsrcip | duration 1d

stream=threat where sourcename = "TREND-MICRO-ENDPOINT" |  groupby CNAMtime , @cs5 as Action , file , threat , user , devsrcip | duration 1d

stream=win-audit where action='OBJECT_ACCESSED' and rlike(lower(scriptblocktext) , 'get-wmiobject.*?win32_computersystem.*?select-object -expandproperty.*?(manufacturer|model)') and rlike(lower(scriptblocktext), 'microsoft corporation.*?(vmware|virtual|virtualbox)') | duration 1h

stream=threat where sourcename = "TREND-MICRO-ENDPOINT" |  groupby @cs5 as Action , file , threat , user , devsrcip | duration 1d

stream=threat where sourcename = "TREND-MICRO-ENDPOINT" |  groupby @cs5 as Action , file , threat , user , devsrcip | duration 1d

stream=threat where sourcename = "TREND-MICRO-ENDPOINT" |  groupby @cs5 as Action , file , threat , user , devsrcip | duration 1d

stream=threat where sourcename = "TREND-MICRO-ENDPOINT" |  groupby @cs5 as Action , file , threat , user , devsrcip | duration 1d

stream=firewall | duration 30m | groupby srcip,system

stream=win-audit where action='OBJECT_ACCESSED' and (rlike(lower(scriptblocktext) , 'get-wmiobject.*?msacpi_thermalzonetemperature')) or (rlike(lower(scriptblocktext) , 'get-wmiobject.*?win32_computersystem.*?select-object -expandproperty.*?(manufacturer|model)') and rlike(lower(scriptblocktext), 'microsoft corporation.*?(vmware|virtual|virtualbox)')) | duration 1h

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'get-wmiobject.*?msacpi_thermalzonetemperature')) or (rlike(lower(commandline) , 'get-wmiobject.*?select-object -expandproperty.*?(manufacturer|model)') and rlike(lower(commandline), 'microsoft corporation.*?(vmware|virtual|virtualbox)')) | groupby user, system 

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'get-wmiobject.*?msacpi_thermalzonetemperature')) or (rlike(lower(commandline) , 'get-wmiobject.*?select-object -expandproperty.*?(manufacturer|model)') and rlike(lower(commandline), 'microsoft corporation.*?(vmware|virtual|virtualbox)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and (rlike(lower(scriptblocktext) , 'get-wmiobject.*?msacpi_thermalzonetemperature')) or (rlike(lower(scriptblocktext) , 'get-wmiobject.*?win32_computersystem.*?select-object -expandproperty.*?(manufacturer|model)') and rlike(lower(scriptblocktext), 'microsoft corporation.*?(vmware|virtual|virtualbox)')) | duration 1h |  groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (rlike(lower(scriptblocktext) , 'get-wmiobject.*?msacpi_thermalzonetemperature')) or (rlike(lower(scriptblocktext) , 'get-wmiobject.*?win32_computersystem.*?select-object -expandproperty.*?(manufacturer|model)') and rlike(lower(scriptblocktext), 'microsoft corporation.*?(vmware|virtual|virtualbox)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'start.*?\\w+.\\w+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'start.*?\\w+.\\w+') | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%get-wmiobject%shadowcopy%delete%' or lower(commandline) like '%vssadmin%delete%shadows%' or lower(commandline) like '%wmic%shadowcopy%delete%'  | duration 1d

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), '(hklm|hkey_local_machine).*?system.*?currentcontrolset.*?controle.*?nls.*?language')) | duration 15m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(schtasks|scheduledtask).*?(tn|taskname).*?(systemrestore|sr).*?disable') | duration 1d

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  lower(commandline) like  '%bcdedit%/set%bootstatuspolicy%ignoreallfailures%' or lower(commandline) like '%bcdedit%/set%recoveryenabled%no%' |groupby user, system | duration 1d

stream=win-audit where action='OBJECT_ACCESSED' and (rlike(lower(scriptblocktext) , 'get-wmiobject.*?msacpi_thermalzonetemperature')) or (rlike(lower(scriptblocktext) , 'get-wmiobject.*?win32_computersystem.*?select-object -expandproperty.*?(manufacturer|model)') and rlike(lower(scriptblocktext), 'microsoft corporation.*?(vmware|virtual|virtualbox)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and (rlike(lower(scriptblocktext) , 'get-wmiobject.*?msacpi_thermalzonetemperature')) or (rlike(lower(scriptblocktext) , 'get-wmiobject.*?select-object -expandproperty.*?(manufacturer|model)') and rlike(lower(scriptblocktext), 'microsoft corporation.*?(vmware|virtual|virtualbox)')) | duration 1h |  groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (rlike(lower(scriptblocktext) , 'get-wmiobject.*?msacpi_thermalzonetemperature')) or (rlike(lower(scriptblocktext) , 'get-wmiobject.*?select-object -expandproperty.*?(manufacturer|model)') and rlike(lower(scriptblocktext), 'microsoft corporation.*?(vmware|virtual|virtualbox)')) | groupby user, system

stream=win-audit where action='OBJECT_ACCESSED' and (rlike(lower(scriptblocktext) , 'get-wmiobject.*?msacpi_thermalzonetemperature')) or (rlike(lower(scriptblocktext) , 'get-wmiobject.*?win32_computersystem.*?select-object -expandproperty.*?(manufacturer|model)') and rlike(lower(scriptblocktext), 'microsoft corporation.*?(vmware|virtual|virtualbox)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'start.*?\\w+.\\w+') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'start.*?\\w+.\\w+') | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%get-wmiobject%shadowcopy%delete%' or lower(commandline) like '%vssadmin%delete%shadows%' or lower(commandline) like '%wmic%shadowcopy%delete%'  | duration 1d | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%get-wmiobject%shadowcopy%delete%' or lower(commandline) like '%vssadmin%delete%shadows%' or lower(commandline) like '%wmic%shadowcopy%delete%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and lower(scriptblocktext) like '%get-wmiobject%shadowcopy%delete%' or lower(scriptblocktext) like '%vssadmin%delete%shadows%' or lower(scriptblocktext) like '%wmic%shadowcopy%delete%' | groupby user, system 

stream=win-audit where action='OBJECT_ACCESSED' and lower(scriptblocktext) like '%get-wmiobject%shadowcopy%delete%' or lower(scriptblocktext) like '%vssadmin%delete%shadows%' or lower(scriptblocktext) like '%wmic%shadowcopy%delete%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(schtasks|scheduledtask).*?(tn|taskname).*?(systemrestore|sr).*?disable') or rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?(policies.*?microsoft.*?windows.*?nt|microsoft.*?windows.*?nt.*?currentversion).*?systemrestore.*?disable') | duration 1d

stream=authentication where user!="rajendra.boke@net-mon.net"|  duration from 2024-06-20T12:00:00 to 2024-06-21T00:00:00 |  groupby user,action,status

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), '(hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language')) | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(schtasks|scheduledtask).*?(tn|taskname).*?(systemrestore|sr).*?disable') or rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?(policies.*?microsoft.*?windows.*?nt|microsoft.*?windows.*?nt.*?currentversion).*?systemrestore.*?disable') | duration 1d | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(schtasks|scheduledtask).*?(tn|taskname).*?(systemrestore|sr).*?disable') or rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?(policies.*?microsoft.*?windows.*?nt|microsoft.*?windows.*?nt.*?currentversion).*?systemrestore.*?disable') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(schtasks|scheduledtask).*?(tn|taskname).*?(systemrestore|sr).*?disable') or rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?(policies.*?microsoft.*?windows.*?nt|microsoft.*?windows.*?nt.*?currentversion).*?systemrestore.*?disable') | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(schtasks|scheduledtask).*?(tn|taskname).*?(systemrestore|sr).*?disable') or rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?(policies.*?microsoft.*?windows.*?nt|microsoft.*?windows.*?nt.*?currentversion).*?systemrestore.*?disable') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  lower(commandline) like '%wbadmin%delete%catalog%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  lower(commandline) like '%wbadmin%delete%catalog%' | duration 1d | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  lower(commandline) like '%bcdedit%/set%bootstatuspolicy%ignoreallfailures%' or lower(commandline) like '%bcdedit%/set%recoveryenabled%no%' |groupby user, system | duration 1d

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  lower(commandline) like '%bcdedit%/set%bootstatuspolicy%ignoreallfailures%' or lower(commandline) like '%bcdedit%/set%recoveryenabled%no%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%get-wmiobject%shadowcopy%delete%' or lower(commandline) like '%vssadmin%delete%shadows%' or lower(commandline) like '%wmic%shadowcopy%delete%' | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%get-wmiobject%shadowcopy%delete%' or lower(commandline) like '%vssadmin%delete%shadows%' or lower(commandline) like '%wmic%shadowcopy%delete%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and lower(scriptblocktext) like '%get-wmiobject%shadowcopy%delete%' or lower(scriptblocktext) like '%vssadmin%delete%shadows%' or lower(scriptblocktext) like '%wmic%shadowcopy%delete%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='OBJECT_ACCESSED' and lower(scriptblocktext) like '%get-wmiobject%shadowcopy%delete%' or lower(scriptblocktext) like '%vssadmin%delete%shadows%' or lower(scriptblocktext) like '%wmic%shadowcopy%delete%' | groupby user, system | duration 1d

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(schtasks|scheduledtask).*?(tn|taskname).*?(systemrestore|sr).*?disable') or rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?(policies.*?microsoft.*?windows.*?nt|microsoft.*?windows.*?nt.*?currentversion).*?systemrestore.*?disable') | duration 1d | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(schtasks|scheduledtask).*?(tn|taskname).*?(systemrestore|sr).*?disable') or rlike(lower(commandline), '(hklm|hkey_local_machine).*?software.*?(policies.*?microsoft.*?windows.*?nt|microsoft.*?windows.*?nt.*?currentversion).*?systemrestore.*?disable') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  lower(commandline) like '%wbadmin%delete%catalog%' | duration 1d

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  lower(commandline) like '%wbadmin%delete%catalog%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  lower(commandline) like '%wbadmin%delete%catalog%' | duration 1d | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  lower(commandline) like '%wbadmin%delete%catalog%'  or lower(commandline) like '%wbadmin%delete%systemstatebackup%' | duration 1d 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  lower(commandline) like '%wbadmin%delete%catalog%'  or lower(commandline) like '%wbadmin%delete%systemstatebackup%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), '(hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), '(hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language')) | groupby user, system | duration 1d

stream=other

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  lower(commandline) like '%wbadmin%delete%catalog%'  or lower(commandline) like '%wbadmin%delete%systemstatebackup%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  lower(commandline) like '%wbadmin%delete%catalog%'  or lower(commandline) like '%wbadmin%delete%systemstatebackup%' | groupby user, system

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'xcopy.*?(/i|/a|/m|/d|/t|/s|/e|/q|/f|/l|/r|/k|/x|/h|/y|/n|/j|/z)') | duration 1d | select system, user, commandline

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'xcopy.*?(/i|/a|/m|/d|/t|/s|/e|/q|/f|/l|/r|/k|/x|/h|/y|/n|/j|/z)') and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'xcopy.*?(/i|/a|/m|/d|/t|/s|/e|/q|/f|/l|/r|/k|/x|/h|/y|/n|/j|/z)') | duration 15m | select system, user, commandline

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  lower(commandline) like '%bcdedit%/set%bootstatuspolicy%ignoreallfailures%' or lower(commandline) like '%bcdedit%/set%recoveryenabled%no%' |groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  lower(commandline) like '%bcdedit%/set%bootstatuspolicy%ignoreallfailures%' or lower(commandline) like '%bcdedit%/set%recoveryenabled%no%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  lower(commandline) like '%bcdedit%/set%bootstatuspolicy%ignoreallfailures%' or lower(commandline) like '%bcdedit%/set%recoveryenabled%no%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and  lower(commandline) like '%bcdedit%/set%bootstatuspolicy%ignoreallfailures%' or lower(commandline) like '%bcdedit%/set%recoveryenabled%no%' | groupby user, system

stream=configuration where action='CONFIGURATION_CHANGED' and lower(commandline) like '%vssadmin%resize%shadowstorage%' | groupby user, system

stream=configuration where action='CONFIGURATION_CHANGED' and lower(commandline) like '%vssadmin%resize%shadowstorage%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'cmd.exe.*?assoc.*?.hta.*?\=') or rlike(lower(commandline), 'hkey_classes_root.*?shell.*?command')| groupby system, user 

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'cmd.exe.*?assoc.*?.hta.*?\=') or rlike(lower(commandline), 'hkey_classes_root.*?shell.*?command') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=IAM where eid in ('4723', '4724') AND action='PASSWORD_CHANGED' and targetuser='{TargetUser}' and user='{SuspectUser}' | duration 6m

stream=IAM where eid in ('4723', '4724') AND action='PASSWORD_CHANGED' | groupby user, targetuser 

stream=IAM where eid='4726' AND action='PASSWORD_CHANGED' and targetuser='{TargetUser}' and user='{SuspectUser}' | duration 6m

stream=IAM where eid='4726' AND action='USER_DELETED' | groupby user, targetuser 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline),'((hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language|chcp)')) | groupby user , system | duration 10m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline),'((hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language|chcp)')) user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'xcopy.*?(/i|/a|/m|/d|/t|/s|/e|/q|/f|/l|/r|/k|/x|/h|/y|/n|/j|/z)') and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'xcopy.*?(/i|/a|/m|/d|/t|/s|/e|/q|/f|/l|/r|/k|/x|/h|/y|/n|/j|/z)') | duration 15m | select system, user, commandline

stream=ep-process, win-audit,configuration where action in ('PROCESS_CREATED', 'PROCESS_ADDED', 'CONFIGURATION_CHANGED') and lower(commandline) like '%vssadmin%resize%shadowstorage%' | groupby user, system | duration 3h

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload%SysmonDrv%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit where action='PROCESS_CREATED' and newprocessname like '%fltMC.exe' and commandline like '%unload%SysmonDrv%' | groupby user, system

stream=IAM where eid in ('4723', '4724') AND action='PASSWORD_CHANGED' | groupby user, targetuser 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline),'((hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language|chcp)')) | groupby user, system | duration 1d

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), '(hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline),'((hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language|chcp)')) | groupby user, system | duration 1d

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), '(hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%bcdedit%/set%bootstatuspolicy%ignoreallfailures%' or lower(commandline) like '%bcdedit%/set%recoveryenabled%no%' | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and lower(commandline) like '%bcdedit%/set%bootstatuspolicy%ignoreallfailures%' or lower(commandline) like '%bcdedit%/set%recoveryenabled%no%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit,configuration where action in ('PROCESS_CREATED', 'PROCESS_ADDED', 'CONFIGURATION_CHANGED') and lower(commandline) like '%vssadmin%resize%shadowstorage%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit,configuration where action in ('PROCESS_CREATED', 'PROCESS_ADDED', 'CONFIGURATION_CHANGED') and lower(commandline) like '%vssadmin%resize%shadowstorage%' | groupby user, system

stream=* | duration from 2024-07-29T20:00:00 to 2024-07-30T14:00:00 | groupby pstatus | timeslice 30m

stream=* | duration from 2024-07-29T20:00:00 to 2024-07-30T14:00:00 | groupby pstatus | timeslice 30m

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'cmd.exe.*?assoc.*?.hta.*?\=') or rlike(lower(commandline), 'hkey_classes_root.*?shell.*?command') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'cmd.exe.*?assoc.*?.hta.*?\=') or rlike(lower(commandline), 'hkey_classes_root.*?shell.*?command') | groupby system, user

stream=authentication where action="LOGIN" and status="FAILED" |  duration 30m |  groupby user | having count_col1 >1000

stream=authentication where action="LOGIN" and status="FAILED" |  duration 30m |  groupby user | having count_col1 >1000

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED')  and (rlike(lower(commandline) , 'findstr.*?pass.*?\\.(xml|doc|txt|xls|json|csv|html)')) | duration 1d

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'xcopy.*?(/i|/a|/m|/d|/t|/s|/e|/q|/f|/l|/r|/k|/x|/h|/y|/n|/j|/z)') and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=win-audit where action='PROCESS_CREATED' and rlike(lower(commandline), 'xcopy.*?(/i|/a|/m|/d|/t|/s|/e|/q|/f|/l|/r|/k|/x|/h|/y|/n|/j|/z)') | duration 15m | select system, user, commandline

stream=nta-intel where srcip="{TargetHost}" and indicator="{SuspectObject}" |  duration 30m

stream=nta-intel where not indicatortype like "%Intel::DOMAIN%" | groupby indicatortype, indicator,  msg, srcip | duration 30m

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'cmd.exe.*?assoc.*?.hta.*?\=') or rlike(lower(commandline), 'hkey_classes_root.*?shell.*?command') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), 'cmd.exe.*?assoc.*?.hta.*?\=') or rlike(lower(commandline), 'hkey_classes_root.*?shell.*?command') | groupby system, user

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline),'((hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language|chcp)')) | groupby user , system | duration 10m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline),'((hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language|chcp)')) user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline),'((hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language|chcp)')) | groupby user, system 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline),'((hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language|chcp)')) user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll')) |  groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline), 'copy.*?system.*?.exe.*?appdata.*?.exe') or rlike(lower(commandline), 'copy.*?system.*?.dll.*?appdata.*?.dll')) and user='{SuspectUser}' and system='{TargetHost}' | duration 16m

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(targetobject), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows nt.*?currentversion.*?winlogon.*?(shell|userinit|notify)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(targetobject), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows nt.*?currentversion.*?winlogon.*?(shell|userinit|notify)') | groupby system, user 

stream=nta-notice where noticeidentifier like "%ATTACK::%" and analyzer like '%Notice::ACTION_LOG%' | groupby noticeidentifier, srcip, dstip, errormsg |  duration 1h

stream=ep-process, win-audit,configuration where action in ('PROCESS_CREATED', 'PROCESS_ADDED', 'CONFIGURATION_CHANGED') and lower(commandline) like '%vssadmin%resize%shadowstorage%' and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit,configuration where action in ('PROCESS_CREATED', 'PROCESS_ADDED', 'CONFIGURATION_CHANGED') and lower(commandline) like '%vssadmin%resize%shadowstorage%' | groupby user, system | duration 3h

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline),'((hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language|chcp)')) | groupby user, system 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline),'((hklm|hkey_local_machine).*?system.*?currentcontrolset.*?control.*?nls.*?language|chcp)')) user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?(screensaver|screensaveactive|screensavetimeout|screensaverissecure|scrnsave)') | groupby user, system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu).*?control panel.*?desktop.*?(screensaver|screensaveactive|screensavetimeout|screensaverissecure|scrnsave)') and system='{TargetHost}' and user='{TargetUser}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(targetobject), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows nt.*?currentversion.*?winlogon.*?(shell|userinit|notify)') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-registry where action='OBJECT_MODIFIED' and rlike(lower(targetobject), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows nt.*?currentversion.*?winlogon.*?(shell|userinit|notify)') | groupby system, user 

stream=CONFIGURATION,WIN-AUDIT,EP-PROCESS where action in ("PROCESS_CREATED", "PROCESS_ADDED", "CONFIGURATION_CHANGED") and ((lower(commandline) like "%csuninstalltool%quiet%") or (lower(commandline) like "%windowssensor%uninstall%quiet%")) and system='{TargetHost}' | duration 6m

stream=CONFIGURATION,WIN-AUDIT,EP-PROCESS where action in ("PROCESS_CREATED", "PROCESS_ADDED", "CONFIGURATION_CHANGED") and ((lower(commandline) like "%csuninstalltool%quiet%") or (lower(commandline) like "%windowssensor%uninstall%quiet%")) | groupby system

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?webcam') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?webcam') | groupby user, system | duration 1d

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'findstr.*?pass.*?\\.(xml|doc|txt|xls|json|csv|html)')) | groupby system, user

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'findstr.*?pass.*?\\.(xml|doc|txt|xls|json|csv|html)')) and system='{TargetHost}'and user='{SuspectUser}' | duration 6m

stream=authentication where action="LOGIN" and status="FAILED" |  groupby user |  limit 5 |  duration 20m

stream=WIN-AUDIT,EP-PROCESS where action in ("PROCESS_CREATED", "PROCESS_ADDED") and ( rlike(lower(commandline), "(sc.*?delete|remove-service|wmic.*?service.*?delete).*?(windefend|mpssvc|wuauserv|wscsvc|sense|policyagent|wdnissvc|vaultsvc|eventlog|nlasvc|bfe|rpcss|rasman|smartscreen|nissrv|winmgmt|alg|winrm|swprv|securityhealthservice|gpsvc|kdc|lanmanserver|lanmanworkstation|msdtc|efs|bdesvc|napagent|wbiosrvc|wbengine|w32time|dgssvc|scardsvr|wscsvc|winrm|mcafeedlpagentservice)")) and user="{SuspectUser}" and system="{TargetHost}" | duration 6m

stream=WIN-AUDIT,EP-PROCESS where action in ("PROCESS_CREATED", "PROCESS_ADDED") and ( rlike(lower(commandline), "(sc.*?delete|remove-service|wmic.*?service.*?delete).*?(windefend|mpssvc|wuauserv|wscsvc|sense|policyagent|wdnissvc|vaultsvc|eventlog|nlasvc|bfe|rpcss|rasman|smartscreen|nissrv|winmgmt|alg|winrm|swprv|securityhealthservice|gpsvc|kdc|lanmanserver|lanmanworkstation|msdtc|efs|bdesvc|napagent|wbiosrvc|wbengine|w32time|dgssvc|scardsvr|wscsvc|winrm|mcafeedlpagentservice)"))| groupby commandline | duration 2d

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?webcam') | groupby user, system 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?windows.*?currentversion.*?capabilityaccessmanager.*?consentstore.*?webcam') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?system.*?currentcontrolset.*?services.*?ntds.*?lsadbextpt') | groupby system, user

stream=win-audit, ep-process where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hklm|hkey_local_machine).*?system.*?currentcontrolset.*?services.*?ntds.*?lsadbextpt') and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?office test.*?special.*?perf') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?office test.*?special.*?perf') | groupby user, system  | duration 1h

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?office test.*?special.*?perf') and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and rlike(lower(commandline), '(hkey_current_user|hkcu|hklm|hkey_local_machine).*?software.*?microsoft.*?office test.*?special.*?perf') | groupby user, system

stream=authentication where action="LOGIN" | groupby srcip,system,systemname|  duration 1d|
select srcip,system,systemname,count_if(status="PASSED") as pass_count , count_if(status="FAILED") as failed_count |  
having failed_count > 50 and failed_count>5*pass_count

stream=WINDOWS-EVENT where user is not null and user='{SuspectUser}' | duration 1h | limit 1

stream=WINDOWS-EVENT where user is not null | duration 24h |  select User | limit 1

stream=nta-ssl where (version='TLSv10' or version='TLSv11') |  groupby srcip, version | duration 2h

stream=nta-ssl where (version='TLSv10' or version='TLSv11') and devsrcip='{TargetResource}'|  duration 1h

stream=WIN-AUDIT,EP-PROCESS where action IN ("PROCESS_CREATED", "PROCESS_ADDED") and rlike(lower(commandline), "(wmic.*?process.*?where.*?(msmpeng|mssense|smartscreen|windefend|mpssvc|nortonantivirus|ccsvchst|mcshield|mfevtps|avp).*?name.*?delte|(taskkill.*?f.*?im|pskill|processhacker.*?type.*?process.*?kill|backstab.*?-k.*?-n).*?(msmpeng|smartscreen|windefend|mpssvc|nortonantivirus|ccsvchst|mssense|mcshield|mfevtps|avp))") and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=WIN-AUDIT,EP-PROCESS where action IN ("PROCESS_CREATED", "PROCESS_ADDED") and rlike(lower(commandline), "(wmic.*?process.*?where.*?(msmpeng|mssense|smartscreen|windefend|mpssvc|nortonantivirus|ccsvchst|mcshield|mfevtps|avp).*?name.*?delte|(taskkill.*?f.*?im|pskill|processhacker.*?type.*?process.*?kill|backstab.*?-k.*?-n).*?(msmpeng|smartscreen|windefend|mpssvc|nortonantivirus|ccsvchst|mssense|mcshield|mfevtps|avp))") |  groupby user, system

stream=authentication where action="LOGIN" | groupby srcip,system,systemname|  duration 1d|
select srcip,system,systemname,count_if(status="PASSED") as pass_count , count_if(status="FAILED") as failed_count |  
having failed_count > 50 and failed_count>5*pass_count

stream=authentication where action="LOGIN" | groupby srcip,system,systemname|  duration 1d|
select srcip,system,systemname,count_if(status="PASSED") as pass_count , count_if(status="FAILED") as failed_count |  
having failed_count > 50 and failed_count>5*pass_count

stream=authentication where action="LOGIN" | groupby srcip,system,systemname, sourcename, extractorid|  duration 1d|
select srcip,system,systemname, sourcename, extractorid,count_if(status="PASSED") as pass_count , count_if(status="FAILED") as failed_count |  
having failed_count > 50 and failed_count>5*pass_count

stream=WIN-AUDIT,EP-PROCESS where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (lower(commandline) like '%winpwn%' and rlike(lower(commandline), '(winpeas|itm4nprivesc|privesccheck|allchecks|oldchecks|otherchecks|generalrecon|morerecon|rbcd-check|dotnetsearch|dotnet|powersql|powersharppack.*?(watson|sharpup|powerup|seatbelt))')) and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=WIN-AUDIT,EP-PROCESS where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (lower(commandline) like '%winpwn%' and rlike(lower(commandline), '(winpeas|itm4nprivesc|privesccheck|allchecks|oldchecks|otherchecks|generalrecon|morerecon|rbcd-check|dotnetsearch|dotnet|powersql|powersharppack.*?(watson|sharpup|powerup|seatbelt))'))| duration 15m | select system, user, commandline | limit 10000 

stream=authentication where action="LOGIN" and system='{TargetHost}' and systemname='{}'

stream=authentication where action="LOGIN" | groupby srcip,system,systemname, sourcename, extractorid|  duration 1d|
select srcip,system,systemname, sourcename, extractorid,count_if(status="PASSED") as pass_count , count_if(status="FAILED") as failed_count |  
having failed_count > 50 and failed_count>5*pass_count

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'findstr.*?pass.*?\\.(xml|doc|txt|xls|json|csv|html)')) and system='{TargetHost}'and user='{SuspectUser}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'findstr.*?pass.*?\\.(xml|doc|txt|xls|json|csv|html)')) | groupby system, user

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'findstr.*?pass.*?\\.(xml|doc|txt|xls|json|csv|html)')) | groupby system, user

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'findstr.*?pass.*?\\.(xml|doc|txt|xls|json|csv|html)')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=authentication where action="LOGIN" | groupby srcip,system,systemname, sourcename, extractorid|  duration 1d|
select srcip,system,systemname, sourcename, extractorid,count_if(status="PASSED") as pass_count , count_if(status="FAILED") as failed_count |  
having failed_count > 50 and failed_count>5*pass_count

stream=WIN-AUDIT,EP-PROCESS where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (lower(commandline) like '%winpwn%' and rlike(lower(commandline), '(winpeas|itm4nprivesc|privesccheck|allchecks|oldchecks|otherchecks|generalrecon|morerecon|rbcd-check|dotnetsearch|dotnet|powersql|powersharppack.*?(watson|sharpup|powerup|seatbelt))')) and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=WIN-AUDIT,EP-PROCESS where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (lower(commandline) like '%winpwn%' and rlike(lower(commandline), '(winpeas|itm4nprivesc|privesccheck|allchecks|oldchecks|otherchecks|generalrecon|morerecon|rbcd-check|dotnetsearch|dotnet|powersql|powersharppack.*?(watson|sharpup|powerup|seatbelt))'))| duration 15m | select system, user, commandline | limit 10000 

stream=win-audit, ep-process where action in('PROCESS_CREATED', 'PROCESS_ADDED') and ( rlike(lower(commandline), 'reg add.*?(hkey_local_machine|hklm).*?currentcontrolset.*?control.*?session manager.*?appcertdlls')  or rlike(lower(parentcommandline), '(hkey_local_machine|hklm).*?system.*?currentcontrolset.*?control.*?session manager.*?appcertdlls')) and user='{SuspectUser}' and system='{TargetHost}' | duration 6m

stream=win-audit, ep-process where action in('PROCESS_CREATED', 'PROCESS_ADDED') and ( rlike(lower(commandline), 'reg add.*?(hkey_local_machine|hklm).*?currentcontrolset.*?control.*?session manager.*?appcertdlls')  or rlike(lower(parentcommandline), '(hkey_local_machine|hklm).*?system.*?currentcontrolset.*?control.*?session manager.*?appcertdlls')) | groupby system, user

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'findstr.*?pass.*?\\.(xml|doc|txt|xls|json|csv|html)')) | groupby system, user

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'findstr.*?pass.*?\\.(xml|doc|txt|xls|json|csv|html)')) and system='{TargetHost}'and user='{SuspectUser}' | duration 10m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'findstr.*?pass.*?\\.(xml|doc|txt|xls|json|csv|html)')) | groupby system, user

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'findstr.*?pass.*?\\.(xml|doc|txt|xls|json|csv|html)')) and system='{TargetHost}' and user='{SuspectUser}' | duration 10m

stream=WIN-AUDIT,EP-PROCESS where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (lower(commandline) like '%winpwn%' and rlike(lower(commandline), '(winpeas|itm4nprivesc|privesccheck|allchecks|oldchecks|otherchecks|generalrecon|morerecon|rbcd-check|dotnetsearch|dotnet|powersql|powersharppack.*?(watson|sharpup|powerup|seatbelt))')) and system='{TargetHost}' and user='{SuspectUser}' | duration 16m

stream=WIN-AUDIT,EP-PROCESS where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (lower(commandline) like '%winpwn%' and rlike(lower(commandline), '(winpeas|itm4nprivesc|privesccheck|allchecks|oldchecks|otherchecks|generalrecon|morerecon|rbcd-check|dotnetsearch|dotnet|powersql|powersharppack.*?(watson|sharpup|powerup|seatbelt))')) | duration 15m | select system, user, commandline | limit 10000 

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'findstr.*?pass.*?\\.(xml|doc|txt|xls|json|csv|html)')) | groupby system, user

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'findstr.*?pass.*?\\.(xml|doc|txt|xls|json|csv|html)')) and system='{TargetHost}'and user='{SuspectUser}' | duration 6m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'findstr.*?pass.*?\\.(xml|doc|txt|xls|json|csv|html)')) | groupby system, user

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'findstr.*?pass.*?\\.(xml|doc|txt|xls|json|csv|html)')) and system='{TargetHost}' and user='{SuspectUser}' | duration 10m

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'findstr.*?pass.*?\\.(xml|doc|txt|xls|json|csv|html)')) | groupby system, user

stream=ep-process, win-audit where action in ('PROCESS_CREATED', 'PROCESS_ADDED') and (rlike(lower(commandline) , 'findstr.*?pass.*?\\.(xml|doc|txt|xls|json|csv|html)')) and system='{TargetHost}' and user='{SuspectUser}' | duration 6m

